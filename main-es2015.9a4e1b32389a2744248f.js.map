{"version":3,"mappings":"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ACAE,GACAE,GACAE,GACAK,GACAE,GACAI,GACAE,GACAE,GACAI,GACAK,GACAwN,GACAU,GACAE,GACAM,GACAG,GACAE,GACAe,GACAK,GAEAE,GAEAI,GAEAniJ,SAOSyB,GAAb,GAUM,YAAgCA,GACpC,MAAO,IAAM,IAAIiK,QAAc1J,IAC3BP,EAAgBiN,UAAUlC,eAAe/K,EAAgBmN,eAAe9F,UAAU,KAChF8C,QAAQwE,KAAK,6BAA6B3O,EAAgBmN,8BACzDrO,IACDqL,QAAQG,MAAM,iBAAiBtK,EAAgBmN,6CAC9C,KACD5M,EAAQ,mBC5HZ+mC,kBACF3oC,SAGFJ,OACGsjJ,gBAAgBP,IAChB5uG,MAAM1yC,GAAOmK,QAAQC,IAAIpK,2BCd5B,OACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,YACA,eACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,YACA,eACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,sBACA,mBACA,sBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,eACA,kBACA,gBACA,aACA,gBACA,WACA,cACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,YACA,eACA,YACA,eACA,YACA,eACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,iBACA,oBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,aACA,gBACA,YACA,eACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,cACA,iBACA,aACA,gBACA,cACA,iBACA,cACA,mBACA,sBACA,iBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,mBACA,sBACA,aACA,gBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,oBAIA,cACA,WACA,YAEA,cACA,cACA,8CACA,gCACAtB,EAEA,YAEAC,kBACA,uBAEAA,YACAF,YACAE","names":["ke","Kt","re","w","e","_p","getByte","t","o","charCodeAt","this","ALPHA","indexOf","charAt","n","s","a","length","l","String","PADCHAR","getByte64","push","fromCharCode","join","i","ni","hp","window","navigator","userAgent","copy","r","At","createTextArea","selectText","copyTextToClipboard","destroyTextArea","document","createElement","value","body","appendChild","removeChild","getOSName","contentEditable","readOnly","createRange","getSelection","contenteditable","readonly","selectNodeContents","removeAllRanges","addRange","setSelectionRange","select","compareVersion","execCommand","diff","toString","Eo","getChanges","slice","mtc","ins","sbs","del","fis","c","split","u","p","fil","d","g","getMatchingSubstring","rotateArray","Array","ri","ADDED","findChanges","added","deleted","modified","findIndex","h","id","change","type","DELETED","splice","JSON","parse","stringify","Kr","compareObject","MODIFIED","keysChanged","oldValue","newValue","map","Set","Object","keys","forEach","isArray","concat","key","resolve","replace","shift","Date","assign","P","isObject","filter","mergeDeep","hasOwnProperty","copyDeep","toUpperCase","count","toLowerCase","reduce","y","removeUndefined","removeNull","localeCompare","getOwnPropertyNames","roundToNDecimal","Math","pow","round","create","random","substring","Co","de","constructor","Fe","_status","status$","next","subscribe","watch","status$$","pipe","handleStatusChange","call","unsubscribe","unwatch","status","Waiting","Hi","v","register","Pe","ids","counter$","unregister","factory","vp","intercept","headers","get","clone","delete","handle","activityService","es","forRoot","ngModule","providers","provide","q","useClass","multi","ol","lib","releaseDate","J","getConfig","config","load","default","path","injector","Promise","pe","console","log","Bn","error","version","il","useValue","Un","ts","useFactory","bp","deps","getTranslation","b","W","prefix","http","suffix","Cp","F","nl","translateService","langs","Error","substr","ee","Sp","missingTranslationHandler","wp","wo","m","tl","positionClass","timeOut","extendedTimeOut","messageClass","closeButton","progressBar","enableHtml","tapToDismiss","maxOpened","preventDuplicates","resetTimeoutOnDuplicate","countDuplicates","includeTitleDuplicates","L","translate","getBrowserLang","getLanguage","setDefaultLang","language","match","setLanguage","use","reloadLang","co","ERROR","me","options","configService","showError","caught","message","title","messages$","from","to","handleTemplate","text","SUCCESS","success","INFO","info","ALERT","WARNING","alert","toastId","languageService","instant","toastr","warning","remove","removeAllAreNotError","template","html","Tp","httpError","handleError","handleCaughtError","handleUncaughtError","statusText","url","toDisplay","messageService","os","rl","ai","centerKey","zoomKey","projectionKey","contextKey","searchKey","visibleOnLayersKey","visibleOffLayersKey","directionsCoordKey","directionsOptionsKey","toolKey","wmsUrlKey","wmsLayersKey","wmtsUrlKey","wmtsLayersKey","arcgisUrlKey","arcgisLayersKey","iarcgisUrlKey","iarcgisLayersKey","tarcgisUrlKey","tarcgisLayersKey","vectorKey","decodeURIComponent","location","search","includes","router","navigate","queryParams","route","$t","Mobile","Portrait","at","observe","So","matches","media$","orientation$","Landscape","Tablet","Desktop","getMedia","getOrientation","isTouchScreen","documentElement","isMobile","isDesktop","Ae","SESSION","oo","ae","sessionStorage","getItem","LOCAL","localStorage","set","setItem","storageChange$","scope","event","previousValue","currentValue","removeItem","REMOVED","clear","CLEARED","Nn","connection","onLine","checkNetworkState","onlineSubscription","previousMessageId","state","emitEvent","offlineSubscription","stateChangeEventEmitter","emit","ngOnDestroy","currentState","we","Ue","Default","ui","Auto","Vi","None","safeObject","meta","Jo","idProperty","titleProperty","icon","iconProperty","Map","zi","store","getKey","Wi","index","size","setMany","setAll","update","updateMany","updateManyExclusive","reverse","reverseMany","reverseChanges","updateAll","getAllKeys","some","entries","change$","getKey$","count$","empty$","_index","all","values$","all$","firstBy","find","firstBy$","manyBy","manyBy$","sort","destroy","values$$","createIndex","lifted","joins","filter$","addFilter","filterIndex","filters$","values","removeFilter","sort$","lift","liftJoinedSource","liftSource","li","processValues","setValues","source$","Ke","source","computeJoinedValue","filterValues","sortValues","every","valueAccessor","direction","nullsFirst","generateIndex","getProperty","createStateManager","view","createDataView","stateView","createStateView","_pristine","entities$","softClear","updateCount","insert","insertMany","deleteMany","addStrategy","strategies","bindStore","activate","removeStrategy","unbindStore","getStrategyOfType","activateStrategyOfType","deactivateStrategyOfType","deactivate","kp","ll","entity","statesAreTheSame","revision","ref","setChangeDetector","setStore","teardownObservers","innerStateIndex","setupObservers","detectChanges","cdRef","entities$$","onEntitiesChange","state$$","onStateChange","active$","active","doDeactivate","doActivate","stores","Bo","super","filterStore","unfilterStore","filterAll","unfilterAll","filters","filterClauseFunc","has","selected","cl","Rt","ngOnInit","watcher","Xi","selected$$","onSelectFromStore","onSelectionChange","multiSelectValue","emptyValue","selectedChange","selected$","updateMultiToggleWithEntities","multiText$","multiNoneText","multiAllText","selectors","pi","onClick","stopPropagation","qp","selection","_selected","toggleSelected","scroll","selectOnClick","addCls","selectedCls","highlightSelection","highlightedCls","removeCls","el","nativeElement","scrollMode","behavior","block","inline","renderer","addClass","removeClass","ul","paginationLabelTranslation$$","max","min","ngOnChanges","unsubscribeAll","count$$","emitPaginator","entitySortChange$$","entitySortChange$","paginator","firstPage","initPaginatorOptions","translateLabels","disabled","paginatorOptions","pageIndex","pageSize","pageSizeOptions","mediaService","showFirstLastButtons","hidePageSize","_intl","firstPageLabel","getRangeLabel","rangeLabel","itemsPerPageLabel","lastPageLabel","nextPageLabel","previousPageLabel","paginatorChange","jn","Gn","transform","activityInterceptor","responseType","Ap","it","FileReader","readAsDataURL","onloadend","result","complete","pure","H","Et","maxCacheCount","Yn","_sanitizer","bypassSecurityTrustHtml","oxw","onFocus","onChange","onBlur","ls","ci","di","_","he","dateAdapter","setLocale","_paginator","dataSource","columns","visible","name","selectionCheckbox","selectMany","fixedHeader","handleDatasource","onValueChange","getColumnKeyWithoutPropertiesTag","properties","target","onBooleanValueChange","checked","onSelectValueChange","onAutocompleteValueChange","formGroup","controls","setValue","option","viewValue","onDateChange","format","enableEdit","validation","mandatory","setControl","formBuilder","control","multiple","parseInt","filteredOptions","valueChanges","domainValues","normalize","test","utc","getValidationAttributeValue","disable","unsubscribeStore","selection$$","floor","selectionState$","computeSelectionState","dataSource$$","data","getTrackByFunction","refresh","onSort","getValue","sortNullsFirst","entitySortChange","column","onRowClick","lastRecordCheckedKey","entityClick","onRowSelect","entitySelectChange","onToggleRows","onToggleRow","onShiftToggleRow","selectNode","stopImmediatePropagation","All","Some","columnIsSortable","rowIsSelected","isImg","isUrl","pop","Boolean","isEdition","Number","edition","getColumnRenderer","getTableClass","getHeaderClass","headerClassFunc","Function","getRowClass","rowClassFunc","getCellClass","cellClassFunc","onButtonClick","O","useExisting","po","Dock","action","Bd","disabled$","noDisplay$","args","ngClass","ngClass$$","updateNgClass","icon$$","updateIcon","ns","checkCondition","checkCondition$$","updateCheckCondition","tooltip","tooltip$$","updateTooltip","availability","availability$$","disabled$$","display","display$$","noDisplay","noDisplay$$","trigger","ngClass$","tooltip$","checkCondition$","icon$","Ki","handler","collapsed","_overlayClass","withTitle","withIcon","horizontal","elRef","scrollActive","clientHeight","scrollHeight","scrollTop","positionConditionLow","onTriggerAction","scrollDown","scrollBy","scrollUp","Hn","S","I","Ie","R","x","He","cs","imports","us","matIconRegistry","getNamedSvgIcon","svg","updateSvg","hidden","updateHidden","updateDisabled","inverseColor","updateColor","inheritColor","querySelector","badge","style","alignItems","justifyContent","innerHTML","color","background","getComputedStyle","getPropertyValue","originalColor","zn","ut","Kd","handleMouseClick","contains","clickout","eg","gi","_target","_collapsed","collapseTarget","expandTarget","toggle","click","ps","_title","mi","og","ds","open","dialog","disableClose","componentInstance","confirmMessage","afterClosed","pl","$","dl","onContextMenu","close","preventDefault","menuPosition","overlayRef","overlay","position","flexibleConnectedTo","withPositions","originX","originY","overlayX","overlayY","positionStrategy","scrollStrategy","scrollStrategies","attach","Ip","menuContext","viewContainerRef","$implicit","sub","lo","overlayElement","et","elementRef","dispose","gl","Vn","Y","rg","setTarget","componentRef","createComponent","componentFactory","updateInputs","inputs","updateSubscribers","subscribers","unobserveAllInputs","instance","propName","unobserveInput","observeInput","setInputValue","onUpdateInputs","getPrototypeOf","getOwnPropertyDescriptor","outputs","subscriptions","inputs$$","gs","resolver","resolveComponentFactory","ml","Wn","component","dynamicComponent","dynamicComponentService","renderComponent","ms","hs","fs","_s","buttons","children","formData","setData","onSubmit","submitForm","getData","groups","fields","form","updateDataWithFormField","reset","fg","ys","group","addControl","validator","getValidators","setValidators","field","extendFieldConfig","getValidator","vs","getFieldByType","yg","getFieldComponent","formFieldService","getFieldInputs","fieldInputs","fieldOptions","errors","placeholder","disableSwitch","formControl","required","getFieldSubscribers","fieldSubscribers","bs","le","fl","getFieldColSpan","cols","getFieldNgClass","getErrorMessage","_l","tn","xs","tr","Cs","Ss","on","ct","Ro","To","yl","vl","jsonURL","getPathToConfigFile","loadConfigTour","getJSON","allToursOptions","getTourOptionData","ws","isAppHaveTour","interactiveTourLoader","isToolHaveTourConfig","disabledTourButton","conditions","isTourDisplayInMobile","getButtons","classes","getAction","addProgress","setInterval","getCurrentStep","attachTo","element","cancel","clearInterval","getElement","querySelectorAll","classList","add","steps","className","innerText","insertBefore","checkNext","_setupModal","show","executeAction","condition","executeActionPromise","waitFor","maxWait","getShepherdSteps","popperOptions","modifiers","offset","beforeShowPromise","previousStep","beforeChange","beforeShow","noBackButton","class","highlightClass","scrollTo","scrollToElement","canClickTarget","disableInteraction","when","onShow","hide","onHide","startTour","shepherdService","defaultStepOptions","cancelIcon","enabled","modal","confirmCancel","addSteps","tourObject","start","ze","setToolbar","toolbar","initStore","activeTool$$","getTool","getTools","setTools","getToolbar","toolbar$","activateTool","activatePreviousTool","activeToolHistory","deactivateTool","clearActiveToolHistory","setActiveTool","activeTool$","hi","bl","toolbox","tools","xl","getClass","styleButton","toolService","getTourToStart","tourToStart","activeToolName","isActiveTool","isToolHaveTour","interactiveTourService","startInteractiveTour","Cl","Uo","fi","Ft","_color","_focused","beforeFocus","beforeUnfocus","toggleFocusedClass","focus","unfocus","beforeSelect","beforeUnselect","toggleSelectedClass","unselect","_disabled","beforeDisable","beforeEnable","toggleDisabledClass","enable","getOffsetTop","offsetTop","focused","focusedCls","disabledCls","go","_navigation","_selection","_selectedItem","focusedItem","_focusedItem","handleKeyboardEvent","navigationEnabled","enableNavigation","ngAfterViewInit","listItems","init","listItems$$","changes","focusNext","toArray","getFocusedIndex","isScrolledIntoView","offsetHeight","focusPrevious","selectedItem","navigation","disableNavigation","scrollToItem","findSelectedItem","findFocusedItem","handleItemBeforeSelect","handleItemSelect","handleItemBeforeFocus","handleItemFocus","No","xt","_withHeader","gt","or","shown$","shown","Hg","counter$$","spinner","ir","sl","as","_filterChange","connect","_database","rs","dataChange","_sort","sortChange","getFilteredData","getSortedData","disconnect","_model","filterable","nn","gm","_hasFIlterInput","Sl","database","model","displayedColumns","displayed","unshift","actions","changed","getActionColor","isAllSelected","masterToggle","handleClickAction","mm","Op","_i","White","ue","vm","Mo","Grey","Primary","toolbar$$","onToolbarChange","onActiveToolChange","actionStore","onAnimationStart","animating$","onAnimationComplete","getToolInputs","animate","onAnimate","animation$","parent","unAnimate","animating$$","hm","changeDetection","bm","xm","wl","onCancel","onComplete","destroyWidget","getEffectiveSubscribers","baseSubscribers","widget","Ms","As","Tl","Ml","getWorkspaceTitle","onSelectedChange","activateWorkspace","Sm","Tm","workspace","widget$","widgetInputs$","widgetSubscribers$","onWidgetCancel","deactivateWidget","onWidgetComplete","Mm","Am","activeWorkspace$","deactivateWorkspace","entityStore","activateWidget","Im","V","Zm","Dm","idsActivity","km","Fs","production","igo","projections","code","alias","def","extent","auth","intern","allowAnonymous","interactiveTour","tourInMobile","importExport","catalog","sources","queryFormat","queryHtmlTarget","regFilters","tooltipType","searchSources","nominatim","icherche","searchUrl","order","params","limit","coordinatesreverse","showInPointerSummary","icherchereverse","ilayer","$m","configLanguage","Em","Rm","changeLanguage","Jm","Um","Nm","Qm","Gm","Hm","callHttp","callHttpError","zm","Xm","added$","Km","Is","eh","oh","toggleComponent","ih","rh","description","image","sh","ch","getTitle","uh","gh","choices","formService","valueChanges$$","submitDisabled","valid","form$","fillForm","data$","clearForm","mh","fh","sortable","showName","Lm","handleSelect","_h","yi","Ze","vi","xh","activateSalutationTool","Ch","Sh","Th","widgetService","Mh","Zs","tokenKey","decode","Lh","isExpired","getTime","exp","Ee","authenticate$","authenticated","logged$","login","username","password","encodePassword","loginCall","loginWithToken","token","typeConnection","infosUser","loginAnonymous","anonymous","post","tokenService","logout","isAuthenticated","getToken","decodeToken","goToRedirectUrl","redirectUrl","loginRoute","navigateByUrl","homeRoute","getUserInfo","getProfils","updateUser","patch","isAnonymous","user","isAdmin","locale","Ih","apiKey","clientId","loadSDKGoogle","loadPlatform","warn","handleSignInClick","gapi","auth2","getAuthInstance","signIn","handleSignOutClick","signOut","handleClientLoad","initClient","client","discoveryDocs","then","updateTextButton","isSignedIn","listen","updateSigninStatus","loginGoogle","access_token","authService","appRef","tick","getElementsByTagName","src","onload","parentNode","Zh","msalService","nr","cache","cacheLocation","broadcastService","Jt","inProgress$","bi","_destroying$","checkAccount","loginMicrosoft","loginPopup","getConf","authRequest","setActiveAccount","account","acquireTokenSilent","accessToken","tokenId","idToken","catch","Ll","acquireTokenPopup","msalGuardConfig","Os","redirectHash","initializeWrapperLibrary","acquireTokenRedirect","handleRedirectObservable","io","handleRedirectPromise","loginRedirect","logoutRedirect","logoutPopup","ssoSilent","getLogger","logger","setLogger","Oh","_msalSubject","msalSubject$","asObservable","_inProgress","msalInstance","addEventCallback","Fh","verbose","eventType","Dh","browserAuthOptions","loginMicrosoftb2c","kh","appId","loadSDKFacebook","subscribeEvents","FB","Event","statusChangeCallback","loginFacebook","authResponse","getElementById","Eh","_allowAnonymous","loginUser","loading","Ds","backgroundDisable","isLogoutRoute","_backgroundDisable","hasAlreadyConnectedDiv","_hasAlreadyConnectedDiv","hasLogoutDiv","_hasLogoutDiv","showAlreadyConnectedDiv","_showAlreadyConnectedDiv","showLogoutDiv","_showLogoutDiv","showLoginDiv","analyzeRoute","getName","onLogin","logoutRoute","home","firstName","sourceId","events","qo","isLoginRoute","rr","hostname","handleHostsWithCredentials","handleHostsAuthByKey","withCredentials","refreshToken","href","host","trustHosts","no","interceptXhr","setRequestHeader","alterUrlWithKeyAuth","hostsWithCredentials","RegExp","domainRegFilters","hostsWithAuthByKey","keyProperty","keyValue","refreshInProgress","redirectUri","authority","interactionType","scopes","loginHint","Vh","Xh","zh","Wh","Kh","preference","mergePreference","ks","Fl","nf","rf","Ef","extern","Mi","_layer","openMetadata","metadataService","abstract","Bf","layerTitle","layer","zo","oe","G","Yi","handleLoadStart","handleLoadEnd","handleLoadError","un","__watchers__","loaded","params_","LAYERS","sourceOptions","styleByAttribute","hoverStyle","featureClass","De","OPACITY","Bt","TITLE","wms","Nf","wmts","jf","xyz","Qf","feature","Gf","wfs","Yf","arcgisrest","js","imagearcgisrest","tilearcgisrest","osm","tiledebug","Qs","Fo","featureTypes","origin","generateId","createOlSource","mn","getLegend","legend","setLegend","Je","BasicNumericOperator","D","BBOX","moment","PropertyIsEqualTo","spatial","fieldRestrict","PropertyIsNotEqualTo","PropertyIsLike","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","PropertyIsBetween","During","PropertyIsNull","Intersects","Within","Contains","defineOgcFiltersDefaultOptions","editable","geometryName","advancedOgcFilters","pushButtons","checkboxes","radioButtons","buildFilter","nt","getCode","checkIgoFiltersProperties","bundleFilter","srsName","featureNS","featurePrefix","outputFormat","Yo","writeGetFeature","XMLSerializer","serializeToString","createFilter","operator","logical","logicalArray","propertyName","pattern","matchCase","wildCard","singleChar","escapeChar","lowerBoundary","upperBoundary","f","wkt_geometry","C","T","parseFilterOptionDate","begin","minDate","M","end","maxDate","E","expression","A","olFormatWKT","readGeometry","dataProjection","featureProjection","And","Or","Not","defineInterfaceFilterSequence","filterSequence","addInterfaceFilter","computeAllowedOperators","allowedOperatorsType","Spatial","BasicAndSpatial","operators","Basic","Time","filterid","step","sliderOptions","igoSpatialSelector","igoSNRC","geometry","parentLogical","level","addFilterProperties","rebuiltIgoOgcFilterObjectFromSequence","computeIgoSelector","computedSelectors","bundles","selectorType","handleOgcFiltersAppliedValue","ogcFilters","formatGroupAndFilter","verifyMultipleEnableds","formatProcessedOgcFilter","isValid","$e","GML2","Nt","Yt","IFRAME","zl","Ai","Gs","Wl","paramsWFS","Ys","Zt","xmlFilter","download","dynamicUrl","urlWfs","maxFeatures","k","sourceFields","ye","Me","fieldNameGeometry","_e","te","ce","OlFormat","formatOptions","gmlFormat","Js","hf","$l","ff","Ut","DPI","MAP_RESOLUTION","FORMAT_OPTIONS","refreshIntervalSec","Kl","buildDynamicDownloadUrlFromParamsWFS","calendarModeYear","wfsService","getSourceFieldsFromWFS","FILTER","setOgcFilters","timeFilterable","timeFilter","setTimeFilter","queryTitle","mapLabel","BLANK","updateParams","igoRefresh","pf","ratio","ogcFilters$","timeFilter$","scale","projection","contentDependentLegend","VERSION","currentStyle","onUnwatch","ogcFilterWriter","transferCommonProperties","ogcFilters$$","transferOgcFiltersProperties","timeFilter$$","transferTimeFilterProperties","syncChildLayers","layers","linkedLayers","links","VISIBLE","opacity","MINRESOLUTION","minResolution","MAXRESOLUTION","OGCFILTERS","TIMEFILTER","getProperties","linkId","linkedIds","visible$","bidirectionnal","getSource","viewController","getOlProjection","getParams","Ct","TIME","tile","getSourceFormatFromOptions","olSourceVector","formatType","ur","fe","be","El","Ht","getUrl","z","se","ve","Mt","Oo","xo","Rn","ji","Jn","Qi","ii","Gi","K","Wr","Wa","ao","uL","dp","gp","pL","Xr","toLocaleUpperCase","trim","Do","parseFloat","Io","Q","lonLat","radius","conf","forceNA","dL","q6","abs","originalEvent","altKey","_f","metaKey","ctrlKey","shiftKey","si","isInResolutionsRange$","Z","createOlLayer","zIndex","baseLayer","maxResolution","St","maxScaleDenom","minScaleDenom","legendOptions","legendCollapsed","isIgoInternalLayer","getZIndex","setZIndex","setOpacity","setMaxResolution","updateInResolutionsRange","getMaxResolution","setMinResolution","getMinResolution","setVisible","hasBeenVisible$","messages","showOnEachLayerVisibility","showMessage","isInResolutionsRange","showInLayerList","setMap","unobserveResolution","observeResolution","layerSyncWatcher","zf","hasBeenVisible$$","resolution$$","resolution$","getResolution","fr","Wf","browsable","exportable","animation","flash","bind","trackFeature","enableTrackFeature","olLayerVector","customWFSLoader","authInterceptor","customLoader","setLoader","frameState","getGeometry","time","duration","ColorAsArray","getStyleFunction","getImage","getType","getRadius","setRadius","getStroke","setColor","setWidth","wi","getWidth","getFill","setText","setStyle","drawGeometry","render","stopAnimation","trackFeatureListenerId","centerMapOnFeature","getFeatureById","getView","setCenter","getCoordinates","getId","disableTrackFeature","Ti","Xl","getFeatures","mostRecentIdCallOGCFilter","XMLHttpRequest","removeLoadedExtent","onerror","responseText","getFormat","readFeatures","addFeatures","send","cn","responseXML","DOMParser","parseFromString","response","readProjection","yf","vf","Hs","strategy","ql","r_","defineFieldAndValuefromWFS","wfsGetFeature","getKeys","getGeometryName","built_properties_value","boundedBy","getExtent","extentGetWidth","bf","extentGetTopLeft","resolutions","matrixIds","tileGrid","s_","Rl","crossOrigin","xf","items","cartocss","layer_name","pr","attributions","overlaps","encodeURIComponent","customParams","olloadingstrategy","legendInfo","htmlImgSrc","contentType","imageData","label","uniqueValueInfos","symbol","createSVG","width","outline","renderingRule","Cf","layerId","Sf","Tf","wf","createWebSocket","WebSocket","onmessage","onMessage","onclose","onClose","onError","onopen","onOpen","readFeature","removeFeature","addFeature","Bl","Jl","_converters","esriPMS","Be","_convertEsriPMS","esriSFS","_convertEsriSFS","esriSLS","_convertEsriSLS","esriSMS","_convertEsriSMS","esriTS","_convertEsriTS","_renderers","uniqueValue","_renderUniqueValue","simple","_renderSimple","classBreaks","_renderClassBreaks","_transformAngle","angle","B","ht","fill","j","_transformColor","font","weight","family","textBaseline","verticalAlignment","textAlign","horizontalAlignment","offsetX","_convertPointToPixel","xoffset","offsetY","yoffset","rotation","Ci","_convertOutline","stroke","U","lineDash","PI","Te","Si","points","radius2","_convertLabelingInfo","labelExpression","maxScale","minScale","_getResolutionForScale","getText","defaultSymbol","classBreakInfos","classMinValue","minValue","classMaxValue","field1","generateStyle","drawingInfo","labelingInfo","Qe","DATE","_t","CALENDAR","Dt","getMap","Fi","yr","gf","mf","esriJSON","getWMSOptions","getCapabilities","parseWMSOptions","getWMTSOptions","parseWMTSOptions","getCartoOptions","jsonp","mapId","parseCartoOptions","getArcgisOptions","mo","parseArcgisOptions","getImageArcgisOptions","parseTileOrImageArcgisOptions","getTileArcgisOptions","fromObject","request","service","parsers","read","findDataSourceInCapabilities","Capability","Layer","DataURL","Abstract","KeywordList","queryable","getTimeFilter","Style","getStyle","EX_GeographicBoundingBox","mapService","GEOJSON","GEOJSON2","GML3","HTML","Request","GetFeatureInfo","Format","_layerOptionsFromSource","Title","MaxScaleDenominator","MinScaleDenominator","metadata","OnlineResource","keywordList","stepDate","Contents","Identifier","layer_definition","layerName","units","lr","copyrightText","timeInfo","timeExtent","setTime","toUTCString","range","DATETIME","serviceDescription","displayField","Name","Dimension","stylesAvailable","fn","registerProjection","$s","Ol","setExtent","mt","createAsyncDataSource","createOSMDataSource","createFeatureDataSource","createWFSDataSource","createWMSDataSource","createWMTSDataSource","createXYZDataSource","createTileDebugDataSource","createCartoDataSource","createArcGISRestDataSource","createArcGISRestImageDataSource","createWebSocketDataSource","createMVTDataSource","createTileArcGISRestDataSource","createClusterDataSource","datasources$","oc","nc","Li","wfsDataSourceService","optionsFromCapabilities","capabilitiesService","optionsService","optionsFromApi","Ws","Vs","ic","_r","getArcgisRestOptions","Xs","Ks","hn","ea","OlFormatGeoJSON","setId","Qn","startsWith","writeGeometryObject","excludeAttribute","excludeAttributeOffline","idColumn","mapTitle","getRevision","Ne","ac","Zoom","zoomToExtent","Move","moveToExtent","getZoom","xe","bindLayer","addLayer","setLayerFeatures","checkLayer","kt","setLayerOlFeatures","setStoreOlFeatures","_n","clearLayer","removeOlFeaturesFromLayer","addOlFeaturesToLayer","zt","watchStore","empty$$","It","updateEntitiesInExtent","unwatchStore","unwatchAll","stores$$","states$$","state$","inMapExtent","updateEntitiesInResolution","inMapResolution","setMotion","motion","onFeaturesChange","selectMotion","viewScale","areaRatio","getFeatureId","pristine","onSourceChanges","flatMap","Ul","_overlayStore","createOverlayStore","unselectAll","overlayStore","deactivateSelection","unlistenToMapClick","removeDragBoxInteraction","addOverlayLayer","listenToMapClick","dragBox","addDragBoxInteraction","watchAll","removeOverlayLayer","mapClickListener","onMapClick","hr","getFeaturesAtPixel","pixel","hitTolerance","layerFilter","onSelectFromMap","getInteractions","getArray","xr","addInteraction","olDragSelectInteraction","olDragSelectInteractionEndKey","onDragBoxEnd","removeInteraction","mapBrowserEvent","getFeaturesInExtent","groupFeaturesByStore","unselectAllFeaturesFromStore","selectFeaturesFromStore","createOverlayLayer","yt","removeLayer","jt","vt","markerColor","markerOutlineColor","imgSize","anchor","overflow","Wo","createStyle","parseStyle","Zi","getOlCls","getOlKey","uf","createStyleByAttribute","guessTypeFeature","attribute","baseStyle","getLabel","qe","createClusterStyle","clusterRanges","minRadius","maxRadius","showRange","dynamicRadius","image_","radiusCalc","matchAll","strokeWidth","fillColor","strokeColor","g_","setFeatures","removeOlFeature","addOlFeatures","addOlFeature","removeFeatures","unwatchLayer","watchLayer","Oi","getOlMap","olMap","setOlMap","observerKeys","stateHistory","olView","onMoveEnd","extent$$","extent$","getProjection","getCenter","calculateExtent","getSize","getScale","getUnits","zoomIn","zoomTo","zoomOut","cancelAnimations","zoom","easing","getRotation","resetRotation","hasPreviousState","states","stateIndex","hasNextState","previousState","setStateIndex","nextState","clearStateHistory","setInitialState","sqrt","maxZoomOnExtent","fit","maxZoom","padding","callback","setState","resolution","center","trunc","attribution","defaultOptions","layerWatcher","h_","layers$","olControlAttribution","scaleLine","Zl","interactions","altShiftDragRotate","doubleClickZoom","keyboard","mouseWheelZoom","shiftDragZoom","dragPan","pinchRotate","pinchZoom","sf","olinteraction","setView","__","Cr","queryResultsOverlay","searchResultsOverlay","buffer","updateView","constrainResolution","af","unsubscribeGeolocate","maxLayerZoomExtent","geolocate","alwaysTracking","updateControls","getControls","removeControl","changeBaseLayer","getBaseLayers","setMinZoom","minZoom","setMaxZoom","getLayerById","getLayerByAlias","getLayerByOlUId","ol_uid","addLayers","doAddLayer","setLayers","removeLayers","handleLinkedLayersDeletion","doRemoveLayer","syncedDelete","removeAllLayers","raiseLayer","getLayerIndex","moveLayer","raiseLayers","lowerLayer","lowerLayers","sortLayersByZIndex","geolocation$$","geolocation","getTracking","startGeolocation","geolocation$","getAccuracy","getPosition","olPoint","getAccuracyGeometry","geolocationPositionFeature","geolocationAccuracyFeature","bufferFeature","olFeature","positionFollower","bufferRadius","bufferGeom","olCircle","bufferStroke","bufferFill","showBufferRadius","setZoom","stopGeolocation","setTracking","lf","trackingOptions","enableHighAccuracy","tracking","onOfflineToggle","offlineButtonToggle$","Ce","_view","_controls","activityId","v_","listenToMapPointerMove","unlistenToMapPointerMove","pointerMoveListener","onPointerEvent","pointerPositionDelay","dragging","lastTimeoutRequest","clearTimeout","coordinate","mapProjection","setTimeout","pointerPositionCoord","Uf","olLoadingProblem","Af","setImageLoadFunction","abort","Uint8Array","TextDecoder","Blob","URL","createObjectURL","ec","Lf","setTileLoadFunction","dr","onLoad","C_","mouseout","subscribeToPointerStore","layers$$","Vo","S_","selectionLayer","renderMode","declutter","olVectorTileSource","mvtStyleOptions","selectionMVT","createHoverStyle","backgroundFill","backgroundStroke","styleService","unsubscribeToPointerStore","unlistenToMapSingleClick","store$$","pointerHoverFeatureStore","entitiesToPointerOverlay","addFeatureOverlay","onMapEvent","singleClickMapListener","onMapSingleClickEvent","igoHoverFeatureEnabled","getPixelFromCoordinate","forEachFeatureAtPixel","canProcessHover","handleRenderFeature","setLayerStyleFromOptions","setProperties","OlGeom","setGeometry","setSource","igoHoverFeatureDelay","jl","hoverFeatureId","hoverSummary","getHoverSummary","getOrientedFlatCoordinates","OlStyle","tt","getMinZoom","getMaxZoom","bn","_map","xn","computeHomeExtent","homeExtentButtonExtent","extentOverride","homeExtentButtonCenter","centerOverride","homeExtentButtonZoom","zoomOverride","onToggleClick","I_","useStaticIcon","_baseLayers","collapseOrExpand","expand","baseLayers","height","Le","createLayer","createTileLayer","createVectorLayer","createImageLayer","Hl","createVectorTileLayer","createAsyncLayer","dataSourceService","b_","x_","clusterBaseStyle","clusterParam","applyMapboxStyle","dc","mapboxStyle","getMapboxGlStyle","Ff","fc","Ge","_baseLayer","handleBaseLayerChanged","handleMainMapViewChange","basemap","setResolution","setRotation","layerService","handleLinkedBaseLayer","Cn","_showIfNoRotation","rotationStyle","$_","ot","ge","catalogService","ki","collectCatalogItems","loadCatalogWMSLayerItems","loadCatalogWMTSLayerItems","baselayers","loadCatalogBaseLayerItems","loadCatalogArcGISRestItems","composite","loadCatalogCompositeLayerItems","createInstanceCatalog","B_","R_","J_","_c","q_","E_","ta","query","queryLayer","getQueryUrl","HTMLGML2","mergeGML","extractData","kl","Mf","Nl","getQueryParams","bbox","Oe","appendLineString","ro","appendPolygon","ho","coordinates","convexHull","cross","getAllowedFieldsAndAlias","extractGML3Data","extractGeoJSONData","ESRIJSON","extractEsriJSONData","TEXT","extractTextData","extractHtmlData","extractGML2Data","createGeometryFromUrlClick","getQueryTitle","sourceTitle","featureToResult","features","crs","srs","lastIndexOf","If","GEOMETRIE","shape","SHAPE","the_geom","geom","queryUrl","getCustomQueryUrl","INFO_FORMAT","getMimeInfoFormat","QUERY_LAYERS","FEATURE_COUNT","getFeatureInfoUrl","sql","queryPrecision","getLabelMatch","Sn","queryLayerFeatures","vc","cancelOngoingQueries","queryService","queryEnabled","queryFeatures","doQueryFeatures","waitForAllQueries","queries$$","values_","queryFormatAsWms","nom","id_","_icon","OlRenderFeature","getEnds","getFlatCoordinates","Es","queryFeaturesHitTolerance","queryFeaturesCondition","N_","forEachFeatureIntersectingExtent","st","storageService","getDefaultOptions","settings","setParamFromSetting","available","showInSettings","getHashtagsValid","getSettingsValues","hashtags","bc","getGoogleMapsCoordLink","encodeURI","getOpenStreetMapLink","ia","loadCatalogs","Qo","apply","loadCatalogItems","yc","getCatalogBaseLayersOptions","externalProvider","Group","getCatalogCapabilities","Service","flattenWmsCapabilities","groupSeparator","includeRecursiveItems","getWMTSItems","getArcGISRESTItems","sortDirection","groupImpose","address","sr","prepareCatalogItemLayer","retrieveLayerInfoFormat","showLegend","setCrossOriginAnonymous","forcedProperties","prepareCatalogItemGroup","testLayerRegexes","findCatalogInfoFormat","ServiceIdentification","matrixSet","requestEncoding","na","catalogAllowLegend","isGroup","isLayer","onLayerAddedChange","addLayerToMap","removeLayerFromMap","onGroupAddedChange","addGroupToMap","removeGroupFromMap","addLayersToMap","removeLayersFromMap","sortCatalogItemsByTitle","Tn","styles","listStyles","STYLES","updateLegendOnResolutionChange","onViewControllerStateChange","legendItems$","getLegendGraphic","imgGraphValue","toggleLegendItem","transfertToggleLegendItem","computeItemTitle","updateLegend","onChangeStyle","onLoadImage","renderedLegends","first","imagesHeight","xc","isPreview$$","isPreview$","addedLayerIsPreview","computeTitleTooltip","ABSTRACT","CUSTOM","onMouseEvent","askForLegend","layerLegendShown$","xi","igoLayer$","mouseInsideAdd","addedChange","haveGroup","inRange$","computeTooltip","by","evaluateAdded","evaluateDisabled","onToggleCollapsed","layerAddedChange","tryToggleGroup","onLayerPreview","preview$","toggleCollapsed","onTitleClick","xy","Sc","_activeLayer","selectionMode","layerTool$","_selectAll","layerCheck","expandLegendIfVisible","firstLoadComponent","toggleLegend","updateQueryBadge","onResolutionChange","tooltipText","network$$","networkService","showLegend$","toggleLegendOnClick","toggleVisibility","toggleLegendOnVisibilityChange","inResolutionRange$","queryBadge","queryBadgeHidden$","toggleLayerTool","check","checkbox","Ve","always","Zo","ALL_VISIBLE","Pi","Raise","Xo","_layers","removeProblemLayerInList","activeLayer$","_keyword","_onlyVisible","_sortedAlpha","orderable","activeLayer","getUpperLayer","isUpperBaselayer","getLowerLayer","isLowerBaselayer","layersChecked","raisableLayers","selectAllCheck","lowerDisabledSelection","lowerableLayers","checkOpacity","layersCheckedOpacity","change$$","showToolbar$","computeShowToolbar","computeLayers","appliedFilterAndSort","keyword","sortAlpha","onlyVisible","selectAllCheck$$","selectAllCheck$","layerTool","excludeBaseLayers","activeLayerIsValid","activeLayersAreValid","zoomLayerExtents","zoomLayersExtents","changeOpacity","clearKeyword","moveActiveLayer","getLinkedLayers","Lower","ZINDEX","raisableLayer","computeElementRef","offsetParent","lowerableLayer","filterLayers","sortLayersByTitle","sortLayersByZindex","onKeywordChange","onAppliedFilterAndSortChange","layerFilterAndSortOptions","showToolbar","never","thresholdToFilterAndSort","toggleOpacity","removable","hideSelectedLayers","layerItemChangeDetection$","isLayerRemovable","isAllLayersRemovable","NULL","MIXED","ALL_HIDDEN","layersCheck","toggleSelectionMode","selectAll","getElementsByClassName","Ny","onlyVisible$","sortAlpha$","term$","term$$","onlyVisible$$","term","sortAlpha$$","clearTerm","toggleSortAlpha","toggleOnlyVisible","Sr","layersOrResolutionChange$$","setLayersVisibilityStatus","layersVisibility$$","layersAreAllVisible","Mn","computeShownLayers","hasVisibleOrInRangeLayers$","hasVisibleAndNotInRangeLayers$","layersInUi$","showAllLegendsValue","toggleShowAllLegends","allLegendsShown","wr","toggleTrackFeature","Tc","Ko","lt","rt","Ho","Mc","sv","predefinedCatalogs","addedCatalog","defaultAddedCatalogType","typeCapabilities","addedCatalogType$$","updateValueAndValidity","computePredefinedCatalogList","storeViewAll$$","emailAddress","changeUrlOrTitle","patchValue","predefinedCatalogsList$","addCatalog","dialogRef","ra","getCatalogs","onCatalogSelect","catalogSelectChange","unsubscribeAddingCatalog","addingCatalog$$","addCatalogDialog","mapName","ServiceType","addedCatalogs","onCatalogRemove","dv","removeCatalogFromLibrary","catalogRemove","Ac","Lc","Fc","isTimeFilterable","isOgcFilterable","Ic","filterByDate","reformatDateTime","filterByYear","getFullYear","getMonth","getUTCDate","getUTCHours","getUTCMinutes","sa","filterByOgc","setOgcWFSFiltersOptions","interfaceOgcFilters","setOgcWMSFiltersOptions","filtered","Se","Predefined","dt","Address","An","AdmRegion","Arrond","CircFed","CircProv","DirReg","MRC","Mun","RegTour","bornes","hydro","routes","baseUrl","getKeyByValue","loadFilterList","urlFilterList","loadThematicsList","loadFilterItem","bufferInput","simplified","loc","loadItemById","loadBufferGeometry","bufferOutput","Zc","outputFormatDownload","hv","openDownload","downloadService","Tr","ei","unsubscribe$","_source","_feature","selectFeature","ready","urlSanitizer","sanitizer","bypassSecurityTrustResourceUrl","isHtmlDisplay","htmlDisplayEvent","htmlSanitizer","filterFeatureProperties","Route","Ln","Point","olDrawingLayer","drawingLayer","createOlInnerOverlayLayer","olGeometryType","geometryType","olDrawingLayerSource","clearOlInnerOverlaySource","removeOlInnerOverlayLayer","removeOlInteractions","addOlInnerOverlayLayer","addOlInteractions","setGeometryType","Go","drawingLayerSource","Gt","drawingLayerStyle","freehand$","gr","maxPoints","freehand","stopClick","interactionStyle","freehandCondition","olDrawInteraction","onDrawStartKey","onDrawStart","onDrawEndKey","onDrawEnd","onDrawAbortKey","abort$","Bs","olModifyInteraction","olSelectInteraction","Ps","Gl","onSelect","unsubscribeKeyDown","onDrawKey","start$","mousePosition","ua","changes$","subscribeKeyDown","modify$","end$","select$","keyDown$$","removeLastPoint","finishDrawing","abortDrawing","Pv","noLabel","$v","Pt","Length","ie","Meters","pa","Kilometers","Miles","Feet","Ye","SquareMeters","kc","SquareKilometers","SquareMiles","SquareFeet","Hectares","Acres","Ev","Rv","qv","Jv","Bv","Uv","Nv","jv","decimal","toLocaleString","minimumFractionDigits","maximumFractionDigits","toFixed","unit","unitAbbr","olGetLength","Pc","olGetArea","area","lengths","$c","getCoordinateAt","setCoordinates","cr","Ec","removeOverlay","Yl","stopEvent","setPosition","Olstyle","Kv","getFillColor","setFillColor","getStrokeColor","setStrokeColor","getStrokeWidth","getLabelsAreShown","labelsAreShown","toggleLabelsAreShown","setIcon","getIcon","createDrawingLayerStyle","flatCoordinates","cos","e1","getIconsList","getIcons","icons","getPath","Uc","draw","buildForm","drawStyleService","drawIconService","drawControl","createDrawControl","toggleDrawControl","subscriptions$$","$i","Jc","onGeometryTypeChange","yn","uc","many","clearLabelsOfOlGeometry","selectedFeatures$","onColorChange","strokeForm","onToggleDrawControl","deactivateDrawControl","activateDrawControl","openDialog","currentLabel","updateLabelOfOlGeometry","onSelectDraw","drawControlIsDisabled","drawControlIsActive","drawEnd$$","onModifyDraw","drawSelect$$","addFeatureToStore","replaceFeatureInStore","rad","longitude","latitude","deleteDrawings","ha","onToggleLabels","_label","onIconChange","openShorcutsDialog","Nc","Re","Ql","fa","s1","fo","modify","olOverlayLayer","olLinearRingsLayer","createOlLinearRingsLayer","olOverlaySource","removeOlModifyInteraction","removeOlTranslateInteraction","removeOlDrawInteraction","addOlDrawInteraction","addOlTranslateInteraction","activateTranslateInteraction","addOlModifyInteraction","activateModifyInteraction","setOlGeometry","layerStyle","Dc","addOlLinearRingsLayer","removeOlLinearRingsLayer","clearOlLinearRingsSource","olLinearRingsSource","drawStyle","deactivateModifyInteraction","olModifyInteractionIsActive","onModifyStartKey","onModifyStart","onModifyEndKey","onModifyEnd","onModifyKey","item","subscribeToKeyDown","unsubscribeToKeyDown","Dl","olTranslateInteraction","deactivateTranslateInteraction","olTranslateInteractionIsActive","onTranslateStartKey","onTranslateStart","onTranslateEndKey","onTranslateEnd","onTranslateKey","olOuterGeometry","getOlGeometry","intersectsCoordinate","subscribeToDrawKeyDown","drawKeyDown$$","unsubscribeToDrawKeyDown","subscribeToDrawKeyUp","activateDrawInteraction","drawKeyUp$$","unsubscribeToDrawKeyUp","deactivateDrawInteraction","olDrawInteractionIsActive","removedOlInteractions","getLinearRing","addLinearRingToOlGeometry","updateLinearRingOfOlGeometry","appendLinearRing","Zf","getLinearRings","Zn","Gc","onNoClick","_a","activeLengthUnit","In","Fn","measure","activeAreaUnit","Mr","setActiveMeasureType","_activeMeasureType","activeDrawControl","createDrawLineControl","createDrawPolygonControl","createModifyControl","updateTooltipsOfOlSource","checkDistanceAreaToggle","deactivateModifyControl","freezeStore","onMeasureTypeChange","activeMeasureType","onToggleMeasureUnitsAuto","measureUnitsAuto","onToggleDisplayDistance","displayDistance","onDisplayDistance","onToggleDisplayLines","displayLines","onDisplayLines","onToggleDisplayAreas","displayAreas","onDisplayAreas","onLengthUnitChange","table","activeOlGeometry","updateTooltipsOfOlGeometry","onAreaUnitChange","onCalculateClick","perimeter","onDeleteClick","olDrawSource","onModifyClick","modifyControl","activateModifyControl","clearTooltipsOfOlGeometry","onFeatureAddedKey","updateMeasureOfOlGeometry","onFeatureRemovedKey","selectedFeatures$$","hasArea$","hasLine$","je","drawLineControl","da","drawPolygonControl","Qc","Area","drawStart$$","drawChanges$$","onDrawChanges","clearMeasures","clearTooltipsOfOlSource","finalizeMeasureOfOlGeometry","ga","measure$","modifyStart$$","modifyEnd$$","modifyChanges$$","onModifyChanges","_measure","ma","Rc","updateOlTooltip","olGetCenter","showTooltipsOfOlGeometry","shouldShowTooltip","addOverlay","forEachFeature","showTooltipsOfOlSource","_unit","_type","computeTooltipInnerHTML","showTooltips","minSegmentLength","Yc","Hc","createMeasureTooltip","ngControl","_geometryType","deactivateControl","freehandDrawIsActive","toggleControl","_drawControlIsActive","_freehandDrawIsActive","Oc","_drawStyle","getGuideStyleFromDrawStyle","defaultDrawStyleRadius","_overlayStyle","_value","addGeoJSONToOverlay","features_","overlayStyle","addOlOverlayLayer","registerOnChange","registerOnTouched","onTouched","writeValue","controlOptions","updateDrawStyleWithDrawGuide","activeControl","activateControl","olGeometryEnds$$","onOlGeometryEnds","olGeometryChanges$$","onOlGeometryChanges","removeMeasureTooltip","updateMeasureTooltip","circleToPoint","olGeoJSON","olTooltip","drawGuide","isStyleWithRadius","zc","ya","On","J1","YEAR","isNaN","valueOf","startDate","endDate","SLIDER","getStepDefinition","timeInterval","getTimezoneOffset","is","startYear","initStartYear","endYear","initEndYear","isRange","startListYears","endListYears","listYears","checkFilterValue","yearChange","year","storeCurrentFilterValue","handleDateChange","setupDateOutput","applyTypeChange","handleYearChange","handleListYearChange","handleListYearStartChange","dateToNumber","setSliderThumbLabel","findThumbLabel","mySlider","_elementRef","childNodes","textContent","toggleFilterState","stopFilter","resetFilter","date","playFilter","interval","playIcon","playYear","handleSliderDateChange","handleSliderTooltip","handleSliderYearChange","handleSliderValue","current","getRoundedDate","toDateString","toTimeString","setSeconds","setHours","setMinutes","getDay","getHours","getMinutes","getRangeMinDate","getRangeMaxDate","asMilliseconds","Ar","timeFilterService","datasource","filtersCollapsed","toggleFiltersCollapsed","Lr","H1","wktToFeature","extentToWkt","roundCoordinateArray","wktPoly","wktLine","wktMultiPoints","roundArray","snrcToWkt","Vc","allOgcFilterOperators","ogcFilterOperators$","igoSpatialSelectors","_snrc","currentFilter","allowedOperators","fields$","excludeFromOgcFilters","updateFieldsList","selectedField$","updateValuesList","currentFilterIsSpatial","filteredFields$","_filterFields","changeField","filteredValues$","_filterValues","changeProperty","clearSelectedField","clearProperty","isClearable","detectProperty","refreshFilters","deleteFilter","changeLogical","changeOperator","currentFilterIsSpatial$","changeSpatialSelector","changeCaseSensitive","changeNumericProperty","changeMapExtentGeometry","changeSNRC","snrc","changeSNRCGeometry","wktService","isTemporalOperator","ogcFilterOperator","Wc","Dn","hasSelector","ogcFilterService","lastRunOgcFilter","hasActiveSpatialFilter","filtersAreEditable","addFilterToSequence","defaultLogicalParent","isAdvancedOgcFilters","addFilterDisabled","changeOgcFiltersAdvancedOgcFilters","changeOgcFilterType","Fr","kn","va","stepMillisecond","defaultStepMillisecond","stepIsYearDuration","years","months","weeks","days","hours","minutes","stepIsMonthDuration","stepIsWeekDuration","stepIsDayDuration","stepIsHourDuration","stepIsMinuteDuration","_o","addStep","toDate","subtractStep","subtract","Xc","_currentFilter","pushButtonsGroup","checkboxesGroup","radioButtonsGroup","selectGroup","enabled$","applyFiltersTimeout","currentSelectGroup","applyFilters","enableds$","getPushButtonsGroups","getCheckboxesGroups","getRadioButtonsGroups","getSelectGroups","currentPushButtonsGroup","currentCheckboxesGroup","currentRadioButtonsGroup","getSelectEnabled","onPushButtonsChangeGroup","onCheckboxesChangeGroup","onRadioButtonsChangeGroup","onSelectChangeGroup","enableds","getToolTip","getButtonColor","bundleIsVertical","vertical","emptyRadioButtons","emptySelect","toggleAllSelection","sel","allSelected","deselect","optionClick","isMoreResults","radioButtonsIndex","checkboxesIndex","displayMoreResults","isLessResults","baseIndex","displayLessResults","ba","spatialType","Polygon","_store","selectedTypeIndex","activeDrawType","onTypeChange","onDrawTypeChange","eventQueryType","selectedQueryType","zoneChange","T0","_queryType","_zone","zoneWithBuffer","bufferFormControl","formValueChanges$$","bufferValueChanges$$","measureUnit","bufferChange","spatialFilterService","selectedZone","queryType","zoneWithBufferChange","displayFn","onZoneChange","onMeasureUnitChange","measureUnitChange","entityChange","xa","Thematics","Of","Lo","geometryTypes","drawGuide$","drawStyle$","radiusFormControl","PointStyle","olStyle","PolyStyle","overlayStyle$","_thematicLength","childrens","thematics","value$","value$$","drawZone","drawZoneEvent","radiusChanges$$","bufferChanges$$","bufferEvent","uo","detach","onItemTypeChange","selectedItemType","itemTypeChange","isPolygon","isPoint","isPredefined","hasChild","treeControl","isExpanded","collapse","selectedThematics","hasChildrenSelected","thematicChange","childrensToggle","onToggleChange","onDrawControlChange","onfreehandControlChange","freehandControl","toggleSearchButton","radiusEvent","toggleSearch","thematicLength","openWorkspace","createTableTemplate","clearButton","clearButtonEvent","tableTemplate","clearDrawZone","clearSearch","clearSearchEvent","disableSearchButton","zone","disabledClearSearch","toggleVisibleList","listIsVisible","Ca","_beginValue","_endValue","sliderInterval","_defaultMax","displayFormat","_defaultDisplayFormat","_defaultSliderModeEnabled","beginValue","parseFilter","handleMin","endValue","handleMax","onlyYearBegin","getUTCFullYear","onlyYearEnd","calendarTypeYear","isCalendarYearMode","setFilterStateDisable","updateHoursMinutesArray","updateValues","endOf","getDateFromStringWithoutTime","changeTemporalProperty","getDateTime","pos","refreshFilter","calendarType","sliderMode","restrictedToStep","ogcFilterTimeService","stepMilliseconds","toISOString","handleDate","yearOnlyInputChange","yearSelected","monthSelected","calendarView","dateFilter","ne","asYears","asMonths","asWeeks","asDays","asHours","beginHourFormControl","beginMinuteFormControl","endHourFormControl","endMinuteFormControl","handleMinuteIncrement","handleHourIncrement","fullBeginHoursArray","beginHours","fullEndHoursArray","endHours","fullBeginMinutesArray","beginMinutes","fullEndMinutesArray","endMinutes","restrictToStep","_defaultMin","changePropertyByPass","modeChange","filterStateDisable","toLocaleDateString","bt","cx","sliderDisplayWith","_defaultSliderInterval","calculateStep","handleSliderInput","beginMillisecond","slider","calculatedStep","_increment","_emitInputEvent","startOf","maxMillisecond","yo","N","pt","ft","pn","Kc","setPrototypeOf","wa","prototype","Ir","X","eo","Vt","Ta","ogreUrl","aggregateInComment","export","generateFeature","exportAsync","GPX","generateAggregatedFeature","nothingToExport","ogreFormats","noOgreFallbacks","exportToFile","exportWithOgre","setAttribute","writeFeatures","featureType","UTF8","acceptCharset","enctype","LATIN1","submit","GML","KML","Shapefile","CSVcomma","CSVsemicolon","mimeType","Ma","getStyleList","distance","Ei","ti","Dr","Aa","ou","clientSideFileSizeMax","import","importAsync","getFileImporter","tu","allowedMimeTypes","allowedZipMimeTypes","allowedExtensions","importFile","importFileWithOgre","Cx","parseFeaturesFromFile","readAsText","FormData","append","parseFeaturesFromGeoJSON","msg","startWith","Sx","Rs","Pl","qs","writeFeatureObject","kr","styleList","iu","loadConfig","computeProjections","_projectionsLimitations","importForm","inputProj","exportableLayers$","fileSizeMb","exportOptions$$","exportOptions$","computeFormats","formLayer$$","popupChecked","handlePopup","handlePreviousLayerSpecs","formats$","loading$","previousLayerSpecs$","formats$$","encodings$$","encodings$","encoding","exportableLayers$$","controlFormat","selectFirstProj","projections$","translateKey","projectionsConstraints","mtmZone","utmZone","projFromConfig","nad83","wgs84","webMercator","utm","mtm","minZone","maxZone","projectionsLimitations","getWorkspaceByLayerId","getLayerTitleById","layerHasSelectedFeatures","onlySelected","layersWithSelection","onlySelectedClick","inLayersIdToExportSelectionOnly","exportOptionsChange","importFiles","espgCodeRegex","importService","onFileImportSuccess","onFileImportError","closed","onPopupBlockedError","popupAllowed","handleExportFormSubmit","combineLayers","featureInMapExtent","separator","createTitleEmptyRows","exportService","onFileExportError","onFileExportSuccess","unset","forceNaming","Zr","styleListService","fx","yx","_x","bx","xx","extraMessage","loadEncodings","encodingDefaultValue","onlyUrl","onlyVector","vectorAndUrl","customList","allowedFormats","formats","validateListFormat","GeoJSON","modeChanged","selectMode","onImportExportChange","selectedMode","nu","su","ru","Gx","Pr","We","zx","toggleAutoUnit","_auto","measureType","measure$$","computeBestMeasureUnit","au","lu","Pn","La","features$","Vx","olFormatGeoJSON","features$$","overlayService","handleFeatures","$r","Wx","print","paperFormat","orientation","Df","internal","getTitleSize","addTitle","subtitle","getSubTitleSize","addSubTitle","showProjection","showScale","addProjScale","comment","addComment","addMap","addScale","handleMeasureLayer","legendPosition","addLegendSamePage","addLegend","saveDoc","getOverlayContainer","dn","backgroundColor","addCanvas","getLayersLegendHtml","getDataImage","rxMap","getLayersLegendImage","toPromise","top","timeout","useCORS","generateCanvaFileToZip","saveCanvasImageAsFile","setFont","getTextWidth","getStringUnitWidth","scaleFactor","setFontSize","zs","addPage","toDataURL","addImage","getOverlayContainerStopEvent","allowTaint","defineNbFileToProcess","nbFileToProcess","getImageSizeToFitPdf","rect","once","getViewport","renderMap","downloadMapImage","getContext","measureText","ceil","fillStyle","fillRect","fillText","drawImage","getWorldFileInformation","addFileToZip","Ns","saveFileProcessing","renderSync","updateSize","save","returnPromise","getHeight","msSaveBlob","msToBlob","toBlob","zipFile","Pf","file","getZipFile","generateAsync","cu","uu","pu","du","gu","mu","nC","imageFormat","doZipFile","isPrintService","imageFormatField","Jpeg","onlySelf","outputFormatField","Pdf","paperFormatField","Letter","orientationField","landscape","resolutionField","legendPositionField","none","titleField","subtitleField","commentField","showProjectionField","showScaleField","showLegendField","doZipFileField","handleFormSubmit","toggleImageSaveProp","hu","_outputFormat","_paperFormat","_orientation","_imageFormat","_legendPosition","_resolution","printService","Fa","$n","rC","Za","Er","qr","oi","Coord","vo","Stop","bo","Start","Intermediate","End","relativePosition","Rr","Oa","aggregatedDirection","translatedModifier","translatedDirection","coma","exit","cntSuffix","instruction","cssClass","TC","unlistenMapSingleClick","onStopEnter","stopWithHover","onStopLeave","getOptionText","chooseProposal","stopsStore","setStopText","clearStop","validateTerm","keyIsValid","invalidKeys","getNgClass","getPlaceholder","removeStop","drop","moveStops","previousIndex","currentIndex","gn","onInputFocus","stopInputHasFocus","listenMapSingleClick","stopsFeatureStore","Ot","olProj","coordRoundedDecimals","onMapClickEventKeys","MC","directionsSourceService","routeSource","reverseSearch","vu","getSources","getEnabledSources","enableSourcesByType","Ri","termIsValid","tc","getEnabledOnly","searchSourceService","searchType","En","Pa","yu","reverseSearchSources","ZC","routesFeatureStore","resetStops","clearStops","addStop","Da","copyLinkToClipboard","zoomRoute","zoomToActiveRoute$","copyDirectionsToClipboard","directionsToText","activeRoute","Jr","fu","formatStep","_u","maneuver","modifier","bearing_after","contextUri","pathname","EC","directions","activeDirection","changeRoute","formatDistance","formatDuration","onStepsListBlur","stepFeatureStore","showSegment","showRouteSegmentGeometry","olGeom","Vertex","bu","initEntityStores","ka","initOlInteraction","storeEmpty$$","storeChange$$","routesQueries$$","zoomRoute$$","freezeStores","selectStopInteraction","translateStop","selectedRoute","monitorEmptyEntityStore","monitorEntityStoreChange","monitorActiveRouteZoom","isTranslating","executeStopTranslation","focusOnStop","onStopInputHasFocusChange","getLength","storeInitialized$","debounce","handleStopDiff","handleStopsFeature","getRoutes","cancelSearch","searchs$$","previousStops","searchService","searchProposals","Text","results","addStopOverlay","directionsService","overview","alternatives","continue_straight","stopText","stopColor","stopOpacity","stop","$a","aC","Ia","Wt","Br","formatResult","encodeKey","encodeValue","decodeKey","decodeValue","xu","title$","getAllowedTypes","ecmax","computeRequestParams","page","extractResults","hashtagsLieuxToKeep","computeOptionsParam","computeTerm","encoder","JC","formatter","dataToResult","computeProperties","dataType","titleHtml","highlight","title2","title3","score","qi","nextPage","propertiesBlacklist","GoogleMaps","Qt","getGoogleMapsNameLink","municipalite","GoogleStreetView","getGoogleStreetViewLink","Cu","getSubtitle","computeExtent","pointerSummaryTitle","Su","wu","coord","igo2CoordFormat","writeGeometry","OpenStreetMap","j_","Ur","Tu","computeSearchRequestParams","computeLayerOptions","groupTitle","extractQueryParamsFromSourceUrl","metadataUrl","urls","Mu","oS","setSearchType","searchType$","searchType$$","onSetSearchType","onSearchTypeChange","getSearchTypeTitle","searchTypeChange","Ea","mS","now","pointerSummaryEnabled","pointerSummaryStatus","hasPointerReverseSearchSource","hasReverseSearchSourcesForPointerSummary","getSearchSources","computeSourcesCheckAllBehavior","settingsValueCheckedCheckbox","searchSourceChange","computeSettingCheckAllBehavior","allEnabled","searchSourcesAllEnabled","checkUncheckAll","checkUncheckAllSources","settingsValueCheckedRadioButton","onCheckSearchSource","getAvailableValues","getAvailableHashtagsValues","changePointerReverseSearch","changeSearchResultsGeometry","searchResultsGeometryEnabled","searchResultsGeometryStatus","qa","Ra","setTerm","stream$$","stream$","sn","onSetTerm","handlePlaceholder","onKeyup","onClearButtonClick","clearFeature","onSearchSettingsChange","doSearch","searchSettingsChange","minLength","input","searchTermChange","placeholder$","researches$$","termSplitter","onResearchCompleted","research","Au","FS","titleHtmlProperty","onZoomHandler","resultFocus","resultUnfocus","qn","Grouped","Fu","_term","pageIterator","_results$","liftResults","settingsChange$$","settingsChange$","computeGroupTitle","onResultSelect","resultSelect","groupResults","sortByOrder","displayOrder","Lt","moreResults","Iu","layersSubcriptions","Zu","BS","US","ngAfterContentChecked","unsubscribeReverseSearch","pointerSearchStore","computeSummaryClosestFeature","addPointerOverlay","reverseSearch$$","igoSearchPointerSummaryEnabled","onSearchCoordinate","igoSearchPointerSummaryDelay","onSearch","searchPointerSummaryFeatureId","pointerSummary","Nr","qC","BC","YC","WC","GS","Ja","Ou","Ls","getLayerWksOptionTabQuery","queryOptions","tabQuery","getLayerWksOptionMapQuery","mapQueryOnOpenTab","getInResolutionRange","Du","createWorkspace","srcId","workspaceId","Ba","createFeatureStore","br","Ii","vr","zoomAuto","createFilterInMapExtentOrResolutionStrategy","relations","ws$","class_icon","ku","zS","cancelAction","confirmedAction","newFeature","deleteFeature","deleteUrl","primary","editionWorkspaceService","editFeature","getDomainValues","relation","original_properties","original_geometry","idkey","geomType","adding$","addWithDraw","createModifyInteraction","$f","unique","modifyStyle","$u","Pu","wksConfig","editMode","saveFeature","cancelEdit","validateFeature","sanitizeParameter","addUrl","addHeaders","modifyProtocol","modifyUrl","modifyHeaders","modifyFeature","hasGeometry","refreshMap","rowsInMapExtentCheckCondition$","relationLayers$","jr","qu","Eu","VS","onLayersChange","featureWorkspaceService","changeWorkspace","wmsWorkspaceService","wfsWorkspaceService","relationLayers","rowsInMapExtentCheckCondition","layerIsEditable","getOrCreateWorkspace","workspaceStore","Ru","Ju","WS","Bu","YS","KS","directionsUrl","_name","getRouteParams","extractRoutesData","formatRoute","waypoints","geometries","legs","summary","sourceType","weight_name","Gu","endsWith","numero","epsg","computeGeometry","NoLot","Yu","place_id","display_name","osm_type","lon","lat","boundingbox","computeTermTags","computeTermSettings","Hu","storedQueriesOptions","storedquery_id","defaultValue","splitPrefix","outputformat","srsname","resultTitle","multipleFieldsQuery","extractWFSData","getFormatFromOptions","zu","longField","latField","doc_type","dw","onPointerMove","pointerCoord","gw","fw","_w","vw","bw","Cw","Sw","Mw","geometryTypeField","drawGuideField","drawGuidePlaceholder","Aw","Fw","Iw","Ow","circle","media","Dw","Pw","$w","qw","Rw","Uw","handleQueryResults","feature$","Nw","Qw","onCatalogSelectChange","catalogStore","catalogItemStore","Gw","wt","Xt","ours","basePath","contextListFile","defaultContextUri","readParamsFromRoute","hasAuthService","contexts$","handleContextsChange","loadContexts","_defaultContextUri","getById","getDetails","getDefault","defaultContextId$","getProfilByUser","setDefault","defaultContextId","hideContext","showContext","importedContext","permission","write","addToolAssociation","toolId","deleteToolAssociation","getPermissions","addPermissionAssociation","profil","typePermission","deletePermissionAssociation","getLocalContexts","getLocalContext","base","loadDefaultContext","uri","addContextToList","setContext","loadContext","context$","getContextByUri","handleContextMessage","keepCurrentView","mapViewFromRoute","loadEditedContext","setEditedContext","editedContext$","getContextFromMap","layerOptions","global","getContextFromLayers","extraFeatures","imported","getContextLayers","findContext","toolsChanged$","public","Qa","Wu","context$$","contextService","handleContextChange","minWidth","Xu","removeLayersOnContextChange","contextLayers","computeLayerVisibilityFromUrl","Ji","Ku","LT","_context","_default","context","favoriteClick","favorite","edit","manageTools","managePermissions","zr","contextsInitial","shared","_contexts","_selectedContext","_defaultContextId","contexts","filterContextsList","createContext","sortedAlpha","sortContextsList","showFilter","showContextFilter","thresholdToFilter","toggleSort","clearFilter","empty","getPermission","permissions","userSelection","indeterminate","childs","filterPermissionsChanged","showHidden","Ga","onEdit","onSave","onFavorite","onManageTools","onManagePermissions","onDelete","confirmDialogService","onClone","onCreate","showHiddenContexts","onShowContext","onHideContext","contexts$$","defaultContextId$$","selectedContext$$","selectedContext","users","op","ip","Ya","Bi","so","Ui","setImportExportType","importExportType$","setMode","selectedMode$","setsExportOptions","Tt","toolToActivateFromOptions","tool","importExportState","openSidenav$","Ha","igoStorageService","W2","storageState","storageChange$$","loadActions","buildActions","zoomAuto$","Ni","Ua","Na","toolState","maximize$","X2","ogcFilterWidget","K2","Vr","initWorkspaces","Al","workspace$","wfsActionsService","selectOnlyCheckCondition$","featureActionsService","editionActionsService","actionMaximize$$","setWorkspaceIsMaximized","activeWorkspace$$","activeWorkspaceWidget$$","activeWorkspaceWidget$","rowsInMapExtentCheckCondition$$","selectOnlyCheckCondition$$","workspaceMaximize$","setActiveWorkspaceById","setActiveWorkspaceByTitle","teardownWorkspaces","Va","searchOverlayStyle","searchOverlayStyleSelection","searchOverlayStyleFocus","searchResultsGeometryEnabled$","createCustomFilterTermStrategy","activateCustomFilterTermStrategy","deactivateCustomFilterTermStrategy","enableSearch","searchDisabled$","disableSearch","setSearchTerm","searchTerm$","setSearchSettingsChange","searchSettingsChange$","setSelectedResult","selectedResult$","setSearchResultsGeometryStatus","tA","aA","pp","TA","osmLayer","searchState","onPointerSummaryStatusChange","onSearchTermChange","searchStore","selectedFeature","onResultFocus","tryAddFeatureToMap","onOpenGoogleMaps","onOpenGoogleStreetView","removeFeatureFromMap","onContextMenuOpen","mapPosition","getCoordinateFromPixel","lonlat","mapBrowser","getBoundingClientRect","scrollY","left","scrollX","onPointerSearch","MA","zC","ow","NC","KC","nw","QC","sw","lw","LA","FA","ZA","OA","kA","Uu","Nu","Qu","ju","PA","ew","EA","qA","JA","BA","jA","getOutputType","getOutputQueryType","spatialListStore","getOutputToggleSearch","loadThematics","getOutputClearSearch","tryAddFeaturesToMap","itemType","tryAddPointToMap","tryAddLayerToMap","zoomToFeatureExtent","_internal","selectedFeature$","QA","KA","workspaceState","selectedWorkspace$","workspacePaginator","eL","iL","nL","rL","redirectTo","pathMatch","sL","useHash","aL","mobileQuery","matchMedia","_mobileQueryListener","addEventListener","themeClass","detectOldBrowser","removeEventListener","chrome","firefox","lL","addSvgIconSet","bootstrap","cL","ko","Po","Xa","bootstrapModule"],"sources":["webpack:///$_lazy_route_resources|lazy|groupOptions:%20%7B%7D|namespace%20object","webpack:///dist/core/locale|sync|/^/.*/.json$","webpack:///packages/utils/src/lib/base64.ts","webpack:///packages/utils/src/lib/user-agent.ts","webpack:///packages/utils/src/lib/clipboard.ts","webpack:///packages/utils/src/lib/string-utils.ts","webpack:///packages/utils/src/lib/change.interface.ts","webpack:///packages/utils/src/lib/change.ts","webpack:///packages/utils/src/lib/object-utils.ts","webpack:///packages/utils/src/lib/number-utils.ts","webpack:///packages/utils/src/lib/strenum.ts","webpack:///packages/utils/src/lib/uuid.ts","webpack:///packages/utils/src/lib/watcher.ts","webpack:///packages/core/src/lib/activity/activity.service.ts","webpack:///packages/core/src/lib/activity/activity.interceptor.ts","webpack:///packages/core/src/lib/activity/activity.module.ts","webpack:///packages/core/src/lib/config/version.ts","webpack:///packages/core/src/lib/config/config.service.ts","webpack:///packages/core/src/lib/config/config.provider.ts","webpack:///packages/core/src/lib/config/config.module.ts","webpack:///packages/core/src/lib/language/shared/language.loader.ts","webpack:///packages/core/src/lib/language/shared/language.provider.ts","webpack:///packages/core/src/lib/language/shared/missing-translation.guard.ts","webpack:///packages/core/src/lib/language/language.module.ts","webpack:///packages/core/src/lib/message/message.module.ts","webpack:///packages/core/src/lib/language/shared/language.service.ts","webpack:///packages/core/src/lib/message/shared/message.enum.ts","webpack:///packages/core/src/lib/message/shared/message.service.ts","webpack:///packages/core/src/lib/request/error.interceptor.ts","webpack:///packages/core/src/lib/request/error.module.ts","webpack:///packages/core/src/lib/route/route.service.ts","webpack:///packages/core/src/lib/media/media.enum.ts","webpack:///packages/core/src/lib/media/media.service.ts","webpack:///packages/core/src/lib/storage/storage.interface.ts","webpack:///packages/core/src/lib/storage/storage.service.ts","webpack:///packages/core/src/lib/network/network.service.ts","webpack:///packages/common/src/lib/entity/shared/entity.enums.ts","webpack:///packages/common/src/lib/entity/shared/entity.utils.ts","webpack:///packages/common/src/lib/entity/shared/state.ts","webpack:///packages/common/src/lib/entity/shared/view.ts","webpack:///packages/common/src/lib/entity/shared/store.ts","webpack:///packages/common/src/lib/entity/shared/watcher.ts","webpack:///packages/common/src/lib/entity/shared/strategies/strategy.ts","webpack:///packages/common/src/lib/entity/shared/strategies/filter-custom-function.ts","webpack:///packages/common/src/lib/entity/shared/strategies/filter-selection.ts","webpack:///packages/common/src/lib/entity/entity-selector/entity-selector.component.html","webpack:///packages/common/src/lib/entity/entity-selector/entity-selector.component.ts","webpack:///packages/common/src/lib/stop-propagation/stop-propagation.directive.ts","webpack:///packages/common/src/lib/entity/entity-table/entity-table-row.directive.ts","webpack:///packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.ts","webpack:///packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.html","webpack:///packages/common/src/lib/image/secure-image.pipe.ts","webpack:///packages/common/src/lib/custom-html/custom-html.pipe.ts","webpack:///packages/common/src/lib/entity/entity-table/entity-table.component.html","webpack:///packages/common/src/lib/entity/entity-table/entity-table.component.ts","webpack:///packages/common/src/lib/action/shared/action.enums.ts","webpack:///packages/common/src/lib/action/actionbar/actionbar-item.component.html","webpack:///packages/common/src/lib/action/actionbar/actionbar-item.component.ts","webpack:///packages/common/src/lib/action/actionbar/actionbar.component.html","webpack:///packages/common/src/lib/action/actionbar/actionbar.component.ts","webpack:///packages/common/src/lib/action/actionbar/actionbar.module.ts","webpack:///packages/common/src/lib/action/action.module.ts","webpack:///packages/common/src/lib/badge-icon/badge-icon.directive.ts","webpack:///packages/common/src/lib/badge-icon/badge-icon.module.ts","webpack:///packages/common/src/lib/clickout/clickout.directive.ts","webpack:///packages/common/src/lib/clickout/clickout.module.ts","webpack:///packages/common/src/lib/collapsible/collapse.directive.ts","webpack:///packages/common/src/lib/collapsible/collapsible.component.ts","webpack:///packages/common/src/lib/collapsible/collapsible.component.html","webpack:///packages/common/src/lib/collapsible/collapsible.module.ts","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.component.ts","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.component.html","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.service.ts","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.module.ts","webpack:///packages/common/src/lib/context-menu/context-menu.directive.ts","webpack:///packages/common/src/lib/context-menu/context-menu.module.ts","webpack:///packages/common/src/lib/custom-html/custom-html.module.ts","webpack:///packages/common/src/lib/drag-drop/drag-drop.module.ts","webpack:///packages/common/src/lib/dynamic-component/shared/dynamic-component.ts","webpack:///packages/common/src/lib/dynamic-component/shared/dynamic-component.service.ts","webpack:///packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.ts","webpack:///packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.html","webpack:///packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.module.ts","webpack:///packages/common/src/lib/dynamic-component/dynamic-component.module.ts","webpack:///packages/common/src/lib/flexible/flexible.module.ts","webpack:///packages/common/src/lib/form/form/form.component.ts","webpack:///packages/common/src/lib/form/shared/form.utils.ts","webpack:///packages/common/src/lib/form/form/form.component.html","webpack:///packages/common/src/lib/form/form/form.module.ts","webpack:///packages/common/src/lib/form/shared/form.service.ts","webpack:///packages/common/src/lib/form/shared/form-field.service.ts","webpack:///packages/common/src/lib/form/form-field/form-field.component.html","webpack:///packages/common/src/lib/form/form-field/form-field.component.ts","webpack:///packages/common/src/lib/form/form-field/form-field.module.ts","webpack:///packages/common/src/lib/form/form-group/form-group.component.html","webpack:///packages/common/src/lib/form/form-group/form-group.component.ts","webpack:///packages/common/src/lib/form/form-group/form-group.module.ts","webpack:///packages/common/src/lib/form/form.module.ts","webpack:///packages/common/src/lib/entity/entity-selector/entity-selector.module.ts","webpack:///packages/common/src/lib/stop-propagation/stop-propagation.module.ts","webpack:///packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.module.ts","webpack:///packages/common/src/lib/image/image.module.ts","webpack:///packages/common/src/lib/entity/entity-table/entity-table.module.ts","webpack:///packages/common/src/lib/entity/entity.module.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.loader.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.service.ts","webpack:///packages/common/src/lib/tool/shared/toolbox.ts","webpack:///packages/common/src/lib/tool/shared/tool.service.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.component.html","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.component.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.module.ts","webpack:///packages/common/src/lib/keyvalue/keyvalue.pipe.ts","webpack:///packages/common/src/lib/keyvalue/keyvalue.module.ts","webpack:///packages/common/src/lib/list/list-item.directive.ts","webpack:///packages/common/src/lib/list/list.component.ts","webpack:///packages/common/src/lib/list/list.component.html","webpack:///packages/common/src/lib/list/list.module.ts","webpack:///packages/common/src/lib/panel/panel.component.html","webpack:///packages/common/src/lib/panel/panel.component.ts","webpack:///packages/common/src/lib/panel/panel.module.ts","webpack:///packages/common/src/lib/spinner/spinner.component.ts","webpack:///packages/common/src/lib/spinner/spinner.component.html","webpack:///packages/common/src/lib/spinner/spinner-activity.directive.ts","webpack:///packages/common/src/lib/spinner/spinner.module.ts","webpack:///packages/common/src/lib/table/table-datasource.ts","webpack:///packages/common/src/lib/table/table-action-color.enum.ts","webpack:///packages/common/src/lib/table/table.component.html","webpack:///packages/common/src/lib/table/table.component.ts","webpack:///packages/common/src/lib/table/table.module.ts","webpack:///packages/common/src/lib/action/shared/store.ts","webpack:///packages/common/src/lib/tool/shared/toolbox.enums.ts","webpack:///packages/common/src/lib/tool/toolbox/toolbox.animation.ts","webpack:///packages/common/src/lib/tool/toolbox/toolbox.component.html","webpack:///packages/common/src/lib/tool/toolbox/toolbox.component.ts","webpack:///packages/common/src/lib/tool/toolbox/toolbox.module.ts","webpack:///packages/common/src/lib/tool/tool.module.ts","webpack:///packages/common/src/lib/widget/widget-outlet/widget-outlet.component.html","webpack:///packages/common/src/lib/widget/widget-outlet/widget-outlet.component.ts","webpack:///packages/common/src/lib/widget/widget-outlet/widget-outlet.module.ts","webpack:///packages/common/src/lib/widget/shared/widget.service.ts","webpack:///packages/common/src/lib/widget/widget.module.ts","webpack:///packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.ts","webpack:///packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.html","webpack:///packages/common/src/lib/workspace/workspace-selector/workspace-selector.module.ts","webpack:///packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.html","webpack:///packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.ts","webpack:///packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.module.ts","webpack:///packages/common/src/lib/workspace/workspace.module.ts","webpack:///packages/common/src/lib/table/table-database.ts","webpack:///packages/common/src/lib/tool/shared/tool-component.ts","webpack:///packages/common/src/lib/workspace/shared/store.ts","webpack:///packages/common/src/lib/workspace/shared/workspace.ts","webpack:///demo/src/app/core/home/home-routing.module.ts","webpack:///demo/src/app/core/home/home.component.ts","webpack:///demo/src/app/core/home/home.component.html","webpack:///demo/src/app/core/home/home.module.ts","webpack:///demo/src/app/core/activity/activity-routing.module.ts","webpack:///demo/src/app/core/activity/activity.component.ts","webpack:///demo/src/app/core/activity/activity.component.html","webpack:///demo/src/app/core/activity/activity.module.ts","webpack:///demo/src/environments/environment.prod.ts","webpack:///demo/src/app/core/config/config-routing.module.ts","webpack:///demo/src/app/core/config/config.component.ts","webpack:///demo/src/app/core/config/config.component.html","webpack:///demo/src/app/core/config/config.module.ts","webpack:///demo/src/app/core/language/language-routing.module.ts","webpack:///demo/src/app/core/language/language.component.ts","webpack:///demo/src/app/core/language/language.component.html","webpack:///demo/src/app/core/language/language.module.ts","webpack:///demo/src/app/core/media/media-routing.module.ts","webpack:///demo/src/app/core/media/media.component.ts","webpack:///demo/src/app/core/media/media.component.html","webpack:///demo/src/app/core/media/media.module.ts","webpack:///demo/src/app/core/message/message-routing.module.ts","webpack:///demo/src/app/core/message/message.component.ts","webpack:///demo/src/app/core/message/message.component.html","webpack:///demo/src/app/core/message/message.module.ts","webpack:///demo/src/app/core/request/request-routing.module.ts","webpack:///demo/src/app/core/request/request.component.ts","webpack:///demo/src/app/core/request/request.component.html","webpack:///demo/src/app/core/request/request.module.ts","webpack:///demo/src/app/common/action/action.component.html","webpack:///demo/src/app/common/action/action-routing.module.ts","webpack:///demo/src/app/common/action/action.component.ts","webpack:///demo/src/app/common/action/action.module.ts","webpack:///demo/src/app/common/dynamic-component/dynamic-component.component.ts","webpack:///demo/src/app/common/dynamic-component/dynamic-component-routing.module.ts","webpack:///demo/src/app/common/dynamic-component/dynamic-component.component.html","webpack:///demo/src/app/common/dynamic-component/dynamic-component.module.ts","webpack:///demo/src/app/common/entity-table/entity-table-routing.module.ts","webpack:///demo/src/app/common/entity-table/entity-table.component.ts","webpack:///demo/src/app/common/entity-table/entity-table.component.html","webpack:///demo/src/app/common/entity-table/entity-table.module.ts","webpack:///demo/src/app/common/entity-selector/entity-selector.component.html","webpack:///demo/src/app/common/entity-selector/entity-selector-routing.module.ts","webpack:///demo/src/app/common/entity-selector/entity-selector.component.ts","webpack:///demo/src/app/common/entity-selector/entity-selector.module.ts","webpack:///demo/src/app/common/form/form.component.html","webpack:///demo/src/app/common/form/form-routing.module.ts","webpack:///demo/src/app/common/form/form.component.ts","webpack:///demo/src/app/common/form/form.module.ts","webpack:///demo/src/app/common/table/table-routing.module.ts","webpack:///demo/src/app/common/table/table.component.ts","webpack:///demo/src/app/common/table/table.component.html","webpack:///demo/src/app/common/table/table.module.ts","webpack:///demo/src/app/common/tool/tool.component.html","webpack:///demo/src/app/common/tool/tool.component.ts","webpack:///demo/src/app/common/tool/tool-routing.module.ts","webpack:///demo/src/app/common/tool/tool.module.ts","webpack:///demo/src/app/common/widget/widget.component.ts","webpack:///demo/src/app/common/widget/widget-routing.module.ts","webpack:///demo/src/app/common/widget/widget.component.html","webpack:///demo/src/app/common/widget/widget.module.ts","webpack:///packages/auth/src/lib/shared/token.service.ts","webpack:///packages/auth/src/lib/shared/auth.service.ts","webpack:///packages/auth/src/lib/auth-form/auth-google.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-google.component.html","webpack:///packages/auth/src/lib/auth-form/auth-microsoft.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-microsoft.component.html","webpack:///packages/auth/src/lib/shared/auth-msalServiceb2c.service..ts","webpack:///packages/auth/src/lib/shared/auth-msalBroadcastServiceb2c.service.ts","webpack:///packages/auth/src/lib/auth-form/auth-microsoftb2c.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-microsoftb2c.component.html","webpack:///packages/auth/src/lib/auth-form/auth-facebook.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-facebook.component.html","webpack:///packages/auth/src/lib/auth-form/auth-intern.component.html","webpack:///packages/auth/src/lib/auth-form/auth-intern.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-form.component.html","webpack:///packages/auth/src/lib/auth-form/auth-form.component.ts","webpack:///packages/auth/src/lib/shared/auth.interceptor.ts","webpack:///packages/auth/src/lib/shared/auth-microsoft.provider.ts","webpack:///packages/auth/src/lib/shared/storage.service.ts","webpack:///packages/auth/src/lib/auth.module.ts","webpack:///demo/src/app/auth/auth-form/auth-form-routing.module.ts","webpack:///demo/src/app/auth/auth-form/auth-form.component.ts","webpack:///demo/src/app/auth/auth-form/auth-form.component.html","webpack:///demo/src/app/auth/auth-form/auth-form.module.ts","webpack:///packages/geo/src/lib/metadata/shared/metadata.service.ts","webpack:///packages/geo/src/lib/metadata/metadata-button/metadata-button.component.html","webpack:///packages/geo/src/lib/metadata/metadata-button/metadata-abstract.component.html","webpack:///packages/geo/src/lib/metadata/metadata-button/metadata-button.component.ts","webpack:///packages/geo/src/lib/metadata/metadata.module.ts","webpack:///packages/geo/src/lib/feature/shared/feature.enums.ts","webpack:///packages/geo/src/lib/layer/utils/image-watcher.ts","webpack:///packages/geo/src/lib/layer/utils/layer.utils.ts","webpack:///packages/geo/src/lib/layer/shared/layers/layer.interface.ts","webpack:///packages/geo/src/lib/utils/id-generator.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/datasource.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter.enum.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter.ts","webpack:///packages/geo/src/lib/query/shared/query.enums.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wms-wfs.utils.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wms-datasource.ts","webpack:///packages/geo/src/lib/layer/utils/layerSync-watcher.ts","webpack:///packages/geo/src/lib/layer/utils/tile-watcher.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/feature-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/cluster-datasource.ts","webpack:///packages/geo/src/lib/layer/utils/vector-watcher.ts","webpack:///packages/geo/src/lib/map/shared/map.utils.ts","webpack:///packages/geo/src/lib/layer/shared/layers/layer.ts","webpack:///packages/geo/src/lib/layer/shared/layers/vector-layer.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/osm-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/xyz-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wfs-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wfs.service.ts","webpack:///packages/geo/src/lib/datasource/utils/tilegrid.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wmts-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/carto-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/arcgisrest-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/imagearcgisrest-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/tilearcgisrest-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/tiledebug-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/websocket-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/mvt-datasource.ts","webpack:///packages/geo/src/lib/datasource/utils/esri-style-generator.ts","webpack:///packages/geo/src/lib/filter/shared/time-filter.enum.ts","webpack:///packages/geo/src/lib/map/shared/map.service.ts","webpack:///packages/geo/src/lib/datasource/shared/capabilities.service.ts","webpack:///packages/geo/src/lib/map/shared/projection.service.ts","webpack:///packages/geo/src/lib/datasource/shared/datasource.service.ts","webpack:///packages/geo/src/lib/feature/shared/feature.utils.ts","webpack:///packages/geo/src/lib/feature/shared/store.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/in-map-extent.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/in-map-resolution.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/loading.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/loading-layer.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/selection.ts","webpack:///packages/geo/src/lib/feature/shared/strategies.utils.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay-marker-style.utils.ts","webpack:///packages/geo/src/lib/layer/shared/style.service.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.utils.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.ts","webpack:///packages/geo/src/lib/map/utils/layer-watcher.ts","webpack:///packages/geo/src/lib/map/shared/map.enums.ts","webpack:///packages/geo/src/lib/map/shared/controllers/controller.ts","webpack:///packages/geo/src/lib/map/shared/controllers/view.ts","webpack:///packages/geo/src/lib/map/shared/map.ts","webpack:///packages/geo/src/lib/map/map-browser/map-browser.component.ts","webpack:///packages/geo/src/lib/map/map-browser/map-browser.component.html","webpack:///packages/geo/src/lib/map/shared/map-pointer-position.directive.ts","webpack:///packages/geo/src/lib/layer/shared/layers/image-layer.ts","webpack:///packages/geo/src/lib/layer/shared/layers/tile-layer.ts","webpack:///packages/geo/src/lib/layer/shared/layers/vectortile-layer.ts","webpack:///packages/geo/src/lib/map/shared/hover-feature.directive.ts","webpack:///packages/geo/src/lib/map/zoom-button/zoom-button.component.ts","webpack:///packages/geo/src/lib/map/zoom-button/zoom-button.component.html","webpack:///packages/geo/src/lib/map/geolocate-button/geolocate-button.component.ts","webpack:///packages/geo/src/lib/map/geolocate-button/geolocate-button.component.html","webpack:///packages/geo/src/lib/map/home-extent-button/home-extent-button.component.ts","webpack:///packages/geo/src/lib/map/home-extent-button/home-extent-button.component.html","webpack:///packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.html","webpack:///packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.ts","webpack:///packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.animation.ts","webpack:///packages/geo/src/lib/layer/shared/layer.service.ts","webpack:///packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.html","webpack:///packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.ts","webpack:///packages/geo/src/lib/map/rotation-button/rotation-button.component.html","webpack:///packages/geo/src/lib/map/rotation-button/rotation-button.component.ts","webpack:///packages/geo/src/lib/map/info-section/info-section.component.html","webpack:///packages/geo/src/lib/map/info-section/info-section.component.ts","webpack:///packages/geo/src/lib/catalog/shared/catalog.enum.ts","webpack:///packages/geo/src/lib/catalog/shared/catalog.abstract.ts","webpack:///packages/geo/src/lib/query/shared/query.service.ts","webpack:///packages/geo/src/lib/query/shared/query.utils.ts","webpack:///packages/geo/src/lib/query/shared/query.directive.ts","webpack:///packages/geo/src/lib/search/shared/sources/source.ts","webpack:///packages/geo/src/lib/query/shared/query-search-source.ts","webpack:///packages/geo/src/lib/utils/googleLinks.ts","webpack:///packages/geo/src/lib/utils/osmLinks.ts","webpack:///packages/geo/src/lib/catalog/shared/catalog.service.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.html","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.ts","webpack:///packages/geo/src/lib/layer/layer-legend/layer-legend.component.html","webpack:///packages/geo/src/lib/layer/layer-legend/layer-legend.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.html","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.html","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.ts","webpack:///packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.service.ts","webpack:///packages/geo/src/lib/layer/layer-item/layer-item.component.html","webpack:///packages/geo/src/lib/layer/layer-item/layer-item.component.ts","webpack:///packages/geo/src/lib/layer/layer-list/layer-list.enum.ts","webpack:///packages/geo/src/lib/layer/layer-list/layer-list.component.html","webpack:///packages/geo/src/lib/layer/layer-list/layer-list.component.ts","webpack:///packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.html","webpack:///packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.ts","webpack:///packages/geo/src/lib/layer/layer-list/layer-list-binding.directive.ts","webpack:///packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.html","webpack:///packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.ts","webpack:///packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.html","webpack:///packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.ts","webpack:///packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.ts","webpack:///packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.html","webpack:///packages/geo/src/lib/layer/layer.module.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser.module.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.html","webpack:///packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library.component.html","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.html","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library.module.ts","webpack:///packages/geo/src/lib/catalog/catalog.module.ts","webpack:///packages/geo/src/lib/filter/shared/filterable-datasource.pipe.ts","webpack:///packages/geo/src/lib/filter/shared/time-filter.service.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter.service.ts","webpack:///packages/geo/src/lib/filter/shared/spatial-filter.enum.ts","webpack:///packages/geo/src/lib/filter/shared/spatial-filter.service.ts","webpack:///packages/geo/src/lib/download/shared/download.service.ts","webpack:///packages/geo/src/lib/download/download-button/download-button.component.html","webpack:///packages/geo/src/lib/download/download-button/download-button.component.ts","webpack:///packages/geo/src/lib/download/download.module.ts","webpack:///packages/geo/src/lib/feature/feature-details/feature-details.component.html","webpack:///packages/geo/src/lib/feature/feature-details/feature-details.component.ts","webpack:///packages/geo/src/lib/draw/shared/draw.enum.ts","webpack:///packages/geo/src/lib/geometry/shared/geometry.utils.ts","webpack:///packages/geo/src/lib/geometry/shared/geometry.errors.ts","webpack:///packages/geo/src/lib/geometry/shared/controls/draw.ts","webpack:///packages/geo/src/lib/draw/draw/draw-popup.component.ts","webpack:///packages/geo/src/lib/draw/draw/draw-popup.component.html","webpack:///packages/geo/src/lib/draw/draw/draw-shorcuts.component.ts","webpack:///packages/geo/src/lib/draw/draw/draw-shorcuts.component.html","webpack:///packages/geo/src/lib/measure/shared/measure.enum.ts","webpack:///packages/geo/src/lib/measure/shared/measure.utils.ts","webpack:///packages/geo/src/lib/draw/shared/draw.utils.ts","webpack:///packages/geo/src/lib/draw/shared/draw-style.service.ts","webpack:///packages/geo/src/lib/draw/shared/draw-icon.service.ts","webpack:///packages/geo/src/lib/draw/draw/draw.component.html","webpack:///packages/geo/src/lib/draw/draw/draw.component.ts","webpack:///packages/geo/src/lib/draw/draw/draw.module.ts","webpack:///packages/geo/src/lib/feature/feature-details/feature-details.module.ts","webpack:///packages/geo/src/lib/feature/feature-form/feature-form.module.ts","webpack:///packages/geo/src/lib/feature/feature.module.ts","webpack:///packages/geo/src/lib/geometry/shared/controls/modify.ts","webpack:///packages/geo/src/lib/layer/shared/layer.enums.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer-dialog.component.html","webpack:///packages/geo/src/lib/measure/measurer/measurer-dialog.component.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer.component.html","webpack:///packages/geo/src/lib/measure/measurer/measurer.component.ts","webpack:///packages/geo/src/lib/measure/measurer/measure-format.pipe.ts","webpack:///packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.ts","webpack:///packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.html","webpack:///packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field.module.ts","webpack:///packages/geo/src/lib/geometry/geometry.module.ts","webpack:///packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.html","webpack:///packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.ts","webpack:///packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.html","webpack:///packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.ts","webpack:///packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.html","webpack:///packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.ts","webpack:///packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.html","webpack:///packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.ts","webpack:///packages/geo/src/lib/wkt/shared/wkt.service.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.html","webpack:///packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.html","webpack:///packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.html","webpack:///packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter-time.service.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.ts","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.html","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.ts","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.html","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.ts","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.html","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.html","webpack:///packages/geo/src/lib/filter/filter.module.ts","webpack:///packages/geo/src/lib/import-export/shared/export.errors.ts","webpack:///packages/geo/src/lib/import-export/shared/export.type.ts","webpack:///packages/geo/src/lib/import-export/shared/export.service.ts","webpack:///packages/utils/src/lib/file.ts","webpack:///packages/geo/src/lib/import-export/shared/import.utils.ts","webpack:///packages/geo/src/lib/import-export/shared/import.errors.ts","webpack:///packages/geo/src/lib/import-export/shared/import.service.ts","webpack:///packages/geo/src/lib/import-export/style-list/style-list.service.ts","webpack:///packages/geo/src/lib/import-export/import-export/import-export.component.html","webpack:///packages/geo/src/lib/import-export/import-export/import-export.component.ts","webpack:///packages/geo/src/lib/map/shared/projection.utils.ts","webpack:///packages/geo/src/lib/import-export/shared/export.utils.ts","webpack:///packages/geo/src/lib/import-export/style-list/style-list.provider.ts","webpack:///packages/geo/src/lib/import-export/style-list/style-list.module.ts","webpack:///packages/geo/src/lib/import-export/import-export.module.ts","webpack:///packages/geo/src/lib/map/map.module.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer-item.component.html","webpack:///packages/geo/src/lib/measure/measurer/measurer-item.component.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer.module.ts","webpack:///packages/geo/src/lib/measure/measure.module.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.enum.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.service.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.directive.ts","webpack:///packages/geo/src/lib/overlay/overlay.module.ts","webpack:///packages/geo/src/lib/print/shared/print.service.ts","webpack:///packages/geo/src/lib/layer/utils/outputLegend.ts","webpack:///packages/geo/src/lib/print/shared/print.type.ts","webpack:///packages/geo/src/lib/print/print-form/print-form.component.html","webpack:///packages/geo/src/lib/print/print-form/print-form.component.ts","webpack:///packages/geo/src/lib/print/print/print.component.ts","webpack:///packages/geo/src/lib/print/print/print.component.html","webpack:///packages/geo/src/lib/print/print.module.ts","webpack:///packages/geo/src/lib/query/shared/query-search-source.providers.ts","webpack:///packages/geo/src/lib/query/query.module.ts","webpack:///packages/geo/src/lib/directions/shared/directions-source.service.ts","webpack:///packages/geo/src/lib/directions/shared/directions.enum.ts","webpack:///packages/geo/src/lib/directions/shared/directions.utils.ts","webpack:///packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.html","webpack:///packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.ts","webpack:///packages/geo/src/lib/directions/shared/directions.service.ts","webpack:///packages/geo/src/lib/search/shared/search.utils.ts","webpack:///packages/geo/src/lib/search/shared/search-source.service.ts","webpack:///packages/geo/src/lib/search/shared/search.service.ts","webpack:///packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.html","webpack:///packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.ts","webpack:///packages/geo/src/lib/directions/directions-results/directions-results.component.html","webpack:///packages/geo/src/lib/directions/directions-results/directions-results.component.ts","webpack:///packages/geo/src/lib/directions/directions.component.ts","webpack:///packages/geo/src/lib/directions/directions.component.html","webpack:///packages/geo/src/lib/directions/directions.module.ts","webpack:///packages/geo/src/lib/search/shared/search-source-service.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/icherche.ts","webpack:///packages/geo/src/lib/search/shared/sources/icherche.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/coordinates.ts","webpack:///packages/geo/src/lib/search/shared/sources/coordinates.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/ilayer.ts","webpack:///packages/geo/src/lib/search/shared/sources/ilayer.providers.ts","webpack:///packages/geo/src/lib/search/shared/search.enums.ts","webpack:///packages/geo/src/lib/search/search-selector/search-selector.component.html","webpack:///packages/geo/src/lib/search/search-selector/search-selector.component.ts","webpack:///packages/geo/src/lib/search/search-selector/search-selector.module.ts","webpack:///packages/geo/src/lib/search/search-settings/search-settings.component.html","webpack:///packages/geo/src/lib/search/search-settings/search-settings.component.ts","webpack:///packages/geo/src/lib/search/search-settings/search-settings.module.ts","webpack:///packages/geo/src/lib/search/search-bar/search-bar.component.html","webpack:///packages/geo/src/lib/search/search-bar/search-bar.component.ts","webpack:///packages/geo/src/lib/search/search-bar/search-bar.module.ts","webpack:///packages/geo/src/lib/search/search-results/search-results-item.component.html","webpack:///packages/geo/src/lib/search/search-results/search-results-item.component.ts","webpack:///packages/geo/src/lib/search/search-results/search-results.component.html","webpack:///packages/geo/src/lib/search/search-results/search-results.component.ts","webpack:///packages/geo/src/lib/search/search-results/search-results-add-button.component.html","webpack:///packages/geo/src/lib/search/search-results/search-results-add-button.component.ts","webpack:///packages/geo/src/lib/search/search-results/search-results.module.ts","webpack:///packages/geo/src/lib/search/shared/search-pointer-summary.directive.ts","webpack:///packages/geo/src/lib/search/search.module.ts","webpack:///packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.ts","webpack:///packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.html","webpack:///packages/geo/src/lib/workspace/widgets/widgets.ts","webpack:///packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.module.ts","webpack:///packages/geo/src/lib/workspace/shared/wfs-workspace.ts","webpack:///packages/geo/src/lib/workspace/shared/wfs-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/shared/wms-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.ts","webpack:///packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.html","webpack:///packages/geo/src/lib/workspace/shared/edition-workspace.ts","webpack:///packages/geo/src/lib/workspace/shared/edition-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/shared/feature-workspace.ts","webpack:///packages/geo/src/lib/workspace/shared/feature-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/workspace-selector/workspace-selector.directive.ts","webpack:///packages/geo/src/lib/workspace/workspace-selector/workspace-selector.module.ts","webpack:///packages/geo/src/lib/workspace/workspace-updator/workspace-updator.module.ts","webpack:///packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.module.ts","webpack:///packages/geo/src/lib/workspace/workspace.module.ts","webpack:///packages/geo/src/lib/directions/shared/store.ts","webpack:///packages/geo/src/lib/directions/directions-sources/osrm-directions-source.ts","webpack:///packages/geo/src/lib/directions/directions-sources/directions-source.provider.ts","webpack:///packages/geo/src/lib/search/shared/sources/cadastre.ts","webpack:///packages/geo/src/lib/search/shared/sources/cadastre.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/nominatim.ts","webpack:///packages/geo/src/lib/search/shared/sources/nominatim.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/storedqueries.ts","webpack:///packages/geo/src/lib/search/shared/sources/storedqueries.providers.ts","webpack:///packages/geo/src/lib/workspace/shared/workspace.utils.ts","webpack:///demo/src/app/geo/simple-map/simple-map.component.html","webpack:///demo/src/app/geo/simple-map/simple-map-routing.module.ts","webpack:///demo/src/app/geo/simple-map/simple-map.component.ts","webpack:///demo/src/app/geo/simple-map/simple-map.module.ts","webpack:///demo/src/app/geo/layer/layer.component.html","webpack:///demo/src/app/geo/layer/layer-routing.module.ts","webpack:///demo/src/app/geo/layer/layer.component.ts","webpack:///demo/src/app/geo/layer/layer.module.ts","webpack:///demo/src/app/geo/legend/legend-routing.module.ts","webpack:///demo/src/app/geo/legend/legend.component.ts","webpack:///demo/src/app/geo/legend/legend.component.html","webpack:///demo/src/app/geo/legend/legend.module.ts","webpack:///demo/src/app/geo/overlay/overlay-routing.module.ts","webpack:///demo/src/app/geo/overlay/overlay.component.ts","webpack:///demo/src/app/geo/overlay/overlay.component.html","webpack:///demo/src/app/geo/overlay/overlay.module.ts","webpack:///demo/src/app/geo/geometry/geometry.component.html","webpack:///demo/src/app/geo/geometry/geometry-routing.module.ts","webpack:///demo/src/app/geo/geometry/geometry.component.ts","webpack:///demo/src/app/geo/geometry/geometry.module.ts","webpack:///demo/src/app/geo/feature/feature-routing.module.ts","webpack:///demo/src/app/geo/feature/feature.component.ts","webpack:///demo/src/app/geo/feature/feature.component.html","webpack:///demo/src/app/geo/feature/feature.module.ts","webpack:///demo/src/app/geo/hover/hover-routing.module.ts","webpack:///demo/src/app/geo/hover/hover.component.ts","webpack:///demo/src/app/geo/hover/hover.component.html","webpack:///demo/src/app/geo/hover/hover.module.ts","webpack:///demo/src/app/geo/measure/measure-routing.module.ts","webpack:///demo/src/app/geo/measure/measure.component.ts","webpack:///demo/src/app/geo/measure/measure.component.html","webpack:///demo/src/app/geo/measure/measure.module.ts","webpack:///demo/src/app/geo/draw/draw-routing.module.ts","webpack:///demo/src/app/geo/draw/draw.component.ts","webpack:///demo/src/app/geo/draw/draw.component.html","webpack:///demo/src/app/geo/draw/draw.module.ts","webpack:///demo/src/app/geo/query/query.component.html","webpack:///demo/src/app/geo/query/query-routing.module.ts","webpack:///demo/src/app/geo/query/query.component.ts","webpack:///demo/src/app/geo/query/query.module.ts","webpack:///demo/src/app/geo/catalog/catalog-routing.module.ts","webpack:///demo/src/app/geo/catalog/catalog.component.ts","webpack:///demo/src/app/geo/catalog/catalog.component.html","webpack:///demo/src/app/geo/catalog/catalog.module.ts","webpack:///packages/context/src/lib/context-import-export/shared/context-export.errors.ts","webpack:///packages/context/src/lib/context-import-export/shared/context-import.errors.ts","webpack:///packages/context/src/lib/context-manager/shared/context.enum.ts","webpack:///packages/context/src/lib/context-manager/shared/context.service.ts","webpack:///packages/context/src/lib/context-import-export/context-import-export.module.ts","webpack:///packages/context/src/lib/context-manager/shared/map-context.directive.ts","webpack:///packages/context/src/lib/context-manager/shared/layer-context.directive.ts","webpack:///packages/context/src/lib/context-import-export/shared/context-import.utils.ts","webpack:///packages/context/src/lib/context-manager/context-list/context-list.enum.ts","webpack:///packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.ts","webpack:///packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.html","webpack:///packages/context/src/lib/context-manager/context-item/context-item.component.html","webpack:///packages/context/src/lib/context-manager/context-item/context-item.component.ts","webpack:///packages/context/src/lib/context-manager/context-list/context-list.component.html","webpack:///packages/context/src/lib/context-manager/context-list/context-list.component.ts","webpack:///packages/context/src/lib/context-manager/context-list/context-list-binding.directive.ts","webpack:///packages/context/src/lib/context-map-button/poi-button/shared/poi.service.ts","webpack:///packages/context/src/lib/context-map-button/context-map-button.module.ts","webpack:///packages/context/src/lib/context-manager/context-manager.module.ts","webpack:///packages/integration/src/lib/import-export/import-export.state.ts","webpack:///packages/integration/src/lib/tool/tool.state.ts","webpack:///packages/integration/src/lib/workspace/shared/workspace.utils.ts","webpack:///packages/integration/src/lib/storage/storage.state.ts","webpack:///packages/integration/src/lib/workspace/shared/feature-actions.service.ts","webpack:///packages/integration/src/lib/workspace/shared/wfs-actions.service.ts","webpack:///packages/integration/src/lib/workspace/shared/edition-actions.service.ts","webpack:///packages/integration/src/lib/workspace/workspace.state.ts","webpack:///packages/integration/src/lib/search/search.state.ts","webpack:///packages/integration/src/lib/search/search-bar/search-bar.module.ts","webpack:///packages/integration/src/lib/search/search-results-tool/search-results-tool.module.ts","webpack:///packages/integration/src/lib/search/search.module.ts","webpack:///demo/src/app/geo/search/search.component.html","webpack:///demo/src/app/geo/search/search-routing.module.ts","webpack:///demo/src/app/geo/search/search.component.ts","webpack:///demo/src/app/geo/search/search.module.ts","webpack:///demo/src/app/geo/print/print-routing.module.ts","webpack:///demo/src/app/geo/print/print.component.ts","webpack:///demo/src/app/geo/print/print.component.html","webpack:///demo/src/app/geo/print/print.module.ts","webpack:///demo/src/app/geo/import-export/import-export-routing.module.ts","webpack:///demo/src/app/geo/import-export/import-export.component.ts","webpack:///demo/src/app/geo/import-export/import-export.component.html","webpack:///demo/src/app/geo/import-export/import-export.module.ts","webpack:///demo/src/app/geo/directions/directions-routing.module.ts","webpack:///demo/src/app/geo/directions/directions.component.ts","webpack:///demo/src/app/geo/directions/directions.component.html","webpack:///demo/src/app/geo/directions/directions.module.ts","webpack:///demo/src/app/geo/time-filter/time-filter-routing.module.ts","webpack:///demo/src/app/geo/time-filter/time-filter.component.ts","webpack:///demo/src/app/geo/time-filter/time-filter.component.html","webpack:///demo/src/app/geo/time-filter/time-filter.module.ts","webpack:///demo/src/app/geo/ogc-filter/ogc-filter-routing.module.ts","webpack:///demo/src/app/geo/ogc-filter/ogc-filter.component.ts","webpack:///demo/src/app/geo/ogc-filter/ogc-filter.component.html","webpack:///demo/src/app/geo/ogc-filter/ogc-filter.module.ts","webpack:///demo/src/app/geo/spatial-filter/spatial-filter.component.html","webpack:///demo/src/app/geo/spatial-filter/spatial-filter-routing.module.ts","webpack:///demo/src/app/geo/spatial-filter/spatial-filter.component.ts","webpack:///demo/src/app/geo/spatial-filter/spatial-filter.module.ts","webpack:///demo/src/app/geo/workspace/workspace.component.html","webpack:///demo/src/app/geo/workspace/workspace-routing.module.ts","webpack:///demo/src/app/geo/workspace/workspace.component.ts","webpack:///demo/src/app/geo/workspace/workspace.module.ts","webpack:///demo/src/app/context/context/context.component.html","webpack:///demo/src/app/context/context/context-routing.module.ts","webpack:///demo/src/app/context/context/context.component.ts","webpack:///demo/src/app/context/context/context.module.ts","webpack:///demo/src/app/app-routing.module.ts","webpack:///demo/src/app/app.component.ts","webpack:///demo/src/app/app.component.html","webpack:///demo/src/app/app.module.ts","webpack:///demo/src/main.ts","webpack:///node_modules/moment/locale|sync|/^/.*$"],"sourcesContent":["function webpackEmptyAsyncContext(req) {\n\t// Here Promise.resolve().then() is used instead of new Promise() to prevent\n\t// uncaught exception popping up in devtools\n\treturn Promise.resolve().then(function() {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t});\n}\nwebpackEmptyAsyncContext.keys = function() { return []; };\nwebpackEmptyAsyncContext.resolve = webpackEmptyAsyncContext;\nwebpackEmptyAsyncContext.id = 98255;\nmodule.exports = webpackEmptyAsyncContext;","var map = {\n\t\"./en.auth.json\": 50257,\n\t\"./en.common.json\": 35488,\n\t\"./en.context.json\": 88952,\n\t\"./en.core.json\": 63154,\n\t\"./en.geo.json\": 10711,\n\t\"./en.integration.json\": 32766,\n\t\"./en.json\": 10503,\n\t\"./fr.auth.json\": 8555,\n\t\"./fr.common.json\": 20551,\n\t\"./fr.context.json\": 68079,\n\t\"./fr.core.json\": 5415,\n\t\"./fr.geo.json\": 27268,\n\t\"./fr.integration.json\": 63031,\n\t\"./fr.json\": 65962\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 36438;","/* eslint-disable */\r\n\r\nconst ALPHA =\r\n  'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\r\n\r\nexport class Base64 {\r\n  private static PADCHAR: string = '=';\r\n  private static ALPHA: string = ALPHA;\r\n\r\n  private static getByte(s: string, i: number): number {\r\n    const x = s.charCodeAt(i);\r\n    return x;\r\n  }\r\n\r\n  private static getByte64(s: string, i: number): number {\r\n    const idx = this.ALPHA.indexOf(s.charAt(i));\r\n    return idx;\r\n  }\r\n\r\n  public static decode(s: string): string {\r\n    let pads = 0,\r\n      i,\r\n      b10,\r\n      imax = s.length,\r\n      x = [];\r\n\r\n    s = String(s);\r\n\r\n    if (imax === 0) {\r\n      return s;\r\n    }\r\n\r\n    if (s.charAt(imax - 1) === this.PADCHAR) {\r\n      pads = 1;\r\n      if (s.charAt(imax - 2) === this.PADCHAR) {\r\n        pads = 2;\r\n      }\r\n      imax -= 4;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 4) {\r\n      b10 =\r\n        (this.getByte64(s, i) << 18) |\r\n        (this.getByte64(s, i + 1) << 12) |\r\n        (this.getByte64(s, i + 2) << 6) |\r\n        this.getByte64(s, i + 3);\r\n      x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255, b10 & 255));\r\n    }\r\n\r\n    switch (pads) {\r\n      case 1:\r\n        b10 =\r\n          (this.getByte64(s, i) << 18) |\r\n          (this.getByte64(s, i + 1) << 12) |\r\n          (this.getByte64(s, i + 2) << 6);\r\n        x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255));\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte64(s, i) << 18) | (this.getByte64(s, i + 1) << 12);\r\n        x.push(String.fromCharCode(b10 >> 16));\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n\r\n  public static encode(s: string): string {\r\n    s = String(s);\r\n\r\n    let i,\r\n      b10,\r\n      x = [],\r\n      imax = s.length - s.length % 3;\r\n\r\n    if (s.length === 0) {\r\n      return s;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 3) {\r\n      b10 =\r\n        (this.getByte(s, i) << 16) |\r\n        (this.getByte(s, i + 1) << 8) |\r\n        this.getByte(s, i + 2);\r\n      x.push(this.ALPHA.charAt(b10 >> 18));\r\n      x.push(this.ALPHA.charAt((b10 >> 12) & 63));\r\n      x.push(this.ALPHA.charAt((b10 >> 6) & 63));\r\n      x.push(this.ALPHA.charAt(b10 & 63));\r\n    }\r\n\r\n    switch (s.length - imax) {\r\n      case 1:\r\n        b10 = this.getByte(s, i) << 16;\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.PADCHAR +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte(s, i) << 16) | (this.getByte(s, i + 1) << 8);\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.ALPHA.charAt((b10 >> 6) & 63) +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n}\r\n","import * as Bowser from 'bowser';\r\n\r\nexport interface UserAgent extends Bowser.Parser.Parser {\r\n  compareVersion: (version: string) => boolean;\r\n}\r\n\r\nexport const userAgent = Bowser.getParser(\r\n  window.navigator.userAgent\r\n) as UserAgent;\r\n","import { userAgent } from './user-agent';\r\n\r\nexport class Clipboard {\r\n  static copy(element: HTMLTextAreaElement | string): boolean {\r\n    let successful = false;\r\n    if (typeof element === 'string') {\r\n      const textArea = Clipboard.createTextArea(element);\r\n      Clipboard.selectText(textArea);\r\n      successful = Clipboard.copyTextToClipboard();\r\n      Clipboard.destroyTextArea(textArea);\r\n    } else {\r\n      Clipboard.selectText(element);\r\n      successful = Clipboard.copyTextToClipboard();\r\n    }\r\n    return successful;\r\n  }\r\n\r\n  private static createTextArea(text: string): HTMLTextAreaElement {\r\n    const textArea = document.createElement('textArea') as HTMLTextAreaElement;\r\n    textArea.value = text;\r\n    document.body.appendChild(textArea);\r\n    return textArea;\r\n  }\r\n\r\n  private static destroyTextArea(textArea) {\r\n    document.body.removeChild(textArea);\r\n  }\r\n\r\n  private static selectText(textArea) {\r\n    if (userAgent.getOSName() === 'iOS') {\r\n      const oldContentEditable = textArea.contentEditable;\r\n      const oldReadOnly = textArea.readOnly;\r\n      const range = document.createRange();\r\n      const selection = window.getSelection();\r\n\r\n      textArea.contenteditable = true;\r\n      textArea.readonly = false;\r\n      range.selectNodeContents(textArea);\r\n      selection.removeAllRanges();\r\n      selection.addRange(range);\r\n      textArea.setSelectionRange(0, 999999);\r\n      textArea.contentEditable = oldContentEditable;\r\n      textArea.readOnly = oldReadOnly;\r\n    } else {\r\n      textArea.select();\r\n    }\r\n  }\r\n\r\n  private static copyTextToClipboard(): boolean {\r\n    if (!(userAgent.getOSName() === 'iOS' && userAgent.compareVersion('<10'))) {\r\n      return document.execCommand('copy');\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","export class StringUtils {\r\n  static diff(s1: string, s2: string, p = 4): string {\r\n    if (!s1 && !s2) {\r\n      return '';\r\n    }\r\n    if (!s1) {\r\n      return '<span class=\"inserted\">' + s2 + '</span>';\r\n    }\r\n    if (!s2) {\r\n      return '<span class=\"deleted\">' + s1 + '</span>';\r\n    }\r\n    s1 = s1.toString();\r\n    s2 = s2.toString();\r\n    const changeData = StringUtils.getChanges(s1, s2, '', p);\r\n    const nextS = s2.slice(\r\n      changeData.mtc.length + changeData.ins.length + changeData.sbs.length\r\n    ); // remaining part of \"s\"\r\n    const nextThis = s1.slice(\r\n      changeData.mtc.length + changeData.del.length + changeData.sbs.length\r\n    ); // remaining part of \"this\"\r\n    let result = ''; // the glorious result\r\n    if (changeData.del.length > 0) {\r\n      changeData.del = '<span class=\"deleted\">' + changeData.del + '</span>';\r\n    }\r\n    if (changeData.ins.length > 0) {\r\n      changeData.ins = '<span class=\"inserted\">' + changeData.ins + '</span>';\r\n    }\r\n    result = changeData.mtc + changeData.del + changeData.ins + changeData.sbs;\r\n    result +=\r\n      nextThis !== '' || nextS !== ''\r\n        ? StringUtils.diff(nextThis, nextS, p)\r\n        : '';\r\n    return result;\r\n  }\r\n\r\n  private static getMatchingSubstring(s, l, m) {\r\n    // returns the first matching substring in-between the two strings\r\n    let i = 0;\r\n    let match = false;\r\n    const slen = s.length;\r\n    const o = { fis: slen, mtc: m, sbs: '' }; // temporary object used to construct the cd (change data) object\r\n\r\n    while (i < slen) {\r\n      l[i] === s[i]\r\n        ? match\r\n          ? (o.sbs += s[i]) // o.sbs holds the matching substring itsef\r\n          : ((match = true), (o.fis = i), (o.sbs = s[i]))\r\n        : match\r\n          ? (i = slen) // stop after the first found substring\r\n          : (i = i);\r\n      ++i;\r\n    }\r\n    return o;\r\n  }\r\n\r\n  private static getChanges(s1, s2, m, p) {\r\n    const isThisLonger = s1.length >= s1.length ? true : false;\r\n    let [longer, shorter] = isThisLonger ? [s1, s2] : [s2, s1]; // assignment of longer and shorter by es6 destructuring\r\n    let bi = 0; // base index designating the index of first mismacthing character in both strings\r\n\r\n    while (shorter[bi] === longer[bi] && bi < shorter.length) {\r\n      ++bi;\r\n    } // make bi the index of first mismatching character\r\n    longer = longer.split('').slice(bi); // as the longer string will be rotated it is converted into array\r\n    shorter = shorter.slice(bi); // shorter and longer now starts from the first mismatching character\r\n\r\n    const len = longer.length; // length of the longer string\r\n    let cd: any = {\r\n      fis: shorter.length, // the index of matching string in the shorter string\r\n      fil: len, // the index of matching string in the longer string\r\n      sbs: '', // the matching substring itself\r\n      mtc: m + s2.slice(0, bi)\r\n    }; // if exists mtc holds the matching string at the front\r\n    let sub: any = { sbs: '' }; // returned substring per 1 character rotation of the longer string\r\n\r\n    if (shorter !== '') {\r\n      for (let rc = 0; rc < len && sub.sbs.length < p; rc++) {\r\n        // rc -> rotate count, p -> precision factor\r\n        sub = StringUtils.getMatchingSubstring(\r\n          shorter,\r\n          StringUtils.rotateArray(longer, rc),\r\n          cd.mtc\r\n        ); // rotate longer string 1 char and get substring\r\n        sub.fil =\r\n          rc < len - sub.fis\r\n            ? sub.fis + rc // mismatch is longer than the mismatch in short\r\n            : sub.fis - len + rc; // mismatch is shorter than the mismatch in short\r\n        if (sub.sbs.length > cd.sbs.length) {\r\n          cd = sub; // only keep the one with the longest substring.\r\n        }\r\n      }\r\n    }\r\n    // insert the mismatching delete subsrt and insert substr to the cd object and attach the previous substring\r\n    [cd.del, cd.ins] = isThisLonger\r\n      ? [longer.slice(0, cd.fil).join(''), shorter.slice(0, cd.fis)]\r\n      : [shorter.slice(0, cd.fis), longer.slice(0, cd.fil).join('')];\r\n    return cd.del.indexOf(' ') === -1 ||\r\n      cd.ins.indexOf(' ') === -1 ||\r\n      cd.del === '' ||\r\n      cd.ins === '' ||\r\n      cd.sbs === ''\r\n      ? cd\r\n      : StringUtils.getChanges(cd.del, cd.ins, cd.mtc, p);\r\n  }\r\n\r\n  private static rotateArray(array, n) {\r\n    const len = array.length;\r\n    const res = new Array(array.length);\r\n    if (n % len === 0) {\r\n      return array.slice();\r\n    } else {\r\n      for (let i = 0; i < len; i++) {\r\n        res[i] = array[(i + (len + (n % len))) % len];\r\n      }\r\n    }\r\n    return res;\r\n  }\r\n}\r\n","export enum ChangeType {\r\n  ADDED = 'added',\r\n  DELETED = 'deleted',\r\n  MODIFIED = 'modified'\r\n}\r\n\r\nexport interface Change {\r\n  type: ChangeType;\r\n  keysChanged?: {\r\n    key: string;\r\n    newValue: any;\r\n    oldValue: any;\r\n  }[];\r\n}\r\n\r\nexport interface GroupingChanges {\r\n  added: ChangeItem[];\r\n  deleted: ChangeItem[];\r\n  modified: ChangeItem[];\r\n}\r\n\r\nexport interface ChangeItem {\r\n  change: Change;\r\n  value: any;\r\n  oldValue?: any;\r\n  newValue?: any;\r\n}\r\n","import { StringUtils } from './string-utils';\r\nimport { GroupingChanges, ChangeType } from './change.interface';\r\n\r\nexport class ChangeUtils {\r\n  static findChanges(\r\n    obj1: any[],\r\n    obj2: any[],\r\n    ignoreKeys: string[] = []\r\n  ): GroupingChanges {\r\n    const items: GroupingChanges = {\r\n      added: [],\r\n      deleted: [],\r\n      modified: []\r\n    };\r\n\r\n    if (!obj1 || !obj2) {\r\n      return items;\r\n    }\r\n\r\n    const obj1Clone: any = [...obj1];\r\n    const obj2Clone: any = [...obj2];\r\n\r\n    for (const fromItem of obj1Clone) {\r\n      const index = obj2Clone.findIndex(s => s.id === fromItem.id);\r\n\r\n      if (index === -1) {\r\n        items.deleted.push({\r\n          change: { type: ChangeType.DELETED },\r\n          value: fromItem\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const toItem = obj2Clone.splice(index, 1)[0];\r\n      const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n      const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n      const keysChanged = ChangeUtils.compareObject(\r\n        fromItemClone,\r\n        toItemClone,\r\n        undefined,\r\n        ignoreKeys\r\n      );\r\n\r\n      if (keysChanged.length) {\r\n        items.modified.push({\r\n          change: {\r\n            type: ChangeType.MODIFIED,\r\n            keysChanged\r\n          },\r\n          value: fromItemClone,\r\n          oldValue: fromItem,\r\n          newValue: toItem\r\n        });\r\n      }\r\n    }\r\n\r\n    items.added = obj2Clone.map(itemAdded => {\r\n      return {\r\n        change: { type: ChangeType.ADDED },\r\n        value: itemAdded\r\n      };\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  private static compareObject(fromItem, toItem, baseKey?, ignoreKeys = []) {\r\n    const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n    const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n    const keys: any = new Set([\r\n      ...Object.keys(fromItem),\r\n      ...Object.keys(toItem)\r\n    ]);\r\n    let keysChanged = [];\r\n    keys.forEach(key => {\r\n      const keyString = baseKey ? `${baseKey}.${key}` : key;\r\n      if (ignoreKeys.indexOf(keyString) !== -1) {\r\n        return;\r\n      }\r\n\r\n      if (Array.isArray(fromItem[key])) {\r\n        fromItem[key] = fromItem[key].join(',<br>');\r\n      }\r\n      if (Array.isArray(toItem[key])) {\r\n        toItem[key] = toItem[key].join(',<br>');\r\n      }\r\n\r\n      if (\r\n        typeof fromItem[key] === 'object' &&\r\n        typeof toItem[key] === 'object' &&\r\n        fromItem[key] !== null &&\r\n        toItem[key] !== null\r\n      ) {\r\n        keysChanged = keysChanged.concat(\r\n          this.compareObject(fromItem[key], toItem[key], keyString)\r\n        );\r\n      } else {\r\n        if (fromItem[key] !== toItem[key]) {\r\n          keysChanged.push({\r\n            key: keyString,\r\n            oldValue: fromItemClone[key],\r\n            newValue: toItemClone[key]\r\n          });\r\n          fromItem[key] = StringUtils.diff(fromItem[key], toItem[key]);\r\n        }\r\n      }\r\n    });\r\n\r\n    return keysChanged;\r\n  }\r\n}\r\n","export class ObjectUtils {\r\n  static resolve(obj: object, key: string): any {\r\n    const keysArray = key\r\n      .replace(/\\[/g, '.')\r\n      .replace(/\\]/g, '')\r\n      .split('.');\r\n    let current = obj;\r\n    while (keysArray.length) {\r\n      if (typeof current !== 'object') {\r\n        return undefined;\r\n      }\r\n      current = current[keysArray.shift()];\r\n    }\r\n\r\n    return current;\r\n  }\r\n\r\n  static isObject(item: object) {\r\n    return (\r\n      item &&\r\n      typeof item === 'object' &&\r\n      !Array.isArray(item) &&\r\n      item !== null &&\r\n      !(item instanceof Date)\r\n    );\r\n  }\r\n\r\n  static mergeDeep(\r\n    target: object,\r\n    source: object,\r\n    ignoreUndefined = false\r\n  ): any {\r\n    const output = Object.assign({}, target);\r\n    if (ObjectUtils.isObject(target) && ObjectUtils.isObject(source)) {\r\n      Object.keys(source)\r\n        .filter(key => !ignoreUndefined || source[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(source[key])) {\r\n            if (!(key in target)) {\r\n              Object.assign(output, { [key]: source[key] });\r\n            } else {\r\n              output[key] = ObjectUtils.mergeDeep(\r\n                target[key],\r\n                source[key],\r\n                ignoreUndefined\r\n              );\r\n            }\r\n          } else {\r\n            Object.assign(output, { [key]: source[key] });\r\n          }\r\n        });\r\n    }\r\n    return output;\r\n  }\r\n\r\n  static copyDeep(src): any {\r\n    const target = Array.isArray(src) ? [] : {};\r\n    for (const prop in src) {\r\n      if (src.hasOwnProperty(prop)) {\r\n        const value = src[prop];\r\n        if (value && typeof value === 'object') {\r\n          target[prop] = this.copyDeep(value);\r\n        } else {\r\n          target[prop] = value;\r\n        }\r\n      }\r\n    }\r\n    return target;\r\n  }\r\n\r\n  static removeDuplicateCaseInsensitive(obj: object) {\r\n    const summaryCapitalizeObject = {};\r\n    const capitalizeObject = {};\r\n    const upperCaseCount = [];\r\n\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        const upperCaseProperty = property.toUpperCase();\r\n        if (!summaryCapitalizeObject.hasOwnProperty(upperCaseProperty)) {\r\n          summaryCapitalizeObject[upperCaseProperty] = [\r\n            { [property]: obj[property] }\r\n          ];\r\n        } else {\r\n          summaryCapitalizeObject[upperCaseProperty].push({\r\n            [property]: obj[property]\r\n          });\r\n        }\r\n        // counting the number of uppercase lettersMna\r\n        upperCaseCount.push({\r\n          key: property,\r\n          count: property.replace(/[^A-Z]/g, '').length\r\n        });\r\n      }\r\n    }\r\n    for (const capitalizedProperty in summaryCapitalizeObject) {\r\n      if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n        if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n          const capitalizedPropertyObject =\r\n            summaryCapitalizeObject[capitalizedProperty];\r\n          if (capitalizedPropertyObject.length === 1) {\r\n            // for single params (no duplicates)\r\n            const singlePossibility = capitalizedPropertyObject[0];\r\n            capitalizeObject[capitalizedProperty] =\r\n              singlePossibility[Object.keys(singlePossibility)[0]];\r\n          } else if (capitalizedPropertyObject.length > 1) {\r\n            // defining the closest to lowercase property\r\n            const paramClosestToLowercase = upperCaseCount\r\n              .filter(\r\n                f => f.key.toLowerCase() === capitalizedProperty.toLowerCase()\r\n              )\r\n              .reduce((prev, current) => {\r\n                return prev.y < current.y ? prev : current;\r\n              });\r\n            capitalizeObject[paramClosestToLowercase.key.toUpperCase()] =\r\n              obj[paramClosestToLowercase.key];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        delete obj[property];\r\n      }\r\n    }\r\n\r\n    for (const property in capitalizeObject) {\r\n      if (capitalizeObject.hasOwnProperty(property)) {\r\n        obj[property] = capitalizeObject[property];\r\n      }\r\n    }\r\n  }\r\n\r\n  static removeUndefined(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeUndefined(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeUndefined(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static removeNull(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== null)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeNull(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeNull(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static naturalCompare(a, b, direction = 'asc', nullsFirst?: boolean) {\r\n    if (direction === 'desc') {\r\n      b = [a, (a = b)][0];\r\n    }\r\n\r\n    // nullsFirst = undefined : end if direction = 'asc', first if direction = 'desc'\r\n    // nullsFirst = true : always first\r\n    // nullsFirst = false : always end\r\n    if (\r\n      a === null ||\r\n      a === '' ||\r\n      a === undefined ||\r\n      b === null ||\r\n      b === '' ||\r\n      b === undefined\r\n    ) {\r\n      const nullScore =\r\n        a === b\r\n          ? 0\r\n          : a === undefined\r\n          ? 3\r\n          : b === undefined\r\n          ? -3\r\n          : a === null\r\n          ? 2\r\n          : b === null\r\n          ? -2\r\n          : a === ''\r\n          ? 1\r\n          : -1;\r\n      if (direction === 'desc') {\r\n        return nullsFirst !== false ? nullScore : nullScore * -1;\r\n      }\r\n      return nullsFirst === true ? nullScore * -1 : nullScore;\r\n    }\r\n\r\n    const ax = [];\r\n    const bx = [];\r\n    a = '' + a;\r\n    b = '' + b;\r\n\r\n    a.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      ax.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    b.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      bx.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    while (ax.length && bx.length) {\r\n      const an = ax.shift();\r\n      const bn = bx.shift();\r\n      const nn = an[0] - bn[0] || an[1].localeCompare(bn[1]);\r\n      if (nn) {\r\n        return nn;\r\n      }\r\n    }\r\n\r\n    return ax.length - bx.length;\r\n  }\r\n\r\n  /**\r\n   * Return true if two object are equivalent.\r\n   * Objects are considered equivalent if they have the same properties and\r\n   * if all of their properties (first-level only) share the same value.\r\n   * @param obj1 First object\r\n   * @param obj2 Second object\r\n   * @returns Whether two objects arer equivalent\r\n   */\r\n  static objectsAreEquivalent(obj1: object, obj2: object): boolean {\r\n    if (obj1 === obj2) {\r\n      return true;\r\n    }\r\n\r\n    const obj1Props = Object.getOwnPropertyNames(obj1);\r\n    const obj2Props = Object.getOwnPropertyNames(obj2);\r\n    if (obj1Props.length !== obj2Props.length) {\r\n      return false;\r\n    }\r\n\r\n    for (const prop of obj1Props) {\r\n      if (obj1[prop] !== obj2[prop]) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Return a new object with an array of keys removed\r\n   * @param obj Source object\r\n   * @param keys Keys to remove\r\n   * @returns A new object\r\n   */\r\n  static removeKeys(obj: object, keys: string[]): object {\r\n    const newObj = Object.keys(obj)\r\n      .filter(key => keys.indexOf(key) < 0)\r\n      .reduce((_obj, key) => {\r\n        _obj[key] = obj[key];\r\n        return _obj;\r\n      }, {});\r\n\r\n    return newObj;\r\n  }\r\n}\r\n","export class NumberUtils {\r\n    static roundToNDecimal(num: number, decimal: number = 3): number {\r\n        const roundFactor = Math.pow(10, decimal);\r\n        return Math.round((num) * roundFactor) / roundFactor;\r\n    }\r\n}\r\n","/** Utility function to create a K:V from a list of strings */\r\nexport function strEnum<T extends string>(o: Array<T>): { [K in T]: K } {\r\n  return o.reduce((res, key) => {\r\n    res[key] = key;\r\n    return res;\r\n  }, Object.create(null));\r\n}\r\n","export function S4() {\r\n  // eslint-disable-next-line no-bitwise\r\n  return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);\r\n}\r\n\r\nexport function uuid() {\r\n  const id = `${S4()}${S4()}-${S4()}-${S4()}-${S4()}-${S4()}${S4()}${S4()}`;\r\n  return id.toLowerCase();\r\n}\r\n","import { Subject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nexport enum SubjectStatus {\r\n  Error = 0,\r\n  Done = 1,\r\n  Working = 2,\r\n  Waiting = 3\r\n}\r\n\r\nexport abstract class Watcher {\r\n  public status$ = new Subject<SubjectStatus>();\r\n  protected status$$: Subscription;\r\n\r\n  get status(): SubjectStatus {\r\n    return this._status;\r\n  }\r\n  set status(value: SubjectStatus) {\r\n    this._status = value;\r\n    this.status$.next(value);\r\n  }\r\n  private _status: SubjectStatus;\r\n\r\n  protected abstract watch();\r\n\r\n  protected abstract unwatch();\r\n\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  subscribe(callback: Function, scope?: any) {\r\n    this.watch();\r\n\r\n    this.status$$ = this.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((status: SubjectStatus) => {\r\n        this.handleStatusChange(status);\r\n        callback.call(scope, this);\r\n      });\r\n  }\r\n\r\n  unsubscribe() {\r\n    this.unwatch();\r\n    if (this.status$$ !== undefined) {\r\n      this.status$$.unsubscribe();\r\n      this.status$$ = undefined;\r\n    }\r\n    this.status = SubjectStatus.Waiting;\r\n  }\r\n\r\n  protected handleStatusChange(status: SubjectStatus) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ActivityService {\r\n  public counter$ = new BehaviorSubject<number>(0);\r\n\r\n  private ids: string[] = [];\r\n\r\n  constructor() {}\r\n\r\n  register(): string {\r\n    const id = uuid();\r\n    this.ids.push(id);\r\n    this.counter$.next(this.ids.length);\r\n\r\n    return id;\r\n  }\r\n\r\n  unregister(id: string) {\r\n    const index = this.ids.indexOf(id);\r\n    if (index === -1) {\r\n      return;\r\n    }\r\n    this.ids.splice(index, 1);\r\n\r\n    this.counter$.next(this.ids.length);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpEvent,\r\n  HttpHandler,\r\n  HttpInterceptor,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { finalize } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from './activity.service';\r\n\r\n@Injectable()\r\nexport class ActivityInterceptor implements HttpInterceptor {\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const activity = req.headers.get('activityInterceptor');\r\n    if (activity) {\r\n      const actReq = req.clone({\r\n        headers: req.headers.delete('activityInterceptor')\r\n      });\r\n      if (activity === 'false') {\r\n        return next.handle(actReq);\r\n      }\r\n    }\r\n\r\n    const id = this.activityService.register();\r\n\r\n    return next.handle(req).pipe(\r\n      finalize(() => {\r\n        this.activityService.unregister(id);\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ActivityInterceptor } from './activity.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoActivityModule {\r\n  static forRoot(): ModuleWithProviders<IgoActivityModule> {\r\n    return {\r\n      ngModule: IgoActivityModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ActivityInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export interface Version {\r\n  lib: string;\r\n  releaseDate: number;\r\n}\r\n\r\nexport const version: Version = {\r\n  lib: '1.11.0',\r\n  releaseDate: 1648648424505\r\n};\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigOptions } from './config.interface';\r\nimport { version } from './version';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ConfigService {\r\n  private config: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in config file\r\n   */\r\n  public getConfig(key: string): any {\r\n    return ObjectUtils.resolve(this.config, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all config's variables\r\n   */\r\n  public load(options: ConfigOptions) {\r\n    const baseConfig = options.default || {};\r\n    if (!options.path) {\r\n      this.config = baseConfig;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`Configuration file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((configResponse: object) => {\r\n          this.config = ObjectUtils.mergeDeep(\r\n            ObjectUtils.mergeDeep({ version }, baseConfig),\r\n            configResponse\r\n          );\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { ConfigService } from './config.service';\r\nimport { ConfigOptions } from './config.interface';\r\n\r\nexport let CONFIG_OPTIONS = new InjectionToken<ConfigOptions>('configOptions');\r\n\r\nexport function provideConfigOptions(options: ConfigOptions) {\r\n  return {\r\n    provide: CONFIG_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function configFactory(\r\n  configService: ConfigService,\r\n  options: ConfigOptions\r\n) {\r\n  return () => configService.load(options);\r\n}\r\n\r\nexport function provideConfigLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: configFactory,\r\n    multi: true,\r\n    deps: [ConfigService, CONFIG_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideConfigOptions, provideConfigLoader } from './config.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoConfigModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfigModule> {\r\n    return {\r\n      ngModule: IgoConfigModule,\r\n      providers: [provideConfigOptions({}), provideConfigLoader()]\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { of, combineLatest } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\ndeclare function require(arg: string): any;\r\n\r\nexport class LanguageLoader implements TranslateLoader {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private prefix?: string | string[],\r\n    private suffix: string = '.json',\r\n    private config?: ConfigService\r\n  ) {}\r\n\r\n  public getTranslation(lang: string): any {\r\n    const translation = require(`../locale/${lang}.json`);\r\n    const igoLocale$ = of(translation);\r\n\r\n    if (this.config && !this.prefix) {\r\n      const prefix = this.config.getConfig('language.prefix');\r\n      this.prefix = !prefix || Array.isArray(prefix) ? prefix : [prefix];\r\n    }\r\n\r\n    if (!this.prefix || this.prefix.length === 0) {\r\n      return igoLocale$;\r\n    }\r\n\r\n    const appLocale$ = (this.prefix as string[]).map((prefix) =>\r\n      this.http.get(`${prefix}${lang}${this.suffix}`)\r\n    );\r\n\r\n    const locale$ = combineLatest([igoLocale$, ...appLocale$]);\r\n\r\n    return locale$.pipe(\r\n      map((translations) => {\r\n        return translations.reduce(\r\n          (acc, current) => ObjectUtils.mergeDeep(acc, current),\r\n          {}\r\n        );\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\nimport { LanguageLoader } from './language.loader';\r\n\r\nexport function defaultLanguageLoader(\r\n  http: HttpClient,\r\n  config?: ConfigService\r\n) {\r\n  return new LanguageLoader(http, undefined, undefined, config);\r\n}\r\n\r\nexport function provideLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient]\r\n  };\r\n}\r\n\r\nexport function provideDefaultLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import {\r\n  MissingTranslationHandler,\r\n  MissingTranslationHandlerParams\r\n} from '@ngx-translate/core';\r\n\r\nexport class IgoMissingTranslationHandler implements MissingTranslationHandler {\r\n  handle(params: MissingTranslationHandlerParams) {\r\n    if (!params.translateService.langs.length) {\r\n      const error =\r\n        'Translations are not yet loaded. \\\r\n         Check that the LanguageService is injected.';\r\n      throw new Error(error);\r\n    }\r\n\r\n    if (params.key.substr(0, 4) === 'igo.') {\r\n      throw new Error(`The Key \"${params.key}\" is missing in locale file.`);\r\n    } else {\r\n      return params.key;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport {\r\n  TranslateModule,\r\n  MissingTranslationHandler\r\n} from '@ngx-translate/core';\r\n\r\nimport { provideDefaultLanguageLoader } from './shared/language.provider';\r\nimport { IgoMissingTranslationHandler } from './shared/missing-translation.guard';\r\n\r\n@NgModule({\r\n  imports: [\r\n    TranslateModule.forRoot({\r\n      missingTranslationHandler: {\r\n        provide: MissingTranslationHandler,\r\n        useClass: IgoMissingTranslationHandler\r\n      }\r\n    })\r\n  ],\r\n  declarations: [],\r\n  exports: [TranslateModule]\r\n})\r\nexport class IgoLanguageModule {\r\n  static forRoot(): ModuleWithProviders<IgoLanguageModule> {\r\n    return {\r\n      ngModule: IgoLanguageModule,\r\n      providers: [provideDefaultLanguageLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { GlobalConfig, ToastrModule } from 'ngx-toastr';\r\n\r\n@NgModule({\r\n  imports: [CommonModule,\r\n    ToastrModule.forRoot({\r\n      positionClass: 'toast-bottom-right',\r\n      timeOut: 10000,\r\n      extendedTimeOut: 10000,\r\n      messageClass: 'toast-message mat-typography',\r\n      closeButton: true,\r\n      progressBar: true,\r\n      enableHtml: true,\r\n      tapToDismiss: true,\r\n      maxOpened: 4,\r\n      preventDuplicates: true,\r\n      resetTimeoutOnDuplicate: true,\r\n      countDuplicates: false,\r\n      includeTitleDuplicates: true\r\n    } as GlobalConfig)],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoMessageModule {\r\n  static forRoot(): ModuleWithProviders<IgoMessageModule> {\r\n    return {\r\n      ngModule: IgoMessageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { TranslateService } from '@ngx-translate/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LanguageService {\r\n  private language: string = this.translate.getBrowserLang();\r\n\r\n  constructor(public translate: TranslateService) {\r\n    const lang = this.getLanguage();\r\n    this.translate.setDefaultLang(lang);\r\n  }\r\n\r\n  public getLanguage(): string {\r\n    return this.language.match(/en|fr/) ? this.language : 'en';\r\n  }\r\n\r\n  public setLanguage(language: string) {\r\n    this.language = language.match(/en|fr/) ? language : 'en';\r\n    this.translate.use(this.language);\r\n    this.translate.reloadLang(this.language);\r\n  }\r\n}\r\n","export enum MessageType {\r\n  ERROR = 'error',\r\n  ALERT = 'warning', // todo delete (transition to ngx-toastr)\r\n  WARNING = 'warning',\r\n  INFO = 'info',\r\n  SUCCESS = 'success'\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpErrorResponse } from '@angular/common/http';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\nimport { Message, MessageOptions } from './message.interface';\r\nimport { ActiveToast, IndividualConfig, ToastrService } from 'ngx-toastr';\r\nimport { MessageType } from './message.enum';\r\nimport { LanguageService } from '../../language/shared/language.service';\r\n\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MessageService {\r\n  public messages$ = new BehaviorSubject<Message[]>([]);\r\n  private options: MessageOptions;\r\n\r\n  constructor(\r\n    @Inject(Injector) private injector: Injector,\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService\r\n  ) {\r\n    this.options = this.configService.getConfig('message') || {};\r\n  }\r\n\r\n  private get toastr(): ToastrService {\r\n    return this.injector.get(ToastrService);\r\n  }\r\n\r\n  showError(httpError: HttpErrorResponse) {\r\n    httpError.error.caught = true;\r\n    return this.error(httpError.error.message, httpError.error.title);\r\n  }\r\n\r\n  message(message: Message) {\r\n    this.messages$.next(this.messages$.value.concat([message]));\r\n\r\n    message.options = message.options || {} as MessageOptions;\r\n    const currentDate = new Date();\r\n\r\n    message.options.from = message.options.from ? message.options.from : new Date('1 jan 1900');\r\n    message.options.to = message.options.to ? message.options.to : new Date('1 jan 3000');\r\n    if (typeof message.options.from === 'string') {\r\n      message.options.from = new Date(Date.parse(message.options.from.replace(/-/g, ' ')));\r\n    }\r\n    if (typeof message.options.to === 'string') {\r\n      message.options.to = new Date(Date.parse(message.options.to.replace(/-/g, ' ')));\r\n    }\r\n    if (\r\n      currentDate > message.options.from && currentDate < message.options.to) {\r\n\r\n      message = this.handleTemplate(message);\r\n\r\n      if (message.text) {\r\n        let messageShown: ActiveToast<any>;\r\n        switch (message.type) {\r\n          case MessageType.SUCCESS:\r\n            messageShown = this.success(message.text, message.title, message.options);\r\n            break;\r\n          case MessageType.ERROR:\r\n            messageShown = this.error(message.text, message.title, message.options);\r\n            break;\r\n          case MessageType.INFO:\r\n            messageShown = this.info(message.text, message.title, message.options);\r\n            break;\r\n          case MessageType.ALERT:\r\n          case MessageType.WARNING:\r\n            messageShown = this.alert(message.text, message.title, message.options);\r\n            break;\r\n          default:\r\n            messageShown = this.info(message.text, message.title, message.options);\r\n            break;\r\n        }\r\n        message.options.id = messageShown.toastId;\r\n      }\r\n    }\r\n  }\r\n\r\n  success(text: string, title: string = 'igo.core.message.success', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.success(message, translatedTitle, options);\r\n  }\r\n\r\n  error(text: string, title: string = 'igo.core.message.error', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.error(message, translatedTitle, options);\r\n  }\r\n\r\n  info(text: string, title: string = 'igo.core.message.info', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.info(message, translatedTitle, options);\r\n  }\r\n\r\n  alert(text: string, title: string = 'igo.core.message.alert', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.warning(message, translatedTitle, options);\r\n  }\r\n\r\n  remove(id?: number) {\r\n    this.toastr.remove(id);\r\n  }\r\n\r\n  removeAllAreNotError() {\r\n    for (const mess of this.messages$.value) {\r\n      if (mess.type !== MessageType.ERROR) {\r\n        this.remove(mess.options.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleTemplate(message: Message): Message {\r\n    if (!this.options.template || message.html) {\r\n      return message;\r\n    }\r\n\r\n    let html = this.options.template;\r\n    html = html.replace('${text}', message.text);\r\n    html = html.replace('${title}', message.title);\r\n\r\n    message.html = undefined;\r\n    message.text = html;\r\n    message.title = undefined;\r\n    return message;\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport {\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest,\r\n  HttpEvent,\r\n  HttpErrorResponse\r\n} from '@angular/common/http';\r\n\r\nimport { Observable, throwError } from 'rxjs';\r\nimport { catchError, finalize } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\nimport { LanguageService } from '../language/shared/language.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ErrorInterceptor implements HttpInterceptor {\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private injector: Injector\r\n  ) {}\r\n\r\n  intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const errorContainer = { httpError: undefined };\r\n    return next.handle(req).pipe(\r\n      catchError(error => this.handleError(error, errorContainer)),\r\n      finalize(() => {\r\n        this.handleCaughtError(errorContainer);\r\n        this.handleUncaughtError(errorContainer);\r\n      })\r\n    );\r\n  }\r\n\r\n  private handleError(\r\n    httpError: HttpErrorResponse,\r\n    errorContainer: { httpError: HttpErrorResponse }\r\n  ) {\r\n    if (httpError instanceof HttpErrorResponse) {\r\n      const errorObj = httpError.error === 'object' ? httpError.error : {};\r\n      errorObj.message = httpError.error.message || httpError.statusText;\r\n      errorObj.caught = false;\r\n\r\n      httpError = new HttpErrorResponse({\r\n        error: errorObj,\r\n        headers: httpError.headers,\r\n        status: httpError.status,\r\n        statusText: httpError.statusText,\r\n        url: httpError.url\r\n      });\r\n    }\r\n\r\n    errorContainer.httpError = httpError;\r\n    return throwError(httpError);\r\n  }\r\n\r\n  private handleCaughtError(errorContainer: { httpError: HttpErrorResponse }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && httpError.error.toDisplay) {\r\n      httpError.error.caught = true;\r\n      this.messageService.error(httpError.error.message, httpError.error.title);\r\n    }\r\n  }\r\n\r\n  private handleUncaughtError(errorContainer: {\r\n    httpError: HttpErrorResponse;\r\n  }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && !httpError.error.caught) {\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.errors.uncaught.message');\r\n      const title = translate.instant('igo.core.errors.uncaught.title');\r\n      httpError.error.caught = true;\r\n      this.messageService.error(message, title);\r\n    }\r\n  }\r\n}\r\n","import {\r\n  NgModule,\r\n  ModuleWithProviders,\r\n  Optional,\r\n  SkipSelf\r\n} from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ErrorInterceptor } from './error.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoErrorModule {\r\n  static forRoot(): ModuleWithProviders<IgoErrorModule> {\r\n    return {\r\n      ngModule: IgoErrorModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ErrorInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  constructor(@Optional() @SkipSelf() parentModule: IgoErrorModule) {\r\n    if (parentModule) {\r\n      throw new Error(\r\n        'IgoErrorModule is already loaded. Import it in the AppModule only'\r\n      );\r\n    }\r\n  }\r\n}\r\n","import { Injectable, Inject, InjectionToken, Optional } from '@angular/core';\r\nimport { ActivatedRoute, Params, Router } from '@angular/router';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { RouteServiceOptions } from './route.interface';\r\n\r\nexport let ROUTE_SERVICE_OPTIONS = new InjectionToken<RouteServiceOptions>(\r\n  'routeServiceOptions'\r\n);\r\n\r\nexport function provideRouteServiceOptions(options: RouteServiceOptions) {\r\n  return {\r\n    provide: ROUTE_SERVICE_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class RouteService {\r\n  public options: RouteServiceOptions;\r\n\r\n  constructor(\r\n    private router: Router,\r\n    public route: ActivatedRoute,\r\n    @Inject(ROUTE_SERVICE_OPTIONS)\r\n    @Optional()\r\n    options: RouteServiceOptions\r\n  ) {\r\n    const defaultOptions = {\r\n      centerKey: 'center',\r\n      zoomKey: 'zoom',\r\n      projectionKey: 'projection',\r\n      contextKey: 'context',\r\n      searchKey: 'search',\r\n      visibleOnLayersKey: 'visiblelayers',\r\n      visibleOffLayersKey: 'invisiblelayers',\r\n      directionsCoordKey: 'routing',\r\n      directionsOptionsKey: 'routingOptions',\r\n      toolKey: 'tool',\r\n      wmsUrlKey: 'wmsUrl',\r\n      wmsLayersKey:  'wmsLayers',\r\n      wmtsUrlKey: 'wmtsUrl',\r\n      wmtsLayersKey:  'wmtsLayers',\r\n      arcgisUrlKey: 'arcgisUrl',\r\n      arcgisLayersKey:  'arcgisLayers',\r\n      iarcgisUrlKey: 'iarcgisUrl',\r\n      iarcgisLayersKey:  'iarcgisLayers',\r\n      tarcgisUrlKey: 'tarcgisUrl',\r\n      tarcgisLayersKey:  'tarcgisLayers',\r\n      vectorKey: 'vector'\r\n    };\r\n    this.options = Object.assign({}, defaultOptions, options);\r\n  }\r\n\r\n  get queryParams(): Observable<Params> {\r\n    let url = decodeURIComponent(location.search);\r\n    if (url.includes('¢er=')) {\r\n      url = url.replace('¢er', '&center');\r\n      const queryParams: any = url\r\n      .slice(1)\r\n      .split('&')\r\n      .map(p => p.split('='))\r\n      .reduce((obj, pair) => {\r\n        const [key, value] = pair.map(decodeURIComponent);\r\n        obj[key] = value;\r\n        return obj;\r\n      }, {});\r\n      this.router.navigate([], { queryParams });\r\n    }\r\n    return this.route.queryParams;\r\n  }\r\n}\r\n","export enum Media {\r\n  Mobile = 'mobile',\r\n  Tablet = 'tablet',\r\n  Desktop = 'desktop'\r\n}\r\n\r\nexport enum MediaOrientation {\r\n  Portrait = 'portrait',\r\n  Landscape = 'landscape'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Breakpoints, BreakpointObserver } from '@angular/cdk/layout';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Media, MediaOrientation } from './media.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MediaService {\r\n  public media$ = new BehaviorSubject<Media>(undefined);\r\n  public orientation$ = new BehaviorSubject<MediaOrientation>(undefined);\r\n\r\n  constructor(breakpointObserver: BreakpointObserver) {\r\n    breakpointObserver\r\n      .observe([Breakpoints.HandsetLandscape])\r\n      .subscribe(res => {\r\n        if (res.matches) {\r\n          this.media$.next(Media.Mobile);\r\n          this.orientation$.next(MediaOrientation.Landscape);\r\n        }\r\n      });\r\n\r\n    breakpointObserver.observe([Breakpoints.HandsetPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Mobile);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n  }\r\n\r\n  getMedia(): Media {\r\n    return this.media$.value;\r\n  }\r\n\r\n  getOrientation(): MediaOrientation {\r\n    return this.orientation$.value;\r\n  }\r\n\r\n  isTouchScreen(): boolean {\r\n    return 'ontouchstart' in document.documentElement ? true : false;\r\n  }\r\n\r\n  isMobile(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'mobile';\r\n  }\r\n\r\n  isDesktop(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'desktop';\r\n  }\r\n}\r\n","export enum StorageScope {\r\n  SESSION = 'Session',\r\n  LOCAL = 'Local'\r\n}\r\n\r\nexport interface StorageOptions {\r\n  key: string;\r\n}\r\n\r\nexport interface StorageServiceEvent {\r\n  key?: string;\r\n  scope: StorageScope;\r\n  event: StorageServiceEventEnum;\r\n  previousValue?: any;\r\n  currentValue?: any;\r\n}\r\n\r\nexport enum StorageServiceEventEnum {\r\n  ADDED = 'Added',\r\n  MODIFIED = 'Modified',\r\n  REMOVED = 'Removed',\r\n  CLEARED = 'Cleared'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '../config/config.service';\r\nimport { StorageScope, StorageOptions, StorageServiceEvent, StorageServiceEventEnum } from './storage.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageService {\r\n  protected options: StorageOptions;\r\n\r\n  public storageChange$: BehaviorSubject<StorageServiceEvent> = new BehaviorSubject(undefined);\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.options = this.config.getConfig('storage') || { key: 'igo' };\r\n  }\r\n  /**\r\n   * Use to get the data found in storage file\r\n   */\r\n  get(key: string, scope?: StorageScope): string | object | boolean | number {\r\n    let value: any;\r\n\r\n    if (!scope || scope === StorageScope.SESSION) {\r\n      value = sessionStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (scope === StorageScope.LOCAL || (!value && !scope)) {\r\n      value = localStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (value) {\r\n      try {\r\n        value = JSON.parse(value);\r\n      } catch {\r\n        value = value;\r\n      }\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.setItem(\r\n        `${this.options.key}.${key}`,\r\n        JSON.stringify(value)\r\n      );\r\n    } else {\r\n      localStorage.setItem(`${this.options.key}.${key}`, JSON.stringify(value));\r\n    }\r\n    const currentValue = this.get(key, scope);\r\n\r\n    if (currentValue !== previousValue) {\r\n      this.storageChange$.next({\r\n        key, scope,\r\n        event: previousValue !== undefined ? StorageServiceEventEnum.MODIFIED : StorageServiceEventEnum.ADDED,\r\n        previousValue,\r\n        currentValue\r\n      });\r\n    }\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.removeItem(`${this.options.key}.${key}`);\r\n    } else {\r\n      localStorage.removeItem(`${this.options.key}.${key}`);\r\n    }\r\n    this.storageChange$.next({key, scope, event: StorageServiceEventEnum.REMOVED, previousValue });\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.clear();\r\n    } else {\r\n      localStorage.clear();\r\n    }\r\n    this.storageChange$.next({scope, event: StorageServiceEventEnum.CLEARED });\r\n  }\r\n}\r\n","import { Injectable, EventEmitter, OnDestroy, Injector } from '@angular/core';\r\nimport { Observable, Subscription, fromEvent } from 'rxjs';\r\nimport { debounceTime, startWith } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\nimport { LanguageService } from '../language/shared/language.service';\r\nimport { ConnectionState } from './network.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class NetworkService implements OnDestroy {\r\n  private stateChangeEventEmitter = new EventEmitter<ConnectionState>();\r\n  private onlineSubscription: Subscription;\r\n  private offlineSubscription: Subscription;\r\n  private previousMessageId;\r\n\r\n  private state: ConnectionState = {\r\n    connection: window.navigator.onLine\r\n  };\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private injector: Injector\r\n  ) {\r\n      this.checkNetworkState();\r\n  }\r\n\r\n  private checkNetworkState() {\r\n    this.onlineSubscription = fromEvent(window, 'online').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.network.online.message');\r\n      const title = translate.instant('igo.core.network.online.title');\r\n      const messageObj = this.messageService.info(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = true;\r\n      this.emitEvent();\r\n    });\r\n\r\n    this.offlineSubscription = fromEvent(window, 'offline').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.network.offline.message');\r\n      const title = translate.instant('igo.core.network.offline.title');\r\n      const messageObj = this.messageService.info(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = false;\r\n      this.emitEvent();\r\n    });\r\n  }\r\n\r\n  private emitEvent() {\r\n    this.stateChangeEventEmitter.emit(this.state);\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    try {\r\n      this.offlineSubscription.unsubscribe();\r\n      this.onlineSubscription.unsubscribe();\r\n    } catch (e) {}\r\n  }\r\n\r\n  currentState(reportState = true): Observable<ConnectionState> {\r\n    return reportState\r\n      ? this.stateChangeEventEmitter.pipe(\r\n          debounceTime(300),\r\n          startWith(this.state)\r\n        )\r\n      : this.stateChangeEventEmitter.pipe(debounceTime(300));\r\n  }\r\n}\r\n","export enum EntityOperationType {\r\n  Insert = 'Insert',\r\n  Update = 'Update',\r\n  Delete = 'Delete'\r\n}\r\n\r\nexport enum EntityTableColumnRenderer {\r\n  Default = 'Default',\r\n  HTML = 'HTML',\r\n  UnsanitizedHTML = 'UnsanitizedHTML',\r\n  Editable = 'Editable',\r\n  Icon = 'Icon',\r\n  ButtonGroup = 'ButtonGroup'\r\n}\r\n\r\nexport enum EntityTableScrollBehavior {\r\n  Auto = 'auto',\r\n  Instant = 'instant',\r\n  Smooth = 'smooth'\r\n}\r\n\r\nexport enum EntityTableSelectionState {\r\n  None = 'None',\r\n  All = 'All',\r\n  Some = 'Some'\r\n}\r\n","import t from 'typy';\r\n\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\n/**\r\n * Get an entity's named property. Nested properties are supported\r\n * with the dotted notation. (i.e 'author.name')\r\n *\r\n * Note: this method is a 'best attempt' at getting an entity's property.\r\n * It fits the most common cases but you might need to explicitely define\r\n * a property getter when using an EntityStore, for example.\r\n * @param entity Entity\r\n * @param property Property name\r\n * @returns Property value\r\n */\r\nexport function getEntityProperty(entity: object, property: string): any {\r\n  return t(entity, property).safeObject;\r\n}\r\n\r\n/**\r\n * Get an entity's id. An entity's id can be one of:\r\n * 'entity.meta.id', 'entity.meta.idProperty' or 'entity.id'.\r\n *\r\n * Note: See the note in the 'getEntityProperty' documentation.\r\n * @param entity Entity\r\n * @returns Entity id\r\n */\r\nexport function getEntityId(entity: object): EntityKey {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.id ? meta.id : getEntityProperty(entity, meta.idProperty || 'id');\r\n}\r\n\r\n/**\r\n * Get an entity's title. An entity's title can be one of:\r\n * 'entity.meta.title', 'entity.meta.titleProperty' or 'entity.title'.\r\n * @param entity Entity\r\n * @returns Entity title\r\n */\r\nexport function getEntityTitle(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.title ? meta.title : getEntityProperty(entity, meta.titleProperty || 'title');\r\n}\r\n\r\n/**\r\n * Get an entity's HTML title. An entity's HTML title can be one of:\r\n * 'entity.meta.titleHtml', 'entity.meta.titleHtmlProperty' or 'entity.titleHtml'.\r\n * @param entity Entity\r\n * @returns Entity HTML title\r\n */\r\nexport function getEntityTitleHtml(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.titleHtml ? meta.titleHtml : getEntityProperty(entity, meta.titleHtmlProperty || 'titleHtml');\r\n}\r\n\r\n/**\r\n * Get an entity's icon. An entity's icon can be one of:\r\n * 'entity.meta.icon', 'entity.meta.iconProperty' or 'entity.icon'.\r\n * @param entity Entity\r\n * @returns Entity icon\r\n */\r\nexport function getEntityIcon(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.icon ? meta.icon : getEntityProperty(entity, meta.iconProperty || 'icon');\r\n}\r\n\r\n/**\r\n * Get an entity's revision.\r\n * @param entity Entity\r\n * @returns Entity revision\r\n */\r\nexport function getEntityRevision(entity: object): number {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.revision || 0;\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\n\r\nimport { EntityKey, EntityState, EntityStateManagerOptions } from './entity.interfaces';\r\nimport { getEntityId } from './entity.utils';\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to track a store's entities state\r\n */\r\nexport class EntityStateManager<E extends object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * State index\r\n   */\r\n  readonly index = new Map<EntityKey, S>();\r\n\r\n  /**\r\n   * Change emitter\r\n   */\r\n  readonly change$ = new ReplaySubject<void>(1);\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  private store: EntityStore<object> | undefined;\r\n\r\n  constructor(options: EntityStateManagerOptions = {}) {\r\n    this.store = options.store ? options.store : undefined;\r\n    this.getKey = options.getKey\r\n      ? options.getKey\r\n      : (this.store ? this.store.getKey : getEntityId);\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear state\r\n   */\r\n  clear() {\r\n    if (this.index.size > 0) {\r\n      this.index.clear();\r\n      this.next();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity's state\r\n   * @param entity Entity\r\n   * @returns State\r\n   */\r\n  get(entity: E): S {\r\n    return (this.index.get(this.getKey(entity)) || {}) as S;\r\n  }\r\n\r\n  /**\r\n   * Set an entity's state\r\n   * @param entity Entity\r\n   * @param state State\r\n   */\r\n  set(entity: E, state: S) {\r\n    this.setMany([entity], state);\r\n  }\r\n\r\n  /**\r\n   * Set many entitie's state\r\n   * @param entitie Entities\r\n   * @param state State\r\n   */\r\n  setMany(entities: E[], state: S) {\r\n    entities.forEach((entity: E) => {\r\n      this.index.set(this.getKey(entity), Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Set state of all entities that already have a state. This is not\r\n   * the same as setting the state of all the store's entities.\r\n   * @param state State\r\n   */\r\n  setAll(state: S) {\r\n    Array.from(this.index.keys()).forEach((key: EntityKey) => {\r\n      this.index.set(key, Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update an entity's state\r\n   * @param entity Entity\r\n   * @param changes State changes\r\n   */\r\n  update(entity: E, changes: Partial<S>, exclusive = false) {\r\n    this.updateMany([entity], changes, exclusive);\r\n  }\r\n\r\n  /**\r\n   * Update many entitie's state\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  updateMany(entities: E[], changes: Partial<S>, exclusive = false) {\r\n    if (exclusive === true) {\r\n      return this.updateManyExclusive(entities, changes);\r\n    }\r\n\r\n    entities.forEach((entity: E) => {\r\n      const state = Object.assign({}, this.get(entity), changes);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Reversee an entity's state\r\n   * @param entity Entity\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverse(entity: E, keys: string[]) {\r\n    this.reverseMany([entity], keys);\r\n  }\r\n\r\n  /**\r\n   * Reverse many entitie's state\r\n   * @param entitie Entities\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverseMany(entities: E[], keys: string[]) {\r\n    entities.forEach((entity: E) => {\r\n      const currentState = this.get(entity);\r\n      const changes = keys.reduce((acc: {[key: string]: boolean}, key: string) => {\r\n        acc[key] = currentState[key] || false;\r\n        return acc;\r\n      }, {}) as Partial<S>;\r\n      const reversedChanges = this.reverseChanges(changes);\r\n      const state = Object.assign({}, currentState, reversedChanges);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update state of all entities that already have a state. This is not\r\n   * the same as updating the state of all the store's entities.\r\n   * @param changes State\r\n   */\r\n  updateAll(changes: Partial<S>) {\r\n    const allKeys = this.getAllKeys();\r\n    Array.from(allKeys).forEach((key: EntityKey) => {\r\n      const state = Object.assign({}, this.index.get(key), changes);\r\n      this.index.set(key, state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * When some state changes are flagged as 'exclusive', reverse\r\n   * the state of all other entities. Changes are reversable when\r\n   * they are boolean.\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  private updateManyExclusive(entities: E[], changes: Partial<S>) {\r\n    const reverseChanges = this.reverseChanges(changes);\r\n\r\n    const keys = entities.map((entity: E) => this.getKey(entity));\r\n    const allKeys = new Set(keys.concat(Array.from(this.getAllKeys())));\r\n    allKeys.forEach((key: EntityKey) => {\r\n      const state = this.index.get(key) || {} as S;\r\n\r\n      if (keys.indexOf(key) >= 0) {\r\n        this.index.set(key, Object.assign({}, state, changes));\r\n      } else {\r\n        // Update only if the reverse changes would modify\r\n        // a key already present in the current state\r\n        const shouldUpdate = Object.keys(reverseChanges).some((changeKey: string) => {\r\n          return state[changeKey] !== undefined &&\r\n            state[changeKey] !== reverseChanges[changeKey];\r\n        });\r\n        if (shouldUpdate === true) {\r\n          this.index.set(key, Object.assign({}, state, reverseChanges));\r\n        }\r\n      }\r\n    });\r\n\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Compute a 'reversed' version of some state changes.\r\n   * Changes are reversable when they are boolean.\r\n   * @param changes State changes\r\n   * @returns Reversed state changes\r\n   */\r\n  private reverseChanges(changes: Partial<S>): Partial<S> {\r\n    return Object.entries(changes).reduce((reverseChanges: Partial<S>, bunch: [string, any]) => {\r\n      const [changeKey, value] = bunch;\r\n      if (typeof value === typeof true) {\r\n        (reverseChanges as object)[changeKey] = !value;\r\n      }\r\n      return reverseChanges;\r\n    }, {});\r\n  }\r\n\r\n  /**\r\n   * Return all the keys in that state and in the store it's bound to, if any.\r\n   * @returns Set of keys\r\n   */\r\n  private getAllKeys(): Set<EntityKey> {\r\n    const storeKeys = this.store ? Array.from(this.store.index.keys()) : [];\r\n    return new Set(Array.from(this.index.keys()).concat(storeKeys));\r\n  }\r\n\r\n  /**\r\n   * Emit 'change' event\r\n   */\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject, Observable, Subscription, combineLatest } from 'rxjs';\r\nimport { debounceTime, map, skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils, uuid } from '@igo2/utils';\r\nimport {\r\n  EntityKey,\r\n  EntityFilterClause,\r\n  EntitySortClause,\r\n  EntityJoinClause\r\n} from './entity.interfaces';\r\n\r\n/**\r\n * An entity view streams entities from an observable source. These entities\r\n * can be filtered or sorted without affecting the source. A view can also\r\n * combine data from multiple sources, joined together.\r\n */\r\nexport class EntityView<E extends object, V extends object = E> {\r\n\r\n  /**\r\n   * Observable stream of values\r\n   */\r\n  readonly values$ = new BehaviorSubject<V[]>([]);\r\n\r\n  /**\r\n   * Subscription to the source (and joined sources) values\r\n   */\r\n  private values$$: Subscription;\r\n\r\n  /**\r\n   * Whether this view has been lifted\r\n   */\r\n  private lifted = false;\r\n\r\n  /**\r\n   * Join clauses\r\n   */\r\n  private joins: EntityJoinClause[] = [];\r\n\r\n  /**\r\n   * Observable of a filter clause\r\n   */\r\n  private filter$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Observable of filter clauses\r\n   */\r\n  private filters$: BehaviorSubject<EntityFilterClause[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Filters index\r\n   */\r\n  private filterIndex: Map<string, EntityFilterClause> = new Map();\r\n\r\n  /**\r\n   * Observable of a sort clause\r\n   */\r\n  private sort$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Method for indexing\r\n   */\r\n  get getKey(): (V) => EntityKey { return this.getKey$.value; }\r\n  private getKey$: BehaviorSubject<(V) => EntityKey> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, V> { return this._index; }\r\n  private _index: Map<EntityKey, V>;\r\n\r\n  constructor(private source$: BehaviorSubject<E[]>) {}\r\n\r\n  /**\r\n   * Get a value from the view by key\r\n   * @param key Key\r\n   * @returns Value\r\n   */\r\n  get(key: EntityKey): V {\r\n    if (this._index === undefined) {\r\n      throw new Error('This view has no index, therefore, this method is unavailable.');\r\n    }\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all the values\r\n   * @returns Array of values\r\n   */\r\n  all(): V[] {\r\n    return this.values$.value;\r\n  }\r\n\r\n  /**\r\n   * Observe all the values\r\n   * @returns Observable of values\r\n   */\r\n  all$(): BehaviorSubject<V[]> {\r\n    return this.values$;\r\n  }\r\n\r\n  /**\r\n   * Get the first value that respects a criteria\r\n   * @returns A value\r\n   */\r\n  firstBy(clause: EntityFilterClause<V>): V {\r\n    return this.values$.value.find(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe the first value that respects a criteria\r\n   * @returns Observable of a value\r\n   */\r\n  firstBy$(clause: EntityFilterClause<V>): Observable<V> {\r\n    return this.values$.pipe(map((values: V[]) => values.find(clause)));\r\n  }\r\n\r\n  /**\r\n   * Get all the values that respect a criteria\r\n   * @returns Array of values\r\n   */\r\n  manyBy(clause: EntityFilterClause<V>): V[] {\r\n    return this.values$.value.filter(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe all the values that respect a criteria\r\n   * @returns Observable of values\r\n   */\r\n  manyBy$(clause: EntityFilterClause<V>): Observable<V[]> {\r\n    return this.values$.pipe(map((values: V[]) => values.filter(clause)));\r\n  }\r\n\r\n  /**\r\n   * Clear the filter and sort and unsubscribe from the source\r\n   */\r\n  clear() {\r\n    this.filter(undefined);\r\n    this.sort(undefined);\r\n  }\r\n\r\n  destroy() {\r\n    if (this.values$$ !== undefined) {\r\n      this.values$$.unsubscribe();\r\n    }\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Create an index\r\n   * @param getKey Method to get a value's id\r\n   * @returns The view\r\n   */\r\n  createIndex(getKey: (E) => EntityKey): EntityView<E, V> {\r\n    this._index = new Map();\r\n    this.getKey$.next(getKey);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Join another source to the stream (chainable)\r\n   * @param clause Join clause\r\n   * @returns The view\r\n   */\r\n  join(clause: EntityJoinClause): EntityView<E, V> {\r\n    if (this.lifted === true) {\r\n      throw new Error('This view has already been lifted, therefore, no join is allowed.');\r\n    }\r\n    this.joins.push(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Filter values (chainable)\r\n   * @param clause Filter clause\r\n   * @returns The view\r\n   */\r\n  filter(clause: EntityFilterClause<V>): EntityView<E, V> {\r\n    this.filter$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * @param clause Filter clause\r\n   * @returns The filter id\r\n   */\r\n  addFilter(clause: EntityFilterClause<V>): string {\r\n    const id = uuid();\r\n    this.filterIndex.set(id, clause);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Remove a filter by id\r\n   * @param clause Filter clause\r\n   */\r\n  removeFilter(id: string) {\r\n    this.filterIndex.delete(id);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n  }\r\n\r\n  /**\r\n   * Sort values (chainable)\r\n   * @param clauseSort clause\r\n   * @returns The view\r\n   */\r\n  sort(clause: EntitySortClause<V>): EntityView<E, V> {\r\n    this.sort$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Create the final observable\r\n   * @returns Observable\r\n   */\r\n  lift() {\r\n    this.lifted = true;\r\n    const source$ = this.joins.length > 0 ? this.liftJoinedSource() : this.liftSource();\r\n    const observables$ = [\r\n      source$,\r\n      this.filters$,\r\n      this.filter$,\r\n      this.sort$,\r\n      this.getKey$\r\n    ];\r\n\r\n    this.values$$ = combineLatest(observables$)\r\n      .pipe(skip(1), debounceTime(5))\r\n      .subscribe((bunch: [V[], EntityFilterClause[], EntityFilterClause, EntitySortClause, (V) => EntityKey]) => {\r\n        const [_values, filters, filter, sort, getKey] = bunch;\r\n        const values = this.processValues(_values, filters, filter, sort);\r\n        const generateIndex = getKey !== undefined;\r\n        this.setValues(values, generateIndex);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when no joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftSource(): Observable<V[]> {\r\n    return this.source$ as any as Observable<V[]>;\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftJoinedSource(): Observable<V[]> {\r\n    const sources$ = [this.source$, combineLatest(\r\n      this.joins.map((join: EntityJoinClause) => join.source)\r\n    )];\r\n\r\n    return combineLatest(sources$)\r\n      .pipe(\r\n        map((bunch: [E[], any[]]) => {\r\n          const [entities, joinData] = bunch;\r\n          return entities.reduce((values: V[], entity: E) => {\r\n            const value = this.computeJoinedValue(entity, joinData);\r\n            if (value !== undefined) {\r\n              values.push(value);\r\n            }\r\n            return values;\r\n          }, []);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Apply joins to a source's entity and return the final value\r\n   * @returns Final value\r\n   */\r\n  private computeJoinedValue(entity: E, joinData: any[]): V | undefined {\r\n    let value = entity as Partial<V>;\r\n    let joinIndex = 0;\r\n    while (value !== undefined && joinIndex < this.joins.length) {\r\n      value = this.joins[joinIndex].reduce(value, joinData[joinIndex]);\r\n      joinIndex += 1;\r\n    }\r\n    return value as V;\r\n  }\r\n\r\n  /**\r\n   * Filter and sort values before streaming them\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @param filter Filter clause\r\n   * @param sort Sort clause\r\n   * @returns Filtered and sorted values\r\n   */\r\n  private processValues(\r\n    values: V[], filters: EntityFilterClause[], filter: EntityFilterClause, sort: EntitySortClause\r\n  ): V[] {\r\n    values = values.slice(0);\r\n    values = this.filterValues(values, filters.concat([filter]));\r\n    values = this.sortValues(values, sort);\r\n    return values;\r\n  }\r\n\r\n  /**\r\n   * Filter values\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @returns Filtered values\r\n   */\r\n  private filterValues(values: V[], clauses: EntityFilterClause[]): V[] {\r\n    if (clauses.length === 0) { return values; }\r\n\r\n    return values\r\n      .filter((value: V) => {\r\n        return clauses\r\n          .filter((clause: EntityFilterClause) => clause !== undefined)\r\n          .every((clause: EntityFilterClause) => clause(value));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Sort values\r\n   * @param values Values\r\n   * @param sort Sort clause\r\n   * @returns Sorted values\r\n   */\r\n  private sortValues(values: V[], clause: EntitySortClause): V[] {\r\n    if (clause === undefined) { return values; }\r\n    return values.sort((v1: V, v2: V) => {\r\n      return ObjectUtils.naturalCompare(\r\n        clause.valueAccessor(v1),\r\n        clause.valueAccessor(v2),\r\n        clause.direction,\r\n        clause.nullsFirst\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set value and optionally generate an index\r\n   * @param values Values\r\n   * @param generateIndex boolean\r\n   */\r\n  private setValues(values: V[], generateIndex: boolean) {\r\n    if (generateIndex === true) {\r\n      this._index = this.generateIndex(values);\r\n    }\r\n\r\n    this.values$.next(values);\r\n\r\n    const count = values.length;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the values\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(values: V[]): Map<EntityKey, V> {\r\n    const entries = values.map((value: V) => [this.getKey(value), value]);\r\n    return new Map(entries as [EntityKey, V][]);\r\n  }\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStateManager } from './state';\r\nimport { EntityView } from './view';\r\nimport { EntityKey, EntityState, EntityRecord, EntityStoreOptions } from './entity.interfaces';\r\nimport { getEntityId, getEntityProperty } from './entity.utils';\r\nimport { EntityStoreStrategy } from './strategies/strategy';\r\n\r\n/**\r\n * An entity store class holds any number of entities\r\n * as well as their state. It can be observed, filtered and sorted and\r\n * provides methods to insert, update or delete entities.\r\n */\r\nexport class EntityStore<E extends object = object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * Observable of the raw entities\r\n   */\r\n  readonly entities$ = new BehaviorSubject<E[]>([]);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Entity store state\r\n   */\r\n  readonly state: EntityStateManager<E, S>;\r\n\r\n  /**\r\n   * View of all the entities\r\n   */\r\n  readonly view: EntityView<E>;\r\n\r\n  /**\r\n   * View of all the entities and their state\r\n   */\r\n  readonly stateView: EntityView<E, EntityRecord<E, S>>;\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  /**\r\n   * Method to get an entity's named property\r\n   */\r\n  readonly getProperty: (E, prop: string) => any;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, E> { return this._index; }\r\n  private _index: Map<EntityKey, E>;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get pristine(): boolean { return this._pristine; }\r\n  private _pristine: boolean = true;\r\n\r\n  /**\r\n   * Strategies\r\n   */\r\n  private strategies: EntityStoreStrategy[] = [];\r\n\r\n  constructor(entities: E[], options: EntityStoreOptions = {}) {\r\n    this.getKey = options.getKey ? options.getKey : getEntityId;\r\n    this.getProperty = options.getProperty ? options.getProperty : getEntityProperty;\r\n\r\n    this.state = this.createStateManager();\r\n    this.view = this.createDataView();\r\n    this.stateView = this.createStateView();\r\n\r\n    this.view.lift();\r\n    this.stateView.lift();\r\n\r\n    if (entities.length > 0) {\r\n      this.load(entities);\r\n    } else {\r\n      this._index = this.generateIndex(entities);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity from the store by key\r\n   * @param key Key\r\n   * @returns Entity\r\n   */\r\n  get(key: EntityKey): E {\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all entities in the store\r\n   * @returns Array of entities\r\n   */\r\n  all(): E[] {\r\n    return this.entities$.value;\r\n  }\r\n\r\n  /**\r\n   * Set this store's entities\r\n   * @param entities Entities\r\n   */\r\n  load(entities: E[], pristine: boolean = true) {\r\n    this._index = this.generateIndex(entities);\r\n    this._pristine = pristine;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities but keep the state and views intact.\r\n   * Views won't return any data but future data will be subject to the\r\n   * current views filter and sort\r\n   */\r\n  softClear() {\r\n    if (this.index && this.index.size > 0) {\r\n      this.index.clear();\r\n      this._pristine = true;\r\n      this.next();\r\n    } else if (this.index) {\r\n      this.updateCount();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities, state and views\r\n   */\r\n  clear() {\r\n    this.stateView.clear();\r\n    this.view.clear();\r\n    this.state.clear();\r\n    this.softClear();\r\n  }\r\n\r\n  destroy() {\r\n    this.stateView.destroy();\r\n    this.view.destroy();\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  insert(entity: E) {\r\n    this.insertMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  insertMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update or insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  update(entity: E) {\r\n    this.updateMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Update or insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  updateMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Delete an entity from the store\r\n   * @param entity Entity\r\n   */\r\n  delete(entity: E) {\r\n    this.deleteMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Delete many entities from the store\r\n   * @param entities Entities\r\n   */\r\n  deleteMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.delete(this.getKey(entity)));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Add a strategy to this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  addStrategy(strategy: EntityStoreStrategy, activate: boolean = false): EntityStore {\r\n    const existingStrategy = this.strategies.find((_strategy: EntityStoreStrategy) => {\r\n      return strategy.constructor === _strategy.constructor;\r\n    });\r\n    if (existingStrategy !== undefined) {\r\n      throw new Error('A strategy of this type already exists on that EntityStore.');\r\n    }\r\n\r\n    this.strategies.push(strategy);\r\n    strategy.bindStore(this);\r\n\r\n    if (activate === true) {\r\n      strategy.activate();\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove a strategy from this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  removeStrategy(strategy: EntityStoreStrategy): EntityStore {\r\n    const index = this.strategies.indexOf(strategy);\r\n    if (index >= 0) {\r\n      this.strategies.splice(index, 1);\r\n      strategy.unbindStore(this);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Return strategies of a given type\r\n   * @param type Entity store strategy class\r\n   * @returns Strategies\r\n   */\r\n  getStrategyOfType(type: typeof EntityStoreStrategy): EntityStoreStrategy {\r\n    return this.strategies.find((strategy: EntityStoreStrategy) => {\r\n      return strategy instanceof type;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  activateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  deactivateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the entities\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(entities: E[]): Map<EntityKey, E> {\r\n    const entries = entities.map((entity: E) => [this.getKey(entity), entity]);\r\n    return new Map(entries as [EntityKey, E][]);\r\n  }\r\n\r\n  /**\r\n   * Push the index's entities into the entities$ observable\r\n   */\r\n  private next() {\r\n    this.entities$.next(Array.from(this.index.values()));\r\n    this.updateCount();\r\n  }\r\n\r\n  /**\r\n   * Update the store's count and empty\r\n   */\r\n  private updateCount() {\r\n    const count = this.index.size;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Create the entity state manager\r\n   * @returns EntityStateManager\r\n   */\r\n  private createStateManager() {\r\n    return new EntityStateManager<E, S>({store: this});\r\n  }\r\n\r\n  /**\r\n   * Create the data view\r\n   * @returns EntityView<E>\r\n   */\r\n  private createDataView() {\r\n    return new EntityView<E>(this.entities$);\r\n  }\r\n\r\n  /**\r\n   * Create the state view\r\n   * @returns EntityView<EntityRecord<E>>\r\n   */\r\n  private createStateView() {\r\n    return new EntityView<E, EntityRecord<E, S>>(this.view.all$())\r\n      .join({\r\n        source: this.state.change$,\r\n        reduce: (entity: E): EntityRecord<E, S> => {\r\n          const key = this.getKey(entity);\r\n          const state = this.state.get(entity);\r\n          const currentRecord = this.stateView.get(key);\r\n\r\n          if (\r\n            currentRecord !== undefined &&\r\n            currentRecord.entity === entity &&\r\n            this.statesAreTheSame(currentRecord.state, state)\r\n          ) {\r\n            return currentRecord;\r\n          }\r\n\r\n          const revision = currentRecord ? currentRecord.revision + 1 : 1;\r\n          const ref = `${key}-${revision}`;\r\n          return {entity, state, revision, ref};\r\n        }\r\n      })\r\n      .createIndex((record: EntityRecord<E, S>) => this.getKey(record.entity));\r\n  }\r\n\r\n  private statesAreTheSame(currentState: S, newState: S): boolean {\r\n    if (currentState === newState) {\r\n      return true;\r\n    }\r\n\r\n    const currentStateIsEmpty = Object.keys(currentState).length === 0;\r\n    const newStateIsEmpty = Object.keys(newState).length === 0;\r\n    return currentStateIsEmpty && newStateIsEmpty;\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to synchronize a component's changes\r\n * detection with an EntityStore changes. For example, it is frequent\r\n * to have a component subscribe to a store's selected entity and, at the same time,\r\n * this component provides a way to select an entity with, let's say, a click.\r\n *\r\n * This class automatically handles those case and triggers the compoent's\r\n * change detection when needed.\r\n *\r\n * Note: If the component observes the store's stateView, a workspace is\r\n * probably not required because the stateView catches any changes to the\r\n * entities and their state.\r\n */\r\nexport class EntityStoreWatcher<E extends object> {\r\n\r\n  /**\r\n   * Component change detector\r\n   */\r\n  private cdRef: ChangeDetectorRef;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  private store: EntityStore<E>;\r\n\r\n  /**\r\n   * Component inner state\r\n   */\r\n  private innerStateIndex = new Map<EntityKey, {[key: string]: any}>();\r\n\r\n  /**\r\n   * Subscription to the store's entities\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the store's state\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  constructor(store?: EntityStore<E>, cdRef?: ChangeDetectorRef) {\r\n    this.setChangeDetector(cdRef);\r\n    this.setStore(store);\r\n  }\r\n\r\n  destroy() {\r\n    this.setChangeDetector(undefined);\r\n    this.setStore(undefined);\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a store and start watching for changes\r\n   * @param store Entity store\r\n   */\r\n  setStore(store?: EntityStore<E>) {\r\n    if (store === undefined) {\r\n      this.teardownObservers();\r\n      this.innerStateIndex.clear();\r\n      this.store = undefined;\r\n      return;\r\n    }\r\n\r\n    this.setStore(undefined);\r\n    this.store = store;\r\n    this.setupObservers();\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a component's change detector\r\n   * @param cdRef Change detector\r\n   */\r\n  setChangeDetector(cdRef?: ChangeDetectorRef) {\r\n    this.cdRef = cdRef;\r\n  }\r\n\r\n  /**\r\n   * Set up observers on a store's entities and their state\r\n   * @param store Entity store\r\n   */\r\n  private setupObservers() {\r\n    this.teardownObservers();\r\n\r\n    this.entities$$ = this.store.entities$\r\n      .subscribe((entities: E[]) => this.onEntitiesChange(entities));\r\n\r\n    this.state$$ = this.store.state.change$\r\n      .pipe(skip(1))\r\n      .subscribe(() => this.onStateChange());\r\n  }\r\n\r\n  /**\r\n   * Teardown store observers\r\n   */\r\n  private teardownObservers() {\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n    this.entities$$ = undefined;\r\n    this.state$$ = undefined;\r\n  }\r\n\r\n  /**\r\n   * When the entities change, always trigger the changes detection\r\n   */\r\n  private onEntitiesChange(entities: E[]) {\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * When the entities state change, trigger the change detection\r\n   * only if the component has not handled these changes yet. For example,\r\n   * the component might have initiated thoses changes itself.\r\n   */\r\n  private onStateChange() {\r\n    let changesDetected = false;\r\n    const storeIndex = this.store.state.index;\r\n    const innerIndex = this.innerStateIndex;\r\n\r\n    if (storeIndex.size !== innerIndex.size) {\r\n      changesDetected = this.detectChanges();\r\n    }\r\n\r\n    const storeKeys = Array.from(storeIndex.keys());\r\n    for (const key of storeKeys) {\r\n      const storeValue = storeIndex.get(key);\r\n      const innerValue = innerIndex.get(key);\r\n      if (changesDetected === false) {\r\n        if (innerValue === undefined) {\r\n          changesDetected = this.detectChanges();\r\n        } else if (!ObjectUtils.objectsAreEquivalent(storeValue, innerValue)) {\r\n          changesDetected = this.detectChanges();\r\n        }\r\n      }\r\n\r\n      this.innerStateIndex.set(key, Object.assign({}, storeValue));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger the change detection of the workspace is bound to a change detector\r\n   */\r\n  private detectChanges() {\r\n    if (this.cdRef !== undefined) {\r\n      this.cdRef.detectChanges();\r\n    }\r\n    return true;\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStoreStrategyOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\n\r\n/**\r\n * Entity store strategies. They can do pretty much anything during a store's\r\n * lifetime. For example, they may act as triggers when something happens.\r\n * Sharing a strategy is a good idea when multiple strategies would have\r\n * on cancelling effect on each other.\r\n *\r\n * At creation, strategy is inactive and needs to be manually activated.\r\n */\r\nexport class EntityStoreStrategy {\r\n\r\n  /**\r\n   * Feature store\r\n   * @internal\r\n   */\r\n  protected stores: EntityStore[] = [];\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  constructor(protected options: EntityStoreStrategyOptions = {}) {\r\n    this.options = options;\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.doDeactivate();\r\n    }\r\n    this.active$.next(true);\r\n    this.doActivate();\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.doDeactivate();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    if (this.stores.indexOf(store) < 0) {\r\n      this.stores.push(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from store\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    const index = this.stores.indexOf(store);\r\n    if (index >= 0) {\r\n      this.stores.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Do the stataegy activation\r\n   * @internal\r\n   */\r\n  protected doActivate() {}\r\n\r\n  /**\r\n   * Do the strategy deactivation\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {}\r\n\r\n}\r\n","import { EntityStoreStrategyFuncOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterCustomFuncStrategy extends EntityStoreStrategy {\r\n\r\n  constructor(protected options: EntityStoreStrategyFuncOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    this.filters.set(store, store.stateView.addFilter(this.options.filterClauseFunc));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","import { EntityRecord } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterSelectionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    if (this.filters.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const filter = (record: EntityRecord<object>) => {\r\n      return record.state.selected === true;\r\n    };\r\n    this.filters.set(store, store.stateView.addFilter(filter));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","<mat-form-field class=\"igo-entity-selector\">\r\n  <mat-select\r\n    [disabled]=\"disabled\"\r\n    [value]=\"selected$ | async\"\r\n    [multiple]=\"multi\"\r\n    [placeholder]=\"placeholder\"\r\n    (selectionChange)=\"onSelectionChange($event)\">\r\n    <mat-option *ngIf=\"emptyText !== undefined && multi === false\" [value]=\"emptyValue\">{{emptyText}}</mat-option>\r\n    <mat-option *ngIf=\"multi === true\" [value]=\"multiSelectValue\">{{multiText$ | async}}</mat-option>\r\n    <ng-template ngFor let-record [ngForOf]=\"store.stateView.all$() | async\">\r\n      <mat-option [value]=\"record.entity\">\r\n        {{titleAccessor(record.entity)}}\r\n      </mat-option>\r\n    </ng-template>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { EntityRecord } from '../shared/entity.interfaces';\r\nimport { EntityStore } from '../shared/store';\r\nimport { EntityStoreWatcher } from '../shared/watcher';\r\nimport { getEntityTitle } from '../shared/entity.utils';\r\n\r\n@Component({\r\n  selector: 'igo-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * The selected entity\r\n   * @internal\r\n   */\r\n  readonly selected$ = new BehaviorSubject<object>(undefined);\r\n\r\n  /**\r\n   * The current multi select option text\r\n   * @internal\r\n   */\r\n  readonly multiText$ = new BehaviorSubject<string>(undefined);\r\n\r\n  readonly multiSelectValue = {id: 'IGO_MULTI_SELECT'};\r\n\r\n  readonly emptyValue = {id: 'IGO_EMPTY_SELECT'};\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private selected$$: Subscription;\r\n\r\n  /**\r\n   * Store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<object>;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Title accessor\r\n   */\r\n  @Input() titleAccessor: (object) => string = getEntityTitle;\r\n\r\n  /**\r\n   * Text to display when nothing is selected\r\n   */\r\n  @Input() emptyText: string = undefined;\r\n\r\n  /**\r\n   * Wheter selecting many entities is allowed\r\n   */\r\n  @Input() multi: boolean = false;\r\n\r\n  /**\r\n   * Text to display for the select all option\r\n   */\r\n  @Input() multiAllText: string = 'All';\r\n\r\n  /**\r\n   * Text to display for the select none option\r\n   */\r\n  @Input() multiNoneText: string = 'None';\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Wheter the selector is disabled or not\r\n   */\r\n  @Input() disabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the selection changes\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: object | object[];\r\n  }>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Create a store watcher and subscribe to the selected entity\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.selected$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const entities = records.map((record: EntityRecord<object>) => record.entity);\r\n        this.onSelectFromStore(entities);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the selected entity and destroy the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.selected$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On selection change, update the store's state and emit an event\r\n   * @internal\r\n   */\r\n  onSelectionChange(event: {value: object | undefined}) {\r\n    const values = event.value instanceof Array ? event.value : [event.value];\r\n\r\n    const multiSelect = values.find((_value: object) => _value === this.multiSelectValue);\r\n    let entities = values.filter((_value: object) => _value !== this.multiSelectValue);\r\n    if (multiSelect !== undefined) {\r\n      if (entities.length === this.store.count) {\r\n        entities = [];\r\n      } else if (entities.length < this.store.count) {\r\n        entities = this.store.all();\r\n      }\r\n    }\r\n\r\n    entities = entities.filter((entity: object) => entity !== this.emptyValue);\r\n    if (entities.length === 0) {\r\n      this.store.state.updateAll({selected: false});\r\n    } else {\r\n      this.store.state.updateMany(entities, {selected: true}, true);\r\n    }\r\n\r\n    const value = this.multi ? entities : event.value;\r\n    this.selectedChange.emit({selected: true, value});\r\n  }\r\n\r\n  private onSelectFromStore(entities: object[]) {\r\n    if (this.multi === true) {\r\n      this.selected$.next(entities);\r\n    } else {\r\n      const entity = entities.length > 0 ? entities[0] : undefined;\r\n      this.selected$.next(entity);\r\n    }\r\n\r\n    this.updateMultiToggleWithEntities(entities);\r\n  }\r\n\r\n  private updateMultiToggleWithEntities(entities: object[]) {\r\n    if (entities.length === this.store.count && this.multiText$.value !== this.multiNoneText) {\r\n      this.multiText$.next(this.multiNoneText);\r\n    } else if (entities.length < this.store.count && this.multiText$.value !== this.multiAllText) {\r\n      this.multiText$.next(this.multiAllText);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Directive, HostListener } from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoStopPropagation]'\r\n})\r\nexport class StopPropagationDirective {\r\n  @HostListener('click', ['$event'])\r\n  public onClick(event: any): void {\r\n    event.stopPropagation();\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  ElementRef,\r\n  Renderer2,\r\n  EventEmitter,\r\n  Output,\r\n  HostListener\r\n} from '@angular/core';\r\n\r\nimport scrollIntoView from 'scroll-into-view-if-needed';\r\n\r\nimport { EntityTableScrollBehavior } from '../shared/entity.enums';\r\n\r\n/**\r\n * Directive that handles an entity table row click and selection.\r\n */\r\n@Directive({\r\n  selector: '[igoEntityTableRow]'\r\n})\r\nexport class EntityTableRowDirective {\r\n\r\n  /**\r\n   * Class added to a selected row\r\n   */\r\n  static selectedCls = 'igo-entity-table-row-selected';\r\n\r\n  /**\r\n   * Class added to a highlighted row\r\n   */\r\n  static highlightedCls = 'igo-entity-table-row-highlighted';\r\n\r\n  /**\r\n   * Whether a row supports selection\r\n   */\r\n  @Input() selection = false;\r\n\r\n  /**\r\n   * Whether clicking a row should select it (if selection is true)\r\n   */\r\n  @Input() selectOnClick: boolean = true;\r\n\r\n  /**\r\n   * Whether the selected row should be highlighted\r\n   */\r\n  @Input() highlightSelection: boolean = true;\r\n\r\n  /**\r\n   * Whether a row is selected\r\n   */\r\n  @Input()\r\n  set selected(value: boolean) {\r\n    if (this.selection === false) { return; }\r\n    if (value === this._selected) { return; }\r\n\r\n    this.toggleSelected(value);\r\n    this.scroll();\r\n  }\r\n  get selected(): boolean {\r\n    return this._selected;\r\n  }\r\n  private _selected = false;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Event emitted when a row is selected\r\n   */\r\n  @Output() select = new EventEmitter<EntityTableRowDirective>();\r\n\r\n  /**\r\n   * When a row is clicked, select it if it's supported\r\n   * @ignore\r\n   */\r\n  @HostListener('click')\r\n  onClick() {\r\n    if (this.selection === false || this.selectOnClick === false) {\r\n      return;\r\n    }\r\n\r\n    this.toggleSelected(true);\r\n    this.select.emit(this);\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  /**\r\n   * Select a row and add or remove the selected class from it\r\n   * @param selected Whether the row should be selected\r\n   */\r\n  private toggleSelected(selected: boolean) {\r\n    this._selected = selected;\r\n    if (selected === true) {\r\n      this.addCls(EntityTableRowDirective.selectedCls);\r\n      if (this.highlightSelection === true) {\r\n        this.addCls(EntityTableRowDirective.highlightedCls);\r\n      }\r\n    } else {\r\n      this.removeCls(EntityTableRowDirective.selectedCls);\r\n      this.removeCls(EntityTableRowDirective.highlightedCls);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scroll to the selected row\r\n   */\r\n  private scroll() {\r\n    if (this._selected === true) {\r\n      scrollIntoView(this.el.nativeElement, {\r\n        scrollMode: 'if-needed',\r\n        behavior: 'smooth',\r\n        block: 'end',\r\n        inline: 'nearest'\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the selected CSS class\r\n   */\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  /**\r\n   * Remove the selected CSS class\r\n   */\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport {\r\n  EntityStore\r\n} from '../shared';\r\nimport { MatPaginator, PageEvent } from '@angular/material/paginator';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityTablePaginatorOptions } from './entity-table-paginator.interface';\r\n\r\n@Component({\r\n  selector: 'igo-entity-table-paginator',\r\n  templateUrl: './entity-table-paginator.component.html',\r\n  styleUrls: ['./entity-table-paginator.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntityTablePaginatorComponent implements OnChanges, OnDestroy {\r\n\r\n  public disabled: boolean = false;\r\n  public hidePageSize: boolean = false;\r\n  public pageIndex: number = 0;\r\n  public pageSize: number = 50;\r\n  public pageSizeOptions: number[] = [5, 10, 20, 50, 100, 200];\r\n  public showFirstLastButtons: boolean = true;\r\n  private count$$: Subscription;\r\n  private entitySortChange$$: Subscription;\r\n  private paginationLabelTranslation$$: Subscription[] = [];\r\n\r\n  @Input() entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when the paginator changes the page size or page index.\r\n   */\r\n  @Output() page: EventEmitter<PageEvent>;\r\n\r\n  public length: number = 0;\r\n\r\n  /**\r\n   * Paginator emitted.\r\n   */\r\n  @Output() paginatorChange: EventEmitter<MatPaginator> = new EventEmitter<MatPaginator>();\r\n\r\n  constructor(private languageService: LanguageService, private mediaService: MediaService) {}\r\n\r\n  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;\r\n\r\n  ngOnChanges() {\r\n    this.unsubscribeAll();\r\n    this.count$$ = this.store.stateView.count$.subscribe((count) => {\r\n      this.length = count;\r\n      this.emitPaginator();\r\n    });\r\n    this.entitySortChange$$ = this.entitySortChange$.subscribe(() => {\r\n      if (this.paginator) {\r\n        this.paginator.firstPage();\r\n      }\r\n    });\r\n    this.initPaginatorOptions();\r\n    this.translateLabels();\r\n  }\r\n\r\n  initPaginatorOptions() {\r\n    this.disabled = this.paginatorOptions?.disabled || this.disabled;\r\n    this.pageIndex = this.paginatorOptions?.pageIndex || this.pageIndex;\r\n    this.pageSize = this.paginatorOptions?.pageSize || this.pageSize;\r\n    this.pageSizeOptions = this.paginatorOptions?.pageSizeOptions || this.pageSizeOptions;\r\n    if (this.mediaService.isMobile()) {\r\n      this.showFirstLastButtons = false;\r\n      this.hidePageSize = true;\r\n    } else {\r\n      this.showFirstLastButtons = this.paginatorOptions?.showFirstLastButtons || this.showFirstLastButtons;\r\n      this.hidePageSize = this.paginatorOptions?.hidePageSize || this.hidePageSize;\r\n    }\r\n  }\r\n\r\n  translateLabels() {\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.firstPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.firstPageLabel = label;\r\n      }));\r\n\r\n    this.paginator._intl.getRangeLabel = this.rangeLabel;\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.itemsPerPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.itemsPerPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.lastPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.lastPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.nextPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.nextPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.previousPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.previousPageLabel = label;\r\n      }));\r\n  }\r\n\r\n  rangeLabel = (page: number, pageSize: number, length: number) => {\r\n    const of: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.of').subscribe((label: string) => {\r\n        of.next(label);\r\n      }));\r\n    if (length === 0 || pageSize === 0) { return `0 ${of.value} ${length}`; }\r\n    length = Math.max(length, 0);\r\n    const startIndex = page * pageSize;\r\n    const endIndex = startIndex < length ?\r\n        Math.min(startIndex + pageSize, length) :\r\n        startIndex + pageSize;\r\n    return `${startIndex + 1} - ${endIndex} ${of.value} ${length}`;\r\n  }\r\n\r\n  private unsubscribeAll() {\r\n    this.paginationLabelTranslation$$.map(sub => sub.unsubscribe());\r\n    if (this.count$$) { this.count$$.unsubscribe(); }\r\n    if (this.entitySortChange$$) { this.entitySortChange$$.unsubscribe(); }\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  emitPaginator() {\r\n    this.paginatorChange.emit(this.paginator);\r\n  }\r\n}\r\n","<mat-paginator \r\n  [disabled]=\"disabled\"\r\n  [hidePageSize]=\"hidePageSize\"\r\n  [length]=\"length\"\r\n  [pageIndex]=\"pageIndex\"\r\n  [pageSize]=\"pageSize\"\r\n  [pageSizeOptions]=\"pageSizeOptions\"\r\n  [showFirstLastButtons]=\"showFirstLastButtons\"\r\n  (page)=\"emitPaginator()\">\r\n</mat-paginator>\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\nimport { Observable } from 'rxjs';\r\nimport { switchMap } from 'rxjs/operators';\r\n\r\n@Pipe({\r\n  name: 'secureImage'\r\n})\r\nexport class SecureImagePipe implements PipeTransform {\r\n  constructor(private http: HttpClient) {}\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  transform(url: string): Observable<string> {\r\n    const headers = new HttpHeaders({\r\n      'Content-Type': 'text/plain',\r\n      activityInterceptor: 'false'\r\n    });\r\n\r\n    return this.http\r\n      .get(url, {\r\n        headers,\r\n        responseType: 'blob'\r\n      })\r\n      .pipe(\r\n        switchMap((blob) => {\r\n          return new Observable((observer) => {\r\n            const reader = new FileReader();\r\n            reader.readAsDataURL(blob);\r\n            reader.onloadend = () => {\r\n              observer.next(reader.result);\r\n              observer.complete();\r\n            };\r\n          });\r\n        })\r\n      ) as Observable<string>;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { DomSanitizer, SafeHtml } from '@angular/platform-browser';\r\n\r\n@Pipe({ name: 'sanitizeHtml' })\r\nexport class SanitizeHtmlPipe implements PipeTransform {\r\n  constructor(private _sanitizer: DomSanitizer) {\r\n  }\r\n  transform(v: string): SafeHtml {\r\n    return this._sanitizer.bypassSecurityTrustHtml(v);\r\n  }\r\n}\r\n","<div class=\"table-container\">\r\n    <table mat-table matSort [ngClass]=\"getTableClass()\" [dataSource]=\"dataSource\" [trackBy]=\"getTrackByFunction()\" (matSortChange)=\"onSort($event)\">\r\n        <ng-container matColumnDef=\"selectionCheckbox\" class=\"mat-cell-checkbox\">\r\n            <th mat-header-cell *matHeaderCellDef>\r\n                <ng-container *ngIf=\"selectMany\">\r\n                    <ng-container *ngIf=\"selectionState$ | async as selectionState\">\r\n                        <mat-checkbox (change)=\"onToggleRows($event.checked)\" [checked]=\"selectionState === entityTableSelectionState.All\"\r\n                        [indeterminate]=\"selectionState === entityTableSelectionState.Some\">\r\n                        </mat-checkbox>\r\n                    </ng-container>\r\n                </ng-container>\r\n            </th>\r\n            <td mat-cell *matCellDef=\"let record\">\r\n                <mat-checkbox (mousedown)=\"$event.shiftKey ? $event.preventDefault() : null\" (click)=\"$event.shiftKey ?\r\n                onShiftToggleRow(!rowIsSelected(record), record, $event) : $event.stopPropagation()\" (change)=\"onToggleRow($event.checked,record)\"\r\n                [checked]=\"rowIsSelected(record)\">\r\n                </mat-checkbox>\r\n            </td>\r\n        </ng-container>\r\n\r\n        <ng-container [matColumnDef]=\"column.name\" *ngFor=\"let column of template.columns\">\r\n            <ng-container *ngIf=\"columnIsSortable(column)\">\r\n                <th mat-header-cell *matHeaderCellDef mat-sort-header [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                    {{column.title}}\r\n                </th>\r\n            </ng-container>\r\n\r\n            <ng-container *ngIf=\"!columnIsSortable(column)\">\r\n                <th mat-header-cell *matHeaderCellDef [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                    {{column.title}}\r\n                </th>\r\n            </ng-container>\r\n\r\n            <ng-container *ngIf=\"getColumnRenderer(column) as columnRenderer\">\r\n                <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Default\">\r\n                    <ng-container *matCellDef=\"let record\">\r\n                        <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlDefault\" [ngClass]=\"getCellClass(record, column)\">\r\n                            {{getValue(record, column)}}\r\n                        </td>\r\n                        <ng-template #isAnUrlDefault>\r\n                            <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                                <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                    <img *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                    <ng-template #notImg><span>{{\r\n                      'igo.common.entity-table.targetHtmlUrl' | translate }}\r\n                    </span></ng-template>\r\n                                </a>\r\n                            </td>\r\n                        </ng-template>\r\n                    </ng-container>\r\n                </ng-container>\r\n                <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.HTML\">\r\n                    <ng-container *matCellDef=\"let record\">\r\n                        <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                        [innerHTML]=\"getValue(record, column)\">\r\n                        </td>\r\n                        <ng-template #isAnUrlHTML>\r\n                            <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                                <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                    <img *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                    <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' |\r\n                      translate }} </span></ng-template>\r\n                                </a>\r\n                            </td>\r\n                        </ng-template>\r\n                    </ng-container>\r\n                </ng-container>\r\n                <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.UnsanitizedHTML\">\r\n                    <ng-container *matCellDef=\"let record\">\r\n                        <td mat-cell class=\"mat-cell-text edition\" [formGroup]=\"formGroup\" *ngIf=\"isEdition(record);else isUnsanitizedHTML\"\r\n                        [ngClass]=\"getCellClass(record, column)\">\r\n                            <div class=\"date-picker\" *ngIf=\"column.type === 'date'\">\r\n                                <mat-datepicker-toggle matSuffix [for]=\"picker\"></mat-datepicker-toggle>\r\n                                <input matInput [matDatepicker]=\"picker\" [formControlName]=\"column.name\" value=\"{{getValue(record, column)}}\"\r\n                                (dateChange)=\"onDateChange(column.name, record, $event)\">\r\n                                <mat-datepicker #picker></mat-datepicker>\r\n                            </div>\r\n                            <input matInput type=\"time\" *ngIf=\"column.type === 'time'\" [formControlName]=\"column.name\" step=\"900\" (focus)=\"column.onFocus($event)\"\r\n                            (keypress)=\"column.onChange($event)\" (blur)=\"column.onBlur($event)\">\r\n                            <input matInput type=\"number\" class=\"class_number_edition\" *ngIf=\"column.type === 'number'\" [formControlName]=\"column.name\" step=\"{{column.step}}\"\r\n                            value=\"{{getValue(record,column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                            readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                            min=\"{{getValidationAttributeValue(column, 'minValue')}}\" max=\"{{getValidationAttributeValue(column, 'maxValue')}}\">\r\n                            <input matInput type=\"text\" *ngIf=\"!column.type || column.type ==='string'\" [formControlName]=\"column.name\"\r\n                            value=\"{{getValue(record, column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                            readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\">\r\n                            <mat-checkbox *ngIf=\"column.type === 'boolean'\" [formControlName]=\"column.name\" [checked]=\"getValue(record,column)\"\r\n                            (change)=\"onBooleanValueChange(column.name, record,$event)\"></mat-checkbox>\r\n                            <mat-select *ngIf=\"column.type === 'list'\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                            [formControlName]=\"column.name\" [multiple]=\"column.multiple\" (selectionChange)=\"onSelectValueChange(column.name, record, $event)\"\r\n                            [value]=\"getValue(record, column)\">\r\n                                <mat-option *ngFor=\"let option of column.domainValues\" [value]=\"option.id\" [disabled]=\"option.disabled\">\r\n                                    {{ option.value }}\r\n                                </mat-option>\r\n                            </mat-select>\r\n                            <input matInput type=\"text\" [formControlName]=\"column.name\" *ngIf=\"column.type === 'autocomplete'\"\r\n                            [matAutocomplete]=\"auto\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\" value=\"{{getValue(record, column)}}\">\r\n                                <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onAutocompleteValueChange(column.name, record, $event)\"\r\n                                panelWidth=\"430px\">\r\n                                    <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option.id\">\r\n                                        {{ option.value }}\r\n                                    </mat-option>\r\n                                </mat-autocomplete>\r\n                        </td>\r\n                        <ng-template #isUnsanitizedHTML>\r\n                            <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlUnsanitizedHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                            [innerHTML]=\"getValue(record, column) | sanitizeHtml\">\r\n                            </td>\r\n                            <ng-template #isAnUrlUnsanitizedHTML>\r\n                                <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                                    <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                        <img *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                        <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' | translate }} </span></ng-template>\r\n                                    </a>\r\n                                </td>\r\n                            </ng-template>\r\n                        </ng-template>\r\n                    </ng-container>\r\n                </ng-container>\r\n                <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Icon\">\r\n                    <td mat-cell *matCellDef=\"let record\" class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                        <mat-icon svgIcon=\"{{getValue(record, column)|| column.icon}}\" (click)=\"column.onClick($event)\"></mat-icon>\r\n                    </td>\r\n                </ng-container>\r\n                <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.ButtonGroup\">\r\n                    <ng-container *matCellDef=\"let record\">\r\n                        <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                            <span *ngFor=\"let button of getValue(record, column)\">\r\n                                <ng-container *ngIf=\"isEdition(record) === button.editMode\">\r\n                                    <button *ngIf=\"button.style === 'mat-icon-button'\" igoStopPropagation mat-icon-button\r\n                                        [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                        <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                    </button>\r\n                                    <button *ngIf=\"button.style !== 'mat-icon-button'\" igoStopPropagation mat-mini-fab\r\n                                        [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                        <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                    </button>\r\n                                </ng-container>\r\n                            </span>\r\n                        </td>\r\n                    </ng-container>\r\n                </ng-container>\r\n            </ng-container>\r\n        </ng-container>\r\n\r\n        <tr mat-header-row *matHeaderRowDef=\"headers; sticky: fixedHeader;\" [ngClass]=\"getHeaderClass()\">\r\n        </tr>\r\n        <tr mat-row igoEntityTableRow *matRowDef=\"let record; columns: headers;\" [scrollBehavior]=\"scrollBehavior\" [ngClass]=\"getRowClass(record)\" [selection]=\"selection\" [selected]=\"rowIsSelected(record)\" (select)=\"onRowSelect(record)\" (click)=\"onRowClick(record)\">\r\n        </tr>\r\n    </table>\r\n    <igo-entity-table-paginator *ngIf=\"withPaginator\" [store]=\"store\" [paginatorOptions]=\"paginatorOptions\" [entitySortChange$]=\"entitySortChange$\" (paginatorChange)=\"paginatorChange($event)\">\r\n    </igo-entity-table-paginator>\r\n</div>","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ElementRef,\r\n  Optional,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Observable, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  EntityKey,\r\n  EntityRecord,\r\n  EntityState,\r\n  EntityStore,\r\n  EntityTableTemplate,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer,\r\n  EntityTableSelectionState,\r\n  EntityTableScrollBehavior\r\n} from '../shared';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { MatTableDataSource } from '@angular/material/table';\r\nimport { EntityTablePaginatorOptions } from '../entity-table-paginator/entity-table-paginator.interface';\r\nimport { MatFormFieldControl } from '@angular/material/form-field';\r\nimport { FormBuilder, NgControl, NgForm, FormControlName, FormGroup } from '@angular/forms';\r\nimport { FocusMonitor } from '@angular/cdk/a11y';\r\nimport { DateAdapter, ErrorStateMatcher } from '@angular/material/core';\r\nimport { map } from 'rxjs/operators';\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\n@Component({\r\n  selector: 'igo-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  providers: [{ provide: MatFormFieldControl, useExisting: EntityTableComponent }]\r\n})\r\nexport class EntityTableComponent implements OnInit, OnChanges, OnDestroy {\r\n\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public formGroup: FormGroup = new FormGroup({});\r\n\r\n  public filteredOptions: Observable<any[]>;\r\n\r\n  /**\r\n   * Reference to the column renderer types\r\n   * @internal\r\n   */\r\n  entityTableColumnRenderer = EntityTableColumnRenderer;\r\n\r\n  /**\r\n   * Reference to the selection's state\r\n   * @internal\r\n   */\r\n  entityTableSelectionState = EntityTableSelectionState;\r\n\r\n  /**\r\n   * Observable of the selection,s state\r\n   * @internal\r\n   */\r\n  readonly selectionState$: BehaviorSubject<EntityTableSelectionState> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the store's selection\r\n   */\r\n  private selection$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the dataSource\r\n   */\r\n  private dataSource$$: Subscription;\r\n\r\n  /**\r\n   * The last record checked. Useful for selecting\r\n   * multiple records by holding the shift key and checking\r\n   * checkboxes.\r\n   */\r\n  private lastRecordCheckedKey: EntityKey;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Table paginator\r\n   */\r\n  @Input() set paginator(value: MatPaginator) {\r\n    this._paginator = value;\r\n    this.dataSource.paginator = value;\r\n  }\r\n\r\n  get paginator(): MatPaginator {\r\n    return this._paginator;\r\n  }\r\n  private _paginator: MatPaginator;\r\n\r\n  /**\r\n   * Table template\r\n   */\r\n  @Input() template: EntityTableTemplate;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Whether nulls should be first when sorting\r\n   */\r\n  @Input()\r\n  sortNullsFirst: boolean = false;\r\n\r\n  /**\r\n   * Show the table paginator or not. False by default.\r\n   */\r\n  @Input()\r\n  withPaginator: boolean = false;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is clicked\r\n   */\r\n  @Output() entityClick = new EventEmitter<object>();\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is selected\r\n   */\r\n  @Output() entitySelectChange = new EventEmitter<{\r\n    added: object[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the table sort is changed.\r\n   */\r\n  @Output() entitySortChange: EventEmitter<{column: EntityTableColumn, direction: string}> = new EventEmitter(undefined);\r\n\r\n  /**\r\n   * Table headers\r\n   * @internal\r\n   */\r\n  get headers(): string[] {\r\n    let columns = this.template.columns\r\n      .filter((column: EntityTableColumn) => column.visible !== false)\r\n      .map((column: EntityTableColumn) => column.name);\r\n\r\n    if (this.selectionCheckbox === true) {\r\n      columns = ['selectionCheckbox'].concat(columns);\r\n    }\r\n\r\n    return columns;\r\n  }\r\n\r\n  /**\r\n   * Data source consumable by the underlying material table\r\n   * @internal\r\n   */\r\n  dataSource = new MatTableDataSource<object>();\r\n\r\n  /**\r\n   * Whether selection is supported\r\n   * @internal\r\n   */\r\n  get selection(): boolean { return this.template.selection || false; }\r\n\r\n  /**\r\n   * Whether a selection checkbox should be displayed\r\n   * @internal\r\n   */\r\n  get selectionCheckbox(): boolean { return this.template.selectionCheckbox || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get selectMany(): boolean { return this.template.selectMany || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get fixedHeader(): boolean { return this.template.fixedHeader === undefined ? true : this.template.fixedHeader; }\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n    private formBuilder: FormBuilder,\r\n    protected _focusMonitor: FocusMonitor,\r\n    protected _elementRef: ElementRef<HTMLElement>,\r\n    @Optional() @Self() public ngControl: NgControl,\r\n    @Optional() protected _parentForm: NgForm,\r\n    @Optional() protected _controlName: FormControlName,\r\n    protected _defaultErrorStateMatcher: ErrorStateMatcher,\r\n    private dateAdapter: DateAdapter<Date>\r\n  ) {\r\n    this.dateAdapter.setLocale('fr-CA');\r\n  }\r\n\r\n  /**\r\n   * Track the selection state to properly display the selection checkboxes\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.handleDatasource();\r\n    this.dataSource.paginator = this.paginator;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      this.handleDatasource();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process text or number value change (edition)\r\n   */\r\n  onValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.target.value;\r\n  }\r\n\r\n  /**\r\n   * Process boolean value change (edition)\r\n   */\r\n  onBooleanValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.checked;\r\n  }\r\n\r\n  /**\r\n   * Process select value change (edition)\r\n   */\r\n  onSelectValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.value;\r\n  }\r\n\r\n  /**\r\n   * Process autocomplete value change (edition)\r\n   */\r\n  onAutocompleteValueChange(column: string, record: EntityRecord<any>, event) {\r\n    this.formGroup.controls[column].setValue(event.option.viewValue);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.option.value;\r\n  }\r\n\r\n  /**\r\n   * Process date value change (edition)\r\n   */\r\n  onDateChange(column: string, record: EntityRecord<any>, event) {\r\n    const format = \"YYYY-MM-DD\";\r\n    const value = moment(event.value).format(format);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = value;\r\n  }\r\n\r\n  /**\r\n   * Enable edition mode for one row\r\n   * More than one row can be edited at the same time\r\n   */\r\n  private enableEdit(record: EntityRecord<any>) {\r\n    const item = record.entity.properties;\r\n    this.template.columns.forEach(column => {\r\n      column.title = column.validation?.mandatory && !column.title.includes('*') ? column.title + ' *' : column.title;\r\n\r\n      const key = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n      if (column.type === 'boolean') {\r\n        if (!item[key] || item[key] === null) {\r\n          item[key] = false;\r\n        } else if (typeof item[key] === 'string') {\r\n          item[key] = JSON.parse(item[key].toLowerCase());\r\n        }\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      } else if (column.type === 'list') {\r\n        if (column.multiple) {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            [item[key]]\r\n          ));\r\n        } else {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            item[key]\r\n          ));\r\n\r\n          typeof item[key] === 'string' ?\r\n            this.formGroup.controls[column.name].setValue(parseInt(item[key])) :\r\n            this.formGroup.controls[column.name].setValue(item[key]);\r\n        }\r\n      } else if (column.type === 'autocomplete') {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n\r\n        this.filteredOptions = this.formGroup.controls[column.name].valueChanges.pipe(\r\n          map(value => {\r\n            if (value.length) {\r\n              return column.domainValues.filter((option) => {\r\n                const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                return featureNameNormalized.includes(filterNormalized);\r\n              });\r\n            }\r\n          })\r\n        );\r\n\r\n        let formControlValue = item[key];\r\n        column.domainValues.forEach(option => {\r\n          if (typeof formControlValue === 'string' && /^\\d+$/.test(formControlValue)) {\r\n            formControlValue = parseInt(formControlValue);\r\n          }\r\n          if (option.value === formControlValue || option.id === formControlValue) {\r\n            formControlValue = option.value;\r\n          }\r\n        });\r\n\r\n        this.formGroup.controls[column.name].setValue(formControlValue);\r\n      } else if (column.type === 'date') {\r\n        if (column.visible) {\r\n          if (item[key]) {\r\n            let date = moment(item[key]);\r\n            item[key] = date.utc().format('YYYY-MM-DD');\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              item[key]\r\n            ));\r\n          } else {\r\n            const newKey = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n            record.entity.properties[newKey] = null;\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              null\r\n            ));\r\n          }\r\n        }\r\n      } else {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      }\r\n\r\n      if (this.formGroup.controls[column.name] && this.getValidationAttributeValue(column, 'readonly')) {\r\n        this.formGroup.controls[column.name].disable();\r\n      }\r\n    });\r\n  }\r\n\r\n  private handleDatasource() {\r\n    this.unsubscribeStore();\r\n    this.selection$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const firstSelected = records[0];\r\n        const firstSelectedStateviewPosition = this.store.stateView.all().indexOf(firstSelected);\r\n        const pageMax = this.paginator ? this.paginator.pageSize * (this.paginator.pageIndex + 1) : 0;\r\n        const pageMin = this.paginator ? pageMax - this.paginator.pageSize : 0;\r\n\r\n        if (\r\n          this.paginator &&\r\n          (firstSelectedStateviewPosition < pageMin ||\r\n          firstSelectedStateviewPosition >= pageMax)) {\r\n          const pageToReach = Math.floor(firstSelectedStateviewPosition / this.paginator.pageSize);\r\n          this.dataSource.paginator.pageIndex = pageToReach;\r\n        }\r\n        this.selectionState$.next(this.computeSelectionState(records));\r\n      });\r\n    this.dataSource$$ = this.store.stateView.all$().subscribe((all) => {\r\n      if (all[0]) {\r\n        this.enableEdit(all[0]);\r\n      }\r\n      this.dataSource.data = all;\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Unbind the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unsubscribeStore();\r\n  }\r\n\r\n  private unsubscribeStore() {\r\n    if (this.selection$$) {\r\n      this.selection$$.unsubscribe();\r\n    }\r\n    if (this.dataSource$$) {\r\n      this.dataSource$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trackby function\r\n   * @param record Record\r\n   * @param index Record index\r\n   * @internal\r\n   */\r\n  getTrackByFunction() {\r\n    return (index: number, record: EntityRecord<object, EntityState>) => {\r\n      return record.ref;\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Trigger a refresh of thre table. This can be useful when\r\n   * the data source doesn't emit a new value but for some reason\r\n   * the records need an update.\r\n   * @internal\r\n   */\r\n  refresh() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  /**\r\n   * On sort, sort the store\r\n   * @param event Sort event\r\n   * @internal\r\n   */\r\n  onSort(event: {active: string, direction: string}) {\r\n    const direction = event.direction;\r\n    const column = this.template.columns\r\n      .find((c: EntityTableColumn) => c.name === event.active);\r\n\r\n    if (direction === 'asc' || direction === 'desc') {\r\n      this.store.stateView.sort({\r\n        valueAccessor: (record: EntityRecord<object>) => this.getValue(record, column),\r\n        direction,\r\n        nullsFirst: this.sortNullsFirst\r\n      });\r\n      this.entitySortChange.emit({column, direction});\r\n      this.entitySortChange$.next(true);\r\n    } else {\r\n      this.store.stateView.sort(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is clicked, emit an event\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowClick(record: EntityRecord<object>) {\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n    this.entityClick.emit(record.entity);\r\n  }\r\n\r\n  /**\r\n   * When an entity is selected, select it in the store and emit an event. Even if\r\n   * \"many\" is set to true, this method always select a single, exclusive row. Selecting\r\n   * multiple rows should be achieved by using the checkboxes.\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowSelect(record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    this.store.state.update(entity, {selected: true}, true);\r\n    this.entitySelectChange.emit({added: [entity]});\r\n  }\r\n\r\n  /**\r\n   * Select or unselect all rows at once. On select, emit an event.\r\n   * @param toggle Select or unselect\r\n   * @internal\r\n   */\r\n  onToggleRows(toggle: boolean) {\r\n    if (this.selection === false) { return; }\r\n\r\n    this.store.state.updateAll({selected: toggle});\r\n    if (toggle === true) {\r\n      const entities = this.store.stateView\r\n        .all()\r\n        .map((record: EntityRecord<object>) => record.entity);\r\n      this.entitySelectChange.emit({added: [entities]});\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onToggleRow(toggle: boolean, record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    const exclusive = toggle === true && !this.selectMany;\r\n    this.store.state.update(entity, {selected: toggle}, exclusive);\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: [entity]});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onShiftToggleRow(toggle: boolean, record: EntityRecord<object>, event: MouseEvent) {\r\n    if (this.selection === false) { return; }\r\n\r\n    if (this.selectMany === false || this.lastRecordCheckedKey === undefined) {\r\n      this.onToggleRow(toggle, record);\r\n      return;\r\n    }\r\n\r\n    // This is a workaround mat checkbox wrong behavior\r\n    // when the shift key is held.\r\n    // See https://github.com/angular/components/issues/6232\r\n    const range = window.document.createRange();\r\n    range.selectNode(event.target as HTMLElement);\r\n    window.getSelection().removeAllRanges();\r\n    window.getSelection().addRange(range);\r\n    event.stopImmediatePropagation();\r\n\r\n    const records = this.store.stateView.all();\r\n    const recordIndex = records.indexOf(record);\r\n    const lastRecordChecked = this.store.stateView.get(this.lastRecordCheckedKey);\r\n    const lastRecordIndex = records.indexOf(lastRecordChecked);\r\n    const indexes = [recordIndex, lastRecordIndex];\r\n    const selectRecords = records.slice(Math.min(...indexes), Math.max(...indexes) + 1);\r\n\r\n    const entities = selectRecords.map((_record: EntityRecord<object>) => _record.entity);\r\n    this.store.state.updateMany(entities, {selected: toggle});\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: entities});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * Compute the selection state\r\n   * @returns Whether all, some or no rows are selected\r\n   * @internal\r\n   */\r\n  private computeSelectionState(selectedRecords: EntityRecord<object>[]): EntityTableSelectionState {\r\n    const states = EntityTableSelectionState;\r\n    const selectionCount = selectedRecords.length;\r\n    return selectionCount === 0 ?\r\n      states.None :\r\n      (selectionCount === this.store.stateView.count ? states.All : states.Some);\r\n  }\r\n\r\n  /**\r\n   * Whether a column is sortable\r\n   * @param column Column\r\n   * @returns True if a column is sortable\r\n   * @internal\r\n   */\r\n  columnIsSortable(column: EntityTableColumn): boolean {\r\n    let sortable = column.sort;\r\n    if (sortable === undefined) {\r\n      sortable = this.template.sort === undefined ? false : this.template.sort;\r\n    }\r\n    return sortable;\r\n  }\r\n\r\n  /**\r\n   * Whether a row is should be selected based on the underlying entity state\r\n   * @param record Record\r\n   * @returns True if a row should be selected\r\n   * @internal\r\n   */\r\n  rowIsSelected(record: EntityRecord<object>): boolean {\r\n    const state = record.state;\r\n    return state.selected ? state.selected : false;\r\n  }\r\n\r\n  isImg(value) {\r\n    if (this.isUrl(value)) {\r\n      return (\r\n        ['jpg', 'png', 'gif'].indexOf(value.split('.').pop().toLowerCase()) !== -1\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      return (\r\n        value.slice(0, 8) === 'https://' || value.slice(0, 7) === 'http://'\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's values\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns Any value\r\n   * @internal\r\n   */\r\n  getValue(record: EntityRecord<object>, column: EntityTableColumn): any {\r\n    const entity = record.entity;\r\n    let value;\r\n    if (column.valueAccessor !== undefined) {\r\n      return column.valueAccessor(entity, record);\r\n    }\r\n    if (this.template.valueAccessor !== undefined) {\r\n      return this.template.valueAccessor(entity, column.name, record);\r\n    }\r\n    value = this.store.getProperty(entity, column.name);\r\n\r\n    if (column.type === 'boolean') {\r\n      if (value === undefined || value === null || value === '') {\r\n        value = false;\r\n      } else if (typeof value !== 'boolean' && value !== undefined) {\r\n        if (typeof value === 'number'){\r\n          value = Boolean(value);\r\n        } else {\r\n          value = JSON.parse(value.toLowerCase());\r\n        }\r\n      }\r\n      if (!this.isEdition(record)){\r\n        value = value ? '&#10003;' : ''; // check mark\r\n      }\r\n    } else if (column.type === 'list' && value && column.domainValues) {\r\n      if (column.multiple) {\r\n        let list_id;\r\n        typeof value === 'string' ? list_id = value.match(/[\\w.-]+/g).map(Number) : list_id = value;\r\n        let list_option = [];\r\n\r\n        column.domainValues.forEach(option => {\r\n          if (list_id.includes(option.id)) {\r\n            if (record.edition) {\r\n              list_option.push(option.id);\r\n            } else {\r\n              list_option.push(option.value);\r\n            }\r\n          }\r\n        });\r\n\r\n        this.isEdition(record) ? value = list_id : value = list_option;\r\n      } else {\r\n        column.domainValues.forEach(option => {\r\n          if (typeof value === 'string' && /^\\d+$/.test(value)) {\r\n            value = parseInt(value);\r\n          }\r\n          if (option.value === value || option.id === value) {\r\n            this.isEdition(record) ? value = option.id : value = option.value;\r\n          }\r\n        });\r\n      }\r\n    } else if (column.type === 'autocomplete' && value && column.domainValues) {\r\n      column.domainValues.forEach(option => {\r\n        if (typeof value === 'string' && /^\\d+$/.test(value)) {\r\n          value = parseInt(value);\r\n        }\r\n        if (option.value === value || option.id === value) {\r\n          value = option.value;\r\n        }\r\n      });\r\n    }\r\n    else if (column.type === 'date') {\r\n      if (this.isEdition(record)) {\r\n        if (value) {\r\n          let date = moment(value);\r\n          value = date.format();\r\n          this.formGroup.controls[column.name].setValue(value);\r\n        }\r\n      } else if (!this.isEdition(record) && value === null) {\r\n        value = \"\";\r\n      }\r\n    }\r\n\r\n    if (value === undefined) {\r\n      value = '';\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's validation values\r\n   * @param column Column\r\n   * @param validationType string\r\n   * @returns Any value (false if no validation or not the one concerned)\r\n   * @internal\r\n   */\r\n  getValidationAttributeValue(column: EntityTableColumn, validationType: string): any {\r\n    if (column.validation !== undefined && column.validation[validationType] !== undefined) {\r\n      return column.validation[validationType];\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public isEdition(record) {\r\n    return record.entity.edition ? true : false;\r\n  }\r\n\r\n  /**\r\n   * Return the type of renderer of a column\r\n   * @param column Column\r\n   * @returns Renderer type\r\n   * @internal\r\n   */\r\n  getColumnRenderer(column: EntityTableColumn): EntityTableColumnRenderer {\r\n    if (column.renderer !== undefined) {\r\n      return column.renderer;\r\n    }\r\n    return EntityTableColumnRenderer.Default;\r\n  }\r\n\r\n  /**\r\n   * Return the table ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getTableClass(): {[key: string]: boolean} {\r\n    return {\r\n      'igo-entity-table-with-selection': this.selection\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Return a header ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getHeaderClass(): {[key: string]: boolean} {\r\n    const func = this.template.headerClassFunc;\r\n    if (func instanceof Function) {\r\n      return func();\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getRowClass(record: EntityRecord<object>): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const func = this.template.rowClassFunc;\r\n    if (func instanceof Function) {\r\n      return func(entity, record);\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getCellClass(record: EntityRecord<object>, column: EntityTableColumn): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const cls = {};\r\n\r\n    const tableFunc = this.template.cellClassFunc;\r\n    if (tableFunc instanceof Function) {\r\n      Object.assign(cls, tableFunc(entity, column, record));\r\n    }\r\n\r\n    const columnFunc = column.cellClassFunc;\r\n    if (columnFunc instanceof Function) {\r\n      Object.assign(cls, columnFunc(entity, record));\r\n    }\r\n\r\n    return cls;\r\n  }\r\n\r\n  /**\r\n   * When a button is clicked\r\n   * @param func Function\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onButtonClick(\r\n    clickFunc: (entity: object, record?: EntityRecord<object>) => void,\r\n    record: EntityRecord<object>\r\n  ) {\r\n    this.enableEdit(record);\r\n    if (typeof clickFunc === 'function') {\r\n      clickFunc(record.entity, record);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve column name without his \"properties\" tag (useful for edition workspace properties)\r\n   */\r\n  public getColumnKeyWithoutPropertiesTag(column: string) {\r\n    if (column.includes('properties.')) {\r\n      return column.split('.')[1];\r\n    }\r\n    return column;\r\n  }\r\n}\r\n","export enum ActionbarMode {\r\n  Dock = 'dock',\r\n  Overlay = 'overlay',\r\n  Context = 'context'\r\n}\r\n","<mat-list-item *ngIf=\"!action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\"\r\n  (click)=\"onClick()\">\r\n  <button *ngIf=\"withIcon\"\r\n    mat-list-avatar\r\n    mat-icon-button\r\n    [color]=\"color\"\r\n    [disabled]=\"disabled$ | async\">\r\n    <mat-icon *ngIf=\"withIcon\" svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n  <h4 *ngIf=\"withTitle\" matLine>{{title | translate}}</h4>\r\n</mat-list-item>\r\n\r\n<mat-list-item class=\"item-checkbox\" *ngIf=\"action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\">\r\n  <mat-checkbox *ngIf=\"withTitle\"\r\n      (change)=\"action.handler()\"\r\n      [checked]=\"checkCondition$ | async\">\r\n      {{title | translate}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, isObservable } from 'rxjs';\r\n\r\nimport { Action } from '../shared/action.interfaces';\r\n\r\n /**\r\n  * An action button\r\n  */\r\n@Component({\r\n  selector: 'igo-actionbar-item',\r\n  templateUrl: './actionbar-item.component.html',\r\n  styleUrls: ['./actionbar-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarItemComponent implements OnInit, OnDestroy {\r\n\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly checkCondition$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly tooltip$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly noDisplay$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly ngClass$: BehaviorSubject<{[key: string]: boolean}> = new BehaviorSubject({});\r\n\r\n  private ngClass$$: Subscription;\r\n\r\n  private disabled$$: Subscription;\r\n\r\n  private availability$$: Subscription;\r\n\r\n  private icon$$: Subscription;\r\n\r\n  private checkCondition$$: Subscription;\r\n\r\n  private tooltip$$: Subscription;\r\n\r\n  private noDisplay$$: Subscription;\r\n\r\n  private display$$: Subscription;\r\n\r\n  /**\r\n   * Action\r\n   */\r\n  @Input() action: Action;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Whether the action title is displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether the action icon is displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Whether a tooltip should be shown\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether the action is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) { this.disabled$.next(value); }\r\n  get disabled(): boolean { return this.disabled$.value; }\r\n\r\n  /**\r\n   * Whether the action is display or not\r\n   */\r\n  @Input()\r\n  set noDisplay(value: boolean) { this.noDisplay$.next(value); }\r\n  get noDisplay(): boolean { return this.noDisplay$.value; }\r\n\r\n  /**\r\n   * Event emitted when the action button is clicked\r\n   */\r\n  @Output() trigger: EventEmitter<Action> = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return this.action.title; }\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    const args = this.action.args || [];\r\n\r\n    if (this.action.ngClass !== undefined) {\r\n      this.ngClass$$ = this.action.ngClass(...args)\r\n        .subscribe((ngClass: {[key: string]: boolean}) => this.updateNgClass(ngClass));\r\n    }\r\n\r\n    if (isObservable(this.action.icon)) {\r\n      this.icon$$ = this.action.icon\r\n        .subscribe((icon: string) => this.updateIcon(icon));\r\n    } else {\r\n      this.updateIcon(this.action.icon);\r\n    }\r\n\r\n    if (isObservable(this.action.checkCondition)) {\r\n      this.checkCondition$$ = this.action.checkCondition\r\n        .subscribe((checkCondition: boolean) => this.updateCheckCondition(checkCondition));\r\n    } else {\r\n      this.updateCheckCondition(this.action.checkCondition);\r\n    }\r\n\r\n    if (isObservable(this.action.tooltip)) {\r\n      this.tooltip$$ = this.action.tooltip\r\n        .subscribe((tooltip: string) => this.updateTooltip(tooltip));\r\n    } else {\r\n      this.updateTooltip(this.action.tooltip);\r\n    }\r\n\r\n    if (this.action.availability !== undefined) {\r\n      this.availability$$ = this.action.availability(...args)\r\n        .subscribe((available: boolean) => this.disabled = !available);\r\n    }\r\n\r\n    this.disabled$$ = this.disabled$\r\n      .subscribe((disabled: boolean) => this.updateNgClass({'igo-actionbar-item-disabled': disabled}));\r\n\r\n    if (this.action.display !== undefined) {\r\n      this.display$$ = this.action.display(...args)\r\n        .subscribe((display: boolean) => this.noDisplay = !display);\r\n    }\r\n\r\n    this.noDisplay$$ = this.noDisplay$\r\n      .subscribe((noDisplay: boolean) => this.updateNgClass({'igo-actionbar-item-no-display': noDisplay}));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.ngClass$$ !== undefined) {\r\n      this.ngClass$$.unsubscribe();\r\n      this.ngClass$$ = undefined;\r\n    }\r\n\r\n    if (this.availability$$ !== undefined) {\r\n      this.availability$$.unsubscribe();\r\n      this.availability$$ = undefined;\r\n    }\r\n\r\n    if (this.display$$ !== undefined) {\r\n      this.display$$.unsubscribe();\r\n      this.display$$ = undefined;\r\n    }\r\n\r\n    if (this.checkCondition$$ !== undefined) {\r\n      this.checkCondition$$.unsubscribe();\r\n      this.checkCondition$$ = undefined;\r\n    }\r\n\r\n    if (this.icon$$ !== undefined) {\r\n      this.icon$$.unsubscribe();\r\n      this.icon$$ = undefined;\r\n    }\r\n\r\n    if (this.tooltip$$ !== undefined) {\r\n      this.tooltip$$.unsubscribe();\r\n      this.tooltip$$ = undefined;\r\n    }\r\n\r\n    this.disabled$$.unsubscribe();\r\n    this.noDisplay$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When the action button is clicked, emit the 'trigger' event but don't\r\n   * invoke the action handler. This is handled by the parent component.\r\n   * @internal\r\n   */\r\n  onClick() {\r\n    if (this.disabled === true) {\r\n      return;\r\n    }\r\n    this.trigger.emit(this.action);\r\n  }\r\n\r\n  private updateNgClass(ngClass: {[key: string]: boolean}) {\r\n    this.ngClass$.next(Object.assign({}, this.ngClass$.value, ngClass));\r\n  }\r\n\r\n  private updateTooltip(tooltip: string) {\r\n    this.tooltip$.next(tooltip);\r\n  }\r\n\r\n  private updateCheckCondition(checkCondition: boolean) {\r\n    this.checkCondition$.next(checkCondition);\r\n  }\r\n\r\n  private updateIcon(icon: string) {\r\n    this.icon$.next(icon);\r\n  }\r\n}\r\n","<mat-list *ngIf=\"mode === actionbarMode.Dock\">\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionTop && isDesktop\"\r\n      id=\"topChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollUp' | translate\"\r\n        (click)=\"scrollUp()\">\r\n        <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <igo-actionbar-item\r\n      *ngIf=\"withToggleButton\"\r\n      color=\"accent\"\r\n      [withTitle]=\"false\"\r\n      [withIcon]=\"true\"\r\n      [color]=\"color\"\r\n      [disabled]=\"store.view.empty\"\r\n      [action]=\"toggleCollapseAction\"\r\n      (trigger)=\"onTriggerAction(toggleCollapseAction)\">\r\n    </igo-actionbar-item>\r\n\r\n    <ng-template #buttonContent *ngIf=\"!collapsed\" ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n      <igo-actionbar-item\r\n        color=\"accent\"\r\n        [withTitle]=\"withTitle\"\r\n        [withIcon]=\"withIcon\"\r\n        [withTooltip]=\"withTooltip\"\r\n        [color]=\"color\"\r\n        [disabled]=\"store.state.get(action).disabled\"\r\n        [action]=\"action\"\r\n        (trigger)=\"onTriggerAction(action)\">\r\n      </igo-actionbar-item>\r\n    </ng-template>\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionLow && isDesktop\"\r\n      id=\"lowChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollDown' | translate\"\r\n        (click)=\"scrollDown()\">\r\n        <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n</mat-list>\r\n\r\n<div *ngIf=\"mode === actionbarMode.Overlay\">\r\n  <button class=\"buttonOverlay\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.common.actionbar.icon' | translate\"\r\n    [matMenuTriggerFor]=\"actionbarMenu\"\r\n    [disabled]=\"store.view.empty\"\r\n    [color]=\"iconColor\">\r\n    <mat-icon [svgIcon]=\"icon\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #actionbarMenu=\"matMenu\"\r\n    class=\"igo-compact-menu igo-no-min-width-menu\"\r\n    overlapTrigger=\"true\"\r\n    [xPosition]=\"xPosition\"\r\n    [yPosition]=\"yPosition\"\r\n    [class]=\"overlayClass\">\r\n\r\n    <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n        <igo-actionbar-item\r\n          color=\"accent\"\r\n          [withTitle]=\"withTitle\"\r\n          [withIcon]=\"withIcon\"\r\n          [color]=\"color\"\r\n          [action]=\"action\"\r\n          (trigger)=\"onTriggerAction(action)\">\r\n        </igo-actionbar-item>\r\n      </ng-template>\r\n    </mat-list>\r\n  </mat-menu>\r\n</div>\r\n<mat-card *ngIf=\"mode === actionbarMode.Context\" class=\"context-menu-card mat-elevation-z4\">\r\n  <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n          <igo-actionbar-item\r\n            color=\"accent\"\r\n            [withTitle]=\"withTitle\"\r\n            [withIcon]=\"withIcon\"\r\n            [color]=\"color\"\r\n            [action]=\"action\"\r\n            (trigger)=\"onTriggerAction(action)\">\r\n          </igo-actionbar-item>\r\n        <br/>\r\n      </ng-template>\r\n  </mat-list>\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  Input,\r\n  HostBinding,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '../../entity';\r\nimport { Action } from '../shared/action.interfaces';\r\nimport { ActionbarMode } from '../shared/action.enums';\r\nimport { ActionStore } from '../shared/store';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * A list of action buttons.\r\n * This component can be displayed in one of two way: 'dock' or 'overlay'\r\n */\r\n@Component({\r\n  selector: 'igo-actionbar',\r\n  templateUrl: './actionbar.component.html',\r\n  styleUrls: ['./actionbar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarComponent implements OnDestroy, OnChanges {\r\n\r\n  /**\r\n   * Reference to the ActionbarMode enum for use in the template\r\n   * @internal\r\n   */\r\n  actionbarMode = ActionbarMode;\r\n\r\n  /**\r\n   * Whether the actionbar is collapsed (Dock mode)\r\n   * @internal\r\n   */\r\n  collapsed = false;\r\n\r\n  /**\r\n   * Toggle collapse action (Dock)\r\n   * @internal\r\n   */\r\n  toggleCollapseAction = {\r\n    id: 'actionbar_toggle',\r\n    icon: 'dots-vertical',\r\n    handler: () => {\r\n      this.collapsed = !this.collapsed;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Action store watcher\r\n   * @internal\r\n   */\r\n  private watcher: EntityStoreWatcher<Action>;\r\n\r\n  /**\r\n   * Height Condition for scroll button\r\n   */\r\n  heightCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Position Condition for top scroll button\r\n   */\r\n  positionConditionTop$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Position Condition for low scroll button\r\n   */\r\n  positionConditionLow$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Action store\r\n   */\r\n  @Input() store: ActionStore;\r\n\r\n  /**\r\n   * Actionbar mode\r\n   */\r\n  @Input() mode: ActionbarMode = ActionbarMode.Dock;\r\n\r\n  /**\r\n   * Whether a toggle button should be displayed (Dock mode)\r\n   */\r\n  @Input() withToggleButton = false;\r\n\r\n  /**\r\n   * Whether a the actionbar should display buttons horizontally\r\n   */\r\n  @Input() horizontal = false;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Color of the button if action mode === overlay\r\n   */\r\n  @Input() iconColor = 'default';\r\n\r\n  /**\r\n   * Whether action titles are displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether action tooltips are displayed\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether action titles are displayed (condition for scroll button)\r\n   */\r\n  @Input() scrollActive = true;\r\n\r\n  /**\r\n   * Whether action icons are displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Which icon want to be shown\r\n   */\r\n  @Input() icon = 'dots-horizontal';\r\n\r\n  /**\r\n   * Overlay X position\r\n   */\r\n  @Input() xPosition = 'before';\r\n\r\n  /**\r\n   * Overlay Y position\r\n   */\r\n  @Input() yPosition = 'above';\r\n\r\n  /**\r\n   * Class to add to the actionbar overlay\r\n   */\r\n  @Input()\r\n  set overlayClass(value: string) {\r\n    this._overlayClass = value;\r\n  }\r\n  get overlayClass(): string {\r\n    return [this._overlayClass, 'igo-actionbar-overlay'].join(' ');\r\n  }\r\n  private _overlayClass = '';\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-title')\r\n  get withTitleClass() {\r\n    return this.withTitle;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-icon')\r\n  get withIconClass() {\r\n    return this.withIcon;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.horizontal')\r\n  get horizontalClass() {\r\n    return this.horizontal;\r\n  }\r\n\r\n  get heightCondition(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (this.scrollActive === false) {\r\n      if (el.clientHeight < el.scrollHeight) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get positionConditionTop(): boolean {\r\n    if (this.elRef.nativeElement.scrollTop === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get positionConditionLow(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (el.scrollTop >= (el.scrollHeight - el.clientHeight)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isDesktop(): boolean {\r\n    return this.mediaService.getMedia() === Media.Desktop;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef,\r\n    public mediaService: MediaService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      if (this.watcher !== undefined) {\r\n        this.watcher.destroy();\r\n      }\r\n      this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * Invoke the action handler\r\n   * @internal\r\n   */\r\n  onTriggerAction(action: Action) {\r\n    const args = action.args || [];\r\n    action.handler(...args);\r\n  }\r\n\r\n  scrollDown() {\r\n    this.elRef.nativeElement.scrollBy(0, 52);\r\n  }\r\n\r\n  scrollUp() {\r\n    this.elRef.nativeElement.scrollBy(0, -52);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ActionbarComponent } from './actionbar.component';\r\nimport { ActionbarItemComponent } from './actionbar-item.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatMenuModule,\r\n    MatListModule,\r\n    MatCardModule,\r\n    MatCheckboxModule\r\n  ],\r\n  exports: [ActionbarComponent],\r\n  declarations: [ActionbarComponent, ActionbarItemComponent]\r\n})\r\nexport class IgoActionbarModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionbarModule } from './actionbar/actionbar.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    IgoActionbarModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoActionModule {}\r\n","import { Directive, Input, ElementRef, OnInit } from '@angular/core';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\n\r\n/**\r\n * This directive allow to add an icon inside a matBadge.\r\n * A value must be set into the matBadge directive ex: matBadge=\"icon\".\r\n * The badge content will be overrided by this current directive.\r\n */\r\n@Directive({\r\n  selector: '[igoMatBadgeIcon]'\r\n})\r\nexport class IgoBadgeIconDirective implements OnInit {\r\n  @Input()\r\n  set igoMatBadgeIcon(value: string) {\r\n    this.matIconRegistry.getNamedSvgIcon(value).subscribe((svgObj) => {\r\n      this.svg = svgObj;\r\n      this.updateSvg();\r\n    });\r\n  }\r\n  private svg: SVGElement;\r\n\r\n  @Input()\r\n  set matBadgeHidden(value: boolean) {\r\n    this.hidden = value;\r\n    this.updateHidden();\r\n  }\r\n  private hidden = false;\r\n\r\n  @Input()\r\n  set matBadgeDisabled(value: boolean) {\r\n    this.disabled = value;\r\n    this.updateDisabled();\r\n  }\r\n  private disabled = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInverseColor(value: boolean) {\r\n    this.inverseColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inverseColor = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInheritColor(value: boolean) {\r\n    this.inheritColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inheritColor = false;\r\n\r\n  get badge() {\r\n    return this.el.nativeElement.querySelector('.mat-badge-content');\r\n  }\r\n\r\n  private originalColor: string;\r\n\r\n  constructor(\r\n    private el: ElementRef,\r\n    private matIconRegistry: MatIconRegistry\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.badge.style.alignItems = 'center';\r\n    this.badge.style.justifyContent = 'center';\r\n\r\n    this.updateHidden();\r\n    this.updateColor();\r\n    this.updateSvg();\r\n  }\r\n\r\n  private updateSvg() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.innerHTML = '';\r\n    if (this.svg) {\r\n      this.badge.appendChild(this.svg);\r\n    }\r\n  }\r\n  private updateColor() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n\r\n    if (this.inheritColor) {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = 'currentColor';\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = 'currentColor';\r\n      }\r\n    } else {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = window\r\n          .getComputedStyle(this.badge, null)\r\n          .getPropertyValue('background-color');\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = '';\r\n      }\r\n    }\r\n    this.originalColor = this.badge.style.color;\r\n    this.updateDisabled();\r\n  }\r\n\r\n  private updateHidden() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.style.display = this.hidden ? 'none' : 'flex';\r\n  }\r\n\r\n  private updateDisabled() {\r\n    if (!this.badge || !this.inverseColor) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      this.originalColor = this.badge.style.color;\r\n      this.badge.style.color = '#b9b9b9';\r\n    } else {\r\n      this.badge.style.color = this.originalColor;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { IgoBadgeIconDirective } from './badge-icon.directive';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\n@NgModule({\r\n  imports: [MatBadgeModule, MatIconModule],\r\n  declarations: [IgoBadgeIconDirective],\r\n  exports: [MatBadgeModule, IgoBadgeIconDirective]\r\n})\r\nexport class IgoMatBadgeIconModule {\r\n  static forRoot(): ModuleWithProviders<IgoMatBadgeIconModule> {\r\n    return {\r\n      ngModule: IgoMatBadgeIconModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Output\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoClickout]'\r\n})\r\nexport class ClickoutDirective {\r\n  @Output() clickout = new EventEmitter<MouseEvent>();\r\n\r\n  @HostListener('document:click', ['$event', '$event.target'])\r\n  handleMouseClick(event: MouseEvent, target: HTMLElement) {\r\n    if (!target) {\r\n      return;\r\n    }\r\n\r\n    if (!this.el.nativeElement.contains(target)) {\r\n      this.clickout.emit(event);\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ClickoutDirective } from './clickout.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ClickoutDirective],\r\n  exports: [ClickoutDirective]\r\n})\r\nexport class IgoClickoutModule {\r\n  static forRoot(): ModuleWithProviders<IgoClickoutModule> {\r\n    return {\r\n      ngModule: IgoClickoutModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  HostListener,\r\n  ElementRef,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoCollapse]'\r\n})\r\nexport class CollapseDirective {\r\n  @Input()\r\n  get target() {\r\n    return this._target;\r\n  }\r\n  set target(value: Element) {\r\n    this._target = value;\r\n  }\r\n  private _target: Element;\r\n\r\n  @Input()\r\n  get collapsed(): boolean {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(collapsed: boolean) {\r\n    collapsed ? this.collapseTarget() : this.expandTarget();\r\n    this._collapsed = collapsed;\r\n    this.toggle.emit(collapsed);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n\r\n  @HostListener('click')\r\n  click() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  private collapseTarget() {\r\n    this.renderer.addClass(this.target, 'igo-collapsed');\r\n    this.renderer.addClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n\r\n  private expandTarget() {\r\n    this.renderer.removeClass(this.target, 'igo-collapsed');\r\n    this.renderer.removeClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n}\r\n","import { Component, Input, Output, EventEmitter } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-collapsible',\r\n  templateUrl: './collapsible.component.html',\r\n  styleUrls: ['./collapsible.component.scss']\r\n})\r\nexport class CollapsibleComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title = '';\r\n\r\n  @Input()\r\n  get collapsed() {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(value: boolean) {\r\n    this._collapsed = value;\r\n    this.toggle.emit(value);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    svgIcon=\"chevron-up\" \r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"content\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"collapsed = $event\">\r\n  </mat-icon>\r\n  <h4 matLine>{{title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #content>\r\n  <ng-content></ng-content>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { CollapseDirective } from './collapse.directive';\r\nimport { CollapsibleComponent } from './collapsible.component';\r\n\r\n@NgModule({\r\n  imports: [MatIconModule, MatListModule],\r\n  declarations: [CollapsibleComponent, CollapseDirective],\r\n  exports: [CollapsibleComponent, CollapseDirective]\r\n})\r\nexport class IgoCollapsibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoCollapsibleModule> {\r\n    return {\r\n      ngModule: IgoCollapsibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-confirm-dialog',\r\n  templateUrl: './confirm-dialog.component.html',\r\n  styleUrls: ['./confirm-dialog.component.scss']\r\n})\r\nexport class ConfirmDialogComponent {\r\n  public confirmMessage: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<ConfirmDialogComponent>) {}\r\n}\r\n","<h2 mat-dialog-title class=\"mat-typography\">{{'igo.common.confirmDialog.title' | translate}}</h2>\r\n<div mat-dialog-content class=\"mat-typography\">{{confirmMessage}}</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\" (click)=\"dialogRef.close(true)\">{{'igo.common.confirmDialog.confirmBtn' | translate}}</button>\r\n  <button mat-button (click)=\"dialogRef.close(false)\">{{'igo.common.confirmDialog.cancelBtn' | translate}}</button>\r\n</div>\r\n","import { Injectable } from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\n\r\n@Injectable()\r\nexport class ConfirmDialogService {\r\n  constructor(private dialog: MatDialog) {}\r\n\r\n  public open(message: string): Observable<any> {\r\n    const dialogRef = this.dialog.open(ConfirmDialogComponent, {\r\n      disableClose: false\r\n    });\r\n    dialogRef.componentInstance.confirmMessage = message;\r\n\r\n    return dialogRef.afterClosed();\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\nimport { ConfirmDialogService } from './confirm-dialog.service';\r\n\r\n@NgModule({\r\n  imports: [MatButtonModule, MatDialogModule, IgoLanguageModule],\r\n  declarations: [ConfirmDialogComponent],\r\n  exports: [ConfirmDialogComponent],\r\n  providers: [ConfirmDialogService]\r\n})\r\nexport class IgoConfirmDialogModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfirmDialogModule> {\r\n    return {\r\n      ngModule: IgoConfirmDialogModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Input,\r\n  Output,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { TemplatePortal } from '@angular/cdk/portal';\r\nimport { fromEvent, Subscription } from 'rxjs';\r\nimport { filter, take } from 'rxjs/operators';\r\nimport { Overlay, OverlayRef } from '@angular/cdk/overlay';\r\n\r\n@Directive({\r\n  selector: '[igoContextMenu]'\r\n})\r\nexport class ContextMenuDirective {\r\n  private overlayRef: OverlayRef | null;\r\n  private sub: Subscription;\r\n\r\n  @Input('igoContextMenu') menuContext: TemplateRef<any>;\r\n  @Output() menuPosition = new EventEmitter<{ x: number; y: number }>();\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    public viewContainerRef: ViewContainerRef,\r\n    private elementRef: ElementRef\r\n  ) {}\r\n\r\n  @HostListener('contextmenu', ['$event'])\r\n  public onContextMenu(e: MouseEvent): void {\r\n    const {x, y} = e;\r\n    this.close();\r\n    e.preventDefault();\r\n    this.menuPosition.emit({ x, y });\r\n    this.overlayRef = null;\r\n    const positionStrategy = this.overlay\r\n      .position()\r\n      .flexibleConnectedTo({ x, y })\r\n      .withPositions([\r\n        {\r\n          originX: 'end',\r\n          originY: 'bottom',\r\n          overlayX: 'start',\r\n          overlayY: 'top'\r\n        }\r\n      ]);\r\n    this.overlayRef = this.overlay.create({\r\n      positionStrategy,\r\n      scrollStrategy: this.overlay.scrollStrategies.close()\r\n    });\r\n    this.overlayRef.attach(\r\n      new TemplatePortal(this.menuContext, this.viewContainerRef, {\r\n        $implicit: undefined\r\n      })\r\n    );\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'click')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          this.close();\r\n          return (\r\n            !!this.overlayRef &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          );\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'contextmenu')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          if (\r\n            clickTarget &&\r\n            !this.elementRef.nativeElement.contains(clickTarget) &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          ) {\r\n            return true;\r\n          } else {\r\n            event.preventDefault();\r\n          }\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n  }\r\n\r\n  close() {\r\n    if (this.overlayRef) {\r\n      this.overlayRef.dispose();\r\n      this.overlayRef = null;\r\n    }\r\n    if (this.sub) {\r\n      this.sub.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ContextMenuDirective } from './context-menu.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ContextMenuDirective],\r\n  exports: [ContextMenuDirective]\r\n})\r\nexport class IgoContextMenuModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMenuModule> {\r\n    return {\r\n      ngModule: IgoContextMenuModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { CustomHtmlComponent } from './custom-html.component';\r\nimport { SanitizeHtmlPipe } from './custom-html.pipe';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SanitizeHtmlPipe, CustomHtmlComponent],\r\n  declarations: [SanitizeHtmlPipe, CustomHtmlComponent]\r\n})\r\nexport class IgoCustomHtmlModule {\r\n  static forRoot(): ModuleWithProviders<IgoCustomHtmlModule> {\r\n    return {\r\n      ngModule: IgoCustomHtmlModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { DragAndDropDirective } from './drag-drop.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [DragAndDropDirective],\r\n  exports: [DragAndDropDirective]\r\n})\r\nexport class IgoDrapDropModule {\r\n  static forRoot(): ModuleWithProviders<IgoDrapDropModule> {\r\n    return {\r\n      ngModule: IgoDrapDropModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  ComponentFactory,\r\n  ComponentRef,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\n\r\nimport { Observable, Subscription } from 'rxjs';\r\n\r\n/**\r\n * This class is used in the DynamicComponentOutlet component. It holds\r\n * a reference to a component factory and can render that component\r\n * in a target element on demand. It's also possible to set inputs\r\n * and to subscribe to outputs.\r\n */\r\nexport class DynamicComponent<C> {\r\n\r\n  /**\r\n   * Component reference\r\n   */\r\n  private componentRef: ComponentRef<C>;\r\n\r\n  /**\r\n   * Subscriptions to the component's outputs. Those need\r\n   * to be unsubscribed when the component is destroyed.\r\n   */\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  /**\r\n   * Component target element\r\n   */\r\n  private target: ViewContainerRef;\r\n\r\n  /**\r\n   * Component inputs\r\n   */\r\n  private inputs: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Subscriptions to the component's async inputs\r\n   */\r\n  private inputs$$: {[key: string]: Subscription} = {};\r\n\r\n  /**\r\n   * Subscribers to the component's outputs\r\n   */\r\n  private subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  constructor(private componentFactory: ComponentFactory<C>) {}\r\n\r\n  /**\r\n   * Render the component to a target element.\r\n   * Set it's inputs and subscribe to it's outputs.\r\n   * @param target Target element\r\n   */\r\n  setTarget(target: ViewContainerRef) {\r\n    this.target = target;\r\n    this.componentRef = target.createComponent(this.componentFactory);\r\n    this.updateInputs(this.inputs);\r\n    this.updateSubscribers(this.subscribers);\r\n  }\r\n\r\n  /**\r\n   * Destroy this component. That means, removing from it's target\r\n   * element and unsubscribing to it's outputs.\r\n   */\r\n  destroy() {\r\n    if (this.target !== undefined) {\r\n      this.target.clear();\r\n    }\r\n    if (this.componentRef !== undefined) {\r\n      this.componentRef.destroy();\r\n      this.componentRef = undefined;\r\n    }\r\n    this.unobserveAllInputs();\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  /**\r\n   * Update the component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateInputs(inputs: {[key: string]: any}) {\r\n    this.inputs = inputs;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedInputs = this.componentFactory.inputs;\r\n    allowedInputs.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n\r\n      this.unobserveInput(key);\r\n\r\n      const inputValue = inputs[key];\r\n      if (inputs.hasOwnProperty(key)) {\r\n        if (inputValue instanceof Observable) {\r\n          this.observeInput(key, inputValue);\r\n        } else {\r\n          this.setInputValue(instance, key, inputValue);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (typeof (instance as any).onUpdateInputs === 'function') {\r\n      (instance as any).onUpdateInputs();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set an instance's input value\r\n   * @param instance Component instance\r\n   * @param key Input key\r\n   * @param value Input value\r\n   */\r\n  private setInputValue(instance: C, key: string, value: any) {\r\n    const currentValue = instance[key];\r\n    if (value === currentValue) {\r\n      return;\r\n    }\r\n\r\n    const prototype = Object.getPrototypeOf(instance);\r\n    const descriptor = Object.getOwnPropertyDescriptor(prototype, key);\r\n    if (descriptor !== undefined && descriptor.set !== undefined) {\r\n      descriptor.set.call(instance, value);\r\n    } else {\r\n      instance[key] = value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateSubscribers(subscribers: {[key: string]: (event: any) => void}) {\r\n    this.subscribers = subscribers;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedSubscribers = this.componentFactory.outputs;\r\n    allowedSubscribers.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n      if (subscribers.hasOwnProperty(key)) {\r\n        const emitter = instance[key];\r\n        const subscriber = subscribers[key];\r\n        if (Array.isArray(subscriber)) {\r\n          subscriber.forEach((_subscriber) => {\r\n            this.subscriptions.push(emitter.subscribe(_subscriber));\r\n          });\r\n        } else {\r\n          this.subscriptions.push(emitter.subscribe(subscriber));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an observable input and update the component's input value\r\n   * accordingly\r\n   * @param key Input key\r\n   * @param observable Observable\r\n   */\r\n  private observeInput(key: string, observable: Observable<any>) {\r\n    this.inputs$$[key] = observable.subscribe((value: any) => {\r\n      const instance = this.componentRef.instance;\r\n      this.setInputValue(instance, key, value);\r\n\r\n      if (typeof (instance as any).onUpdateInputs === 'function') {\r\n        (instance as any).onUpdateInputs();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to an observable input\r\n   * @param key Input key\r\n   */\r\n  private unobserveInput(key: string) {\r\n    if (this.inputs$$[key] !== undefined) {\r\n      this.inputs$$[key].unsubscribe();\r\n      this.inputs$$[key] = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unobserveAllInputs() {\r\n    Object.values(this.inputs$$).forEach((s: Subscription | undefined) => {\r\n      if (s !== undefined) {\r\n        s.unsubscribe();\r\n      }\r\n    });\r\n    this.inputs$$ = {};\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unsubscribeAll() {\r\n    this.subscriptions.forEach((s: Subscription) => s.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n}\r\n","import {\r\n  ComponentFactoryResolver,\r\n  Injectable\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from './dynamic-component';\r\n\r\n/**\r\n * Service to creates DynamicComponent instances from base component classes\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DynamicComponentService {\r\n\r\n  constructor(private resolver: ComponentFactoryResolver) {}\r\n\r\n  /**\r\n   * Creates a DynamicComponent instance from a base component class\r\n   * @param componentCls The component class\r\n   * @returns DynamicComponent instance\r\n   */\r\n  create(componentCls: any): DynamicComponent<any> {\r\n    const factory = this.resolver.resolveComponentFactory(componentCls as any);\r\n    return new DynamicComponent<typeof componentCls>(factory);\r\n  }\r\n}\r\n","import {\r\n  Input,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  Component,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ViewContainerRef,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { DynamicComponent } from '../shared/dynamic-component';\r\nimport { DynamicComponentService } from '../shared/dynamic-component.service';\r\n\r\n@Component({\r\n  selector: 'igo-dynamic-outlet',\r\n  templateUrl: 'dynamic-outlet.component.html',\r\n  styleUrls: ['dynamic-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DynamicOutletComponent implements OnChanges, OnDestroy {\r\n  /**\r\n   * The dynamic component base class or the dynamic component itself\r\n   */\r\n  @Input() component: DynamicComponent<any> | any;\r\n\r\n  /**\r\n   * The dynamic component inputs\r\n   */\r\n  @Input() inputs: { [key: string]: any } = {};\r\n\r\n  /**\r\n   * The subscribers to the dynamic component outputs\r\n   */\r\n  @Input() subscribers: { [key: string]: (event: any) => void } = {};\r\n\r\n  /**\r\n   * The dynamic component\r\n   */\r\n  private dynamicComponent: DynamicComponent<any>;\r\n\r\n  /**\r\n   * The view element to render the component to\r\n   * @ignore\r\n   */\r\n  @ViewChild('target', { read: ViewContainerRef, static: true })\r\n  private target: ViewContainerRef;\r\n\r\n  constructor(\r\n    private dynamicComponentService: DynamicComponentService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * If the dynamic component changes, create it.\r\n   * If the inputs or subscribers change, update the current component's\r\n   * inputs or subscribers.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const component = changes.component;\r\n    const inputs = changes.inputs;\r\n    const subscribers = changes.subscribers;\r\n    const eq = ObjectUtils.objectsAreEquivalent;\r\n\r\n    if (!component || !component.currentValue) {\r\n      return;\r\n    }\r\n\r\n    if (component.currentValue !== component.previousValue) {\r\n      this.createComponent(component.currentValue);\r\n    } else {\r\n      const inputsAreEquivalents =\r\n        inputs && eq(inputs.currentValue || {}, inputs.previousValue || {});\r\n      const subscribersAreEquivalents =\r\n        subscribers &&\r\n        eq(subscribers.currentValue || {}, subscribers.previousValue || {});\r\n\r\n      if (inputsAreEquivalents === false) {\r\n        this.updateInputs();\r\n      }\r\n\r\n      if (subscribersAreEquivalents === false) {\r\n        this.updateSubscribers();\r\n      }\r\n    }\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Destroy the dynamic component and all it's subscribers\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.dynamicComponent) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a  DynamicComponent out of the component class and render it.\r\n   * @internal\r\n   */\r\n  private createComponent(component: DynamicComponent<any> | any) {\r\n    if (this.dynamicComponent !== undefined) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n    this.dynamicComponent =\r\n      component instanceof DynamicComponent\r\n        ? component\r\n        : this.dynamicComponentService.create(component);\r\n    this.renderComponent();\r\n  }\r\n\r\n  /**\r\n   * Create and render the dynamic component. Set it's inputs and subscribers\r\n   * @internal\r\n   */\r\n  private renderComponent() {\r\n    this.updateInputs();\r\n    this.updateSubscribers();\r\n    this.dynamicComponent.setTarget(this.target);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateInputs() {\r\n    this.dynamicComponent.updateInputs(this.inputs);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateSubscribers() {\r\n    this.dynamicComponent.updateSubscribers(this.subscribers);\r\n  }\r\n}\r\n","<ng-template #target></ng-template>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { DynamicOutletComponent } from './dynamic-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    DynamicOutletComponent\r\n  ],\r\n  declarations: [\r\n    DynamicOutletComponent\r\n  ]\r\n})\r\nexport class IgoDynamicOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoDynamicOutletModule } from './dynamic-outlet/dynamic-outlet.module';\r\nimport { DynamicComponentService } from './shared/dynamic-component.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    IgoDynamicOutletModule\r\n  ],\r\n  providers: [\r\n    DynamicComponentService\r\n  ]\r\n})\r\nexport class IgoDynamicComponentModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FlexibleComponent } from './flexible.component';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [FlexibleComponent],\r\n  exports: [FlexibleComponent]\r\n})\r\nexport class IgoFlexibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoFlexibleModule> {\r\n    return {\r\n      ngModule: IgoFlexibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ChangeDetectionStrategy,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport t from 'typy';\r\n\r\nimport { Form, FormField, FormFieldGroup } from '../shared/form.interfaces';\r\nimport { getAllFormFields } from '../shared/form.utils';\r\n\r\n/**\r\n * A configurable form\r\n */\r\n@Component({\r\n  selector: 'igo-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormComponent implements OnChanges {\r\n\r\n  /**\r\n   * Form\r\n   */\r\n  @Input() form: Form;\r\n\r\n  /**\r\n   * Input data\r\n   */\r\n  @Input() formData: { [key: string]: any};\r\n\r\n  /**\r\n   * Form autocomplete\r\n   */\r\n  @Input() autocomplete: string = 'off';\r\n\r\n  /**\r\n   * Event emitted when the form is submitted\r\n   */\r\n  @Output() submitForm = new EventEmitter<{[key: string]: any}>();\r\n\r\n  @ViewChild('buttons', { static: true }) buttons: ElementRef;\r\n\r\n  get hasButtons(): boolean {\r\n    return this.buttons.nativeElement.children.length !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Is the entity or the template change, recreate the form or repopulate it.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const formData = changes.formData;\r\n    if (formData && formData.currentValue !== formData.previousValue) {\r\n      if (formData.currentValue === undefined) {\r\n        this.clear();\r\n      } else {\r\n        this.setData(formData.currentValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform the form data to a feature and emit an event\r\n   * @param event Form submit event\r\n   * @internal\r\n   */\r\n  onSubmit() {\r\n    this.submitForm.emit(this.getData());\r\n  }\r\n\r\n  getData(): { [key: string]: any} {\r\n    const data = {};\r\n    getAllFormFields(this.form).forEach((field: FormField) => {\r\n      this.updateDataWithFormField(data, field);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  private setData(data: {[key: string]: any}) {\r\n    this.form.fields.forEach((field: FormField) => {\r\n      field.control.setValue(t(data, field.name).safeObject);\r\n    });\r\n\r\n    this.form.groups.forEach((group: FormFieldGroup) => {\r\n      group.fields.forEach((field: FormField) => {\r\n        field.control.setValue(t(data, field.name).safeObject);\r\n      });\r\n    });\r\n  }\r\n\r\n  private updateDataWithFormField(data: { [key: string]: any}, field: FormField) {\r\n    const control = field.control;\r\n    if (!control.disabled) {\r\n      data[field.name] = control.value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear form\r\n   */\r\n  private clear() {\r\n    this.form.control.reset();\r\n  }\r\n\r\n}\r\n","import { AbstractControl } from '@angular/forms';\r\n\r\nimport { Form, FormField, FormFieldGroup } from './form.interfaces';\r\n\r\nexport function formControlIsRequired(control: AbstractControl): boolean {\r\n  if (control.validator) {\r\n    const validator = control.validator({} as AbstractControl);\r\n    if (validator && validator.required) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  if ((control as any).controls) {\r\n    const requiredControl = Object.keys((control as any).controls).find((key: string) => {\r\n      return formControlIsRequired((control as any).controls[key]);\r\n    });\r\n    return requiredControl !== undefined;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function getDefaultErrorMessages(): {[key: string]: string} {\r\n  return {\r\n    required: 'igo.common.form.errors.required'\r\n  };\r\n}\r\n\r\nexport function getControlErrorMessage(control: AbstractControl, messages: {[key: string]: string}): string {\r\n  const errors = control.errors || {};\r\n  const errorKeys = Object.keys(errors);\r\n  const errorMessages = errorKeys\r\n    .map((key: string) => messages[key])\r\n    .filter((message: string) => message !== undefined);\r\n  return errorMessages.length > 0 ? errorMessages[0] : '';\r\n}\r\n\r\nexport function getAllFormFields(form: Form): FormField[] {\r\n  return form.groups.reduce((acc: FormField[], group: FormFieldGroup) => {\r\n    return acc.concat(group.fields);\r\n  }, [].concat(form.fields));\r\n}\r\n\r\nexport function getFormFieldByName(form: Form, name: string): FormField {\r\n  const fields = getAllFormFields(form);\r\n  return fields.find((field: FormField) => {\r\n    return field.name === name;\r\n  });\r\n}\r\n","\r\n<form\r\n  [autocomplete]=\"autocomplete\"\r\n  [formGroup]=\"form.control\"\r\n  (ngSubmit)=\"onSubmit()\">\r\n  <div class=\"igo-form-body\" [ngClass]=\"{'igo-form-body-with-buttons': hasButtons}\">\r\n    <div class=\"igo-form-content\">\r\n      <ng-content></ng-content>\r\n    </div>\r\n    <div #buttons class=\"igo-form-buttons\">\r\n      <ng-content select=\"[formButtons]\"></ng-content>\r\n    </div>\r\n  </div>\r\n</form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { FormComponent } from './form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  exports: [\r\n    FormComponent,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  declarations: [\r\n    FormComponent\r\n  ]\r\n})\r\nexport class IgoFormFormModule {}\r\n","import { Injectable } from '@angular/core';\r\nimport { FormBuilder, Validators, ValidatorFn } from '@angular/forms';\r\n\r\nimport {\r\n  Form,\r\n  FormField,\r\n  FormFieldConfig,\r\n  FormFieldGroup,\r\n  FormFieldGroupConfig\r\n} from './form.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormService {\r\n\r\n  constructor(private formBuilder: FormBuilder) {}\r\n\r\n  form(fields: FormField[], groups: FormFieldGroup[]): Form {\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n    groups.forEach((group: FormFieldGroup) => {\r\n      control.addControl(group.name, group.control);\r\n    });\r\n\r\n    return {fields, groups, control};\r\n  }\r\n\r\n  group(config: FormFieldGroupConfig, fields: FormField[]): FormFieldGroup {\r\n    const options = config.options || {};\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({}, config, {fields, control}) as FormFieldGroup;\r\n  }\r\n\r\n  field(config: FormFieldConfig): FormField {\r\n    const options = config.options || {};\r\n    const state = {\r\n      value: '',\r\n      disabled: options.disabled\r\n    };\r\n    const control = this.formBuilder.control(state);\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({type: 'text'}, config, {control}) as FormField;\r\n  }\r\n\r\n  extendFieldConfig(config: FormFieldConfig, partial: Partial<FormFieldConfig>): FormFieldConfig {\r\n    const options = Object.assign({}, config.options || {}, partial.options || {});\r\n    const inputs = Object.assign({}, config.inputs || {}, partial.inputs || {});\r\n    const subscribers = Object.assign({}, config.subscribers || {}, partial.subscribers || {});\r\n    return Object.assign({}, config, {options, inputs, subscribers});\r\n  }\r\n\r\n  private getValidators(validatorOption: string | string[] | ValidatorFn): ValidatorFn | ValidatorFn[] {\r\n    if (Array.isArray(validatorOption)) {\r\n      return validatorOption.map((validatorStr) => {\r\n        return this.getValidator(validatorStr);\r\n      });\r\n    }\r\n\r\n    return this.getValidator(validatorOption);\r\n  }\r\n\r\n  private getValidator(validatorStr: string | ValidatorFn): ValidatorFn {\r\n    if (typeof validatorStr !== 'string') {\r\n      return validatorStr;\r\n    }\r\n\r\n    // regex pattern to extract arguments from string for e.g applying on \"minLength(8)\" would extract 8\r\n    const re = /^([a-zA-Z]{3,15})\\((.{0,20})\\)$/;\r\n    const match = validatorStr.match(re);\r\n\r\n    if (!match) {\r\n      return Validators[validatorStr];\r\n    }\r\n\r\n    const name = match[1];\r\n    const args = match[2];\r\n    return Validators[name](args);\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n/**\r\n * Service where all available form fields are registered.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormFieldService {\r\n\r\n  static fields: {[key: string]: any} = {};\r\n\r\n  static register(type: string, component: any) {\r\n    FormFieldService.fields[type] = component;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return field component by type\r\n   * @param type Field type\r\n   * @returns Field component\r\n   */\r\n  getFieldByType(type: string): any {\r\n    return FormFieldService.fields[type];\r\n  }\r\n\r\n}\r\n","\r\n\r\n<ng-container *ngIf=\"field !== undefined\">\r\n  <igo-dynamic-outlet\r\n    [component]=\"getFieldComponent()\"\r\n    [inputs]=\"getFieldInputs()\"\r\n    [subscribers]=\"getFieldSubscribers()\">\r\n  </igo-dynamic-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { FormField, FormFieldInputs, FormFieldOptions } from '../shared/form.interfaces';\r\nimport { FormFieldService } from '../shared/form-field.service';\r\nimport { getDefaultErrorMessages } from '../shared';\r\n\r\n/**\r\n * This component renders the proper form input based on\r\n * the field configuration it receives.\r\n */\r\n@Component({\r\n  selector: 'igo-form-field',\r\n  templateUrl: './form-field.component.html',\r\n  styleUrls: ['./form-field.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormFieldComponent {\r\n\r\n  /**\r\n   * Field configuration\r\n   */\r\n  @Input() field: FormField;\r\n\r\n  /**\r\n   * Field inputs cache\r\n   */\r\n  private fieldInputs: FormFieldInputs = undefined;\r\n\r\n  /**\r\n   * Field subscribers cache\r\n   */\r\n  private fieldSubscribers: {[key: string]: ({field: FormField, control: FormControl}) => void } = undefined;\r\n\r\n  get fieldOptions(): FormFieldOptions {\r\n    return this.field.options || {};\r\n  }\r\n\r\n  constructor(private formFieldService: FormFieldService) {}\r\n\r\n  getFieldComponent(): any {\r\n    return this.formFieldService.getFieldByType(this.field.type || 'text');\r\n  }\r\n\r\n  getFieldInputs(): FormFieldInputs {\r\n    if (this.fieldInputs !== undefined) {\r\n      return this.fieldInputs;\r\n    }\r\n\r\n    const errors = this.fieldOptions.errors || {};\r\n    this.fieldInputs = Object.assign(\r\n      {\r\n        placeholder: this.field.title,\r\n        disableSwitch: this.fieldOptions.disableSwitch || false\r\n      },\r\n      Object.assign({}, this.field.inputs || {}),\r\n      {\r\n        formControl: this.field.control,\r\n        errors: Object.assign({}, getDefaultErrorMessages(), errors)\r\n      }\r\n    );\r\n    return this.fieldInputs;\r\n  }\r\n\r\n  getFieldSubscribers(): {[key: string]: ({field: FormField, control: FormControl}) => void } {\r\n    if (this.fieldSubscribers !== undefined) {\r\n      return this.fieldSubscribers;\r\n    }\r\n\r\n    this.fieldSubscribers = Object.assign({}, this.field.subscribers || {});\r\n    return this.fieldSubscribers;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoDynamicOutletModule } from '../../dynamic-component/dynamic-outlet/dynamic-outlet.module';\r\n\r\nimport { FormFieldComponent } from './form-field.component';\r\nimport { FormFieldSelectComponent } from './form-field-select.component';\r\nimport { FormFieldTextComponent } from './form-field-text.component';\r\nimport { FormFieldTextareaComponent } from './form-field-textarea.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    IgoLanguageModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ],\r\n  declarations: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ]\r\n})\r\nexport class IgoFormFieldModule {}\r\n","<div\r\n  *ngIf=\"group && group.fields.length > 0\"\r\n  class=\"igo-form-group-fields\">\r\n  <div\r\n    *ngFor=\"let field of group.fields\"\r\n    class=\"igo-form-field-wrapper\"\r\n    [ngClass]=\"getFieldNgClass(field)\">\r\n    <igo-form-field [field]=\"field\"></igo-form-field>\r\n  </div>\r\n</div>\r\n\r\n<div class=\"igo-form-group-extra-content\">\r\n  <ng-content></ng-content>\r\n</div>\r\n\r\n<mat-error *ngIf=\"formControl.errors\">{{getErrorMessage() | translate}}</mat-error>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { FormGroup } from '@angular/forms';\r\n\r\nimport { getControlErrorMessage } from '../shared/form.utils';\r\nimport { FormField, FormFieldGroup } from '../shared/form.interfaces';\r\n\r\n/**\r\n * A configurable form, optionnally bound to an entity\r\n * (for example in case of un update). Submitting that form\r\n * emits an event with the form data but no other operation is performed.\r\n */\r\n@Component({\r\n  selector: 'igo-form-group',\r\n  templateUrl: './form-group.component.html',\r\n  styleUrls: ['./form-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormGroupComponent {\r\n\r\n  /**\r\n   * Form field group\r\n   */\r\n  @Input() group: FormFieldGroup;\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() errors: {[key: string]: string};\r\n\r\n  /**\r\n   * Form group control\r\n   */\r\n  get formControl(): FormGroup { return this.group.control; }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldColSpan(field: FormField): number {\r\n    let colSpan = 2;\r\n    const options = field.options || {};\r\n    if (options.cols && options.cols > 0) {\r\n      colSpan = Math.min(options.cols, 2);\r\n    }\r\n\r\n    return colSpan;\r\n  }\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldNgClass(field: FormField): {[key: string]: boolean} {\r\n    const colspan = this.getFieldColSpan(field);\r\n    return {[`igo-form-field-colspan-${colspan}`]: true};\r\n  }\r\n\r\n  /**\r\n   * Get error message\r\n   */\r\n  getErrorMessage(): string {\r\n    const options = this.group.options || {};\r\n    return getControlErrorMessage(this.formControl, options.errors || {});\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFormFieldModule } from '../form-field/form-field.module';\r\nimport { FormGroupComponent } from './form-group.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatFormFieldModule,\r\n    IgoLanguageModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    FormGroupComponent\r\n  ],\r\n  declarations: [\r\n    FormGroupComponent\r\n  ]\r\n})\r\nexport class IgoFormGroupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormFormModule } from './form/form.module';\r\nimport { IgoFormGroupModule } from './form-group/form-group.module';\r\nimport { IgoFormFieldModule } from './form-field/form-field.module';\r\nimport { FormService } from './shared/form.service';\r\nimport { FormFieldService } from './shared/form-field.service';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoFormFormModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    FormService,\r\n    FormFieldService\r\n  ]\r\n})\r\nexport class IgoFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { EntitySelectorComponent } from './entity-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatSelectModule\r\n  ],\r\n  exports: [EntitySelectorComponent],\r\n  declarations: [EntitySelectorComponent]\r\n})\r\nexport class IgoEntitySelectorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { StopDropPropagationDirective } from './stop-drop-propagation.directive';\r\nimport { StopPropagationDirective } from './stop-propagation.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [StopDropPropagationDirective, StopPropagationDirective],\r\n  exports: [StopDropPropagationDirective, StopPropagationDirective]\r\n})\r\nexport class IgoStopPropagationModule {\r\n  static forRoot(): ModuleWithProviders<IgoStopPropagationModule> {\r\n    return {\r\n      ngModule: IgoStopPropagationModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { EntityTablePaginatorComponent } from './entity-table-paginator.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    MatPaginatorModule,\r\n  ],\r\n  exports: [\r\n    EntityTablePaginatorComponent\r\n  ],\r\n  declarations: [\r\n    EntityTablePaginatorComponent,\r\n  ]\r\n})\r\nexport class IgoEntityTablePaginatorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { SecureImagePipe } from './secure-image.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [SecureImagePipe],\r\n  exports: [SecureImagePipe]\r\n})\r\nexport class IgoImageModule {\r\n  static forRoot(): ModuleWithProviders<IgoImageModule> {\r\n    return {\r\n      ngModule: IgoImageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\n\r\nimport { IgoStopPropagationModule } from '../../stop-propagation/stop-propagation.module';\r\nimport { IgoCustomHtmlModule } from '../../custom-html/custom-html.module';\r\nimport { EntityTableRowDirective } from './entity-table-row.directive';\r\nimport { EntityTableComponent } from './entity-table.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\nimport { IgoEntityTablePaginatorModule } from '../entity-table-paginator/entity-table-paginator.module';\r\nimport { IgoImageModule } from '../../image/image.module';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTableModule,\r\n    MatAutocompleteModule,\r\n    MatSortModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatCheckboxModule,\r\n    MatPaginatorModule,\r\n    MatSelectModule,\r\n    IgoStopPropagationModule,\r\n    IgoCustomHtmlModule,\r\n    IgoEntityTablePaginatorModule,\r\n    IgoImageModule,\r\n    IgoLanguageModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatDatepickerModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    EntityTableComponent\r\n  ],\r\n  declarations: [\r\n    EntityTableComponent,\r\n    EntityTableRowDirective\r\n  ]\r\n})\r\nexport class IgoEntityTableModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from './entity-selector/entity-selector.module';\r\nimport { IgoEntityTableModule } from './entity-table/entity-table.module';\r\nimport { IgoEntityTablePaginatorModule } from './entity-table-paginator/entity-table-paginator.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoEntitySelectorModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoEntityModule {}\r\n","import { catchError } from 'rxjs/operators';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Injectable } from '@angular/core';\r\nimport { InteractiveTourOptions } from './interactive-tour.interface';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable()\r\nexport class InteractiveTourLoader {\r\n  private jsonURL: string;\r\n  private allToursOptions;\r\n\r\n  constructor(private http: HttpClient, private configService: ConfigService) {\r\n    this.jsonURL = this.getPathToConfigFile();\r\n  }\r\n\r\n   public loadConfigTour() {\r\n      this.getJSON()\r\n        .subscribe(\r\n          (data) => {\r\n            this.allToursOptions = data;\r\n          },\r\n          (err) => {\r\n            throw new Error(`Problem with Interactive tour configuration file: interactiveTour.json not find. Check if the file and is path is set correctly.`);\r\n          }\r\n        );\r\n   }\r\n\r\n  public getPathToConfigFile(): string {\r\n    return (\r\n      this.configService.getConfig('interactiveTour.pathToConfigFile') ||\r\n      './config/interactiveTour.json'\r\n    );\r\n  }\r\n\r\n  public getJSON(): Observable<any> {\r\n    return this.http.get(this.jsonURL).pipe(\r\n      catchError((e) => {\r\n        e.error.caught = true;\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  public getTourOptionData(toolName): InteractiveTourOptions {\r\n    if (this.allToursOptions === undefined) {\r\n      return undefined;\r\n    }\r\n    let nameInConfigFile = toolName;\r\n    nameInConfigFile = nameInConfigFile.replace(/\\s/g, '');\r\n    return this.allToursOptions[nameInConfigFile];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { ShepherdService } from 'angular-shepherd';\r\n\r\nimport { ConfigService, MediaService, LanguageService } from '@igo2/core';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\nimport {\r\n  InteractiveTourOptions,\r\n  InteractiveTourStep,\r\n  InteractiveTourAction\r\n} from './interactive-tour.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class InteractiveTourService {\r\n  private previousStep: InteractiveTourStep;\r\n  private nextIndex = 1;\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService,\r\n    private interactiveTourLoader: InteractiveTourLoader,\r\n    private shepherdService: ShepherdService\r\n  ) {\r\n    if (this.isAppHaveTour()) {\r\n      this.interactiveTourLoader.loadConfigTour();\r\n    }\r\n  }\r\n\r\n  public isAppHaveTour() {\r\n    const haveTour = this.configService.getConfig('interactiveTour.activateInteractiveTour');\r\n    if (haveTour === undefined) {\r\n      return true;\r\n    } else {\r\n      return haveTour;\r\n    }\r\n  }\r\n\r\n  public isToolHaveTourConfig(toolName: string): boolean {\r\n    const checkTourActiveOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n    if (checkTourActiveOptions === undefined) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  public disabledTourButton(toolName: string): boolean {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    if (stepConfig?.conditions) {\r\n      for (const condition of stepConfig?.conditions) {\r\n        if (document.querySelector(condition) === null) {\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public isMobile(): boolean {\r\n    return this.mediaService.isMobile();\r\n  }\r\n\r\n  public isTourDisplayInMobile(): boolean {\r\n    const showInMobile = this.configService.getConfig(\r\n      'interactiveTour.tourInMobile'\r\n    );\r\n    if (showInMobile === undefined) {\r\n      return true;\r\n    }\r\n    return this.configService.getConfig('interactiveTour.tourInMobile');\r\n  }\r\n\r\n  private getButtons(buttonKind?: 'first' | 'last' | 'noBackButton') {\r\n    if (buttonKind === 'noBackButton') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n    if (buttonKind === 'first') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n\r\n    if (buttonKind === 'last') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.backButton'\r\n          ),\r\n          type: 'back'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        }\r\n      ];\r\n    }\r\n\r\n    return [\r\n      {\r\n        classes: 'shepherd-button-secondary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.backButton'\r\n        ),\r\n        type: 'back'\r\n      },\r\n      {\r\n        classes: 'shepherd-button-primary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.nextButton'\r\n        ),\r\n        type: 'next'\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getAction(actionName: string) {\r\n    const action = {\r\n      click: 'click'\r\n    };\r\n    return action[actionName.toLowerCase()];\r\n  }\r\n\r\n  private addProgress() {\r\n    const self = this as any;\r\n    let nbTry = 0;\r\n    const maxTry = 21;\r\n    const checkExist = setInterval(() => {\r\n      if (self.getCurrentStep()) {\r\n        if (self.getCurrentStep().options.attachTo.element && !document.querySelector(self.getCurrentStep().options.attachTo.element)) {\r\n          self.cancel();\r\n          clearInterval(checkExist);\r\n          return;\r\n        } else {\r\n          const currentStepElement = self.getCurrentStep().getElement();\r\n          if (currentStepElement) {\r\n            const shepherdList = currentStepElement.querySelectorAll('.shepherd-content, .shepherd-text');\r\n            shepherdList.forEach(element => {\r\n              element.classList.add('mat-typography');\r\n            });\r\n          }\r\n          const header = currentStepElement\r\n            ? currentStepElement.querySelector('.shepherd-header')\r\n            : undefined;\r\n\r\n          nbTry++;\r\n          if (header || nbTry > maxTry) {\r\n            clearInterval(checkExist);\r\n          }\r\n\r\n          if (header) {\r\n            const stepsArray = self.steps;\r\n            const progress = document.createElement('span');\r\n            progress.className = 'shepherd-progress';\r\n            progress.innerText = `${\r\n              stepsArray.indexOf(self.getCurrentStep()) + 1\r\n            }/${stepsArray.length}`;\r\n            header.insertBefore(\r\n              progress,\r\n              currentStepElement.querySelector('.shepherd-cancel-icon')\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  private checkNext(index, tour, service) {\r\n    if (tour.getCurrentStep()) {\r\n      if (tour.getCurrentStep().options.attachTo.element && document.querySelector(tour.getCurrentStep().options.attachTo.element)) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      if (index.index === tour.steps.length - 1) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      tour.steps.splice(index.index, 1);\r\n      const nextStep = tour.steps[index.index];\r\n      if (nextStep.options.attachTo.element && !document.querySelector(nextStep.options.attachTo.element)) {\r\n        service.checkNext(index, tour, service);\r\n      } else {\r\n        tour._setupModal();\r\n        tour.show(nextStep.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private executeAction(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    if (!actionConfig) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      actionConfig.condition &&\r\n      ((actionConfig.condition.charAt(0) === '!' &&\r\n        document.querySelector(actionConfig.condition.slice(1))) ||\r\n        (actionConfig.condition.charAt(0) !== '!' &&\r\n          !document.querySelector(actionConfig.condition)))\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const element: HTMLElement = document.querySelector(\r\n      actionConfig.element || step.element\r\n    ) as HTMLElement;\r\n    const action = this.getAction(actionConfig.action);\r\n    if (element && action) {\r\n      element[action]();\r\n    }\r\n  }\r\n\r\n  private executeActionPromise(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    return new Promise<void>((resolve) => {\r\n      this.executeAction(step, actionConfig);\r\n      if (!actionConfig || !actionConfig.waitFor) {\r\n        resolve();\r\n        return;\r\n      }\r\n      let nbTry = 0;\r\n      const maxTry = actionConfig.maxWait ? actionConfig.maxWait / 100 : 20;\r\n      const checkExist = setInterval(() => {\r\n        nbTry++;\r\n        if (nbTry > maxTry || document.querySelector(actionConfig.waitFor)) {\r\n          clearInterval(checkExist);\r\n          resolve();\r\n        }\r\n      }, 100);\r\n    });\r\n  }\r\n\r\n  private getShepherdSteps(stepConfig: InteractiveTourOptions) {\r\n    const shepherdSteps = [];\r\n\r\n    let i = 0;\r\n    for (const step of stepConfig.steps) {\r\n      shepherdSteps.push({\r\n        attachTo: {\r\n          element: step.element,\r\n          on: step.position || stepConfig.position\r\n        },\r\n        popperOptions: {\r\n          modifiers: [{ name: 'offset', options: { offset: [0, 15] } }]\r\n        },\r\n        beforeShowPromise: () => {\r\n          return Promise.all([\r\n            this.executeActionPromise(\r\n              this.previousStep,\r\n              this.previousStep ? this.previousStep.beforeChange : undefined\r\n            ),\r\n            this.executeActionPromise(step, step.beforeShow)\r\n          ]);\r\n        },\r\n        buttons: this.getButtons(\r\n          i === 0\r\n            ? 'first'\r\n            : i + 1 === stepConfig.steps.length\r\n            ? 'last'\r\n            : stepConfig.steps[i].noBackButton\r\n            ? 'noBackButton'\r\n            : undefined\r\n        ),\r\n        classes: step.class,\r\n        highlightClass: step.highlightClass,\r\n        scrollTo: step.scrollToElement || stepConfig.scrollToElement || true,\r\n        canClickTarget: step.disableInteraction\r\n          ? !step.disableInteraction\r\n          : undefined,\r\n        title: this.languageService.translate.instant(\r\n          step.title || stepConfig.title\r\n        ),\r\n        text: [this.languageService.translate.instant(step.text)],\r\n        when: {\r\n          show: () => {\r\n            this.executeAction(step, step.onShow);\r\n          },\r\n          hide: () => {\r\n            this.previousStep = step;\r\n            this.executeAction(step, step.onHide);\r\n          }\r\n        }\r\n      });\r\n      i++;\r\n    }\r\n\r\n    return shepherdSteps;\r\n  }\r\n\r\n  public startTour(toolName: string) {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    this.shepherdService.defaultStepOptions = {\r\n      classes: stepConfig.class,\r\n      highlightClass: stepConfig.highlightClass,\r\n      canClickTarget: stepConfig.disableInteraction\r\n        ? !stepConfig.disableInteraction\r\n        : true,\r\n      cancelIcon: {\r\n        enabled: true\r\n      }\r\n    };\r\n\r\n    const shepherdSteps = this.getShepherdSteps(stepConfig);\r\n\r\n    this.shepherdService.modal = true;\r\n    this.shepherdService.confirmCancel = false;\r\n    this.shepherdService.addSteps(shepherdSteps);\r\n\r\n    this.shepherdService.tourObject.on('show', this.addProgress);\r\n    this.shepherdService.tourObject.on('cancel', (index) => {\r\n      this.checkNext(index, this.shepherdService.tourObject, this);\r\n    });\r\n\r\n    this.shepherdService.start();\r\n  }\r\n}\r\n","import { EntityRecord, EntityStore } from '../../entity';\r\nimport { Tool, ToolboxOptions } from './tool.interface';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service where all available tools and their component are registered.\r\n */\r\nexport class Toolbox {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Ordered list of tool names to display in a toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Active tool history. Useful for activating the previous tool.\r\n   */\r\n  private activeToolHistory: string[] = [];\r\n\r\n  /**\r\n   * Tool store\r\n   */\r\n  private store = new EntityStore<Tool>([], {\r\n    getKey: (tool: Tool) => tool.name\r\n  });\r\n\r\n  get tools$(): BehaviorSubject<Tool[]> {\r\n    return this.store.entities$;\r\n  }\r\n\r\n  constructor(private options: ToolboxOptions = {}) {\r\n    this.setToolbar(options.toolbar);\r\n    this.initStore();\r\n  }\r\n\r\n  /**\r\n   * Destroy the toolbox\r\n   */\r\n  destroy() {\r\n    this.activeTool$$.unsubscribe();\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return this.store.get(name);\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns Array of tools\r\n   */\r\n  getTools(): Tool[] {\r\n    return this.store.all();\r\n  }\r\n\r\n  /**\r\n   * Set tool configurations\r\n   * @param tools Tools\r\n   */\r\n  setTools(tools: Tool[]) {\r\n    this.store.load(tools);\r\n  }\r\n\r\n  /**\r\n   * Get toolbar\r\n   * @returns Toolbar value\r\n   */\r\n  getToolbar(): string[] {\r\n    return this.toolbar$.getValue();\r\n  }\r\n\r\n  /**\r\n   * Set toolbar\r\n   * @param toolbar A list of tool names\r\n   */\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar$.next(toolbar || []);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool (and deactivate other tools)\r\n   * @param name Tool name\r\n   * @param options Tool options\r\n   */\r\n  activateTool(name: string, options: { [key: string]: any } = {}) {\r\n    const tool = this.getTool(name);\r\n    if (tool === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.store.state.update(tool, { active: true, options }, true);\r\n  }\r\n\r\n  /**\r\n   * Activate the previous tool, if any\r\n   */\r\n  activatePreviousTool() {\r\n    if (this.activeToolHistory.length <= 1) {\r\n      this.deactivateTool();\r\n      return;\r\n    }\r\n    const [previous, current] = this.activeToolHistory.splice(-2, 2);\r\n    this.activateTool(previous);\r\n  }\r\n\r\n  /**\r\n   * Activate the tool below, if any\r\n   */\r\n  /* activateBelowTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index + 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const below = arrayTools[index + 1];\r\n      this.activateTool(below);\r\n    } else {\r\n      this.deactivateTool();\r\n      const below = arrayTools[0];\r\n      this.activateTool(below);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Activate the tool above, if any\r\n   */\r\n  /* activateAboveTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index - 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const above = arrayTools[index - 1];\r\n      this.activateTool(above);\r\n    } else {\r\n      this.deactivateTool();\r\n      const above = arrayTools[arrayTools.length - 1];\r\n      this.activateTool(above);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Deactivate the active tool\r\n   */\r\n  deactivateTool() {\r\n    this.clearActiveToolHistory();\r\n    this.store.state.updateAll({ active: false });\r\n  }\r\n\r\n  /**\r\n   * Initialize the tool store and start observing the active tool\r\n   */\r\n  private initStore() {\r\n    this.store = new EntityStore<Tool>([], {\r\n      getKey: (entity: Tool) => entity.name\r\n    });\r\n\r\n    this.activeTool$$ = this.store.stateView\r\n      .firstBy$((record: EntityRecord<Tool>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Tool>) => {\r\n        if (record === undefined) {\r\n          this.setActiveTool(undefined);\r\n          return;\r\n        }\r\n\r\n        const tool = record.entity;\r\n        const options = Object.assign(\r\n          {},\r\n          tool.options || {},\r\n          record.state.options || {}\r\n        );\r\n        this.setActiveTool(Object.assign({}, tool, { options }));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Set the active tool and update the tool history\r\n   * @param tool Tool\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    this.activeTool$.next(tool);\r\n    if (tool === undefined) {\r\n      this.clearActiveToolHistory();\r\n    } else {\r\n      this.activeToolHistory = this.activeToolHistory\r\n        .filter((name: string) => name !== tool.name)\r\n        .concat([tool.name]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the tool history\r\n   */\r\n  private clearActiveToolHistory() {\r\n    this.activeToolHistory = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Tool } from './tool.interface';\r\nimport { Toolbox } from './toolbox';\r\n\r\n/**\r\n * Service where runtime tool configurations are registered\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolService {\r\n  static tools: { [key: string]: Tool } = {};\r\n\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  public toolbox: Toolbox = new Toolbox();\r\n\r\n  static register(tool: Tool) {\r\n    ToolService.tools[tool.name] = tool;\r\n  }\r\n\r\n  constructor() {\r\n    this.toolbox.setTools(this.getTools());\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return ToolService.tools[name];\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns tTols\r\n   */\r\n  getTools(): Tool[] {\r\n    return Object.values(ToolService.tools);\r\n  }\r\n}\r\n","<button *ngIf=\"showTourButton\"\r\n  (click) = \"startInteractiveTour()\"\r\n  [ngClass]=\"getClass()\"\r\n  mat-raised-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [disabled]=disabledTourButton>\r\n  <span class=\"interactive-tour-button-title\">{{'igo.common.interactiveTour.buttonTitle' | translate}} {{(discoverTitleInLocale$ | async) | translate}}</span>\r\n  <mat-icon\r\n    svgIcon=\"presentation-play\"\r\n    [matTooltip]=\"disabledTourButton ?\r\n    ('igo.common.interactiveTour.disaledTooltipTourToolButton' | translate) :\r\n    ('igo.common.interactiveTour.tooltipTourToolButton' | translate)\">\r\n  </mat-icon>\r\n</button>\r\n","import { Component, ViewEncapsulation, Input } from '@angular/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { ToolService } from '../tool/shared/tool.service';\r\nimport { Observable, of } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-interactive-tour',\r\n  templateUrl: './interactive-tour.component.html',\r\n  styleUrls: ['./interactive-tour.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class InteractiveTourComponent {\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  @Input() tourToStart: string = '';\r\n  @Input() styleButton: string;\r\n  @Input() discoverTitleInLocale$: Observable<string> = of('IGO');\r\n\r\n  getClass() {\r\n    return {\r\n      'tour-button-tool-icon': this.styleButton === 'icon',\r\n      'tour-button-tool': this.styleButton === 'raised'\r\n    };\r\n  }\r\n\r\n  get toolbox() {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  getTourToStart() {\r\n    if (this.tourToStart) {\r\n      return this.tourToStart;\r\n    } else {\r\n      return this.activeToolName;\r\n    }\r\n  }\r\n\r\n  get activeToolName() {\r\n    if (this.toolbox) {\r\n      if (this.isActiveTool) {\r\n        return this.toolbox.activeTool$.getValue().name;\r\n      } else {\r\n        return 'global';\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isActiveTool(): boolean {\r\n    if (this.toolbox) {\r\n      return this.toolbox.activeTool$.getValue() !== undefined;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isToolHaveTour(): boolean {\r\n    if (this.activeToolName === 'about' && !this.tourToStart) {\r\n      return false;\r\n    }\r\n    return this.interactiveTourService.isToolHaveTourConfig(\r\n      this.getTourToStart()\r\n    );\r\n  }\r\n\r\n  get showTourButton(): boolean {\r\n    // 2 conditions to show: have Tour on tool in Config file and if we are in mobile displayInMobile= true\r\n    let haveTour: boolean;\r\n    haveTour = this.isToolHaveTour;\r\n    if (haveTour === false) {\r\n      return false;\r\n    }\r\n\r\n    let inMobileAndShow: boolean;\r\n    if (this.interactiveTourService.isMobile()) {\r\n      inMobileAndShow = this.isTourDisplayInMobile;\r\n      if (inMobileAndShow === false) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isTourDisplayInMobile(): boolean {\r\n    return this.interactiveTourService.isTourDisplayInMobile();\r\n  }\r\n\r\n  get disabledTourButton(): boolean {\r\n    return this.interactiveTourService.disabledTourButton(this.activeToolName);\r\n  }\r\n\r\n  constructor(\r\n    private interactiveTourService: InteractiveTourService,\r\n    private toolService: ToolService\r\n  ) {}\r\n\r\n  startInteractiveTour() {\r\n    const tour = this.getTourToStart();\r\n    if (tour) {\r\n      this.interactiveTourService.startTour(tour);\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { InteractiveTourComponent } from './interactive-tour.component';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\n\r\n@NgModule({\r\n  declarations: [InteractiveTourComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  providers: [InteractiveTourService, InteractiveTourLoader],\r\n  exports: [InteractiveTourComponent]\r\n})\r\nexport class IgoInteractiveTourModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\n@Pipe({\r\n  name: 'keyvalue'\r\n})\r\nexport class KeyValuePipe implements PipeTransform {\r\n  transform(value: any, args?: any): any {\r\n    const keyValues = [];\r\n    Object.getOwnPropertyNames(value).forEach((key: string) =>\r\n      keyValues.push({ key, value: value[key] })\r\n    );\r\n\r\n    return keyValues;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { KeyValuePipe } from './keyvalue.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [KeyValuePipe],\r\n  exports: [KeyValuePipe]\r\n})\r\nexport class IgoKeyValueModule {\r\n  static forRoot(): ModuleWithProviders<IgoKeyValueModule> {\r\n    return {\r\n      ngModule: IgoKeyValueModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  ElementRef,\r\n  Renderer2,\r\n  HostListener,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoListItem]'\r\n})\r\nexport class ListItemDirective {\r\n\r\n  static focusedCls = 'igo-list-item-focused';\r\n  static selectedCls = 'igo-list-item-selected';\r\n  static disabledCls = 'igo-list-item-disabled';\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  @Input()\r\n  get focused() {\r\n    return this._focused;\r\n  }\r\n  set focused(value: boolean) {\r\n    if (value === this._focused) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeFocus.emit(this) : this.beforeUnfocus.emit(this);\r\n\r\n    this._focused = value;\r\n    if (this.selected !== true) {\r\n      this.toggleFocusedClass();\r\n    }\r\n\r\n    value ? this.focus.emit(this) : this.unfocus.emit(this);\r\n  }\r\n  private _focused = false;\r\n\r\n  @Input()\r\n  get selected() {\r\n    return this._selected;\r\n  }\r\n  set selected(value: boolean) {\r\n    if (value === this._selected) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeSelect.emit(this) : this.beforeUnselect.emit(this);\r\n\r\n    this._selected = value;\r\n    this._focused = value;\r\n    this.toggleSelectedClass();\r\n\r\n    value ? this.select.emit(this) : this.unselect.emit(this);\r\n  }\r\n  private _selected = false;\r\n\r\n  @Input()\r\n  get disabled() {\r\n    return this._disabled;\r\n  }\r\n  set disabled(value: boolean) {\r\n    if (value === this._disabled) {\r\n      return;\r\n    }\r\n\r\n    if (value === true) {\r\n      this.selected = false;\r\n    }\r\n\r\n    value ? this.beforeDisable.emit(this) : this.beforeEnable.emit(this);\r\n\r\n    this._disabled = value;\r\n    this.toggleDisabledClass();\r\n\r\n    value ? this.disable.emit(this) : this.enable.emit(this);\r\n  }\r\n  private _disabled = false;\r\n\r\n  @Output() beforeSelect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeFocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnselect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeDisable = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeEnable = new EventEmitter<ListItemDirective>();\r\n  @Output() focus = new EventEmitter<ListItemDirective>();\r\n  @Output() unfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() select = new EventEmitter<ListItemDirective>();\r\n  @Output() unselect = new EventEmitter<ListItemDirective>();\r\n  @Output() disable = new EventEmitter<ListItemDirective>();\r\n  @Output() enable = new EventEmitter<ListItemDirective>();\r\n\r\n  @HostListener('click')\r\n  onClick() {\r\n    this.selected = true;\r\n  }\r\n\r\n  constructor(public renderer: Renderer2, public el: ElementRef) {}\r\n\r\n  getOffsetTop(): number {\r\n    const padding = 5;\r\n\r\n    return this.el.nativeElement.offsetTop - padding;\r\n  }\r\n\r\n  private toggleFocusedClass() {\r\n    if (this.focused) {\r\n      this.addCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    }\r\n  }\r\n\r\n  private toggleSelectedClass() {\r\n    if (this.selected) {\r\n      this.addCls(ListItemDirective.selectedCls);\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.selectedCls);\r\n    }\r\n  }\r\n\r\n  private toggleDisabledClass() {\r\n    if (this.disabled) {\r\n      this.addCls(ListItemDirective.disabledCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.disabledCls);\r\n    }\r\n  }\r\n\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  AfterViewInit,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ContentChildren,\r\n  HostListener,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\n\r\n@Component({\r\n  selector: 'igo-list',\r\n  templateUrl: './list.component.html',\r\n  styleUrls: ['./list.component.scss']\r\n})\r\nexport class ListComponent implements AfterViewInit, OnInit, OnDestroy {\r\n  @Input()\r\n  get navigation() {\r\n    return this._navigation;\r\n  }\r\n  set navigation(value: boolean) {\r\n    this._navigation = value;\r\n  }\r\n  private _navigation = true;\r\n\r\n  @Input()\r\n  get selection() {\r\n    return this._selection;\r\n  }\r\n  set selection(value: boolean) {\r\n    this._selection = value;\r\n  }\r\n  private _selection = true;\r\n\r\n  get selectedItem() {\r\n    return this._selectedItem;\r\n  }\r\n  set selectedItem(value: ListItemDirective) {\r\n    this.focusedItem = value;\r\n    this._selectedItem = value;\r\n  }\r\n  private _selectedItem: ListItemDirective;\r\n\r\n  get focusedItem() {\r\n    return this._focusedItem;\r\n  }\r\n  set focusedItem(value: ListItemDirective) {\r\n    this._focusedItem = value;\r\n  }\r\n  private _focusedItem: ListItemDirective;\r\n\r\n  private navigationEnabled: boolean;\r\n  private listItems$$: Subscription;\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  @ContentChildren(ListItemDirective, { descendants: true })\r\n  listItems: QueryList<ListItemDirective>;\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  @HostListener('document:enter', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    // It would be nice to be able to unsubscribe to the event\r\n    // completely but until ES7 this won't be possible because\r\n    // document events are not observables\r\n    if (this.navigationEnabled) {\r\n      if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n        event.preventDefault();\r\n        this.navigate(event.key);\r\n      } else if (event.key === 'Enter') {\r\n        this.select(this.focusedItem);\r\n      }\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n\r\n  ngOnInit() {\r\n    this.enableNavigation();\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.listItems.length) {\r\n      this.init();\r\n    }\r\n\r\n    this.listItems$$ = this.listItems.changes.subscribe(\r\n      (items: ListItemDirective[]) => this.init()\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.listItems$$.unsubscribe();\r\n  }\r\n\r\n  focus(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unfocus();\r\n\r\n    // We need to make this check because dynamic\r\n    // lists such as in the search results list may fail\r\n    if (item !== undefined) {\r\n      item.focused = true;\r\n    }\r\n  }\r\n\r\n  unfocus() {\r\n    if (this.focusedItem !== undefined) {\r\n      this.focusedItem.focused = false;\r\n    }\r\n\r\n    this.focusedItem = undefined;\r\n  }\r\n\r\n  focusNext() {\r\n    const items = this.listItems.toArray();\r\n    let item;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n    if (index === undefined) {\r\n      index = -1;\r\n    }\r\n\r\n    while (disabled && index < items.length - 1) {\r\n      index += 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index + 1]) {\r\n      igoList.scrollTop = igoList.scrollHeight - igoList.clientHeight;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      igoList.scrollTop =\r\n        item.el.nativeElement.offsetTop +\r\n        item.el.nativeElement.children[0].offsetHeight -\r\n        igoList.clientHeight;\r\n    }\r\n  }\r\n\r\n  focusPrevious() {\r\n    const items = this.listItems.toArray();\r\n    let item: ListItemDirective;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n\r\n    while (disabled && index > 0) {\r\n      index -= 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index - 1]) {\r\n      igoList.scrollTop = 0;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      const padding = 3;\r\n      igoList.scrollTop = item.el.nativeElement.offsetTop - padding;\r\n    }\r\n  }\r\n\r\n  select(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unselect();\r\n\r\n    if (item !== undefined) {\r\n      item.selected = true;\r\n    }\r\n  }\r\n\r\n  unselect() {\r\n    this.unfocus();\r\n\r\n    if (this.selectedItem !== undefined) {\r\n      this.selectedItem.selected = false;\r\n    }\r\n\r\n    this.selectedItem = undefined;\r\n  }\r\n\r\n  enableNavigation() {\r\n    if (this.navigation) {\r\n      this.navigationEnabled = true;\r\n    }\r\n  }\r\n\r\n  disableNavigation() {\r\n    this.navigationEnabled = false;\r\n  }\r\n\r\n  scrollToItem(item: ListItemDirective) {\r\n    this.el.nativeElement.scrollTop = item.getOffsetTop();\r\n  }\r\n\r\n  isScrolledIntoView(elem) {\r\n    const docViewTop =\r\n      this.el.nativeElement.scrollTop + this.el.nativeElement.offsetTop;\r\n    const docViewBottom = docViewTop + this.el.nativeElement.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.children[0].offsetHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  private init() {\r\n    this.subscribe();\r\n\r\n    this.selectedItem = this.findSelectedItem();\r\n    this.focusedItem = this.findFocusedItem();\r\n\r\n    this.enableNavigation();\r\n  }\r\n\r\n  private subscribe() {\r\n    this.unsubscribe();\r\n\r\n    this.listItems.toArray().forEach(item => {\r\n      this.subscriptions.push(\r\n        item.beforeSelect.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.select.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.beforeFocus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeFocus(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.focus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemFocus(item2)\r\n        )\r\n      );\r\n    }, this);\r\n  }\r\n\r\n  private unsubscribe() {\r\n    this.subscriptions.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n  private handleItemBeforeFocus(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unfocus();\r\n    }\r\n  }\r\n\r\n  private handleItemFocus(item: ListItemDirective) {\r\n    this.focusedItem = item;\r\n  }\r\n\r\n  private handleItemBeforeSelect(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unselect();\r\n    }\r\n  }\r\n\r\n  private handleItemSelect(item: ListItemDirective) {\r\n    this.selectedItem = item;\r\n  }\r\n\r\n  private findSelectedItem() {\r\n    return this.listItems.toArray().find(item => item.selected);\r\n  }\r\n\r\n  private findFocusedItem() {\r\n    return this.listItems.toArray().find(item => item.focused);\r\n  }\r\n\r\n  private getFocusedIndex() {\r\n    return this.listItems\r\n      .toArray()\r\n      .findIndex(item => item === this.focusedItem);\r\n  }\r\n\r\n  private navigate(key: string) {\r\n    switch (key) {\r\n      case 'ArrowUp':\r\n        this.focusPrevious();\r\n        break;\r\n      case 'ArrowDown':\r\n        this.focusNext();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n}\r\n","<mat-list\r\n  igoClickout\r\n  [ngClass]=\"{'selectable': selection}\"\r\n  (clickout)=\"disableNavigation()\"\r\n  (click)=\"enableNavigation()\">\r\n  <ng-content></ng-content>\r\n</mat-list>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { IgoClickoutModule } from '../clickout/clickout.module';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\nimport { ListComponent } from './list.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatIconModule, MatListModule, IgoClickoutModule],\r\n  declarations: [ListItemDirective, ListComponent],\r\n  exports: [ListItemDirective, ListComponent]\r\n})\r\nexport class IgoListModule {\r\n  static forRoot(): ModuleWithProviders<IgoListModule> {\r\n    return {\r\n      ngModule: IgoListModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","<div *ngIf=\"withHeader\" class=\"igo-panel-header mat-typography\" title=\"\">\r\n  <h3>\r\n    <ng-content select=\"[panelLeftButton]\"></ng-content>\r\n    <div class=\"igo-panel-title\">\r\n      {{ title }}\r\n      <ng-content select=\"[panelHeader]\"></ng-content>\r\n    </div>\r\n    <ng-content select=\"[panelRightButton]\"></ng-content>\r\n  </h3>\r\n</div>\r\n<div class=\"igo-panel-content\" title=\"\">\r\n  <ng-content></ng-content>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  HostBinding\r\n} from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-panel',\r\n  templateUrl: './panel.component.html',\r\n  styleUrls: ['./panel.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class PanelComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title: string;\r\n\r\n  @Input()\r\n  @HostBinding('class.igo-panel-with-header')\r\n  get withHeader(): boolean {\r\n    return this._withHeader;\r\n  }\r\n  set withHeader(value: boolean) {\r\n    this._withHeader = value;\r\n  }\r\n  private _withHeader = true;\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { PanelComponent } from './panel.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  exports: [PanelComponent],\r\n  declarations: [PanelComponent]\r\n})\r\nexport class IgoPanelModule {}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-spinner',\r\n  templateUrl: './spinner.component.html',\r\n  styleUrls: ['./spinner.component.scss']\r\n})\r\nexport class SpinnerComponent {\r\n\r\n  public shown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  set shown(value: boolean) { this.shown$.next(value); }\r\n  get shown(): boolean { return this.shown$.value; }\r\n\r\n  constructor() {}\r\n\r\n  show() {\r\n    this.shown = true;\r\n  }\r\n\r\n  hide() {\r\n    this.shown = false;\r\n  }\r\n}\r\n","<div\r\n  [ngClass]=\"{'igo-spinner-container': true, 'igo-spinner-shown': (shown$ | async)}\">\r\n  <div class=\"igo-spinner-background\"></div>\r\n  <mat-progress-spinner diameter=\"40\" mode=\"indeterminate\"></mat-progress-spinner>\r\n</div>\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n/**\r\n * A directive to bind a SpinnerComponent to the activity service.\r\n * The activity service tracks any HTTP request and this directive\r\n * will display the spinner it's attached to when the activity counter\r\n * is greater than 0.\r\n */\r\n@Directive({\r\n  selector: '[igoSpinnerActivity]'\r\n})\r\nexport class SpinnerActivityDirective implements OnInit, OnDestroy {\r\n  /**\r\n   * Subscription to the activity service counter\r\n   */\r\n  private counter$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() private spinner: SpinnerComponent,\r\n    private activityService: ActivityService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the activity service counter and display the spinner\r\n   * when it's is greater than 0.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.counter$$ = this.activityService.counter$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((count: number) => {\r\n        count > 0 ? this.spinner.show() : this.spinner.hide();\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubcribe to the activity service counter.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.counter$$.unsubscribe();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\r\n\r\nimport { SpinnerActivityDirective } from './spinner-activity.directive';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatProgressSpinnerModule],\r\n  declarations: [SpinnerActivityDirective, SpinnerComponent],\r\n  exports: [SpinnerActivityDirective, SpinnerComponent]\r\n})\r\nexport class IgoSpinnerModule {}\r\n","import { DataSource } from '@angular/cdk/table';\r\nimport { MatSort } from '@angular/material/sort';\r\n\r\nimport { Observable, BehaviorSubject, merge } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableDatabase, TableModel } from './index';\r\n\r\nexport class TableDataSource extends DataSource<any> {\r\n  get filter(): string {\r\n    return this._filterChange.value;\r\n  }\r\n  set filter(filter: string) {\r\n    this._filterChange.next(filter);\r\n  }\r\n  private _filterChange = new BehaviorSubject('');\r\n\r\n  constructor(\r\n    private _database: TableDatabase,\r\n    private _model: TableModel,\r\n    private _sort: MatSort\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  // Connect function called by the table to retrieve one stream containing\r\n  // the data to render.\r\n  connect(): Observable<any[]> {\r\n    if (!this._database) {\r\n      return merge([]);\r\n    }\r\n    const displayDataChanges = [\r\n      this._database.dataChange,\r\n      this._filterChange,\r\n      this._sort.sortChange\r\n    ];\r\n\r\n    return merge(...displayDataChanges).pipe(\r\n      map(() => {\r\n        return this.getFilteredData(this._database.data);\r\n      }),\r\n      map(data => {\r\n        return this.getSortedData(data);\r\n      })\r\n    );\r\n  }\r\n\r\n  disconnect() {}\r\n\r\n  getFilteredData(data): any[] {\r\n    if (!this.filter) {\r\n      return data;\r\n    }\r\n    return data.slice().filter((item: any) => {\r\n      const searchStr: string = this._model.columns\r\n        .filter(c => c.filterable)\r\n        .map(c => ObjectUtils.resolve(item, c.name))\r\n        .join(' ')\r\n        .toLowerCase();\r\n\r\n      return searchStr.indexOf(this.filter.toLowerCase()) !== -1;\r\n    });\r\n  }\r\n\r\n  getSortedData(data): any[] {\r\n    if (!this._sort.active || this._sort.direction === '') {\r\n      return data;\r\n    }\r\n\r\n    return data.sort((a, b) => {\r\n      const propertyA: number | string = ObjectUtils.resolve(\r\n        a,\r\n        this._sort.active\r\n      );\r\n      const propertyB: number | string = ObjectUtils.resolve(\r\n        b,\r\n        this._sort.active\r\n      );\r\n\r\n      return ObjectUtils.naturalCompare(\r\n        propertyB,\r\n        propertyA,\r\n        this._sort.direction\r\n      );\r\n    });\r\n  }\r\n}\r\n","export enum TableActionColor {\r\n  primary,\r\n  accent,\r\n  warn\r\n}\r\n","<div class='table-box'>\r\n  <div class='table-header' *ngIf=\"hasFilterInput\">\r\n    <mat-form-field floatPlaceholder='never'>\r\n      <input matInput #filter [placeholder]=\"'igo.common.table.filter' | translate\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class='table-container'>\r\n    <table mat-table #table [dataSource]='dataSource' matSort>\r\n\r\n      <!-- Checkbox Column -->\r\n      <ng-container matColumnDef=\"selectionCheckbox\">\r\n        <th mat-header-cell *matHeaderCellDef>\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"selection.hasValue() && isAllSelected()\"\r\n                        [indeterminate]=\"selection.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </th>\r\n        <td mat-cell *matCellDef=\"let row\">\r\n          <mat-checkbox (click)=\"$event.stopPropagation()\"\r\n                        (change)=\"$event ? selection.toggle(row) : null\"\r\n                        [checked]=\"selection.isSelected(row)\">\r\n          </mat-checkbox>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]='column.name' *ngFor='let column of model.columns'>\r\n        <ng-container *ngIf='column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef mat-sort-header> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf='!column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf=\"!column.html; else cellHTML\">\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\">\r\n            {{getValue(row, column.name)}}\r\n          </td>\r\n        </ng-container>\r\n\r\n        <ng-template #cellHTML>\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\"\r\n            [innerHTML]=\"getValue(row, column.name)\">\r\n          </td>\r\n        </ng-template>\r\n      </ng-container>\r\n\r\n      <!-- Action Column -->\r\n      <ng-container matColumnDef='action'>\r\n        <th mat-header-cell *matHeaderCellDef></th>\r\n        <td mat-cell *matCellDef='let row'>\r\n          <button *ngFor='let action of model.actions'\r\n          mat-mini-fab\r\n          [color]='getActionColor(action.color)'\r\n          (click)='handleClickAction($event, action, row)'>\r\n            <mat-icon svgIcon=\"{{action.icon}}\"></mat-icon>\r\n          </button>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef='displayedColumns;'></tr>\r\n      <tr mat-row\r\n        *matRowDef='let row; columns: displayedColumns;'\r\n        [ngClass]=\"model.rowClassFunc ? model.rowClassFunc(row) : {}\"\r\n        (click)=\"selection.toggle(row)\">\r\n      </tr>\r\n\r\n    </table>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ElementRef,\r\n  ViewChild,\r\n  Input,\r\n  Output,\r\n  OnChanges,\r\n  OnInit,\r\n  AfterViewInit,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { MatSort } from '@angular/material/sort';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\n\r\nimport { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { fromEvent } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableModel } from './table-model.interface';\r\nimport { TableDatabase } from './table-database';\r\nimport { TableDataSource } from './table-datasource';\r\nimport { TableActionColor } from './table-action-color.enum';\r\n\r\n@Component({\r\n  selector: 'igo-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class TableComponent implements OnChanges, OnInit, AfterViewInit {\r\n  @Input()\r\n  get database(): TableDatabase {\r\n    return this._database;\r\n  }\r\n  set database(value: TableDatabase) {\r\n    this._database = value;\r\n  }\r\n  private _database: TableDatabase;\r\n\r\n  @Input()\r\n  get model(): TableModel {\r\n    return this._model;\r\n  }\r\n  set model(value: TableModel) {\r\n    this._model = value;\r\n  }\r\n  private _model: TableModel;\r\n\r\n  @Input()\r\n  get hasFilterInput(): boolean {\r\n    return this._hasFIlterInput;\r\n  }\r\n  set hasFilterInput(value: boolean) {\r\n    this._hasFIlterInput = value;\r\n  }\r\n  private _hasFIlterInput = true;\r\n\r\n  public displayedColumns;\r\n  public dataSource: TableDataSource | null;\r\n  public selection = new SelectionModel<any>(true, []);\r\n\r\n  @Output()\r\n  select = new EventEmitter<{\r\n    added: any[];\r\n    removed: any[];\r\n    source: SelectionModel<any>;\r\n  }>();\r\n\r\n  @ViewChild('filter') filter: ElementRef;\r\n  @ViewChild(MatSort, { static: true }) sort: MatSort;\r\n\r\n  ngOnInit() {\r\n    this.dataSource = new TableDataSource(this.database, this.model, this.sort);\r\n\r\n    if (this.model) {\r\n      this.displayedColumns = this.model.columns\r\n        .filter(c => c.displayed !== false)\r\n        .map(c => c.name);\r\n\r\n      if (this.model.selectionCheckbox) {\r\n        this.displayedColumns.unshift('selectionCheckbox');\r\n      }\r\n      if (this.model.actions && this.model.actions.length) {\r\n        this.displayedColumns.push('action');\r\n      }\r\n    }\r\n\r\n    this.selection.changed.subscribe(e => this.select.emit(e));\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.filter) {\r\n      fromEvent(this.filter.nativeElement, 'keyup')\r\n        .pipe(\r\n          debounceTime(150),\r\n          distinctUntilChanged()\r\n        )\r\n        .subscribe(() => {\r\n          if (!this.dataSource) {\r\n            return;\r\n          }\r\n          this.dataSource.filter = this.filter.nativeElement.value;\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnChanges(change) {\r\n    if (change.database) {\r\n      this.dataSource = new TableDataSource(\r\n        this.database,\r\n        this.model,\r\n        this.sort\r\n      );\r\n      this.selection.clear();\r\n    }\r\n  }\r\n\r\n  getActionColor(colorId: number): string {\r\n    return TableActionColor[colorId];\r\n  }\r\n\r\n  getValue(row, key) {\r\n    return ObjectUtils.resolve(row, key);\r\n  }\r\n\r\n  /** Whether the number of selected elements matches the total number of rows. */\r\n  isAllSelected() {\r\n    const numSelected = this.selection.selected.length;\r\n    const numRows = this.database.data.length;\r\n    return numSelected === numRows;\r\n  }\r\n\r\n  /** Selects all rows if they are not all selected; otherwise clear selection. */\r\n  masterToggle() {\r\n    this.isAllSelected()\r\n      ? this.selection.clear()\r\n      : this.database.data.forEach(row => this.selection.select(row));\r\n  }\r\n\r\n  handleClickAction(event, action, row) {\r\n    event.stopPropagation();\r\n    action.click(row);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { CdkTableModule } from '@angular/cdk/table';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { TableComponent } from './table.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    CdkTableModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTableModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSortModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  declarations: [TableComponent],\r\n  exports: [TableComponent]\r\n})\r\nexport class IgoTableModule {\r\n  static forRoot(): ModuleWithProviders<IgoTableModule> {\r\n    return {\r\n      ngModule: IgoTableModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Action } from './action.interfaces';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * actions.\r\n */\r\nexport class ActionStore extends EntityStore<Action> {\r\n\r\n}\r\n","export enum ToolboxColor {\r\n  White = 'white',\r\n  Grey = 'grey',\r\n  Primary = 'primary'\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function toolSlideInOut(\r\n  speed = '300ms',\r\n  type = 'ease-in-out'\r\n): AnimationTriggerMetadata {\r\n  return trigger('toolSlideInOut', [\r\n    state(\r\n      'enter',\r\n      style({\r\n        transform: 'translate3d(0, 0, 0)'\r\n      })\r\n    ),\r\n    transition('void => enter', animate(speed + ' ' + type))\r\n  ]);\r\n}\r\n","<igo-actionbar\r\n  *ngIf=\"(toolbar$ | async).length > 0\"\r\n  [store]=\"actionStore\"\r\n  [withIcon]=\"true\"\r\n  [withTitle]=\"toolbarWithTitle$ | async\"\r\n  [withTooltip]=\"(toolbarWithTitle$ | async) === false\"\r\n  [scrollActive]=\"toolbarWithTitle$ | async\"\r\n  [horizontal]=\"false\">\r\n</igo-actionbar>\r\n\r\n<div\r\n  *ngIf=\"activeTool$ | async as tool\"\r\n  class=\"igo-tool-container\"\r\n  [ngClass]=\"{'igo-tool-container-with-toolbar': !actionStore.empty, 'igo-tool-container-with-animation': animate}\"\r\n  [@toolSlideInOut]=\"animation$ | async\"\r\n  (@toolSlideInOut.start)=\"onAnimationStart()\"\r\n  (@toolSlideInOut.done)=\"onAnimationComplete()\">\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"tool.component\"\r\n    [inputs]=\"getToolInputs(tool)\">\r\n  </igo-dynamic-outlet>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  HostBinding,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Action, ActionStore } from '../../action';\r\nimport { Tool } from '../shared/tool.interface';\r\nimport { ToolboxColor } from '../shared/toolbox.enums';\r\nimport { Toolbox } from '../shared/toolbox';\r\nimport { toolSlideInOut } from './toolbox.animation';\r\n\r\n@Component({\r\n  selector: 'igo-toolbox',\r\n  templateUrl: 'toolbox.component.html',\r\n  styleUrls: ['toolbox.component.scss'],\r\n  animations: [toolSlideInOut()],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ToolboxComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store of actions that toggle tools\r\n   */\r\n  actionStore: ActionStore = new ActionStore([]);\r\n\r\n  /**\r\n   * Observable of he anmation state\r\n   */\r\n  animation$: BehaviorSubject<string> = new BehaviorSubject('none');\r\n\r\n  /**\r\n   * Observable of the toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Whether the Toolbar should display actions' titles\r\n   */\r\n  toolbarWithTitle$: Observable<boolean> = this.activeTool$.pipe(\r\n    map((tool: Tool | undefined) => tool === undefined)\r\n  );\r\n\r\n  /**\r\n   * Subscription to the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the toolbar\r\n   */\r\n  private toolbar$$: Subscription;\r\n\r\n  /**\r\n   * Observable of the ongoing animation. This is useful when\r\n   * multiple animations are triggered at once i.e. when the user clicks\r\n   * too fast on different actions\r\n   */\r\n  private animating$ = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Subscription to the ongoing animation\r\n   */\r\n  private animating$$: Subscription;\r\n\r\n  /**\r\n   * Toolbox\r\n   */\r\n  @Input() toolbox: Toolbox;\r\n\r\n  /**\r\n   * Whether the toolbox should animate the first tool entering\r\n   */\r\n  @Input() animate: boolean = false;\r\n\r\n  /**\r\n   * Color of Toolbox\r\n   */\r\n  @Input() color: ToolboxColor = ToolboxColor.White;\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-grey')\r\n  get classColorGrey() {\r\n    return this.color === ToolboxColor.Grey;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-primary')\r\n  get classColorPrimary() {\r\n    return this.color === ToolboxColor.Primary;\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar and subscribe to the active tool\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.toolbar$$ = this.toolbox.toolbar$.subscribe((toolbar: string[]) =>\r\n      this.onToolbarChange(toolbar)\r\n    );\r\n    this.activeTool$$ = this.toolbox.activeTool$.subscribe((tool: Tool) =>\r\n      this.onActiveToolChange(tool)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the active tool and destroy the action store\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toolbar$$.unsubscribe();\r\n    this.activeTool$$.unsubscribe();\r\n    this.actionStore.destroy();\r\n  }\r\n\r\n  /**\r\n   * Track the starting animation\r\n   * @internal\r\n   */\r\n  onAnimationStart() {\r\n    this.animating$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Untrack the completed animation\r\n   * @internal\r\n   */\r\n  onAnimationComplete() {\r\n    this.animating$.next(false);\r\n  }\r\n\r\n  /**\r\n   * Return a tool's inputs\r\n   * @param tool Tool\r\n   * @returns Tool inputs\r\n   * @internal\r\n   */\r\n  getToolInputs(tool: Tool): { [key: string]: any } {\r\n    return tool.options || {};\r\n  }\r\n\r\n  /**\r\n   * Initialize an action store\r\n   * @param toolbar Toolbar\r\n   */\r\n  private onToolbarChange(toolbar: string[]) {\r\n    this.setToolbar(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool and trigger an animation or not\r\n   * @param tool Tool to activate\r\n   */\r\n  private onActiveToolChange(tool: Tool) {\r\n    if (!this.animate) {\r\n      this.setActiveTool(tool);\r\n      return;\r\n    }\r\n    this.onAnimate(() => this.setActiveTool(tool));\r\n  }\r\n\r\n  /**\r\n   * Set the active tool\r\n   * @param tool Tool to activate\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    if (tool === undefined) {\r\n      this.actionStore.state.updateAll({ active: false });\r\n    } else {\r\n      const action = this.actionStore.get(tool.name);\r\n      if (action !== undefined) {\r\n        this.actionStore.state.update(action, { active: true }, true);\r\n      }\r\n    }\r\n\r\n    this.activeTool$.next(tool);\r\n    if (this.animate) {\r\n      this.animation$.next('enter');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar\r\n   */\r\n  private setToolbar(toolbar: string[]) {\r\n    const actions = toolbar.reduce((acc: Action[], toolName: string) => {\r\n      const tool = this.toolbox.getTool(toolName);\r\n      if (tool === undefined) {\r\n        return acc;\r\n      }\r\n\r\n      acc.push({\r\n        id: tool.name,\r\n        title: tool.title,\r\n        icon: tool.icon,\r\n        // iconImage: tool.iconImage,\r\n        tooltip: tool.tooltip,\r\n        args: [tool, this.toolbox],\r\n        handler: (_tool: Tool, _toolbox: Toolbox) => {\r\n          _toolbox.activateTool(_tool.name);\r\n        },\r\n        ngClass: (_tool: Tool, _toolbox: Toolbox) => {\r\n          return this.toolbox.activeTool$.pipe(\r\n            map((activeTool: Tool) => {\r\n              let toolActivated = false;\r\n              if (activeTool !== undefined && _tool.name === activeTool.name) {\r\n                toolActivated = true;\r\n              }\r\n\r\n              let childrenToolActivated = false;\r\n              if (\r\n                activeTool !== undefined &&\r\n                _tool.name === activeTool.parent\r\n              ) {\r\n                childrenToolActivated = true;\r\n              }\r\n\r\n              return {\r\n                'tool-activated': toolActivated,\r\n                'children-tool-activated': childrenToolActivated\r\n              };\r\n            })\r\n          );\r\n        }\r\n      });\r\n      return acc;\r\n    }, []);\r\n    this.actionStore.load(actions);\r\n    this.toolbar$.next(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Observe the ongoing animation and ignore any incoming animation\r\n   * while one is still ongoing.\r\n   * @param callback Callback to execute when the animation completes\r\n   */\r\n  private onAnimate(callback: () => void) {\r\n    this.unAnimate();\r\n    this.animating$$ = this.animating$.subscribe((animation: boolean) => {\r\n      if (!animation) {\r\n        callback.call(this);\r\n        this.unAnimate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop observing an animation when it's complete\r\n   */\r\n  private unAnimate() {\r\n    if (this.animating$$) {\r\n      this.animating$$.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionModule } from '../../action/action.module';\r\nimport {\r\n    IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { ToolboxComponent } from './toolbox.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    ToolboxComponent\r\n  ],\r\n  declarations: [\r\n    ToolboxComponent\r\n  ]\r\n})\r\nexport class IgoToolboxModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { ToolService } from './shared/tool.service';\r\nimport { IgoToolboxModule } from './toolbox/toolbox.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoToolboxModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoToolModule {\r\n  static forRoot(): ModuleWithProviders<IgoToolModule> {\r\n    return {\r\n      ngModule: IgoToolModule,\r\n      providers: [\r\n        ToolService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","<igo-dynamic-outlet\r\n  *ngIf=\"widget\"\r\n  [component]=\"widget\"\r\n  [inputs]=\"inputs\"\r\n  [subscribers]=\"getEffectiveSubscribers()\">\r\n</igo-dynamic-outlet>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from '../../dynamic-component';\r\n\r\nimport { WidgetComponent } from '../shared/widget.interfaces';\r\n\r\n/**\r\n * This component dynamically renders a widget. It also subscribes\r\n * to the widget's 'cancel' and 'complete' events and destroys it\r\n * when any of those event is emitted.\r\n */\r\n@Component({\r\n  selector: 'igo-widget-outlet',\r\n  templateUrl: './widget-outlet.component.html',\r\n  styleUrls: ['./widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WidgetOutletComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Widget subscribers to 'cancel' and 'complete'\r\n   * @internal\r\n   */\r\n  private baseSubscribers = {\r\n    cancel: (event: any) => this.onCancel(event),\r\n    complete: (event: any) => this.onComplete(event)\r\n  };\r\n\r\n  /**\r\n   * Widget\r\n   */\r\n  @Input() widget: DynamicComponent<WidgetComponent>;\r\n\r\n  /**\r\n   * Widget inputs\r\n   */\r\n  @Input() inputs: {[key: string]: any};\r\n\r\n  /**\r\n   * Widget subscribers\r\n   */\r\n  @Input() subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'complete'\r\n   */\r\n  @Output() complete = new EventEmitter<any>();\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'cancel'\r\n   */\r\n  @Output() cancel = new EventEmitter<any>();\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Destroy the current widget and all it's inner subscriptions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Get the effective subscribers. That means a combination of the base\r\n   * subscribers and any subscriber given as input.\r\n   * @returns Combined subscribers\r\n   * @internal\r\n   */\r\n  getEffectiveSubscribers(): {[key: string]: (event: any) => void} {\r\n    const subscribers = Object.assign({}, this.subscribers);\r\n\r\n    // Base subscribers\r\n    Object.keys(this.baseSubscribers).forEach((key: string) => {\r\n      const subscriber = subscribers[key];\r\n      const baseSubscriber = this.baseSubscribers[key];\r\n      if (subscriber !== undefined) {\r\n        subscribers[key] = (event: any) => {\r\n          subscriber(event);\r\n          baseSubscriber(event);\r\n        };\r\n      } else {\r\n        subscribers[key] = baseSubscriber;\r\n      }\r\n    });\r\n\r\n    return subscribers;\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'cancel', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onCancel(event: any) {\r\n    this.cancel.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'complete', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onComplete(event: any) {\r\n    this.complete.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Destroy the current widget\r\n   */\r\n  private destroyWidget() {\r\n    if (this.widget !== undefined) {\r\n      this.widget.destroy();\r\n    }\r\n    this.widget = undefined;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { WidgetOutletComponent } from './widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    WidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWidgetOutletModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { DynamicComponentService } from '../../dynamic-component/shared/dynamic-component.service';\r\n\r\nimport { Widget } from './widget';\r\nimport { WidgetComponent } from './widget.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WidgetService {\r\n\r\n  constructor(private dynamicComponentService: DynamicComponentService) {}\r\n\r\n  create(widgetCls: any): Widget {\r\n    return this.dynamicComponentService.create(widgetCls as WidgetComponent);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from './widget-outlet/widget-outlet.module';\r\nimport { WidgetService } from './shared/widget.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    IgoWidgetOutletModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    WidgetService\r\n  ]\r\n})\r\nexport class IgoWidgetModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle } from '../../entity';\r\nimport { Workspace } from '../shared/workspace';\r\nimport { WorkspaceStore } from '../shared/store';\r\n\r\n/**\r\n * Drop list that activates the selected workspace emit an event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-selector',\r\n  templateUrl: './workspace-selector.component.html',\r\n  styleUrls: ['./workspace-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceSelectorComponent {\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  /**\r\n   * Wheither the selector must be disabled or not.\r\n   */\r\n  @Input() disabled: boolean;\r\n\r\n  /**\r\n   * Event emitted when an workspace is selected or unselected\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: Workspace;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  getWorkspaceTitle(workspace: Workspace): string {\r\n    return getEntityTitle(workspace);\r\n  }\r\n\r\n  /**\r\n   * When an workspace is manually selected, select it into the\r\n   * store and emit an event.\r\n   * @internal\r\n   * @param event The selection change event\r\n   */\r\n  onSelectedChange(event: {value: Workspace}) {\r\n    const workspace = event.value;\r\n    this.store.activateWorkspace(workspace);\r\n    this.selectedChange.emit({selected: true, value: workspace});\r\n  }\r\n\r\n}\r\n","<igo-entity-selector\r\n  [store]=\"store\"\r\n  [multi]=\"false\"\r\n  [titleAccessor]=\"getWorkspaceTitle\"\r\n  [disabled]=\"disabled\"\r\n  (selectedChange)=\"onSelectedChange($event)\">\r\n</igo-entity-selector>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from '../../entity/entity-selector/entity-selector.module';\r\nimport { WorkspaceSelectorComponent } from './workspace-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [\r\n    WorkspaceSelectorComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","<ng-container *ngIf=\"widget$ | async as widget\">\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"widgetInputs$ | async\"\r\n    [subscribers]=\"widgetSubscribers$ | async\"\r\n    (cancel)=\"onWidgetCancel(widget)\"\r\n    (complete)=\"onWidgetComplete(widget)\">\r\n  </igo-widget-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Widget } from '../../widget';\r\nimport { Workspace } from '../shared/workspace';\r\n\r\n/**\r\n * This component dynamically render an Workspace's active widget.\r\n * It also deactivate that widget whenever the widget's component\r\n * emit the 'cancel' or 'complete' event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-widget-outlet',\r\n  templateUrl: './workspace-widget-outlet.component.html',\r\n  styleUrls: ['./workspace-widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceWidgetOutletComponent {\r\n\r\n  /**\r\n   * Workspace\r\n   */\r\n  @Input() workspace: Workspace;\r\n\r\n  /**\r\n   * Event emitted when a widget is deactivate which happens\r\n   * when the widget's component emits the 'cancel' or 'complete' event.\r\n   */\r\n  @Output() deactivateWidget = new EventEmitter<Widget>();\r\n\r\n  /**\r\n   * Observable of the workspace's active widget\r\n   * @internal\r\n   */\r\n  get widget$(): BehaviorSubject<Widget> { return this.workspace.widget$; }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetInputs$(): BehaviorSubject<{[key: string]: any}> {\r\n    return this.workspace.widgetInputs$;\r\n  }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetSubscribers$(): BehaviorSubject<{[key: string]: (event: any) => void}> {\r\n    return this.workspace.widgetSubscribers$;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetCancel(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetComplete(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from '../../widget/widget-outlet/widget-outlet.module';\r\n\r\nimport { WorkspaceWidgetOutletComponent } from './workspace-widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    WorkspaceWidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceWidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceWidgetOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceWidgetOutletModule } from './workspace-widget-outlet/workspace-widget-outlet.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceWidgetOutletModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoWorkspaceModule {}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nexport class TableDatabase {\r\n  /** Stream that emits whenever the data has been modified. */\r\n  dataChange: BehaviorSubject<any[]> = new BehaviorSubject<any[]>([]);\r\n  get data(): any[] {\r\n    return this.dataChange.value;\r\n  }\r\n\r\n  constructor(data?) {\r\n    if (data) {\r\n      this.dataChange.next(data);\r\n    }\r\n  }\r\n\r\n  set(data) {\r\n    this.dataChange.next(data);\r\n  }\r\n\r\n  add(item) {\r\n    const copiedData = this.data.slice();\r\n    copiedData.push(item);\r\n    this.set(copiedData);\r\n  }\r\n\r\n  remove(item) {\r\n    const copiedData = this.data.slice();\r\n    const index = copiedData.indexOf(item);\r\n    copiedData.splice(index, 1);\r\n    this.set(copiedData);\r\n  }\r\n}\r\n","import { Tool } from './tool.interface';\r\nimport { ToolService } from './tool.service';\r\n\r\nexport function ToolComponent(tool: Partial<Tool>): (cls: any) => any {\r\n  return (compType: any) => {\r\n    ToolService.register(Object.assign({}, tool, {\r\n      component: compType\r\n    } as Tool));\r\n  };\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Workspace } from './workspace';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * workspaces.\r\n */\r\nexport class WorkspaceStore extends EntityStore<Workspace> {\r\n\r\n  activeWorkspace$: BehaviorSubject<Workspace> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Activate the an workspace workspace and deactivate the one currently active\r\n   * @param workspace Workspace\r\n   */\r\n  activateWorkspace(workspace: Workspace) {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n    }\r\n\r\n    this.deactivateWorkspace();\r\n    if (workspace !== undefined) {\r\n      this.state.update(workspace, {active: true, selected: true}, true);\r\n      this.activeWorkspace$.next(workspace);\r\n      workspace.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate the current workspace\r\n   * @param workspace Workspace\r\n   */\r\n  deactivateWorkspace() {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n      this.activeWorkspace$.next(undefined);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Subscription, BehaviorSubject, Subject } from 'rxjs';\r\n\r\nimport { ActionStore } from '../../action';\r\nimport { Widget } from '../../widget';\r\nimport { EntityStore } from '../../entity';\r\n\r\nimport { WorkspaceOptions } from './workspace.interfaces';\r\n\r\n/**\r\n * This class is responsible of managing the relations between\r\n * entities and the actions that consume them. It also defines an\r\n * entity table template that may be used by an entity table component.\r\n */\r\nexport class Workspace<E extends object = object> {\r\n\r\n  /**\r\n   * Observable of the selected widget\r\n   */\r\n  readonly widget$ = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the selected widget's inputs\r\n   */\r\n  readonly widgetInputs$ = new BehaviorSubject<{[key: string]: any}>({});\r\n\r\n  /**\r\n   * Observable of the selected widget's subscribers\r\n   */\r\n  readonly widgetSubscribers$ = new BehaviorSubject<{[key: string]: (event: any) => void}>({});\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * State change that trigger an update of the actions availability\r\n   */\r\n  private change: Subject<void> = new Subject();\r\n\r\n  /**\r\n   * Subscription to state changes\r\n   */\r\n  private change$: Subscription;\r\n\r\n  /**\r\n   * Workspace id\r\n   */\r\n  get id(): string { return this.options.id; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get title(): string { return this.options.title; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get meta(): {[key: string]: any} { return this.options.meta || {}; }\r\n\r\n  /**\r\n   * Entities store\r\n   */\r\n  get entityStore(): EntityStore<E> { return this.options.entityStore as EntityStore<E>; }\r\n\r\n  /**\r\n   * Actions store (some actions activate a widget)\r\n   */\r\n  get actionStore(): ActionStore { return this.options.actionStore; }\r\n\r\n  /**\r\n   * Selected widget\r\n   */\r\n  get widget(): Widget { return this.widget$.value; }\r\n\r\n  /**\r\n   * Whether a widget is selected\r\n   */\r\n  get hasWidget(): boolean { return this.widget !== undefined; }\r\n\r\n  constructor(protected options: WorkspaceOptions) {}\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Activate the workspace. By doing that, the workspace will observe\r\n   * the selected entity (from the store) and update the actions availability.\r\n   * For example, some actions require an entity to be selected.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.deactivate();\r\n    }\r\n    this.active$.next(true);\r\n\r\n    if (this.entityStore !== undefined) {\r\n      this.entities$$ = this.entityStore.stateView.all$()\r\n        .subscribe(() => this.onStateChange());\r\n    }\r\n\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the workspace. Unsubcribe to the selected entity.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.deactivateWidget();\r\n\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.change$ !== undefined) {\r\n      this.change$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a widget. In itself, activating a widget doesn't render it but,\r\n   * if an WorkspaceWidgetOutlet component is bound to this workspace, the widget will\r\n   * show up.\r\n   * @param widget Widget\r\n   * @param inputs Inputs the widget will receive\r\n   */\r\n  activateWidget(\r\n    widget: Widget,\r\n    inputs: {[key: string]: any} = {},\r\n    subscribers: {[key: string]: (event: any) => void} = {}\r\n  ) {\r\n    this.widget$.next(widget);\r\n    this.widgetInputs$.next(inputs);\r\n    this.widgetSubscribers$.next(subscribers);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate a widget.\r\n   */\r\n  deactivateWidget() {\r\n    this.widget$.next(undefined);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * When the state changes, update the actions availability.\r\n   */\r\n  private onStateChange() {\r\n    this.change.next();\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppHomeComponent } from './home.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'home',\r\n    component: AppHomeComponent\r\n  }\r\n];\r\n\r\nexport const AppHomeRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { InteractiveTourService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-home',\r\n  templateUrl: './home.component.html',\r\n  styleUrls: ['./home.component.scss']\r\n})\r\nexport class AppHomeComponent {\r\n  constructor(private interactiveTourService: InteractiveTourService) {}\r\n\r\n  startTour() {\r\n    this.interactiveTourService.startTour('global');\r\n  }\r\n}\r\n","<div style=\"text-align:center\">\r\n  <h1 id=\"igo-title\">\r\n    Welcome to IGO\r\n  </h1>\r\n  <img  class=\"igo-logo\" width=\"180\" src=\"assets/igo2/core/logo.png\">\r\n</div>\r\n\r\n<p>\r\n  <igo-interactive-tour\r\n    tourToStart = \"global\"\r\n    menuIsOpen = true\r\n    styleButton = \"raised\">\r\n  </igo-interactive-tour>\r\n</p>\r\n\r\n<p>\r\n  IGO2 library contains many components and services that may benefit any web application. <br>\r\n  IGO2 library is open source project using Angular, Angular Material and OpenLayers.\r\n</p>\r\n\r\n<h3>IGO2 library is divided into several elements: </h3>\r\n<ul>\r\n  <li><b>@igo2/utils</b> : Basic utilies without dependency (ex: base64, clipboard, uuid)</li>\r\n  <li><b>@igo2/core</b> : Element affecting the core of the application (ex: config, language, message, media, request)</li>\r\n  <li><b>@igo2/common</b> : Library containing reusable components (ex: clickout, drag-drop, list, panel, spinner, table)</li>\r\n  <li><b>@igo2/auth</b> : Library grouping the authentication and security module</li>\r\n  <li><b>@igo2/geo</b> : Library containing the geomatic components. Depends on Openlayers.</li>\r\n  <li><b>@igo2/context</b> : Library of components uniting @igo2/geo and @igo2/auth</li>\r\n  <li><b>@igo2/integration</b> : Library integrate basic components</li>\r\n</ul>\r\n\r\n<h2>Here are some links to help you start: </h2>\r\n<ul>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://github.com/infra-geo-ouverte/igo2-lib/blob/master/README.md#user-installation\">Installation</a></h2>\r\n  </li>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://angular.io/docs\">Angular Documentation</a></h2>\r\n  </li>\r\n</ul>\r\n\r\n*** Modules in <code>@igo2/core</code> must be imported only once\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { AppHomeComponent } from './home.component';\r\nimport { AppHomeRoutingModule } from './home-routing.module';\r\nimport { IgoInteractiveTourModule } from '@igo2/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHomeComponent],\r\n  imports: [\r\n    AppHomeRoutingModule,\r\n    IgoInteractiveTourModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule\r\n  ],\r\n  exports: [AppHomeComponent]\r\n})\r\nexport class AppHomeModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'activity',\r\n    component: AppActivityComponent\r\n  }\r\n];\r\n\r\nexport const AppActivityRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-activity',\r\n  templateUrl: './activity.component.html',\r\n  styleUrls: ['./activity.component.scss']\r\n})\r\nexport class AppActivityComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  register() {\r\n    this.idsActivity.push(this.activityService.register());\r\n  }\r\n\r\n  unregister() {\r\n    this.activityService.unregister(this.idsActivity.pop());\r\n  }\r\n\r\n  get counter() {\r\n    return this.activityService.counter$.value;\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Activity</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register activities in service. Use to display a loading icon</p>\r\n\r\n    <li>Import <code>IgoActivityModule</code> only if you want register http calls</li>\r\n    <li>Import <code>IgoActivityModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/activity\"> code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"register()\">Register</button>\r\n    <button mat-raised-button (click)=\"unregister()\">Unregister</button>\r\n  </mat-card-actions>\r\n  <p>Counter: {{counter}}</p>\r\n\r\n  <igo-spinner igoSpinnerActivity></igo-spinner>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActivityModule } from '@igo2/core';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\nimport { AppActivityRoutingModule } from './activity-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActivityComponent],\r\n  imports: [\r\n    AppActivityRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoActivityModule.forRoot(), // Only if you want register http calls\r\n    IgoSpinnerModule\r\n  ],\r\n  exports: [AppActivityComponent]\r\n})\r\nexport class AppActivityModule {}\r\n","interface Environment {\r\n  production: boolean;\r\n  igo: any;\r\n}\r\n\r\nexport const environment: Environment = {\r\n  production: true,\r\n  igo: {\r\n    projections: [\r\n      {\r\n        code: 'EPSG:32198',\r\n        alias: 'Quebec Lambert',\r\n        def:\r\n          '+proj=lcc +lat_1=60 +lat_2=46 +lat_0=44 +lon_0=-68.5 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs',\r\n        extent: [-886251.0296, 180252.9126, 897177.3418, 2106143.8139]\r\n      }\r\n    ],\r\n    auth: {\r\n      intern: {\r\n        enabled: true\r\n      },\r\n      allowAnonymous: true\r\n    },\r\n    interactiveTour: {\r\n      tourInMobile: true\r\n    },\r\n    importExport: {\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ogre'\r\n    },\r\n    language: {\r\n      prefix: './locale/'\r\n    },\r\n    catalog: {\r\n      sources: [\r\n        {\r\n          id: 'Gououvert',\r\n          title: 'Gouvouvert',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi'\r\n        },\r\n        {\r\n          id: 'DefiningInfoFormat',\r\n          title: 'Defining info_format',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          queryFormat: {\r\n            html: '*',\r\n            'application/json': [\r\n              'stations_meteoroutieres',\r\n              'histo_stations_meteoroutieres'\r\n            ]\r\n          },\r\n          queryHtmlTarget: 'iframe',\r\n          count: 30\r\n        },\r\n        {\r\n          id: 'catalogwithregex',\r\n          title: 'Filtered catalog by regex',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          regFilters: ['zpegt']\r\n        },\r\n        {\r\n          id: 'catalogwithtooltipcontrol',\r\n          title: 'Controling tooltip format',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          tooltipType: 'abstract' // or title\r\n        }\r\n      ]\r\n    },\r\n    searchSources: {\r\n      nominatim: {\r\n        enabled: false\r\n      },\r\n      icherche: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n        order: 2,\r\n        enabled: true,\r\n        params: {\r\n          limit: '8'\r\n        }\r\n      },\r\n      coordinatesreverse: {\r\n        showInPointerSummary: true\r\n      },\r\n      icherchereverse: {\r\n        showInPointerSummary: true,\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n        order: 3,\r\n        enabled: true\r\n      },\r\n      ilayer: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n        order: 4,\r\n        enabled: true,\r\n        params: {\r\n          limit: '5'\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppConfigComponent } from './config.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'config',\r\n    component: AppConfigComponent\r\n  }\r\n];\r\n\r\nexport const AppConfigRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { ConfigService, LanguageOptions } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-config',\r\n  templateUrl: './config.component.html',\r\n  styleUrls: ['./config.component.scss']\r\n})\r\nexport class AppConfigComponent {\r\n  public configLanguage: LanguageOptions;\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.configLanguage = this.configService.getConfig('language');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>config</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Load config in your angular application</p>\r\n\r\n    <li>Import <code>IgoConfigModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/config\"> code of this example</a> <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Config language: {{configLanguage | json }}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppConfigComponent } from './config.component';\r\nimport { AppConfigRoutingModule } from './config-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppConfigComponent],\r\n  imports: [\r\n    AppConfigRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoConfigModule.forRoot()\r\n  ],\r\n  exports: [AppConfigComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppConfigModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'language',\r\n    component: AppLanguageComponent\r\n  }\r\n];\r\n\r\nexport const AppLanguageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-language',\r\n  templateUrl: './language.component.html',\r\n  styleUrls: ['./language.component.scss']\r\n})\r\nexport class AppLanguageComponent {\r\n  public app = {\r\n    title: 'IGO'\r\n  };\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  changeLanguage(language: string) {\r\n    this.languageService.setLanguage(language);\r\n    console.log(this.languageService);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>language</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Translate your angular application</p>\r\n\r\n    <li>Import <code>IgoLanguageModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/language\">code of this example</a><br>\r\n    See language section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/locale\">locale files</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"changeLanguage('en')\">English</button>\r\n    <button mat-raised-button (click)=\"changeLanguage('fr')\">Français</button>\r\n  </mat-card-actions>\r\n\r\n  <p>{{'welcome' | translate: app}}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\nimport { AppLanguageRoutingModule } from './language-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLanguageComponent],\r\n  imports: [\r\n    AppLanguageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule.forRoot()\r\n  ],\r\n  exports: [AppLanguageComponent]\r\n})\r\nexport class AppLanguageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMediaComponent } from './media.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'media',\r\n    component: AppMediaComponent\r\n  }\r\n];\r\n\r\nexport const AppMediaRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-media',\r\n  templateUrl: './media.component.html',\r\n  styleUrls: ['./media.component.scss']\r\n})\r\nexport class AppMediaComponent {\r\n  constructor(private mediaService: MediaService) {}\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get orientation() {\r\n    return this.mediaService.getOrientation();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Media</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Detect type of media (mobile, tablet, desktop)</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/media\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Current media: {{media}}</p>\r\n  <p>Current orientation: {{orientation}}</p>\r\n  <p>Device mode:  {{isTouchScreen ? 'Touch device' : 'Not a touch device '}}</p>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { AppMediaComponent } from './media.component';\r\nimport { AppMediaRoutingModule } from './media-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMediaComponent],\r\n  imports: [AppMediaRoutingModule, MatCardModule],\r\n  exports: [AppMediaComponent]\r\n})\r\nexport class AppMediaModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMessageComponent } from './message.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'message',\r\n    component: AppMessageComponent\r\n  }\r\n];\r\n\r\nexport const AppMessageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MessageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-message',\r\n  templateUrl: './message.component.html',\r\n  styleUrls: ['./message.component.scss']\r\n})\r\nexport class AppMessageComponent {\r\n  constructor(private messageService: MessageService) {}\r\n\r\n  success() {\r\n    this.messageService.success('Congratulations', 'Success');\r\n  }\r\n\r\n  info() {\r\n    this.messageService.info('Welcome to IGO', 'Info');\r\n  }\r\n\r\n  alert() {\r\n    this.messageService.alert('Warning', 'Alert');\r\n  }\r\n  error() {\r\n    this.messageService.error('There is a bug', 'Error');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Message</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Show message to user.</p>\r\n\r\n    <li>Import <code>IgoMessageModule</code> only once</li>\r\n    <li>Dependencies: BrowserAnimationsModule </li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/message\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"success()\">Success message</button>\r\n    <button mat-raised-button color='primary' (click)=\"info()\">Info message</button>\r\n    <button mat-raised-button color='accent' (click)=\"alert()\">Alert message</button>\r\n    <button mat-raised-button color='warn' (click)=\"error()\">Error message</button>\r\n  </mat-card-actions>\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppMessageComponent } from './message.component';\r\nimport { AppMessageRoutingModule } from './message-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMessageComponent],\r\n  imports: [\r\n    AppMessageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule.forRoot()\r\n  ],\r\n  exports: [AppMessageComponent]\r\n})\r\nexport class AppMessageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppRequestComponent } from './request.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'request',\r\n    component: AppRequestComponent\r\n  }\r\n];\r\n\r\nexport const AppRequestRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-request',\r\n  templateUrl: './request.component.html',\r\n  styleUrls: ['./request.component.scss']\r\n})\r\nexport class AppRequestComponent {\r\n  constructor(\r\n    private http: HttpClient,\r\n    public languageService: LanguageService\r\n  ) {}\r\n\r\n  callHttp() {\r\n    const url = 'https://geoegl.msp.gouv.qc.ca/apis/icherche/info';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n\r\n  callHttpError() {\r\n    const url = '404';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Request</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register http calls in console</p>\r\n\r\n    <li>Import <code>IgoLoggingModule</code> only if you want register http calls in console</li>\r\n    <li>Import <code>IgoErrorModule</code> only if you want register errors from http call in console</li>\r\n    <li>Import modules only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/request\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"callHttp()\">Log</button>\r\n    <button mat-raised-button (click)=\"callHttpError()\">Error</button>\r\n  </mat-card-actions>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoErrorModule, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppRequestComponent } from './request.component';\r\nimport { AppRequestRoutingModule } from './request-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppRequestComponent],\r\n  imports: [\r\n    AppRequestRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    HttpClientModule,\r\n    IgoLanguageModule.forRoot(),\r\n    IgoErrorModule.forRoot() // Only if you want register errors from http call in console\r\n    // IgoLoggingModule.forRoot() // Only if you want register http calls in console\r\n  ],\r\n  exports: [AppRequestComponent]\r\n})\r\nexport class AppRequestModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/action\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n</mat-card>\r\n<p></p>\r\n\r\n<mat-card [igoContextMenu]= actionbarMenu>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action context-menu</mat-card-title>\r\n  <div></div>\r\n</mat-card>\r\n\r\n\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppActionComponent } from './action.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'action',\r\n    component: AppActionComponent\r\n  }\r\n];\r\n\r\nexport const AppActionRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  Media,\r\n  MediaOrientation,\r\n  MediaService,\r\n  LanguageService\r\n} from '@igo2/core';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\n\r\n@Component({\r\n  selector: 'app-action',\r\n  templateUrl: './action.component.html',\r\n  styleUrls: ['./action.component.scss']\r\n})\r\nexport class AppActionComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  private added$ = new BehaviorSubject(false);\r\n\r\n  get actionbarMode(): ActionbarMode {\r\n    const media = this.mediaService.media$.value;\r\n    const orientation = this.mediaService.orientation$.value;\r\n    if (media === Media.Desktop && orientation === MediaOrientation.Landscape) {\r\n      return ActionbarMode.Dock;\r\n    }\r\n    return ActionbarMode.Overlay;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'add',\r\n        title: 'Add',\r\n        icon: 'plus',\r\n        tooltip: 'Add Tooltip',\r\n        handler: () => {\r\n          alert('Add!');\r\n          this.added$.next(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'edit',\r\n        title: 'Edit',\r\n        icon: 'pencil',\r\n        tooltip: 'Edit Tooltip',\r\n        args: ['1'],\r\n        handler: (item: string) => {\r\n          alert(`Edit item ${item}!`);\r\n        },\r\n        availability: () => this.added$\r\n      },\r\n      {\r\n        id: 'delete',\r\n        title: 'Delete',\r\n        tooltip: 'Delete Tooltip',\r\n        icon: 'delete',\r\n        handler: () => {\r\n          alert('Delete!');\r\n          this.added$.next(false);\r\n        },\r\n        availability: () => this.added$\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActionModule, IgoContextMenuModule } from '@igo2/common';\r\n\r\nimport { AppActionComponent } from './action.component';\r\nimport { AppActionRoutingModule } from './action-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActionComponent],\r\n  imports: [\r\n    AppActionRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoActionModule,\r\n    IgoContextMenuModule\r\n  ],\r\n  exports: [AppActionComponent]\r\n})\r\nexport class AppActionModule {}\r\n","import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { OnUpdateInputs } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-component',\r\n  template: '<p>Hello, my name is {{name}}.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-explanation-component',\r\n  template: '<p>I am a dynamic component, rendered into an IgoDynamicOutlet.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppExplanationComponent implements OnUpdateInputs {\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-dynamic-component',\r\n  templateUrl: './dynamic-component.component.html',\r\n  styleUrls: ['./dynamic-component.component.scss']\r\n})\r\nexport class AppDynamicComponentComponent {\r\n\r\n  component: any = AppSalutationComponent;\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  toggleComponent() {\r\n    this.component = this.component === AppSalutationComponent ?\r\n      AppExplanationComponent :\r\n      AppSalutationComponent;\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDynamicComponentComponent } from './dynamic-component.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'dynamic-component',\r\n    component: AppDynamicComponentComponent\r\n  }\r\n];\r\n\r\nexport const AppDynamicComponentRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Dynamic Component</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/dynamic-component\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"component\"\r\n    [inputs]=\"inputs\">\r\n  </igo-dynamic-outlet>\r\n\r\n  <button mat-flat-button color=\"primary\" (click)=\"toggleComponent()\">Toggle Component</button>\r\n</mat-card>\r\n\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoDynamicComponentModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationComponent,\r\n  AppExplanationComponent,\r\n  AppDynamicComponentComponent\r\n} from './dynamic-component.component';\r\nimport { AppDynamicComponentRoutingModule } from './dynamic-component-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    AppSalutationComponent,\r\n    AppDynamicComponentComponent,\r\n    AppExplanationComponent\r\n  ],\r\n  imports: [\r\n    AppDynamicComponentRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [AppDynamicComponentComponent],\r\n  entryComponents: [\r\n    AppSalutationComponent,\r\n    AppExplanationComponent\r\n  ]\r\n})\r\nexport class AppDynamicComponentModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-table',\r\n    component: AppEntityTableComponent\r\n  }\r\n];\r\n\r\nexport const AppEntityTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  EntityStore,\r\n  EntityTableButton,\r\n  getEntityProperty,\r\n  EntityTableColumnRenderer,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss']\r\n})\r\nexport class AppEntityTableComponent implements OnInit, OnDestroy {\r\n  public store = new EntityStore([]);\r\n  public paginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public paginatorOptions: EntityTablePaginatorOptions = {pageSize: 10};\r\n\r\n  public template = {\r\n    selection: true,\r\n    selectionCheckbox: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    valueAccessor: (entity: object, name: string) => {\r\n      return getEntityProperty(entity, name);\r\n    },\r\n    columns: [\r\n      {\r\n        name: 'selected',\r\n        title: 'Selected',\r\n        valueAccessor: (entity: object) => {\r\n          return this.store.state.get(entity).selected\r\n            ? 'radiobox-marked'\r\n            : 'radiobox-blank';\r\n        },\r\n        renderer: EntityTableColumnRenderer.Icon\r\n      },\r\n      {\r\n        name: 'id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        renderer: EntityTableColumnRenderer.HTML\r\n      },\r\n      {\r\n        name: 'url',\r\n        title: 'Hyperlink'\r\n      },\r\n      {\r\n        name: 'image',\r\n        title: 'Image'\r\n      },\r\n      {\r\n        name: 'action',\r\n        title: '',\r\n        valueAccessor: (entity: object) => {\r\n          return [{\r\n            icon: 'home',\r\n            color: 'warn',\r\n            click: (row) => { console.log(row); }\r\n          }] as EntityTableButton[];\r\n        },\r\n        renderer: EntityTableColumnRenderer.ButtonGroup\r\n      }\r\n    ]\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    const ids = [2, 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];\r\n\r\n    const entities = ids.map(id => {\r\n      return { id , name: `Name ${id}`, description: `<b>Description ${id}</b>`, url: 'https://igouverte.org', image: 'https://www.igouverte.org/assets/img/Igo_logoavec.png'};\r\n    });\r\n    this.store.load(entities);\r\n  }\r\n\r\n  entitySortChange() {\r\n    this.entitySortChange$.next(true);\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-table\">code of this example</a>\r\n  </mat-card-content>\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [withPaginator]=\"true\"\r\n    [paginatorOptions]=\"paginatorOptions\"\r\n    [template]=\"template\"\r\n    (entitySortChange)=\"entitySortChange()\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntityTableModule, IgoEntityTablePaginatorModule } from '@igo2/common';\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\nimport { AppEntityTableRoutingModule } from './entity-table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntityTableComponent],\r\n  imports: [\r\n    AppEntityTableRoutingModule,\r\n    MatCardModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  exports: [AppEntityTableComponent]\r\n})\r\nexport class AppEntityTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Selector</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-selector\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-entity-selector\r\n    [store]=\"store\"\r\n    [titleAccessor]=\"getTitle\"\r\n    [emptyText]=\"''\"\r\n    [placeholder]=\"'Select an entity'\"\r\n    (selectedChange)=\"onSelectedChange($event)\">\r\n  </igo-entity-selector>\r\n\r\n  <div *ngIf=\"selected$ | async as selected\">\r\n    <p>ID: {{selected.id}}</p>\r\n    <p>Name: {{selected.name}}</p>\r\n    <p>Description: <span [innerHtml]=\"selected.description\"></span></p>\r\n  </div>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-selector',\r\n    component: AppEntitySelectorComponent\r\n  }\r\n];\r\n\r\nexport const AppEntitySelectorRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\ninterface DemoEntity {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'app-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss']\r\n})\r\nexport class AppEntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  public store = new EntityStore([]);\r\n\r\n  public selected$ = new BehaviorSubject<DemoEntity>(undefined);\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {id: '2', name: 'Name 2', description: '<b>Description 2</b>'},\r\n      {id: '1', name: 'Name 1', description: '<b>Description 1</b>'},\r\n      {id: '3', name: 'Name 3', description: '<b>Description 3</b>'}\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  getTitle(entity: DemoEntity): string {\r\n    return entity.name;\r\n  }\r\n\r\n  onSelectedChange(event: {selected: boolean; entity: DemoEntity}) {\r\n    this.selected$.next(event.entity);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntitySelectorModule } from '@igo2/common';\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\nimport { AppEntitySelectorRoutingModule } from './entity-selector-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntitySelectorComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppEntitySelectorRoutingModule,\r\n    MatCardModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [AppEntitySelectorComponent]\r\n})\r\nexport class AppEntitySelectorModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFormComponent } from './form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'form',\r\n    component: AppFormComponent\r\n  }\r\n];\r\n\r\nexport const AppFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss']\r\n})\r\nexport class AppFormComponent implements OnInit, OnDestroy {\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private formService: FormService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        options:  {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options:  {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'status',\r\n        title: 'Status',\r\n        type: 'select',\r\n        options:  {\r\n          cols: 2\r\n        },\r\n        inputs: {\r\n          choices: [\r\n            {value: 1, title: 'Single'},\r\n            {value: 2, title: 'Married'}\r\n          ]\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      id: 1,\r\n      name: 'Bob',\r\n      status: 2\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { AppFormComponent } from './form.component';\r\nimport { AppFormRoutingModule } from './form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFormComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppFormRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [AppFormComponent]\r\n})\r\nexport class AppFormModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTableComponent } from './table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'table',\r\n    component: AppTableComponent\r\n  }\r\n];\r\n\r\nexport const AppTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { TableDatabase, TableActionColor } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class AppTableComponent implements OnInit {\r\n  public database: TableDatabase;\r\n\r\n  public model = {\r\n    columns: [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        sortable: false,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        sortable: true,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        sortable: true,\r\n        filterable: true\r\n      }\r\n    ],\r\n    actions: [\r\n      {\r\n        icon: 'file-document',\r\n        color: TableActionColor.primary,\r\n        click: row => this.showName(row.name)\r\n      }\r\n    ],\r\n    selectionCheckbox: true\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.database = new TableDatabase([\r\n      { id: '2', name: 'Name 2', description: 'Hello 2' },\r\n      { id: '1', name: 'Name 1', description: 'Bonjour 1' },\r\n      { id: '3', name: 'Name 3', description: 'Hola 3' }\r\n    ]);\r\n  }\r\n\r\n  showName(name) {\r\n    alert(name);\r\n  }\r\n\r\n  handleSelect(rows) {\r\n    console.log(rows);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/table\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-table\r\n    [database]=\"database\"\r\n    [model]=\"model\"\r\n    [hasFilterInput]=\"true\"\r\n    (select)=\"handleSelect($event)\">\r\n  </igo-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoTableModule } from '@igo2/common';\r\n\r\nimport { AppTableComponent } from './table.component';\r\nimport { AppTableRoutingModule } from './table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTableComponent],\r\n  imports: [\r\n    AppTableRoutingModule,\r\n    MatCardModule,\r\n    IgoTableModule\r\n  ],\r\n  exports: [AppTableComponent]\r\n})\r\nexport class AppTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Tool</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/tool\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-panel [title]=\"panelTitle\">\r\n    <button\r\n      mat-icon-button\r\n      panelLeftButton\r\n      (click)=\"toolbox.activatePreviousTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"arrow-back\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      panelRightButton\r\n      (click)=\"toolbox.deactivateTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"menu\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-toolbox [toolbox]=\"toolbox\" [animate]=\"true\"></igo-toolbox>\r\n  </igo-panel>\r\n\r\n  <button\r\n    mat-flat-button\r\n    type=\"button\"\r\n    color=\"primary\"\r\n    (click)=\"activateSalutationTool()\">\r\n    Activate Salutation Tool\r\n  </button>\r\n\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  OnUpdateInputs,\r\n  Tool,\r\n  Toolbox,\r\n  ToolComponent,\r\n  ToolService\r\n} from '@igo2/common';\r\n\r\n@ToolComponent({\r\n  name: 'demo-salutation',\r\n  title: 'Salutation',\r\n  icon: 'account',\r\n  options: {name: 'Jack'}\r\n})\r\n@Component({\r\n  selector: 'app-salutation-tool',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationToolComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@ToolComponent({\r\n  name: 'demo-about',\r\n  title: 'About',\r\n  icon: 'information'\r\n})\r\n@Component({\r\n  selector: 'app-about-tool',\r\n  template: `\r\n    <p>I'm a tool inside a toolbox.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppAboutToolComponent {}\r\n\r\n@Component({\r\n  selector: 'app-tool',\r\n  templateUrl: './tool.component.html',\r\n  styleUrls: ['./tool.component.scss']\r\n})\r\nexport class AppToolComponent implements OnInit, OnDestroy {\r\n\r\n  toolbox = new Toolbox();\r\n\r\n  get activeTool$(): BehaviorSubject<Tool> {\r\n    return this.toolbox.activeTool$;\r\n  }\r\n\r\n  get panelTitle(): string {\r\n    return this.activeTool$.value ? this.activeTool$.value.title : 'Toolbox';\r\n  }\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.toolbox.setToolbar(['demo-salutation', 'demo-about']);\r\n    this.toolbox.setTools(this.toolService.getTools());\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.toolbox.destroy();\r\n  }\r\n\r\n  activateSalutationTool() {\r\n    this.toolbox.activateTool('demo-salutation', {name: 'Bob'});\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppToolComponent } from './tool.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'tool',\r\n    component: AppToolComponent\r\n  }\r\n];\r\n\r\nexport const AppToolRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoPanelModule, IgoToolModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppToolComponent,\r\n  AppSalutationToolComponent,\r\n  AppAboutToolComponent\r\n} from './tool.component';\r\nimport { AppToolRoutingModule } from './tool-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    AppToolComponent,\r\n    AppSalutationToolComponent,\r\n    AppAboutToolComponent\r\n  ],\r\n  imports: [\r\n    CommonModule,\r\n    AppToolRoutingModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatCardModule,\r\n    IgoLanguageModule,\r\n    IgoPanelModule,\r\n    IgoToolModule.forRoot()\r\n  ],\r\n  exports: [AppToolComponent],\r\n  entryComponents: [\r\n    AppSalutationToolComponent,\r\n    AppAboutToolComponent\r\n  ]\r\n})\r\nexport class AppToolModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent, OnUpdateInputs, WidgetComponent, WidgetService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-widget',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n    <button mat-flat-button (click)=\"complete.emit(name)\">Nice to meet you</button>\r\n    <button mat-flat-button (click)=\"cancel.emit(name)\">Dismiss</button>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationWidgetComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() name: string;\r\n\r\n  @Output() complete = new EventEmitter<string>();\r\n\r\n  @Output() cancel = new EventEmitter<string>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-widget',\r\n  templateUrl: './widget.component.html',\r\n  styleUrls: ['./widget.component.scss']\r\n})\r\nexport class AppWidgetComponent {\r\n\r\n  widget: DynamicComponent<WidgetComponent> = this.widgetService.create(AppSalutationWidgetComponent);\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  constructor(private widgetService: WidgetService) {}\r\n\r\n  onWidgetComplete(name: string) {\r\n    alert(`${name} emitted event 'complete' then got automatically destroyed.`);\r\n  }\r\n\r\n  onWidgetCancel() {\r\n    alert(`Widget emitted event 'cancel' then got automatically destroyed.`);\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWidgetComponent } from './widget.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'widget',\r\n    component: AppWidgetComponent\r\n  }\r\n];\r\n\r\nexport const AppWidgetRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Widget</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/widget\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"inputs\"\r\n    (complete)=\"onWidgetComplete($event)\"\r\n    (cancel)=\"onWidgetCancel()\">\r\n  </igo-widget-outlet>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationWidgetComponent,\r\n  AppWidgetComponent\r\n} from './widget.component';\r\nimport { AppWidgetRoutingModule } from './widget-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    AppSalutationWidgetComponent,\r\n    AppWidgetComponent\r\n  ],\r\n  imports: [\r\n    AppWidgetRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoWidgetModule\r\n  ],\r\n  exports: [AppWidgetComponent],\r\n  entryComponents: [\r\n    AppSalutationWidgetComponent\r\n  ]\r\n})\r\nexport class AppWidgetModule {}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport jwtDecode from 'jwt-decode';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class TokenService {\r\n  private options: AuthOptions;\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  set(token: string) {\r\n    localStorage.setItem(this.tokenKey, token);\r\n  }\r\n\r\n  remove() {\r\n    localStorage.removeItem(this.tokenKey);\r\n  }\r\n\r\n  get(): string {\r\n    return localStorage.getItem(this.tokenKey);\r\n  }\r\n\r\n  decode() {\r\n    const token = this.get();\r\n    if (!token) {\r\n      return;\r\n    }\r\n    return jwtDecode(token);\r\n  }\r\n\r\n  isExpired() {\r\n    const jwt = this.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n    if (jwt && currentTime < jwt.exp) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private get tokenKey() {\r\n    const config = this.injector.get<ConfigService>(ConfigService);\r\n    this.options = config.getConfig('auth') || {};\r\n    return this.options.tokenKey;\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\nimport { Router } from '@angular/router';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { tap, catchError } from 'rxjs/operators';\r\nimport { globalCacheBusterNotifier } from 'ts-cacheable';\r\n\r\nimport { ConfigService, LanguageService, MessageService } from '@igo2/core';\r\nimport { Base64 } from '@igo2/utils';\r\n\r\nimport { User, IInfosUser } from './auth.interface';\r\nimport { TokenService } from './token.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  public authenticate$ = new BehaviorSubject<boolean>(undefined);\r\n  public logged$ = new BehaviorSubject<boolean>(undefined);\r\n  public redirectUrl: string;\r\n  private anonymous = false;\r\n\r\n  get hasAuthService() {\r\n    return this.config.getConfig('auth.url') !== undefined;\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private tokenService: TokenService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.authenticate$.next(this.authenticated);\r\n    this.authenticate$.subscribe((authenticated) => {\r\n      this.logged$.next(authenticated);\r\n      globalCacheBusterNotifier.next();\r\n    });\r\n  }\r\n\r\n  login(username: string, password: string): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      username,\r\n      password: this.encodePassword(password)\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginWithToken(token: string, type: string, infosUser?: IInfosUser): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      token,\r\n      typeConnection: type,\r\n      infosUser\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginAnonymous(): Observable<boolean> {\r\n    this.anonymous = true;\r\n    this.logged$.next(true);\r\n    return of(true);\r\n  }\r\n\r\n  refresh(): Observable<void> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/refresh`, {}).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  logout(): Observable<boolean> {\r\n    this.anonymous = false;\r\n    this.tokenService.remove();\r\n    this.authenticate$.next(false);\r\n    return of(true);\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return !this.tokenService.isExpired();\r\n  }\r\n\r\n  getToken(): string {\r\n    return this.tokenService.get();\r\n  }\r\n\r\n  decodeToken() {\r\n    if (this.isAuthenticated()) {\r\n      return this.tokenService.decode();\r\n    }\r\n    return false;\r\n  }\r\n\r\n  goToRedirectUrl() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n    const redirectUrl = this.redirectUrl || this.router.url;\r\n\r\n    const options = this.config.getConfig('auth') || {};\r\n    if (redirectUrl === options.loginRoute) {\r\n      const homeRoute = options.homeRoute || '/';\r\n      this.router.navigateByUrl(homeRoute);\r\n    } else if (redirectUrl) {\r\n      this.router.navigateByUrl(redirectUrl);\r\n    }\r\n  }\r\n\r\n  getUserInfo(): Observable<User> {\r\n    const url = this.config.getConfig('auth.url') + '/info';\r\n    return this.http.get<User>(url);\r\n  }\r\n\r\n  getProfils(): Observable<{ profils: string[] }> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.get<{ profils: string[] }>(`${url}/profils`);\r\n  }\r\n\r\n  updateUser(user: User): Observable<User> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.patch<User>(url, user);\r\n  }\r\n\r\n  private encodePassword(password: string) {\r\n    return Base64.encode(password);\r\n  }\r\n\r\n  // authenticated or anonymous\r\n  get logged(): boolean {\r\n    return this.authenticated || this.isAnonymous;\r\n  }\r\n\r\n  get isAnonymous(): boolean {\r\n    return this.anonymous;\r\n  }\r\n\r\n  get authenticated(): boolean {\r\n    return this.isAuthenticated();\r\n  }\r\n\r\n  get isAdmin(): boolean {\r\n    const token = this.decodeToken();\r\n    if (token && token.user && token.user.isAdmin) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private loginCall(body, headers) {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/login`, body, { headers }).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n        const tokenDecoded = this.decodeToken();\r\n        if (tokenDecoded && tokenDecoded.user) {\r\n          if (tokenDecoded.user.locale) {\r\n            this.languageService.setLanguage(tokenDecoded.user.locale);\r\n          }\r\n          if (tokenDecoded.user.isExpired) {\r\n            this.languageService.translate\r\n              .get('igo.auth.error.Password expired')\r\n              .subscribe((expiredAlert) =>\r\n                this.messageService.alert(expiredAlert)\r\n              );\r\n          }\r\n        }\r\n        this.authenticate$.next(true);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { AuthGoogleOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-google',\r\n  templateUrl: './auth-google.component.html',\r\n  styleUrls: ['./auth-google.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthGoogleComponent {\r\n  private options: AuthGoogleOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.google') || {};\r\n\r\n    if (this.options.apiKey && this.options.clientId) {\r\n      this.loadSDKGoogle();\r\n      this.loadPlatform();\r\n    } else {\r\n      console.warn('Google authentification needs \"apiKey\" and \"clientId\" options');\r\n    }\r\n  }\r\n\r\n  public handleSignInClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signIn();\r\n  }\r\n\r\n  public handleSignOutClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signOut();\r\n  }\r\n\r\n  private handleClientLoad() {\r\n    (window as any).gapi.load('client:auth2', () => this.initClient());\r\n  }\r\n\r\n  private initClient() {\r\n    (window as any).gapi.client\r\n      .init({\r\n        apiKey: this.options.apiKey,\r\n        clientId: this.options.clientId,\r\n        discoveryDocs: [\r\n          'https://people.googleapis.com/$discovery/rest?version=v1'\r\n        ],\r\n        scope: 'profile'\r\n      })\r\n      .then(() => {\r\n        this.handleSignOutClick();\r\n        this.updateTextButton();\r\n        (window as any).gapi.auth2.getAuthInstance().isSignedIn.listen(rep => {\r\n          this.updateSigninStatus(rep);\r\n        });\r\n      });\r\n  }\r\n\r\n  private updateSigninStatus(isSignedIn) {\r\n    this.updateTextButton();\r\n    if (isSignedIn) {\r\n      this.loginGoogle((window as any).gapi.client.getToken().access_token);\r\n    }\r\n  }\r\n\r\n  private updateTextButton() {\r\n    const btn = document.querySelector('span[id^=\"not_signed_\"]');\r\n    if (btn && this.languageService.getLanguage() !== 'en') {\r\n      if (btn.innerHTML === 'Sign in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.login');\r\n      } else if (btn.innerHTML === 'Signed in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.logged');\r\n      }\r\n    }\r\n  }\r\n\r\n  private loginGoogle(token) {\r\n    this.authService.loginWithToken(token, 'google').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKGoogle() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-jssdk';\r\n    js.src = 'https://apis.google.com/js/api.js';\r\n    js.onload = () => {\r\n      this.handleClientLoad();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n\r\n  private loadPlatform() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-platform';\r\n    js.src = 'https://apis.google.com/js/platform.js';\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div class=\"g-signin2 google-login-button\" data-height=\"40\" data-width=\"265\" data-longtitle=\"true\">\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\nimport { MsalBroadcastService, MsalService, MSAL_GUARD_CONFIG} from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoft',\r\n  templateUrl: './auth-microsoft.component.html',\r\n  styleUrls: ['./auth-microsoft.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftComponent {\r\n  private options: AuthMicrosoftOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastService;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalService,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n    this.options = this.config.getConfig('auth.microsoft') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastService(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoft() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const tokenAccess = response.accessToken;\r\n        const tokenId = response.idToken;\r\n        this.authService.loginWithToken(tokenAccess, 'microsoft', { tokenId } ).subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        console.log(error);\r\n      }).catch(error => {\r\n        console.log('Silent token fails');\r\n      });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'add')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoft()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoft.login' | translate}}\r\n</button>\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { Location } from '@angular/common';\r\nimport {\r\n    IPublicClientApplication,\r\n    EndSessionRequest,\r\n    EndSessionPopupRequest,\r\n    AuthenticationResult,\r\n    RedirectRequest,\r\n    SilentRequest,\r\n    PopupRequest,\r\n    SsoSilentRequest,\r\n    Logger,\r\n    WrapperSKU\r\n} from '@azure/msal-browser';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { Observable, from } from 'rxjs';\r\nimport { IMsalService } from '@azure/msal-angular';\r\n\r\n@Injectable()\r\nexport class MsalServiceb2c implements IMsalService {\r\n    private redirectHash: string;\r\n    private logger: Logger;\r\n    private name = '@azure/msal-angular';\r\n    private version = '2.0.0-beta.2';\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) public instance: IPublicClientApplication,\r\n        private location: Location\r\n    ) {\r\n        const hash = this.location.path(true).split('#').pop();\r\n        if (hash) {\r\n            this.redirectHash = `#${hash}`;\r\n        }\r\n        this.instance.initializeWrapperLibrary(WrapperSKU.Angular, this.version);\r\n    }\r\n\r\n    acquireTokenPopup(request: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenPopup(request));\r\n    }\r\n    acquireTokenRedirect(request: RedirectRequest): Observable<void> {\r\n        return from(this.instance.acquireTokenRedirect(request));\r\n    }\r\n    acquireTokenSilent(silentRequest: SilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenSilent(silentRequest));\r\n    }\r\n    handleRedirectObservable(hash?: string): Observable<AuthenticationResult> {\r\n        return from(this.instance.handleRedirectPromise(hash || this.redirectHash));\r\n    }\r\n    loginPopup(request?: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.loginPopup(request));\r\n    }\r\n    loginRedirect(request?: RedirectRequest): Observable<void> {\r\n        return from(this.instance.loginRedirect(request));\r\n    }\r\n    logout(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logout(logoutRequest));\r\n    }\r\n    logoutRedirect(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logoutRedirect(logoutRequest));\r\n    }\r\n    logoutPopup(logoutRequest?: EndSessionPopupRequest): Observable<void> {\r\n        return from(this.instance.logoutPopup(logoutRequest));\r\n    }\r\n    ssoSilent(request: SsoSilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.ssoSilent(request));\r\n    }\r\n    /**\r\n     * Gets logger for msal-angular.\r\n     * If no logger set, returns logger instance created with same options as msal-browser\r\n     */\r\n    getLogger(): Logger {\r\n        if (!this.logger) {\r\n            this.logger = this.instance.getLogger().clone(this.name, this.version);\r\n        }\r\n        return this.logger;\r\n    }\r\n    // Create a logger instance for msal-angular with the same options as msal-browser\r\n    setLogger(logger: Logger): void {\r\n        this.logger = logger.clone(this.name, this.version);\r\n        this.instance.setLogger(logger);\r\n    }\r\n\r\n}\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { BehaviorSubject, Observable, Subject } from 'rxjs';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { EventMessage, EventMessageUtils, IPublicClientApplication, InteractionStatus } from '@azure/msal-browser';\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\n@Injectable()\r\nexport class MsalBroadcastServiceb2c {\r\n    private _msalSubject: Subject<EventMessage>;\r\n    public msalSubject$: Observable<EventMessage>;\r\n    private _inProgress: BehaviorSubject<InteractionStatus>;\r\n    public inProgress$: Observable<InteractionStatus>;\r\n\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) private msalInstance: IPublicClientApplication,\r\n        private authService: MsalServiceb2c\r\n    ) {\r\n        this._msalSubject = new Subject<EventMessage>();\r\n        this.msalSubject$ = this._msalSubject.asObservable();\r\n\r\n        // InProgress as BehaviorSubject so most recent inProgress state will be available upon subscription\r\n        this._inProgress = new BehaviorSubject<InteractionStatus>(InteractionStatus.Startup);\r\n        this.inProgress$ = this._inProgress.asObservable();\r\n\r\n        this.msalInstance.addEventCallback((message: EventMessage) => {\r\n            this._msalSubject.next(message);\r\n            const status = EventMessageUtils.getInteractionStatusFromEvent(message);\r\n            if (status !== null) {\r\n                this.authService.getLogger().verbose(`BroadcastService - ${message.eventType} results in setting inProgress to ${status}`);\r\n                this._inProgress.next(status);\r\n            }\r\n        });\r\n    }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\n\r\nimport { MSAL_GUARD_CONFIG } from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftb2cOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\nimport { MsalBroadcastServiceb2c } from '../shared/auth-msalBroadcastServiceb2c.service';\r\nimport { MsalServiceb2c } from '../shared/auth-msalServiceb2c.service.';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoftb2c',\r\n  templateUrl: './auth-microsoftb2c.component.html',\r\n  styleUrls: ['./auth-microsoftb2c.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftb2cComponent {\r\n  private options: AuthMicrosoftb2cOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastServiceb2c;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalServiceb2c,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n\r\n    this.options = this.config.getConfig('auth.microsoftb2c') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options.browserAuthOptions,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastServiceb2c(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.browserAuthOptions.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoftb2c() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const token = response.idToken;\r\n        this.authService.loginWithToken(token, 'microsoftb2c').subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        }).catch(error => {\r\n          console.log('Silent token fails');\r\n        });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'b2c')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoftb2c()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoftb2c.login' | translate}}\r\n</button>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthFacebookOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-facebook',\r\n  templateUrl: './auth-facebook.component.html',\r\n  styleUrls: ['./auth-facebook.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthFacebookComponent {\r\n  private options: AuthFacebookOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.facebook') || {};\r\n\r\n    if (this.options.appId) {\r\n      this.loadSDKFacebook();\r\n    } else {\r\n      console.warn('Facebook authentification needs \"appId\" option');\r\n    }\r\n  }\r\n\r\n  private subscribeEvents() {\r\n    (window as any).FB.Event.subscribe('auth.statusChange', rep => {\r\n      this.statusChangeCallback(rep);\r\n    });\r\n  }\r\n\r\n  private statusChangeCallback(response) {\r\n    if (response.status === 'connected') {\r\n      const accessToken = response.authResponse.accessToken;\r\n      this.loginFacebook(accessToken);\r\n    }\r\n  }\r\n\r\n  private loginFacebook(token) {\r\n    this.authService.loginWithToken(token, 'facebook').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKFacebook() {\r\n    if (document.getElementById('facebook-jssdk')) {\r\n      return;\r\n    }\r\n\r\n    const urlSDK =\r\n      'https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v2.9';\r\n\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'facebook-jssdk';\r\n    js.src = `${urlSDK}&appId=${this.options.appId}`;\r\n    js.onload = () => {\r\n      this.subscribeEvents();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div scope=\"public_profile,email\"\r\n     class=\"fb-login-button\" data-max-rows=\"1\" data-size=\"large\"\r\n     data-button-type=\"login_with\" data-show-faces=\"false\"\r\n     data-auto-logout-link=\"false\" data-use-continue-as=\"false\">\r\n</div>\r\n","<form [formGroup]=\"form\" role=\"form\" (ngSubmit)=\"loginUser(form.value)\">\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required placeholder=\"{{'igo.auth.user' | translate}}\" formControlName=\"username\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required type=\"password\" placeholder=\"{{'igo.auth.password' | translate}}\" formControlName=\"password\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button mat-raised-button type=\"submit\">{{'igo.auth.login' | translate}}</button>\r\n  <button *ngIf=\"allowAnonymous\" mat-raised-button class=\"anonymous\" type=\"button\" [disabled]=\"loading\" (click)=\"loginAnonymous()\">\r\n    {{'igo.auth.accessAnonymous' | translate }}\r\n  </button>\r\n  <div *ngIf=\"error\">\r\n    <br/>\r\n    <font size=\"3\" color=\"red\">{{error}}</font>\r\n  </div>\r\n</form>\r\n\r\n<!--\r\nThis part was removed from the below line to fix Angular issue 30616 : [disabled]=\"!form.valid || loading\r\n  <button mat-raised-button type=\"submit\" [disabled]=\"!form.valid || loading\">{{'igo.auth.login' | translate}}</button>*/\r\n-->\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Validators, FormGroup, FormBuilder } from '@angular/forms';\r\n\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-auth-intern',\r\n  templateUrl: './auth-intern.component.html',\r\n  styleUrls: ['./auth-intern.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthInternComponent {\r\n  @Input()\r\n  get allowAnonymous(): boolean {\r\n    return this._allowAnonymous;\r\n  }\r\n  set allowAnonymous(value: boolean) {\r\n    this._allowAnonymous = value;\r\n  }\r\n  private _allowAnonymous = true;\r\n\r\n  public error = '';\r\n  public form: FormGroup;\r\n  public loading = false;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private languageService: LanguageService,\r\n    fb: FormBuilder\r\n  ) {\r\n    this.form = fb.group({\r\n      username: ['', Validators.required],\r\n      password: ['', Validators.required]\r\n    });\r\n  }\r\n\r\n  loginUser(values: any) {\r\n    this.loading = true;\r\n    this.auth.login(values.username, values.password).subscribe(\r\n      () => {\r\n        this.login.emit(true);\r\n        this.loading = false;\r\n      },\r\n      (error: any) => {\r\n        try {\r\n          this.languageService.translate\r\n            .get('igo.auth.error.' + error.error.message)\r\n            .subscribe(errorMsg => (this.error = errorMsg));\r\n        } catch (e) {\r\n          this.error = error.error.message;\r\n        }\r\n        this.loading = false;\r\n      }\r\n    );\r\n    return false;\r\n  }\r\n\r\n  loginAnonymous() {\r\n    this.auth.loginAnonymous().subscribe(() => {\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n}\r\n","<div *ngIf=\"visible\">\r\n  <div *ngIf=\"!auth.logged && backgroundDisable\" class=\"backgroundDisable\"></div>\r\n\r\n  <div *ngIf=\"!auth.logged && showLoginDiv\" class=\"login center-block\">\r\n    <h1>{{'igo.auth.connection' | translate}}</h1>\r\n\r\n    <igo-auth-google\r\n      *ngIf=\"options.google && options.google.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-google>\r\n    <igo-auth-microsoft\r\n      *ngIf=\"options.microsoft && options.microsoft.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoft>\r\n    <igo-auth-microsoftb2c\r\n      *ngIf=\"options.microsoftb2c && options.microsoftb2c.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoftb2c>\r\n    <igo-auth-facebook\r\n      *ngIf=\"options.facebook && options.facebook.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-facebook>\r\n    <igo-auth-intern\r\n      *ngIf=\"!options.intern || options.intern.enabled !== false\"\r\n      [allowAnonymous]=\"options.allowAnonymous\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-intern>\r\n  </div>\r\n\r\n  <div *ngIf=\"auth.logged && showAlreadyConnectedDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.welcome' | translate: user}}</p>\r\n    <button mat-raised-button type=\"button\" (click)=\"logout()\">{{'igo.auth.signOut' | translate}}</button>\r\n  </div>\r\n\r\n  <div *ngIf=\"showLogoutDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.deconnection' | translate}}</p>\r\n    <button *ngIf=\"options.homeRoute\" mat-raised-button type=\"button\" (click)=\"home()\">{{'igo.auth.home' | translate}}</button>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  Input,\r\n  Optional,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Router, NavigationStart } from '@angular/router';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthFormComponent implements OnInit {\r\n  @Input()\r\n  get backgroundDisable(): boolean {\r\n    if (this.isLogoutRoute || this.isLogoutRoute) {\r\n      return false;\r\n    }\r\n    return this._backgroundDisable;\r\n  }\r\n  set backgroundDisable(value: boolean) {\r\n    this._backgroundDisable = value.toString() === 'true';\r\n  }\r\n  private _backgroundDisable = true;\r\n\r\n  @Input()\r\n  get hasAlreadyConnectedDiv(): boolean {\r\n    return this._hasAlreadyConnectedDiv;\r\n  }\r\n  set hasAlreadyConnectedDiv(value: boolean) {\r\n    this._hasAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _hasAlreadyConnectedDiv = true;\r\n\r\n  @Input()\r\n  get hasLogoutDiv(): boolean {\r\n    return this._hasLogoutDiv;\r\n  }\r\n  set hasLogoutDiv(value: boolean) {\r\n    this._hasLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _hasLogoutDiv = true;\r\n\r\n  @Input()\r\n  get showAlreadyConnectedDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasAlreadyConnectedDiv;\r\n    }\r\n    return this._showAlreadyConnectedDiv;\r\n  }\r\n  set showAlreadyConnectedDiv(value: boolean) {\r\n    this._showAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _showAlreadyConnectedDiv = false;\r\n\r\n  @Input()\r\n  get showLogoutDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasLogoutDiv;\r\n    }\r\n    return this._showLogoutDiv;\r\n  }\r\n  set showLogoutDiv(value: boolean) {\r\n    this._showLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _showLogoutDiv = false;\r\n\r\n  get showLoginDiv(): boolean {\r\n    if (!this.isLogoutRoute) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  public options: AuthOptions;\r\n  public user;\r\n\r\n  public visible = true;\r\n\r\n  private isLoginRoute: boolean;\r\n  private isLogoutRoute: boolean;\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private config: ConfigService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.options = this.config.getConfig('auth') || {};\r\n    this.visible = Object.getOwnPropertyNames(this.options).length !== 0;\r\n  }\r\n\r\n  public ngOnInit() {\r\n    this.analyzeRoute();\r\n    this.getName();\r\n  }\r\n\r\n  public onLogin() {\r\n    this.auth.goToRedirectUrl();\r\n    this.getName();\r\n    this.login.emit(true);\r\n  }\r\n\r\n  public logout() {\r\n    this.auth.logout().subscribe(() => {\r\n      this.user = undefined;\r\n      if (this.router) {\r\n        if (this.options.logoutRoute) {\r\n          this.router.navigate([this.options.logoutRoute]);\r\n        } else if (this.options.homeRoute) {\r\n          this.router.navigate([this.options.homeRoute]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public home() {\r\n    if (this.router && this.options.homeRoute) {\r\n      this.router.navigate([this.options.homeRoute]);\r\n    }\r\n  }\r\n\r\n  private getName() {\r\n    const tokenDecoded = this.auth.decodeToken();\r\n    if (tokenDecoded) {\r\n      this.user = {\r\n        name: tokenDecoded.user.firstName || tokenDecoded.user.sourceId\r\n      };\r\n    }\r\n  }\r\n\r\n  private analyzeRoute() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n\r\n    this.router.events\r\n      .pipe(filter((event) => event instanceof NavigationStart))\r\n      .subscribe((changeEvent: any) => {\r\n        if (changeEvent.url) {\r\n          const currentRoute = changeEvent.url;\r\n          const logoutRoute = this.options.logoutRoute;\r\n          const loginRoute = this.options.loginRoute;\r\n\r\n          this.isLogoutRoute = currentRoute === logoutRoute;\r\n          this.isLoginRoute = currentRoute === loginRoute;\r\n\r\n          if (this.isLogoutRoute) {\r\n            this.auth.logout();\r\n          }\r\n        }\r\n      });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport {\r\n  HttpEvent,\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { TokenService } from './token.service';\r\nimport { AuthByKeyOptions, WithCredentialsOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthInterceptor implements HttpInterceptor {\r\n  private refreshInProgress = false;\r\n\r\n  private get trustHosts() {\r\n    const trustHosts = this.config.getConfig('auth.trustHosts') || [];\r\n    trustHosts.push(window.location.hostname);\r\n    return trustHosts;\r\n  }\r\n\r\n  private get hostsWithCredentials(): WithCredentialsOptions[] {\r\n    return this.config.getConfig('auth.hostsWithCredentials') || [];\r\n  }\r\n\r\n  private get hostsWithAuthByKey(): AuthByKeyOptions[] {\r\n    return this.config.getConfig('auth.hostsByKey') || [];\r\n  }\r\n\r\n  constructor(\r\n    private config: ConfigService,\r\n    private tokenService: TokenService,\r\n    private http: HttpClient\r\n  ) {}\r\n\r\n  intercept(\r\n    originalReq: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const withCredentials = this.handleHostsWithCredentials(originalReq.url);\r\n    let req = originalReq.clone();\r\n    const hostWithKey = this.handleHostsAuthByKey(originalReq.url);\r\n    if (hostWithKey) {\r\n      req = req.clone({\r\n        params: req.params.set(hostWithKey.key, hostWithKey.value)\r\n      });\r\n    }\r\n    if (withCredentials) {\r\n      req = originalReq.clone({\r\n        withCredentials\r\n      });\r\n    }\r\n    this.refreshToken();\r\n    const token = this.tokenService.get();\r\n    const element = document.createElement('a');\r\n    element.href = req.url;\r\n    if (element.host === '') {\r\n      element.href = element.href; // FIX IE11, DO NOT REMOVE\r\n    }\r\n\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return next.handle(req);\r\n    }\r\n\r\n    const authHeader = `Bearer ${token}`;\r\n    let authReq = req.clone({\r\n      headers: req.headers.set('Authorization', authHeader)\r\n    });\r\n\r\n    const tokenDecoded: any = this.tokenService.decode();\r\n    if (\r\n      authReq.params.get('_i') === 'true' &&\r\n      tokenDecoded &&\r\n      tokenDecoded.user &&\r\n      tokenDecoded.user.sourceId\r\n    ) {\r\n      const hashUser = Md5.hashStr(tokenDecoded.user.sourceId) as string;\r\n      authReq = authReq.clone({\r\n        params: authReq.params.set('_i', hashUser)\r\n      });\r\n    } else if (authReq.params.get('_i') === 'true') {\r\n      authReq = authReq.clone({\r\n        params: authReq.params.delete('_i')\r\n      });\r\n    }\r\n\r\n    return next.handle(authReq);\r\n  }\r\n\r\n  interceptXhr(xhr, url: string): boolean {\r\n    const withCredentials = this.handleHostsWithCredentials(url);\r\n    if (withCredentials) {\r\n       xhr.withCredentials = withCredentials;\r\n       return true;\r\n    }\r\n\r\n    this.refreshToken();\r\n    const element = document.createElement('a');\r\n    element.href = url;\r\n\r\n    const token = this.tokenService.get();\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return false;\r\n    }\r\n    xhr.setRequestHeader('Authorization', 'Bearer ' + token);\r\n    return true;\r\n  }\r\n\r\n  alterUrlWithKeyAuth(url: string): string {\r\n    const hostWithKey = this.handleHostsAuthByKey(url);\r\n    let interceptedUrl = url;\r\n    if (hostWithKey) {\r\n      const urlDecomposed = interceptedUrl.split(/[?&]/);\r\n      let urlWithKeyAdded = urlDecomposed.shift();\r\n      const paramsToKeep = urlDecomposed.filter(p => p.length !== 0);\r\n      paramsToKeep.push(`${hostWithKey.key}=${hostWithKey.value}`);\r\n      if (paramsToKeep.length) {\r\n        urlWithKeyAdded += '?' + paramsToKeep.join('&');\r\n      }\r\n      return urlWithKeyAdded;\r\n    }\r\n    return;\r\n  }\r\n\r\n  private handleHostsWithCredentials(reqUrl: string) {\r\n    let withCredentials = false;\r\n    for (const hostWithCredentials of this.hostsWithCredentials) {\r\n      const domainRegex = new RegExp(hostWithCredentials.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        withCredentials = hostWithCredentials.withCredentials !== undefined ? hostWithCredentials.withCredentials : undefined;\r\n        break;\r\n      }\r\n    }\r\n    return withCredentials;\r\n  }\r\n\r\n  private handleHostsAuthByKey(reqUrl: string): {key: string, value: string} {\r\n    let hostWithKey;\r\n    for (const hostWithAuthByKey of this.hostsWithAuthByKey) {\r\n      const domainRegex = new RegExp(hostWithAuthByKey.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        var replace = `${hostWithAuthByKey.keyProperty}=${hostWithAuthByKey.keyValue}`;\r\n        var keyAdded = new RegExp(replace,\"gm\");\r\n        if (!keyAdded.test(reqUrl)) {\r\n          hostWithKey = {key : hostWithAuthByKey.keyProperty, value: hostWithAuthByKey.keyValue};\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return hostWithKey;\r\n  }\r\n\r\n  refreshToken() {\r\n    const jwt = this.tokenService.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n\r\n    if (\r\n      !this.refreshInProgress &&\r\n      jwt &&\r\n      currentTime < jwt.exp &&\r\n      currentTime > jwt.exp - 1800\r\n    ) {\r\n      this.refreshInProgress = true;\r\n\r\n      const url = this.config.getConfig('auth.url');\r\n      return this.http.post(`${url}/refresh`, {}).subscribe(\r\n        (data: any) => {\r\n          this.tokenService.set(data.token);\r\n          this.refreshInProgress = false;\r\n        },\r\n        err => {\r\n          err.error.caught = true;\r\n          return err;\r\n        }\r\n      );\r\n    }\r\n  }\r\n}\r\n","import {\r\n  MSAL_GUARD_CONFIG,\r\n  MSAL_INSTANCE,\r\n  MsalService,\r\n} from '@azure/msal-angular';\r\n\r\nimport {\r\n  PublicClientApplication,\r\n  InteractionType\r\n} from '@azure/msal-browser';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { BrowserAuthOptions } from '@azure/msal-browser';\r\n\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from './auth.interface';\r\n\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\nexport function MSALConfigFactory(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALConfigFactoryb2c(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALAngularConfigFactory(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: AuthMicrosoftOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: ['user.read'],\r\n      loginHint: 'todo',\r\n    },\r\n    type: 'add'\r\n  };\r\n}\r\n\r\nexport function MSALAngularConfigFactoryb2c(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: [msConf.clientId]\r\n    },\r\n    type: 'b2c'\r\n  };\r\n}\r\n\r\nexport function provideAuthMicrosoft(type?: string) {\r\n  if (type === 'b2c') {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactoryb2c,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactoryb2c,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalServiceb2c\r\n    ];\r\n  } else {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactory,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactory,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalService\r\n    ];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { StorageService, StorageScope, ConfigService } from '@igo2/core';\r\nimport { AuthService } from './auth.service';\r\nimport { TokenService } from './token.service';\r\nimport { AuthStorageOptions } from './storage.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthStorageService extends StorageService {\r\n  protected options: AuthStorageOptions;\r\n\r\n  constructor(\r\n    config: ConfigService,\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private tokenService: TokenService\r\n  ) {\r\n    super(config);\r\n\r\n    this.authService.authenticate$.subscribe(isAuthenticated => {\r\n      if (isAuthenticated && this.options.url) {\r\n        this.http\r\n          .get(this.options.url)\r\n          .subscribe((userIgo: { preference: object }) => {\r\n            if (userIgo && userIgo.preference) {\r\n              for (const key of Object.keys(userIgo.preference)) {\r\n                const value = userIgo.preference[key];\r\n                super.set(key, value);\r\n              }\r\n            }\r\n          });\r\n      }\r\n    });\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = value;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.set(key, value, scope);\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = undefined;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.remove(key, scope);\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http.patch(this.options.url, { preference: {}}, {\r\n        params: {\r\n          mergePreference: 'false'\r\n        }\r\n      }).subscribe();\r\n    }\r\n\r\n    let token: string;\r\n    if (scope === StorageScope.LOCAL) {\r\n      token = this.tokenService.get();\r\n    }\r\n\r\n    super.clear(scope);\r\n\r\n    if (token) {\r\n      this.tokenService.set(token);\r\n    }\r\n\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http\r\n        .get(this.options.url)\r\n        .subscribe((userIgo: { preference: object }) => {\r\n          if (userIgo && userIgo.preference) {\r\n            for (const key of Object.keys(userIgo.preference)) {\r\n              const value = userIgo.preference[key];\r\n              super.set(key, value);\r\n            }\r\n          }\r\n        });\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MsalModule } from '@azure/msal-angular';\r\n\r\nimport { StorageService, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AuthStorageService } from './shared/storage.service';\r\nimport { ProtectedDirective } from './shared/protected.directive';\r\nimport { AuthInterceptor } from './shared/auth.interceptor';\r\nimport { provideAuthMicrosoft } from './shared/auth-microsoft.provider';\r\n\r\nimport { AuthInternComponent } from './auth-form/auth-intern.component';\r\nimport { AuthFormComponent } from './auth-form/auth-form.component';\r\nimport { AuthGoogleComponent } from './auth-form/auth-google.component';\r\nimport { AuthFacebookComponent } from './auth-form/auth-facebook.component';\r\nimport { AuthMicrosoftComponent } from './auth-form/auth-microsoft.component';\r\nimport { AuthMicrosoftb2cComponent } from './auth-form/auth-microsoftb2c.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    MsalModule\r\n  ],\r\n  declarations: [\r\n    AuthFormComponent,\r\n    AuthGoogleComponent,\r\n    AuthInternComponent,\r\n    AuthFacebookComponent,\r\n    AuthMicrosoftComponent,\r\n    AuthMicrosoftb2cComponent,\r\n    ProtectedDirective\r\n  ],\r\n  exports: [AuthFormComponent, ProtectedDirective]\r\n})\r\nexport class IgoAuthModule {\r\n  static forRoot(): ModuleWithProviders<IgoAuthModule> {\r\n    return {\r\n      ngModule: IgoAuthModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: AuthInterceptor,\r\n          multi: true\r\n        },\r\n        {\r\n          provide: StorageService,\r\n          useClass: AuthStorageService\r\n        },\r\n        ...provideAuthMicrosoft('add'),\r\n        ...provideAuthMicrosoft('b2c')\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'auth-form',\r\n    component: AppAuthFormComponent\r\n  }\r\n];\r\n\r\nexport const AppAuthFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss']\r\n})\r\nexport class AppAuthFormComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Auth</mat-card-subtitle>\r\n  <mat-card-title>Authentification</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/auth/auth-form\">code of this example</a><br>\r\n    See auth section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n  </mat-card-content>\r\n</mat-card>\r\n\r\n<igo-auth-form></igo-auth-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\nimport { AppAuthFormRoutingModule } from './auth-form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppAuthFormComponent],\r\n  imports: [AppAuthFormRoutingModule, MatCardModule, IgoAuthModule.forRoot()],\r\n  exports: [AppAuthFormComponent]\r\n})\r\nexport class AppAuthFormModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { MetadataOptions } from './metadata.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MetadataService {\r\n  constructor() {}\r\n\r\n  open(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      window.open(metadata.url, '_blank');\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"(options && options.metadata && options.metadata.url) || (options && options.metadata && options.metadata.abstract)\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.metadata.show' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openMetadata(options.metadata)\">\r\n  <mat-icon svgIcon=\"information-outline\"></mat-icon>\r\n</button>\r\n","<h2 mat-dialog-title>{{ data.layerTitle }}</h2>\r\n<button class=\"close-button\" mat-button mat-dialog-close>X</button>\r\n<mat-dialog-content *ngIf=\"data.type !== 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3>{{ data.abstract }}</h3>\r\n</mat-dialog-content>\r\n<mat-dialog-content *ngIf=\"data.type === 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3 [innerHTML]=\"data.abstract\"></h3>\r\n</mat-dialog-content>\r\n","import { Component, Input, ChangeDetectionStrategy, Inject, ViewEncapsulation } from '@angular/core';\r\nimport { MatDialog, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../shared/metadata.interface';\r\nimport { MetadataService } from '../shared/metadata.service';\r\n\r\n@Component({\r\n  selector: 'igo-metadata-button',\r\n  templateUrl: './metadata-button.component.html',\r\n  styleUrls: ['./metadata-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MetadataButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(\r\n    private metadataService: MetadataService,\r\n    private dialog: MatDialog) {}\r\n\r\n  openMetadata(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      this.metadataService.open(metadata);\r\n    } else if (!metadata.extern && metadata.abstract) {\r\n      this.dialog.open(MetadataAbstractComponent, {\r\n        data: {\r\n          layerTitle: this.layer.title,\r\n          abstract: metadata.abstract,\r\n          type: metadata.type\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  get options(): MetadataLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-metadata-abstract',\r\n  templateUrl: './metadata-abstract.component.html',\r\n  styleUrls: ['./metadata-abstract.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class MetadataAbstractComponent {\r\n  constructor(@Inject(MAT_DIALOG_DATA) public data: MetadataOptions) {}\r\n}\r\n","import { MatDialogModule } from '@angular/material/dialog';\r\nimport { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { MetadataButtonComponent, MetadataAbstractComponent } from './metadata-button/metadata-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent],\r\n  declarations: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent]\r\n})\r\nexport class IgoMetadataModule {\r\n  static forRoot(): ModuleWithProviders<IgoMetadataModule> {\r\n    return {\r\n      ngModule: IgoMetadataModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","export const FEATURE = 'Feature';\r\n\r\nexport enum FeatureMotion {\r\n  None,\r\n  Move,\r\n  Zoom,\r\n  Default\r\n}\r\n","import olSourceImage from 'ol/source/Image';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ImageLayer } from '../shared/layers/image-layer';\r\n\r\n\r\nexport class ImageWatcher extends Watcher {\r\n  protected id: string;\r\n  protected loaded = 0;\r\n  protected loading = 0;\r\n\r\n  private source: olSourceImage;\r\n\r\n  private messageService: MessageService;\r\n  private languageService: LanguageService;\r\n\r\n  constructor(layer: ImageLayer, messageService: MessageService, languageService: LanguageService) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n    this.messageService = messageService;\r\n    this.languageService = languageService;\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    if (!event.image.__watchers__) {\r\n      event.image.__watchers__ = [];\r\n    }\r\n    event.image.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.image.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.image.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleLoadError(event) {\r\n\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n    const title = this.languageService.translate.instant(\r\n      'igo.geo.dataSource.unavailableTitle'\r\n    );\r\n    const message = this.languageService.translate.instant(\r\n      'igo.geo.dataSource.unavailable', {value: event.target.params_.LAYERS}\r\n    );\r\n\r\n    this.messageService.error(message, title);\r\n    this.loaded = -1;\r\n    this.loading = 0;\r\n    this.status = SubjectStatus.Error;\r\n\r\n  }\r\n}\r\n","import { AnyLayerOptions } from \"../shared/layers/any-layer.interface\";\r\nimport { VectorTileLayerOptions } from \"../shared/layers/vectortile-layer.interface\";\r\n\r\n\r\nexport function computeMVTOptionsOnHover(layerOptions: AnyLayerOptions) {\r\n  const vectorTileLayerOptions = layerOptions as VectorTileLayerOptions;\r\n  if (\r\n    vectorTileLayerOptions.sourceOptions?.type === 'mvt' &&\r\n    (vectorTileLayerOptions.styleByAttribute?.hoverStyle || vectorTileLayerOptions.hoverStyle)) {\r\n    const fc = vectorTileLayerOptions.sourceOptions.featureClass;\r\n    vectorTileLayerOptions.sourceOptions.featureClass = fc ? fc : 'feature';\r\n  }\r\n  return layerOptions;\r\n}\r\n","import olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\nimport { Message } from '@igo2/core';\r\n\r\nimport { DataSource } from '../../../datasource/shared/datasources/datasource';\r\nimport { AnyDataSourceOptions } from '../../../datasource/shared/datasources/any-datasource.interface';\r\nimport { MapExtent, MapViewOptions } from '../../../map/shared/map.interface';\r\n\r\nexport interface LayerOptions {\r\n  isIgoInternalLayer?: boolean; // useful when mapOffline directive set the resolution of the layers.\r\n  source?: DataSource;\r\n  sourceOptions?: AnyDataSourceOptions;\r\n  title?: string;\r\n  id?: string;\r\n  alias?: string;\r\n  baseLayer?: boolean;\r\n  opacity?: number;\r\n  visible?: boolean;\r\n  extent?: MapExtent;\r\n  zIndex?: number;\r\n  messages?: Message[];\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  minScaleDenom?: number;\r\n  maxScaleDenom?: number;\r\n  showInLayerList?: boolean;\r\n  removable?: boolean;\r\n  workspace?: GeoWorkspaceOptions;\r\n  legendOptions?: LegendOptions;\r\n  ol?: olLayer<olSource>;\r\n  tooltip?: TooltipContent;\r\n  _internal?: { [key: string]: string };\r\n  active?: boolean;\r\n  check?: boolean;\r\n  linkedLayers?: LayersLink;\r\n}\r\n\r\nexport interface GeoWorkspaceOptions {\r\n  srcId?: string;\r\n  workspaceId?: string;\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  enabled?: boolean;\r\n  queryOptions?: GeoWorkspaceQueryOptions;\r\n  pageSize?: number;\r\n  pageSizeOptions?: number[];\r\n}\r\n\r\nexport interface GeoWorkspaceQueryOptions {\r\n  mapQueryOnOpenTab?: boolean;\r\n  tabQuery?: boolean;\r\n}\r\n\r\nexport interface LayersLink {\r\n  linkId: string;\r\n  links?: LayersLinkProperties[];\r\n}\r\nexport interface LayersLinkProperties {\r\n  bidirectionnal?: boolean;\r\n  linkedIds: string[];\r\n  syncedDelete: boolean;\r\n  properties: LinkedProperties[];\r\n}\r\n\r\nexport enum LinkedProperties {\r\n  OPACITY = 'opacity',\r\n  VISIBLE = 'visible',\r\n  OGCFILTERS = 'ogcFilters',\r\n  MINRESOLUTION = 'minResolution',\r\n  MAXRESOLUTION = 'maxResolution',\r\n  ZINDEX = 'zIndex',\r\n  TIMEFILTER = 'timeFilter'\r\n}\r\n\r\nexport interface GroupLayers {\r\n  title: string;\r\n  layers?: LayerOptions;\r\n  collapsed?: boolean;\r\n}\r\n\r\nexport interface TooltipContent {\r\n  type?: TooltipType;\r\n  text?: string;\r\n}\r\nexport enum TooltipType {\r\n  TITLE = 'title',\r\n  ABSTRACT = 'abstract',\r\n  CUSTOM = 'custom'\r\n}\r\n\r\nexport interface LegendOptions {\r\n  collapsed?: boolean;\r\n  display?: boolean;\r\n  url?: string;\r\n  html?: string;\r\n  stylesAvailable?: ItemStyleOptions[];\r\n}\r\n\r\nexport interface LegendMapViewOptions extends MapViewOptions{\r\n  scale?: number;\r\n  size?: [number, number];\r\n}\r\n\r\nexport interface ItemStyleOptions {\r\n  name: string;\r\n  title?: string;\r\n}\r\n\r\nexport interface OutputLayerLegend {\r\n  title: string;\r\n  url: string;\r\n}\r\n","import { ArcGISRestDataSourceOptions } from './../datasource/shared/datasources/arcgisrest-datasource.interface';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { AnyDataSourceOptions } from '../datasource/shared/datasources/any-datasource.interface';\r\nimport { DataSourceOptions } from '../datasource/shared/datasources/datasource.interface';\r\nimport { WMSDataSourceOptions } from '../datasource/shared/datasources/wms-datasource.interface';\r\nimport { WMTSDataSourceOptions } from '../datasource/shared/datasources/wmts-datasource.interface';\r\nimport { WFSDataSourceOptions } from '../datasource';\r\n\r\n/**\r\n * Generate a id from it's datasource options.\r\n * @param options Data source options\r\n * @returns A id\r\n */\r\nexport function generateIdFromSourceOptions(options: DataSourceOptions): string {\r\n  const generators = {\r\n    wms: generateWMSIdFromSourceOptions,\r\n    wmts: generateWMTSIdFromSourceOptions,\r\n    xyz: generateXYZIdFromSourceOptions,\r\n    feature: generateFeatureIdFromSourceOptions,\r\n    wfs: generateWfsIdFromSourceOptions,\r\n    arcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    imagearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    tilearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    osm: (_options: AnyDataSourceOptions) => 'OSM',\r\n    tiledebug: (_options: AnyDataSourceOptions) => 'tiledebug'\r\n  };\r\n  const generator = generators[options.type] || generateId;\r\n  return generator(options);\r\n}\r\n\r\n/**\r\n * Generate a id from WMS data source options\r\n * @param options WMS data source options\r\n * @returns A md5 hash of the the url and layers\r\n */\r\nexport function generateWMSIdFromSourceOptions(options: WMSDataSourceOptions) {\r\n  const layers = options.params.LAYERS;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wms' + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from WMTS data source options\r\n * @param options WMTS data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWMTSIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const layer = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wmts' + url + layer;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from XYZ data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateXYZIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'xyz' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateFeatureIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  if (!options.url) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'feature' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWfsIdFromSourceOptions(options: WFSDataSourceOptions) {\r\n  if (!options.url || !options.params) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wfs' + url + options.params.featureTypes;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n/**\r\n * Generate a id from ArcGIS Rest data source options\r\n * @param options ArcGIS Rest data source options\r\n * @returns A md5 hash of the url and layers\r\n */\r\nexport function generateArcgisRestIdFromSourceOptions(options: ArcGISRestDataSourceOptions) {\r\n  const layers = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = (options.type || 'arcgis') + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a unique id\r\n * @returns A uuid\r\n */\r\nexport function generateId(_options: AnyDataSourceOptions) {\r\n  return uuid();\r\n}\r\n\r\nexport function standardizeUrl(url: string): string {\r\n  const absUrl = url.charAt(0) === '/' ? window.location.origin + url : url;\r\n  const urlDecomposed = absUrl.split(/[?&]/);\r\n  let urlStandardized = urlDecomposed.shift();\r\n  const paramsToKeep = urlDecomposed.filter(p => p.length !== 0 && p.charAt(0) !== '_');\r\n  if (paramsToKeep.length) {\r\n    urlStandardized += '?' + paramsToKeep.join('&');\r\n  }\r\n  return urlStandardized;\r\n}\r\n","import olSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  DataSourceOptions,\r\n  Legend\r\n} from './datasource.interface';\r\n\r\nimport { DataService } from './data.service';\r\nimport { generateIdFromSourceOptions } from '../../../utils/id-generator';\r\nimport { LegendMapViewOptions, LegendOptions } from '../../../layer/shared/layers/layer.interface';\r\n\r\nexport abstract class DataSource {\r\n\r\n  public id: string;\r\n  public ol: olSource | olVectorSource<OlGeometry> | olClusterSource ;\r\n  private legend: Legend[];\r\n\r\n  constructor(\r\n    public options: DataSourceOptions = {},\r\n    protected dataService?: DataService\r\n  ) {\r\n    this.options = options;\r\n    this.id = this.options.id || this.generateId();\r\n    this.ol = this.createOlSource();\r\n  }\r\n\r\n  protected abstract createOlSource(): olSource;\r\n\r\n  protected generateId(): string {\r\n    return generateIdFromSourceOptions(this.options);\r\n  }\r\n\r\n  public getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    return this.legend ? this.legend : [];\r\n  }\r\n\r\n  public setLegend(options: LegendOptions): Legend[] {\r\n    if (options.url) {\r\n      this.legend = [{ url: options.url} ];\r\n    } else if (options.html) {\r\n      this.legend = [{ html: options.html} ];\r\n    } else {\r\n      this.legend = [];\r\n    }\r\n\r\n    return this.legend;\r\n  }\r\n\r\n  protected abstract onUnwatch();\r\n}\r\n","export enum OgcFilterOperatorType {\r\n    BasicNumericOperator = 'basicnumericoperator',\r\n    Basic = 'basic',\r\n    BasicAndSpatial = 'basicandspatial',\r\n    Spatial = 'spatial',\r\n    All = 'all',\r\n    Time = 'time'\r\n}\r\n\r\nexport enum OgcFilterOperator {\r\n    BBOX = 'BBox',\r\n    PropertyIsBetween = 'PropertyIsBetween',\r\n    Contains = 'Contains',\r\n    During = 'During',\r\n    PropertyIsEqualTo = 'PropertyIsEqualTo',\r\n    PropertyIsGreaterThan = 'PropertyIsGreaterThan',\r\n    PropertyIsGreaterThanOrEqualTo = 'PropertyIsGreaterThanOrEqualTo',\r\n    Intersects = 'Intersects',\r\n    PropertyIsNull = 'PropertyIsNull',\r\n    PropertyIsLessThan = 'PropertyIsLessThan',\r\n    PropertyIsLessThanOrEqualTo = 'PropertyIsLessThanOrEqualTo',\r\n    PropertyIsLike = 'PropertyIsLike',\r\n    PropertyIsNotEqualTo = 'PropertyIsNotEqualTo',\r\n    Within = 'Within',\r\n    And = 'And',\r\n    Or = 'Or',\r\n    Not = 'Not'\r\n}\r\n","import * as olfilter from 'ol/format/filter';\r\nimport olFormatWKT from 'ol/format/WKT';\r\nimport olFormatWFS, { WriteGetFeatureOptions } from 'ol/format/WFS';\r\nimport olGeometry from 'ol/geom/Geometry';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\n\r\nimport {\r\n  OgcFilter,\r\n  IgoOgcFilterObject,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcInterfaceFilterOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFiltersOptions,\r\n  IgoOgcSelector,\r\n  SelectorGroup,\r\n  OgcSelectorBundle\r\n} from './ogc-filter.interface';\r\nimport { OgcFilterOperatorType, OgcFilterOperator } from './ogc-filter.enum';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\nexport class OgcFilterWriter {\r\n  private filterSequence: OgcInterfaceFilterOptions[] = [];\r\n  public operators = {\r\n    [OgcFilterOperator.PropertyIsEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsNotEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsLike as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['string']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsBetween as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.During as string]: { spatial: false, fieldRestrict: [] },\r\n    [OgcFilterOperator.PropertyIsNull as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Intersects as string]: {\r\n      spatial: true,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Within as string]: { spatial: true, fieldRestrict: [] },\r\n    [OgcFilterOperator.Contains as string]: { spatial: true, fieldRestrict: [] }\r\n  };\r\n\r\n  defineOgcFiltersDefaultOptions(\r\n    ogcFiltersOptions: OgcFiltersOptions,\r\n    fieldNameGeometry: string,\r\n    srcType?: string\r\n  ): OgcFiltersOptions {\r\n    let ogcFiltersDefaultValue = true; // default values for wfs.\r\n    if (srcType && srcType === 'wms') {\r\n      ogcFiltersDefaultValue = false;\r\n    }\r\n\r\n    ogcFiltersOptions = ogcFiltersOptions || {};\r\n    ogcFiltersOptions.enabled =\r\n      ogcFiltersOptions.enabled === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.enabled;\r\n    ogcFiltersOptions.editable =\r\n      ogcFiltersOptions.editable === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.editable;\r\n    ogcFiltersOptions.geometryName = fieldNameGeometry;\r\n\r\n    ogcFiltersOptions.advancedOgcFilters = true;\r\n    if (ogcFiltersOptions.enabled && (ogcFiltersOptions.pushButtons || ogcFiltersOptions.checkboxes\r\n      || ogcFiltersOptions.radioButtons || ogcFiltersOptions.select)) {\r\n      ogcFiltersOptions.advancedOgcFilters = false;\r\n    }\r\n    return ogcFiltersOptions;\r\n  }\r\n\r\n  public buildFilter(\r\n    filters?: IgoOgcFilterObject,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection,\r\n    fieldNameGeometry?: string,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): string {\r\n    let ourBboxFilter;\r\n    let enableBbox: boolean;\r\n    if (/intersects|contains|within/gi.test(JSON.stringify(filters))) {\r\n      enableBbox = false;\r\n    } else {\r\n      enableBbox = true;\r\n    }\r\n    if (filters) {\r\n      fieldNameGeometry =\r\n        (filters as any).geometryName !== undefined\r\n          ? (filters as any).geometryName\r\n          : fieldNameGeometry;\r\n    }\r\n    if (extent && filters) {\r\n      ourBboxFilter = olfilter.bbox(fieldNameGeometry, extent, proj.getCode());\r\n    }\r\n    let filterAssembly: OgcFilter;\r\n    if (filters) {\r\n      filters = this.checkIgoFiltersProperties(\r\n        filters,\r\n        fieldNameGeometry,\r\n        proj\r\n      );\r\n      if (extent && enableBbox) {\r\n        filterAssembly = olfilter.and(\r\n          ourBboxFilter,\r\n          this.bundleFilter(filters, options)\r\n        );\r\n      } else {\r\n        filterAssembly = this.bundleFilter(filters, options);\r\n      }\r\n    } else {\r\n      return 'bbox=' + extent.join(',') + ',' + proj.getCode();\r\n    }\r\n\r\n    const wfsOptions: WriteGetFeatureOptions = {\r\n      srsName: '',\r\n      featureNS: '',\r\n      featurePrefix: '',\r\n      featureTypes: ['featureTypes'],\r\n      filter: filterAssembly,\r\n      outputFormat: '',\r\n      geometryName: fieldNameGeometry\r\n    };\r\n\r\n    const query = new olFormatWFS().writeGetFeature(wfsOptions);\r\n    const str = new XMLSerializer().serializeToString(query);\r\n    const regexp1 = /typenames *=|typename *=\\\"featureTypes\\\" *>/gi;\r\n    const regexp2 = /<\\/Query><\\/GetFeature>/gi;\r\n\r\n    return 'filter=' + str.split(regexp1)[1].split(regexp2)[0];\r\n  }\r\n\r\n  private bundleFilter(\r\n    filterObject: any,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ) {\r\n    if (filterObject instanceof Array) {\r\n      const logicalArray = [];\r\n      filterObject.forEach((element) => {\r\n        logicalArray.push(this.bundleFilter(element, options));\r\n      });\r\n      return logicalArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return this.createFilter(\r\n          {\r\n            operator: filterObject.logical,\r\n            logicalArray: this.bundleFilter(filterObject.filters, options)\r\n          },\r\n          options\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.createFilter(\r\n          filterObject as AnyBaseOgcFilterOptions,\r\n          options\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private createFilter(\r\n    filterOptions,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): OgcFilter {\r\n    const operator = filterOptions.operator;\r\n    const logicalArray = filterOptions.logicalArray;\r\n\r\n    const wfsPropertyName = filterOptions.propertyName;\r\n    const wfsPattern = filterOptions.pattern;\r\n    const wfsMatchCase = filterOptions.matchCase\r\n      ? filterOptions.matchCase\r\n      : true;\r\n    const wfsWildCard = filterOptions.wildCard ? filterOptions.wildCard : '*';\r\n    const wfsSingleChar = filterOptions.singleChar\r\n      ? filterOptions.singleChar\r\n      : '.';\r\n    const wfsEscapeChar = filterOptions.escapeChar\r\n      ? filterOptions.escapeChar\r\n      : '!';\r\n\r\n    const wfsLowerBoundary = filterOptions.lowerBoundary;\r\n    const wfsUpperBoundary = filterOptions.upperBoundary;\r\n\r\n    const wfsGeometryName = filterOptions.geometryName;\r\n    const wfsExtent = filterOptions.extent;\r\n    const wfsWktGeometry = filterOptions.wkt_geometry;\r\n    const wfsSrsName = filterOptions.srsName\r\n      ? filterOptions.srsName\r\n      : 'EPSG:3857';\r\n\r\n    const wfsBegin = this.parseFilterOptionDate(\r\n      filterOptions.begin,\r\n      options ? options.minDate : undefined\r\n    );\r\n    const wfsEnd = this.parseFilterOptionDate(\r\n      filterOptions.end,\r\n      options ? options.maxDate : undefined\r\n    );\r\n\r\n    const wfsExpression = filterOptions.expression;\r\n\r\n    let geometry: olGeometry;\r\n    if (wfsWktGeometry) {\r\n      const wkt = new olFormatWKT();\r\n      geometry = wkt.readGeometry(wfsWktGeometry, {\r\n        dataProjection: wfsSrsName,\r\n        featureProjection: wfsSrsName || 'EPSG:3857'\r\n      });\r\n    }\r\n\r\n    switch (operator.toLowerCase()) {\r\n      case OgcFilterOperator.BBOX.toLowerCase():\r\n        return olfilter.bbox(wfsGeometryName, wfsExtent, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsBetween.toLowerCase():\r\n        return olfilter.between(\r\n          wfsPropertyName,\r\n          wfsLowerBoundary,\r\n          wfsUpperBoundary\r\n        );\r\n      case OgcFilterOperator.Contains.toLowerCase():\r\n        return olfilter.contains(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.During.toLowerCase():\r\n        return olfilter.during(wfsPropertyName, wfsBegin, wfsEnd);\r\n      case OgcFilterOperator.PropertyIsEqualTo.toLowerCase():\r\n        return olfilter.equalTo(wfsPropertyName, wfsExpression, wfsMatchCase);\r\n      case OgcFilterOperator.PropertyIsGreaterThan.toLowerCase():\r\n        return olfilter.greaterThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo.toLowerCase():\r\n        return olfilter.greaterThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.Intersects.toLowerCase():\r\n        return olfilter.intersects(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsNull.toLowerCase():\r\n        return olfilter.isNull(wfsPropertyName);\r\n      case OgcFilterOperator.PropertyIsLessThan.toLowerCase():\r\n        return olfilter.lessThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo.toLowerCase():\r\n        return olfilter.lessThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLike.toLowerCase():\r\n        return olfilter.like(\r\n          wfsPropertyName,\r\n          wfsPattern.replace(/[()_]/gi, wfsSingleChar),\r\n          wfsWildCard,\r\n          wfsSingleChar,\r\n          wfsEscapeChar,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.PropertyIsNotEqualTo.toLowerCase():\r\n        return olfilter.notEqualTo(\r\n          wfsPropertyName,\r\n          wfsExpression,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.Within.toLowerCase():\r\n        return olfilter.within(wfsGeometryName, geometry, wfsSrsName);\r\n      // LOGICAL\r\n      case OgcFilterOperator.And.toLowerCase():\r\n        return olfilter.and.apply(null, logicalArray);\r\n      case OgcFilterOperator.Or.toLowerCase():\r\n        return olfilter.or.apply(null, logicalArray);\r\n      case OgcFilterOperator.Not.toLowerCase():\r\n        return olfilter.not.apply(null, logicalArray);\r\n\r\n      default:\r\n        return undefined;\r\n    }\r\n  }\r\n\r\n  public defineInterfaceFilterSequence(\r\n    filterObject: any,\r\n    geometryName,\r\n    logical = '',\r\n    level = -1\r\n  ): OgcInterfaceFilterOptions[] {\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            element,\r\n            geometryName,\r\n            logical,\r\n            level\r\n          )\r\n        );\r\n      });\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        level = level + 1;\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            filterObject.filters,\r\n            geometryName,\r\n            filterObject.logical,\r\n            level\r\n          )\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        this.filterSequence.push(\r\n          this.addInterfaceFilter(filterObject, geometryName, level, logical)\r\n        );\r\n      }\r\n    }\r\n    return this.filterSequence;\r\n  }\r\n\r\n  public computeAllowedOperators(\r\n    fields?: SourceFieldsOptionsParams[],\r\n    propertyName?: string,\r\n    defaultOperatorsType?: OgcFilterOperatorType\r\n  ) {\r\n    let effectiveOperators: {} = {};\r\n    let allowedOperators;\r\n    let fieldsHasSpatialOperator: boolean;\r\n    let includeContains: boolean;\r\n\r\n    if (fields && propertyName) {\r\n      const srcField = fields.find((field) => field.name === propertyName);\r\n      allowedOperators =\r\n        srcField && srcField.allowedOperatorsType\r\n          ? srcField.allowedOperatorsType\r\n          : defaultOperatorsType;\r\n    }\r\n\r\n    if (fields) {\r\n      fields.map((field) => {\r\n        if (!field.allowedOperatorsType) {\r\n          return;\r\n        }\r\n        const allowedOperatorsType = field.allowedOperatorsType.toLowerCase();\r\n        if (\r\n          allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.Spatial.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.BasicAndSpatial.toLowerCase()\r\n        ) {\r\n          fieldsHasSpatialOperator = true;\r\n          if (\r\n            allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase()\r\n          ) {\r\n            includeContains = true;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    allowedOperators = allowedOperators\r\n      ? allowedOperators\r\n      : OgcFilterOperatorType.BasicAndSpatial;\r\n\r\n    switch (allowedOperators.toLowerCase()) {\r\n      case OgcFilterOperatorType.All:\r\n        effectiveOperators = this.operators;\r\n        break;\r\n      case OgcFilterOperatorType.Spatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicAndSpatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Basic:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Time:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.During]: { spatial: false, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicNumericOperator:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          }\r\n        };\r\n        break;\r\n      default:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n    }\r\n\r\n    if (fieldsHasSpatialOperator) {\r\n      (effectiveOperators as any).Intersects = {\r\n        spatial: true,\r\n        fieldRestrict: []\r\n      };\r\n      (effectiveOperators as any).Within = { spatial: true, fieldRestrict: [] };\r\n      if (includeContains) {\r\n        (effectiveOperators as any).Contains = {\r\n          spatial: true,\r\n          fieldRestrict: []\r\n        };\r\n      }\r\n    }\r\n\r\n    return effectiveOperators;\r\n  }\r\n\r\n  public addInterfaceFilter(\r\n    igoOgcFilterObject?,\r\n    geometryName?,\r\n    level = 0,\r\n    parentLogical = 'Or'\r\n  ): OgcInterfaceFilterOptions {\r\n    if (!igoOgcFilterObject) {\r\n      igoOgcFilterObject = { operator: 'PropertyIsEqualTo' };\r\n    }\r\n    const f = {\r\n      propertyName: '',\r\n      operator: '',\r\n      active: '',\r\n      filterid: uuid(),\r\n      step: '',\r\n      begin: '',\r\n      end: '',\r\n      sliderOptions: {},\r\n      lowerBoundary: '',\r\n      upperBoundary: '',\r\n      expression: '',\r\n      pattern: '',\r\n      wildCard: '*',\r\n      singleChar: '.',\r\n      escapeChar: '!',\r\n      matchCase: true,\r\n      igoSpatialSelector: '',\r\n      igoSNRC: '',\r\n      geometryName: '',\r\n      geometry: '',\r\n      wkt_geometry: '',\r\n      extent: '',\r\n      srsName: '',\r\n      parentLogical: '',\r\n      level: 0\r\n    };\r\n\r\n    return Object.assign(\r\n      f,\r\n      {\r\n        parentLogical,\r\n        level,\r\n        geometryName\r\n      },\r\n      igoOgcFilterObject\r\n    );\r\n  }\r\n\r\n  public checkIgoFiltersProperties(\r\n    filterObject: any,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterArray = [];\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        filterArray.push(\r\n          this.checkIgoFiltersProperties(\r\n            element,\r\n            fieldNameGeometry,\r\n            proj,\r\n            active\r\n          )\r\n        );\r\n      });\r\n      return filterArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return Object.assign(\r\n          {},\r\n          {\r\n            logical: filterObject.logical,\r\n            filters: this.checkIgoFiltersProperties(\r\n              filterObject.filters,\r\n              fieldNameGeometry,\r\n              proj,\r\n              active\r\n            )\r\n          }\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.addFilterProperties(\r\n          filterObject as OgcInterfaceFilterOptions,\r\n          fieldNameGeometry,\r\n          proj,\r\n          active\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private addFilterProperties(\r\n    igoOgcFilterObject: OgcInterfaceFilterOptions,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterid = igoOgcFilterObject.hasOwnProperty('filterid')\r\n      ? igoOgcFilterObject.filterid\r\n      : uuid();\r\n    const status = igoOgcFilterObject.hasOwnProperty('active')\r\n      ? igoOgcFilterObject.active\r\n      : active;\r\n\r\n    const srsName = igoOgcFilterObject.hasOwnProperty('srsName')\r\n      ? igoOgcFilterObject.srsName\r\n      : proj\r\n      ? proj.getCode()\r\n      : 'EPSG:3857';\r\n\r\n    return Object.assign(\r\n      {},\r\n      {\r\n        filterid,\r\n        active: status,\r\n        igoSpatialSelector: 'fixedExtent',\r\n        srsName\r\n      },\r\n      igoOgcFilterObject,\r\n      { geometryName: fieldNameGeometry }\r\n    );\r\n  }\r\n\r\n  public rebuiltIgoOgcFilterObjectFromSequence(\r\n    sequence: OgcInterfaceFilterOptions[]\r\n  ): IgoOgcFilterObject {\r\n    if (sequence instanceof Array) {\r\n      if (sequence.length >= 1) {\r\n        let lastParentLogical = sequence[0].parentLogical;\r\n        let nextElement: any;\r\n        let logicalArray = [];\r\n        let lastProcessedFilter;\r\n        sequence.forEach((uiFilter) => {\r\n          const element = Object.assign({}, uiFilter);\r\n          const index = sequence.indexOf(uiFilter);\r\n          if (index >= 0 && index < sequence.length - 1) {\r\n            nextElement = sequence[index + 1];\r\n          } else {\r\n            nextElement = element;\r\n          }\r\n          delete element.active;\r\n          delete element.filterid;\r\n          delete element.parentLogical;\r\n          logicalArray.push(element);\r\n\r\n          if (sequence.length === 1) {\r\n            lastProcessedFilter = element;\r\n          } else if (lastParentLogical !== nextElement.parentLogical) {\r\n            if (logicalArray.length === 1) {\r\n              console.log(\r\n                'You must set at ' +\r\n                  'least two operator in a logical (' +\r\n                  lastParentLogical +\r\n                  ')'\r\n              );\r\n            } else {\r\n              lastProcessedFilter = Object.assign(\r\n                {},\r\n                { logical: lastParentLogical, filters: logicalArray }\r\n              );\r\n              logicalArray = [lastProcessedFilter];\r\n              lastParentLogical = nextElement.parentLogical;\r\n            }\r\n          }\r\n        });\r\n        return lastProcessedFilter;\r\n      } else {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  private computeIgoSelector(selectors: IgoOgcSelector): IgoOgcSelector {\r\n    if (\r\n      selectors.groups.every((group) => group.computedSelectors !== undefined)\r\n    ) {\r\n      return selectors;\r\n    }\r\n    let selector: IgoOgcSelector;\r\n    if (selectors.groups && selectors.bundles) {\r\n      if (!selectors.bundles.every((bundle) => bundle.id !== undefined)) {\r\n        throw new Error(\r\n          'You must set an id for each of your bundles'\r\n        );\r\n      }\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups.forEach((group) => {\r\n        group.title = group.title ? group.title : group.name;\r\n        group.enabled = group.enabled ? group.enabled : false;\r\n        group.computedSelectors = ObjectUtils.copyDeep(\r\n          selector.bundles.filter((b) => group.ids.includes(b.id))\r\n        );\r\n      });\r\n    } else if (!selectors.groups && selectors.bundles) {\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups = [\r\n        {\r\n          title: 'group1',\r\n          name: 'group1',\r\n          computedSelectors: ObjectUtils.copyDeep(selector.bundles)\r\n        } as SelectorGroup\r\n      ];\r\n    } else {\r\n      selector = {\r\n        bundles: selectors as any,\r\n        groups: [\r\n          {\r\n            title: 'group1',\r\n            name: 'group1',\r\n            computedSelectors: ObjectUtils.copyDeep(\r\n              selectors\r\n            ) as OgcSelectorBundle[]\r\n          } as SelectorGroup\r\n        ],\r\n        selectorType: selector.selectorType\r\n      };\r\n    }\r\n    if (!selector.groups.find((selectorGroup) => selectorGroup.enabled)) {\r\n      selector.groups[0].enabled = true;\r\n    }\r\n    return selector;\r\n  }\r\n\r\n  public handleOgcFiltersAppliedValue(\r\n    options: OgcFilterableDataSourceOptions,\r\n    fieldNameGeometry: string,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection\r\n  ): string {\r\n    const ogcFilters = options.ogcFilters;\r\n    if (!ogcFilters) {\r\n      return;\r\n    }\r\n    const conditions = [];\r\n    let filterQueryStringSelector = '';\r\n    let filterQueryStringAdvancedFilters = '';\r\n    if (ogcFilters.enabled && (ogcFilters.pushButtons || ogcFilters.checkboxes || ogcFilters.radioButtons || ogcFilters.select)) {\r\n      let selectors;\r\n      if (ogcFilters.pushButtons) {\r\n        selectors = ogcFilters.pushButtons;\r\n        const pushConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of pushConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.checkboxes) {\r\n        selectors = ogcFilters.checkboxes;\r\n        const checkboxConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of checkboxConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.radioButtons) {\r\n        selectors = ogcFilters.radioButtons;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const radioConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of radioConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.select) {\r\n        selectors = ogcFilters.select;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n\r\n      if (conditions.length >= 1) {\r\n        filterQueryStringSelector = this.buildFilter(\r\n          conditions.length === 1\r\n            ? conditions[0]\r\n            : { logical: 'And', filters: conditions },\r\n          extent,\r\n          proj,\r\n          ogcFilters.geometryName\r\n        );\r\n      }\r\n    }\r\n    if (ogcFilters.enabled && ogcFilters.filters) {\r\n      ogcFilters.geometryName = ogcFilters.geometryName || fieldNameGeometry;\r\n      const igoFilters = ogcFilters.filters;\r\n      filterQueryStringAdvancedFilters = this.buildFilter(\r\n        igoFilters,\r\n        extent,\r\n        proj,\r\n        ogcFilters.geometryName,\r\n        options\r\n      );\r\n    }\r\n\r\n    let filterQueryString = ogcFilters.advancedOgcFilters\r\n      ? filterQueryStringAdvancedFilters\r\n      : filterQueryStringSelector;\r\n    if (options.type === 'wms') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.LAYERS\r\n      );\r\n    }\r\n    if (options.type === 'wfs') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.featureTypes\r\n      );\r\n    }\r\n\r\n    return filterQueryString;\r\n  }\r\n\r\n  public verifyMultipleEnableds(selectors) {\r\n    selectors.bundles.forEach(bundle => {\r\n      if (!bundle.multiple) {\r\n        const enableds = bundle.selectors.reduce((list, filter, index) => (filter.enabled) === true ? list.concat(index) : list, []);\r\n        if (enableds.length > 1) {\r\n          enableds.splice(0, 1);\r\n          enableds.forEach(index => {\r\n            bundle.selectors[index].enabled = false;\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return selectors;\r\n  }\r\n\r\n  public formatGroupAndFilter(ogcFilters: OgcFiltersOptions, selectors) {\r\n    selectors = this.computeIgoSelector(\r\n      selectors\r\n    );\r\n    const selectorBundle = selectors.groups.find(\r\n      (g) => g.enabled\r\n    ).computedSelectors;\r\n    const conditions = [];\r\n    selectorBundle.map((bundle) => {\r\n      const bundleCondition = [];\r\n      const selectorsType = bundle.selectors as any;\r\n      if (!selectorsType) {\r\n        return;\r\n      }\r\n      selectorsType\r\n        .filter((ogcselector) => ogcselector.enabled === true)\r\n        .forEach((enabledSelector) => bundleCondition.push(enabledSelector.filters));\r\n      if (bundleCondition.length === 1) {\r\n        conditions.push(bundleCondition[0]);\r\n      } else if (bundleCondition.length > 1) {\r\n        conditions.push({\r\n          logical: bundle.logical,\r\n          filters: bundleCondition\r\n        });\r\n      }\r\n    });\r\n\r\n    if (selectors.selectorType === 'pushButton') {\r\n      ogcFilters.pushButtons = selectors;\r\n    } else if (selectors.selectorType === 'checkbox') {\r\n      ogcFilters.checkboxes = selectors;\r\n    } else if (selectors.selectorType === 'radioButton') {\r\n      ogcFilters.radioButtons = selectors;\r\n    } else if (selectors.selectorType === 'select') {\r\n      ogcFilters.select = selectors;\r\n    }\r\n    return conditions;\r\n  }\r\n\r\n  public formatProcessedOgcFilter(\r\n    processedFilter: string,\r\n    layersOrTypenames: string\r\n  ): string {\r\n\r\n    if (!processedFilter) {return undefined;};\r\n    let appliedFilter = '';\r\n    if (processedFilter.length === 0 && layersOrTypenames.indexOf(',') === -1) {\r\n      appliedFilter = processedFilter;\r\n    } else {\r\n      layersOrTypenames.split(',').forEach((layerOrTypenames) => {\r\n        appliedFilter = `${appliedFilter}(${processedFilter.replace(\r\n          'filter=',\r\n          ''\r\n        )})`;\r\n      });\r\n    }\r\n    appliedFilter = appliedFilter.replace(/\\(\\)/g, '');\r\n    const filterValue =\r\n      appliedFilter.length > 0\r\n        ? appliedFilter.replace('filter=', '')\r\n        : undefined;\r\n    return filterValue;\r\n  }\r\n\r\n  public parseFilterOptionDate(value: string, defaultValue?: string): string {\r\n    if (!value) {\r\n      return defaultValue;\r\n    } else if (value === 'today') {\r\n      return undefined;\r\n    } else if (moment(value).isValid()) {\r\n      return value;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n}\r\n","export enum QueryFormat {\r\n  GML2 = 'gml2',\r\n  GML3 = 'gml3',\r\n  JSON = 'json',\r\n  GEOJSON = 'geojson',\r\n  GEOJSON2 = 'geojson2',\r\n  ESRIJSON = 'esrijson',\r\n  TEXT = 'text',\r\n  HTML = 'html',\r\n  HTMLGML2 = 'htmlgml2'\r\n}\r\n\r\nexport enum QueryFormatMimeType {\r\n  GML2 = 'application/vnd.ogc.gml',\r\n  GML3 = 'application/vnd.ogc.gml/3.1.1',\r\n  JSON = 'application/json',\r\n  GEOJSON = 'application/geojson',\r\n  GEOJSON2 = 'geojson',\r\n  ESRIJSON = 'application/json',\r\n  TEXT = 'text/plain',\r\n  HTML = 'text/html',\r\n  HTMLGML2 = 'text/html'\r\n}\r\n\r\nexport enum QueryHtmlTarget {\r\n  IFRAME = 'iframe',\r\n  BLANK = '_blank'\r\n}\r\n","import { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\n\r\nimport * as OlFormat from 'ol/format';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatGML32 from 'ol/format/GML32';\r\nimport olFormatOSMXML from 'ol/format/OSMXML';\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nexport const defaultEpsg = 'EPSG:3857';\r\nexport const defaultMaxFeatures = 5000;\r\nexport const defaultWfsVersion = '2.0.0';\r\nexport const defaultFieldNameGeometry = 'geometry';\r\nexport const gmlRegex = new RegExp(/(.*)?gml(.*)?/gi);\r\nexport const jsonRegex = new RegExp(/(.*)?json(.*)?/gi);\r\n\r\n\r\n/**\r\n * This method build the WFS URL based on the layer property.\r\n * @param options  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param extent  An extent like array [number, number, number, number]\r\n * @param proj  olProjection\r\n * @param ogcFilters  OgcFiltersOptions\r\n * @returns A string representing the datasource options, based on filter and views\r\n */\r\nexport function buildUrl(\r\n  options: WFSDataSourceOptions,\r\n  extent,\r\n  proj: olProjection,\r\n  ogcFilters: OgcFiltersOptions,\r\n  randomParam?: boolean): string {\r\n  const paramsWFS = options.paramsWFS;\r\n  const queryStringValues = formatWFSQueryString(options, undefined, options.paramsWFS.srsName);\r\n  let igoFilters;\r\n  if (ogcFilters && ogcFilters.enabled) {\r\n    igoFilters = ogcFilters.filters;\r\n  }\r\n  const ogcFilterWriter = new OgcFilterWriter();\r\n  const filterOrBox = ogcFilterWriter.buildFilter(igoFilters, extent, proj, ogcFilters.geometryName, options);\r\n  let filterOrPush = ogcFilterWriter.handleOgcFiltersAppliedValue(options, ogcFilters.geometryName, extent, proj);\r\n\r\n  let prefix = 'filter';\r\n  if (!filterOrPush) {\r\n    prefix = 'bbox';\r\n    filterOrPush = extent.join(',') + ',' + proj.getCode();\r\n  }\r\n\r\n  paramsWFS.xmlFilter = ogcFilters.advancedOgcFilters ? filterOrBox : `${prefix}=${filterOrPush}`;\r\n  let baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n  const patternFilter = /(filter|bbox)=.*/gi;\r\n  baseUrl = patternFilter.test(paramsWFS.xmlFilter) ? `${baseUrl}&${paramsWFS.xmlFilter}` : baseUrl;\r\n  options.download = Object.assign({}, options.download, { dynamicUrl: baseUrl });\r\n  if (randomParam) {\r\n    baseUrl += `$&_t${new Date().getTime()}`;\r\n  }\r\n  return baseUrl.replace(/&&/g, '&');\r\n}\r\n\r\n\r\n/**\r\n * This method build/standardize WFS call query params based on the layer property.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param count  Number: Used to control the number of feature. Used to bypass whe wfs datasource options interface (maxFeatures)\r\n * @param epsg  String: Used to control the EPSG code (es: 'EPSG3857'). Used to bypass whe wfs datasource options interface (srsName)\r\n * @param properties  String: Used to control the queried fields  (WFS service).\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function formatWFSQueryString(\r\n  dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n  count?: number,\r\n  epsg?: string,\r\n  properties?: string,\r\n  startIndex: number = 0,\r\n  forceDefaultOutputFormat: boolean = false\r\n): { name: string; value: string }[] {\r\n  const versionWfs200 = '2.0.0'; // not the same usage as defaultWfsVersion.\r\n  const url = dataSourceOptions.urlWfs;\r\n  const paramsWFS = dataSourceOptions.paramsWFS;\r\n  const effectiveCount = count || defaultMaxFeatures;\r\n  const effectiveStartIndex = paramsWFS.version === versionWfs200 ? `startIndex=${startIndex}` : '';\r\n  const epsgCode = epsg || defaultEpsg;\r\n  let outputFormat = paramsWFS.outputFormat\r\n    ? `outputFormat=${paramsWFS.outputFormat}`\r\n    : '';\r\n  let version = paramsWFS.version\r\n    ? `version=${paramsWFS.version}`\r\n    : `version=${defaultWfsVersion}`;\r\n  const paramTypename =\r\n    paramsWFS.version === versionWfs200 ? 'typenames' : 'typename';\r\n  const featureTypes = `${paramTypename}=${paramsWFS.featureTypes}`;\r\n  const paramMaxFeatures =\r\n    paramsWFS.version === versionWfs200 ? 'count' : 'maxFeatures';\r\n  let cnt = count\r\n    ? `${paramMaxFeatures}=${effectiveCount}`\r\n    : paramsWFS.maxFeatures\r\n    ? `${paramMaxFeatures}=${paramsWFS.maxFeatures}`\r\n    : `${paramMaxFeatures}=${effectiveCount}`;\r\n  if (forceDefaultOutputFormat) {\r\n      outputFormat = '';\r\n      version = 'version=1.1.0';\r\n      cnt = cnt.replace('count', 'maxFeatures');\r\n    }\r\n\r\n  const srs = epsg\r\n    ? `srsname=${epsgCode}`\r\n    : paramsWFS.srsName\r\n    ? 'srsname=' + paramsWFS.srsName\r\n    : `srsname=${epsgCode}`;\r\n\r\n  let propertyName = '';\r\n  let valueReference = '';\r\n  if (properties) {\r\n    propertyName = `propertyName=${properties}`;\r\n    valueReference = `valueReference=${properties}`;\r\n  }\r\n  const sourceFields = dataSourceOptions.sourceFields;\r\n  if (!propertyName && sourceFields && sourceFields.length > 0) {\r\n    const fieldsNames = [];\r\n    dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n      fieldsNames.push(sourcefield.name);\r\n    });\r\n    propertyName = `propertyName=${fieldsNames.join(',')},${\r\n      paramsWFS.fieldNameGeometry\r\n    }`;\r\n  }\r\n\r\n  const separator = url.indexOf('?') === -1 ? '?' : '&';\r\n  const getCapabilities = `${url}${separator}service=WFS&request=GetCapabilities&${version}`;\r\n  let getFeature = `${url}${separator}service=WFS&request=GetFeature&${version}&${featureTypes}&`;\r\n  getFeature += `${outputFormat}&${srs}&${cnt}&${propertyName}&${effectiveStartIndex}`;\r\n\r\n  let getpropertyvalue = `${url}?service=WFS&request=GetPropertyValue&version=${versionWfs200}&${featureTypes}&`;\r\n  getpropertyvalue += `&${cnt}&${valueReference}`;\r\n\r\n  return [\r\n    { name: 'outputformat', value: outputFormat },\r\n    { name: 'version', value: version },\r\n    { name: 'typename', value: featureTypes },\r\n    { name: 'count', value: cnt },\r\n    { name: 'srsname', value: srs },\r\n    { name: 'propertyname', value: propertyName },\r\n    { name: 'valuereference', value: valueReference },\r\n    { name: 'getcapabilities', value: getCapabilities.replace(/&&/g, '&') },\r\n    { name: 'getfeature', value: getFeature.replace(/&&/g, '&') },\r\n    { name: 'getpropertyvalue', value: getpropertyvalue.replace(/&&/g, '&') }\r\n  ];\r\n}\r\n\r\n/**\r\n * Validate/Modify layer's wfs options based on :\r\n * 1- an Openlayers's issue with GML provided from WFS. Refer to\r\n * https://github.com/openlayers/openlayers/pull/6400\r\n * 2- Set default values for optionals parameters.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function checkWfsParams(wfsDataSourceOptions, srcType?: string) {\r\n  if (srcType && srcType === 'wfs') {\r\n    // reassignation of params to paramsWFS and url to urlWFS to have a common interface with wms-wfs datasources\r\n    wfsDataSourceOptions.paramsWFS = wfsDataSourceOptions.params;\r\n  }\r\n\r\n  const paramsWFS = wfsDataSourceOptions.paramsWFS;\r\n  wfsDataSourceOptions.urlWfs =\r\n    wfsDataSourceOptions.urlWfs || wfsDataSourceOptions.url;\r\n\r\n  paramsWFS.version = paramsWFS.version || defaultWfsVersion;\r\n  paramsWFS.fieldNameGeometry =\r\n    paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n  paramsWFS.maxFeatures = paramsWFS.maxFeatures || defaultMaxFeatures;\r\n\r\n  let outputFormat;\r\n  if (paramsWFS.outputFormat) {\r\n    outputFormat = paramsWFS.outputFormat;\r\n  }\r\n\r\n  if (gmlRegex.test(outputFormat) || !outputFormat) {\r\n    paramsWFS.version = '1.1.0';\r\n  }\r\n  return Object.assign({}, wfsDataSourceOptions);\r\n}\r\n\r\nexport function getFormatFromOptions(\r\n  options: WFSDataSourceOptions | WMSDataSourceOptions\r\n) {\r\n  const wfsOptions = options as WFSDataSourceOptions;\r\n\r\n  let olFormatCls;\r\n  const outputFormat = wfsOptions.paramsWFS.outputFormat\r\n    ? wfsOptions.paramsWFS.outputFormat\r\n    : undefined;\r\n\r\n  if (!outputFormat) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  if (OlFormat[outputFormat]) {\r\n    olFormatCls = OlFormat[outputFormat];\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gml2')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ... { gmlFormat: olFormatGML2 }});\r\n  } else if (outputFormat.toLowerCase().match('gml32')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ... { gmlFormat: olFormatGML32 }});\r\n  } else if (outputFormat.toLowerCase().match('gml3')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ... { gmlFormat: olFormatGML3 }});\r\n  } else if (outputFormat.toLowerCase().match('topojson')) {\r\n    olFormatCls = OlFormat.TopoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('geojson')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('esrijson')) {\r\n    olFormatCls = OlFormat.EsriJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('json')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gpx')) {\r\n    olFormatCls = OlFormat.GPX;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('WKT')) {\r\n    olFormatCls = OlFormat.WKT;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('osmxml')) {\r\n    olFormatCls = olFormatOSMXML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('kml')) {\r\n    olFormatCls = OlFormat.KML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  return new olFormatCls();\r\n}\r\n","import olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions, OgcFilterDuringOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nimport {\r\n  formatWFSQueryString,\r\n  checkWfsParams,\r\n  defaultFieldNameGeometry\r\n} from './wms-wfs.utils';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LegendMapViewOptions } from '../../../layer/shared/layers/layer.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { TimeFilterableDataSourceOptions, TimeFilterOptions } from '../../../filter/shared/time-filter.interface';\r\n\r\nexport class WMSDataSource extends DataSource {\r\n  public ol: olSourceImageWMS;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  readonly ogcFilters$: BehaviorSubject<OgcFiltersOptions> = new BehaviorSubject(undefined);\r\n\r\n  set timeFilter(value: TimeFilterOptions ) {\r\n    (this.options as TimeFilterableDataSourceOptions).timeFilter = value;\r\n  }\r\n  get timeFilter(): TimeFilterOptions {\r\n    return (this.options as TimeFilterableDataSourceOptions).timeFilter;\r\n  }\r\n  readonly timeFilter$: BehaviorSubject<TimeFilterOptions> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    public options: WMSDataSourceOptions,\r\n    protected wfsService: WFSService\r\n  ) {\r\n    super(options);\r\n    const sourceParams: any = options.params;\r\n\r\n    const dpi = sourceParams.DPI || 96;\r\n    sourceParams.DPI = dpi;\r\n    sourceParams.MAP_RESOLUTION = dpi;\r\n    sourceParams.FORMAT_OPTIONS = 'dpi:' + dpi;\r\n\r\n    if (options.refreshIntervalSec && options.refreshIntervalSec > 0) {\r\n      setInterval(() => {\r\n        this.refresh();\r\n      }, options.refreshIntervalSec * 1000); // Convert seconds to MS\r\n    }\r\n\r\n    let fieldNameGeometry = defaultFieldNameGeometry;\r\n\r\n    // ####   START if paramsWFS\r\n    if (options.paramsWFS) {\r\n      const wfsCheckup = checkWfsParams(options, 'wms');\r\n      ObjectUtils.mergeDeep(options.paramsWFS, wfsCheckup.paramsWFS);\r\n\r\n      fieldNameGeometry =\r\n        options.paramsWFS.fieldNameGeometry || fieldNameGeometry;\r\n\r\n      options.download = Object.assign({}, options.download, {\r\n        dynamicUrl: this.buildDynamicDownloadUrlFromParamsWFS(options)\r\n      });\r\n    } //  ####   END  if paramsWFS\r\n\r\n    if (!options.sourceFields || options.sourceFields.length === 0) {\r\n      options.sourceFields = [];\r\n    } else {\r\n      options.sourceFields.forEach(sourceField => {\r\n        sourceField.alias = sourceField.alias\r\n          ? sourceField.alias\r\n          : sourceField.name;\r\n        // to allow only a list of sourcefield with names\r\n      });\r\n    }\r\n    const initOgcFilters = (options as OgcFilterableDataSourceOptions)\r\n      .ogcFilters;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (!initOgcFilters) {\r\n      (options as OgcFilterableDataSourceOptions).ogcFilters = ogcFilterWriter.defineOgcFiltersDefaultOptions(\r\n        initOgcFilters,\r\n        fieldNameGeometry,\r\n        'wms'\r\n      );\r\n    } else {\r\n      initOgcFilters.advancedOgcFilters = (initOgcFilters.pushButtons || initOgcFilters.checkboxes\r\n        || initOgcFilters.radioButtons || initOgcFilters.select)\r\n        ? false\r\n        : true;\r\n      if (initOgcFilters.advancedOgcFilters && initOgcFilters.filters) {\r\n          const filterDuring = initOgcFilters.filters as OgcFilterDuringOptions;\r\n          if(filterDuring.calendarModeYear) {\r\n            initOgcFilters.advancedOgcFilters = false;\r\n          }\r\n      }\r\n      if (initOgcFilters.pushButtons){\r\n        initOgcFilters.pushButtons.selectorType = 'pushButton';\r\n      }\r\n      if (initOgcFilters.checkboxes){\r\n        initOgcFilters.checkboxes.selectorType = 'checkbox';\r\n      }\r\n      if (initOgcFilters.radioButtons){\r\n        initOgcFilters.radioButtons.selectorType = 'radioButton';\r\n      }\r\n      if (initOgcFilters.select){\r\n        initOgcFilters.select.selectorType = 'select';\r\n      }\r\n    }\r\n\r\n    if (\r\n      sourceParams.LAYERS.split(',').length > 1 &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled\r\n    ) {\r\n      console.log('*******************************');\r\n      console.log(\r\n        'BE CAREFULL, YOUR WMS LAYERS (' +\r\n          sourceParams.LAYERS +\r\n          ') MUST SHARE THE SAME FIELDS TO ALLOW ogcFilters TO WORK !! '\r\n      );\r\n      console.log('*******************************');\r\n    }\r\n\r\n    if (\r\n      options.paramsWFS &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled &&\r\n      initOgcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0) {\r\n      this.wfsService.getSourceFieldsFromWFS(options);\r\n    }\r\n\r\n    const filterQueryString = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n      options,\r\n      fieldNameGeometry\r\n    );\r\n    sourceParams.FILTER = filterQueryString;\r\n    this.setOgcFilters(initOgcFilters, true);\r\n\r\n    const timeFilterableDataSourceOptions = (options as TimeFilterableDataSourceOptions);\r\n    if (\r\n      timeFilterableDataSourceOptions?.timeFilterable &&\r\n      timeFilterableDataSourceOptions?.timeFilter) {\r\n      this.setTimeFilter(timeFilterableDataSourceOptions.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  refresh() {\r\n    this.ol.updateParams({ igoRefresh: Math.random() });\r\n  }\r\n\r\n  private buildDynamicDownloadUrlFromParamsWFS(asWFSDataSourceOptions) {\r\n    const queryStringValues = formatWFSQueryString(asWFSDataSourceOptions);\r\n    const downloadUrl = queryStringValues.find(f => f.name === 'getfeature')\r\n      .value;\r\n    return downloadUrl;\r\n  }\r\n\r\n  protected createOlSource(): olSourceImageWMS {\r\n    return new olSourceImageWMS(Object.assign({ratio: 1}, this.options));\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    if (triggerEvent) {\r\n      this.ogcFilters$.next(this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  setTimeFilter(timeFilter: TimeFilterOptions, triggerEvent: boolean = false) {\r\n    this.timeFilter = timeFilter;\r\n    if (triggerEvent) {\r\n      this.timeFilter$.next(this.timeFilter);\r\n    }\r\n  }\r\n\r\n  getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    let legend = super.getLegend();\r\n    if (legend.length > 0 && (style === undefined && !view?.scale)) {\r\n      return legend;\r\n    }\r\n\r\n    let contentDependent = false;\r\n    let projParam;\r\n\r\n    if (view?.size && view?.extent && view?.projection && this.options.contentDependentLegend) {\r\n      projParam = this.params.VERSION === '1.3.0' || this.params.VERSION === undefined ? 'CRS' : 'SRS';\r\n      contentDependent = true;\r\n    }\r\n\r\n    const sourceParams = this.params;\r\n\r\n    let layers = [];\r\n    if (sourceParams.LAYERS !== undefined) {\r\n      layers = sourceParams.LAYERS.split(',');\r\n    }\r\n\r\n    const baseUrl = this.options.url.replace(/\\?$/, '');\r\n    const params = [\r\n      'REQUEST=GetLegendGraphic',\r\n      'SERVICE=WMS',\r\n      'FORMAT=image/png',\r\n      'SLD_VERSION=1.1.0',\r\n      `VERSION=${sourceParams.VERSION || '1.3.0'}`\r\n    ];\r\n    if (style !== undefined) {\r\n      params.push(`STYLE=${style}`);\r\n    }\r\n    if (view?.scale !== undefined) {\r\n      params.push(`SCALE=${view.scale}`);\r\n    }\r\n    if (contentDependent) {\r\n      params.push(`WIDTH=${view.size[0]}`);\r\n      params.push(`HEIGHT=${view.size[1]}`);\r\n      params.push(`BBOX=${view.extent.join(',')}`);\r\n      params.push(`${projParam}=${view.projection}`);\r\n    }\r\n\r\n    legend = layers.map((layer: string) => {\r\n      const separator = baseUrl.match(/\\?/) ? '&' : '?';\r\n      return {\r\n        url: `${baseUrl}${separator}${params.join('&')}&LAYER=${layer}`,\r\n        title: layers.length > 1 ? layer : undefined,\r\n        currentStyle: style === undefined ? undefined : style as string\r\n      };\r\n    });\r\n\r\n    return legend;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { Watcher } from '@igo2/utils';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\nimport { DataSource } from '../../datasource/shared/datasources/datasource';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayersLink, LinkedProperties } from '../shared/layers/layer.interface';\r\nimport { OgcFilterableDataSource, OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { TimeFilterableDataSource } from '../../filter/shared/time-filter.interface';\r\nimport { Subscription } from 'rxjs';\r\nimport { first } from 'rxjs/operators';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nexport class LayerSyncWatcher extends Watcher {\r\n    private ogcFilters$$: Subscription;\r\n    private timeFilter$$: Subscription;\r\n\r\n    private ol: olLayer<olSource>;\r\n    private layer: Layer;\r\n    private dataSource: DataSource;\r\n    private map: IgoMap;\r\n    private ogcFilterWriter;\r\n\r\n    constructor(layer: Layer, map: IgoMap) {\r\n        super();\r\n        this.ol = layer.ol;\r\n        this.layer = layer;\r\n        this.dataSource = layer.options.source;\r\n        this.map = map;\r\n        this.ogcFilterWriter = new OgcFilterWriter();\r\n    }\r\n\r\n    protected watch() {\r\n\r\n        this.ol.on('propertychange', evt => this.transferCommonProperties(evt));\r\n        if ((this.dataSource as OgcFilterableDataSource).ogcFilters$) {\r\n            this.ogcFilters$$ = (this.dataSource as OgcFilterableDataSource).ogcFilters$\r\n                .subscribe(ogcFilters => this.transferOgcFiltersProperties(ogcFilters));\r\n        }\r\n        if ((this.dataSource as TimeFilterableDataSource).timeFilter$) {\r\n            this.timeFilter$$ = (this.dataSource as TimeFilterableDataSource).timeFilter$\r\n                .subscribe(timeFilter => this.transferTimeFilterProperties(timeFilter));\r\n        }\r\n        this.syncChildLayers();\r\n    }\r\n\r\n    protected unwatch() {\r\n        this.ol.un('propertychange', evt => this.transferCommonProperties(evt));\r\n        if (this.ogcFilters$$) { this.ogcFilters$$.unsubscribe(); }\r\n        if (this.timeFilter$$) { this.timeFilter$$.unsubscribe(); }\r\n    }\r\n\r\n\r\n    private syncChildLayers() {\r\n        // Force the sync the child layers with parent on the first load.\r\n        if (!this.map) {\r\n            return;\r\n        }\r\n        this.map.status$\r\n            .pipe(first())\r\n            .subscribe(() => {\r\n                this.map.layers\r\n                    .filter(layer => layer.options.linkedLayers?.links)\r\n                    .map(layer => {\r\n                        layer.options.linkedLayers.links.map(link => {\r\n                            if (link.properties?.indexOf(LinkedProperties.VISIBLE) !== -1) {\r\n                                layer.ol.set('visible', !(layer.visible), false);\r\n                                layer.ol.set('visible', !(layer.visible), false);\r\n                                layer.visible = layer.visible;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.OPACITY) !== -1) {\r\n                                const baseOpacity = layer.ol.get('opacity');\r\n                                layer.ol.set('opacity', 0, false);\r\n                                layer.ol.set('opacity', baseOpacity, false);\r\n                                layer.opacity = layer.opacity;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.MINRESOLUTION) !== -1) {\r\n                                const baseMinResolution = layer.ol.get('minResolution');\r\n                                layer.ol.set('minResolution', 0, false);\r\n                                layer.ol.set('minResolution', baseMinResolution, false);\r\n                                layer.minResolution = layer.minResolution;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.MAXRESOLUTION) !== -1) {\r\n                                const baseMaxResolution = layer.ol.get('maxResolution');\r\n                                layer.ol.set('maxResolution', 0, false);\r\n                                layer.ol.set('maxResolution', baseMaxResolution, false);\r\n                                layer.minResolution = layer.minResolution;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.OGCFILTERS) !== -1) {\r\n                                const ogcFilters$ = (layer.dataSource as OgcFilterableDataSource).ogcFilters$;\r\n                                ogcFilters$.next(ogcFilters$.value);\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.TIMEFILTER) !== -1) {\r\n                                const timeFilter$ = (layer.dataSource as TimeFilterableDataSource).timeFilter$;\r\n                                timeFilter$.next(timeFilter$.value);\r\n                            }\r\n                        });\r\n                    });\r\n            });\r\n    }\r\n\r\n    private transferCommonProperties(layerChange) {\r\n        const key = layerChange.key;\r\n        const layerChangeProperties = layerChange.target.getProperties();\r\n        const newValue = layerChangeProperties[key];\r\n\r\n        if (['visible', 'opacity', 'minResolution', 'maxResolution'].indexOf(key) === -1) {\r\n            return;\r\n        }\r\n        const linkedLayers = layerChangeProperties.linkedLayers as LayersLink;\r\n        if (!linkedLayers) {\r\n            return;\r\n        }\r\n        const currentLinkedId = linkedLayers.linkId;\r\n        const currentLinks = linkedLayers.links;\r\n        const isParentLayer = currentLinks ? true : false;\r\n\r\n        if (isParentLayer) {\r\n            // search for child layers\r\n            const silent = true;\r\n            currentLinks.map(link => {\r\n                if (!link.properties || link.properties.indexOf(key) === -1) {\r\n                    return;\r\n                }\r\n                link.linkedIds.map(linkedId => {\r\n                    const layerToApply = this.map.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n                    if (layerToApply) {\r\n                        layerToApply.ol.set(key, newValue, silent);\r\n                        if (key === 'visible') {\r\n                            layerToApply.visible$.next(newValue);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // search for parent layer\r\n            const silent = false;\r\n            this.map.layers.map(layer => {\r\n                if (layer.options.linkedLayers?.links) {\r\n                    layer.options.linkedLayers.links.map(l => {\r\n                        if (l.properties && l.properties.indexOf(key) !== -1 &&\r\n                            l.bidirectionnal !== false && l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n                            layer.ol.set(key, newValue, silent);\r\n                            if (key === 'visible') {\r\n                                layer.visible$.next(newValue);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    private transferOgcFiltersProperties(ogcFilters) {\r\n        const linkedLayers = this.ol.getProperties().linkedLayers as LayersLink;\r\n        if (!linkedLayers) {\r\n            return;\r\n        }\r\n        const currentLinkedId = linkedLayers.linkId;\r\n        const currentLinks = linkedLayers.links;\r\n        const isParentLayer = currentLinks ? true : false;\r\n        if (isParentLayer) {\r\n            // search for child layers\r\n            currentLinks.map(link => {\r\n                if (!link.properties || link.properties.indexOf(LinkedProperties.OGCFILTERS) === -1) {\r\n                    return;\r\n                }\r\n                link.linkedIds.map(linkedId => {\r\n                    const layerToApply = this.map.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n                    if (layerToApply) {\r\n                        const layerType = layerToApply.ol.getProperties().sourceOptions.type;\r\n                        (layerToApply.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, false);\r\n                        if (layerType === 'wfs') {\r\n                            if (ogcFilters !== (layerToApply.dataSource as OgcFilterableDataSource).ogcFilters$.value) {\r\n                                layerToApply.ol.getSource().refresh();\r\n                            }\r\n                        }\r\n                        if (layerType === 'wms') {\r\n                            let appliedOgcFilter;\r\n                            if (this.ol.getProperties().sourceOptions.type === 'wfs') {\r\n                                appliedOgcFilter = this.ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n                                    this.layer.dataSource.options as OgcFilterableDataSourceOptions,\r\n                                    (this.dataSource.options as any).fieldNameGeometry,\r\n                                    undefined,\r\n                                    this.map.viewController.getOlProjection()\r\n                                );\r\n                            } else if (this.ol.getProperties().sourceOptions.type === 'wms') {\r\n                                appliedOgcFilter = (this.dataSource as WMSDataSource).ol.getParams().FILTER;\r\n                            }\r\n                            (layerToApply.dataSource as WMSDataSource).ol.updateParams({ FILTER: appliedOgcFilter });\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // search for parent layer\r\n            this.map.layers.map(layer => {\r\n                if (layer.options.linkedLayers?.links) {\r\n                    layer.options.linkedLayers.links.map(l => {\r\n                        if (l.properties && l.properties.indexOf(LinkedProperties.OGCFILTERS) !== -1 &&\r\n                            l.bidirectionnal !== false && l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n                            const layerType = layer.ol.getProperties().sourceOptions.type;\r\n                            if (layerType === 'wfs') {\r\n                                if (ogcFilters !== (layer.dataSource as OgcFilterableDataSource).ogcFilters$.value) {\r\n                                    (layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n                                    layer.ol.getSource().refresh();\r\n                                }\r\n                            }\r\n                            if (layerType === 'wms') {\r\n                                let appliedOgcFilter;\r\n                                if (this.ol.getProperties().sourceOptions.type === 'wfs') {\r\n                                    appliedOgcFilter = this.ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n                                        layer.dataSource.options as OgcFilterableDataSourceOptions,\r\n                                        (this.dataSource.options as any).fieldNameGeometry,\r\n                                        undefined,\r\n                                        this.map.viewController.getOlProjection()\r\n                                    );\r\n\r\n                                } else if (this.ol.getProperties().sourceOptions.type === 'wms') {\r\n                                    appliedOgcFilter = (this.dataSource as WMSDataSource).ol.getParams().FILTER;\r\n                                }\r\n                                (layer.dataSource as WMSDataSource).ol.updateParams({ FILTER: appliedOgcFilter });\r\n                                (layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    private transferTimeFilterProperties(timeFilter) {\r\n        const linkedLayers = this.ol.getProperties().linkedLayers as LayersLink;\r\n        if (!linkedLayers) {\r\n            return;\r\n        }\r\n        const currentLinkedId = linkedLayers.linkId;\r\n        const currentLinks = linkedLayers.links;\r\n        const isParentLayer = currentLinks ? true : false;\r\n        if (isParentLayer) {\r\n            // search for child layers\r\n            currentLinks.map(link => {\r\n                if (!link.properties || link.properties.indexOf(LinkedProperties.TIMEFILTER) === -1) {\r\n                    return;\r\n                }\r\n                link.linkedIds.map(linkedId => {\r\n                    const childLayer = this.map.layers.find(layer =>\r\n                        layer.dataSource instanceof WMSDataSource &&\r\n                        layer.options.linkedLayers?.linkId === linkedId);\r\n                    if (childLayer) {\r\n                        (childLayer.dataSource as TimeFilterableDataSource).setTimeFilter(timeFilter, false);\r\n                        const appliedTimeFilter = (this.ol.getSource() as olSourceImageWMS).getParams().TIME;\r\n                        (childLayer.dataSource as WMSDataSource).ol.updateParams({ TIME: appliedTimeFilter });\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // search for parent layer\r\n            this.map.layers\r\n                .filter(layer => layer.dataSource instanceof WMSDataSource)\r\n                .map(parentLayer => {\r\n                    if (parentLayer.options.linkedLayers?.links) {\r\n                        parentLayer.options.linkedLayers.links.map(l => {\r\n                            if (l.properties && l.properties.indexOf(LinkedProperties.TIMEFILTER) !== -1 &&\r\n                                l.bidirectionnal !== false && l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n                                const appliedTimeFilter = (this.ol.getSource() as olSourceImageWMS).getParams().TIME;\r\n                                (parentLayer.dataSource as WMSDataSource).ol.updateParams({ TIME: appliedTimeFilter });\r\n                                (parentLayer.dataSource as TimeFilterableDataSource).setTimeFilter(timeFilter, true);\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n        }\r\n    }\r\n}\r\n","import olSourceTile from 'ol/source/Tile';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { TileLayer } from '../shared/layers/tile-layer';\r\nimport { VectorTileLayer } from '../shared/layers/vectortile-layer';\r\n\r\nexport class TileWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private source: olSourceTile;\r\n\r\n  constructor(layer: TileLayer | VectorTileLayer) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    // This is to avoid increasing\r\n    // the number of loaded tiles if a tile was loading\r\n    // before subscribing to this watcher\r\n    if (!event.tile.__watchers__) {\r\n      event.tile.__watchers__ = [];\r\n    }\r\n    event.tile.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.tile.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.tile.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.tile.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as olformat from 'ol/format';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { FeatureDataSourceOptions } from './feature-datasource.interface';\r\n\r\nexport class FeatureDataSource extends DataSource {\r\n  public options: FeatureDataSourceOptions;\r\n  public ol: olSourceVector<OlGeometry>;\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const sourceOptions = {\r\n      format: this.getSourceFormatFromOptions(this.options)\r\n    };\r\n\r\n    return new olSourceVector(Object.assign(sourceOptions, this.options));\r\n  }\r\n\r\n  protected getSourceFormatFromOptions(options: FeatureDataSourceOptions) {\r\n    if (options.format) {\r\n      return options.format;\r\n    }\r\n    let olFormatCls;\r\n    const formatType = options.formatType;\r\n    if (!formatType) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    } else {\r\n      olFormatCls = olformat[formatType];\r\n      if (olFormatCls === undefined) {\r\n        throw new Error('Invalid vector source format ${formatType}.');\r\n      }\r\n    }\r\n\r\n    const formatOptions = options.formatOptions;\r\n    let format;\r\n    if (formatOptions) {\r\n      format = new olFormatCls(formatOptions);\r\n    } else {\r\n      format = new olFormatCls();\r\n    }\r\n\r\n    return format;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n}\r\n","import olSourceCluster from 'ol/source/Cluster';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { ClusterDataSourceOptions } from './cluster-datasource.interface';\r\n\r\nexport class ClusterDataSource extends FeatureDataSource {\r\n  public options: ClusterDataSourceOptions;\r\n  public ol: olSourceCluster;\r\n\r\n  protected createOlSource(): olSourceCluster {\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    this.options.source = super.createOlSource();\r\n    return new olSourceCluster(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    return uuid();\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { VectorLayer } from '../shared/layers/vector-layer';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\n\r\nexport class VectorWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private layer: VectorLayer;\r\n\r\n  constructor(layer: VectorLayer) {\r\n    super();\r\n    this.layer = layer;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n\r\n    if (olSource.getUrl()) {\r\n      olSource.on(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.on(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.on(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n\r\n  }\r\n\r\n  protected unwatch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n    if (olSource.getUrl()) {\r\n      olSource.un(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.un(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.un(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event: any) {\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import * as olproj from 'ol/proj';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { MAC } from 'ol/has';\r\n\r\nimport { NumberUtils } from '@igo2/utils';\r\n\r\nimport { MapViewState } from './map.interface';\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * This method extracts a coordinate tuple from a string.\r\n * @param str Any string\r\n * @param mapProjection string Map Projection\r\n * @param opts.forceNA boolean Force North America Zone\r\n * @returns object:\r\n *             lonLat: Coordinate,\r\n *             message: Message of error,\r\n *             radius: radius of the confience of coordinate,\r\n *             conf: confidence of the coordinate}\r\n */\r\nexport function stringToLonLat(\r\n  str: string,\r\n  mapProjection: string,\r\n  opts: { forceNA?: boolean } = {}\r\n): {\r\n  lonLat: [number, number] | undefined;\r\n  message: string;\r\n  radius: number | undefined;\r\n  conf: number | undefined;\r\n} {\r\n  let lonLat: [number, number];\r\n  let coordStr: string;\r\n  let negativeLon: string;\r\n  let degreesLon: string;\r\n  let minutesLon: string;\r\n  let secondsLon: string;\r\n  let directionLon: string;\r\n  let decimalLon: string;\r\n  let negativeLat: string;\r\n  let degreesLat: string;\r\n  let minutesLat: string;\r\n  let secondsLat: string;\r\n  let directionLat: string;\r\n  let decimalLat: string;\r\n  let zone: string;\r\n  let radius: string;\r\n  let conf: string;\r\n  let lon: any;\r\n  let lat: any;\r\n\r\n  const projectionPattern = '(\\\\s*;\\\\s*[\\\\d]{4,6})';\r\n  const toProjection = '4326';\r\n  let projectionStr: string;\r\n  const projectionRegex = new RegExp(projectionPattern, 'g');\r\n\r\n  const lonlatCoord = '([-+])?([\\\\d]{1,3})([,.](\\\\d+))?';\r\n  const lonLatPattern = `${lonlatCoord}[\\\\s,]+${lonlatCoord}`;\r\n  const lonLatRegex = new RegExp(`^${lonLatPattern}$`, 'g');\r\n\r\n  const dmsCoord =\r\n    '([0-9]{1,2})[:|°]?\\\\s*([0-9]{1,2})?[:|\\'|′|’]?\\\\s*([0-9]{1,2}(?:.[0-9]+){0,1})?\\\\s*[\"|″|”]?\\\\s*';\r\n  const dmsCoordPattern = `${dmsCoord}([N|S|E|W|O]),?\\\\s*${dmsCoord}([N|S|E|W|O])`;\r\n  const dmsRegex = new RegExp(`^${dmsCoordPattern}$`, 'gi');\r\n\r\n  const patternUtm =\r\n    '(UTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const utmRegex = new RegExp(`^${patternUtm}`, 'gi');\r\n\r\n  const patternMtm =\r\n    '(MTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const mtmRegex = new RegExp(`^${patternMtm}`, 'gi');\r\n\r\n  const ddCoord = '([-+])?(\\\\d{1,3})[,.](\\\\d+)';\r\n  const patternDd = `${ddCoord}\\\\s*[,]?\\\\s*${ddCoord}`;\r\n  const ddRegex = new RegExp(`^${patternDd}`, 'g');\r\n\r\n  const dmdCoord =\r\n    '([-+])?(\\\\d{1,3})[\\\\s,.]{1}(\\\\d{1,2})[\\\\s,.]{1}(\\\\d{1,2})[.,]?(\\\\d{1,5})?';\r\n  const patternDmd = `${dmdCoord}\\\\s*[,.]?\\\\s*${dmdCoord}`;\r\n  const dmdRegex = new RegExp(`^${patternDmd}`, 'g');\r\n\r\n /* eslint-disable max-len */\r\n  const patternBELL =\r\n    'LAT\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,2})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*LONG\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,3})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*UNC\\\\s*[\\\\s:]?\\\\s*(\\\\d+)\\\\s*CONF\\\\s*[\\\\s:]?\\\\s*(\\\\d{1,3})';\r\n  const bellRegex = new RegExp(`^${patternBELL}?`, 'gi');\r\n\r\n  const mmCoord = '([-+]?\\\\d+)[,.]?(\\\\d+)?';\r\n  const mmPattern = `${mmCoord}[\\\\s,]+${mmCoord}`;\r\n  const mmRegex = new RegExp(`^${mmPattern}$`, 'g');\r\n\r\n  let isXYCoords = false;\r\n\r\n  str = str.toLocaleUpperCase().trim();\r\n\r\n  // Extract projection\r\n  if (projectionRegex.test(str)) {\r\n    [coordStr, projectionStr] = str.split(';').map(s => s.trim());\r\n  } else {\r\n    coordStr = str;\r\n  }\r\n  if (lonLatRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      lon,\r\n      ,\r\n      decimalLon,\r\n      negativeLat,\r\n      lat,\r\n      ,\r\n      decimalLat\r\n    ] = coordStr.match(lonLatPattern);\r\n\r\n    lon = parseFloat((negativeLon ? negativeLon : '') + lon + '.' + decimalLon);\r\n    lat = parseFloat((negativeLat ? negativeLat : '') + lat + '.' + decimalLat);\r\n  } else if (dmsRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      directionLon,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      directionLat\r\n    ] = coordStr.match(dmsCoordPattern);\r\n\r\n    if (directionLon === 'S' || directionLon === 'N') {\r\n      degreesLon = [degreesLat, (degreesLat = degreesLon)][0];\r\n      minutesLon = [minutesLat, (minutesLat = minutesLon)][0];\r\n      secondsLon = [secondsLat, (secondsLat = secondsLon)][0];\r\n      directionLon = [directionLat, (directionLat = directionLon)][0];\r\n    }\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat(degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat(degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (utmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternUtm);\r\n    const epsgUtm = Number(zone) < 10 ? `EPSG:3260${zone}` : `EPSG:326${zone}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgUtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (mtmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternMtm);\r\n    const epsgMtm =\r\n      Number(zone) < 10 ? `EPSG:3218${zone}` : `EPSG:321${80 + Number(zone)}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgMtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (dmdRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDmd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (ddRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (bellRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      ,\r\n      directionLat,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      ,\r\n      directionLon,\r\n      radius,\r\n      conf\r\n    ] = coordStr.match(patternBELL);\r\n\r\n    // Set default value for North America\r\n    if (!directionLon) {\r\n      directionLon = 'W';\r\n    }\r\n\r\n    // Check if real minutes or decimals\r\n    if (minutesLon && minutesLon.length > 2) {\r\n      lon = parseFloat(\r\n        (negativeLon ? negativeLon : '') + degreesLon + '.' + minutesLon\r\n      );\r\n    } else {\r\n      lon = convertDMSToDD(\r\n        parseFloat(degreesLon),\r\n        parseFloat(minutesLon),\r\n        parseFloat(secondsLon),\r\n        directionLon\r\n      );\r\n    }\r\n\r\n    if (minutesLat && minutesLat.length > 2) {\r\n      lat = parseFloat(\r\n        (negativeLat ? negativeLat : '') + degreesLat + '.' + minutesLat\r\n      );\r\n    } else {\r\n      lat = convertDMSToDD(\r\n        parseFloat(degreesLat),\r\n        parseFloat(minutesLat),\r\n        parseFloat(secondsLat),\r\n        directionLat\r\n      );\r\n    }\r\n  } else if (mmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, lon, decimalLon, lat, decimalLat] = coordStr.match(mmPattern);\r\n\r\n    if (decimalLon) {\r\n      lon = parseFloat(lon + '.' + decimalLon);\r\n    }\r\n\r\n    if (decimalLat) {\r\n      lat = parseFloat(lat + '.' + decimalLat);\r\n    }\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: '',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n\r\n  if (opts.forceNA && !isXYCoords) {\r\n    // Set a negative coordinate for North America zone\r\n    if (lon > 0 && lat > 0) {\r\n      if (lon > lat) {\r\n        lon = -lon;\r\n      } else {\r\n        lat = -lat;\r\n      }\r\n    }\r\n\r\n    // Reverse coordinate to respect lonLat convention\r\n    if (lon > lat) {\r\n      lon = [lat, (lat = lon)][0];\r\n    }\r\n  }\r\n\r\n  lonLat = [Number(lon), Number(lat)] as [number, number];\r\n\r\n  // Reproject the coordinate if projection parameter have been set and coord is not 4326\r\n  if (\r\n    (projectionStr !== undefined && projectionStr !== toProjection) ||\r\n    (lonLat[0] > 180 || lonLat[0] < -180) ||\r\n    (lonLat[1] > 90 || lonLat[1] < -90)\r\n  ) {\r\n    const source = projectionStr ? 'EPSG:' + projectionStr : mapProjection;\r\n    const dest = 'EPSG:' + toProjection;\r\n\r\n    try {\r\n      lonLat = olproj.transform(lonLat, source, dest) as [number, number];\r\n    } catch (e) {\r\n      return {\r\n        lonLat: undefined,\r\n        message: 'Projection ' + source + ' not supported',\r\n        radius: undefined,\r\n        conf: undefined\r\n      };\r\n    }\r\n  }\r\n  if (Math.abs(lonLat[0]) <= 180 && Math.abs(lonLat[1]) <= 90) {\r\n    return {\r\n      lonLat,\r\n      message: '',\r\n      radius: radius ? parseInt(radius, 10) : undefined,\r\n      conf: conf ? parseInt(conf, 10) : undefined\r\n    };\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: 'Coordinate out of Longitude/Latitude bounds',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Convert degrees minutes seconds to dd\r\n * @param degrees Degrees\r\n * @param minutes Minutes\r\n * @param seconds Seconds\r\n * @param direction Direction\r\n */\r\nfunction convertDMSToDD(\r\n  degrees: number,\r\n  minutes: number,\r\n  seconds: number,\r\n  direction: string\r\n) {\r\n  minutes = minutes || 0;\r\n  seconds = seconds || 0;\r\n\r\n  const neg = degrees < 0;\r\n  let dd = Math.abs(degrees) + minutes / 60 + seconds / 3600;\r\n\r\n  if (neg || direction === 'S' || direction === 'W') {\r\n    dd = -dd;\r\n  } // Don't do anything for N or E\r\n  return dd;\r\n}\r\n\r\n/**\r\n * Convert dd to degrees minutes seconds\r\n * @param lonLatDD longitude and latitude in dd\r\n * @param decimal number of decimals for seconds\r\n * @returns longitude and latitude in dms\r\n */\r\nexport function convertDDToDMS(\r\n  lonLatDD: [number, number], decimal: number = 3\r\n): string[] {\r\n  const lonLatDMS = [];\r\n\r\n  lonLatDD.forEach(dd => {\r\n    const degrees = dd < 0 ? Math.ceil(dd) : Math.floor(dd);\r\n    const int = dd < 0 ? (degrees - dd) * 60 : (dd - degrees) * 60;\r\n    const minutes = Math.floor(int);\r\n    const seconds = ((int - minutes) * 60).toFixed(decimal);\r\n\r\n    lonLatDMS.push(`${degrees}° ${minutes}' ${seconds}\"`);\r\n  });\r\n  return lonLatDMS;\r\n}\r\n\r\n/**\r\n * Return true of two view states are equal.\r\n * @param state1 View state\r\n * @param state2 View state\r\n * @returns True if the view states are equal\r\n */\r\nexport function viewStatesAreEqual(\r\n  state1: MapViewState,\r\n  state2: MapViewState\r\n): boolean {\r\n  if (state1 === undefined || state2 === undefined) {\r\n    return false;\r\n  }\r\n\r\n  const tolerance = 1 / 10000;\r\n  return (\r\n    state1.zoom === state2.zoom &&\r\n    Math.trunc(state1.center[0] / tolerance) ===\r\n      Math.trunc(state2.center[0] / tolerance) &&\r\n    Math.trunc(state1.center[1] / tolerance) ===\r\n      Math.trunc(state2.center[1] / tolerance)\r\n  );\r\n}\r\n\r\n/**\r\n * Format the scale to a human readable text\r\n * @param Scale of the map\r\n * @returns Human readable scale text\r\n */\r\nexport function formatScale(scale) {\r\n  scale = Math.round(scale);\r\n  if (scale < 10000) {\r\n    return scale + '';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  if (scale < 1000) {\r\n    return scale + 'K';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  return scale + 'M';\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param scale Scale denom\r\n * @param dpi DPI\r\n * @returns Resolution\r\n */\r\nexport function getResolutionFromScale(\r\n  scale: number,\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return scale / (inchesPerMeter * dpi);\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param Scale denom\r\n * @returns Resolution\r\n */\r\nexport function getScaleFromResolution(\r\n  resolution: number,\r\n  unit: string = 'm',\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return resolution * olproj.METERS_PER_UNIT[unit] * inchesPerMeter * dpi;\r\n}\r\n\r\n/**\r\n * Returns true if the CTRL key is pushed during an Ol MapBrowserPointerEvent\r\n * @param event OL MapBrowserPointerEvent\r\n * @returns Whether the CTRL key is pushed\r\n */\r\nexport function ctrlKeyDown(event: MapBrowserPointerEvent<any>): boolean {\r\n  const originalEvent = event.originalEvent;\r\n  return (\r\n    !originalEvent.altKey &&\r\n    (MAC ? originalEvent.metaKey : originalEvent.ctrlKey) &&\r\n    !originalEvent.shiftKey\r\n  );\r\n}\r\n\r\nexport function roundCoordTo(coord: [number, number], decimal: number = 3): [number, number] {\r\n  return [\r\n    NumberUtils.roundToNDecimal(coord[0], decimal),\r\n    NumberUtils.roundToNDecimal(coord[1], decimal)] as [number, number];\r\n}\r\n\r\n/**\r\n * Returns an array of converted coordinates.\r\n * Conversion is done for every configured projections\r\n * and for the current UTM zone and MTM zone.\r\n * @param lonLat [number, number] array of the coordinate to transform.\r\n * @param projections  Projection[] Array of destination projection.\r\n * @returns Returns an array of converted coordinates.\r\n */\r\nexport function lonLatConversion(\r\n  lonLat: [number, number],\r\n  projections: Projection[]\r\n): {\r\n  code: string;\r\n  alias: string;\r\n  coord: [number, number];\r\n  igo2CoordFormat: string;\r\n}[] {\r\n  const rawCoord3857 = olproj.transform(lonLat, 'EPSG:4326', 'EPSG:3857') as [number, number];\r\n  const convertedLonLat = [\r\n    {\r\n      code: 'EPSG:3857',\r\n      alias: 'Web Mercator',\r\n      coord: rawCoord3857,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord3857).join(', ')} ; 3857`\r\n    }\r\n  ];\r\n\r\n  // detect the current utm zone.\r\n  const utmZone = utmZoneFromLonLat(lonLat);\r\n  const epsgUtm = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n  const utmName = `UTM-${utmZone}`;\r\n  const rawCoordUtm = olproj.transform(lonLat, 'EPSG:4326', epsgUtm) as [number, number];\r\n  convertedLonLat.push({\r\n    code: epsgUtm,\r\n    alias: 'UTM',\r\n    coord: rawCoordUtm,\r\n    igo2CoordFormat: `${utmName} ${roundCoordTo(rawCoordUtm).join(', ')}`\r\n  });\r\n\r\n  // detect the current mtm zone.\r\n  const mtmZone = mtmZoneFromLonLat(lonLat);\r\n  if (mtmZone) {\r\n    const epsgMtm =\r\n      mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n    const mtmName = `MTM-${mtmZone}`;\r\n    const rawCoordMtm = olproj.transform(lonLat, 'EPSG:4326', epsgMtm) as [number, number];\r\n    convertedLonLat.push({\r\n      code: epsgMtm,\r\n      alias: 'MTM',\r\n      coord: rawCoordMtm,\r\n      igo2CoordFormat: `${mtmName} ${roundCoordTo(rawCoordMtm).join(', ')}`\r\n    });\r\n  }\r\n\r\n  projections.forEach(projection => {\r\n    const rawCoord = olproj.transform(lonLat, 'EPSG:4326', projection.code) as [number, number];\r\n    const numericEpsgCode = projection.code.split(':')[1];\r\n    convertedLonLat.push({\r\n      code: projection.code,\r\n      alias: projection.alias || projection.code,\r\n      coord: rawCoord,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord).join(\r\n        ', '\r\n      )} ; ${numericEpsgCode}`\r\n    });\r\n  });\r\n\r\n  return convertedLonLat;\r\n}\r\n\r\n/**\r\n * Detect the current utm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the UTM zone.\r\n * @returns number The UTM zone.\r\n */\r\nexport function utmZoneFromLonLat(lonLat: [number, number]) {\r\n  return Math.ceil((lonLat[0] + 180) / 6);\r\n}\r\n\r\n/**\r\n * Detect the current mtm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the MTM zone.\r\n * @returns number The MTM zone. Undefined if outside of the mtm application zone.\r\n */\r\nexport function mtmZoneFromLonLat(lonLat: [number, number]) {\r\n  const long = lonLat[0];\r\n  let mtmZone;\r\n  if (long < -51 && long > -54) {\r\n    mtmZone = 1;\r\n  }\r\n  if (long < -54 && long > -57) {\r\n    mtmZone = 2;\r\n  }\r\n  if (long < -57 && long > -60) {\r\n    mtmZone = 3;\r\n  }\r\n  if (long < -60 && long > -63) {\r\n    mtmZone = 4;\r\n  }\r\n  if (long < -63 && long > -66) {\r\n    mtmZone = 5;\r\n  }\r\n  if (long < -66 && long > -69) {\r\n    mtmZone = 6;\r\n  }\r\n  if (long < -69 && long > -72) {\r\n    mtmZone = 7;\r\n  }\r\n  if (long < -72 && long > -75) {\r\n    mtmZone = 8;\r\n  }\r\n  if (long < -75 && long > -78) {\r\n    mtmZone = 9;\r\n  }\r\n  if (long < -78 && long > -81) {\r\n    mtmZone = 10;\r\n  }\r\n  return mtmZone;\r\n}\r\n","import {\r\n  BehaviorSubject,\r\n  Observable,\r\n  Subject,\r\n  Subscription,\r\n  combineLatest\r\n} from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { DataSource, Legend } from '../../../datasource';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\n\r\nimport { LayerOptions } from './layer.interface';\r\nimport { LayerSyncWatcher } from '../../utils/layerSync-watcher';\r\nimport { Message, MessageService } from '@igo2/core';\r\n\r\nexport abstract class Layer {\r\n  public collapsed: boolean;\r\n  public dataSource: DataSource;\r\n  public legend: Legend[];\r\n  public legendCollapsed: boolean = true;\r\n  public firstLoadComponent: boolean = true;\r\n  public map: IgoMap;\r\n  public ol: olLayer<olSource>;\r\n  public olLoadingProblem: boolean = false;\r\n  public status$: Subject<SubjectStatus>;\r\n  public hasBeenVisible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n  private hasBeenVisible$$: Subscription;\r\n  private resolution$$: Subscription;\r\n\r\n  /**\r\n   * Define if a layer is generated by code OR defined by layer/context user layer.\r\n   * Useful for filtering layers list in mapOffline.directive or in the sharemap...\r\n   * return false by default.\r\n   */\r\n  get isIgoInternalLayer(): boolean {\r\n    return this.options.isIgoInternalLayer || false;\r\n  }\r\n\r\n  get id(): string {\r\n    return this.options.id || this.dataSource.id;\r\n  }\r\n\r\n  get alias(): string {\r\n    return this.options.alias;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  set title(title: string) {\r\n    this.options.title = title;\r\n  }\r\n\r\n  get zIndex(): number {\r\n    return this.ol.getZIndex();\r\n  }\r\n\r\n  set zIndex(zIndex: number) {\r\n    this.ol.setZIndex(zIndex);\r\n  }\r\n\r\n  get baseLayer(): boolean {\r\n    return this.options.baseLayer;\r\n  }\r\n\r\n  set baseLayer(baseLayer: boolean) {\r\n    this.options.baseLayer = baseLayer;\r\n  }\r\n\r\n  get opacity(): number {\r\n    return this.ol.get('opacity');\r\n  }\r\n\r\n  set opacity(opacity: number) {\r\n    this.ol.setOpacity(opacity);\r\n  }\r\n\r\n  set isInResolutionsRange(value: boolean) {\r\n    this.isInResolutionsRange$.next(value);\r\n  }\r\n  get isInResolutionsRange(): boolean {\r\n    return this.isInResolutionsRange$.value;\r\n  }\r\n  readonly isInResolutionsRange$: BehaviorSubject<\r\n    boolean\r\n  > = new BehaviorSubject(false);\r\n\r\n  set maxResolution(value: number) {\r\n    this.ol.setMaxResolution(value || Infinity);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get maxResolution(): number {\r\n    return this.ol.getMaxResolution();\r\n  }\r\n\r\n  set minResolution(value: number) {\r\n    this.ol.setMinResolution(value || 0);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get minResolution(): number {\r\n    return this.ol.getMinResolution();\r\n  }\r\n\r\n  set visible(value: boolean) {\r\n    this.ol.setVisible(value);\r\n    this.visible$.next(value);\r\n    if (!this.hasBeenVisible$.value && value){\r\n      this.hasBeenVisible$.next(value);\r\n    }\r\n    if (this.options?.messages && value) {\r\n      this.options?.messages\r\n        .filter(m => m.options?.showOnEachLayerVisibility)\r\n        .map(message =>\r\n          this.showMessage(message)\r\n        );\r\n    }\r\n  }\r\n  get visible(): boolean {\r\n    return this.visible$.value;\r\n  }\r\n  readonly visible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  get displayed(): boolean {\r\n    return this.visible && this.isInResolutionsRange;\r\n  }\r\n  readonly displayed$: Observable<boolean> = combineLatest([\r\n    this.isInResolutionsRange$,\r\n    this.visible$\r\n  ]).pipe(map((bunch: [boolean, boolean]) => bunch[0] && bunch[1]));\r\n\r\n  get showInLayerList(): boolean {\r\n    return this.options.showInLayerList !== false;\r\n  }\r\n\r\n  private layerSyncWatcher: LayerSyncWatcher;\r\n\r\n  constructor(\r\n    public options: LayerOptions,\r\n    protected messageService?: MessageService,\r\n    protected authInterceptor?: AuthInterceptor\r\n  ) {\r\n    this.dataSource = options.source;\r\n\r\n    this.ol = this.createOlLayer();\r\n    if (options.zIndex !== undefined) {\r\n      this.zIndex = options.zIndex;\r\n    }\r\n\r\n    if (options.baseLayer && options.visible === undefined) {\r\n      options.visible = false;\r\n    }\r\n\r\n    this.maxResolution = options.maxResolution || getResolutionFromScale(Number(options.maxScaleDenom));\r\n    this.minResolution = options.minResolution || getResolutionFromScale(Number(options.minScaleDenom));\r\n\r\n    this.visible = options.visible === undefined ? true : options.visible;\r\n    this.opacity = options.opacity === undefined ? 1 : options.opacity;\r\n\r\n    if (\r\n      options.legendOptions &&\r\n      (options.legendOptions.url || options.legendOptions.html)\r\n    ) {\r\n      this.legend = this.dataSource.setLegend(options.legendOptions);\r\n    }\r\n\r\n    this.legendCollapsed = options.legendOptions\r\n      ? options.legendOptions.collapsed\r\n        ? options.legendOptions.collapsed\r\n        : true\r\n      : true;\r\n\r\n    this.ol.set('_layer', this, true);\r\n  }\r\n\r\n  protected abstract createOlLayer(): olLayer<olSource>;\r\n\r\n  setMap(igoMap: IgoMap | undefined) {\r\n    this.map = igoMap;\r\n\r\n    this.unobserveResolution();\r\n    if (igoMap !== undefined) {\r\n      this.observeResolution();\r\n      this.layerSyncWatcher = new LayerSyncWatcher(this, this.map);\r\n      this.layerSyncWatcher.subscribe(() => {});\r\n      this.hasBeenVisible$$ = this.hasBeenVisible$.subscribe(() => {\r\n        if (this.options.messages && this.visible) {\r\n          this.options.messages.map(message => {\r\n            this.showMessage(message);\r\n          });\r\n        }\r\n      });\r\n    } else {\r\n      this.layerSyncWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  private showMessage(message: Message) {\r\n    if (!this.messageService) {\r\n      return;\r\n    }\r\n    message.title = message.title;\r\n    message.text = message.text;\r\n    this.messageService.message(message as Message);\r\n  }\r\n\r\n  private observeResolution() {\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(() =>\r\n      this.updateInResolutionsRange()\r\n    );\r\n  }\r\n\r\n  private unobserveResolution() {\r\n    if (this.resolution$$ !== undefined) {\r\n      this.resolution$$.unsubscribe();\r\n      this.resolution$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private updateInResolutionsRange() {\r\n    if (this.map !== undefined) {\r\n      const resolution = this.map.viewController.getResolution();\r\n      const minResolution = this.minResolution;\r\n      const maxResolution = this.maxResolution === undefined ? Infinity : this.maxResolution;\r\n      this.isInResolutionsRange = resolution >= minResolution && resolution <= maxResolution;\r\n    } else {\r\n      this.isInResolutionsRange = false;\r\n    }\r\n  }\r\n}\r\n","import olLayerVector from 'ol/layer/Vector';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { easeOut } from 'ol/easing';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\nimport { getVectorContext } from 'ol/render';\r\nimport FormatType from 'ol/format/FormatType';\r\nimport olFeature from 'ol/Feature';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { FeatureDataSource } from '../../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSource } from '../../../datasource/shared/datasources/wfs-datasource';\r\nimport { ArcGISRestDataSource } from '../../../datasource/shared/datasources/arcgisrest-datasource';\r\nimport { WebSocketDataSource } from '../../../datasource/shared/datasources/websocket-datasource';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\nimport { VectorWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\nimport { Layer } from './layer';\r\nimport { VectorLayerOptions } from './vector-layer.interface';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { MessageService } from '@igo2/core';\r\nimport { WFSDataSourceOptions } from '../../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { buildUrl, defaultMaxFeatures } from '../../../datasource/shared/datasources/wms-wfs.utils';\r\nimport { OgcFilterableDataSourceOptions } from '../../../filter/shared/ogc-filter.interface';\r\nexport class VectorLayer extends Layer {\r\n  public dataSource:\r\n    | FeatureDataSource\r\n    | WFSDataSource\r\n    | ArcGISRestDataSource\r\n    | WebSocketDataSource\r\n    | ClusterDataSource;\r\n  public options: VectorLayerOptions;\r\n  public ol: olLayerVector<olSourceVector<OlGeometry>>;\r\n  private watcher: VectorWatcher;\r\n  private trackFeatureListenerId;\r\n\r\n  get browsable(): boolean {\r\n    return this.options.browsable !== false;\r\n  }\r\n\r\n  get exportable(): boolean {\r\n    return this.options.exportable !== false;\r\n  }\r\n\r\n  constructor(\r\n    options: VectorLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new VectorWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVector<olSourceVector<OlGeometry>> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVector<OlGeometry>\r\n    });\r\n\r\n    if (this.options.animation) {\r\n      this.dataSource.ol.on(\r\n        'addfeature',\r\n        function(e) {\r\n          this.flash(e.feature);\r\n        }.bind(this)\r\n      );\r\n    }\r\n\r\n    if (this.options.trackFeature) {\r\n      this.enableTrackFeature(this.options.trackFeature);\r\n    }\r\n\r\n    const vector = new olLayerVector(olOptions);\r\n    const vectorSource = vector.getSource() as olSourceVector<OlGeometry>;\r\n    const url = vectorSource.getUrl();\r\n    if (url) {\r\n      let loader;\r\n      const wfsOptions = olOptions.sourceOptions as WFSDataSourceOptions;\r\n      if (wfsOptions?.type === 'wfs' && (wfsOptions.params || wfsOptions.paramsWFS)) {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customWFSLoader(\r\n            vectorSource,\r\n            wfsOptions,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      } else {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customLoader(\r\n            vectorSource,\r\n            url,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      }\r\n      if (loader) {\r\n        vectorSource.setLoader(loader);\r\n      }\r\n    }\r\n    return vector;\r\n  }\r\n\r\n  protected flash(feature) {\r\n    const start = new Date().getTime();\r\n    const listenerKey = this.ol.on('postrender', animate.bind(this));\r\n\r\n    function animate(event) {\r\n      const vectorContext = getVectorContext(event);\r\n      const frameState = event.frameState;\r\n      const flashGeom = feature.getGeometry().clone();\r\n      const elapsed = frameState.time - start;\r\n      const elapsedRatio = elapsed / this.options.animation.duration;\r\n      const opacity = easeOut(1 - elapsedRatio);\r\n      const newColor = ColorAsArray(this.options.animation.color || 'red');\r\n      newColor[3] = opacity;\r\n      let style = this.ol\r\n        .getStyleFunction()\r\n        .call(this, feature)\r\n        .find((style2) => {\r\n          return style2.getImage();\r\n        });\r\n      if (!style) {\r\n        style = this.ol.getStyleFunction().call(this, feature)[0];\r\n      }\r\n      const styleClone = style.clone();\r\n\r\n      switch (feature.getGeometry().getType()) {\r\n        case 'Point':\r\n          const radius =\r\n            easeOut(elapsedRatio) * (styleClone.getImage().getRadius() * 3);\r\n          styleClone.getImage().setRadius(radius);\r\n          styleClone.getImage().setOpacity(opacity);\r\n          break;\r\n        case 'LineString':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getStroke().setColor(newColor);\r\n            styleClone\r\n              .getImage()\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) *\r\n                  (styleClone.getImage().getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          if (styleClone.getStroke()) {\r\n            styleClone.getStroke().setColor(newColor);\r\n            styleClone\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) * (styleClone.getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          break;\r\n        case 'Polygon':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getFill().setColor(newColor);\r\n          }\r\n          if (styleClone.getFill()) {\r\n            styleClone.getFill().setColor(newColor);\r\n          }\r\n          break;\r\n      }\r\n\r\n      styleClone.setText('');\r\n      vectorContext.setStyle(styleClone);\r\n      vectorContext.drawGeometry(flashGeom);\r\n\r\n      if (elapsed > this.options.animation.duration) {\r\n        unByKey(listenerKey);\r\n        // remove last geometry\r\n        // there is a little flash before feature disappear, better solution ?\r\n        this.map.ol.render();\r\n        return;\r\n      }\r\n      // tell OpenLayers to continue postcompose animation\r\n      this.map.ol.render();\r\n    }\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.dataSource.onUnwatch();\r\n    this.stopAnimation();\r\n  }\r\n\r\n  public stopAnimation() {\r\n    this.dataSource.ol.un(\r\n      'addfeature',\r\n      function(e) {\r\n        if (this.visible) {\r\n          this.flash(e.feature);\r\n        }\r\n      }.bind(this)\r\n    );\r\n  }\r\n\r\n  public enableTrackFeature(id: string | number) {\r\n    this.trackFeatureListenerId = this.dataSource.ol.on(\r\n      'addfeature',\r\n      this.trackFeature.bind(this, id)\r\n    );\r\n  }\r\n  public centerMapOnFeature(id: string | number) {\r\n    const feat = this.dataSource.ol.getFeatureById(id);\r\n    if (feat) {\r\n      this.map.ol.getView().setCenter(feat.getGeometry().getCoordinates());\r\n    }\r\n  }\r\n\r\n  public trackFeature(id, feat) {\r\n    if (feat.feature.getId() === id && this.visible) {\r\n      this.centerMapOnFeature(id);\r\n    }\r\n  }\r\n\r\n  public disableTrackFeature(id?: string | number) {\r\n    unByKey(this.trackFeatureListenerId);\r\n  }\r\n\r\n  /**\r\n   * Custom loader for a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param options olOptions from source\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param proj the projection to retrieve the data\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   * @param randomParam random parameter to ensure cache is not causing problems in retrieving new data\r\n   */\r\n  public customWFSLoader(\r\n    vectorSource,\r\n    options,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    proj,\r\n    success,\r\n    failure,\r\n    randomParam?: boolean\r\n  ) {\r\n    {\r\n      const paramsWFS = options.paramsWFS;\r\n      const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n      const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n      paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n      const url = buildUrl(\r\n        options,\r\n        currentExtent,\r\n        wfsProj,\r\n        (options as OgcFilterableDataSourceOptions).ogcFilters,\r\n        randomParam);\r\n      let startIndex = 0;\r\n      if (paramsWFS.version === '2.0.0' && paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n        const nbOfFeature = 1000;\r\n        while (startIndex < paramsWFS.maxFeatures) {\r\n          let alteredUrl = url.replace('count=' + paramsWFS.maxFeatures, 'count=' + nbOfFeature);\r\n          alteredUrl = alteredUrl.replace('startIndex=0', '0');\r\n          alteredUrl += '&startIndex=' + startIndex;\r\n          alteredUrl.replace(/&&/g, '&');\r\n          this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, alteredUrl, nbOfFeature, success, failure);\r\n          startIndex += nbOfFeature;\r\n        }\r\n      } else {\r\n        this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, url, paramsWFS.maxFeatures, success, failure);\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Custom loader to get feature from a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param dataProjection the projection of the retrieved data\r\n   * @param featureProjection the projection of the created features\r\n   * @param url the url string to retrieve the data\r\n   * @param threshold the threshold to manage \"more features\" (TODO)\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   */\r\n  private getFeatures(\r\n    vectorSource: olSourceVector<OlGeometry>,\r\n    interceptor,\r\n    extent,\r\n    dataProjection,\r\n    featureProjection,\r\n    url: string,\r\n    threshold: number,\r\n    success, failure) {\r\n\r\n    const idAssociatedCall = (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter;\r\n    const xhr = new XMLHttpRequest();\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', modifiedUrl);\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      if (xhr.status === 200 && xhr.responseText.length > 0) {\r\n        const features =\r\n          vectorSource\r\n            .getFormat()\r\n            .readFeatures(xhr.responseText, { dataProjection, featureProjection }) as olFeature<OlGeometry>[];\r\n        // TODO Manage \"More feature\"\r\n        /*if (features.length === 0 || features.length < threshold ) {\r\n          console.log('No more data to download at this resolution');\r\n        }*/\r\n        // Avoids retrieving an older call that took longer to be process\r\n        if (idAssociatedCall === (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter)\r\n        {\r\n            vectorSource.addFeatures(features);\r\n            success(features);\r\n        }\r\n        else {\r\n            success([]);\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector layer.\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param url the url string or function to retrieve the data\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param projection the projection to retrieve the data\r\n   */\r\n  private customLoader(\r\n    vectorSource,\r\n    url,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    projection,\r\n    success,\r\n    failure\r\n  ) {\r\n    const xhr = new XMLHttpRequest();\r\n    let modifiedUrl = url;\r\n    if (typeof url !== 'function') {\r\n      const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n      if (alteredUrlWithKeyAuth) {\r\n        modifiedUrl = alteredUrlWithKeyAuth;\r\n      }\r\n    } else {\r\n      modifiedUrl = url(extent, resolution, projection);\r\n    }\r\n    xhr.open( 'GET', modifiedUrl);\r\n    const format = vectorSource.getFormat();\r\n    if (format.getType() === FormatType.ARRAY_BUFFER) {\r\n      xhr.responseType = 'arraybuffer';\r\n    }\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      // status will be 0 for file:// urls\r\n      if (!xhr.status || (xhr.status >= 200 && xhr.status < 300)) {\r\n        const type = format.getType();\r\n        let source;\r\n        if (type === FormatType.JSON || type === FormatType.TEXT) {\r\n          source = xhr.responseText;\r\n        } else if (type === FormatType.XML) {\r\n          source = xhr.responseXML;\r\n          if (!source) {\r\n            source = new DOMParser().parseFromString(\r\n              xhr.responseText,\r\n              'application/xml'\r\n            );\r\n          }\r\n        } else if (type === FormatType.ARRAY_BUFFER) {\r\n          source = xhr.response;\r\n        }\r\n        if (source) {\r\n          const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n          vectorSource.addFeatures(features, format.readProjection(source));\r\n          success(features);\r\n        } else {\r\n          onError();\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n}\r\n","import olSourceOSM from 'ol/source/OSM';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { OSMDataSourceOptions } from './osm-datasource.interface';\r\n\r\nexport class OSMDataSource extends DataSource {\r\n  public options: OSMDataSourceOptions;\r\n  public ol: olSourceOSM;\r\n\r\n  protected createOlSource(): olSourceOSM {\r\n    if (!this.options.url) {\r\n      this.options.url = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';\r\n    }\r\n    return new olSourceOSM(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceXYZ from 'ol/source/XYZ';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { XYZDataSourceOptions } from './xyz-datasource.interface';\r\n\r\nexport class XYZDataSource extends DataSource {\r\n  public options: XYZDataSourceOptions;\r\n  public ol: olSourceXYZ;\r\n\r\n  protected createOlSource(): olSourceXYZ {\r\n    return new olSourceXYZ(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as OlLoadingStrategy from 'ol/loadingstrategy';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport {\r\n  defaultFieldNameGeometry,\r\n  checkWfsParams,\r\n  getFormatFromOptions,\r\n  buildUrl\r\n} from './wms-wfs.utils';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nexport class WFSDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public mostRecentIdCallOGCFilter: number = 0;\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  readonly ogcFilters$: BehaviorSubject<OgcFiltersOptions> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    public options: WFSDataSourceOptions,\r\n    protected wfsService: WFSService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(checkWfsParams(options, 'wfs'));\r\n\r\n    const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    const fieldNameGeometry = this.options.paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters =\r\n      ogcFilterWriter.defineOgcFiltersDefaultOptions(ogcFilters, fieldNameGeometry);\r\n    if (\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.enabled &&\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0\r\n    ) {\r\n      this.wfsService.getSourceFieldsFromWFS(this.options);\r\n    }\r\n\r\n    if (ogcFilters?.pushButtons){\r\n      ogcFilters.pushButtons.selectorType = 'pushButton';\r\n    }\r\n    if (ogcFilters?.checkboxes){\r\n      ogcFilters.checkboxes.selectorType = 'checkbox';\r\n    }\r\n    if (ogcFilters?.radioButtons){\r\n      ogcFilters.radioButtons.selectorType = 'radioButton';\r\n    }\r\n    if (ogcFilters?.select){\r\n      ogcFilters.select.selectorType = 'select';\r\n    }\r\n\r\n    this.setOgcFilters((this.options as OgcFilterableDataSourceOptions).ogcFilters, true);\r\n  }\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const vectorSource = new olSourceVector({\r\n      format: getFormatFromOptions(this.options),\r\n      url: (extent, resolution, proj: olProjection) => {\r\n        const paramsWFS = this.options.paramsWFS;\r\n        const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n        const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n        const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n        paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n        return buildUrl(this.options, currentExtent, wfsProj, ogcFilters);\r\n      },\r\n      strategy: OlLoadingStrategy.bbox\r\n    });\r\n    return vectorSource;\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    this.mostRecentIdCallOGCFilter += 1;\r\n    if (triggerEvent) {\r\n      this.ogcFilters$.next(this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  public onUnwatch() { }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { combineLatest, Observable, of } from 'rxjs';\r\nimport olFeature from 'ol/Feature';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { DataService } from './data.service';\r\nimport { formatWFSQueryString,\r\n          gmlRegex,\r\n          defaultEpsg,\r\n          defaultMaxFeatures,\r\n          getFormatFromOptions} from './wms-wfs.utils';\r\nimport { concatMap } from 'rxjs/operators';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WFSService extends DataService {\r\n  constructor(private http: HttpClient) {\r\n    super();\r\n  }\r\n\r\n  getData() {\r\n    console.log('This is defining a data service.');\r\n    return 'This is defining a data service.';\r\n  }\r\n\r\n  public getSourceFieldsFromWFS(dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions) {\r\n    if (!dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0 ) {\r\n      dataSourceOptions.sourceFields = [];\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields = getfeatureSourceField;\r\n      });\r\n\r\n    } else {\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n          if (sourcefield.alias === undefined) {\r\n            sourcefield.alias = sourcefield.name; // to allow only a list of sourcefield with names\r\n          }\r\n          if (sourcefield.values === undefined || sourcefield.values.length === 0) {\r\n            sourcefield.values = getfeatureSourceField.find(sf => sf.name === sourcefield.name).values;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  private wfsGetFeature(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n    nb: number = defaultMaxFeatures,\r\n    epsgCode: string = defaultEpsg,\r\n    propertyName?: string,\r\n    startIndex: number = 0,\r\n    forceDefaultOutputFormat: boolean = false\r\n  ): Observable<any> {\r\n    const queryStringValues = formatWFSQueryString(dataSourceOptions, nb, epsgCode, propertyName, startIndex, forceDefaultOutputFormat );\r\n    const baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n    const outputFormat = dataSourceOptions.paramsWFS.outputFormat;\r\n    if (forceDefaultOutputFormat || gmlRegex.test(outputFormat) || !outputFormat) {\r\n      return this.http.get(baseUrl, { responseType: 'text' });\r\n    } else {\r\n      return this.http.get(baseUrl);\r\n    }\r\n  }\r\n\r\n  defineFieldAndValuefromWFS(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions\r\n  ): Observable<any> {\r\n    return new Observable(d => {\r\n      const sourceFields = [];\r\n      let fieldList;\r\n      let fieldListWoGeom;\r\n      let fieldListWoGeomStr;\r\n      let olFormats;\r\n      let effectiveOlFormats;\r\n\r\n      olFormats = getFormatFromOptions(dataSourceOptions);\r\n      const gmlDataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions = JSON.parse(\r\n        JSON.stringify(dataSourceOptions)\r\n      );\r\n      delete gmlDataSourceOptions.paramsWFS.outputFormat;\r\n      delete (gmlDataSourceOptions as WFSDataSourceOptions).formatOptions;\r\n\r\n      effectiveOlFormats = getFormatFromOptions(gmlDataSourceOptions);\r\n      let sourceFieldsToRetrieveValues = dataSourceOptions.sourceFields?.filter(f => !f.values).map(f => f.name);\r\n\r\n      // Validate if the service manage no outputformat (wfs 1.0.0 and GML is the default return)\r\n      this.wfsGetFeature(dataSourceOptions, 1, undefined, undefined, 0, true).pipe(\r\n        concatMap(res => String(res).toLowerCase().includes('exception') ? of(false) : of(true)),\r\n        concatMap(allowGml => {\r\n          // If the service return GML (return no exception)\r\n          return this.wfsGetFeature(dataSourceOptions, 1).pipe(\r\n            concatMap(firstFeature => {\r\n              const features = olFormats.readFeatures(firstFeature);\r\n              fieldList = features[0].getKeys();\r\n              if (dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0) {\r\n                sourceFieldsToRetrieveValues = fieldList;\r\n              }\r\n              fieldListWoGeom = fieldList.filter(\r\n                field =>\r\n                  sourceFieldsToRetrieveValues.includes(field) &&\r\n                  field !== features[0].getGeometryName() &&\r\n                  !field.match(/boundedby/gi)\r\n              );\r\n              fieldListWoGeomStr = fieldListWoGeom.join(',');\r\n              const processingArray = [];\r\n              let startIndex = 0;\r\n              // If the service do not allow gml return, dice the call in multiple\r\n              // calls by increment of chunkSize with the original outputFormat\r\n              if (\r\n                !allowGml && dataSourceOptions.paramsWFS.version === '2.0.0' &&\r\n                dataSourceOptions.paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n                const chunkSize = 1000;\r\n                while (startIndex < dataSourceOptions.paramsWFS.maxFeatures) {\r\n                  processingArray.push(this.wfsGetFeature(\r\n                    dataSourceOptions,\r\n                    chunkSize,\r\n                    dataSourceOptions.paramsWFS.srsName,\r\n                    fieldListWoGeomStr,\r\n                    startIndex\r\n                  ));\r\n                  startIndex += chunkSize;\r\n                }\r\n                effectiveOlFormats = olFormats;\r\n              } else {\r\n                processingArray.push(this.wfsGetFeature(\r\n                  dataSourceOptions,\r\n                  dataSourceOptions.paramsWFS.maxFeatures || defaultMaxFeatures,\r\n                  dataSourceOptions.paramsWFS.srsName,\r\n                  fieldListWoGeomStr,\r\n                  0, true\r\n                ));\r\n              }\r\n              return combineLatest(processingArray);\r\n            })\r\n          );\r\n        })).subscribe((results) => {\r\n          let mfeatures: olFeature<OlGeometry>[] = [];\r\n          results.map((result) => {\r\n            const loopFeatures = effectiveOlFormats.readFeatures(result);\r\n            mfeatures = mfeatures.concat(loopFeatures);\r\n          });\r\n          this.built_properties_value(mfeatures).forEach(element => {\r\n            sourceFields.push(element);\r\n          });\r\n          d.next(sourceFields);\r\n          d.complete();\r\n        });\r\n    });\r\n  }\r\n\r\n  private built_properties_value(features: olFeature<OlGeometry>[]): string[] {\r\n    if (features.length === 0) {\r\n      return [];\r\n    }\r\n    const kv = Object.assign({}, features[0].getProperties());\r\n    delete kv[features[0].getGeometryName()];\r\n    delete kv.boundedBy;\r\n    const sourceFields = [];\r\n    for (const property in kv) {\r\n      if (kv.hasOwnProperty(property)) {\r\n        const fieldType =\r\n          typeof features[0].get(property) === 'object'\r\n            ? undefined\r\n            : typeof features[0].get(property);\r\n        sourceFields.push({\r\n          name: property,\r\n          alias: property,\r\n          type: fieldType,\r\n          values: [kv[property]]\r\n        });\r\n      }\r\n    }\r\n    features.every((element) => {\r\n      const featureProperties = element.getProperties();\r\n      for (const key in featureProperties) {\r\n        if (featureProperties.hasOwnProperty(key) && key in kv) {\r\n          sourceFields.filter(f => f.name === key).forEach(v => {\r\n            if (v.values.indexOf(featureProperties[key]) === -1) {\r\n              v.values.push(featureProperties[key]);\r\n            }\r\n          });\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n    return sourceFields;\r\n  }\r\n}\r\n","import olTileGridWMTS from 'ol/tilegrid/WMTS';\r\nimport * as olproj from 'ol/proj';\r\nimport {\r\n  getTopLeft as extentGetTopLeft,\r\n  getWidth as extentGetWidth\r\n} from 'ol/extent.js';\r\n\r\nexport function createDefaultTileGrid(epsg?: string): olTileGridWMTS {\r\n  const projection = epsg ? olproj.get(epsg) : olproj.get('EPSG:3857');\r\n  const projectionExtent = projection.getExtent();\r\n  const size = extentGetWidth(projectionExtent) / 256;\r\n  const resolutions = new Array(20);\r\n  const matrixIds = new Array(20);\r\n  for (let z = 0; z < 20; ++z) {\r\n    resolutions[z] = size / Math.pow(2, z);\r\n    matrixIds[z] = z;\r\n  }\r\n\r\n  return new olTileGridWMTS({\r\n    origin: extentGetTopLeft(projectionExtent),\r\n    resolutions,\r\n    matrixIds\r\n  });\r\n}\r\n","import { Options } from 'ol/source/WMTS';\r\nimport olSourceWMTS from 'ol/source/WMTS';\r\n\r\nimport { createDefaultTileGrid } from '../../utils/tilegrid';\r\nimport { DataSource } from './datasource';\r\nimport { WMTSDataSourceOptions } from './wmts-datasource.interface';\r\n\r\nexport class WMTSDataSource extends DataSource {\r\n  public options: WMTSDataSourceOptions;\r\n  public ol: olSourceWMTS;\r\n\r\n  constructor(options: WMTSDataSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  protected createOlSource(): olSourceWMTS {\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        tileGrid: createDefaultTileGrid(this.options.projection as string)\r\n      },\r\n      this.options\r\n    ) as Options;\r\n\r\n    return new olSourceWMTS(sourceOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceCarto from 'ol/source/CartoDB';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { CartoDataSourceOptions } from './carto-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class CartoDataSource extends DataSource {\r\n  public ol: olSourceCarto;\r\n  public options: CartoDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceCarto {\r\n    const crossOrigin = this.options.crossOrigin\r\n      ? this.options.crossOrigin\r\n      : 'anonymous';\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        crossOrigin\r\n      },\r\n      this.options\r\n    );\r\n    return new olSourceCarto(sourceOptions);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legend = super.getLegend();\r\n    if (legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    let htmlString = '<table>';\r\n    if (this.options.config.layers[0].legend !== null) {\r\n      this.options.config.layers[0].legend.items.forEach(f => {\r\n        if (f.visible === true) {\r\n          htmlString +=\r\n            '<tr><td>' +\r\n            '<p><font size=\"5\" color=\"' +\r\n            f.value +\r\n            '\"> &#9679</font></p></td>' +\r\n            '<td>' +\r\n            f.name +\r\n            '</td></tr>';\r\n        }\r\n      });\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    } else {\r\n      // Try to build the legend from the cartocss options\r\n      const layerOptions = this.options.config.layers[0].options;\r\n      // All available cartocss style options\r\n      const types = [\r\n        'polygon-fill:',\r\n        'marker-fill:',\r\n        'shield-fill:',\r\n        'building-fill:',\r\n        'line-color:'\r\n      ];\r\n      for (const oneType of types) {\r\n        if (layerOptions.cartocss.includes(oneType)) {\r\n          const type = layerOptions.cartocss.split(oneType).pop();\r\n          const color = type.substr(0, type.indexOf(';'));\r\n          if (color.includes('ramp')) {\r\n            const colors = color.split(', (')[1].split(',');\r\n            const data = color.split(', (')[2].split(',');\r\n            for (let j = 0; j < colors.length; j++) {\r\n              colors[j] = colors[j].replace(/(\"|\\))/g, '');\r\n              data[j] = data[j].replace(/(\"|\\))/g, '');\r\n              if (data[j].replace(/\\s+/g, '') === '=') {\r\n                data[j] = 'Autres';\r\n              }\r\n              htmlString +=\r\n                '<tr><td>' +\r\n                '<p><font size=\"5\" color=\"' +\r\n                colors[j] +\r\n                '\"> &#9679</font></p></td>' +\r\n                '<td>' +\r\n                data[j] +\r\n                '</td></tr>';\r\n            }\r\n            break;\r\n          } else {\r\n            const title = layerOptions.layer_name\r\n              ? layerOptions.layer_name\r\n              : '';\r\n            htmlString +=\r\n              '<tr><td>' +\r\n              '<p><font size=\"5\" color=\"' +\r\n              color +\r\n              '\"> &#9679</font></p>' +\r\n              '</td><td>' +\r\n              title +\r\n              '</td></tr>';\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    }\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport * as olloadingstrategy from 'ol/loadingstrategy';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestDataSourceOptions } from './arcgisrest-datasource.interface';\r\n\r\nexport class ArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public options: ArcGISRestDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const esrijsonFormat = new olFormatEsriJSON();\r\n    return new olSourceVector({\r\n      attributions: this.options.params.attributions,\r\n      overlaps: false,\r\n      format: esrijsonFormat,\r\n      url: function(extent, resolution, proj) {\r\n        const baseUrl = this.options.url + '/' + this.options.layer + '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        if (this.options.params.time) {\r\n          const time = `time=${this.options.params.time}`;\r\n          params.push(time);\r\n        }\r\n        if (this.options.params.customParams) {\r\n          this.options.params.customParams.forEach(element => {\r\n            params.push(element);\r\n          });\r\n        }\r\n        return `${baseUrl}?${params.join('&')}`;\r\n      }.bind(this),\r\n      strategy: olloadingstrategy.bbox\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n    let src: string;\r\n    let label: string;\r\n    let svg: string;\r\n\r\n    if (legendInfo.legend) {\r\n      for (const legendElement of legendInfo.legend) {\r\n        src = this.htmlImgSrc(legendElement.contentType, legendElement.imageData);\r\n        label = legendElement.label ? legendElement.label.replace('<Null>', 'Null') : '';\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      }\r\n    } else if (legendInfo.type === \"uniqueValue\") {\r\n      for (const legendElement of legendInfo.uniqueValueInfos) {\r\n        label = legendElement.label.replace('<Null>', 'Null');\r\n        if (legendElement.symbol.type === 'esriPMS') {\r\n          src = this.htmlImgSrc(legendElement.symbol.contentType, legendElement.symbol.imageData);\r\n          htmlString +=\r\n            `<tr><td align='left'><img src=\"` +\r\n            src +\r\n            `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n            label +\r\n            '</td></tr>';\r\n        } else if (legendElement.symbol.type !== 'esriPMS') {\r\n          svg = this.createSVG(legendElement.symbol);\r\n          htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n        }\r\n      }\r\n    } else if (legendInfo.type === \"simple\") {\r\n      label = legendInfo.label ? legendInfo.label.replace('<Null>', 'Null') : '';\r\n      if (legendInfo.symbol.type === 'esriPMS') {\r\n        src = this.htmlImgSrc(legendInfo.symbol.contentType, legendInfo.symbol.imageData);\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      } else if (legendInfo.symbol.type !== 'esriPMS') {\r\n        svg = this.createSVG(legendInfo.symbol);\r\n        htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n      }\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  htmlImgSrc(contentType: string, imageData: string): string {\r\n    return `data:${contentType};base64,${imageData}`;\r\n  }\r\n\r\n  createSVG(symbol): string {\r\n    let svg: string = '';\r\n\r\n    const color: Array<number> = symbol.color ? symbol.color : [0, 0, 0, 0];\r\n\r\n    if (symbol.type === 'esriSLS') {\r\n      const width: number = symbol.width ? symbol.width : 0;\r\n\r\n      const stroke: string = `stroke:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n      const strokeWidth: string = `stroke-width:` + width;\r\n\r\n      if (symbol.style === 'esriSLSSolid') {\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\"/></svg>`;\r\n      } else if (symbol.style === 'esriSLSDash') {\r\n        const strokeDashArray: string = `stroke-dasharray=\"5,5\"`;\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\" `+ strokeDashArray + `/></svg>`;\r\n      }\r\n    } else if (symbol.style === 'esriSMSCircle' || symbol.style === 'esriSFSSolid') {\r\n      const outlineColor = symbol.outline.color;\r\n      const outlineWidth = symbol.outline.width;\r\n      const size = symbol.size;\r\n\r\n      const stroke = `stroke:rgba(` + outlineColor[0] + ',' + outlineColor[1] + ',' + outlineColor[2] + ',' + outlineColor[3] + ')';\r\n      const strokeWidth = `stroke-width:` + outlineWidth;\r\n      const fill = `fill:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n\r\n      if (symbol.style === 'esriSMSCircle') {\r\n        svg = `<svg height=\"30\" width=\"30\"><circle cx=\"15\" cy=\"15\" r=\"` + size/2 + `\" style=\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      } else {\r\n        svg = `<svg height=\"30\" width=\"30\"><rect x=\"5\" y=\"5\" width=\"20\" height=\"20\" style =\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      }\r\n    }\r\n    return svg;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import ImageArcGISRest from 'ol/source/ImageArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestImageDataSourceOptions } from './imagearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nexport class ImageArcGISRestDataSource extends DataSource {\r\n  public ol: ImageArcGISRest;\r\n  public options: ArcGISRestImageDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): ImageArcGISRest {\r\n    const params = this.options.layer === undefined ? this.options.params : Object.assign(\r\n      {LAYERS: `show:${this.options.layer}`},\r\n      this.options.params\r\n    );\r\n\r\n    if (typeof params.renderingRule === 'object') {\r\n      params.renderingRule = JSON.stringify(params.renderingRule);\r\n    }\r\n\r\n    return new ImageArcGISRest({\r\n      ratio: 1,\r\n      params,\r\n      url: this.options.url\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceTileArcGISRest from 'ol/source/TileArcGISRest';\r\nimport { Options } from 'ol/source/TileArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { TileArcGISRestDataSourceOptions } from './tilearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class TileArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceTileArcGISRest;\r\n  public options: TileArcGISRestDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceTileArcGISRest {\r\n    return new olSourceTileArcGISRest(this.options as Options);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import TileDebug from 'ol/source/TileDebug';\r\nimport TileGrid from 'ol/tilegrid/TileGrid';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { TileDebugDataSourceOptions } from './tiledebug-datasource.interface';\r\n\r\nexport class TileDebugDataSource extends DataSource {\r\n  public options: TileDebugDataSourceOptions;\r\n  public ol: TileDebug;\r\n\r\n  protected createOlSource(): TileDebug {\r\n    const baseOptions = JSON.parse(JSON.stringify(this.options)); // to avoid to alter the original options\r\n    if (this.options.tileGrid) {\r\n      delete baseOptions.tileGrid;\r\n      baseOptions.tileGrid = new TileGrid(this.options.tileGrid);\r\n    }\r\n    return new TileDebug(baseOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { WebSocketDataSourceOptions } from './websocket-datasource.interface';\r\n\r\nexport class WebSocketDataSource extends FeatureDataSource {\r\n  public ws: WebSocket;\r\n  public options: WebSocketDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    this.createWebSocket();\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    return super.createOlSource();\r\n  }\r\n\r\n  private createWebSocket() {\r\n    this.ws = new WebSocket(this.options.url);\r\n    this.ws.onmessage = this.onMessage.bind(this);\r\n\r\n    if (this.options.onclose) {\r\n      this.ws.onclose = this.onClose.bind(this);\r\n    }\r\n\r\n    if (this.options.onerror) {\r\n      this.ws.onerror = this.onError.bind(this);\r\n    }\r\n\r\n    if (this.options.onopen) {\r\n      this.ws.onopen = this.onOpen.bind(this);\r\n    }\r\n  }\r\n\r\n  onMessage(event) {\r\n    const featureAdded = this.options.format.readFeature(event.data) as olFeature<OlGeometry>;\r\n\r\n    switch (this.options.onmessage) {\r\n      case 'update':\r\n        // ol don't add if same ID\r\n        const featureToRemove = this.ol.getFeatureById(featureAdded.getId());\r\n        if (featureToRemove) {\r\n          this.ol.removeFeature(featureToRemove);\r\n        }\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'delete':\r\n        this.ol.clear(true);\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'add':\r\n      default:\r\n        this.ol.addFeature(featureAdded);\r\n    }\r\n  }\r\n\r\n  onClose(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onError(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onOpen(event) {\r\n    // thrown message to user ?\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.ws.close();\r\n  }\r\n}\r\n","import { Md5 } from 'ts-md5';\r\nimport feature from 'ol/Feature';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\nimport olFormatMVT from 'ol/format/MVT';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { MVTDataSourceOptions } from './mvt-datasource.interface';\r\n\r\nexport class MVTDataSource extends DataSource {\r\n  public options: MVTDataSourceOptions;\r\n  public ol: olSourceVectorTile;\r\n\r\n  protected createOlSource(): olSourceVectorTile {\r\n    let mvtFormat;\r\n    if (this.options.featureClass === 'feature') {\r\n      mvtFormat = new olFormatMVT({featureClass: feature});\r\n    } else {\r\n      mvtFormat = new olFormatMVT();\r\n    }\r\n    this.options.format = mvtFormat;\r\n    return new olSourceVectorTile(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    if (!this.options.url) {\r\n        return uuid();\r\n    }\r\n    const chain = 'mvt' + this.options.url;\r\n    return Md5.hashStr(chain) as string;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport class EsriStyleGenerator {\r\n  public _converters: any;\r\n  public _renderers: any;\r\n\r\n  constructor() {\r\n    this._converters = {};\r\n    this._converters.esriPMS = EsriStyleGenerator._convertEsriPMS;\r\n    this._converters.esriSFS = EsriStyleGenerator._convertEsriSFS;\r\n    this._converters.esriSLS = EsriStyleGenerator._convertEsriSLS;\r\n    this._converters.esriSMS = EsriStyleGenerator._convertEsriSMS;\r\n    this._converters.esriTS = EsriStyleGenerator._convertEsriTS;\r\n    this._renderers = {};\r\n    this._renderers.uniqueValue = this._renderUniqueValue;\r\n    this._renderers.simple = this._renderSimple;\r\n    this._renderers.classBreaks = this._renderClassBreaks;\r\n  }\r\n  static _convertPointToPixel(point) {\r\n    return point / 0.75;\r\n  }\r\n  static _transformColor(color): [number, number, number, number] {\r\n    // alpha channel is different, runs from 0-255 but in ol3 from 0-1\r\n    return [color[0], color[1], color[2], color[3] / 255];\r\n  }\r\n\r\n  static _getResolutionForScale(scale, units) {\r\n    const dpi = 96;\r\n    const mpu = olproj.METERS_PER_UNIT[units];\r\n    const inchesPerMeter = 39.3701;\r\n    return parseFloat(scale) / (mpu * inchesPerMeter * dpi);\r\n  }\r\n\r\n  /* convert an Esri Text Symbol */\r\n  static _convertEsriTS(symbol) {\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    const text = symbol.text !== undefined ? symbol.text : undefined;\r\n    return new olstyle.Style({\r\n      text: new olstyle.Text({\r\n        fill: new olstyle.Fill({\r\n          color: EsriStyleGenerator._transformColor(symbol.color)\r\n        }),\r\n        font:\r\n          symbol.font.style +\r\n          ' ' +\r\n          symbol.font.weight +\r\n          ' ' +\r\n          symbol.font.size +\r\n          ' px ' +\r\n          symbol.font.family,\r\n        textBaseline: symbol.verticalAlignment,\r\n        textAlign: symbol.horizontalAlignment,\r\n        offsetX: EsriStyleGenerator._convertPointToPixel(symbol.xoffset),\r\n        offsetY: EsriStyleGenerator._convertPointToPixel(symbol.yoffset),\r\n        rotation,\r\n        text\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Picture Marker Symbol */\r\n  static _convertEsriPMS(symbol) {\r\n    const src = 'data:' + symbol.contentType + ';base64, ' + symbol.imageData;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src,\r\n        rotation\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Simple Fill Symbol */\r\n  static _convertEsriSFS(symbol) {\r\n    // there is no support in openlayers currently for fill patterns, so style is not interpreted\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    return new olstyle.Style({\r\n      fill,\r\n      stroke\r\n    });\r\n  }\r\n  static _convertOutline(outline) {\r\n    let lineDash;\r\n    const color = EsriStyleGenerator._transformColor(outline.color);\r\n    if (outline.style === 'esriSLSDash') {\r\n      lineDash = [5];\r\n    } else if (outline.style === 'esriSLSDashDot') {\r\n      lineDash = [5, 5, 1, 2];\r\n    } else if (outline.style === 'esriSLSDashDotDot') {\r\n      lineDash = [5, 5, 1, 2, 1, 2];\r\n    } else if (outline.style === 'esriSLSDot') {\r\n      lineDash = [1, 2];\r\n    } else if (outline.style === 'esriSLSNull') {\r\n      // line not visible, make color fully transparent\r\n      color[3] = 0;\r\n    }\r\n    return new olstyle.Stroke({\r\n      color,\r\n      lineDash,\r\n      width: EsriStyleGenerator._convertPointToPixel(outline.width)\r\n    });\r\n  }\r\n  /* convert an Esri Simple Line Symbol */\r\n  static _convertEsriSLS(symbol) {\r\n    return new olstyle.Style({\r\n      stroke: EsriStyleGenerator._convertOutline(symbol)\r\n    });\r\n  }\r\n  static _transformAngle(angle) {\r\n    if (angle === 0 || angle === undefined) {\r\n      return undefined;\r\n    }\r\n    const normalRad = (angle * Math.PI) / 180;\r\n    const ol3Rad = -normalRad + Math.PI / 2;\r\n    if (ol3Rad < 0) {\r\n      return 2 * Math.PI + ol3Rad;\r\n    } else {\r\n      return ol3Rad;\r\n    }\r\n  }\r\n  /* convert an Esri Simple Marker Symbol */\r\n  static _convertEsriSMS(symbol) {\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    const radius = EsriStyleGenerator._convertPointToPixel(symbol.size) / 2;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    if (symbol.style === 'esriSMSCircle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.Circle({\r\n          radius,\r\n          fill,\r\n          stroke\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSCross') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSDiamond') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSSquare') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSX') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSTriangle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 3,\r\n          radius,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    }\r\n  }\r\n\r\n  _convertLabelingInfo(labelingInfo, mapUnits) {\r\n    const styles = [];\r\n    for (let i = 0, ii = labelingInfo.length; i < ii; ++i) {\r\n      const labelExpression = labelingInfo[i].labelExpression;\r\n      // only limited support for label expressions\r\n      const field = labelExpression.substr(\r\n        labelExpression.indexOf('[') + 1,\r\n        labelExpression.indexOf(']') - 1\r\n      );\r\n      const symbol = labelingInfo[i].symbol;\r\n      const maxScale = labelingInfo[i].maxScale;\r\n      const minScale = labelingInfo[i].minScale;\r\n      let minResolution = null;\r\n      if (maxScale !== 0) {\r\n        minResolution = EsriStyleGenerator._getResolutionForScale(\r\n          maxScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      let maxResolution = null;\r\n      if (minScale !== 0) {\r\n        maxResolution = EsriStyleGenerator._getResolutionForScale(\r\n          minScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      styles.push(\r\n        (() => {\r\n          return function(feature, resolution) {\r\n            let visible = true;\r\n            if (this.minResolution !== null && this.maxResolution !== null) {\r\n              visible =\r\n                resolution < this.maxResolution &&\r\n                resolution >= this.minResolution;\r\n            } else if (this.minResolution !== null) {\r\n              visible = resolution >= this.minResolution;\r\n            } else if (this.maxResolution !== null) {\r\n              visible = resolution < this.maxResolution;\r\n            }\r\n            if (visible) {\r\n              const value = feature.get(this.field);\r\n              this.style.getText().setText(value);\r\n              return [this.style];\r\n            }\r\n          };\r\n        })().bind({\r\n          minResolution,\r\n          maxResolution,\r\n          field,\r\n          style\r\n        })\r\n      );\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  _renderSimple(renderer) {\r\n    const style = this._converters[renderer.symbol.type].call(\r\n      this,\r\n      renderer.symbol\r\n    );\r\n    return (() => {\r\n      return () => {\r\n        return [style];\r\n      };\r\n    })();\r\n  }\r\n  _renderClassBreaks(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    const defaultStyle = this._converters[defaultSymbol.type].call(\r\n      this,\r\n      defaultSymbol\r\n    );\r\n    const field = renderer.field;\r\n    const classes = [];\r\n    for (let i = 0, ii = renderer.classBreakInfos.length; i < ii; ++i) {\r\n      const classBreakInfo = renderer.classBreakInfos[i];\r\n      let min;\r\n      if (\r\n        classBreakInfo.classMinValue === null ||\r\n        classBreakInfo.classMinValue === undefined\r\n      ) {\r\n        if (i === 0) {\r\n          min = renderer.minValue;\r\n        } else {\r\n          min = renderer.classBreakInfos[i - 1].classMaxValue;\r\n        }\r\n      } else {\r\n        min = classBreakInfo.classMinValue;\r\n      }\r\n      const max = classBreakInfo.classMaxValue;\r\n      const symbol = classBreakInfo.symbol;\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      classes.push({ min, max, style });\r\n    }\r\n    return (() => {\r\n      return (feature) => {\r\n        const value = feature.get(field);\r\n        for (let i = 0, ii = classes.length; i < ii; ++i) {\r\n          let condition;\r\n          if (i === 0) {\r\n            condition = value >= classes[i].min && value <= classes[i].max;\r\n          } else {\r\n            condition = value > classes[i].min && value <= classes[i].max;\r\n          }\r\n          if (condition) {\r\n            return [classes[i].style];\r\n          }\r\n        }\r\n        return [defaultStyle];\r\n      };\r\n    })();\r\n  }\r\n  _renderUniqueValue(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    let defaultStyle = [];\r\n    if (defaultSymbol) {\r\n      defaultStyle = [\r\n        this._converters[defaultSymbol.type].call(this, defaultSymbol)\r\n      ];\r\n    }\r\n    const field = renderer.field1;\r\n    const infos = renderer.uniqueValueInfos;\r\n    const me = this;\r\n    return (() => {\r\n      const hash = {};\r\n      for (let i = 0, ii = infos.length; i < ii; ++i) {\r\n        const info = infos[i];\r\n        const symbol = info.symbol;\r\n        hash[info.value] = [me._converters[symbol.type].call(me, symbol)];\r\n      }\r\n\r\n      return (feature) => {\r\n        const style = hash[feature.get(field)];\r\n        return style ? style : defaultStyle;\r\n      };\r\n    })();\r\n  }\r\n  generateStyle(layerInfo, mapUnits) {\r\n    const drawingInfo = layerInfo.drawingInfo;\r\n    let styleFunctions = [];\r\n    const drawingInfoStyle = this._renderers[drawingInfo.renderer.type].call(\r\n      this,\r\n      drawingInfo.renderer\r\n    );\r\n    if (drawingInfoStyle !== undefined) {\r\n      styleFunctions.push(drawingInfoStyle);\r\n    }\r\n    if (layerInfo.labelingInfo) {\r\n      const labelingInfoStyleFunctions = this._convertLabelingInfo(\r\n        layerInfo.labelingInfo,\r\n        mapUnits\r\n      );\r\n      styleFunctions = styleFunctions.concat(labelingInfoStyleFunctions);\r\n    }\r\n    if (styleFunctions.length === 1) {\r\n      return styleFunctions[0];\r\n    } else {\r\n      return (() => {\r\n        return (feature, resolution) => {\r\n          let styles = [];\r\n          for (let i = 0, ii = styleFunctions.length; i < ii; ++i) {\r\n            const result = styleFunctions[i].call(null, feature, resolution);\r\n            if (result) {\r\n              styles = styles.concat(result);\r\n            }\r\n          }\r\n          return styles;\r\n        };\r\n      })();\r\n    }\r\n  }\r\n}\r\n","export enum TimeFilterType {\r\n    DATE = 'date',\r\n    TIME = 'time',\r\n    DATETIME = 'datetime',\r\n    YEAR = 'year',\r\n}\r\n\r\nexport enum TimeFilterStyle {\r\n    CALENDAR = 'calendar',\r\n    SLIDER = 'slider',\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { IgoMap } from './map';\r\n\r\n/**\r\n * MapService\r\n *\r\n * This service tracks the IgoMap instance, if any.\r\n * Currently, only one map instance is supported\r\n * but support for multiple maps may be added in the future.\r\n * This will impact other services such as the OverlayService\r\n * because these maps won't be sharing overlayed features.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MapService {\r\n  private map: IgoMap;\r\n\r\n  constructor() {}\r\n\r\n  getMap(): IgoMap {\r\n    return this.map;\r\n  }\r\n\r\n  setMap(map: IgoMap) {\r\n    this.map = map;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpClient,\r\n  HttpParams\r\n} from '@angular/common/http';\r\nimport { Observable, forkJoin, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { WMSCapabilities, WMTSCapabilities, EsriJSON } from 'ol/format';\r\nimport { optionsFromCapabilities } from 'ol/source/WMTS.js';\r\nimport olAttribution from 'ol/control/Attribution';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\nimport { EsriStyleGenerator } from '../utils/esri-style-generator';\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType\r\n} from '../../query/shared/query.enums';\r\n\r\nimport {\r\n  WMTSDataSourceOptions,\r\n  WMSDataSourceOptions,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions,\r\n  ArcGISRestImageDataSourceOptions\r\n} from './datasources';\r\nimport {\r\n  LegendOptions,\r\n  ItemStyleOptions\r\n} from '../../layer/shared/layers/layer.interface';\r\nimport {\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '../../filter/shared/time-filter.enum';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport enum TypeCapabilities {\r\n  wms = 'wms',\r\n  wmts = 'wmts',\r\n  arcgisrest = 'esriJSON',\r\n  imagearcgisrest = 'esriJSON',\r\n  tilearcgisrest = 'esriJSON'\r\n}\r\n\r\nexport type TypeCapabilitiesStrings = keyof typeof TypeCapabilities;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CapabilitiesService {\r\n  private parsers = {\r\n    wms: new WMSCapabilities(),\r\n    wmts: new WMTSCapabilities(),\r\n    esriJSON: new EsriJSON()\r\n  };\r\n\r\n  constructor(private http: HttpClient, private mapService: MapService) {}\r\n\r\n  getWMSOptions(\r\n    baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = (baseOptions.params as any).VERSION;\r\n\r\n    return this.getCapabilities('wms', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n  }\r\n\r\n  getWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = baseOptions.version;\r\n\r\n    const options = this.getCapabilities('wmts', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMTSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n    return options;\r\n  }\r\n\r\n  getCartoOptions(\r\n    baseOptions: CartoDataSourceOptions\r\n  ): Observable<CartoDataSourceOptions> {\r\n    const baseUrl =\r\n      'https://' +\r\n      baseOptions.account +\r\n      '.carto.com/api/v2/viz/' +\r\n      baseOptions.mapId +\r\n      '/viz.json';\r\n\r\n    return this.http\r\n      .jsonp(baseUrl, 'callback')\r\n      .pipe(\r\n        map((cartoOptions: any) =>\r\n          this.parseCartoOptions(baseOptions, cartoOptions)\r\n        )\r\n      );\r\n  }\r\n\r\n  getArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const modifiedUrl = baseOptions.url.replace('FeatureServer', 'MapServer');\r\n    const legendUrl = modifiedUrl + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('arcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Feature Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseArcgisOptions(baseOptions, res[0], res[1], res[2]);\r\n      })\r\n    );\r\n  }\r\n\r\n  getImageArcgisOptions(\r\n    baseOptions: ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const modifiedUrl = baseOptions.url.replace('FeatureServer', 'MapServer');\r\n    const legendUrl = modifiedUrl + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('imagearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Image Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2]);\r\n      })\r\n    );\r\n  }\r\n\r\n  getTileArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('tilearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legendInfo = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Tile Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legendInfo, serviceCapabilities]).pipe(\r\n      map((res: any) =>\r\n        this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2])\r\n      )\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getCapabilities(\r\n    service: TypeCapabilitiesStrings,\r\n    baseUrl: string,\r\n    version?: string\r\n  ): Observable<any> {\r\n    const params = new HttpParams({\r\n      fromObject: {\r\n        request: 'GetCapabilities',\r\n        service: service.toUpperCase(),\r\n        version: version || '1.3.0',\r\n        _i: 'true'\r\n      }\r\n    });\r\n\r\n    let request;\r\n    if (TypeCapabilities[service] === 'esriJSON') {\r\n      request = this.http.get(baseUrl + '?f=json');\r\n    } else {\r\n      request = this.http.get(baseUrl, {\r\n        params,\r\n        responseType: 'text'\r\n      });\r\n    }\r\n\r\n    return request.pipe(\r\n      map((res) => {\r\n        if (TypeCapabilities[service] === 'esriJSON') {\r\n          return res as object;\r\n        }\r\n        if (\r\n          String(res).toLowerCase().includes('serviceexception') &&\r\n          String(res).toLowerCase().includes('access denied')\r\n        ) {\r\n          throw {\r\n            error: {\r\n              message: 'Service error getCapabilities: Access is denied'\r\n            }\r\n          };\r\n        } else {\r\n          return this.parsers[service].read(res);\r\n        }\r\n      }),\r\n      catchError((e) => {\r\n        if (typeof e.error !== 'undefined') {\r\n          e.error.caught = true;\r\n        }\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  private parseWMSOptions(\r\n    baseOptions: WMSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMSDataSourceOptions {\r\n    const layers = (baseOptions.params as any).LAYERS;\r\n    const layer = this.findDataSourceInCapabilities(\r\n      capabilities.Capability.Layer,\r\n      layers\r\n    );\r\n\r\n    if (!layer) {\r\n      throw {\r\n        error: {\r\n          message: 'Layer not found'\r\n        }\r\n      };\r\n    }\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const abstract = layer.Abstract ? layer.Abstract : undefined;\r\n    const keywordList = layer.KeywordList ? layer.KeywordList : undefined;\r\n    let queryable = layer.queryable;\r\n    const timeFilter = this.getTimeFilter(layer);\r\n    const timeFilterable = timeFilter && Object.keys(timeFilter).length > 0;\r\n    const legendOptions = layer.Style ? this.getStyle(layer.Style) : undefined;\r\n    let isExtentInGeographic = true;\r\n    if (layer.EX_GeographicBoundingBox) {\r\n      layer.EX_GeographicBoundingBox.forEach((coord, index) => {\r\n        if (index < 2 && (coord > 180 || coord < -180)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n        if (index >= 2 && (coord > 90 || coord < -90)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n      });\r\n    } else {\r\n      isExtentInGeographic = false;\r\n    }\r\n\r\n    const extent = isExtentInGeographic ?\r\n        olproj.transformExtent(layer.EX_GeographicBoundingBox, 'EPSG:4326', this.mapService.getMap().projection) :\r\n        undefined;\r\n\r\n    let queryFormat: QueryFormat;\r\n    const queryFormatMimeTypePriority = [\r\n      QueryFormatMimeType.GEOJSON,\r\n      QueryFormatMimeType.GEOJSON2,\r\n      QueryFormatMimeType.GML3,\r\n      QueryFormatMimeType.GML2,\r\n      QueryFormatMimeType.JSON,\r\n      QueryFormatMimeType.HTML\r\n    ];\r\n\r\n    for (const mimeType of queryFormatMimeTypePriority) {\r\n      if (\r\n        capabilities.Capability.Request.GetFeatureInfo.Format.indexOf(\r\n          mimeType\r\n        ) !== -1\r\n      ) {\r\n        const keyEnum = Object.keys(QueryFormatMimeType).find(\r\n          (key) => QueryFormatMimeType[key] === mimeType\r\n        );\r\n        queryFormat = QueryFormat[keyEnum];\r\n        break;\r\n      }\r\n    }\r\n    if (!queryFormat) {\r\n      queryable = false;\r\n    }\r\n\r\n    const options: WMSDataSourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title,\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        extent,\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined,\r\n          abstract,\r\n          keywordList\r\n        },\r\n        legendOptions\r\n      },\r\n      queryable,\r\n      queryFormat,\r\n      timeFilter: timeFilterable ? timeFilter : undefined,\r\n      timeFilterable: timeFilterable ? true : undefined,\r\n      minDate: timeFilterable ? timeFilter.min : undefined,\r\n      maxDate: timeFilterable ? timeFilter.max : undefined,\r\n      stepDate: timeFilterable ? timeFilter.step : undefined\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMTSDataSourceOptions {\r\n    // Put Title source in _layerOptionsFromSource. (For source & catalog in _layerOptionsFromSource, if not already on config)\r\n    const layer = capabilities.Contents.Layer.find(\r\n      (el) => el.Identifier === baseOptions.layer\r\n    );\r\n\r\n    const options = optionsFromCapabilities(capabilities, baseOptions);\r\n\r\n    const ouputOptions = Object.assign(options, baseOptions);\r\n    const sourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title\r\n      }\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(sourceOptions, ouputOptions);\r\n  }\r\n\r\n  private parseCartoOptions(\r\n    baseOptions: CartoDataSourceOptions,\r\n    cartoOptions: any\r\n  ): CartoDataSourceOptions {\r\n    const layers = [];\r\n    const params = cartoOptions.layers[1].options.layer_definition;\r\n    params.layers.forEach((element) => {\r\n      layers.push({\r\n        type: element.type.toLowerCase(),\r\n        options: element.options,\r\n        legend: element.legend\r\n      });\r\n    });\r\n    const options = ObjectUtils.removeUndefined({\r\n      config: {\r\n        version: params.version,\r\n        layers\r\n      }\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any,\r\n    serviceCapabilities: any,\r\n  ): ArcGISRestDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    let legendInfo: any;\r\n\r\n    if (legend.layers) {\r\n      legendInfo = legend.layers.find(x => x.layerName === title);\r\n    } else if (arcgisOptions.drawingInfo?.renderer) {\r\n      legendInfo = arcgisOptions.drawingInfo.renderer;\r\n    } else {\r\n      legendInfo = undefined;\r\n    }\r\n\r\n    let style;\r\n    if (arcgisOptions.drawingInfo) {\r\n      const styleGenerator = new EsriStyleGenerator();\r\n      const units = arcgisOptions.units === 'esriMeters' ? 'm' : 'degrees';\r\n      style = styleGenerator.generateStyle(arcgisOptions, units);\r\n    }\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        style,\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseTileOrImageArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any,\r\n    serviceCapabilities: any\r\n  ): TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    const legendInfo = legend.layers ? legend.layers.find(x => x.layerName === title) : undefined;\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private findDataSourceInCapabilities(layerArray, name): any {\r\n    if (Array.isArray(layerArray)) {\r\n      let layer;\r\n      layerArray.find((value) => {\r\n        layer = this.findDataSourceInCapabilities(value, name);\r\n        return layer !== undefined;\r\n      }, this);\r\n\r\n      return layer;\r\n    } else if (layerArray.Layer) {\r\n      return this.findDataSourceInCapabilities(layerArray.Layer, name);\r\n    } else {\r\n      if (layerArray.Name && layerArray.Name === name) {\r\n        return layerArray;\r\n      }\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  getTimeFilter(layer) {\r\n    let dimension;\r\n\r\n    if (layer.Dimension) {\r\n      const timeFilter: any = {};\r\n      dimension = layer.Dimension[0];\r\n\r\n      if (dimension.values) {\r\n        const minMaxDim = dimension.values.split('/');\r\n        timeFilter.min = minMaxDim[0] !== undefined ? minMaxDim[0] : undefined;\r\n        timeFilter.max = minMaxDim[1] !== undefined ? minMaxDim[1] : undefined;\r\n        timeFilter.step = minMaxDim[2] !== undefined ? minMaxDim[2] : undefined;\r\n      }\r\n\r\n      if (dimension.default) {\r\n        timeFilter.value = dimension.default;\r\n      }\r\n      return timeFilter;\r\n    }\r\n  }\r\n\r\n  getStyle(Style): LegendOptions {\r\n    const styleOptions: ItemStyleOptions[] = Style.map((style) => {\r\n      return {\r\n        name: style.Name,\r\n        title: style.Title\r\n      };\r\n    })\r\n      // Handle repeat the style \"default\" in output  (MapServer or OpenLayer)\r\n      .filter(\r\n        (item, index, self) =>\r\n          self.findIndex((i: ItemStyleOptions) => i.name === item.name) ===\r\n          index\r\n      );\r\n\r\n    const legendOptions: LegendOptions = {\r\n      stylesAvailable: styleOptions\r\n    } as LegendOptions;\r\n\r\n    return legendOptions;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport proj4 from 'proj4';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * When injected, this service automatically registers and\r\n * projection defined in the application config. A custom projection\r\n * needs to be registered to be usable by OL.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ProjectionService {\r\n\r\n  constructor(private config: ConfigService) {\r\n    const projections = this.config.getConfig('projections') || [];\r\n    projections.forEach((projection: Projection) => {\r\n      projection.alias = projection.alias ? projection.alias : projection.code;\r\n      this.registerProjection(projection);\r\n    });\r\n\r\n    // register all utm zones\r\n    for (let utmZone = 1; utmZone < 61; utmZone++) {\r\n      const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n      const def = `+proj=utm +zone=${utmZone} +datum=WGS84 +units=m +no_defs`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n\r\n    // register all mtm zones\r\n    for (let mtmZone = 1; mtmZone < 11; mtmZone++) {\r\n      const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n      let lon0;\r\n      if (Number(mtmZone) <= 2) {\r\n        lon0 = -50 - Number(mtmZone) * 3;\r\n      } else if (Number(mtmZone) >= 12) {\r\n        lon0 = -81 - (Number(mtmZone) - 12) * 3;\r\n      } else {\r\n        lon0 = -49.5 - Number(mtmZone) * 3;\r\n      }\r\n      const def = `+proj=tmerc +lat_0=0 +lon_0=${lon0} +k=0.9999 +x_0=304800 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs\"`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define a proj4 projection and register it in OL\r\n   * @param projection Projection\r\n   */\r\n  registerProjection(projection: Projection) {\r\n    proj4.defs(projection.code, projection.def);\r\n    olproj4.register(proj4);\r\n    if (projection.extent) {\r\n      olproj.get(projection.code).setExtent(projection.extent);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { forkJoin, of, Observable, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { CapabilitiesService } from './capabilities.service';\r\nimport { OptionsService } from './options/options.service';\r\nimport { WFSService } from './datasources/wfs.service';\r\nimport {\r\n  DataSource,\r\n  OSMDataSource,\r\n  OSMDataSourceOptions,\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  XYZDataSource,\r\n  XYZDataSourceOptions,\r\n  TileDebugDataSource,\r\n  TileDebugDataSourceOptions,\r\n  WFSDataSource,\r\n  WFSDataSourceOptions,\r\n  WMTSDataSource,\r\n  WMTSDataSourceOptions,\r\n  WMSDataSource,\r\n  WMSDataSourceOptions,\r\n  CartoDataSource,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSource,\r\n  ArcGISRestDataSourceOptions,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestImageDataSourceOptions,\r\n  TileArcGISRestDataSource,\r\n  TileArcGISRestDataSourceOptions,\r\n  WebSocketDataSource,\r\n  AnyDataSourceOptions,\r\n  MVTDataSource,\r\n  MVTDataSourceOptions,\r\n  ClusterDataSource,\r\n  ClusterDataSourceOptions\r\n} from './datasources';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ProjectionService } from '../../map/shared/projection.service';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DataSourceService {\r\n  public datasources$ = new BehaviorSubject<DataSource[]>([]);\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    @Optional() private optionsService: OptionsService,\r\n    private wfsDataSourceService: WFSService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private projectionService: ProjectionService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {}\r\n\r\n  createAsyncDataSource(context: AnyDataSourceOptions, detailedContextUri?: string): Observable<DataSource> {\r\n    if (!context.type) {\r\n      console.error(context);\r\n      throw new Error('Datasource needs a type');\r\n    }\r\n    let dataSource;\r\n    switch (context.type.toLowerCase()) {\r\n      case 'osm':\r\n        dataSource = this.createOSMDataSource(context as OSMDataSourceOptions);\r\n        break;\r\n      case 'vector':\r\n        dataSource = this.createFeatureDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'wfs':\r\n        dataSource = this.createWFSDataSource(context as WFSDataSourceOptions);\r\n        break;\r\n      case 'wms':\r\n        const wmsContext = context as WMSDataSourceOptions;\r\n        ObjectUtils.removeDuplicateCaseInsensitive(wmsContext.params);\r\n        dataSource = this.createWMSDataSource(wmsContext, detailedContextUri);\r\n        break;\r\n      case 'wmts':\r\n        dataSource = this.createWMTSDataSource(\r\n          context as WMTSDataSourceOptions\r\n        );\r\n        break;\r\n      case 'xyz':\r\n        dataSource = this.createXYZDataSource(context as XYZDataSourceOptions);\r\n        break;\r\n      case 'tiledebug':\r\n        dataSource = this.createTileDebugDataSource(context as TileDebugDataSource);\r\n        break;\r\n      case 'carto':\r\n        dataSource = this.createCartoDataSource(\r\n          context as CartoDataSourceOptions\r\n        );\r\n        break;\r\n      case 'arcgisrest':\r\n        dataSource = this.createArcGISRestDataSource(\r\n          context as ArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'imagearcgisrest':\r\n        dataSource = this.createArcGISRestImageDataSource(\r\n          context as ArcGISRestImageDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'websocket':\r\n        dataSource = this.createWebSocketDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'mvt':\r\n        dataSource = this.createMVTDataSource(context as MVTDataSourceOptions);\r\n        break;\r\n      case 'tilearcgisrest':\r\n        dataSource = this.createTileArcGISRestDataSource(\r\n          context as TileArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'cluster':\r\n        dataSource = this.createClusterDataSource(\r\n          context as ClusterDataSourceOptions\r\n        );\r\n        break;\r\n      default:\r\n        console.error(context);\r\n        throw new Error('Invalid datasource type');\r\n    }\r\n\r\n    this.datasources$.next(this.datasources$.value.concat([dataSource]));\r\n\r\n    return dataSource;\r\n  }\r\n\r\n  private createOSMDataSource(\r\n    context: OSMDataSourceOptions\r\n  ): Observable<OSMDataSource> {\r\n    return new Observable(d => d.next(new OSMDataSource(context)));\r\n  }\r\n\r\n  private createFeatureDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<FeatureDataSource> {\r\n    return new Observable(d => d.next(new FeatureDataSource(context)));\r\n  }\r\n\r\n  private createWebSocketDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<WebSocketDataSource> {\r\n    return new Observable(d => d.next(new WebSocketDataSource(context)));\r\n  }\r\n\r\n  private createWFSDataSource(\r\n    context: WFSDataSourceOptions\r\n  ): Observable<WFSDataSource> {\r\n    return new Observable(d =>\r\n      d.next(new WFSDataSource(context, this.wfsDataSourceService, this.authInterceptor))\r\n    );\r\n  }\r\n\r\n  private createWMSDataSource(context: WMSDataSourceOptions, detailedContextUri?: string): Observable<any> {\r\n    const observables = [];\r\n    if (context.optionsFromCapabilities) {\r\n      observables.push(\r\n        this.capabilitiesService.getWMSOptions(context).pipe(\r\n          catchError(e => {\r\n            const title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            const message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailable',\r\n              { value: context.params.LAYERS }\r\n            );\r\n\r\n            this.messageService.error(message, title);\r\n            throw e;\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getWMSOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    observables.push(of(context));\r\n\r\n    return forkJoin(observables).pipe(\r\n      map((options: WMSDataSourceOptions[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new WMSDataSource(optionsMerged, this.wfsDataSourceService);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createWMTSDataSource(\r\n    context: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSource> {\r\n    if (context.optionsFromCapabilities) {\r\n      return this.capabilitiesService.getWMTSOptions(context).pipe(\r\n        map((options: WMTSDataSourceOptions) => {\r\n          return options ? new WMTSDataSource(options) : undefined;\r\n        }),\r\n        catchError(() => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailableTitle'\r\n          );\r\n          const message = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailable',\r\n            { value: context.layer }\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          return of(undefined);\r\n        })\r\n      );\r\n    }\r\n\r\n    return new Observable(d => d.next(new WMTSDataSource(context)));\r\n  }\r\n\r\n  private createXYZDataSource(\r\n    context: XYZDataSourceOptions\r\n  ): Observable<XYZDataSource> {\r\n    return new Observable(d => d.next(new XYZDataSource(context)));\r\n  }\r\n\r\n  private createTileDebugDataSource(\r\n    context: TileDebugDataSourceOptions\r\n  ): Observable<TileDebugDataSource> {\r\n    return new Observable(d => d.next(new TileDebugDataSource(context)));\r\n  }\r\n\r\n  private createCartoDataSource(\r\n    context: CartoDataSourceOptions\r\n  ): Observable<CartoDataSource> {\r\n    if (context.mapId) {\r\n      return this.capabilitiesService\r\n        .getCartoOptions(context)\r\n        .pipe(\r\n          map((options: CartoDataSourceOptions) => new CartoDataSource(options))\r\n        );\r\n    }\r\n    return new Observable(d => d.next(new CartoDataSource(context)));\r\n  }\r\n\r\n  private createArcGISRestDataSource(\r\n    context: ArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestDataSource> {\r\n    const observables = [];\r\n    observables.push(this.capabilitiesService.getArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.layer }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createArcGISRestImageDataSource(\r\n    context: ArcGISRestImageDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestImageDataSourceOptions> {\r\n    const observables = [];\r\n\r\n    observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.params.LAYERS }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ImageArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ImageArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createTileArcGISRestDataSource(\r\n    context: TileArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<TileArcGISRestDataSource> {\r\n    const observables = [];\r\n    observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.params.LAYERS }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: TileArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new TileArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createMVTDataSource(\r\n    context: MVTDataSourceOptions\r\n  ): Observable<MVTDataSource> {\r\n    return new Observable(d => d.next(new MVTDataSource(context)));\r\n  }\r\n\r\n  private createClusterDataSource(\r\n    context: ClusterDataSourceOptions\r\n  ): Observable<ClusterDataSource> {\r\n    return new Observable(d => d.next(new ClusterDataSource(context)));\r\n  }\r\n}\r\n","import * as olextent from 'ol/extent';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeometryLayout from 'ol/geom/GeometryLayout';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport {\r\n  EntityKey,\r\n  getEntityId,\r\n  getEntityTitle,\r\n  getEntityRevision,\r\n  getEntityIcon,\r\n  getEntityProperty\r\n} from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { FEATURE, FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureGeometry } from './feature.interfaces';\r\nimport { FeatureStore } from './store';\r\n\r\n/**\r\n * Create an Openlayers feature object out of a feature definition.\r\n * The output object has a reference to the feature id.\r\n * @param feature Feature definition\r\n * @param projectionOut Feature object projection\r\n * @returns OpenLayers feature object\r\n */\r\nexport function featureToOl(\r\n  feature: Feature,\r\n  projectionOut: string,\r\n  getId?: (Feature) => EntityKey\r\n): OlFeature<OlGeometry> {\r\n  getId = getId ? getId : getEntityId;\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const olFeature = olFormat.readFeature(feature, {\r\n    dataProjection: feature.projection,\r\n    featureProjection: projectionOut\r\n  });\r\n\r\n  olFeature.setId(getId(feature));\r\n\r\n  const title = getEntityTitle(feature);\r\n  if (title !== undefined) {\r\n    olFeature.set('_title', title, true);\r\n  }\r\n\r\n  if (feature.extent !== undefined) {\r\n    olFeature.set('_extent', feature.extent, true);\r\n  }\r\n\r\n  if (feature.projection !== undefined) {\r\n    olFeature.set('_projection', feature.projection, true);\r\n  }\r\n\r\n  const mapTitle = getEntityProperty(feature, 'meta.mapTitle');\r\n  if (mapTitle !== undefined) {\r\n    olFeature.set('_mapTitle', mapTitle, true);\r\n  }\r\n\r\n  olFeature.set('_entityRevision', getEntityRevision(feature), true);\r\n\r\n  const icon = getEntityIcon(feature);\r\n  if (icon !== undefined) {\r\n    olFeature.set('_icon', icon, true);\r\n  }\r\n\r\n  if (feature.meta && feature.meta.style) {\r\n    olFeature.set('_style', feature.meta.style, true);\r\n  }\r\n\r\n  if (feature.sourceId) {\r\n    olFeature.set('_sourceId', feature.sourceId, true);\r\n  }\r\n\r\n  return olFeature;\r\n}\r\n\r\nexport function renderFeatureFromOl(\r\n  olRenderFeature: OlRenderFeature,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let geom;\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    if (olLayer.get('sourceOptions')) {\r\n      exclude = olLayer.get('sourceOptions').excludeAttribute;\r\n      excludeOffline = olLayer.get('sourceOptions').excludeAttributeOffline;\r\n    }\r\n  } else {\r\n    title = olRenderFeature.get('_title');\r\n  }\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const properties = olRenderFeature.getProperties();\r\n  const geometryType = olRenderFeature.getType();\r\n\r\n  if (geometryType === 'Polygon') {\r\n    const ends = olRenderFeature.getEnds() as number[];\r\n    geom = new OlPolygon(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      OlGeometryLayout.XY,\r\n      ends\r\n    );\r\n  } else if (geometryType === 'Point') {\r\n    geom = new OlPoint(olRenderFeature.getFlatCoordinates(), OlGeometryLayout.XY);\r\n  } else if (geometryType === 'LineString') {\r\n    geom = new OlLineString(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      OlGeometryLayout.XY\r\n    );\r\n  }\r\n\r\n  const geometry = olFormat.writeGeometryObject(geom, {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  const id = olRenderFeature.getId() ? olRenderFeature.getId() : uuid();\r\n  const mapTitle = olRenderFeature.get('_mapTitle');\r\n  const extent = olproj.transformExtent(olRenderFeature.getExtent(), projectionIn, projectionOut) as [number, number, number, number];\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent,\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olRenderFeature\r\n  };\r\n}\r\n/**\r\n * Create a feature object out of an OL feature\r\n * The output object has a reference to the feature id.\r\n * @param olFeature OL Feature\r\n * @param projectionIn OL feature projection\r\n * @param olLayer OL Layer\r\n * @param projectionOut Feature projection\r\n * @returns Feature\r\n */\r\nexport function featureFromOl(\r\n  olFeature: OlFeature<OlGeometry>,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n  let idColumn; // for arcgisrest and tilearcgisrest source\r\n  const olFormat = new OlFormatGeoJSON();\r\n\r\n  const keys = olFeature.getKeys().filter((key: string) => {\r\n    return !key.startsWith('_') && key !== 'geometry';\r\n  });\r\n  const properties = keys.reduce((acc: object, key: string) => {\r\n    acc[key] = olFeature.get(key);\r\n    return acc;\r\n  }, {});\r\n\r\n  const geometry = olFormat.writeGeometryObject(olFeature.getGeometry(), {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    const sourceOptions = olLayer.get('sourceOptions');\r\n    if (sourceOptions) {\r\n      exclude = sourceOptions.excludeAttribute;\r\n      excludeOffline = sourceOptions.excludeAttributeOffline;\r\n      idColumn =\r\n        sourceOptions.idColumn ||\r\n        ((sourceOptions.type === 'arcgisrest' || sourceOptions.type === 'tilearcgisrest') ? 'OBJECTID' : undefined );\r\n    }\r\n  } else {\r\n    title = olFeature.get('_title');\r\n  }\r\n  const mapTitle = olFeature.get('_mapTitle');\r\n  const id = olFeature.getId() ? olFeature.getId() : olFeature.get(idColumn) ? olFeature.get(idColumn) : uuid();\r\n  const newFeature = olFeature.get('_newFeature');\r\n\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent: olFeature.get('_extent'),\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      revision: olFeature.getRevision(),\r\n      style: olFeature.get('_style'),\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olFeature\r\n  };\r\n}\r\n\r\n/**\r\n * Compute an OL feature extent in it's map projection\r\n * @param map Map\r\n * @param olFeature OL feature\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeatureExtent(\r\n  map: IgoMap,\r\n  olFeature: OlFeature<OlGeometry>\r\n): [number, number, number, number] {\r\n  let olExtent = olextent.createEmpty();\r\n\r\n  const olFeatureExtent = olFeature.get('_extent');\r\n  const olFeatureProjection = olFeature.get('_projection');\r\n  if (olFeatureExtent !== undefined && olFeatureProjection !== undefined) {\r\n    olExtent = olproj.transformExtent(\r\n      olFeatureExtent,\r\n      olFeatureProjection,\r\n      map.projection\r\n    );\r\n  } else {\r\n    const olGeometry = olFeature.getGeometry();\r\n    if (olGeometry !== null) {\r\n      olExtent = olGeometry.getExtent();\r\n    }\r\n  }\r\n\r\n  return olExtent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Compute a multiple OL features extent in their map projection\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeaturesExtent(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[]\r\n): [number, number, number, number] {\r\n  const extent = olextent.createEmpty();\r\n\r\n  olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const featureExtent = computeOlFeatureExtent(map, olFeature);\r\n    olextent.extend(extent, featureExtent);\r\n  });\r\n\r\n  return extent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Scale an extent.\r\n * @param extent Extent\r\n * @param Scaling factors for top, right, bottom and left directions, in that order\r\n * @returns Scaled extent\r\n */\r\nexport function scaleExtent(\r\n  extent: [number, number, number, number],\r\n  scale: [number, number, number, number]\r\n): [number, number, number, number] {\r\n  const [width, height] = olextent.getSize(extent);\r\n  return [\r\n    scale[3] ? extent[0] - width * scale[3] : extent[0],\r\n    scale[2] ? extent[1] - height * scale[2] : extent[1],\r\n    scale[1] ? extent[2] + width * scale[1] : extent[2],\r\n    scale[0] ? extent[3] + height * scale[0] : extent[3]\r\n  ];\r\n}\r\n\r\n/**\r\n * Return true if features are out of view.\r\n * If features are too close to the edge, they are considered out of view.\r\n * We define the edge as 5% of the extent size.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @returns Return true if features are out of view\r\n */\r\nexport function featuresAreOutOfView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number]\r\n) {\r\n  const mapExtent = map.viewController.getExtent();\r\n  const edgeRatio = 0.05;\r\n  const scale = [-1, -1, -1, -1].map(x => x * edgeRatio);\r\n  const viewExtent = scaleExtent(mapExtent, scale as [\r\n    number,\r\n    number,\r\n    number,\r\n    number\r\n  ]);\r\n\r\n  return !olextent.containsExtent(viewExtent, featuresExtent);\r\n}\r\n\r\n/**\r\n * Return true if features are too deep into the view. This results\r\n * in features being too small.\r\n * Features are considered too small if their extent occupies less than\r\n * 1% of the map extent.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @param areaRatio The features extent to view extent acceptable ratio\r\n * @returns Return true if features are too deep in the view\r\n */\r\nexport function featuresAreTooDeepInView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  // An area ratio of 0.004 means that the feature extent's width and height\r\n  // should be about 1/16 of the map extent's width and height\r\n  areaRatio = areaRatio ? areaRatio : 0.004;\r\n  const mapExtent = map.viewController.getExtent();\r\n  const mapExtentArea = olextent.getArea(mapExtent);\r\n  const featuresExtentArea = olextent.getArea(featuresExtent);\r\n\r\n  if (featuresExtentArea === 0 && map.viewController.getZoom() > 13) {\r\n    // In case it's a point\r\n    return false;\r\n  }\r\n\r\n  return featuresExtentArea / mapExtentArea < areaRatio;\r\n}\r\n\r\n/**\r\n * Fit view to include the features extent.\r\n * By default, this method will let the features occupy about 50% of the viewport.\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @param motion To motion to the new map view\r\n * @param scale If this is defined, the original view will be scaled\r\n *  by that factor before any logic is applied.\r\n */\r\nexport function moveToOlFeatures(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  motion: FeatureMotion = FeatureMotion.Default,\r\n  scale?: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  const featuresExtent = computeOlFeaturesExtent(map, olFeatures);\r\n  let viewExtent = featuresExtent;\r\n  if (scale !== undefined) {\r\n    viewExtent = scaleExtent(viewExtent, scale);\r\n  }\r\n\r\n  if (motion === FeatureMotion.Zoom) {\r\n    map.viewController.zoomToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Move) {\r\n    map.viewController.moveToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Default) {\r\n    if (\r\n      featuresAreOutOfView(map, featuresExtent) ||\r\n      featuresAreTooDeepInView(map, featuresExtent, areaRatio)\r\n    ) {\r\n      map.viewController.zoomToExtent(viewExtent);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hide an OL feature\r\n * @param olFeature OL feature\r\n */\r\nexport function hideOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n  olFeature.setStyle(new olstyle.Style({}));\r\n}\r\n\r\n/**\r\n * Try to bind a layer to a store if none is bound already.\r\n * The layer will also be added to the store's map.\r\n * If no layer is given to that function, a basic one will be created.\r\n * @param store The store to bind the layer\r\n * @param layer An optional VectorLayer\r\n */\r\nexport function tryBindStoreLayer(store: FeatureStore, layer?: VectorLayer) {\r\n  if (store.layer !== undefined) {\r\n    if (store.layer.map === undefined) {\r\n      store.map.addLayer(store.layer);\r\n    }\r\n    return;\r\n  }\r\n\r\n  layer = layer\r\n    ? layer\r\n    : new VectorLayer({\r\n        source: new FeatureDataSource()\r\n      });\r\n  store.bindLayer(layer);\r\n  if (store.layer.map === undefined) {\r\n    store.map.addLayer(store.layer);\r\n  }\r\n}\r\n\r\n/**\r\n * Compute a diff between a source array of Ol features and a target array\r\n * @param source Source array of OL features\r\n * @param starget Target array of OL features\r\n * @returns Features to add and remove\r\n */\r\nexport function computeOlFeaturesDiff(\r\n  source: OlFeature<OlGeometry>[],\r\n  target: OlFeature<OlGeometry>[]\r\n): {\r\n  add: OlFeature<OlGeometry>[];\r\n  remove: OlFeature<OlGeometry>[];\r\n} {\r\n  const olFeaturesMap = new Map();\r\n  target.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    olFeaturesMap.set(olFeature.getId(), olFeature);\r\n  });\r\n\r\n  const olFeaturesToRemove = [];\r\n  source.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const newOlFeature = olFeaturesMap.get(olFeature.getId());\r\n    if (newOlFeature === undefined) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else if (\r\n      newOlFeature.get('_entityRevision') !== olFeature.get('_entityRevision')\r\n    ) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else {\r\n      olFeaturesMap.delete(newOlFeature.getId());\r\n    }\r\n  });\r\n\r\n  const olFeaturesToAddIds = Array.from(olFeaturesMap.keys());\r\n  const olFeaturesToAdd = target.filter((olFeature: OlFeature<OlGeometry>) => {\r\n    return olFeaturesToAddIds.indexOf(olFeature.getId()) >= 0;\r\n  });\r\n\r\n  return {\r\n    add: olFeaturesToAdd,\r\n    remove: olFeaturesToRemove\r\n  };\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  getEntityId,\r\n  EntityKey,\r\n  EntityStore\r\n} from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureStoreOptions } from './feature.interfaces';\r\nimport { computeOlFeaturesDiff, featureFromOl, featureToOl, moveToOlFeatures } from './feature.utils';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * features and the map layer to display them on. Synchronization\r\n * between the store and the layer is handled by strategies.\r\n */\r\nexport class FeatureStore<T extends Feature = Feature> extends EntityStore<T> {\r\n\r\n  /**\r\n   * Vector layer to display the features on\r\n   */\r\n  layer: VectorLayer;\r\n\r\n  /**\r\n   * The map the layer is bound to\r\n   */\r\n  readonly map: IgoMap;\r\n\r\n  /**\r\n   * The layer's data source\r\n   */\r\n  get source(): FeatureDataSource {\r\n    return this.layer ? this.layer.dataSource as FeatureDataSource : undefined;\r\n  }\r\n\r\n  constructor(entities: T[], options: FeatureStoreOptions) {\r\n    super(entities, options);\r\n    this.map = options.map;\r\n  }\r\n\r\n  /**\r\n   * Bind this store to a vector layer\r\n   * @param layer Vector layer\r\n   * @returns Feature store\r\n   */\r\n  bindLayer(layer: VectorLayer): FeatureStore {\r\n    this.layer = layer;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible. Strategies\r\n   * make extensive use of that method.\r\n   * @param features Features\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  setLayerFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number,\r\n    getId?: (Feature) => EntityKey\r\n  ) {\r\n    getId = getId ? getId : getEntityId;\r\n    this.checkLayer();\r\n\r\n    const olFeatures = features\r\n      .map((feature: Feature) => featureToOl(feature, this.map.projection, getId));\r\n    this.setLayerOlFeatures(olFeatures, motion, viewScale, areaRatio);\r\n  }\r\n\r\n  /**\r\n   * Set the store's features from an array of OL features.\r\n   * @param olFeatures Ol features\r\n   */\r\n  setStoreOlFeatures(olFeatures: OlFeature<OlGeometry>[]) {\r\n    this.checkLayer();\r\n\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n      return featureFromOl(olFeature, this.layer.map.projection);\r\n    });\r\n    this.load(features as T[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all features from the layer\r\n   */\r\n  clearLayer() {\r\n    this.checkLayer();\r\n    this.source.ol.clear();\r\n  }\r\n\r\n  /**\r\n   * Check wether a layer is bound or not and throw an error if not.\r\n   */\r\n  private checkLayer() {\r\n    if (this.layer === undefined) {\r\n      throw new Error('This FeatureStore is not bound to a layer.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible.\r\n   * @param features Openlayers feature objects\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  public setLayerOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number\r\n  ) {\r\n    const olSource = this.layer.ol.getSource();\r\n    const diff = computeOlFeaturesDiff(olSource.getFeatures(), olFeatures);\r\n    if (diff.remove.length > 0) {\r\n      this.removeOlFeaturesFromLayer(diff.remove);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      this.addOlFeaturesToLayer(diff.add);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      // If features are added, do a motion toward the newly added features\r\n      moveToOlFeatures(this.map, diff.add, motion, viewScale, areaRatio);\r\n    } else if (diff.remove.length > 0) {\r\n      // Else, do a motion toward all the features\r\n      moveToOlFeatures(this.map, olFeatures, motion, viewScale, areaRatio);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add features to the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private addOlFeaturesToLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n    });\r\n    this.source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private removeOlFeaturesFromLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      this.source.ol.removeFeature(olFeature);\r\n    });\r\n  }\r\n\r\n}\r\n","import * as olextent from 'ol/extent';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapExtentStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\nimport { skipWhile } from 'rxjs/operators';\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is moved.\r\n * The features's state inside the map are tagged inMapExtent = true;\r\n */\r\nexport class FeatureStoreInMapExtentStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private states$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapExtentStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .pipe(skipWhile((empty) => !empty))\r\n      .subscribe(() => this.updateEntitiesInExtent(store));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInExtent(store);\r\n    this.states$$.push(store.layer.map.viewController.state$.subscribe(() => {\r\n      this.updateEntitiesInExtent(store);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInExtent(store) {\r\n    if (store?.layer?.map?.viewController) {\r\n      store.state.updateAll({ inMapExtent: false });\r\n      const mapExtent = store.layer.map.viewController.getExtent();\r\n      let entitiesInMapExtent = [];\r\n      let entitiesWithNoGeom = [];\r\n      for (const entity of store.entities$.value) {\r\n        if (entity.ol) {\r\n          if (olextent.intersects(entity.ol.getGeometry().getExtent(), mapExtent)) {\r\n            entitiesInMapExtent.push(entity);\r\n          }\r\n        } else {\r\n          entitiesWithNoGeom.push(entity);\r\n        }\r\n      }\r\n      if (entitiesInMapExtent.length > 0) {\r\n        store.state.updateMany(entitiesInMapExtent, { inMapExtent: true }, false);\r\n      }\r\n      if (entitiesWithNoGeom.length > 0) {\r\n        store.state.updateMany(entitiesWithNoGeom, { inMapExtent: true }, false);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.states$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapResolutionStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\n\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is scrolled.\r\n * The features's state inside the map's resolution are tagged inMapResolution = true;\r\n */\r\nexport class FeatureStoreInMapResolutionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private resolution$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapResolutionStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .subscribe(() => this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution()));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution());\r\n    this.resolution$$.push(store.layer.map.viewController.resolution$.subscribe((res) => {\r\n      this.updateEntitiesInResolution(store, res);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInResolution(store, mapResolution: number) {\r\n    if (mapResolution > store.layer.minResolution && mapResolution < store.layer.maxResolution) {\r\n      store.state.updateAll({ inMapResolution: true });\r\n    } else {\r\n      store.state.updateAll({ inMapResolution: false });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.resolution$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureMotion } from '../feature.enums';\r\nimport { Feature, FeatureStoreLoadingStrategyOptions } from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\n\r\n/**\r\n * This strategy loads a store's features into it's layer counterpart.\r\n * The store -> layer binding is a one-way binding. That means any entity\r\n * added to the store will be added to the layer but the opposite is false.\r\n *\r\n * Important: This strategy observes filtered entities, not raw entities. This\r\n * is not configurable yet.\r\n */\r\nexport class FeatureStoreLoadingStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's features\r\n   */\r\n  private stores$$ = new Map<FeatureStore, Subscription>();\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  constructor(protected options: FeatureStoreLoadingStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on load\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for entities changes in a store.\r\n   * Important: Never observe a store's sorted entities. It makes no sense\r\n   * to display sorted entities (instead of unsorted) on a layer and it\r\n   * would potentially result in a lot of useless computation.\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const subscription = store.view.all$()\r\n      .subscribe((features: Feature[]) => this.onFeaturesChange(features, store));\r\n    this.stores$$.set(store, subscription);\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in a store.\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const subscription = this.stores$$.get(store);\r\n    if (subscription !== undefined) {\r\n      subscription.unsubscribe();\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, Subscription]) => {\r\n      entries[1].unsubscribe();\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features into a layer or clear the layer if the array of features is empty.\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onFeaturesChange(features: Feature[], store: FeatureStore) {\r\n    if (features.length === 0) {\r\n      store.clearLayer();\r\n    } else {\r\n      store.setLayerFeatures(\r\n        features,\r\n        this.selectMotion(store),\r\n        this.options.viewScale,\r\n        this.options.areaRatio,\r\n        this.options.getFeatureId\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Selects the best motion\r\n   * @param store A FeatureStore to apply the motion\r\n   * @returns The motion selected\r\n   */\r\n  private selectMotion(store: FeatureStore) {\r\n    if (this.motion !== undefined) { return this.motion; }\r\n\r\n    if (store.pristine === true) {\r\n      // If features have just been loaded into the store, move/zoom on them\r\n      return FeatureMotion.Default;\r\n    } else if (store.count > store.view.count) {\r\n      // If features have been filtered, move/zoom on the remaining ones\r\n      return FeatureMotion.Default;\r\n    } else {\r\n      // On insert, update or delete, do nothing\r\n      return FeatureMotion.None;\r\n    }\r\n  }\r\n}\r\n","import OlEvent from 'ol/events/Event';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreLoadingLayerStrategyOptions } from '../feature.interfaces';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\n/**\r\n * This strategy loads a layer's features into it's store counterpart.\r\n * The layer -> store binding is a one-way binding. That means any OL feature\r\n * added to the layer will be added to the store but the opposite is false.\r\n *\r\n * Important: In it's current state, this strategy is to meant to be combined\r\n * with a standard Loading strategy and it would probably cause recursion issues.\r\n */\r\nexport class FeatureStoreLoadingLayerStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n\r\n  constructor(protected options: FeatureStoreLoadingLayerStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.onSourceChanges(store);\r\n    const olSource = store.layer.ol.getSource();\r\n    olSource.on('change', (event: OlEvent) => {\r\n      this.onSourceChanges(store);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, string]) => {\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features from an OL source into a  store or clear the store if the source is empty\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onSourceChanges(store: FeatureStore) {\r\n    let olFeatures = store.layer.ol.getSource().getFeatures();\r\n\r\n    if (store.layer.dataSource instanceof ClusterDataSource) {\r\n      olFeatures = (olFeatures as any).flatMap((cluster: any) =>\r\n        cluster.get('features')\r\n      );\r\n    }\r\n    if (olFeatures.length === 0) {\r\n      store.clear();\r\n    } else {\r\n      store.setStoreOlFeatures(olFeatures);\r\n    }\r\n  }\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlDragBoxInteraction, { DragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { DragBoxEvent as OlDragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { EventsKey } from 'ol/events';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subscription, combineLatest } from 'rxjs';\r\nimport { map, debounceTime, skip } from 'rxjs/operators';\r\n\r\nimport { EntityKey, EntityRecord, EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../../datasource';\r\nimport { VectorLayer } from '../../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { ctrlKeyDown } from '../../../map/shared/map.utils';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureStoreSelectionStrategyOptions\r\n} from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureMotion } from '../feature.enums';\r\n\r\nexport class OlDragSelectInteraction extends OlDragBoxInteraction {\r\n  constructor(options) {\r\n    super(options);\r\n  }\r\n}\r\n\r\n/**\r\n * This strategy synchronizes a store and a layer selected entities.\r\n * The store <-> layer binding is a two-way binding.\r\n *\r\n * In many cases, a single strategy bound to multiple stores\r\n * will yield better results that multiple strategies with each their\r\n * own store. In the latter scenario, a click on overlapping features\r\n * would trigger the strategy of each layer and they would cancel\r\n * each other as well as move the map view around needlessly.\r\n */\r\nexport class FeatureStoreSelectionStrategy extends EntityStoreStrategy {\r\n  /**\r\n   * Listener to the map click event that allows selecting a feature\r\n   * by clicking on the map\r\n   */\r\n  private mapClickListener;\r\n\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Subscription to all stores selected entities\r\n   */\r\n  private stores$$: Subscription;\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  /**\r\n   * The map the layers belong to\r\n   */\r\n  get map(): IgoMap {\r\n    return this.options.map;\r\n  }\r\n\r\n  /**\r\n   * A feature store that'll contain the selected features. It has it's own\r\n   * layer, shared by all the stores this staretgy is bound to.\r\n   */\r\n  get overlayStore(): FeatureStore {\r\n    return this._overlayStore;\r\n  }\r\n  private _overlayStore: FeatureStore;\r\n\r\n  constructor(protected options: FeatureStoreSelectionStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n    this._overlayStore = this.createOverlayStore();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on select\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Unselect all entities, from all stores\r\n   */\r\n  unselectAll() {\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      store.state.updateAll({ selected: false });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.overlayStore.clear();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the selection without removing the selection\r\n   * overlay.\r\n   */\r\n  deactivateSelection() {\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer, setup the map click lsitener and\r\n   * start watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.addOverlayLayer();\r\n    this.listenToMapClick();\r\n    if (this.options.dragBox === true) {\r\n      this.addDragBoxInteraction();\r\n    }\r\n    this.watchAll();\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer, remove the map click lsitener and\r\n   * stop watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.deactivateSelection();\r\n    this.removeOverlayLayer();\r\n  }\r\n\r\n  /**\r\n   * Create a single observable of all the stores. With a single observable,\r\n   * features can be added all at once to the overlay layer and a single\r\n   * motion can be performed. Multiple observable would have\r\n   * a cancelling effect on each other.\r\n   */\r\n  private watchAll() {\r\n    this.unwatchAll();\r\n\r\n    const stores$ = this.stores.map((store: FeatureStore) => {\r\n      return store.stateView\r\n        .manyBy$((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          map((records: EntityRecord<Feature>[]) =>\r\n            records.map((record) => record.entity)\r\n          )\r\n        );\r\n    });\r\n    this.stores$$ = combineLatest(stores$)\r\n      .pipe(\r\n        debounceTime(5),\r\n        skip(1), // Skip intial selection\r\n        map((features: Array<Feature[]>) =>\r\n          features.reduce((a, b) => a.concat(b))\r\n        )\r\n      )\r\n      .subscribe((features: Feature[]) => this.onSelectFromStore(features));\r\n  }\r\n\r\n  /**\r\n   * Stop watching for selection in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    if (this.stores$$ !== undefined) {\r\n      this.stores$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a 'singleclick' listener to the map that'll allow selecting\r\n   * features by clicking on the map. The selection will be performed\r\n   * only on the layers bound to this strategy.\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => {\r\n        this.onMapClick(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove the map click listener\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n  }\r\n\r\n  /**\r\n   * On map click, select feature at pixel\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onMapClick(event: MapBrowserPointerEvent<any>) {\r\n    const exclusive = !ctrlKeyDown(event);\r\n    const reverse = !exclusive;\r\n    const olFeatures = event.map.getFeaturesAtPixel(event.pixel, {\r\n      hitTolerance: this.options.hitTolerance || 0,\r\n      layerFilter: olLayer => {\r\n        const storeOlLayer = this.stores.find((store: FeatureStore) => {\r\n          return store.layer.ol === olLayer;\r\n        });\r\n        return storeOlLayer !== undefined;\r\n      }\r\n    }) as OlFeature<OlGeometry>[];\r\n    this.onSelectFromMap(olFeatures, exclusive, reverse);\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteraction;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteraction = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteraction === undefined) {\r\n      olDragSelectInteraction = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteraction);\r\n      this.olDragSelectInteraction = olDragSelectInteraction;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteraction.on(\r\n      'boxend',\r\n      (event: DragBoxEvent) => this.onDragBoxEnd(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * On dragbox end, select features in drag box\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onDragBoxEnd(event: OlDragBoxEvent) {\r\n    const exclusive = !ctrlKeyDown(event.mapBrowserEvent);\r\n    const target = event.target as any;\r\n    const extent = target.getGeometry().getExtent();\r\n    const olFeatures = this.stores.reduce(\r\n      (acc: OlFeature<OlGeometry>[], store: FeatureStore) => {\r\n        const olSource = store.layer.ol.getSource();\r\n        acc.push(...olSource.getFeaturesInExtent(extent));\r\n        return acc;\r\n      },\r\n      []\r\n    );\r\n    this.onSelectFromMap(olFeatures, exclusive, false);\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the store, add\r\n   * them to this startegy's overlay layer (select on map)\r\n   * @param features Store features\r\n   */\r\n  private onSelectFromStore(features: Feature[]) {\r\n    const motion = this.motion;\r\n    const olOverlayFeatures = this.overlayStore.layer.ol\r\n      .getSource()\r\n      .getFeatures();\r\n    const overlayFeaturesKeys = olOverlayFeatures.map((olFeature: OlFeature<OlGeometry>) =>\r\n      olFeature.getId()\r\n    );\r\n    const featuresKeys = features.map(this.overlayStore.getKey);\r\n\r\n    let doMotion;\r\n    if (features.length === 0) {\r\n      doMotion = false;\r\n    } else {\r\n      doMotion =\r\n        overlayFeaturesKeys.length !== featuresKeys.length ||\r\n        !overlayFeaturesKeys.every(\r\n          (key: EntityKey) => featuresKeys.indexOf(key) >= 0\r\n        );\r\n    }\r\n\r\n    this.overlayStore.setLayerFeatures(\r\n      features,\r\n      doMotion ? motion : FeatureMotion.None,\r\n      this.options.viewScale,\r\n      this.options.areaRatio,\r\n      this.options.getFeatureId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the map, also select them\r\n   * in their store.\r\n   * @param olFeatures OL feature objects\r\n   */\r\n  private onSelectFromMap(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    const groupedFeatures = this.groupFeaturesByStore(olFeatures);\r\n\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      const features = groupedFeatures.get(store);\r\n      if (features === undefined && exclusive === true) {\r\n        this.unselectAllFeaturesFromStore(store);\r\n      } else if (features === undefined && exclusive === false) {\r\n        // Do nothing\r\n      } else {\r\n        this.selectFeaturesFromStore(store, features, exclusive, reverse);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Select features in store\r\n   * @param store: Feature store\r\n   * @param features Features\r\n   */\r\n  private selectFeaturesFromStore(\r\n    store: FeatureStore,\r\n    features: Feature[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    if (reverse === true) {\r\n      store.state.reverseMany(features, ['selected']);\r\n    } else {\r\n      store.state.updateMany(features, { selected: true }, exclusive);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unselect all features from store\r\n   * @param store: Feature store\r\n   */\r\n  private unselectAllFeaturesFromStore(store: FeatureStore) {\r\n    store.state.updateAll({ selected: false });\r\n  }\r\n\r\n  /**\r\n   * This method returns a store -> features mapping from a list\r\n   * of OL selected features. OL features keep a reference to the store\r\n   * they are from.\r\n   * @param olFeatures: OL feature objects\r\n   * @returns Store -> features mapping\r\n   */\r\n  private groupFeaturesByStore(\r\n    olFeatures: OlFeature<OlGeometry>[]\r\n  ): Map<FeatureStore, Feature[]> {\r\n    const groupedFeatures = new Map<FeatureStore, Feature[]>();\r\n    if (olFeatures === null || olFeatures === undefined) {\r\n      return groupedFeatures;\r\n    }\r\n\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      const store = olFeature.get('_featureStore');\r\n      if (store === undefined) {\r\n        return;\r\n      }\r\n\r\n      let features = groupedFeatures.get(store);\r\n      if (features === undefined) {\r\n        features = [];\r\n        groupedFeatures.set(store, features);\r\n      }\r\n\r\n      const feature = store.get(olFeature.getId());\r\n      if (feature !== undefined) {\r\n        features.push(feature);\r\n      }\r\n    });\r\n\r\n    return groupedFeatures;\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay store\r\n   */\r\n  private createOverlayStore(): FeatureStore {\r\n    const overlayLayer = this.options.layer\r\n      ? this.options.layer\r\n      : this.createOverlayLayer();\r\n    return new FeatureStore([], { map: this.map }).bindLayer(overlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay layer\r\n   */\r\n  private createOverlayLayer(): VectorLayer {\r\n    return new VectorLayer({\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      style: undefined,\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay store's layer to the map to display the selected\r\n   * features.\r\n   */\r\n  private addOverlayLayer() {\r\n    if (this.overlayStore.layer.map === undefined) {\r\n      this.map.addLayer(this.overlayStore.layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer from the map\r\n   */\r\n  private removeOverlayLayer() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.map.removeLayer(this.overlayStore.layer);\r\n  }\r\n}\r\n","import { FeatureStore } from './store';\r\nimport { FeatureStoreSelectionStrategy } from './strategies/selection';\r\nimport { FeatureStoreLoadingStrategy } from './strategies/loading';\r\n\r\n/**\r\n * Try to add a loading strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the loading strategy\r\n * @param strategy An optional loading strategy\r\n */\r\nexport function tryAddLoadingStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreLoadingStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreLoadingStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    return;\r\n  }\r\n\r\n  strategy = strategy ? strategy : new FeatureStoreLoadingStrategy({});\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n\r\n/**\r\n * Try to add a selection strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the selection strategy\r\n * @param [strategy] An optional selection strategy\r\n */\r\nexport function tryAddSelectionStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreSelectionStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreSelectionStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n    return;\r\n  }\r\n  strategy = strategy\r\n    ? strategy\r\n    : new FeatureStoreSelectionStrategy({\r\n        map: store.map\r\n      });\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\n/**\r\n * Create a marker style for points\r\n * @returns Style\r\n */\r\nexport function createOverlayMarkerStyle({\r\n  text,\r\n  opacity = 1,\r\n  markerColor = [0, 161, 222],\r\n  markerOutlineColor = [255, 255, 255]\r\n}: {\r\n  text?: string;\r\n  opacity?: number;\r\n  markerColor?: string | number[];\r\n  markerOutlineColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  let iconColor;\r\n  let svgIconColor;\r\n  let svgOutlineColor;\r\n  let svg;\r\n\r\n  const isIE = /msie\\s|trident\\/|edge\\//i.test(window.navigator.userAgent); // To fix IE11 svg bug (temporarly)\r\n\r\n  const newColor = ColorAsArray(markerColor).slice(0);\r\n  const newOutlineColor = ColorAsArray(markerOutlineColor).slice(0);\r\n\r\n  if (newColor.length === 4 && (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n    opacity = newColor[3];\r\n  }\r\n\r\n  svgIconColor = `\"rgba(${newColor[0]},${newColor[1]},${newColor[2]},${opacity})\"`;\r\n  iconColor = markerColor;\r\n\r\n  svgOutlineColor = `\"rgb(${newOutlineColor[0]},${newOutlineColor[1]},${newOutlineColor[2]})\"`;\r\n\r\n  svg =\r\n    'data:image/svg+xml;utf8,<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" height=\"36\" width=\"36\" viewBox=\"0 0 36 36\">' +\r\n    '<path fill=' +\r\n    svgIconColor +\r\n    ' stroke=' +\r\n    svgOutlineColor +\r\n    ` stroke-width=\"2\" d=\"M 17.692635,32.565644 C 15.71852,30.330584 13.290925,27.058065 11.6766,24.455732 9.3398623,20.688851 7.8905694,17.205334 7.6297492,14.728733 7.5616025,14.081649 7.5739557,12.528552 7.6513363,12.014724 8.1013861,9.0262716 9.8047068,6.3655569 12.310675,4.7364878 c 1.113691,-0.7239832 2.508083,-1.2834131 3.776687,-1.5152052 0.242945,-0.044389 0.451656,-0.09393 0.463804,-0.1100911 0.01215,-0.016161 0.638282,-0.025502 1.391411,-0.02076 1.088235,0.00685 1.450932,0.024316 1.766871,0.085071 2.650763,0.5097353 4.947142,1.8701891 6.498786,3.8501033 0.628018,0.8013587 1.297046,2.0200608 1.640967,2.9891872 0.191065,0.538399 0.427644,1.447408 0.477391,1.834287 0.0164,0.127546 0.0434,0.231902 0.06,0.231902 0.0166,0 0.03122,0.626135 0.03249,1.391411 0.0013,0.765276 -0.011,1.391411 -0.02726,1.391411 -0.01626,0 -0.05449,0.154049 -0.08495,0.342331 -0.08815,0.544879 -0.387235,1.721449 -0.604837,2.379406 -1.209421,3.656888 -4.014463,8.349762 -7.849521,13.132357 -0.790496,0.985807 -1.795217,2.167992 -1.842543,2.167992 -0.01896,0 -0.161766,-0.144111 -0.317336,-0.320246 z m 1.066937,-15.36525 c 0.133519,-0.02121 0.248766,-0.05657 0.256105,-0.07859 0.0073,-0.02202 0.04918,-0.03066 0.09298,-0.0192 0.0438,0.01145 0.107628,-0.0072 0.141834,-0.04137 0.03421,-0.03421 0.08456,-0.05474 0.111888,-0.04563 0.02733,0.0091 0.07703,-0.01077 0.110429,-0.04417 0.03341,-0.03341 0.08416,-0.05293 0.112796,-0.04338 0.02863,0.0095 0.08974,-0.01867 0.135802,-0.06271 0.04606,-0.04403 0.111902,-0.08625 0.146319,-0.09381 0.204084,-0.04483 0.762371,-0.519108 1.079463,-0.917027 0.26749,-0.335672 0.570987,-0.878795 0.529019,-0.946701 -0.01496,-0.0242 -0.0067,-0.044 0.01835,-0.044 0.05645,0 0.196809,-0.467982 0.158801,-0.529481 -0.01521,-0.02461 -0.0043,-0.04475 0.02427,-0.04475 0.03157,0 0.04365,-0.04329 0.03082,-0.11043 -0.01161,-0.06074 -0.0066,-0.110429 0.01124,-0.110429 0.01779,0 0.03235,-0.258405 0.03235,-0.574233 0,-0.315829 -0.01545,-0.574234 -0.03434,-0.574234 -0.01889,0 -0.02437,-0.03811 -0.01219,-0.08469 0.04412,-0.168712 -0.336329,-1.152668 -0.481536,-1.245401 -0.02327,-0.01486 -0.04022,-0.03992 -0.03765,-0.05568 0.01222,-0.07498 -0.156557,-0.318365 -0.406379,-0.586027 -0.295921,-0.317054 -0.773059,-0.690104 -0.83427,-0.652274 -0.0206,0.01273 -0.03745,0.0024 -0.03745,-0.02289 0,-0.06107 -0.433076,-0.2789369 -0.487546,-0.245273 -0.02338,0.01445 -0.04251,0.0068 -0.04251,-0.01695 0,-0.056281 -0.393995,-0.1865457 -0.613804,-0.2029397 -0.0943,-0.00703 -0.188579,-0.023183 -0.209503,-0.035888 -0.02092,-0.012705 -0.276571,-0.023337 -0.568105,-0.023627 -0.534044,-5.301e-4 -1.12638,0.091025 -1.12638,0.1741017 0,0.023781 -0.01713,0.032648 -0.03808,0.019705 -0.05054,-0.031232 -0.403641,0.1088602 -0.403641,0.1601422 0,0.02204 -0.01988,0.02779 -0.04417,0.01278 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01988,0.0371 -0.04417,0.02209 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01915,0.03755 -0.04256,0.02308 -0.02341,-0.01447 -0.08138,0.01252 -0.128834,0.05997 -0.04745,0.04745 -0.0974,0.07515 -0.111001,0.06155 -0.0136,-0.0136 -0.03722,0.0078 -0.05248,0.0476 -0.01526,0.03978 -0.0411,0.06408 -0.0574,0.054 -0.03277,-0.02025 -0.462299,0.323995 -0.491977,0.394291 -0.01026,0.02429 -0.07454,0.0912 -0.142856,0.148686 -0.248033,0.208705 -0.730279,0.974169 -0.672565,1.067553 0.0145,0.02346 0.0059,0.04266 -0.01914,0.04266 -0.05907,0 -0.241471,0.599428 -0.208527,0.685278 0.01385,0.0361 0.0044,0.06564 -0.02098,0.06564 -0.02539,0 -0.04169,0.0646 -0.03622,0.143558 0.0055,0.07896 -0.0042,0.213129 -0.02144,0.29816 -0.04741,0.233576 0.0511,1.055502 0.167516,1.397721 0.126048,0.370516 0.310099,0.740163 0.426484,0.856548 0.04776,0.04776 0.07554,0.08684 0.06174,0.08684 -0.0138,0 0.01516,0.05653 0.06436,0.125632 0.131301,0.184396 0.499365,0.587266 0.518785,0.567846 0.0092,-0.0092 0.09821,0.06081 0.197812,0.155562 0.09961,0.09475 0.190589,0.162786 0.202187,0.151188 0.0116,-0.0116 0.05991,0.01774 0.107361,0.06519 0.04745,0.04745 0.105426,0.07444 0.128834,0.05997 0.02341,-0.01447 0.04256,-0.0057 0.04256,0.01958 0,0.06106 0.344664,0.23496 0.399061,0.201341 0.02346,-0.0145 0.04266,-0.0059 0.04266,0.01914 0,0.05907 0.599429,0.241471 0.685279,0.208527 0.0361,-0.01385 0.06564,-0.0065 0.06564,0.01645 0,0.05196 1.079115,0.04833 1.413314,-0.0048 z\"></path>` +\r\n    '</svg>';\r\n\r\n  let src;\r\n  if (isIE) {\r\n    switch (markerColor) {\r\n      case 'blue' || [0, 161, 222] || '#00a1de':\r\n        iconColor = 'blue';\r\n        break;\r\n      case 'red' || '#f64139':\r\n        iconColor = 'red';\r\n        break;\r\n      case 'yellow' || '#ffd700':\r\n        iconColor = 'yellow';\r\n        break;\r\n      case 'green' || '#008000':\r\n        iconColor = 'green';\r\n        break;\r\n      default:\r\n        iconColor = 'blue';\r\n        break;\r\n    }\r\n    src = './assets/igo2/geo/icons/place_' + iconColor + '_36px.svg';\r\n  } else {\r\n    src = svg;\r\n  }\r\n\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: svg,\r\n      opacity,\r\n      imgSize: [36, 36], // for ie\r\n      anchor: [0.5, 0.92]\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { StyleByAttribute } from './vector-style.interface';\r\n\r\nimport { ClusterParam } from './clusterParam';\r\nimport { createOverlayMarkerStyle } from '../../overlay/shared/overlay-marker-style.utils';\r\nimport RenderFeature from 'ol/render/Feature';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleService {\r\n  public style: olstyle.Style;\r\n\r\n  createStyle(options: { [key: string]: any }) {\r\n    if (!options) {\r\n      return createOverlayMarkerStyle();\r\n    }\r\n    if (typeof options === 'function' || options instanceof olstyle.Style) {\r\n      return options;\r\n    }\r\n    return this.parseStyle('style', options);\r\n  }\r\n\r\n  private parseStyle(key: string, value: any) {\r\n    const styleOptions = {};\r\n    const olCls = this.getOlCls(key);\r\n\r\n    if (olCls && value instanceof Object) {\r\n      Object.keys(value).forEach(_key => {\r\n        const olKey = this.getOlKey(_key);\r\n        styleOptions[olKey] = this.parseStyle(_key, value[_key]);\r\n      });\r\n      return new olCls(styleOptions);\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  private getOlKey(key: any) {\r\n    let olKey;\r\n    switch (key.toLowerCase()) {\r\n      case 'circle':\r\n      case 'regularshape':\r\n      case 'icon':\r\n        olKey = 'image';\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return olKey || key;\r\n  }\r\n\r\n  private getOlCls(key: any) {\r\n    let olCls = olstyle[key.charAt(0).toUpperCase() + key.slice(1)];\r\n    if (key === 'regularshape') {\r\n      olCls = olstyle.RegularShape;\r\n    }\r\n    if (key === 'backgroundFill') {\r\n      olCls = olstyle.Fill;\r\n    }\r\n    if (key === 'backgroundStroke') {\r\n      olCls = olstyle.Stroke;\r\n    }\r\n\r\n    return olCls;\r\n  }\r\n\r\n  createStyleByAttribute(feature: RenderFeature | OlFeature<OlGeometry>, styleByAttribute: StyleByAttribute) {\r\n\r\n    let style;\r\n    const type = styleByAttribute.type ? styleByAttribute.type : this.guessTypeFeature(feature);\r\n    const attribute = styleByAttribute.attribute;\r\n    const data = styleByAttribute.data;\r\n    const stroke = styleByAttribute.stroke;\r\n    const width = styleByAttribute.width;\r\n    const fill = styleByAttribute.fill;\r\n    const anchor = styleByAttribute.anchor;\r\n    const radius = styleByAttribute.radius;\r\n    const icon = styleByAttribute.icon;\r\n    const scale = styleByAttribute.scale;\r\n    const size = data ? data.length : 0;\r\n    const label = styleByAttribute.label ? styleByAttribute.label.attribute : undefined;\r\n    let labelStyle = styleByAttribute.label?.style ? this.parseStyle('text', styleByAttribute.label.style) : undefined;\r\n    if (!labelStyle && label) {\r\n        labelStyle = new olstyle.Text();\r\n    }\r\n    const baseStyle = styleByAttribute.baseStyle;\r\n\r\n    if (labelStyle) {\r\n      labelStyle.setText(this.getLabel(feature, label));\r\n    }\r\n\r\n    if (type === 'circle') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n          typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          if (icon) {\r\n            style = [\r\n              new olstyle.Style({\r\n                image: new olstyle.Icon({\r\n                  color: fill ? fill[i] : undefined,\r\n                  src: icon[i],\r\n                  scale: scale ? scale[i] : 1,\r\n                  anchor: anchor ? anchor[i] : [0.5, 0.5]\r\n                }),\r\n                text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n              })\r\n            ];\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              image: new olstyle.Circle({\r\n                radius: radius ? radius[i] : 4,\r\n                stroke: new olstyle.Stroke({\r\n                  color: stroke ? stroke[i] : 'black',\r\n                  width: width ? width[i] : 1\r\n                }),\r\n                fill: new olstyle.Fill({\r\n                  color: fill ? fill[i] : 'black'\r\n                })\r\n              }),\r\n              text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (!(feature as OlFeature<OlGeometry>).getStyle()) {\r\n        if (baseStyle) {\r\n          style = this.createStyle(baseStyle);\r\n          if (labelStyle) {\r\n            style.setText(labelStyle);\r\n          }\r\n          return style;\r\n        }\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: 4,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n        return style;\r\n      }\r\n    } else if (type === 'regular') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n        typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: stroke ? stroke[i] : 'black',\r\n                width: width ? width[i] : 1\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: fill ? fill[i] : 'rgba(255,255,255,0.4)'\r\n              }),\r\n              text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (feature instanceof OlFeature) {\r\n        if (!feature.getStyle()) {\r\n          if (baseStyle) {\r\n            style = this.createStyle(baseStyle);\r\n            if (labelStyle) {\r\n              style.setText(labelStyle);\r\n            }\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  createClusterStyle(feature, clusterParam: ClusterParam = {}, layerStyle) {\r\n    let style;\r\n    const size = feature.get('features').length;\r\n    if (size !== 1) {\r\n      if (clusterParam.clusterRanges) {\r\n        for (const r of clusterParam.clusterRanges) {\r\n          if (\r\n            (!r.minRadius || r.minRadius <= size) &&\r\n            (!r.maxRadius || r.maxRadius >= size)\r\n          ) {\r\n            style = this.createStyle(r.style) as olstyle.Circle;\r\n\r\n            if (r.showRange) {\r\n              const text = new olstyle.Text({\r\n                text: size.toString(),\r\n                fill: new olstyle.Fill({\r\n                  color: '#fff'\r\n                })\r\n              });\r\n              style.setText(text);\r\n            }\r\n\r\n            if (r.dynamicRadius) {\r\n              let clusterRadius: number;\r\n              const radiusMin = style.getRadius();\r\n              clusterRadius = 5 * Math.log(size);\r\n              if (clusterRadius < radiusMin) {\r\n                clusterRadius = radiusMin;\r\n              }\r\n              style.image_.setRadius(clusterRadius);\r\n            }\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!style) {\r\n        let clusterRadius: number;\r\n        if (clusterParam.radiusCalc) {\r\n          clusterRadius = clusterParam.radiusCalc(size);\r\n        } else {\r\n          const radiusMin = 6;\r\n          clusterRadius = 5 * Math.log(size);\r\n          if (clusterRadius < radiusMin) {\r\n            clusterRadius = radiusMin;\r\n          }\r\n        }\r\n\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: clusterRadius,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: 'rgba(24, 134, 45, 0.5)'\r\n              })\r\n            }),\r\n            text: new olstyle.Text({\r\n              text: size.toString(),\r\n              fill: new olstyle.Fill({\r\n                color: '#fff'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n      }\r\n    } else {\r\n      style = this.createStyle(layerStyle);\r\n    }\r\n    return style;\r\n  }\r\n\r\n  getLabel(feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    if (!label) {\r\n      return;\r\n    }\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.get(v[1]));\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.get(labelMatch) || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  private guessTypeFeature(feature) {\r\n    switch (feature.getGeometry().getType()) {\r\n      case 'Point':\r\n      case 'MultiPoint':\r\n      case 'Circle':\r\n        return 'circle';\r\n      default:\r\n        return 'regular';\r\n    }\r\n  }\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { createOverlayMarkerStyle } from './overlay-marker-style.utils';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n/**\r\n * Create an overlay layer and it's source\r\n * @returns Overlay layer\r\n */\r\nexport function createOverlayLayer(): VectorLayer {\r\n  const overlayDataSource = new FeatureDataSource();\r\n  return new VectorLayer({\r\n    title: 'Overlay',\r\n    zIndex: 300,\r\n    source: overlayDataSource,\r\n    style: createOverlayLayerStyle()\r\n  });\r\n}\r\n\r\n/**\r\n * Create an overlay style with markers for points and a basic stroke/fill\r\n * combination for lines and polygons\r\n * @returns Style function\r\n */\r\nfunction createOverlayLayerStyle(): (olFeature: OlFeature<OlGeometry>) => olstyle.Style {\r\n  const defaultStyle = createOverlayDefaultStyle();\r\n  const markerStyle = createOverlayMarkerStyle();\r\n\r\n  let style;\r\n\r\n  return (olFeature: OlFeature<OlGeometry>) => {\r\n    if (olFeature.getId() === 'bufferFeature') {\r\n      style = createBufferStyle(\r\n        olFeature.get('bufferStroke'),\r\n        2,\r\n        olFeature.get('bufferFill'),\r\n        olFeature.get('bufferText')\r\n      );\r\n      return style;\r\n    } else {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle);\r\n      }\r\n      const geometryType = olFeature.getGeometry().getType();\r\n      style = geometryType === 'Point' ? markerStyle : defaultStyle;\r\n      style.getText().setText(olFeature.get('_mapTitle'));\r\n      return style;\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create a basic style for lines and polygons\r\n * @returns Style\r\n */\r\nexport function createOverlayDefaultStyle({\r\n  text,\r\n  strokeWidth = 2,\r\n  fillColor = [0, 161, 222, 0.3],\r\n  strokeColor = [0, 161, 222, 0.9],\r\n}: {\r\n  text?: string;\r\n  strokeWidth?: number;\r\n  fillColor?: string | number[];\r\n  strokeColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n  const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeWithOpacity\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillWithOpacity\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n\r\nfunction createBufferStyle(\r\n  strokeRGBA: [number, number, number, number] = [0, 161, 222, 1],\r\n  strokeWidth: number = 2,\r\n  fillRGBA: [number, number, number, number] = [0, 161, 222, 0.15],\r\n  bufferRadius?\r\n): olstyle.Style {\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeRGBA\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillRGBA\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      font: '12px Calibri,sans-serif',\r\n      text: bufferRadius,\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature/shared';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\nimport { createOverlayLayer } from './overlay.utils';\r\n\r\n/**\r\n * This class is simply a shortcut for adding features to a map.\r\n * It does nothing more than a standard layer but it's shipped with\r\n * a defautl style based on the geometry type of the features it contains.\r\n * @todo Enhance that by using a FeatureStore and strategies.\r\n */\r\nexport class Overlay {\r\n  /**\r\n   * The map to add the layer to\r\n   */\r\n  private map: IgoMap;\r\n\r\n  /**\r\n   * Overlay layer\r\n   */\r\n  private layer: VectorLayer;\r\n\r\n  /**\r\n   * Overlay layer's data source\r\n   */\r\n  get dataSource(): FeatureDataSource {\r\n    return this.layer.dataSource as FeatureDataSource;\r\n  }\r\n\r\n  constructor(map?: IgoMap) {\r\n    this.layer = createOverlayLayer();\r\n    this.setMap(map);\r\n  }\r\n\r\n  /**\r\n   * Bind this to a map and add the overlay layer to that map\r\n   * @param map Map\r\n   */\r\n  setMap(map: IgoMap) {\r\n    if (map === undefined) {\r\n      if (this.map !== undefined) {\r\n        this.map.ol.removeLayer(this.layer.ol);\r\n      }\r\n    } else {\r\n      map.ol.addLayer(this.layer.ol);\r\n    }\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Set the overlay features and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   * @param sourceId Optional: Remove features of certain sourceId (ex: 'Map' for query features)\r\n   */\r\n  setFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    sourceId?: string\r\n  ) {\r\n    if (sourceId) {\r\n      for (const olFeature of this.dataSource.ol.getFeatures()) {\r\n        if (olFeature.get('_sourceId') === sourceId) {\r\n          this.removeOlFeature(olFeature);\r\n        }\r\n      }\r\n    } else {\r\n      this.clear();\r\n    }\r\n    this.addFeatures(features, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the  overlay and, optionally, move to it\r\n   * @param feature Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeature(feature: Feature, motion: FeatureMotion = FeatureMotion.Default) {\r\n    this.addFeatures([feature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add features to the  overlay and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    const olFeatures = [];\r\n    features.forEach((feature: Feature) => {\r\n      const olFeature = featureToOl(feature, this.map.projection);\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry === null) {\r\n        return;\r\n      }\r\n      olFeatures.push(olFeature);\r\n    });\r\n\r\n    this.addOlFeatures(olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a OpenLayers feature to the  overlay and, optionally, move to it\r\n   * @param olFeature OpenLayers Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeature(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.addOlFeatures([olFeature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add OpenLayers features to the overlay and, optionally, move to them\r\n   * @param olFeatures OpenLayers Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.dataSource.ol.addFeatures(olFeatures);\r\n    moveToOlFeatures(this.map, olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Remove a feature from the overlay\r\n   * @param feature Feature\r\n   */\r\n  removeFeature(feature: Feature) {\r\n    this.removeFeatures([feature]);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the overlay\r\n   * @param features Features\r\n   */\r\n  removeFeatures(features: Feature[]) {\r\n    features.forEach((feature: Feature) => {\r\n      if (feature.meta) {\r\n        if (this.dataSource.ol.getFeatureById(feature.meta.id)) {\r\n          this.removeOlFeature(this.dataSource.ol.getFeatureById(feature.meta.id));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove an OpenLayers feature from the overlay\r\n   * @param olFeature OpenLayers Feature\r\n   */\r\n  removeOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n    this.dataSource.ol.removeFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.dataSource.ol.clear();\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { Layer } from '../../layer/shared/layers';\r\n\r\nexport class LayerWatcher extends Watcher {\r\n  private loaded = 0;\r\n  private loading = 0;\r\n  private layers: Layer[] = [];\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  watch() {}\r\n\r\n  unwatch() {\r\n    this.layers.forEach(layer => this.unwatchLayer(layer), this);\r\n  }\r\n\r\n  watchLayer(layer: Layer) {\r\n    if (layer.status$ === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.layers.push(layer);\r\n\r\n    const layer$$ = layer.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe(status => {\r\n        if (status === SubjectStatus.Error) {\r\n          this.loading = 0;\r\n          this.loaded = -1;\r\n        }\r\n        if (status === SubjectStatus.Working) {\r\n          this.loading += 1;\r\n        } else if (status === SubjectStatus.Done) {\r\n          this.loaded += 1;\r\n        }\r\n\r\n        if (this.loaded >= this.loading) {\r\n          this.loading = this.loaded = 0;\r\n          this.status = SubjectStatus.Done;\r\n        } else if (this.loading > 0) {\r\n          this.status = SubjectStatus.Working;\r\n        }\r\n      });\r\n\r\n    this.subscriptions.push(layer$$);\r\n  }\r\n\r\n  unwatchLayer(layer: Layer) {\r\n    layer.status$.next(SubjectStatus.Done);\r\n    const index = this.layers.indexOf(layer);\r\n    if (index >= 0) {\r\n      const status = (layer as any).watcher.status;\r\n      if (\r\n        [SubjectStatus.Working, SubjectStatus.Waiting].indexOf(status) !== -1\r\n      ) {\r\n        this.loaded += 1;\r\n      }\r\n      this.subscriptions[index].unsubscribe();\r\n      this.subscriptions.splice(index, 1);\r\n      this.layers.splice(index, 1);\r\n      (layer as any).watcher.unwatch();\r\n    }\r\n  }\r\n}\r\n","export enum MapViewAction {\r\n  Move,\r\n  Zoom\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * Base map controller\r\n */\r\nexport class MapController {\r\n\r\n  /**\r\n   * OL Map\r\n   */\r\n  protected olMap: OlMap;\r\n\r\n  /**\r\n   * Array of observer keys\r\n   */\r\n  protected observerKeys: EventsKey[] = [];\r\n\r\n  /**\r\n   * Return the OL map this controller is bound to\r\n   * @returns OL Map\r\n   */\r\n  getOlMap(): OlMap {\r\n    return this.olMap;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap !== undefined && this.getOlMap() !== undefined) {\r\n      throw new Error('This controller is already bound to a map.');\r\n    }\r\n\r\n    if (olMap === undefined) {\r\n      this.teardownObservers();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    this.observerKeys.forEach((key: EventsKey) => unByKey(key));\r\n    this.observerKeys = [];\r\n  }\r\n\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlMapEvent from 'ol/MapEvent';\r\n\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport * as oleasing from 'ol/easing';\r\nimport * as olproj from 'ol/proj';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport OlView from 'ol/View';\r\n\r\nimport { MapViewAction } from '../map.enums';\r\nimport { MapExtent, MapViewState } from '../map.interface';\r\nimport { getScaleFromResolution, viewStatesAreEqual } from '../map.utils';\r\nimport { MapController } from './controller';\r\nimport { EventsKey } from 'ol/events';\r\n\r\nexport interface MapViewControllerOptions {\r\n  stateHistory: boolean;\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapViewController extends MapController {\r\n  /**\r\n   * Observable of the current resolution\r\n   */\r\n  resolution$ = new BehaviorSubject<number>(undefined);\r\n\r\n  /**\r\n   * Observable of the current state\r\n   */\r\n  state$ = new BehaviorSubject<MapViewState>(undefined);\r\n\r\n  /**\r\n   * View Padding\r\n   */\r\n  padding = [0, 0, 0, 0];\r\n\r\n  /**\r\n   * Max zoom after set extent\r\n   */\r\n  maxZoomOnExtent = 19;\r\n\r\n  /**\r\n   * Max extent possible when zooming\r\n   */\r\n  maxLayerZoomExtent: MapExtent;\r\n\r\n  /**\r\n   * Extent stream\r\n   */\r\n  private extent$ = new Subject<{ extent: MapExtent; action: MapViewAction }>();\r\n\r\n  /**\r\n   * Subscription to the movement stream\r\n   */\r\n  private extent$$: Subscription;\r\n\r\n  /**\r\n   * History of states\r\n   */\r\n  private states: MapViewState[] = [];\r\n\r\n  /**\r\n   * Current state index\r\n   */\r\n  private stateIndex: number = 0;\r\n\r\n  /**\r\n   * Whether the view controller should keep the view's state history\r\n   */\r\n  get stateHistory(): boolean {\r\n    return this.options ? this.options.stateHistory === true : false;\r\n  }\r\n\r\n  /**\r\n   * OL View\r\n   */\r\n  get olView(): OlView {\r\n    return this.olMap.getView();\r\n  }\r\n\r\n  constructor(private options?: MapViewControllerOptions) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  /**\r\n   * Observe move moveend and subscribe to the extent stream\r\n   */\r\n  setupObservers() {\r\n    if (this.stateHistory === true) {\r\n      this.observerKeys.push(\r\n        this.olMap.on('moveend', (event: OlMapEvent) => this.onMoveEnd(event)) as EventsKey\r\n      );\r\n    }\r\n\r\n    this.extent$$ = this.extent$\r\n      .pipe(debounceTime(25))\r\n      .subscribe((value: { extent: MapExtent; action: MapViewAction }) => {\r\n        this.setExtent(value.extent, value.action);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    super.teardownObservers();\r\n    if (this.extent$$ !== undefined) {\r\n      this.extent$$.unsubscribe();\r\n      this.extent$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the view's OL projection\r\n   * @returns OL projection\r\n   */\r\n  getOlProjection(): OlProjection {\r\n    return this.olView.getProjection();\r\n  }\r\n\r\n  /**\r\n   * Get the current map view center\r\n   * @param projection Output projection\r\n   * @returns Center\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    let center = this.olView.getCenter() as [number, number];\r\n    if (projection && center) {\r\n      center = olproj.transform(center, this.getOlProjection(), projection) as [number, number];\r\n    }\r\n    return center;\r\n  }\r\n\r\n  /**\r\n   * Get the current view extent\r\n   * @param projection Output projection\r\n   * @returns Extent\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    let extent = this.olView.calculateExtent(this.olMap.getSize());\r\n    if (projection && extent) {\r\n      extent = olproj.transformExtent(\r\n        extent,\r\n        this.getOlProjection(),\r\n        projection\r\n      );\r\n    }\r\n    return extent as [number, number, number, number];\r\n  }\r\n\r\n  /**\r\n   * Get the current scale\r\n   * @param dpi Dot per inches\r\n   * @returns View scale\r\n   */\r\n  getScale(dpi = 96) {\r\n    return getScaleFromResolution(\r\n      this.getResolution(),\r\n      this.getOlProjection().getUnits(),\r\n      dpi\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the current resolution\r\n   * @returns Projection denominator\r\n   */\r\n  getResolution(): number {\r\n    return this.olView.getResolution();\r\n  }\r\n\r\n  /**\r\n   * Get the current zoom level\r\n   * @returns Zoom level\r\n   */\r\n  getZoom(): number {\r\n    return Math.round(this.olView.getZoom());\r\n  }\r\n\r\n  /**\r\n   * Zoom in\r\n   */\r\n  zoomIn() {\r\n    this.zoomTo(this.olView.getZoom() + 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom out\r\n   */\r\n  zoomOut() {\r\n    this.zoomTo(this.olView.getZoom() - 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom to specific zoom level\r\n   * @param zoom Zoom level\r\n   */\r\n  zoomTo(zoom: number) {\r\n    this.olView.cancelAnimations();\r\n    this.olView.animate({\r\n      zoom,\r\n      duration: 250,\r\n      easing: oleasing.easeOut\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Move to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to move to\r\n   */\r\n  moveToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Move });\r\n  }\r\n\r\n  /**\r\n   * Zoom to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to zoom to\r\n   */\r\n  zoomToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Zoom });\r\n  }\r\n\r\n  /**\r\n   * Return the current view rotation\r\n   * @returns Rotation angle in degrees\r\n   */\r\n  getRotation(): number {\r\n    return this.olView.getRotation();\r\n  }\r\n\r\n  /**\r\n   * Reset the view rotation to 0\r\n   */\r\n  resetRotation() {\r\n    this.olView.animate({ rotation: 0 });\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a previous state\r\n   * @returns True if the view has a previous state\r\n   */\r\n  hasPreviousState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a next state\r\n   * @returns True if the view has a next state\r\n   */\r\n  hasNextState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Restore the previous view state\r\n   */\r\n  previousState() {\r\n    if (this.hasPreviousState()) {\r\n      this.setStateIndex(this.stateIndex - 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restore the next view state\r\n   */\r\n  nextState() {\r\n    if (this.hasNextState()) {\r\n      this.setStateIndex(this.stateIndex + 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the state history\r\n   */\r\n  clearStateHistory() {\r\n    this.states = [];\r\n    this.stateIndex = 0;\r\n  }\r\n\r\n  /**\r\n   * Update the the view to it's intial state\r\n   */\r\n  setInitialState() {\r\n    if (this.states.length > 0) {\r\n      this.setStateIndex(0);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Move to the extent retrieved from the stream\r\n   * @param extent Extent\r\n   * @param action Either zoom or move\r\n   * @param animation With or without animation to the target extent.\r\n   */\r\n  private setExtent(\r\n    extent: MapExtent,\r\n    action: MapViewAction,\r\n    animation: boolean = true\r\n  ) {\r\n    const olView = this.olView;\r\n    olView.cancelAnimations();\r\n    const duration = animation ? 500 : 0;\r\n    const zoom = olView.getZoom();\r\n\r\n    const fromCenter = olView.getCenter();\r\n    const toCenter = [\r\n      extent[0] + (extent[2] - extent[0]) / 2,\r\n      extent[1] + (extent[3] - extent[1]) / 2\r\n    ];\r\n    const distCenter = Math.sqrt(\r\n      Math.pow(fromCenter[0] - toCenter[0], 2) +\r\n        Math.pow(fromCenter[1] - toCenter[1], 2)\r\n    );\r\n    const fromExtent = olView.calculateExtent();\r\n    const fromSize = Math.sqrt(\r\n      Math.pow(fromExtent[2] - fromExtent[0], 2) +\r\n        Math.pow(fromExtent[3] - fromExtent[1], 2)\r\n    );\r\n    const toSize = Math.sqrt(\r\n      Math.pow(extent[2] - extent[0], 2) + Math.pow(extent[3] - extent[1], 2)\r\n    );\r\n    const moySize = (toSize + fromSize) / 2;\r\n    const xSize = distCenter / moySize;\r\n\r\n    const maxZoom =\r\n      action === MapViewAction.Move || zoom > this.maxZoomOnExtent\r\n        ? zoom\r\n        : this.maxZoomOnExtent;\r\n\r\n    olView.fit(extent, {\r\n      size: this.olMap.getSize(),\r\n      maxZoom,\r\n      padding: this.padding,\r\n      duration: xSize > 4 ? 0 : duration,\r\n      callback: (isFinished: boolean) => {\r\n        if (!isFinished) {\r\n          olView.fit(extent, {\r\n            size: this.olMap.getSize(),\r\n            maxZoom,\r\n            padding: this.padding,\r\n            duration: xSize > 4 ? 0 : duration\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set the view state index\r\n   * @param index State index\r\n   */\r\n  private setStateIndex(index: number) {\r\n    this.stateIndex = index;\r\n    this.setState(this.states[index]);\r\n  }\r\n\r\n  /**\r\n   * Set the view state\r\n   * @param state View state\r\n   */\r\n  private setState(state: MapViewState) {\r\n    this.olView.animate({\r\n      resolution: state.resolution,\r\n      center: state.center,\r\n      duration: 0\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On move end, get the view state and record it.\r\n   * @param event Map event\r\n   */\r\n  private onMoveEnd(event: OlMapEvent) {\r\n    const resolution = this.getResolution();\r\n    if (this.resolution$.value !== resolution) {\r\n      this.resolution$.next(resolution);\r\n    }\r\n\r\n    const state = {\r\n      resolution,\r\n      center: this.getCenter(),\r\n      zoom: this.getZoom()\r\n    };\r\n\r\n    if (this.stateHistory === true) {\r\n      const stateIndex = this.stateIndex;\r\n      const stateAtIndex =\r\n        this.states.length === 0 ? undefined : this.states[stateIndex];\r\n      if (!viewStatesAreEqual(state, stateAtIndex)) {\r\n        this.states = this.states.slice(0, stateIndex + 1).concat([state]);\r\n        this.stateIndex = this.states.length - 1;\r\n      }\r\n    }\r\n\r\n    this.state$.next(state);\r\n  }\r\n}\r\n","import olMap from 'ol/Map';\r\nimport olView from 'ol/View';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport olGeolocation from 'ol/Geolocation';\r\nimport olControlAttribution from 'ol/control/Attribution';\r\nimport olControlScaleLine from 'ol/control/ScaleLine';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\nimport olPoint from 'ol/geom/Point';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport * as olinteraction from 'ol/interaction';\r\nimport olCircle from 'ol/geom/Circle';\r\nimport * as olstyle from 'ol/style';\r\n\r\nimport proj4 from 'proj4';\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { Layer } from '../../layer/shared/layers';\r\nimport { Overlay } from '../../overlay/shared/overlay';\r\n\r\nimport { LayerWatcher } from '../utils/layer-watcher';\r\nimport {\r\n  MapViewOptions,\r\n  MapOptions,\r\n  MapAttributionOptions,\r\n  MapScaleLineOptions,\r\n  MapExtent,\r\n  MapControlsOptions\r\n} from './map.interface';\r\nimport { MapViewController } from './controllers/view';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureMotion } from '../../feature/shared/feature.enums';\r\n\r\n// TODO: This class is messy. Clearly define it's scope and the map browser's.\r\n// Move some stuff into controllers.\r\nexport class IgoMap {\r\n  public ol: olMap;\r\n  public offlineButtonToggle$ = new BehaviorSubject<boolean>(false);\r\n  public layers$ = new BehaviorSubject<Layer[]>([]);\r\n  public status$: Subject<SubjectStatus>;\r\n  public alwaysTracking: boolean;\r\n  public positionFollower: boolean = true;\r\n  public geolocation$ = new BehaviorSubject<olGeolocation>(undefined);\r\n  public geolocationPositionFeature: olFeature<OlGeometry>;\r\n  public geolocationAccuracyFeature: olFeature<OlGeometry>;\r\n  public bufferGeom: olCircle;\r\n  public bufferFeature: olFeature<OlGeometry>;\r\n  public buffer: Overlay;\r\n  public overlay: Overlay;\r\n  public queryResultsOverlay: Overlay;\r\n  public searchResultsOverlay: Overlay;\r\n  public viewController: MapViewController;\r\n  public swipeEnabled$ = new BehaviorSubject<boolean>(false);\r\n  public mapCenter$ = new BehaviorSubject<boolean>(false);\r\n  public selectedFeatures$ = new BehaviorSubject<Layer[]>(null);\r\n\r\n  public bufferDataSource: FeatureDataSource;\r\n\r\n  private layerWatcher: LayerWatcher;\r\n  private geolocation: olGeolocation;\r\n  private geolocation$$: Subscription;\r\n\r\n  private options: MapOptions;\r\n  private defaultOptions: Partial<MapOptions> = {\r\n    controls: { attribution: false }\r\n  };\r\n\r\n  get layers(): Layer[] {\r\n    return this.layers$.value;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.viewController.getOlProjection().getCode();\r\n  }\r\n\r\n  constructor(options?: MapOptions) {\r\n    this.options = Object.assign({}, this.defaultOptions, options);\r\n    this.layerWatcher = new LayerWatcher();\r\n    this.status$ = this.layerWatcher.status$;\r\n    olproj4.register(proj4);\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    const controls = [];\r\n    if (this.options.controls) {\r\n      if (this.options.controls.attribution) {\r\n        const attributionOpt = (this.options.controls.attribution === true\r\n          ? {}\r\n          : this.options.controls.attribution) as MapAttributionOptions;\r\n        controls.push(new olControlAttribution(attributionOpt));\r\n      }\r\n      if (this.options.controls.scaleLine) {\r\n        const scaleLineOpt = (this.options.controls.scaleLine === true\r\n          ? {}\r\n          : this.options.controls.scaleLine) as MapScaleLineOptions;\r\n        controls.push(new olControlScaleLine(scaleLineOpt));\r\n      }\r\n    }\r\n    let interactions = {};\r\n    if (this.options.interactions === false) {\r\n      interactions = {\r\n        altShiftDragRotate: false,\r\n        doubleClickZoom: false,\r\n        keyboard: false,\r\n        mouseWheelZoom: false,\r\n        shiftDragZoom: false,\r\n        dragPan: false,\r\n        pinchRotate: false,\r\n        pinchZoom: false\r\n      };\r\n    }\r\n\r\n    this.ol = new olMap({\r\n      interactions: olinteraction.defaults(interactions),\r\n      controls\r\n    });\r\n\r\n    this.setView(this.options.view || {});\r\n    this.viewController = new MapViewController({\r\n      stateHistory: true\r\n    });\r\n    this.viewController.setOlMap(this.ol);\r\n    this.overlay = new Overlay(this);\r\n    this.queryResultsOverlay = new Overlay(this);\r\n    this.searchResultsOverlay = new Overlay(this);\r\n    this.buffer = new Overlay(this);\r\n  }\r\n\r\n  setTarget(id: string) {\r\n    this.ol.setTarget(id);\r\n    if (id !== undefined) {\r\n      this.layerWatcher.subscribe(() => { }, null);\r\n    } else {\r\n      this.layerWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  updateView(options: MapViewOptions) {\r\n    const currentView = this.ol.getView();\r\n    const viewOptions = Object.assign(\r\n      {\r\n        zoom: currentView.getZoom()\r\n      },\r\n      currentView.getProperties()\r\n    );\r\n\r\n    this.setView(Object.assign(viewOptions, options));\r\n    if (options.maxZoomOnExtent) {\r\n      this.viewController.maxZoomOnExtent = options.maxZoomOnExtent;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the map view\r\n   * @param options Map view options\r\n   */\r\n  setView(options: MapViewOptions) {\r\n    if (this.viewController !== undefined) {\r\n      this.viewController.clearStateHistory();\r\n    }\r\n\r\n    options = Object.assign({ constrainResolution: true }, options);\r\n    const view = new olView(options);\r\n    this.ol.setView(view);\r\n\r\n    this.unsubscribeGeolocate();\r\n    if (options) {\r\n      if (options.maxLayerZoomExtent) {\r\n        this.viewController.maxLayerZoomExtent = options.maxLayerZoomExtent;\r\n      }\r\n\r\n      if (options.center) {\r\n        const projection = view.getProjection().getCode();\r\n        const center = olproj.fromLonLat(options.center, projection);\r\n        view.setCenter(center);\r\n      }\r\n\r\n      if (options.geolocate) {\r\n        this.geolocate(true);\r\n      }\r\n\r\n      if (options.alwaysTracking) {\r\n        this.alwaysTracking = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  updateControls(value: MapControlsOptions) {\r\n    if (value === undefined) {\r\n      return;\r\n    }\r\n\r\n    const controls = [];\r\n    if (value.attribution) {\r\n      const attributionOpt = (value.attribution === true\r\n        ? {}\r\n        : value.attribution) as MapAttributionOptions;\r\n      controls.push(new olControlAttribution(attributionOpt));\r\n    }\r\n    if (value.scaleLine) {\r\n      const scaleLineOpt = (value.scaleLine === true\r\n        ? {}\r\n        : value.scaleLine) as MapScaleLineOptions;\r\n      controls.push(new olControlScaleLine(scaleLineOpt));\r\n    }\r\n\r\n    const currentControls = Object.assign([], this.ol.getControls().getArray());\r\n    currentControls.forEach(control => {\r\n      this.ol.removeControl(control);\r\n    });\r\n    controls.forEach(control => {\r\n      this.ol.addControl(control);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    return this.viewController.getCenter(projection);\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    return this.viewController.getExtent(projection);\r\n  }\r\n\r\n  // TODO: Move to ViewController and update every place it's used\r\n  getZoom(): number {\r\n    return this.viewController.getZoom();\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (!baseLayer) {\r\n      return;\r\n    }\r\n\r\n    for (const bl of this.getBaseLayers()) {\r\n      bl.visible = false;\r\n    }\r\n\r\n    baseLayer.visible = true;\r\n\r\n    this.viewController.olView.setMinZoom(\r\n      baseLayer.dataSource.options.minZoom || (this.options.view || {}).minZoom\r\n    );\r\n    this.viewController.olView.setMaxZoom(\r\n      baseLayer.dataSource.options.maxZoom || (this.options.view || {}).maxZoom\r\n    );\r\n  }\r\n\r\n  getBaseLayers(): Layer[] {\r\n    return this.layers.filter((layer: Layer) => layer.baseLayer === true);\r\n  }\r\n\r\n  getLayerById(id: string): Layer {\r\n    return this.layers.find((layer: Layer) => layer.id && layer.id === id);\r\n  }\r\n\r\n  getLayerByAlias(alias: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => layer.alias && layer.alias === alias\r\n    );\r\n  }\r\n\r\n  getLayerByOlUId(olUId: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => (layer.ol as any).ol_uid && (layer.ol as any).ol_uid === olUId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Add a single layer\r\n   * @param layer Layer to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayer(layer: Layer, push = true) {\r\n    this.addLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add many layers\r\n   * @param layers Layers to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayers(layers: Layer[], push = true) {\r\n    let offsetZIndex = 0;\r\n    let offsetBaseLayerZIndex = 0;\r\n    const addedLayers = layers\r\n      .map((layer: Layer) => {\r\n        if (!layer) { return; }\r\n        const offset = layer.zIndex\r\n          ? 0\r\n          : layer.baseLayer\r\n            ? offsetBaseLayerZIndex++\r\n            : offsetZIndex++;\r\n        return this.doAddLayer(layer, offset);\r\n      })\r\n      .filter((layer: Layer | undefined) => layer !== undefined);\r\n    this.setLayers([].concat(this.layers, addedLayers));\r\n  }\r\n\r\n  /**\r\n   * Remove a single layer\r\n   * @param layer Layer to remove\r\n   */\r\n  removeLayer(layer: Layer) {\r\n    this.removeLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove many layers\r\n   * @param layers Layers to remove\r\n   */\r\n  removeLayers(layers: Layer[]) {\r\n    const newLayers = this.layers$.value.slice(0);\r\n    const layersToRemove = [];\r\n    layers.forEach((layer: Layer) => {\r\n      const index = newLayers.indexOf(layer);\r\n      if (index >= 0) {\r\n        layersToRemove.push(layer);\r\n        newLayers.splice(index, 1);\r\n        this.handleLinkedLayersDeletion(layer, layersToRemove);\r\n        layersToRemove.map(linkedLayer => {\r\n          layersToRemove.push(linkedLayer);\r\n          const linkedIndex = newLayers.indexOf(linkedLayer);\r\n          if (linkedIndex >= 0) {\r\n            newLayers.splice(linkedIndex, 1);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    layersToRemove.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.setLayers(newLayers);\r\n  }\r\n\r\n  /**\r\n   * Build a list of linked layers to delete\r\n   * @param srcLayer Layer that has triggered the deletion\r\n   * @param layersToRemove list to append the layer to delete into\r\n   */\r\n  handleLinkedLayersDeletion(srcLayer: Layer, layersToRemove: Layer[]) {\r\n    const linkedLayers = srcLayer.options.linkedLayers;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n    if (isParentLayer) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        if (!link.syncedDelete) {\r\n          return;\r\n        }\r\n        link.linkedIds.map(linkedId => {\r\n          const layerToApply = this.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n          if (layerToApply) {\r\n            layersToRemove.push(layerToApply);\r\n          }\r\n        });\r\n      });\r\n    } else {\r\n      // search for parent layer\r\n      this.layers.map(layer => {\r\n        if (layer.options.linkedLayers?.links) {\r\n          layer.options.linkedLayers.links.map(l => {\r\n            if (\r\n              l.syncedDelete && l.bidirectionnal !== false &&\r\n              l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n              layersToRemove.push(layer);\r\n              this.handleLinkedLayersDeletion(layer, layersToRemove);\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all layers\r\n   */\r\n  removeAllLayers() {\r\n    this.layers.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.layers$.next([]);\r\n  }\r\n\r\n  raiseLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index > 1) {\r\n      this.moveLayer(layer, index, index - 1);\r\n    }\r\n  }\r\n\r\n  raiseLayers(layers: Layer[]) {\r\n    for (const layer of layers) {\r\n      this.raiseLayer(layer);\r\n    }\r\n  }\r\n\r\n  lowerLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index < this.layers.length - 1) {\r\n      this.moveLayer(layer, index, index + 1);\r\n    }\r\n  }\r\n\r\n  lowerLayers(layers: Layer[]) {\r\n    const reverseLayers = layers.reverse();\r\n    for (const layer of reverseLayers) {\r\n      this.lowerLayer(layer);\r\n    }\r\n  }\r\n\r\n  moveLayer(layer: Layer, from: number, to: number) {\r\n    const layerTo = this.layers[to];\r\n    const zIndexTo = layerTo.zIndex;\r\n    const zIndexFrom = layer.zIndex;\r\n\r\n    if (layerTo.baseLayer || layer.baseLayer) {\r\n      return;\r\n    }\r\n\r\n    layer.zIndex = zIndexTo;\r\n    layerTo.zIndex = zIndexFrom;\r\n\r\n    this.layers[to] = layer;\r\n    this.layers[from] = layerTo;\r\n    this.layers$.next(this.layers.slice(0));\r\n  }\r\n\r\n  /**\r\n   * Add a layer to the OL map and start watching. If the layer is already\r\n   * added to this map, make it visible but don't add it one again.\r\n   * @param layer Layer\r\n   * @returns The layer added, if any\r\n   */\r\n  private doAddLayer(layer: Layer, offsetZIndex: number) {\r\n    if (layer.baseLayer && layer.visible) {\r\n      this.changeBaseLayer(layer);\r\n    }\r\n\r\n    const existingLayer = this.getLayerById(layer.id);\r\n    if (existingLayer !== undefined) {\r\n      existingLayer.visible = true;\r\n      return;\r\n    }\r\n\r\n    if (!layer.baseLayer && layer.zIndex) {\r\n      layer.zIndex += 10;\r\n    }\r\n\r\n    if (layer.zIndex === undefined || layer.zIndex === 0) {\r\n      const maxZIndex = Math.max(\r\n        layer.baseLayer ? 0 : 10,\r\n        ...this.layers\r\n          .filter(\r\n            (l) => l.baseLayer === layer.baseLayer && l.zIndex < 200 // zIndex > 200 = system layer\r\n          )\r\n          .map((l) => l.zIndex)\r\n      );\r\n      layer.zIndex = maxZIndex + 1 + offsetZIndex;\r\n    }\r\n\r\n    if (layer.baseLayer && layer.zIndex > 9) {\r\n      layer.zIndex = 10; // baselayer must have zIndex < 10\r\n    }\r\n\r\n    layer.setMap(this);\r\n    this.layerWatcher.watchLayer(layer);\r\n    this.ol.addLayer(layer.ol);\r\n\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a layer from the OL map and stop watching\r\n   * @param layer Layer\r\n   */\r\n  private doRemoveLayer(layer: Layer) {\r\n    this.layerWatcher.unwatchLayer(layer);\r\n    this.ol.removeLayer(layer.ol);\r\n    layer.setMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Update the layers observable\r\n   * @param layers Layers\r\n   */\r\n  private setLayers(layers: Layer[]) {\r\n    this.layers$.next(this.sortLayersByZIndex(layers).slice(0));\r\n  }\r\n\r\n  /**\r\n   * Sort layers by descending zIndex\r\n   * @param layers Array of layers\r\n   * @returns The original array, sorted by zIndex\r\n   */\r\n  private sortLayersByZIndex(layers: Layer[]) {\r\n    // Sort by descending zIndex\r\n    return layers.sort(\r\n      (layer1: Layer, layer2: Layer) => layer2.zIndex - layer1.zIndex\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get layer index in the map's inenr array of layers\r\n   * @param layer Layer\r\n   * @returns The layer index\r\n   */\r\n  private getLayerIndex(layer: Layer) {\r\n    return this.layers.findIndex((_layer: Layer) => _layer === layer);\r\n  }\r\n\r\n  // TODO: Create a GeolocationController with everything below\r\n  geolocate(track = false) {\r\n    let first = true;\r\n    if (this.geolocation$$) {\r\n      track = this.geolocation.getTracking();\r\n      this.unsubscribeGeolocate();\r\n    }\r\n    this.startGeolocation();\r\n\r\n    this.geolocation$$ = this.geolocation$.subscribe((geolocation) => {\r\n      if (!geolocation) {\r\n        return;\r\n      }\r\n      const accuracy = geolocation.getAccuracy();\r\n      const coordinates = geolocation.getPosition();\r\n      if (accuracy < 10000) {\r\n        const positionGeometry = coordinates ? new olPoint(coordinates) : null;\r\n\r\n        const accuracyGeometry = geolocation.getAccuracyGeometry();\r\n        const accuracyExtent = accuracyGeometry.getExtent();\r\n\r\n        [this.geolocationPositionFeature, this.geolocationAccuracyFeature].map(feature => {\r\n          if (feature && this.overlay.dataSource.ol.getFeatureById(feature.getId())) {\r\n            this.overlay.dataSource.ol.removeFeature(feature);\r\n          }\r\n        });\r\n\r\n        if (this.bufferFeature) {\r\n          this.buffer.dataSource.ol.removeFeature(this.bufferFeature);\r\n        }\r\n\r\n        this.geolocationPositionFeature = new olFeature({ geometry: positionGeometry });\r\n        this.geolocationPositionFeature.setId('geolocationPositionFeature');\r\n\r\n        this.geolocationPositionFeature.setStyle(\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: 6,\r\n              fill: new olstyle.Fill({\r\n                color: '#3399CC',\r\n              }),\r\n              stroke: new olstyle.Stroke({\r\n                color: '#fff',\r\n                width: 2,\r\n              }),\r\n            }),\r\n          })\r\n        );\r\n\r\n\r\n        this.geolocationAccuracyFeature = new olFeature({ geometry: accuracyGeometry });\r\n        this.geolocationAccuracyFeature.setId('geolocationAccuracyFeature');\r\n        if (this.alwaysTracking) {\r\n          [this.geolocationPositionFeature, this.geolocationAccuracyFeature].map(feature => {\r\n            this.overlay.addOlFeature(\r\n              feature,\r\n              this.positionFollower ? FeatureMotion.Move : FeatureMotion.None\r\n            );\r\n          });\r\n\r\n        } else {\r\n          [this.geolocationPositionFeature, this.geolocationAccuracyFeature].map(feature => {\r\n            this.overlay.addOlFeature(\r\n              feature\r\n            );\r\n          });\r\n        }\r\n\r\n        if (this.ol.getView().get('options_')?.buffer) {\r\n          const bufferRadius = this.ol.getView().get('options_').buffer.bufferRadius;\r\n          this.bufferGeom = new olCircle(coordinates, bufferRadius);\r\n          const bufferStroke = this.ol.getView().get('options_').buffer.bufferStroke;\r\n          const bufferFill = this.ol.getView().get('options_').buffer.bufferFill;\r\n\r\n          let bufferText;\r\n          if (this.ol.getView().get('options_').buffer.showBufferRadius) {\r\n            bufferText = bufferRadius.toString() + 'm';\r\n          } else {\r\n            bufferText = '';\r\n          }\r\n\r\n          this.bufferFeature = new olFeature(this.bufferGeom);\r\n          this.bufferFeature.setId('bufferFeature');\r\n          this.bufferFeature.set('bufferStroke', bufferStroke);\r\n          this.bufferFeature.set('bufferFill', bufferFill);\r\n          this.bufferFeature.set('bufferText', bufferText);\r\n          this.buffer.addOlFeature(this.bufferFeature, FeatureMotion.None);\r\n        }\r\n        if (first) {\r\n          this.viewController.zoomToExtent(accuracyExtent as [number, number, number, number]);\r\n          this.positionFollower = !this.positionFollower;\r\n        }\r\n      } else if (first) {\r\n        const view = this.ol.getView();\r\n        view.setCenter(coordinates);\r\n        view.setZoom(14);\r\n      }\r\n      if (track !== true && this.alwaysTracking !== true) {\r\n        this.unsubscribeGeolocate();\r\n      }\r\n      first = false;\r\n    });\r\n  }\r\n\r\n  unsubscribeGeolocate() {\r\n    this.stopGeolocation();\r\n    if (this.geolocation$$) {\r\n      this.geolocation$$.unsubscribe();\r\n      this.geolocation$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private startGeolocation() {\r\n    if (!this.geolocation) {\r\n      this.geolocation = new olGeolocation({\r\n        trackingOptions: {\r\n          enableHighAccuracy: true\r\n        },\r\n        projection: this.projection,\r\n        tracking: true\r\n      });\r\n\r\n      this.geolocation.on('change', (evt) => {\r\n        this.geolocation$.next(this.geolocation);\r\n      });\r\n    } else {\r\n      this.geolocation.setTracking(true);\r\n    }\r\n  }\r\n\r\n  private stopGeolocation() {\r\n    if (this.geolocation) {\r\n      this.geolocation.setTracking(false);\r\n    }\r\n  }\r\n\r\n  onOfflineToggle(offline: boolean) {\r\n    this.offlineButtonToggle$.next(offline);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  AfterViewInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { ActivityService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapControlsOptions, MapViewOptions } from '../shared/map.interface';\r\n\r\n@Component({\r\n  selector: 'igo-map-browser',\r\n  templateUrl: './map-browser.component.html',\r\n  styleUrls: ['./map-browser.component.scss']\r\n})\r\nexport class MapBrowserComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  private activityId: string;\r\n  private status$$: Subscription;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get view(): MapViewOptions {\r\n    return this._view;\r\n  }\r\n  set view(value: MapViewOptions) {\r\n    this._view = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateView(value);\r\n    }\r\n  }\r\n  private _view: MapViewOptions;\r\n\r\n  get controls(): MapControlsOptions {\r\n    return this._controls;\r\n  }\r\n\r\n  set controls(value: MapControlsOptions) {\r\n    this._controls = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateControls(value);\r\n    }\r\n  }\r\n  private _controls: MapControlsOptions;\r\n\r\n  public id = `igo-map-target-${new Date().getTime()}`;\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  ngOnInit() {\r\n    this.status$$ = this.map.status$.subscribe(status =>\r\n      this.handleStatusChange(status)\r\n    );\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.map.setTarget(this.id);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.setTarget(undefined);\r\n    this.activityService.unregister(this.activityId);\r\n    this.status$$.unsubscribe();\r\n  }\r\n\r\n  private handleStatusChange(status: SubjectStatus) {\r\n    if (status === SubjectStatus.Working && this.activityId === undefined) {\r\n      this.activityId = this.activityService.register();\r\n    } else if (status === SubjectStatus.Done && this.activityId !== undefined) {\r\n      this.activityService.unregister(this.activityId);\r\n      this.activityId = undefined;\r\n    }\r\n  }\r\n}\r\n","<div [id]=\"id\" class=\"igo-map-browser-target\"></div>\r\n<ng-content></ng-content>\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\n\r\nimport { transform } from 'ol/proj';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n/**\r\n * This directive return the pointer coordinate (on click or pointermove)\r\n * in [longitude, latitude], delayed by in input (pointerMoveDelay)\r\n * to avoid too many emitted values.\r\n */\r\n@Directive({\r\n  selector: '[igoPointerPosition]'\r\n})\r\nexport class PointerPositionDirective implements OnInit, OnDestroy {\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * Delay before emitting an event\r\n   */\r\n  @Input() pointerPositionDelay: number = 1000;\r\n\r\n  /**\r\n   * Event emitted when the pointer move, delayed by pointerMoveDelay\r\n   */\r\n  @Output() pointerPositionCoord = new EventEmitter<[number, number]>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.listenToMapPointerMove();\r\n    this.listenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unlistenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, this.pointerPositionDelay)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map click\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * emit delayed coordinate (longitude, latitude array) based on pointerMoveDelay or on click\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onPointerEvent(event: MapBrowserPointerEvent<any>, delay: number) {\r\n    if (event.dragging || this.mediaService.isTouchScreen()) {return; }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    const lonlat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.pointerPositionCoord.emit(lonlat);\r\n    }, delay);\r\n  }\r\n}\r\n","import olLayerImage from 'ol/layer/Image';\r\nimport olSourceImage from 'ol/source/Image';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nimport { ImageWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { WMSDataSource } from '../../../datasource/shared/datasources/wms-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { ImageLayerOptions } from './image-layer.interface';\r\nimport { ImageArcGISRestDataSource } from '../../../datasource/shared/datasources/imagearcgisrest-datasource';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\n\r\nexport class ImageLayer extends Layer {\r\n  public dataSource: WMSDataSource | ImageArcGISRestDataSource;\r\n  public options: ImageLayerOptions;\r\n  public ol: olLayerImage<olSourceImage>;\r\n\r\n  private watcher: ImageWatcher;\r\n\r\n  constructor(\r\n    options: ImageLayerOptions,\r\n    public messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    public authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new ImageWatcher(this, this.messageService, this.languageService);\r\n    this.status$ = this.watcher.status$;\r\n    this.status$.subscribe(valStatus => {\r\n      if (valStatus === 0) {\r\n        this.olLoadingProblem = true;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected createOlLayer(): olLayerImage<olSourceImage> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceImage\r\n    });\r\n\r\n    const image = new olLayerImage(olOptions);\r\n    if (this.authInterceptor) {\r\n      (image.getSource() as any).setImageLoadFunction((tile, src) => {\r\n        this.customLoader(tile, src, this.authInterceptor, this.messageService, this.languageService);\r\n      });\r\n    }\r\n\r\n    return image;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  private customLoader(tile, src: string, interceptor: AuthInterceptor, messageService: MessageService, languageService: LanguageService) {\r\n    const xhr = new XMLHttpRequest();\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(src);\r\n    let url = src;\r\n    if (alteredUrlWithKeyAuth) {\r\n      url = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', url);\r\n    const intercepted = interceptor.interceptXhr(xhr, url);\r\n    if (!intercepted) {\r\n      xhr.abort();\r\n      tile.getImage().src = url;\r\n      return;\r\n    }\r\n\r\n    xhr.responseType = 'arraybuffer';\r\n\r\n    xhr.onload = function() {\r\n      const arrayBufferView = new Uint8Array((this as any).response);\r\n      const responseString = new TextDecoder().decode(arrayBufferView);\r\n      if (responseString.includes('ServiceExceptionReport')) {\r\n        messageService.error(languageService.translate.instant(\r\n          'igo.geo.dataSource.optionsApiUnavailable'\r\n        ),\r\n        languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        ));\r\n      }\r\n      const blob = new Blob([arrayBufferView], { type: 'image/png' });\r\n      const urlCreator = window.URL;\r\n      const imageUrl = urlCreator.createObjectURL(blob);\r\n      tile.getImage().src = imageUrl;\r\n    };\r\n    xhr.send();\r\n  }\r\n}\r\n","import olLayerTile from 'ol/layer/Tile';\r\nimport olSourceTile from 'ol/source/Tile';\r\nimport Tile from 'ol/Tile';\r\n\r\nimport { TileWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { OSMDataSource } from '../../../datasource/shared/datasources/osm-datasource';\r\nimport { WMTSDataSource } from '../../../datasource/shared/datasources/wmts-datasource';\r\nimport { XYZDataSource } from '../../../datasource/shared/datasources/xyz-datasource';\r\nimport { CartoDataSource } from '../../../datasource/shared/datasources/carto-datasource';\r\nimport { TileArcGISRestDataSource } from '../../../datasource/shared/datasources/tilearcgisrest-datasource';\r\nimport { TileDebugDataSource } from '../../../datasource/shared/datasources/tiledebug-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { TileLayerOptions } from './tile-layer.interface';\r\n\r\nimport { MessageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nexport class TileLayer extends Layer {\r\n  public dataSource:\r\n    | OSMDataSource\r\n    | WMTSDataSource\r\n    | XYZDataSource\r\n    | TileDebugDataSource\r\n    | CartoDataSource\r\n    | TileArcGISRestDataSource;\r\n  public options: TileLayerOptions;\r\n  public ol: olLayerTile<olSourceTile>;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: TileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService);\r\n\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerTile<olSourceTile> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol\r\n    });\r\n    const tileLayer = new olLayerTile(olOptions);\r\n    const tileSource = tileLayer.getSource();\r\n    tileSource.setTileLoadFunction((tile: Tile, url: string) => {\r\n      this.customLoader(tile, url, this.authInterceptor);\r\n    });\r\n\r\n    return tileLayer;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for tile layer.\r\n   * @internal\r\n   * @param tile the current tile\r\n   * @param url the url string or function to retrieve the data\r\n   */\r\n  customLoader(tile, url: string, interceptor: AuthInterceptor ) {\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    tile.getImage().src = modifiedUrl;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\n\r\nimport { MVTDataSource } from '../../../datasource/shared/datasources/mvt-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { VectorTileLayerOptions } from './vectortile-layer.interface';\r\nimport { TileWatcher } from '../../utils';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { IgoMap } from '../../../map';\r\nimport { MessageService } from '@igo2/core';\r\nimport VectorTile from 'ol/VectorTile';\r\n\r\nexport class VectorTileLayer extends Layer {\r\n  public dataSource: MVTDataSource;\r\n  public options: VectorTileLayerOptions;\r\n  public ol: olLayerVectorTile;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: VectorTileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVectorTile {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVectorTile\r\n    });\r\n\r\n    const vectorTile = new olLayerVectorTile(olOptions);\r\n    const vectorTileSource = vectorTile.getSource() as olSourceVectorTile;\r\n\r\n    vectorTileSource.setTileLoadFunction((tile: VectorTile, url: string) => {\r\n      const loader = this.customLoader(url, tile.getFormat(), this.authInterceptor, tile.onLoad.bind(tile));\r\n      if (loader) {\r\n        tile.setLoader(loader);\r\n      }\r\n    }\r\n    );\r\n\r\n    return vectorTile;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector tile layer. Modified from the loadFeaturesXhr function in ol\\featureloader.js\r\n   * @internal\r\n   * @param url the url string or function to retrieve the data\r\n   * @param format the format of the tile\r\n   * @param interceptor the interceptor of the data\r\n   * @param success On success event action to trigger\r\n   * @param failure On failure event action to trigger TODO\r\n   */\r\n  customLoader(url, format, interceptor, success, failure?) {\r\n    return ((extent, resolution, projection) => {\r\n      const xhr = new XMLHttpRequest();\r\n      let modifiedUrl = url;\r\n      if (typeof url !== 'function') {\r\n        const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n        if (alteredUrlWithKeyAuth) {\r\n          modifiedUrl = alteredUrlWithKeyAuth;\r\n        }\r\n      } else {\r\n        modifiedUrl = url(extent, resolution, projection);\r\n      }\r\n      xhr.open( 'GET', modifiedUrl);\r\n      if (interceptor) {\r\n        interceptor.interceptXhr(xhr, modifiedUrl);\r\n      }\r\n\r\n      if (format.getType() === 'arraybuffer') {\r\n        xhr.responseType = 'arraybuffer';\r\n      }\r\n      xhr.onload = (event) => {\r\n        if (!xhr.status || xhr.status >= 200 && xhr.status < 300) {\r\n          const type = format.getType();\r\n          let source;\r\n          if (type === 'json' || type === 'text') {\r\n            source = xhr.responseText;\r\n          }\r\n          else if (type === 'xml') {\r\n            source = xhr.responseXML;\r\n            if (!source) {\r\n              source = new DOMParser().parseFromString(xhr.responseText, 'application/xml');\r\n            }\r\n          }\r\n          else if (type === 'arraybuffer') {\r\n            source = xhr.response;\r\n          }\r\n          if (source) {\r\n            success.call(this, format.readFeatures(source, {\r\n              extent,\r\n              featureProjection: projection\r\n            }), format.readProjection(source));\r\n          }\r\n          else {\r\n            // TODO\r\n            failure.call(this);\r\n          }\r\n        } else {\r\n          // TODO\r\n          failure.call(this);\r\n        }\r\n      };\r\n      xhr.onerror = () => {\r\n        // TODO\r\n        failure.call(this);\r\n      };\r\n      xhr.send();\r\n    });\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  HostListener\r\n} from '@angular/core'\r\n  ;\r\nimport olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olLayerVector from 'ol/layer/Vector';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport olVectorTileSource from 'ol/source/VectorTile';\r\n\r\nimport type { default as OlMapBrowserEvent } from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport * as OlGeom from 'ol/geom';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer, Layer, VectorTileLayer } from '../../layer/shared/layers';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { MediaService } from '@igo2/core';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { unByKey } from 'ol/Observable';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoHoverFeature]'\r\n})\r\nexport class HoverFeatureDirective implements OnInit, OnDestroy {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private pointerHoverFeatureStore: EntityStore<OlFeature<OlGeometry>> = new EntityStore<OlFeature<OlGeometry>>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  private selectionLayer: olLayerVectorTile;\r\n  private selectionMVT = {};\r\n  private mvtStyleOptions: StyleByAttribute;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private singleClickMapListener;\r\n\r\n  private hoverFeatureId: string = 'hoverFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoHoverFeatureDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoHoverFeatureEnabled: boolean = false;\r\n\r\n  @HostListener('mouseout')\r\n  mouseout() {\r\n    clearTimeout(this.lastTimeoutRequest);\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService,\r\n    private styleService: StyleService,\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n    this.listenToMapClick();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], { map: this.map });\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers: Layer[]) => {\r\n      if (this.store && !layers.find(l => l.id === 'hoverFeatureId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'hoverFeatureId',\r\n      title: 'hoverFeature',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: hoverFeatureMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n\r\n    this.selectionLayer = new olLayerVectorTile({\r\n      map: this.map.ol,\r\n      zIndex: 901,\r\n      renderMode: \"vector\",\r\n      declutter: true,\r\n      source: new olVectorTileSource({}),\r\n      style: (feature) => {\r\n        if (this.mvtStyleOptions && feature.getId() in this.selectionMVT) {\r\n          return this.createHoverStyle(feature, this.mvtStyleOptions);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  createHoverStyle(feature: RenderFeature | OlFeature<OlGeometry>, hoverStyle: StyleByAttribute) {\r\n    const localHoverStyle = { ...hoverStyle };\r\n    let label = hoverStyle.label ? hoverStyle.label.attribute : undefined;\r\n    let hasLabelStyle = hoverStyle.label?.style ? true : false;\r\n\r\n    if (!feature.get('_isLabel')) {\r\n      localHoverStyle.label = undefined;\r\n      hasLabelStyle = false;\r\n      label = undefined;\r\n    } else {\r\n      // clear the style for label....\r\n      const size = localHoverStyle.data ? localHoverStyle.data.length : 0;\r\n      const radius = [];\r\n      const stroke = [];\r\n      const width = [];\r\n      const fill = [];\r\n      for (let i = 0; i < size; i++) {\r\n        radius.push(0);\r\n        stroke.push('rgba(255, 255, 255, 0)');\r\n        width.push(0);\r\n        fill.push('rgba(255, 255, 255, 0)');\r\n      }\r\n      localHoverStyle.radius = radius;\r\n      localHoverStyle.stroke = stroke;\r\n      localHoverStyle.width = width;\r\n      localHoverStyle.fill = fill;\r\n    }\r\n    if (!hasLabelStyle && label) {\r\n      localHoverStyle.label.style =\r\n      {\r\n        textAlign: 'left',\r\n        textBaseline: 'top',\r\n        font: '12px Calibri,sans-serif',\r\n        fill: { color: '#000' },\r\n        backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n        backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n        stroke: { color: '#fff', width: 3 },\r\n        overflow: true,\r\n        offsetX: 10,\r\n        offsetY: 20,\r\n        padding: [2.5, 2.5, 2.5, 2.5]\r\n      };\r\n    }\r\n    return this.styleService.createStyleByAttribute(feature, localHoverStyle);\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unlistenToMapSingleClick();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerHoverFeatureStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: OlFeature<OlGeometry>[]) {\r\n\r\n    this.addFeatureOverlay(resultsUnderPointerPosition);\r\n\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map singleclick\r\n   */\r\n  private listenToMapClick() {\r\n    this.singleClickMapListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapSingleClickEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map singleclick\r\n   * @internal\r\n   */\r\n  private unlistenToMapSingleClick() {\r\n    unByKey(this.singleClickMapListener);\r\n    this.singleClickMapListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger clear layer on singleclick.\r\n   * @param event OL map browser singleclick event\r\n   */\r\n  private onMapSingleClickEvent(event: OlMapBrowserEvent<any>) {\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * Trigger hover when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: OlMapBrowserEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoHoverFeatureEnabled ||\r\n      this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    this.clearLayer();\r\n    let maximumZindex = -Infinity;\r\n    let topMostOlLayer;\r\n    const pixel = this.map.ol.getPixelFromCoordinate(event.coordinate);\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n\r\n      // retrieve the topmost layer with feature to only apply the hover on this layer.\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        if (!layerOL) {\r\n          return;\r\n        }\r\n        const igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid);\r\n        if (!this.canProcessHover(igoLayer as any)) {\r\n          return;\r\n        }\r\n        if (igoLayer.zIndex <= maximumZindex) {\r\n          return;\r\n        }\r\n        maximumZindex = igoLayer.zIndex;\r\n        topMostOlLayer = layerOL;\r\n\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer instanceof olLayerVector || olLayer instanceof olLayerVectorTile\r\n      });\r\n      if (!topMostOlLayer) {\r\n        return;\r\n      }\r\n\r\n      this.clearLayer();\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        if (mapFeature.get('hoverSummary') === undefined) {\r\n          let igoLayer;\r\n          if (layerOL instanceof olLayerVector) {\r\n            igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorLayer;\r\n            if (!this.canProcessHover(igoLayer)) {\r\n              return;\r\n            }\r\n            let localOlFeature = this.handleRenderFeature(mapFeature);\r\n            this.setLayerStyleFromOptions(igoLayer, localOlFeature);\r\n            const featuresToLoad = [localOlFeature];\r\n            localOlFeature.set(\"_isLabel\", false);\r\n            const myLabelOlFeature = new OlFeature();\r\n            myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n            const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n            myLabelOlFeature.setGeometry(labelGeom);\r\n            myLabelOlFeature.setId(localOlFeature.getId());\r\n            myLabelOlFeature.set(\"_isLabel\", true);\r\n            this.setLayerStyleFromOptions(igoLayer, myLabelOlFeature);\r\n            featuresToLoad.push(myLabelOlFeature);\r\n            this.pointerHoverFeatureStore.load(featuresToLoad);\r\n            return true;\r\n          }\r\n          if (layerOL instanceof olLayerVectorTile) {\r\n            igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorTileLayer;\r\n            if (!this.canProcessHover(igoLayer)) {\r\n              return;\r\n            }\r\n            if (igoLayer?.options?.styleByAttribute?.hoverStyle) {\r\n              this.mvtStyleOptions = igoLayer.options.styleByAttribute.hoverStyle;\r\n            } else if (igoLayer?.options?.hoverStyle) {\r\n              this.mvtStyleOptions = igoLayer.options.hoverStyle;\r\n            }\r\n            this.selectionLayer.setSource(layerOL.getSource());\r\n            layerOL.getFeatures(event.pixel).then((mvtFeatures: (RenderFeature | OlFeature<OlGeometry>)[]) => {\r\n              if (!mvtFeatures.length) {\r\n                this.selectionMVT = {};\r\n                this.selectionLayer.changed();\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              const feature = mvtFeatures[0];\r\n              if (!feature) {\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              let localOlFeature = this.handleRenderFeature(feature);\r\n              localOlFeature.set(\"_isLabel\", false);\r\n              const myLabelOlFeature = new OlFeature();\r\n              myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n              const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n              myLabelOlFeature.setGeometry(labelGeom);\r\n              myLabelOlFeature.setId(localOlFeature.getId());\r\n              myLabelOlFeature.set(\"_isLabel\", true);\r\n              this.setLayerStyleFromOptions(igoLayer, myLabelOlFeature);\r\n              this.pointerHoverFeatureStore.load([myLabelOlFeature]);\r\n              this.selectionMVT[feature.getId()] = localOlFeature;\r\n              this.selectionLayer.changed();\r\n            });\r\n          }\r\n        }\r\n        return true;\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer === topMostOlLayer\r\n      });\r\n    }, this.igoHoverFeatureDelay);\r\n  }\r\n\r\n  canProcessHover(igoLayer: VectorLayer | VectorTileLayer): boolean {\r\n    if (!igoLayer) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.visible) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.options) {\r\n      return false;\r\n    }\r\n\r\n    if (!igoLayer.options.styleByAttribute && !igoLayer.options.hoverStyle) {\r\n      return false;\r\n    }\r\n\r\n    if (\r\n      (igoLayer.options.styleByAttribute && !igoLayer.options.styleByAttribute.hoverStyle) &&\r\n      !igoLayer.options.hoverStyle) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  handleRenderFeature(feature: RenderFeature | OlFeature<OlGeometry>): OlFeature<OlGeometry> {\r\n    let localFeature: OlFeature<OlGeometry>;\r\n    if (feature instanceof RenderFeature) {\r\n      localFeature = new OlFeature({\r\n        geometry: this.getGeometry(feature)\r\n      });\r\n      localFeature.setId(feature.getId());\r\n    } else if (feature instanceof OlFeature) {\r\n      localFeature = feature;\r\n    }\r\n    return localFeature;\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addFeatureOverlay(hoverEntity: OlFeature<OlGeometry>[]) {\r\n\r\n    if (hoverEntity.length > 0) {\r\n\r\n      const result = hoverEntity[0];\r\n      this.clearLayer();\r\n      const feature = new OlFeature({\r\n        geometry: result.getGeometry(),\r\n        meta: { id: this.hoverFeatureId },\r\n        hoverSummary: this.getHoverSummary(result.getProperties())\r\n      });\r\n\r\n      this.store.setLayerOlFeatures([feature], FeatureMotion.None);\r\n    }\r\n  }\r\n\r\n  private setLayerStyleFromOptions(igoLayer: VectorLayer | VectorTileLayer, feature: OlFeature<OlGeometry>) {\r\n    if (igoLayer?.options?.styleByAttribute?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.styleByAttribute.hoverStyle));\r\n      return;\r\n    }\r\n    if (igoLayer?.options?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.hoverStyle));\r\n    }\r\n  }\r\n\r\n  private getHoverSummary(properties): string {\r\n    let summary = '';\r\n    for (const [key, value] of Object.entries(properties)) {\r\n      if (!key.startsWith('_') && key !== 'geometry') {\r\n        summary += `${key}: ${value}` + '\\n';\r\n      }\r\n    }\r\n    return summary.length >= 2 ? summary.slice(0, -2) : summary;\r\n  }\r\n\r\n  private getGeometry(feature): OlGeom.Geometry {\r\n    let geom;\r\n    if (!feature.getOrientedFlatCoordinates) {\r\n      geom = feature.getGeometry();\r\n    } else {\r\n\r\n      const coords = feature.getOrientedFlatCoordinates();\r\n      const flatCoords = [];\r\n\r\n      coords.forEach((c, idx) => {\r\n        if (idx % 2 === 0) {\r\n          flatCoords.push([parseFloat(coords[idx]), parseFloat(coords[idx + 1])]);\r\n        }\r\n      });\r\n\r\n      // TODO: test MultiX\r\n      switch (feature.getType()) {\r\n        case 'Point':\r\n          geom = new OlGeom.Point(flatCoords);\r\n          break;\r\n        case 'Polygon':\r\n          geom = new OlGeom.Polygon([flatCoords]);\r\n          break;\r\n        case 'LineString':\r\n          geom = new OlGeom.LineString([flatCoords]);\r\n          break;\r\n      }\r\n    }\r\n\r\n    return geom;\r\n  }\r\n\r\n\r\n  /**\r\n   * Clear the pointer store features\r\n   */\r\n  private clearLayer() {\r\n    this.selectionMVT = {};\r\n    if (this.selectionLayer) {\r\n      this.selectionLayer.changed();\r\n    }\r\n    if (this.store) {\r\n      this.store.clearLayer();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function hoverFeatureMarker(feature: OlFeature<OlGeom.Geometry>, resolution: number): OlStyle.Style[] {\r\n\r\n  const olStyleText = new OlStyle.Style({\r\n    text: new OlStyle.Text({\r\n      text: feature.get('hoverSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'top',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new OlStyle.Fill({ color: '#000' }),\r\n      backgroundFill: new OlStyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new OlStyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new OlStyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: 20,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n\r\n  const olStyle = [olStyleText];\r\n  switch (feature.getGeometry().getType()) {\r\n    case 'Point':\r\n      olStyle.push(new OlStyle.Style({\r\n        image: new OlStyle.Circle({\r\n          radius: 10,\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'blue',\r\n            width: 3\r\n          })\r\n        })\r\n      }));\r\n      break;\r\n    default:\r\n      olStyle.push(new OlStyle.Style({\r\n        stroke: new OlStyle.Stroke({\r\n          color: 'white',\r\n          width: 5\r\n        })\r\n      }));\r\n      olStyle.push(new OlStyle.Style({\r\n        stroke: new OlStyle.Stroke({\r\n          color: 'blue',\r\n          width: 3\r\n        })\r\n      }));\r\n  }\r\n\r\n  return olStyle;\r\n\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-zoom-button',\r\n  templateUrl: './zoom-button.component.html',\r\n  styleUrls: ['./zoom-button.component.scss']\r\n})\r\nexport class ZoomButtonComponent {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string;\r\n\r\n  get zoom(): number { return this.map.viewController.getZoom(); }\r\n\r\n  get minZoom(): number { return this.map.viewController.olView.getMinZoom() || 1; }\r\n\r\n  get maxZoom(): number { return this.map.viewController.olView.getMaxZoom(); }\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"igo-zoom-button-container\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomIn' | translate: {zoom: zoom + 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom >= maxZoom\"\r\n    (click)=\"map.viewController.zoomIn()\">\r\n    <mat-icon svgIcon=\"plus\"></mat-icon>\r\n  </button>\r\n\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomOut' | translate: {zoom: zoom - 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom <= minZoom\"\r\n    (click)=\"map.viewController.zoomOut()\">\r\n    <mat-icon svgIcon=\"minus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-geolocate-button',\r\n  templateUrl: './geolocate-button.component.html',\r\n  styleUrls: ['./geolocate-button.component.scss']\r\n})\r\nexport class GeolocateButtonComponent {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"igo-geolocate-button-container\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.geolocate' | translate\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    (click)=\"map.geolocate()\">\r\n    <mat-icon svgIcon=\"crosshairs-gps\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import { ConfigService } from '@igo2/core';\r\nimport { Component, Input } from '@angular/core';\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapExtent } from '../shared/map.interface';\r\nimport * as olproj from 'ol/proj';\r\n/*\r\nButton to center the map to the home extent\r\n*/\r\n@Component({\r\n  selector: 'igo-home-extent-button',\r\n  templateUrl:'./home-extent-button.component.html',\r\n  styleUrls: ['./home-extent-button.component.scss'],\r\n})\r\nexport class HomeExtentButtonComponent {\r\n  @Input() map: IgoMap;\r\n  @Input() color: string;\r\n  @Input() extentOverride?: MapExtent\r\n  @Input() centerOverride?: [number, number];\r\n  @Input() zoomOverride?: number;\r\n\r\n  private homeExtentButtonExtent;\r\n  private homeExtentButtonCenter;\r\n  private homeExtentButtonZoom;\r\n\r\n constructor(public configService: ConfigService) {\r\n      this.computeHomeExtent();\r\n  }\r\n\r\n  computeHomeExtent() {\r\n    this.homeExtentButtonExtent = this.extentOverride || this.configService.getConfig('homeExtentButton.homeExtButtonExtent');\r\n    this.homeExtentButtonCenter = this.centerOverride || this.configService.getConfig('homeExtentButton.homeExtButtonCenter');\r\n    this.homeExtentButtonZoom = this.zoomOverride || this.configService.getConfig('homeExtentButton.homeExtButtonZoom');\r\n\r\n    // priority over extent if these 2 properties are defined;\r\n    if (this.centerOverride && this.zoomOverride) {\r\n      this.homeExtentButtonExtent = undefined;\r\n    }\r\n  }\r\n\r\n  onToggleClick() {\r\n    this.computeHomeExtent();\r\n    if (this.homeExtentButtonExtent) {\r\n      this.map.viewController.zoomToExtent(this.homeExtentButtonExtent);\r\n    } else if (this.homeExtentButtonCenter && this.homeExtentButtonZoom) {\r\n      const center = olproj.fromLonLat(this.homeExtentButtonCenter, this.map.viewController.olView.getProjection().getCode());\r\n      this.map.viewController.olView.setCenter(center);\r\n      this.map.viewController.zoomTo(this.homeExtentButtonZoom);\r\n    }\r\n  }\r\n}\r\n","<div class=\"igo-home-extent-button-container\"><button\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.mapButtons.home-extent' | translate\"\r\n            matTooltipPosition=\"left\"\r\n      [color]=\"color\"\r\n      (click)=\"onToggleClick()\"><mat-icon svgIcon = \"home-map-marker\"></mat-icon></button></div>\r\n","<div *ngIf=\"baseLayers.length > 0\"\r\n     class=\"igo-baselayers-switcher-container\"\r\n     [ngClass]=\"{'container-expand': expand}\"\r\n     [@baseLayerSwitcherState]=\"expand ? 'expand' : useStaticIcon ? 'collapseIcon' : 'collapseMap'\"\r\n     (@baseLayerSwitcherState.start)=\"showButton=false\"\r\n     (@baseLayerSwitcherState.done)=\"showButton=true\"\r\n     (click)=\"collapseOrExpand()\">\r\n\r\n     <div *ngIf=\"useStaticIcon && !expand && showButton\" class=\"igo-baselayers-switcher-button-container\">\r\n       <button\r\n         mat-icon-button\r\n         [matTooltip]=\"'igo.geo.mapButtons.baselayerSwitcher' | translate\"\r\n         matTooltipPosition=\"right\"\r\n         color=\"primary\">\r\n         <mat-icon svgIcon=\"image-multiple\"></mat-icon>\r\n       </button>\r\n     </div>\r\n\r\n     <igo-mini-basemap class=\"mat-typography\" *ngFor=\"let baseLayer of baseLayers; let i = index\"\r\n       [map]=\"map\"\r\n       [baseLayer]=\"baseLayer\"\r\n       [title]=\"(baseLayers.length > 2 && !expand) ? ('igo.geo.baselayersSwitcher.title' | translate) : baseLayer.title\"\r\n       [display]=\"expand || (i === 0 && !useStaticIcon)\"\r\n       [disabled]=\"!expand && baseLayers.length > 1\">\r\n     </igo-mini-basemap>\r\n\r\n    <div class=\"more-baselayers\">\r\n      <mat-icon class=\"material-icons mat-icon mat-list-avatar\" color=\"primary\" svgIcon=\"menu-down\"></mat-icon>\r\n    </div>\r\n\r\n</div>\r\n","import { Component, Input, AfterViewInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { Layer } from '../../layer';\r\nimport { IgoMap } from '../shared';\r\nimport { baseLayersSwitcherSlideInOut } from './baselayers-switcher.animation';\r\n\r\n@Component({\r\n  selector: 'igo-baselayers-switcher',\r\n  templateUrl: './baselayers-switcher.component.html',\r\n  styleUrls: ['./baselayers-switcher.component.scss'],\r\n  animations: [baseLayersSwitcherSlideInOut()]\r\n})\r\nexport class BaseLayersSwitcherComponent implements AfterViewInit, OnDestroy {\r\n  @Input() map: IgoMap;\r\n  @Input() useStaticIcon: boolean;\r\n\r\n  public _baseLayers: Layer[] = [];\r\n  public expand = false;\r\n  public showButton = true;\r\n\r\n  private layers$$: Subscription;\r\n\r\n  constructor(private mediaService: MediaService) {\r\n    const media = this.mediaService.media$.value;\r\n    if (media === Media.Mobile && this.useStaticIcon === undefined) {\r\n      this.useStaticIcon = true;\r\n    }\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.layers$$ = this.map.layers$.subscribe(arrayLayers => {\r\n      this._baseLayers = arrayLayers.filter(l => l.baseLayer);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  collapseOrExpand() {\r\n    if (this.baseLayers.length > 1 || this.useStaticIcon) {\r\n      this.expand = !this.expand;\r\n    } else {\r\n      this.expand = false;\r\n    }\r\n  }\r\n\r\n  get baseLayers(): Layer[] {\r\n    const mapResolution = this.map.viewController.getResolution();\r\n    const mapZoom = this.map.viewController.getZoom();\r\n\r\n    const bl = this._baseLayers.filter(l => {\r\n      return (\r\n        (!l.options.maxResolution ||\r\n          mapResolution <= l.options.maxResolution) &&\r\n        (!l.options.minResolution || mapResolution >= l.options.minResolution) &&\r\n        (!l.options.source.options.maxZoom || mapZoom <= l.options.source.options.maxZoom) &&\r\n        (!l.options.source.options.minZoom || mapZoom >= l.options.source.options.minZoom)\r\n      );\r\n    });\r\n\r\n    const blHidden = bl.filter(l => !l.visible);\r\n    return blHidden.length + 1 === bl.length ? blHidden : bl;\r\n  }\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function baseLayersSwitcherSlideInOut(): AnimationTriggerMetadata {\r\n  return trigger('baseLayerSwitcherState', [\r\n    state(\r\n      'collapseIcon',\r\n      style({\r\n        height: '40px',\r\n        width: '40px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'collapseMap',\r\n      style({\r\n        height: '85px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'expand',\r\n      style({\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    transition('collapse => expand', animate('200ms')),\r\n    transition('expand => collapse', animate('200ms'))\r\n  ]);\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport stylefunction from 'ol-mapbox-style/dist/stylefunction';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { Style } from 'ol/style';\r\n\r\nimport {\r\n  OSMDataSource,\r\n  FeatureDataSource,\r\n  XYZDataSource,\r\n  TileDebugDataSource,\r\n  WFSDataSource,\r\n  WMTSDataSource,\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestDataSource,\r\n  TileArcGISRestDataSource,\r\n  WebSocketDataSource,\r\n  MVTDataSource,\r\n  ClusterDataSource\r\n} from '../../datasource';\r\n\r\nimport { DataSourceService } from '../../datasource/shared/datasource.service';\r\n\r\nimport {\r\n  Layer,\r\n  ImageLayer,\r\n  ImageLayerOptions,\r\n  TileLayer,\r\n  TileLayerOptions,\r\n  VectorLayer,\r\n  VectorLayerOptions,\r\n  AnyLayerOptions,\r\n  VectorTileLayer,\r\n  VectorTileLayerOptions\r\n} from './layers';\r\n\r\nimport { computeMVTOptionsOnHover } from '../utils/layer.utils';\r\nimport { StyleService } from './style.service';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private styleService: StyleService,\r\n    private dataSourceService: DataSourceService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    @Optional() private authInterceptor: AuthInterceptor\r\n  ) {}\r\n\r\n  createLayer(layerOptions: AnyLayerOptions): Layer {\r\n    if (!layerOptions.source) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      layerOptions.source.options &&\r\n      layerOptions.source.options._layerOptionsFromSource\r\n    ) {\r\n      layerOptions = ObjectUtils.mergeDeep(\r\n        layerOptions.source.options._layerOptionsFromSource,\r\n        layerOptions || {}\r\n      );\r\n    }\r\n\r\n    let layer;\r\n    switch (layerOptions.source.constructor) {\r\n      case OSMDataSource:\r\n      case WMTSDataSource:\r\n      case XYZDataSource:\r\n      case TileDebugDataSource:\r\n      case CartoDataSource:\r\n      case TileArcGISRestDataSource:\r\n        layer = this.createTileLayer(layerOptions as TileLayerOptions);\r\n        break;\r\n      case FeatureDataSource:\r\n      case WFSDataSource:\r\n      case ArcGISRestDataSource:\r\n      case WebSocketDataSource:\r\n      case ClusterDataSource:\r\n        layer = this.createVectorLayer(layerOptions as VectorLayerOptions);\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case WMSDataSource:\r\n        layer = this.createImageLayer(layerOptions as ImageLayerOptions);\r\n        break;\r\n      case MVTDataSource:\r\n        const _layerOptions = computeMVTOptionsOnHover(layerOptions);\r\n        layer = this.createVectorTileLayer(\r\n          _layerOptions as VectorTileLayerOptions\r\n        );\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return layer;\r\n  }\r\n\r\n  createAsyncLayer(_layerOptions: AnyLayerOptions, detailedContextUri?: string): Observable<Layer> {\r\n    const layerOptions = computeMVTOptionsOnHover(_layerOptions);\r\n    if (layerOptions.source) {\r\n      return new Observable(d => d.next(this.createLayer(layerOptions)));\r\n    }\r\n\r\n    return this.dataSourceService\r\n      .createAsyncDataSource(layerOptions.sourceOptions, detailedContextUri)\r\n      .pipe(\r\n        map(source => {\r\n          if (source === undefined) {\r\n            return undefined;\r\n          }\r\n          return this.createLayer(Object.assign(layerOptions, { source }));\r\n        })\r\n      );\r\n  }\r\n\r\n  private createImageLayer(layerOptions: ImageLayerOptions): ImageLayer {\r\n    return new ImageLayer(layerOptions, this.messageService, this.languageService, this.authInterceptor);\r\n  }\r\n\r\n  private createTileLayer(layerOptions: TileLayerOptions): TileLayer {\r\n    return new TileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n  }\r\n\r\n  private createVectorLayer(layerOptions: VectorLayerOptions): VectorLayer {\r\n    let style: Style;\r\n    let igoLayer: VectorLayer;\r\n    if (layerOptions.style !== undefined) {\r\n      style = this.styleService.createStyle(layerOptions.style);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ArcGISRestDataSource) {\r\n      const source = layerOptions.source as ArcGISRestDataSource;\r\n      style = source.options.params.style;\r\n    } else if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = feature => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(layerOptions, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ClusterDataSource) {\r\n      const serviceStyle = this.styleService;\r\n      const baseStyle = layerOptions.clusterBaseStyle;\r\n      layerOptions.style = feature => {\r\n        return serviceStyle.createClusterStyle(\r\n          feature,\r\n          layerOptions.clusterParam,\r\n          baseStyle\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(layerOptions, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorLayer(layerOptionsOl, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl as any);\r\n\r\n    return igoLayer;\r\n  }\r\n\r\n  private createVectorTileLayer(\r\n    layerOptions: VectorTileLayerOptions\r\n  ): VectorTileLayer {\r\n    let style: Style;\r\n    let igoLayer: VectorTileLayer;\r\n\r\n    if (layerOptions.style !== undefined) {\r\n      style = this.styleService.createStyle(layerOptions.style);\r\n    }\r\n\r\n    if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = feature => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute\r\n        );\r\n      };\r\n      igoLayer = new VectorTileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorTileLayer(layerOptionsOl, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl);\r\n    return igoLayer;\r\n  }\r\n\r\n  private applyMapboxStyle(layer: Layer, layerOptions: VectorTileLayerOptions) {\r\n    if (layerOptions.mapboxStyle) {\r\n      this.getMapboxGlStyle(layerOptions.mapboxStyle.url).subscribe(res => {\r\n        stylefunction(layer.ol, res, layerOptions.mapboxStyle.source);\r\n      });\r\n    }\r\n  }\r\n\r\n  public getMapboxGlStyle(url: string) {\r\n    return this.http.get(url).pipe(\r\n      map((res: any) => res),\r\n      catchError(err => {\r\n        console.log('No style was found');\r\n        return of(err);\r\n      })\r\n    );\r\n  }\r\n}\r\n","<div class=\"igo-mini-basemap-container\">\r\n\r\n  <div *ngIf=\"display\" (click)=\"changeBaseLayer(baseLayer)\">\r\n    <igo-map-browser [map]=\"basemap\"></igo-map-browser>\r\n    <div *ngIf='title' class='igo-mini-basemap-title'> {{title}} </div>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  AfterViewInit,\r\n  OnDestroy,\r\n  ApplicationRef\r\n} from '@angular/core';\r\n\r\nimport { Layer, LayerOptions } from '../../layer/shared';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../shared';\r\n\r\nimport OlMap from 'ol/Map';\r\nimport OlView from 'ol/View';\r\n\r\n@Component({\r\n  selector: 'igo-mini-basemap',\r\n  templateUrl: './mini-basemap.component.html',\r\n  styleUrls: ['./mini-basemap.component.scss']\r\n})\r\nexport class MiniBaseMapComponent implements AfterViewInit, OnDestroy {\r\n\r\n  @Input() map: IgoMap;\r\n  @Input() disabled: boolean;\r\n  @Input() display: boolean;\r\n  @Input() title: string;\r\n\r\n  @Input()\r\n  get baseLayer(): Layer {\r\n    return this._baseLayer;\r\n  }\r\n  set baseLayer(value: Layer) {\r\n    this._baseLayer = value;\r\n    this.handleBaseLayerChanged(value);\r\n  }\r\n  private _baseLayer: Layer;\r\n\r\n  public basemap = new IgoMap({\r\n    controls: {},\r\n    interactions: false\r\n  });\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private appRef: ApplicationRef\r\n  ) { }\r\n\r\n  ngAfterViewInit() {\r\n    this.handleMainMapViewChange(this.map.ol.getView());\r\n    this.map.viewController.olView.on('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.on('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.viewController.olView.un('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.un('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    this.map.changeBaseLayer(baseLayer);\r\n    this.appRef.tick();\r\n  }\r\n\r\n  private handleMainMapViewChange(mainMapView) {\r\n    const mainMapViewProperties = mainMapView.getProperties();\r\n    this.basemap.viewController.olView.setResolution(mainMapViewProperties.resolution);\r\n    this.basemap.viewController.olView.setRotation(mainMapViewProperties.rotation);\r\n    this.basemap.viewController.olView.setCenter(this.map.viewController.getCenter());\r\n  }\r\n\r\n  private handleBaseLayerChanged(baselayer: Layer) {\r\n    this.basemap.removeAllLayers();\r\n\r\n    const options: any = Object.assign(\r\n      Object.create(baselayer.options),\r\n      baselayer.options,\r\n      {\r\n        visible: true,\r\n        baseLayer: false\r\n      }\r\n    );\r\n\r\n    const layer = this.layerService.createLayer(options);\r\n    this.basemap.addLayer(layer);\r\n    this.handleLinkedBaseLayer(layer);\r\n  }\r\n\r\n  private handleLinkedBaseLayer(baselayer: Layer) {\r\n    const linkedLayers = baselayer.options.linkedLayers;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n    if (isParentLayer && currentLinkedId === baselayer.options.linkedLayers.linkId) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        link.linkedIds.map(linkedId => {\r\n          const layerToApply = this.map.layers.find(l => l.options.linkedLayers?.linkId === linkedId);\r\n          if (layerToApply) {\r\n            const linkedLayerOptions: any = Object.assign(\r\n              Object.create(layerToApply.options),\r\n              layerToApply.options,\r\n              {\r\n                zIndex: 9000,\r\n                visible: true,\r\n                baseLayer: false,\r\n              } as LayerOptions\r\n            );\r\n            this.basemap.addLayer(this.layerService.createLayer(linkedLayerOptions));\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n}\r\n","<div *ngIf=\"rotated && !showIfNoRotation\" class=\"igo-rotation-button-container\"\r\n  [matTooltip]=\"rotated ? ('igo.geo.mapButtons.resetRotation' | translate): ('igo.geo.mapButtons.tipRotation' | translate)\"\r\n  matTooltipPosition=\"left\">\r\n  <button mat-icon-button matTooltipPosition=\"left\" [color]=\"color\" [disabled]=\"!rotated\"\r\n    (click)=\"map.viewController.resetRotation()\">\r\n    <mat-icon [ngStyle]=\"rotationStyle(map.viewController.getRotation())\" svgIcon=\"navigation\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n\r\n<div *ngIf=\"showIfNoRotation\" class=\"igo-rotation-button-container\"\r\n  [matTooltip]=\"rotated ? ('igo.geo.mapButtons.resetRotation' | translate): ('igo.geo.mapButtons.tipRotation' | translate)\"\r\n  matTooltipPosition=\"left\">\r\n  <button mat-icon-button matTooltipPosition=\"left\" [color]=\"color\" [disabled]=\"!rotated\"\r\n    (click)=\"map.viewController.resetRotation()\">\r\n    <mat-icon [ngStyle]=\"rotationStyle(map.viewController.getRotation())\" svgIcon=\"navigation\">\r\n    </mat-icon>\r\n  </button>\r\n</div>","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-rotation-button',\r\n  templateUrl: './rotation-button.component.html',\r\n  styleUrls: ['./rotation-button.component.scss']\r\n})\r\nexport class RotationButtonComponent {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get showIfNoRotation(): boolean {\r\n    return this._showIfNoRotation;\r\n  }\r\n  set showIfNoRotation(value: boolean) {\r\n    this._showIfNoRotation = value;\r\n  }\r\n  private _showIfNoRotation: boolean;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  get rotated(): boolean {\r\n    return this.map.viewController.getRotation() !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  rotationStyle(radians): {} {\r\n    const rotation = 'rotate(' + radians + 'rad)';\r\n    return {\r\n      transform: rotation\r\n    };\r\n  }\r\n}\r\n","<div *ngIf=\"infoContent && infoContent.length\" class=\"infoSection\">\r\n    <pre>{{infoContent}}</pre>\r\n</div>","import { Component, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-info-section',\r\n  templateUrl: './info-section.component.html',\r\n  styleUrls: ['./info-section.component.scss']\r\n})\r\nexport class InfoSectionComponent {\r\n\r\n  @Input() infoContent: string = '';\r\n\r\n  constructor() {}\r\n\r\n}\r\n","export enum CatalogItemType {\r\n  Layer = 'layer',\r\n  Group = 'group'\r\n}\r\n\r\nexport enum TypeCatalog {\r\n  wms, wmts, baselayers, arcgisrest, tilearcgisrest, imagearcgisrest, composite\r\n}\r\n\r\nexport type TypeCatalogStrings = keyof typeof TypeCatalog;\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { TooltipType } from '../../layer';\r\nimport { TimeFilterOptions } from '../../filter';\r\nimport { QueryFormat, QueryHtmlTarget } from '../../query';\r\n\r\nimport { ICatalog, ICompositeCatalog , CatalogItem, CatalogItemGroup } from './catalog.interface';\r\nimport { CatalogService } from './catalog.service';\r\nimport { TypeCatalog, TypeCatalogStrings } from './catalog.enum';\r\n\r\nexport abstract class Catalog implements ICatalog {\r\n\r\n    // ICatalog -----------------------------\r\n    id: string;\r\n    title: string;\r\n    url: string;\r\n    removable?: boolean;\r\n    externalProvider?: boolean;\r\n    abstract?: string;\r\n    forcedProperties?: any[];\r\n    items?: CatalogItem[];\r\n    type?: TypeCatalogStrings;\r\n    version?: string;\r\n    matrixSet?: string;\r\n    requestEncoding?: string;\r\n    regFilters?: string[];\r\n    groupImpose?: CatalogItemGroup;\r\n    groupSeparator?: string;\r\n    timeFilter?: TimeFilterOptions;\r\n    queryFormat?: QueryFormat;\r\n    queryHtmlTarget?: QueryHtmlTarget;\r\n    queryParams?: { [key: string]: string; };\r\n    sourceOptions?: { [key: string]: any; };\r\n    count?: number;\r\n    tooltipType?: TooltipType.ABSTRACT | TooltipType.TITLE;\r\n    sortDirection?: 'asc' | 'desc';\r\n    setCrossOriginAnonymous?: boolean;\r\n    showLegend?: boolean;\r\n    // ICatalog -----------------------------\r\n\r\n    protected catalogService: CatalogService;\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        Object.assign(this, options);\r\n        this.catalogService = service;\r\n    }\r\n\r\n    public abstract collectCatalogItems(): Observable<CatalogItem[]>;\r\n}\r\n\r\nclass WMSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wms];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass WMTSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wmts];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMTSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass BaselayersCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.baselayers];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItemGroup[]> {\r\n        return this.catalogService.loadCatalogBaseLayerItems(this);\r\n    }\r\n}\r\n\r\nclass ArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.arcgisrest];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nclass TileOrImageArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService, typeCatalog: TypeCatalog) {\r\n        super(options, service);\r\n        this.type = TypeCatalog[TypeCatalog[typeCatalog]];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nexport class CompositeCatalog extends Catalog implements ICompositeCatalog {\r\n    composite: ICatalog[];\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.composite];\r\n        this.type = TypeCatalog[sType];\r\n        this.url = null;\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogCompositeLayerItems(this);\r\n    }\r\n}\r\n\r\nexport class CatalogFactory {\r\n\r\n    public static createInstanceCatalog(options: Catalog, service: CatalogService): Catalog {\r\n\r\n        let catalog: Catalog;\r\n        if (options.hasOwnProperty('composite')) {\r\n            catalog = new CompositeCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.baselayers]) {\r\n            catalog = new BaselayersCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.arcgisrest]) {\r\n            catalog = new ArcGISRestCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.tilearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.tilearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.imagearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.imagearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.wmts]) {\r\n            catalog = new WMTSCatalog(options, service);\r\n        } else {\r\n            catalog = new WMSCatalog(options, service);\r\n        }\r\n\r\n        return catalog;\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, mergeMap } from 'rxjs/operators';\r\n\r\nimport * as striptags_ from 'striptags';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport * as olextent from 'ol/extent';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport olFeature from 'ol/Feature';\r\nimport * as olgeom from 'ol/geom';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { Feature, FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport {\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  TileArcGISRestDataSource,\r\n  WMSDataSourceOptions,\r\n  ImageArcGISRestDataSource\r\n} from '../../datasource';\r\n\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType,\r\n  QueryHtmlTarget\r\n} from './query.enums';\r\nimport {\r\n  QueryOptions,\r\n  QueryableDataSource,\r\n  QueryableDataSourceOptions\r\n} from './query.interfaces';\r\nimport { MapExtent } from '../../map/shared/map.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class QueryService {\r\n  public queryEnabled = true;\r\n\r\n  constructor(private http: HttpClient) {}\r\n\r\n  query(layers: Layer[], options: QueryOptions): Observable<Feature[]>[] {\r\n    return layers\r\n      .filter((layer: Layer) => layer.visible && layer.isInResolutionsRange)\r\n      .map((layer: Layer) => this.queryLayer(layer, options));\r\n  }\r\n\r\n  queryLayer(layer: Layer, options: QueryOptions): Observable<Feature[]> {\r\n    const url = this.getQueryUrl(layer.dataSource, options, false, layer.map.viewController.getExtent());\r\n    if (!url) {\r\n      return of([]);\r\n    }\r\n\r\n    if (\r\n      (layer.dataSource as QueryableDataSource).options.queryFormat ===\r\n      QueryFormat.HTMLGML2\r\n    ) {\r\n      const urlGml = this.getQueryUrl(layer.dataSource, options, true);\r\n      return this.http.get(urlGml, { responseType: 'text' }).pipe(\r\n        mergeMap(gmlRes => {\r\n          const mergedGML = this.mergeGML(gmlRes, url, layer);\r\n          const imposedGeom = mergedGML[0];\r\n          const imposedProperties = mergedGML[1];\r\n          return this.http\r\n            .get(url, { responseType: 'text' })\r\n            .pipe(\r\n              map(res =>\r\n                this.extractData(res, layer, options, url, imposedGeom, imposedProperties)\r\n              )\r\n            );\r\n        })\r\n      );\r\n    }\r\n\r\n    const request = this.http.get(url, { responseType: 'text' });\r\n    return request.pipe(map(res => this.extractData(res, layer, options, url)));\r\n  }\r\n\r\n  private mergeGML(gmlRes, url, layer: Layer): [FeatureGeometry, { [key: string]: any }] {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(gmlRes);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      features = wmsParser.readFeatures(gmlRes);\r\n    }\r\n    const olmline = new olgeom.MultiLineString([]);\r\n    let pts;\r\n    const ptsArray = [];\r\n    let olmpoly = new olgeom.MultiPolygon([]);\r\n    let firstFeatureType;\r\n    const nbFeatures = features.length;\r\n\r\n    // Check if geometry intersect bbox\r\n    // for geoserver getfeatureinfo response in data projection, not call projection\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const bbox = bboxRaw.split(',');\r\n    const bboxExtent = olextent.createEmpty();\r\n    olextent.extend(bboxExtent, bbox);\r\n    const outBboxExtent = false;\r\n    let titleContent;\r\n    let queryTileField;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        queryTileField = dataSourceOptions.queryTitle;\r\n      }\r\n    }\r\n    features.map(feature => {\r\n\r\n      if (queryTileField) {\r\n        let queryTitleContent = feature.getProperties()[queryTileField];\r\n        if (queryTitleContent) {\r\n          titleContent = !titleContent ? queryTitleContent : `${titleContent},${queryTitleContent}`;\r\n        }\r\n      }\r\n      /*  if (!feature.getGeometry().simplify(100).intersectsExtent(bboxExtent)) {\r\n        outBboxExtent = true;\r\n        // TODO: Check to project the geometry?\r\n      }*/\r\n      const featureGeometryCoordinates = feature.getGeometry().getCoordinates();\r\n      const featureGeometryType = feature.getGeometry().getType();\r\n\r\n      if (!firstFeatureType && !outBboxExtent) {\r\n        firstFeatureType = featureGeometryType;\r\n      }\r\n      if (!outBboxExtent) {\r\n        switch (featureGeometryType) {\r\n          case 'Point':\r\n            if (nbFeatures === 1) {\r\n              pts = new olgeom.Point(featureGeometryCoordinates, 'XY');\r\n            } else {\r\n              ptsArray.push(featureGeometryCoordinates);\r\n            }\r\n            break;\r\n          case 'LineString':\r\n            olmline.appendLineString(\r\n              new olgeom.LineString(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'Polygon':\r\n            olmpoly.appendPolygon(\r\n              new olgeom.Polygon(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'MultiPolygon':\r\n            olmpoly = new olgeom.MultiPolygon(featureGeometryCoordinates, 'XY');\r\n            break;\r\n          default:\r\n            return;\r\n        }\r\n      }\r\n    });\r\n\r\n    let olmpts;\r\n    if (ptsArray.length === 0 && pts) {\r\n      olmpts = {\r\n        type: pts.getType(),\r\n        coordinates: pts.getCoordinates()\r\n      };\r\n    } else {\r\n      olmpts = {\r\n        type: 'Polygon',\r\n        coordinates: [this.convexHull(ptsArray)]\r\n      };\r\n    }\r\n\r\n    let returnGeometry;\r\n    switch (firstFeatureType) {\r\n      case 'LineString':\r\n        returnGeometry = {\r\n          type: olmline.getType(),\r\n          coordinates: olmline.getCoordinates()\r\n        };\r\n      case 'Point':\r\n        return olmpts;\r\n      case 'Polygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n      case 'MultiPolygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n    }\r\n    const imposedProperties = {};\r\n\r\n    if (queryTileField) {\r\n      imposedProperties[queryTileField] = titleContent;\r\n    }\r\n\r\n    return [ returnGeometry, imposedProperties];\r\n\r\n\r\n  }\r\n\r\n  cross(a, b, o) {\r\n    return (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]);\r\n  }\r\n\r\n  /**\r\n   * @param points An array of [X, Y] coordinates\r\n   * This method is use instead of turf.js convexHull because Turf needs at least 3 point to make a hull.\r\n   * https://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain#JavaScript\r\n   */\r\n  convexHull(points) {\r\n    points.sort((a, b) => {\r\n      return a[0] === b[0] ? a[1] - b[1] : a[0] - b[0];\r\n    });\r\n\r\n    const lower = [];\r\n    for (const point of points) {\r\n      while (\r\n        lower.length >= 2 &&\r\n        this.cross(lower[lower.length - 2], lower[lower.length - 1], point) <= 0\r\n      ) {\r\n        lower.pop();\r\n      }\r\n      lower.push(point);\r\n    }\r\n\r\n    const upper = [];\r\n    for (let i = points.length - 1; i >= 0; i--) {\r\n      while (\r\n        upper.length >= 2 &&\r\n        this.cross(\r\n          upper[upper.length - 2],\r\n          upper[upper.length - 1],\r\n          points[i]\r\n        ) <= 0\r\n      ) {\r\n        upper.pop();\r\n      }\r\n      upper.push(points[i]);\r\n    }\r\n\r\n    upper.pop();\r\n    lower.pop();\r\n    return lower.concat(upper);\r\n  }\r\n\r\n  private extractData(\r\n    res,\r\n    layer: Layer,\r\n    options: QueryOptions,\r\n    url: string,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ): Feature[] {\r\n    const queryDataSource = layer.dataSource as QueryableDataSource;\r\n\r\n    const allowedFieldsAndAlias = this.getAllowedFieldsAndAlias(layer);\r\n    let features = [];\r\n    switch (queryDataSource.options.queryFormat) {\r\n      case QueryFormat.GML3:\r\n        features = this.extractGML3Data(\r\n          res,\r\n          layer.zIndex,\r\n          allowedFieldsAndAlias\r\n        );\r\n        break;\r\n      case QueryFormat.JSON:\r\n      case QueryFormat.GEOJSON:\r\n      case QueryFormat.GEOJSON2:\r\n        features = this.extractGeoJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.ESRIJSON:\r\n        features = this.extractEsriJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.TEXT:\r\n        features = this.extractTextData(res);\r\n        break;\r\n      case QueryFormat.HTML:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url\r\n        );\r\n        break;\r\n      case QueryFormat.HTMLGML2:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url,\r\n          imposedGeometry,\r\n          imposedProperties\r\n        );\r\n        break;\r\n      case QueryFormat.GML2:\r\n      default:\r\n        features = this.extractGML2Data(res, layer, allowedFieldsAndAlias);\r\n        break;\r\n    }\r\n\r\n    if (features.length > 0 && features[0].geometry === null) {\r\n      const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n      for (const feature of features) {\r\n        feature.geometry = geomToAdd;\r\n      }\r\n    }\r\n\r\n    return features.map((feature: Feature, index: number) => {\r\n      const mapLabel = feature.properties[queryDataSource.mapLabel];\r\n\r\n      let exclude;\r\n      if (layer.options.sourceOptions?.type === 'wms') {\r\n        const sourceOptions = layer.options\r\n          .sourceOptions as WMSDataSourceOptions;\r\n        exclude = sourceOptions ? sourceOptions.excludeAttribute : undefined;\r\n      }\r\n\r\n      let title = this.getQueryTitle(feature, layer);\r\n      if (!title && features.length > 1) {\r\n        title = `${layer.title} (${index + 1})`;\r\n      } else if (!title) {\r\n        title = layer.title;\r\n      }\r\n\r\n      const meta = Object.assign({}, feature.meta || {}, {\r\n        id: uuid(),\r\n        title,\r\n        mapTitle: mapLabel,\r\n        sourceTitle: layer.title,\r\n        order: 1000 - layer.zIndex,\r\n        excludeAttribute: exclude\r\n      });\r\n\r\n      return Object.assign(feature, {\r\n        meta,\r\n        projection:\r\n          queryDataSource.options.type === 'carto'\r\n            ? 'EPSG:4326'\r\n            : options.projection\r\n      });\r\n    });\r\n  }\r\n\r\n  private createGeometryFromUrlClick(url) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const width = parseInt(searchParams.width, 10);\r\n    const height = parseInt(searchParams.height, 10);\r\n    const xPosition = parseInt(searchParams.i || searchParams.x, 10);\r\n    const yPosition = parseInt(searchParams.j || searchParams.y, 10);\r\n\r\n    const bbox = bboxRaw.split(',');\r\n    let threshold =\r\n      (Math.abs(parseFloat(bbox[0])) - Math.abs(parseFloat(bbox[2]))) * 0.05;\r\n\r\n    // for context in degree (EPSG:4326,4269...)\r\n    if (Math.abs(parseFloat(bbox[0])) < 180) {\r\n      threshold = 0.045;\r\n    }\r\n    const clickx =\r\n      parseFloat(bbox[0]) +\r\n      (Math.abs(parseFloat(bbox[0]) - parseFloat(bbox[2])) * xPosition) /\r\n        width -\r\n      threshold;\r\n    const clicky =\r\n      parseFloat(bbox[1]) +\r\n      (Math.abs(parseFloat(bbox[1]) - parseFloat(bbox[3])) * yPosition) /\r\n        height -\r\n      threshold;\r\n    const clickx1 = clickx + threshold * 2;\r\n    const clicky1 = clicky + threshold * 2;\r\n\r\n    const wktPoly =\r\n      'POLYGON((' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      '))';\r\n\r\n    const format = new olformat.WKT();\r\n    const tenPercentWidthGeom = format.readFeature(wktPoly);\r\n    const f = tenPercentWidthGeom.getGeometry() as any;\r\n\r\n    const newGeom = {\r\n      type: f.getType(),\r\n      coordinates: f.getCoordinates()\r\n    };\r\n\r\n    return newGeom;\r\n  }\r\n\r\n  private extractGML2Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(res);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      try {\r\n        features = wmsParser.readFeatures(res);\r\n      } catch (e) {\r\n        console.warn(\r\n          'query.service: Multipolygons are badly managed in mapserver in GML2. Use another format.'\r\n        );\r\n      }\r\n    }\r\n\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGML3Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML3();\r\n    let features = [];\r\n    try {\r\n      features = parser.readFeatures(res);\r\n    } catch (e) {\r\n      console.warn('query.service: GML3 is not well supported');\r\n    }\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGeoJSONData(res, zIndex, allowedFieldsAndAlias?) {\r\n    let features = [];\r\n    try {\r\n      features = JSON.parse(res.replace(/(\\r|\\n)/g, ' ')).features;\r\n    } catch (e) {\r\n      console.warn('query.service: Unable to parse geojson', '\\n', res);\r\n    }\r\n    features.map(feature => feature.meta = {\r\n      id: uuid(),\r\n      order: 1000 - zIndex,\r\n      alias: allowedFieldsAndAlias\r\n    });\r\n    return features;\r\n  }\r\n\r\n  private extractEsriJSONData(res, zIndex, allowedFieldsAndAlias) {\r\n    if (res) {\r\n      try {\r\n        if (JSON.parse(res).error) {\r\n          return [];\r\n        }\r\n      } catch (e) {}\r\n    }\r\n    const parser = new olFormatEsriJSON();\r\n    const features = parser.readFeatures(res);\r\n\r\n    return features.map(feature => this.featureToResult(feature, zIndex, allowedFieldsAndAlias));\r\n  }\r\n\r\n  private extractTextData(res) {\r\n    // TODO\r\n    return [];\r\n  }\r\n\r\n  private extractHtmlData(\r\n    res,\r\n    htmlTarget: QueryHtmlTarget,\r\n    url,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const projection = searchParams.crs || searchParams.srs || 'EPSG:3857';\r\n    const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n    if (\r\n      htmlTarget !== QueryHtmlTarget.BLANK &&\r\n      htmlTarget !== QueryHtmlTarget.IFRAME\r\n    ) {\r\n      htmlTarget = QueryHtmlTarget.IFRAME;\r\n    }\r\n\r\n    const bodyTagStart = res.toLowerCase().indexOf('<body>');\r\n    const bodyTagEnd = res.toLowerCase().lastIndexOf('</body>') + 7;\r\n    // replace \\r \\n  and ' ' with '' to validate if the body is really empty. Clear all the html tags from body\r\n    const striptags = striptags_;\r\n    const body = striptags(res.slice(bodyTagStart, bodyTagEnd).replace(/(\\r|\\n|\\s)/g, ''));\r\n    if (body === '' || res === '') {\r\n      return [];\r\n    }\r\n\r\n    return [\r\n      {\r\n        type: FEATURE,\r\n        projection,\r\n        properties: Object.assign({ target: htmlTarget, body: res, url }, imposedProperties),\r\n        geometry: imposedGeometry || geomToAdd\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getQueryParams(url) {\r\n    const queryString = url.split('?');\r\n    if (!queryString[1]) {\r\n      return;\r\n    }\r\n    const pairs = queryString[1].split('&');\r\n\r\n    const result = {};\r\n    pairs.forEach(pair => {\r\n      pair = pair.split('=');\r\n      result[pair[0]] = decodeURIComponent(pair[1] || '');\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public featureToResult(\r\n    featureOL: olFeature<olgeom.Geometry>,\r\n    zIndex: number,\r\n    allowedFieldsAndAlias?\r\n  ): Feature {\r\n    const featureGeometry = featureOL.getGeometry() as any;\r\n    const properties: any = Object.assign({}, featureOL.getProperties());\r\n    delete properties.geometry;\r\n    delete properties.GEOMETRIE;\r\n    delete properties.boundedBy;\r\n    delete properties.shape;\r\n    delete properties.SHAPE;\r\n    delete properties.the_geom;\r\n    delete properties.geom;\r\n\r\n    let geometry;\r\n    if (featureGeometry) {\r\n      geometry = {\r\n        type: featureGeometry.getType(),\r\n        coordinates: featureGeometry.getCoordinates()\r\n      };\r\n    }\r\n\r\n    return {\r\n      type: FEATURE,\r\n      projection: undefined,\r\n      properties,\r\n      geometry,\r\n      meta: {\r\n        id: uuid(),\r\n        order: 1000 - zIndex,\r\n        alias: allowedFieldsAndAlias\r\n      }\r\n    };\r\n  }\r\n\r\n  private getQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    forceGML2 = false,\r\n    mapExtent?: MapExtent\r\n  ): string {\r\n    let url;\r\n\r\n    if (datasource.options.queryUrl) {\r\n      return this.getCustomQueryUrl(datasource, options, mapExtent);\r\n    }\r\n\r\n    switch (datasource.constructor) {\r\n      case WMSDataSource:\r\n        const wmsDatasource = datasource as WMSDataSource;\r\n\r\n        const WMSGetFeatureInfoOptions = {\r\n          INFO_FORMAT:\r\n            wmsDatasource.params.INFO_FORMAT ||\r\n            this.getMimeInfoFormat(datasource.options.queryFormat),\r\n          QUERY_LAYERS: wmsDatasource.params.LAYERS,\r\n          FEATURE_COUNT: wmsDatasource.params.FEATURE_COUNT || '5'\r\n        };\r\n\r\n        if (forceGML2) {\r\n          WMSGetFeatureInfoOptions.INFO_FORMAT = this.getMimeInfoFormat(\r\n            QueryFormat.GML2\r\n          );\r\n        }\r\n\r\n        url = wmsDatasource.ol.getFeatureInfoUrl(\r\n          options.coordinates,\r\n          options.resolution,\r\n          options.projection,\r\n          WMSGetFeatureInfoOptions\r\n        );\r\n        // const wmsVersion =\r\n        //   wmsDatasource.params.VERSION ||\r\n        //   wmsDatasource.params.version ||\r\n        //   '1.3.0';\r\n        // if (wmsVersion !== '1.3.0') {\r\n        //   url = url.replace('&I=', '&X=');\r\n        //   url = url.replace('&J=', '&Y=');\r\n        // }\r\n        break;\r\n      case CartoDataSource:\r\n        const cartoDatasource = datasource as CartoDataSource;\r\n        const baseUrl =\r\n          'https://' +\r\n          cartoDatasource.options.account +\r\n          '.carto.com/api/v2/sql?';\r\n        const format = 'format=GeoJSON';\r\n        const sql =\r\n          '&q=' + cartoDatasource.options.config.layers[0].options.sql;\r\n        const clause =\r\n          ' WHERE ST_Intersects(the_geom_webmercator,ST_BUFFER(ST_SetSRID(ST_POINT(';\r\n        const meters = cartoDatasource.options.queryPrecision\r\n          ? cartoDatasource.options.queryPrecision\r\n          : '1000';\r\n        const coordinates =\r\n          options.coordinates[0] +\r\n          ',' +\r\n          options.coordinates[1] +\r\n          '),3857),' +\r\n          meters +\r\n          '))';\r\n\r\n        url = `${baseUrl}${format}${sql}${clause}${coordinates}`;\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case TileArcGISRestDataSource:\r\n        const tileArcGISRestDatasource = datasource as TileArcGISRestDataSource;\r\n        const deltaX = Math.abs(mapExtent[0] - mapExtent[2]);\r\n        const deltaY = Math.abs(mapExtent[1] - mapExtent[3]);\r\n        const maxDelta = deltaX > deltaY ? deltaX : deltaY;\r\n        const clickBuffer = maxDelta * 0.005;\r\n        const threshold = tileArcGISRestDatasource.options.queryPrecision ? tileArcGISRestDatasource.options.queryPrecision : clickBuffer;\r\n        const extent = olextent.buffer(\r\n          olextent.boundingExtent([options.coordinates]),\r\n          threshold\r\n        );\r\n        const serviceUrl =\r\n          tileArcGISRestDatasource.options.url +\r\n          '/' +\r\n          tileArcGISRestDatasource.options.layer +\r\n          '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        url = `${serviceUrl}?${params.join('&')}`;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return url;\r\n  }\r\n\r\n  private getMimeInfoFormat(queryFormat: string) {\r\n    let mime = 'application/vnd.ogc.gml';\r\n    const keyEnum = Object.keys(QueryFormat).find(\r\n      key => QueryFormat[key] === queryFormat\r\n    );\r\n    if (keyEnum) {\r\n      mime = QueryFormatMimeType[keyEnum];\r\n    }\r\n\r\n    return mime;\r\n  }\r\n\r\n  getAllowedFieldsAndAlias(layer: any) {\r\n    let allowedFieldsAndAlias;\r\n    if (\r\n      layer.options?.source?.options?.sourceFields &&\r\n      layer.options.source.options.sourceFields.length >= 1\r\n    ) {\r\n      allowedFieldsAndAlias = {};\r\n      layer.options.source.options.sourceFields.forEach(sourceField => {\r\n        const alias = sourceField.alias ? sourceField.alias : sourceField.name;\r\n        allowedFieldsAndAlias[sourceField.name] = alias;\r\n      });\r\n    }\r\n    return allowedFieldsAndAlias;\r\n  }\r\n\r\n  getQueryTitle(feature: Feature, layer: Layer): string {\r\n    let title;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        title = this.getLabelMatch(feature, dataSourceOptions.queryTitle);\r\n      }\r\n    }\r\n\r\n    return title;\r\n  }\r\n\r\n  getLabelMatch(feature: Feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.properties[v[1]]);\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.properties[labelMatch] || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  /**\r\n   * @param datasource QueryableDataSource\r\n   * @param options QueryOptions\r\n   * @mapExtent extent of the map when click event\r\n   *\r\n   */\r\n\r\n  getCustomQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    mapExtent?: MapExtent): string {\r\n\r\n      let url = datasource.options.queryUrl.replace(/\\{xmin\\}/g, mapExtent[0].toString())\r\n      .replace(/\\{ymin\\}/g, mapExtent[1].toString())\r\n      .replace(/\\{xmax\\}/g, mapExtent[2].toString())\r\n      .replace(/\\{ymax\\}/g, mapExtent[3].toString())\r\n      .replace(/\\{x\\}/g, options.coordinates[0].toString())\r\n      .replace(/\\{y\\}/g, options.coordinates[1].toString())\r\n      .replace(/\\{resolution\\}/g, options.resolution.toString())\r\n      .replace(/\\{srid\\}/g, options.projection.replace('EPSG:',''));\r\n\r\n      return url;\r\n    }\r\n}\r\n","import OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\n\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { QueryableDataSource } from './query.interfaces';\r\n\r\n/**\r\n * Whether a layer is queryable\r\n * @param layer Layer\r\n * @returns True if the layer s squeryable\r\n */\r\nexport function layerIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryable === true;\r\n}\r\n\r\n/**\r\n * Whether an OL layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol layer is queryable\r\n */\r\nexport function olLayerIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : layerIsQueryable(layer);\r\n}\r\n\r\n/**\r\n * Whether a layer's feature is queryable\r\n * @param layer Layer\r\n * @returns True if the layer's feature is queryable\r\n */\r\nexport function layerFeatureIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryLayerFeatures !== undefined ? (dataSource.options.queryLayerFeatures === true) : true;\r\n}\r\n\r\n/**\r\n * Whether an OL Vector layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol vector layer is queryable\r\n */\r\nexport function olLayerFeatureIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : (layerIsQueryable(layer) && layerFeatureIsQueryable(layer));\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  AfterViewInit,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { Subscription, Observable, of, zip } from 'rxjs';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport OlFeature from 'ol/Feature';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { EventsKey } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { renderFeatureFromOl } from '../../feature/shared/feature.utils';\r\nimport { featureFromOl } from '../../feature/shared/feature.utils';\r\nimport { QueryService } from './query.service';\r\nimport { layerIsQueryable, olLayerFeatureIsQueryable } from './query.utils';\r\nimport { ctrlKeyDown } from '../../map/shared/map.utils';\r\nimport { OlDragSelectInteraction } from '../../feature/shared/strategies/selection';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { QueryableDataSourceOptions } from './query.interfaces';\r\n\r\n/**\r\n * This directive makes a map queryable with a click of with a drag box.\r\n * By default, all layers are queryable but this can ben controlled at\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoQuery]'\r\n})\r\nexport class QueryDirective implements AfterViewInit, OnDestroy {\r\n  /**\r\n   * Subscriptions to ongoing queries\r\n   */\r\n  private queries$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * OL drag box interaction\r\n   */\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  /**\r\n   * Ol drag box \"end\" event key\r\n   */\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Whter to query features or not\r\n   */\r\n  @Input() queryFeatures: boolean = false;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesHitTolerance: number = 0;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesCondition: (olLayer: OlLayer<OlSource>) => boolean;\r\n\r\n  /**\r\n   * Whether all query should complete before emitting an event\r\n   */\r\n  @Input() waitForAllQueries: boolean = true;\r\n\r\n  /**\r\n   * Event emitted when a query (or all queries) complete\r\n   */\r\n  @Output() query = new EventEmitter<{\r\n    features: Feature[] | Feature[][];\r\n    event: MapBrowserPointerEvent<any>;\r\n  }>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return (this.component.map as any) as IgoMap;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private queryService: QueryService\r\n  ) {}\r\n\r\n  /**\r\n   * Start listening to click and drag box events\r\n   * @internal\r\n   */\r\n  ngAfterViewInit() {\r\n    this.listenToMapClick();\r\n    this.addDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to click and drag box events and cancel ongoind requests\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.cancelOngoingQueries();\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * On map click, issue queries\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Issue queries from a map event and emit events with the results\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    this.cancelOngoingQueries();\r\n    if (!this.queryService.queryEnabled) {\r\n      return;\r\n    }\r\n\r\n    const queries$ = [];\r\n    if (this.queryFeatures) {\r\n      queries$.push(this.doQueryFeatures(event));\r\n    }\r\n\r\n    const resolution = this.map.ol.getView().getResolution();\r\n    const queryLayers = this.map.layers.filter(layerIsQueryable);\r\n    queries$.push(\r\n      ...this.queryService.query(queryLayers, {\r\n        coordinates: event.coordinate as [number, number],\r\n        projection: this.map.projection,\r\n        resolution\r\n      })\r\n    );\r\n\r\n    if (queries$.length === 0) {\r\n      return;\r\n    }\r\n\r\n    if (this.waitForAllQueries) {\r\n      this.queries$$.push(\r\n        zip(...queries$).subscribe((results: Feature[][]) => {\r\n          const features = [].concat(...results);\r\n          this.query.emit({ features, event });\r\n        })\r\n      );\r\n    } else {\r\n      this.queries$$ = queries$.map((query$: Observable<Feature[]>) => {\r\n        return query$.subscribe((features: Feature[]) => {\r\n          this.query.emit({ features, event });\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query features already present on the map\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private doQueryFeatures(\r\n    event: MapBrowserPointerEvent<any>\r\n  ): Observable<Feature[]> {\r\n    const clickedFeatures = [];\r\n\r\n    if (event.type === 'singleclick') {\r\n      this.map.ol.forEachFeatureAtPixel(\r\n        event.pixel,\r\n        (featureOL: OlFeature<OlGeometry>, layerOL: any) => {\r\n          const layer = this.map.getLayerById(layerOL.values_._layer.id);\r\n          if ((layer.dataSource.options as QueryableDataSourceOptions).queryFormatAsWms) {\r\n            return;\r\n          }\r\n          if (featureOL) {\r\n            if (featureOL.get('features')) {\r\n              for (const feature of featureOL.get('features')) {\r\n                const newFeature = featureFromOl(feature, this.map.projection);\r\n                newFeature.meta = {\r\n                  title: feature.values_.nom,\r\n                  id: layerOL.values_._layer.id + '.' + feature.id_,\r\n                  icon: feature.values_._icon,\r\n                  sourceTitle: layerOL.values_.title,\r\n                  alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                  // title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n                };\r\n                clickedFeatures.push(newFeature);\r\n              }\r\n            } else if (featureOL instanceof OlRenderFeature) {\r\n              const newFeature = renderFeatureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            } else {\r\n              const newFeature = featureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            }\r\n          }\r\n        },\r\n        {\r\n          hitTolerance: this.queryFeaturesHitTolerance || 0,\r\n          layerFilter: this.queryFeaturesCondition\r\n            ? this.queryFeaturesCondition\r\n            : olLayerFeatureIsQueryable\r\n        }\r\n      );\r\n    } else if (event.type === 'boxend') {\r\n      const target = event.target as any;\r\n      const dragExtent = target.getGeometry().getExtent();\r\n      this.map.layers\r\n        .filter(layerIsQueryable)\r\n        .filter(layer => layer instanceof VectorLayer && layer.visible)\r\n        .map(layer => {\r\n          const featuresOL = layer.dataSource.ol as olVectorSource<OlGeometry>;\r\n          featuresOL.forEachFeatureIntersectingExtent(dragExtent, (olFeature: any) => {\r\n            const newFeature: Feature = featureFromOl(olFeature, this.map.projection, layer.ol);\r\n            newFeature.meta = {\r\n              id: layer.id + '.' + olFeature.getId(),\r\n              icon: olFeature.values_._icon,\r\n              sourceTitle: layer.title,\r\n              alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n              title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n            };\r\n            clickedFeatures.push(newFeature);\r\n          });\r\n        });\r\n    }\r\n\r\n\r\n    return of(clickedFeatures);\r\n  }\r\n\r\n  /**\r\n   * Cancel ongoing requests, if any\r\n   */\r\n  private cancelOngoingQueries() {\r\n    this.queries$$.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.queries$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteractionOnQuery;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteractionOnQuery = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteractionOnQuery === undefined) {\r\n      olDragSelectInteractionOnQuery = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteractionOnQuery);\r\n      this.olDragSelectInteraction = olDragSelectInteractionOnQuery;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteractionOnQuery.on(\r\n      'boxend',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions,\r\n  SearchSourceSettings\r\n} from './source.interfaces';\r\n\r\n/**\r\n * Base search source class\r\n */\r\nexport class SearchSource {\r\n  /**\r\n   * Search source ID\r\n   * @internal\r\n   */\r\n  static id = '';\r\n\r\n  /**\r\n   * Search source type\r\n   * @internal\r\n   */\r\n  static type = '';\r\n\r\n  /**\r\n   * Search source options\r\n   * @internal\r\n   */\r\n  protected options: SearchSourceOptions;\r\n\r\n  /**\r\n   * Get search source's id\r\n   * @returns Search source's id\r\n   */\r\n  getId(): string {\r\n    throw new Error('You have to implement the method \"getId\".');\r\n  }\r\n  /**\r\n   * Get search source's type\r\n   * @returns Search source's type\r\n   */\r\n  getType(): string {\r\n    throw new Error('You have to implement the method \"getType\".');\r\n  }\r\n\r\n  /**\r\n   * Get search source's default options\r\n   * @returns Search source default options\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    throw new Error('You have to implement the method \"getDefaultOptions\".');\r\n  }\r\n\r\n  /**\r\n   * Search source's title\r\n   */\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is available\r\n   */\r\n  get available(): boolean {\r\n    return this.options.available !== false;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is enabled\r\n   */\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  get enabled(): boolean {\r\n    return this.available && this.options.enabled !== false;\r\n  }\r\n\r\n  get showInPointerSummary(): boolean {\r\n    const showInPointerSummary = this.options.showInPointerSummary;\r\n    return showInPointerSummary ? showInPointerSummary : false;\r\n  }\r\n\r\n  get showInSettings(): boolean {\r\n    const showInSettings = this.options.showInSettings;\r\n    return showInSettings === undefined ? true : showInSettings;\r\n  }\r\n\r\n  /**\r\n   * Search url\r\n   */\r\n  get searchUrl(): string {\r\n    return this.options.searchUrl;\r\n  }\r\n\r\n  /**\r\n   * Search query params\r\n   */\r\n  get params(): { [key: string]: string } {\r\n    return this.options.params === undefined ? {} : this.options.params;\r\n  }\r\n\r\n  /**\r\n   * Search settings\r\n   */\r\n  get settings(): SearchSourceSettings[] {\r\n    return this.options.settings === undefined ? [] : this.options.settings;\r\n  }\r\n\r\n  /**\r\n   * Set params from selected settings\r\n   */\r\n  setParamFromSetting(setting: SearchSourceSettings, saveInStorage = true) {\r\n    switch (setting.type) {\r\n      case 'radiobutton':\r\n        setting.values.forEach(conf => {\r\n          if (conf.enabled) {\r\n            this.options.params = Object.assign(this.options.params || {}, {\r\n              [setting.name]: conf.value\r\n            });\r\n          }\r\n        });\r\n        break;\r\n      case 'checkbox':\r\n        let confValue = '';\r\n        setting.values\r\n          .filter(s => s.available !== false)\r\n          .forEach(conf => {\r\n            if (conf.enabled) {\r\n              confValue += conf.value + ',';\r\n            }\r\n          });\r\n        confValue = confValue.slice(0, -1);\r\n        this.options.params = Object.assign(this.options.params || {}, {\r\n          [setting.name]: confValue\r\n        });\r\n        break;\r\n    }\r\n\r\n    if (saveInStorage && this.storageService) {\r\n      this.storageService.set(\r\n        this.getId() + '.options',\r\n        {params: this.options.params}\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search results display order\r\n   */\r\n  get displayOrder(): number {\r\n    return this.options.order === undefined ? 99 : this.options.order;\r\n  }\r\n\r\n  constructor(options: SearchSourceOptions, private storageService?: StorageService) {\r\n    this.options = options;\r\n    if (this.storageService) {\r\n      const storageOptions = this.storageService.get(\r\n        this.getId() + '.options'\r\n      ) as object;\r\n      if (storageOptions) {\r\n        this.options = ObjectUtils.mergeDeep(this.options, storageOptions);\r\n      }\r\n    }\r\n\r\n    this.options = ObjectUtils.mergeDeep(this.getDefaultOptions(), this.options);\r\n\r\n\r\n    // Set Default Params from Settings\r\n    this.settings.forEach(setting => {\r\n      this.setParamFromSetting(setting, false);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get hashtags valid\r\n   * @param hashtag hashtag from query\r\n   */\r\n  getHashtagsValid(term: string, settingsName: string): string[] {\r\n    const hashtags = term.match(/(#[A-Za-z]+)/g);\r\n    if (!hashtags) {\r\n      return undefined;\r\n    }\r\n\r\n    const searchSourceSetting = this.getSettingsValues(settingsName);\r\n    const hashtagsValid = [];\r\n    hashtags.forEach(hashtag => {\r\n      searchSourceSetting.values.forEach(conf => {\r\n        const hashtagKey = hashtag.substring(1);\r\n        if (typeof conf.value === 'string') {\r\n          const types = conf.value\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n            .split(',');\r\n          const index = types.indexOf(\r\n            hashtagKey\r\n              .toLowerCase()\r\n              .normalize('NFD')\r\n              .replace(/[\\u0300-\\u036f]/g, '')\r\n          );\r\n          if (index !== -1) {\r\n            hashtagsValid.push(types[index]);\r\n          }\r\n        }\r\n        if (conf.hashtags && conf.hashtags.indexOf(hashtagKey.toLowerCase()) !== -1) {\r\n          hashtagsValid.push(conf.value);\r\n        }\r\n      });\r\n    });\r\n\r\n    return hashtagsValid.filter((a, b) => hashtagsValid.indexOf(a) === b);\r\n  }\r\n\r\n  getSettingsValues(search: string): SearchSourceSettings {\r\n    return this.getDefaultOptions().settings.find(\r\n      (value: SearchSourceSettings) => {\r\n        return value.name === search;\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by text implement this class\r\n */\r\nexport interface TextSearch {\r\n  /**\r\n   * Search by text\r\n   * @param term Text\r\n   * @param options Optional: TextSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by coordinates implement this class\r\n */\r\nexport interface ReverseSearch {\r\n  /**\r\n   * Search by text\r\n   * @param lonLat Coordinates\r\n   * @param options Optional: ReverseSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { SearchSourceOptions } from '../../search/shared/sources/source.interfaces';\r\n/**\r\n * Map search source. For now it has no search capability. All it does\r\n * is act as a placeholder for the map query results' \"search source\".\r\n */\r\n@Injectable()\r\nexport class QuerySearchSource extends SearchSource {\r\n  static id = 'map';\r\n  static type = FEATURE;\r\n\r\n  constructor(@Inject('options') options: SearchSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return QuerySearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return QuerySearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Carte'\r\n    };\r\n  }\r\n}\r\n","export class GoogleLinks {\r\n  static getGoogleMapsCoordLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleStreetViewLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=&layer=c&cbll=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleMapsNameLink(name) {\r\n    const encodedName = encodeURI(name);\r\n    return 'https://www.google.com/maps?q=' + encodedName;\r\n  }\r\n}\r\n","export class OsmLinks {\r\n  static getOpenStreetMapLink(lon, lat, zoom: number = 17) {\r\n    // return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n    return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=${zoom}/${lat}/${lon}`;\r\n  }\r\n\r\n  static getOpenStreetCamLink(lon, lat, zoom: number = 17) {\r\n    return `https://openstreetcam.org/map/@${lat},${lon},${zoom}z`;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { EMPTY, Observable, of, zip } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService, ConfigService } from '@igo2/core';\r\nimport {\r\n  CapabilitiesService,\r\n  WMSDataSourceOptions,\r\n  WMSDataSourceOptionsParams,\r\n  WMTSDataSourceOptions,\r\n  ArcGISRestDataSourceOptions\r\n} from '../../datasource';\r\nimport { LayerOptions, ImageLayerOptions } from '../../layer';\r\nimport { getResolutionFromScale } from '../../map';\r\n\r\nimport {\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup\r\n} from './catalog.interface';\r\nimport { Catalog, CatalogFactory, CompositeCatalog } from './catalog.abstract';\r\nimport { CatalogItemType, TypeCatalog } from './catalog.enum';\r\nimport { QueryFormat } from '../../query';\r\nimport { generateIdFromSourceOptions } from '../../utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CatalogService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private capabilitiesService: CapabilitiesService\r\n  ) {}\r\n\r\n  loadCatalogs(): Observable<Catalog[]> {\r\n    const contextConfig = this.config.getConfig('context') || {};\r\n    const catalogConfig = this.config.getConfig('catalog') || {};\r\n    const apiUrl = catalogConfig.url || contextConfig.url;\r\n    const catalogsFromConfig = catalogConfig.sources || [];\r\n\r\n    const observables$ = [];\r\n\r\n    if (apiUrl) {\r\n      // Base layers catalog\r\n      if (catalogConfig.baseLayers) {\r\n        const translate = this.languageService.translate;\r\n        const title = translate.instant('igo.geo.catalog.baseLayers');\r\n        const baseLayersCatalog = [\r\n          {\r\n            id: 'catalog.baselayers',\r\n            title,\r\n            url: `${apiUrl}/baselayers`,\r\n            type: 'baselayers'\r\n          }\r\n        ];\r\n        observables$.push(of(baseLayersCatalog));\r\n      }\r\n\r\n      // Catalogs from API\r\n      const catalogsFromApi$ = this.http\r\n        .get<Catalog[]>(`${apiUrl}/catalogs`)\r\n        .pipe(\r\n          map((catalogs) =>\r\n            catalogs.map((c: any) => Object.assign(c, c.options))\r\n          ),\r\n          catchError((_response: HttpErrorResponse) => EMPTY)\r\n        );\r\n      observables$.push(catalogsFromApi$);\r\n    }\r\n\r\n    // Catalogs from config\r\n    if (catalogsFromConfig.length > 0) {\r\n      observables$.push(\r\n        of(catalogsFromConfig).pipe(\r\n          map((catalogs: Catalog[]) =>\r\n            catalogs.map((c) => {\r\n              if (!c.id) {\r\n                c.id = uuid();\r\n              }\r\n              return c;\r\n            })\r\n          )\r\n        )\r\n      );\r\n    }\r\n\r\n    return zip(...observables$).pipe(\r\n      map((catalogs: Catalog[][]) => [].concat.apply([], catalogs))\r\n    ) as Observable<Catalog[]>;\r\n  }\r\n\r\n  loadCatalogItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    let newCatalog: Catalog;\r\n    newCatalog = CatalogFactory.createInstanceCatalog(catalog, this);\r\n    return newCatalog.collectCatalogItems();\r\n  }\r\n\r\n  loadCatalogBaseLayerItems(catalog: Catalog): Observable<CatalogItemGroup[]> {\r\n    return this.getCatalogBaseLayersOptions(catalog).pipe(\r\n      map((layersOptions: LayerOptions[]) => {\r\n        const items = layersOptions.map((layerOptions: LayerOptions) => {\r\n          return {\r\n            id: generateIdFromSourceOptions(layerOptions.sourceOptions),\r\n            title: layerOptions.title,\r\n            type: CatalogItemType.Layer,\r\n            externalProvider: catalog.externalProvider,\r\n            options: layerOptions\r\n          } as CatalogItemLayer;\r\n        });\r\n        return [\r\n          {\r\n            id: 'catalog.group.baselayers',\r\n            type: CatalogItemType.Group,\r\n            externalProvider: catalog.externalProvider,\r\n            title: catalog.title,\r\n            items\r\n          }\r\n        ];\r\n      })\r\n    );\r\n  }\r\n\r\n  private getCatalogBaseLayersOptions(\r\n    catalog: Catalog\r\n  ): Observable<LayerOptions[]> {\r\n    return this.http.get<LayerOptions[]>(catalog.url);\r\n  }\r\n\r\n  loadCatalogWMSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        const items = [];\r\n        if (!capabilities) {\r\n          return items;\r\n        }\r\n        if (capabilities.Service && capabilities.Service.Abstract && capabilities.Service.Abstract.length) {\r\n          catalog.abstract = capabilities.Service.Abstract;\r\n        }\r\n        const finalLayers = [];\r\n        this.flattenWmsCapabilities(capabilities.Capability.Layer, 0, finalLayers, catalog.groupSeparator);\r\n        const capabilitiesCapabilityLayer = Object.assign({}, capabilities.Capability.Layer);\r\n        capabilitiesCapabilityLayer.Layer = finalLayers.filter(f => f.Layer.length !== 0);\r\n        this.includeRecursiveItems(\r\n          catalog,\r\n          capabilitiesCapabilityLayer,\r\n          items\r\n        );\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  flattenWmsCapabilities(parent, level = 0, finalLayers, separator = ' / ') {\r\n    if (!finalLayers.includes(parent.Title)) {\r\n        const modifiedParent = Object.assign({}, parent);\r\n        modifiedParent.Layer = [];\r\n        finalLayers.push(modifiedParent);\r\n    }\r\n    for (const layer of parent.Layer) {\r\n        const modifiedLayer = Object.assign({}, layer);\r\n        if (level > 0) {\r\n          modifiedLayer.Title = parent.Title + separator + layer.Title;\r\n        }\r\n        if (layer.Layer) {\r\n            this.flattenWmsCapabilities(modifiedLayer, level + 1, finalLayers, separator);\r\n        } else {\r\n            finalLayers.find(ff => ff.Title === parent.Title).Layer.push(layer);\r\n         }\r\n    }\r\n}\r\n\r\n  loadCatalogWMTSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => this.getWMTSItems(catalog, capabilities))\r\n    );\r\n  }\r\n\r\n  loadCatalogArcGISRestItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        return this.getArcGISRESTItems(catalog, capabilities);\r\n      })\r\n    );\r\n  }\r\n\r\n  loadCatalogCompositeLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    const compositeCatalog = (catalog as CompositeCatalog).composite;\r\n\r\n    const catalogsFromInstance = [] as Catalog[];\r\n    compositeCatalog.map((component: Catalog) => {\r\n      component.sortDirection = catalog.sortDirection; // propagate sortDirection with parent value\r\n      catalogsFromInstance.push(\r\n        CatalogFactory.createInstanceCatalog(component, this)\r\n    );\r\n  }\r\n    );\r\n\r\n    // get CatalogItems for each original Catalog-----------------------------------------------------\r\n    const request1$ = [];\r\n    catalogsFromInstance.map((component: Catalog) =>\r\n      request1$.push(component.collectCatalogItems())\r\n    );\r\n\r\n    // integrate imposed group -----------------------------------------------------\r\n    let request2$ = [];\r\n\r\n    function flatDeepLayer(arr) {\r\n      return arr.reduce(\r\n        (acc, val) =>\r\n          acc.concat(\r\n            val.type === CatalogItemType.Group ? flatDeepLayer(val.items) : val\r\n          ),\r\n        []\r\n      );\r\n    }\r\n\r\n    if (\r\n      Object.keys(compositeCatalog).find((k) => compositeCatalog[k].groupImpose)\r\n    ) {\r\n      const pushImposeGroup = (item, index) => {\r\n        const c = catalogsFromInstance[index];\r\n        const outGroupImpose = Object.assign({}, c.groupImpose);\r\n        outGroupImpose.address = c.id;\r\n        outGroupImpose.type = CatalogItemType.Group;\r\n        outGroupImpose.externalProvider = c.externalProvider;\r\n        if (outGroupImpose.sortDirection === undefined) {\r\n          outGroupImpose.sortDirection = c.sortDirection;\r\n        }\r\n        outGroupImpose.items = [];\r\n\r\n        const flatLayer = flatDeepLayer(item);\r\n        flatLayer.map(\r\n          (v) => (v.address = `${outGroupImpose.address}.${outGroupImpose.id}`)\r\n        );\r\n        outGroupImpose.items = flatLayer;\r\n\r\n        return outGroupImpose;\r\n      };\r\n\r\n      request2$ = request1$.map((obs, idx) =>\r\n        obs.pipe(\r\n          map((items) =>\r\n            compositeCatalog[idx].groupImpose\r\n              ? pushImposeGroup(items, idx)\r\n              : items\r\n          )\r\n        )\r\n      );\r\n    } else {\r\n      request2$ = request1$;\r\n    }\r\n\r\n    // concat Group -----------------------------------------------------\r\n    const request3$ = zip(...request2$).pipe(\r\n      map(\r\n        (output: CatalogItem[]) => [].concat(...output) // [].concat.apply([], result1\r\n      )\r\n    );\r\n\r\n    // merge Group (first level only) -----------------------------------------------------\r\n    const groupByGroupId = (data, keyFn) =>\r\n      data.reduce((acc, group) => {\r\n        const groupId = keyFn(group);\r\n        const ind = acc.find((x) => x.id === groupId);\r\n\r\n        if (!ind) {\r\n          acc[acc.length] = group;\r\n        } else {\r\n          const ix = acc.indexOf(ind);\r\n          if (acc[ix].address.split('|').indexOf(group.address) === -1) {\r\n            acc[ix].address = `${acc[ix].address}|${group.address}`;\r\n          }\r\n          acc[ix].items.push(...group.items);\r\n        }\r\n        return acc;\r\n      }, []);\r\n\r\n    // merge Layer for each Level (catalog, group(recursive))\r\n    const recursiveGroupByLayerAddress = (items, keyFn) =>\r\n      items.reduce((acc, item, idx, arr) => {\r\n        const layerTitle = keyFn(item);\r\n        const outItem = Object.assign({}, item);\r\n\r\n        if (item.type === CatalogItemType.Layer) {\r\n          // same title, same address => result: only one item is keep\r\n\r\n          // same title, address diff\r\n          const indicesMatchTitle = [];\r\n          const diffAddress = arr.filter((x, i) => {\r\n            let bInd = false;\r\n            if (x.title === layerTitle && x.type === CatalogItemType.Layer) {\r\n              if (i !== idx && x.address !== item.address) {\r\n                bInd = true;\r\n              }\r\n              indicesMatchTitle.push(i);\r\n            }\r\n            return bInd;\r\n          }); // $& i !== idx\r\n\r\n          if (diffAddress.length > 0) {\r\n            const nPosition = indicesMatchTitle.findIndex((x) => x === idx) + 1;\r\n            outItem.title = `${item.title} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n          }\r\n\r\n          const exist = acc.find(\r\n            (x) => x.title === outItem.title && x.type === CatalogItemType.Layer\r\n          );\r\n          if (!exist) {\r\n            acc[acc.length] = outItem;\r\n          }\r\n        } else if (item.type === CatalogItemType.Group) {\r\n          outItem.items = recursiveGroupByLayerAddress(\r\n            item.items,\r\n            (layer) => layer.title\r\n          );\r\n          acc[acc.length] = outItem;\r\n        }\r\n\r\n        return acc;\r\n      }, []);\r\n\r\n    const request4$ = request3$.pipe(\r\n      map((output) => groupByGroupId(output, (group) => group.id)),\r\n      map((output) => [].concat(...output)),\r\n      map((data) => recursiveGroupByLayerAddress(data, (layer) => layer.title))\r\n    );\r\n\r\n    return request4$;\r\n  }\r\n\r\n  private getCatalogCapabilities(catalog: Catalog): Observable<any> {\r\n    const sType: string = TypeCatalog[catalog.type as string];\r\n    return this.capabilitiesService\r\n      .getCapabilities(sType as any, catalog.url, catalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.catalog.unavailableTitle'\r\n          );\r\n          const message =\r\n          catalog.title ? this.languageService.translate.instant(\r\n            'igo.geo.catalog.unavailable',\r\n            { value: catalog.title }\r\n          ) : this.languageService.translate.instant(\r\n            'igo.geo.catalog.someUnavailable'\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          console.error(e);\r\n          return of(undefined);\r\n        })\r\n      );\r\n  }\r\n\r\n  private prepareCatalogItemLayer(layer, idParent, layersQueryFormat, catalog) {\r\n    const configuredQueryFormat = this.retrieveLayerInfoFormat(\r\n      layer.Name,\r\n      layersQueryFormat\r\n    );\r\n\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const legendOptions =\r\n      catalog.showLegend && layer.Style\r\n        ? this.capabilitiesService.getStyle(layer.Style)\r\n        : undefined;\r\n\r\n    const params = Object.assign({}, catalog.queryParams, {\r\n      LAYERS: layer.Name,\r\n      VERSION: catalog.version\r\n    } as WMSDataSourceOptionsParams);\r\n\r\n    const baseSourceOptions = {\r\n      type: 'wms',\r\n      url: catalog.url,\r\n      crossOrigin: catalog.setCrossOriginAnonymous ? 'anonymous' : undefined,\r\n      queryFormat: configuredQueryFormat,\r\n      queryHtmlTarget:\r\n        configuredQueryFormat === QueryFormat.HTML ||\r\n        configuredQueryFormat === QueryFormat.HTMLGML2\r\n          ? 'iframe'\r\n          : undefined,\r\n      optionsFromCapabilities: true\r\n    };\r\n\r\n    const sourceOptions = Object.assign(\r\n      {},\r\n      baseSourceOptions,\r\n      catalog.sourceOptions,\r\n      { params }\r\n    ) as WMSDataSourceOptions;\r\n\r\n    let layerTitle;\r\n    if (catalog.forcedProperties) {\r\n      for (const property of catalog.forcedProperties) {\r\n        if (layer.Name === property.layerName && property.title) {\r\n          layerTitle = property.title;\r\n        }\r\n      }\r\n    }\r\n\r\n    let abstract;\r\n    if (layer.Abstract) {\r\n      abstract = layer.Abstract;\r\n    } else if (!layer.Abstract && catalog.abstract) {\r\n      abstract = catalog.abstract;\r\n    }\r\n\r\n    const layerPrepare = {\r\n      id: generateIdFromSourceOptions(sourceOptions),\r\n      type: CatalogItemType.Layer,\r\n      title: layerTitle !== undefined ? layerTitle : layer.Title,\r\n      address: idParent,\r\n      externalProvider: catalog.externalProvider || false,\r\n      options: {\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined,\r\n          abstract,\r\n          type: baseSourceOptions.type\r\n        },\r\n        legendOptions,\r\n        tooltip: { type: catalog.tooltipType },\r\n        sourceOptions\r\n      }\r\n    } as CatalogItem;\r\n\r\n    return ObjectUtils.removeUndefined(layerPrepare);\r\n  }\r\n\r\n  private prepareCatalogItemGroup(\r\n    itemListIn,\r\n    regexes,\r\n    idGroup,\r\n    layersQueryFormat,\r\n    catalog\r\n  ) {\r\n    const groupPrepare = {\r\n      id: idGroup,\r\n      type: CatalogItemType.Group,\r\n      title: itemListIn.Title,\r\n      address: catalog.id,\r\n      externalProvider: catalog.externalProvider || false,\r\n      sortDirection: catalog.sortDirection, // propagate sortDirection\r\n      items: itemListIn.Layer.reduce((items: CatalogItem[], layer: any) => {\r\n        if (layer.Layer !== undefined) {\r\n          // recursive, check next level\r\n          const idGroupItemNextLevel =\r\n            idGroup + `.group.${layer.Name || layer.Layer[0].Name}`;\r\n          const groupItem: CatalogItemGroup = this.prepareCatalogItemGroup(\r\n            layer,\r\n            regexes,\r\n            idGroupItemNextLevel,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(groupItem);\r\n        } else {\r\n          if (this.testLayerRegexes(layer.Name, regexes) === false) {\r\n            return items;\r\n          }\r\n\r\n          const layerItem: CatalogItemLayer<ImageLayerOptions> = this.prepareCatalogItemLayer(\r\n            layer,\r\n            idGroup,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(layerItem);\r\n        }\r\n        return items;\r\n      }, [])\r\n    };\r\n    return groupPrepare;\r\n  }\r\n\r\n  private includeRecursiveItems(\r\n    catalog: Catalog,\r\n    itemListIn: any,\r\n    itemsPrepare: CatalogItem[],\r\n    loopLevel: number = 0\r\n  ) {\r\n    // Dig all levels until last level (layer object are not defined on last level)\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n    if (!itemListIn.Layer) {\r\n      return;\r\n    }\r\n\r\n    for (const item of itemListIn.Layer) {\r\n      if (item.Layer !== undefined) {\r\n        // recursive, check next level\r\n        this.includeRecursiveItems(catalog, item, itemsPrepare, loopLevel + 1);\r\n        continue;\r\n      }\r\n\r\n      const layersQueryFormat = this.findCatalogInfoFormat(catalog);\r\n\r\n      // group(with layers) and layer(without group) level 1\r\n      if (loopLevel !== 0) {\r\n        // TODO: Slice that into multiple methods\r\n        // Define object of group layer\r\n        const idGroupItem = `catalog.group.${itemListIn.Name || item.Name}`;\r\n        const groupItem = this.prepareCatalogItemGroup(\r\n          itemListIn,\r\n          regexes,\r\n          idGroupItem,\r\n          layersQueryFormat,\r\n          catalog\r\n        );\r\n\r\n        if (groupItem.items.length !== 0) {\r\n          itemsPrepare.push(groupItem);\r\n        }\r\n\r\n        // Break the group (don't add a group of layer for each of their layer!)\r\n        break;\r\n      } else {\r\n        // layer without group\r\n        if (this.testLayerRegexes(item.Name, regexes) !== false) {\r\n          const layerItem = this.prepareCatalogItemLayer(\r\n            item,\r\n            catalog.id,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n          itemsPrepare.push(layerItem);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private getWMTSItems(\r\n    catalog,\r\n    capabilities: { [key: string]: any }\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers = capabilities.Contents.Layer;\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    if (\r\n      capabilities.ServiceIdentification &&\r\n      capabilities.ServiceIdentification.Abstract &&\r\n      capabilities.ServiceIdentification.Abstract.length) {\r\n      catalog.abstract = capabilities.ServiceIdentification.Abstract;\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n        let forcedTitle;\r\n        if (catalog.forcedProperties) {\r\n          for (const property of catalog.forcedProperties) {\r\n            if (layer.Title === property.layerName && property.title) {\r\n              forcedTitle = property.title;\r\n            }\r\n          }\r\n        }\r\n        if (this.testLayerRegexes(layer.Identifier, regexes) === false) {\r\n          return undefined;\r\n        }\r\n        const params = Object.assign({}, catalog.queryParams, {\r\n          version: '1.0.0'\r\n        });\r\n        const baseSourceOptions = {\r\n          type: 'wmts',\r\n          url: catalog.url,\r\n          crossOrigin: catalog.setCrossOriginAnonymous\r\n            ? 'anonymous'\r\n            : undefined,\r\n          layer: layer.Identifier,\r\n          matrixSet: catalog.matrixSet,\r\n          optionsFromCapabilities: true,\r\n          requestEncoding: catalog.requestEncoding || 'KVP',\r\n          style: 'default'\r\n        } as WMTSDataSourceOptions;\r\n        const sourceOptions = Object.assign(\r\n          {},\r\n          baseSourceOptions,\r\n          catalog.sourceOptions,\r\n          { params }\r\n        ) as WMTSDataSourceOptions;\r\n\r\n        return ObjectUtils.removeUndefined({\r\n          id: generateIdFromSourceOptions(sourceOptions),\r\n          type: CatalogItemType.Layer,\r\n          title: forcedTitle !== undefined ? forcedTitle : layer.Title,\r\n          address: catalog.id,\r\n          externalProvider: catalog.externalProvider,\r\n          options: {\r\n            sourceOptions,\r\n            metadata: {\r\n              url: undefined,\r\n              extern: undefined,\r\n              abstract: catalog.abstract,\r\n              type: baseSourceOptions.type\r\n            }\r\n          }\r\n        } as CatalogItem);\r\n      })\r\n      .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n  }\r\n\r\n  private getArcGISRESTItems(\r\n    catalog,\r\n    capabilities\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers =\r\n    !capabilities.layers ? [] : capabilities.layers.filter(layer => !layer.type || layer.type === 'Feature Layer');\r\n    if (!capabilities.layers) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant('igo.geo.catalog.someUnavailable'),\r\n        this.languageService.translate.instant('igo.geo.catalog.unavailableTitle')\r\n      );\r\n    }\r\n\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    let abstract;\r\n    if (capabilities.serviceDescription && capabilities.serviceDescription.length) {\r\n      const regex = /(<([^>]+)>)/ig;\r\n      abstract = capabilities.serviceDescription.replace(regex, '');\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n        let forcedTitle;\r\n        if (catalog.forcedProperties) {\r\n          for (const property of catalog.forcedProperties) {\r\n            if (layer.name === property.layerName && property.title) {\r\n              forcedTitle = property.title;\r\n            }\r\n          }\r\n        }\r\n        if (this.testLayerRegexes(layer.id, regexes) === false) {\r\n          return undefined;\r\n        }\r\n        const baseSourceOptions = {\r\n          type: TypeCatalog[catalog.type],\r\n          url: catalog.url,\r\n          crossOrigin: catalog.setCrossOriginAnonymous\r\n            ? 'anonymous'\r\n            : undefined,\r\n          layer: layer.id as string,\r\n          queryable: true,\r\n          queryFormat: 'esrijson',\r\n          matrixSet: catalog.matrixSet,\r\n          optionsFromCapabilities: true,\r\n          style: 'default'\r\n        } as ArcGISRestDataSourceOptions;\r\n        const sourceOptions = Object.assign(\r\n          {},\r\n          baseSourceOptions,\r\n          catalog.sourceOptions\r\n        ) as ArcGISRestDataSourceOptions;\r\n        return ObjectUtils.removeUndefined({\r\n          id: generateIdFromSourceOptions(sourceOptions),\r\n          type: CatalogItemType.Layer,\r\n          title: forcedTitle !== undefined ? forcedTitle : layer.name,\r\n          externalProvider: catalog.externalProvider,\r\n          address: catalog.id,\r\n          options: {\r\n            sourceOptions,\r\n            minResolution: getResolutionFromScale(layer.maxScale),\r\n            maxResolution: getResolutionFromScale(layer.minScale),\r\n            metadata: {\r\n              url: undefined,\r\n              extern: undefined,\r\n              abstract,\r\n              type: baseSourceOptions.type\r\n            },\r\n            title: forcedTitle !== undefined ? forcedTitle : layer.name\r\n          }\r\n        } as CatalogItem);\r\n      })\r\n      .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n  }\r\n\r\n  private testLayerRegexes(layerName: string, regexes: RegExp[]): boolean {\r\n    if (regexes.length === 0) {\r\n      return true;\r\n    }\r\n    return regexes.find((regex: RegExp) => regex.test(layerName)) !== undefined;\r\n  }\r\n\r\n  private retrieveLayerInfoFormat(\r\n    layerNameFromCatalog: string,\r\n    layersQueryFormat: { layer: string; queryFormat: QueryFormat }[]\r\n  ): QueryFormat {\r\n    const currentLayerInfoFormat = layersQueryFormat.find(\r\n      (f) => f.layer === layerNameFromCatalog\r\n    );\r\n    const baseInfoFormat = layersQueryFormat.find((f) => f.layer === '*');\r\n    let queryFormat: QueryFormat;\r\n    if (currentLayerInfoFormat) {\r\n      queryFormat = currentLayerInfoFormat.queryFormat;\r\n    } else if (baseInfoFormat) {\r\n      queryFormat = baseInfoFormat.queryFormat;\r\n    }\r\n    return queryFormat;\r\n  }\r\n\r\n  private findCatalogInfoFormat(\r\n    catalog: Catalog\r\n  ): { layer: string; queryFormat: QueryFormat }[] {\r\n    const layersQueryFormat: { layer: string; queryFormat: QueryFormat }[] = [];\r\n    if (!catalog.queryFormat) {\r\n      return layersQueryFormat;\r\n    }\r\n    Object.keys(catalog.queryFormat).forEach((configuredInfoFormat) => {\r\n      if (catalog.queryFormat[configuredInfoFormat] instanceof Array) {\r\n        catalog.queryFormat[configuredInfoFormat].forEach((layerName) => {\r\n          if (\r\n            !layersQueryFormat.find((specific) => specific.layer === layerName)\r\n          ) {\r\n            layersQueryFormat.push({\r\n              layer: layerName,\r\n              queryFormat: configuredInfoFormat as QueryFormat\r\n            });\r\n          }\r\n        });\r\n      } else {\r\n        if (\r\n          !layersQueryFormat.find(\r\n            (specific) =>\r\n              specific.layer === catalog.queryFormat[configuredInfoFormat]\r\n          )\r\n        ) {\r\n          layersQueryFormat.push({\r\n            layer: catalog.queryFormat[configuredInfoFormat],\r\n            queryFormat: configuredInfoFormat as QueryFormat\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return layersQueryFormat;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <igo-catalog-browser-group\r\n        [catalog]=\"catalog\"\r\n        [group]=\"item\"\r\n        [state]=\"store.state\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [collapsed]=\"(store.count === 1) ? false : true\"\r\n        [toggleCollapsed]=\"toggleCollapsedGroup\"\r\n        (addedChange)=\"onGroupAddedChange($event)\"\r\n        (layerAddedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-group>\r\n    </ng-container>\r\n\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"store.state.get(item).added\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { zip, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore, EntityStoreWatcher } from '@igo2/common';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Component to browse a catalog's groups and layers and display them on a map.\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser',\r\n  templateUrl: './catalog-browser.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Catalog items store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<CatalogItem>;\r\n\r\n // private resolution$$: Subscription;\r\n\r\n  get resolution$(): BehaviorSubject<number> { return this.map.viewController.resolution$; }\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Store holding the catalog's items\r\n   */\r\n  @Input() store: EntityStore<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether a group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsedGroup: boolean = true;\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    const currentItems = this.map.layers.map((layer: Layer) => {\r\n      return {\r\n        id: layer.options.source.id,\r\n        title: layer.title,\r\n        type: CatalogItemType.Layer\r\n      };\r\n    });\r\n    this.store.state.updateMany(currentItems, { added: true }, true);\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.catalog.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n      });\r\n    }\r\n\r\n    const catalogShowLegend = this.catalog ? this.catalog.showLegend : false;\r\n    this.catalogAllowLegend = catalogShowLegend ? catalogShowLegend : this.catalogAllowLegend;\r\n\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Layer added event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const layer = event.layer;\r\n    this.store.state.update(layer, { added: event.added }, false);\r\n    event.added ? this.addLayerToMap(layer) : this.removeLayerFromMap(layer);\r\n  }\r\n\r\n  /**\r\n   * When a froup is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Group added event\r\n   */\r\n  onGroupAddedChange(event: { added: boolean; group: CatalogItemGroup }) {\r\n    const group = event.group;\r\n    this.store.state.update(group, { added: event.added }, false);\r\n    event.added ? this.addGroupToMap(group) : this.removeGroupFromMap(group);\r\n  }\r\n\r\n  /**\r\n   * Add layer to map\r\n   * @param layer Catalog layer\r\n   */\r\n  private addLayerToMap(layer: CatalogItemLayer) {\r\n    this.addLayersToMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove layer from map\r\n   * @param layer Catalog layer\r\n   */\r\n  private removeLayerFromMap(layer: CatalogItemLayer) {\r\n    this.removeLayersFromMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add multiple layers to map\r\n   * @param layers Catalog layers\r\n   */\r\n  private addLayersToMap(layers: CatalogItemLayer[]) {\r\n    const layers$ = layers.map((layer: CatalogItemLayer) => {\r\n      if (!layer.options.sourceOptions.optionsFromApi) {\r\n        layer.options.sourceOptions.optionsFromApi = true;\r\n      }\r\n      return this.layerService.createAsyncLayer(layer.options);\r\n    });\r\n\r\n    zip(...layers$).subscribe((oLayers: Layer[]) => {\r\n      this.store.state.updateMany(layers, { added: true });\r\n      this.map.addLayers(oLayers);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove multiple layers from map\r\n   * @param layers Catalog layers\r\n   */\r\n  private removeLayersFromMap(layers: CatalogItemLayer[]) {\r\n    layers.forEach((layer: CatalogItemLayer) => {\r\n      this.store.state.update(layer, { added: false });\r\n      if (layer.options.baseLayer === true) {\r\n        const oLayer = this.map.getLayerById(layer.options.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      } else {\r\n        const oLayer = this.map.getLayerById(layer.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sort the layers by title. asc or desc.\r\n   * @internal\r\n   */\r\n  private sortCatalogItemsByTitle(items: CatalogItem[], direction) {\r\n    const returnItem = items.sort((a, b) => {\r\n      const titleA = a.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      const titleB = b.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n      if (titleA < titleB) {\r\n        return -1;\r\n      }\r\n      if (titleA > titleB) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    switch (direction) {\r\n      case 'asc':\r\n        return returnItem;\r\n      case 'desc':\r\n        return returnItem.reverse();\r\n      default:\r\n        return items;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add all the layers of a group to map\r\n   * @param group Catalog group\r\n   */\r\n  private addGroupToMap(group: CatalogItemGroup) {\r\n    let layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === false;\r\n    });\r\n    if (group.sortDirection !== undefined) {\r\n      layers = this.sortCatalogItemsByTitle(layers, group.sortDirection);\r\n    }\r\n    this.addLayersToMap(layers.reverse() as CatalogItemLayer[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all the layers of a group from map\r\n   * @param group Catalog group\r\n   */\r\n  private removeGroupFromMap(group: CatalogItemGroup) {\r\n    const layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === true;\r\n    });\r\n    this.removeLayersFromMap(layers as CatalogItemLayer[]);\r\n  }\r\n}\r\n","<ng-container *ngIf=\"legendItems$ | async as items\">\r\n  <ng-container *ngIf=\"items.length; else noItems\">\r\n    <ng-container *ngFor=\"let item of items.slice().reverse()\" #renderedLegends>\r\n      <div *ngIf=\"getLegend; else noItems\">\r\n        <mat-list-item *ngIf=\"item.title\">\r\n          <mat-icon\r\n            id=\"legend-toggle\"\r\n            class=\"igo-chevron\"\r\n            mat-list-avatar\r\n            igoCollapse\r\n            [target]=\"legend\"\r\n            [collapsed]=\"(item.collapsed)\"\r\n            (toggle)=\"toggleLegendItem($event, item)\"\r\n            svgIcon=\"chevron-up\">\r\n          </mat-icon>\r\n          <h4 matLine>{{computeItemTitle(item) | async}} </h4>\r\n        </mat-list-item>\r\n        <div #legend class=\"igo-layer-legend\" [ngClass]=\"{'with-title': item.title}\">\r\n          <div *ngIf=\"currentStyle !== undefined\">\r\n              <mat-form-field>\r\n                <mat-select tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n                  [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" [(ngModel)]=\"currentStyle\"\r\n                  (selectionChange)=\"onChangeStyle()\">\r\n                  <mat-option *ngFor=\"let style of styles\" [value]=\"style.name\">{{style.title}}</mat-option>\r\n                </mat-select>\r\n            </mat-form-field>\r\n          </div>\r\n          <div *ngIf=\"!(item.collapsed)\">\r\n            <div *ngIf=\"item.url\">\r\n              <img #renderedLegend id=\"{{item.title}}\" (load)=\"onLoadImage(item.title)\"\r\n                src=\"{{[item.imgGraphValue]}}\"\r\n                alt=\"{{'igo.geo.layer.legend.loadingLegendText' | translate}}\">\r\n              <small *ngIf=\"imagesHeight[item.title]<16\">\r\n                  {{'igo.geo.layer.legend.noLegendScale' | translate}}\r\n              </small>\r\n            </div>\r\n            <div\r\n              [ngStyle]=\"item.style\"\r\n              [innerHTML]=\"item.html | sanitizeHtml\"\r\n              *ngIf=\"item.html\">\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </ng-container>\r\n  </ng-container>\r\n\r\n  <ng-template #noItems>\r\n    <small>\r\n      {{'igo.geo.layer.legend.noLegendText' | translate}}\r\n    </small>\r\n  </ng-template>\r\n\r\n</ng-container>\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Component, Input, OnInit, OnDestroy, ChangeDetectionStrategy, ViewChildren, ElementRef, ChangeDetectorRef } from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, of, Observable } from 'rxjs';\r\n\r\nimport { Legend } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { Layer, ItemStyleOptions } from '../shared/layers';\r\nimport { LegendMapViewOptions } from '../shared/layers/layer.interface';\r\nimport { CapabilitiesService } from '../../datasource/shared/capabilities.service';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { WMSDataSource, WMSDataSourceOptions } from '../../datasource';\r\nimport { SecureImagePipe } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend',\r\n  templateUrl: './layer-legend.component.html',\r\n  styleUrls: ['./layer-legend.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendComponent implements OnInit, OnDestroy {\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  /**\r\n   * Observable of the legend items\r\n   */\r\n  legendItems$: BehaviorSubject<Legend[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Subscription to the map's resolution\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  /**\r\n   * The available styles\r\n   */\r\n  public styles;\r\n\r\n  /**\r\n   * The style used to make the legend\r\n   */\r\n  public currentStyle;\r\n\r\n  /**\r\n   * The scale used to make the legend\r\n   */\r\n  private scale: number = undefined;\r\n\r\n  /**\r\n   * The extent used to make the legend\r\n   */\r\n  private view: LegendMapViewOptions = undefined;\r\n  /**\r\n   * Get list of images display\r\n   */\r\n  @ViewChildren('renderedLegend') renderedLegends: QueryList<ElementRef>;\r\n\r\n  /**\r\n   * List of size of images displayed\r\n   */\r\n  public imagesHeight: { [srcKey: string]: number } = {};\r\n\r\n  /**\r\n   * Layer\r\n   */\r\n  @Input() layer: Layer;\r\n\r\n  /**\r\n   * if getLegendGraphic is authorized\r\n   */\r\n  public getLegend = true;\r\n\r\n  /**\r\n   * activeLegend\r\n   */\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private languageService: LanguageService,\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * On init, subscribe to the map's resolution and update the legend accordingly\r\n   */\r\n  ngOnInit() {\r\n    let lastlLegend = this.layer.legend;\r\n    this.styles = this.listStyles();\r\n    const sourceOptions = this.layer.options.source.options as any;\r\n    if (sourceOptions && sourceOptions.params && sourceOptions.params.STYLES) {\r\n      // if a styles is provided into the layers wms params\r\n      this.currentStyle = this.styles.find(style => style.name === sourceOptions.params.STYLES).name;\r\n    } else if (!lastlLegend) {\r\n      // if no legend is manually provided\r\n      if (this.styles && this.styles.length > 1) {\r\n        this.currentStyle = this.styles[0].name;\r\n      }\r\n    } else if (this.styles && this.styles.length > 1) {\r\n      this.currentStyle = lastlLegend[0].currentStyle;\r\n    }\r\n    if (typeof this.layer.options.legendOptions !== 'undefined' && this.layer.options.legendOptions.display === false) {\r\n      lastlLegend = [];\r\n    } else {\r\n      lastlLegend = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    }\r\n\r\n    if (this.updateLegendOnResolutionChange || (sourceOptions as WMSDataSourceOptions).contentDependentLegend) {\r\n      const state$ = this.layer.map.viewController.state$;\r\n      this.state$$ = state$.subscribe(() => this.onViewControllerStateChange());\r\n    } else if (lastlLegend && lastlLegend.length !== 0) {\r\n      this.legendItems$.next(lastlLegend);\r\n      for (const legend of lastlLegend) {\r\n        this.getLegendGraphic(legend);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On destroy, unsubscribe to the map's view state\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  getLegendGraphic(item: Legend) {\r\n    if (item.url) {\r\n      const secureIMG = new SecureImagePipe(this.http);\r\n      secureIMG.transform(item.url).pipe(\r\n        catchError((err) => {\r\n          if (err.error) {\r\n            err.error.caught = true;\r\n            this.getLegend = false;\r\n            this.cdRef.detectChanges();\r\n            return err;\r\n          }\r\n        })\r\n        ).subscribe(obsLegGraph => {\r\n          const idx = this.legendItems$.value.findIndex(leg => leg.title === item.title);\r\n          const legendGraph = obsLegGraph as string;\r\n          this.legendItems$.value[idx].imgGraphValue = legendGraph;\r\n          this.cdRef.detectChanges();\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  toggleLegendItem(collapsed: boolean, item: Legend) {\r\n    item.collapsed = collapsed;\r\n  }\r\n\r\n  private transfertToggleLegendItem(newLegends: Legend[]): Legend[] {\r\n    const outLegends: Legend[] = newLegends;\r\n    const lastLegends = this.layer.legend;\r\n    for (let i = 0; i < lastLegends.length; i++) {\r\n      outLegends[i].collapsed = lastLegends[i].collapsed;\r\n   }\r\n    return outLegends;\r\n  }\r\n\r\n  computeItemTitle(layerLegend): Observable<string> {\r\n    const layerOptions = this.layer.dataSource.options as any;\r\n    if (layerOptions.type !== 'wms') {\r\n      return of(layerLegend.title);\r\n    }\r\n\r\n    const layers = layerOptions.params.LAYERS.split(',');\r\n    const localLayerOptions = JSON.parse(JSON.stringify(layerOptions)); // to avoid to alter the original options.\r\n    localLayerOptions.params.LAYERS = layers.find(layer => layer === layerLegend.title);\r\n    return this.capabilitiesService\r\n      .getWMSOptions(localLayerOptions)\r\n      .pipe(map(wmsDataSourceOptions => {\r\n        return wmsDataSourceOptions._layerOptionsFromSource.title;\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * On resolution change, compute the effective scale level and update the\r\n   * legend accordingly.\r\n   * @param resolution Map resolution\r\n   */\r\n  private onViewControllerStateChange() {\r\n    this.view = {\r\n      resolution: this.layer.map.viewController.getResolution(),\r\n      extent: this.layer.map.viewController.getExtent(),\r\n      projection: this.layer.map.viewController.getOlProjection().getCode(),\r\n      scale: this.layer.map.viewController.getScale(),\r\n      size: this.layer.map.ol.getSize()\r\n    } as LegendMapViewOptions;\r\n    this.updateLegend();\r\n  }\r\n\r\n  /**\r\n   * Update the legend with scale level and style define\r\n   */\r\n  private updateLegend() {\r\n    let legendItems = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    if (this.layer.legend && this.layer.legend.length > 1) { legendItems = this.transfertToggleLegendItem(legendItems); }\r\n    this.layer.legend = legendItems;\r\n\r\n    if (legendItems.length === 0 && this.legendItems$.value.length === 0) {\r\n      return;\r\n    }\r\n    this.legendItems$.next(legendItems);\r\n    for (const legend of this.legendItems$.value) {\r\n      this.getLegendGraphic(legend);\r\n    }\r\n  }\r\n\r\n  private listStyles() {\r\n    const layerOptions = this.layer.options;\r\n    if (layerOptions && layerOptions.legendOptions) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.layer.legend.default');\r\n      let stylesAvailable = [{ name: '', title } as ItemStyleOptions];\r\n      if (layerOptions.legendOptions.stylesAvailable) {\r\n        stylesAvailable = stylesAvailable.concat(layerOptions.legendOptions.stylesAvailable.filter(sA => (\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'default' &&\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'defaut')));\r\n      }\r\n      stylesAvailable.filter(sa => !sa.title).map((sa) => sa.title = sa.name);\r\n      stylesAvailable.map(s => s.title = s.title.charAt(0).toUpperCase() + s.title.slice(1).replace(/_/g, ' '));\r\n      return stylesAvailable;\r\n    }\r\n    return ;\r\n  }\r\n\r\n  onChangeStyle() {\r\n    this.updateLegend();\r\n    let STYLES = '';\r\n    if (this.layer.dataSource instanceof WMSDataSource) {\r\n      this.layer.dataSource.ol.getParams().LAYERS.split(',').map(layer =>\r\n        STYLES += this.currentStyle + ','\r\n      );\r\n      STYLES = STYLES.slice(0, -1);\r\n      this.layer.dataSource.ol.updateParams({ STYLES });\r\n    }\r\n  }\r\n\r\n  onLoadImage(id: string) {\r\n    let elemRef: HTMLImageElement;\r\n    if (this.renderedLegends.length === 1) {\r\n      elemRef = this.renderedLegends.first.nativeElement as HTMLImageElement;\r\n    } else {\r\n      elemRef = this.renderedLegends.find(renderedLegend => renderedLegend.nativeElement.id === id).nativeElement as HTMLImageElement;\r\n    }\r\n    this.imagesHeight[id] = elemRef.height;\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"haveGroup()\" mat-list-avatar svgIcon=\"blank\"></mat-icon>\r\n  <h4 mat-line matTooltipShowDelay=\"500\" [ngClass]=\"(catalogAllowLegend)?'igo-cataloglayer-title':''\" (click)=\"askForLegend($event)\" [matTooltip]=\"computeTitleTooltip()\">{{title}}</h4>\r\n\r\n    <button *ngIf=\"layer.externalProvider\"\r\n      disabled=\"true\"\r\n      mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloglayer-external-icon\"\r\n      *ngIf=\"layer.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.layer' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n  <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n\r\n  <button\r\n    (mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"computeTooltip() | translate\"\r\n    [color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n    (click)=\"onToggleClick($event)\">\r\n    <mat-icon\r\n       matBadge=\"icon\"\r\n       igoMatBadgeIcon=\"eye-off\"\r\n       igoMatBadgeInverseColor=\"true\"\r\n       [matBadgeHidden]=\"isInResolutionsRange()\"\r\n       matBadgeDisabled=\"true\"\r\n       matBadgeSize=\"small\"\r\n       matBadgePosition=\"after\"\r\n       [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-cataloglayer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"(layerLegendShown$ | async) && (igoLayer$ | async) && catalogAllowLegend\"\r\n    [layer]=\"igoLayer$ | async\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\n\r\nimport { CatalogItemLayer } from '../shared';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { first } from 'rxjs/operators';\r\nimport { Layer, TooltipType } from '../../layer/shared/layers';\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\n\r\n/**\r\n * Catalog browser layer item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-layer',\r\n  templateUrl: './catalog-browser-layer.component.html',\r\n  styleUrls: ['./catalog-browser-layer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserLayerComponent implements OnInit, OnDestroy {\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private isPreview$$: Subscription;\r\n  private lastTimeoutRequest;\r\n\r\n  public layerLegendShown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public igoLayer$ = new BehaviorSubject<Layer>(undefined);\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog layer\r\n   */\r\n  @Input() layer: CatalogItemLayer;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added = false;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  @Output() addedLayerIsPreview = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.layer);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.layer) || 'layers';\r\n  }\r\n\r\n  constructor(private layerService: LayerService ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.isInResolutionsRange();\r\n    this.isPreview$$ = this.isPreview$.subscribe(value => this.addedLayerIsPreview.emit(value));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.isPreview$$.unsubscribe();\r\n  }\r\n\r\n  computeTitleTooltip(): string {\r\n      const layerOptions = this.layer.options;\r\n      if (!layerOptions.tooltip) {\r\n        return getEntityTitle(this.layer);\r\n      }\r\n      const layerTooltip = layerOptions.tooltip;\r\n      const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n      switch (layerOptions.tooltip.type) {\r\n        case TooltipType.TITLE:\r\n          return this.layer.title;\r\n        case TooltipType.ABSTRACT:\r\n          if (layerMetadata && layerMetadata.abstract) {\r\n            return layerMetadata.abstract;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        case TooltipType.CUSTOM:\r\n          if (layerTooltip && layerTooltip.text) {\r\n            return layerTooltip.text;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        default:\r\n          return this.layer.title;\r\n      }\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  askForLegend(event) {\r\n    this.layerLegendShown$.next(!this.layerLegendShown$.value);\r\n    this.layerService.createAsyncLayer(this.layer.options).pipe(first())\r\n    .subscribe(layer => this.igoLayer$.next(layer));\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addedChange.emit({ added: true, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.addedChange.emit({ added: false, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  haveGroup(): boolean {\r\n    return !(!this.layer.address || this.layer.address.split('.').length === 1);\r\n  }\r\n\r\n  isInResolutionsRange(): boolean {\r\n    const minResolution = this.layer.options.minResolution || 0;\r\n    const maxResolution = this.layer.options.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      this.resolution >= minResolution && this.resolution <= maxResolution\r\n    );\r\n    return this.inRange$.value;\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.isPreview$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    mat-list-avatar\r\n    svgIcon=\"chevron-up\"\r\n    igoCollapse\r\n    class=\"igo-chevron\"\r\n    [target]=\"items\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"onToggleCollapsed($event)\">\r\n  </mat-icon>\r\n\r\n  <h4 class=\"igo-catalog-group-title\" id=\"catalog-group-title\" mat-line matTooltipShowDelay=\"500\" [matTooltip]=\"title\" (click)=\"onTitleClick()\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"group.externalProvider\"\r\n    disabled=\"true\"\r\n    mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloggroup-external-icon\"\r\n      *ngIf=\"group.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.group' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <ng-container *ngIf=\"(added$ | async) && (preview$ | async) === false; else notadded\">\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.removeFromMap' | translate\"\r\n      color=\"warn\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n  </ng-container>\r\n\r\n  <ng-template #notadded>\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.addToMap' | translate\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick()\">\r\n      <mat-icon svgIcon=\"plus\"></mat-icon>\r\n    </button>\r\n  </ng-template>\r\n</mat-list-item>\r\n\r\n<div #items>\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <!-- todo: add display ans manage CatalogItemGroup -->\r\n    </ng-container>\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"state.get(item).added\"\r\n        (addedLayerIsPreview)=\"onLayerPreview($event)\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport type { EntityStateManager } from '@igo2/common';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemGroup,\r\n  CatalogItemLayer,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Catalog browser group item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-group',\r\n  templateUrl: './catalog-browser-group.component.html',\r\n  styleUrls: ['./catalog-browser-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserGroupComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Group's items store\r\n   * @internal\r\n   */\r\n  store = new EntityStore<CatalogItem, CatalogItemState>([]);\r\n\r\n  /**\r\n   * Whether all the layers of the group are added\r\n   * @internal\r\n   */\r\n  added$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  preview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Whether the toggle button is disabled\r\n   * @internal\r\n   */\r\n  disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Catalog group\r\n   */\r\n  @Input() group: CatalogItemGroup;\r\n\r\n  /**\r\n   * Whether the group is collapsed\r\n   */\r\n  @Input() collapsed: boolean = true;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Whether the group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsed: boolean = true;\r\n\r\n  /**\r\n   * Parent catalog's items store state. Groups share a unique\r\n   * EntityState that tracks the group and it's layers state (whether they are added or not).\r\n   * Sharing a unique state would also allow us to expand this component to allow\r\n   * the selection of a layer while unselecting any layer already selected in another group.\r\n   * This could be useful to display some layer info before adding it, for example.\r\n   */\r\n  @Input() state: EntityStateManager<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of the group is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    group: CatalogItemGroup;\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of a layer is clicked\r\n   */\r\n  @Output() layerAddedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return this.group.title;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.load(this.group.items);\r\n    this.evaluateAdded();\r\n    this.evaluateDisabled(this.collapsed);\r\n    if (this.group.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.group.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick() {\r\n    this.added$.value ? this.remove() : this.add();\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleCollapsed(collapsed: boolean) {\r\n    this.evaluateDisabled(collapsed);\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, evaluate if all the layers of the group\r\n   * are now added or removed. If so, consider that the group itself is added\r\n   * or removed.\r\n   * @internal\r\n   * @param event Layer added change event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    this.layerAddedChange.emit(event);\r\n    this.tryToggleGroup(event);\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    this.added$.next(true);\r\n    this.addedChange.emit({\r\n      added: true,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private remove() {\r\n    this.added$.next(false);\r\n    this.addedChange.emit({\r\n      added: false,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  onLayerPreview(event) {\r\n    this.preview$.next(event);\r\n  }\r\n\r\n  /**\r\n   * If all the layers of the group added or removed, add or remove the group itself.\r\n   * @param event The last layer added change event to occur\r\n   */\r\n  private tryToggleGroup(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const added = event.added;\r\n    const layer = event.layer;\r\n\r\n    const layersAdded = this.store.view\r\n      .all()\r\n      .filter((item: CatalogItem) => item.id !== layer.id)\r\n      .map((item: CatalogItem) => this.state.get(item).added || false);\r\n\r\n    if (layersAdded.every(value => value === added)) {\r\n      added ? this.add() : this.remove();\r\n    } else if (this.added$.value === true) {\r\n      this.added$.next(false);\r\n    }\r\n  }\r\n\r\n  private evaluateAdded() {\r\n    const added = this.store.all().every((item: CatalogItem) => {\r\n      return (this.state.get(item).added || false) === true;\r\n    });\r\n    this.added$.next(added);\r\n  }\r\n\r\n  private evaluateDisabled(collapsed: boolean) {\r\n    let disabled = false;\r\n    if (this.toggleCollapsed === false) {\r\n      disabled = collapsed;\r\n    }\r\n    this.disabled$.next(disabled);\r\n  }\r\n\r\n  onTitleClick() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerListToolService {\r\n  public keyword: string;\r\n  public sortAlpha = false;\r\n  public onlyVisible = false;\r\n  public onlyInRange = false;\r\n  public keywordInitialized = false;\r\n  public sortedAlphaInitialized = false;\r\n  public onlyVisibleInitialized = false;\r\n  public onlyInRangeInitialized = false;\r\n\r\n  constructor() {}\r\n\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <mat-checkbox *ngIf=\"selectionMode\"\r\n    class=\"layerCheck\"\r\n    mat-list-icon\r\n    (change)=\"check()\"\r\n    [checked]=\"layerCheck\">\r\n  </mat-checkbox>\r\n  <h4 (click)=\"toggleLegendOnClick()\" matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"layer.visible ?\r\n                  ('igo.geo.layer.hideLayer' | translate) :\r\n                  ('igo.geo.layer.showLayer' | translate)\"\r\n    (click)=\"toggleVisibility()\">\r\n    <mat-icon\r\n      matBadge=\"?\"\r\n      matBadgeColor=\"accent\"\r\n      matBadgeSize=\"small\"\r\n      matBadgePosition=\"after\"\r\n      [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"(layer.visible$ | async) ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <button *ngIf=\"selectionMode\" class=\"selection-eye\"\r\n  mat-icon-button\r\n  [color]=\"layer.visible ? 'primary' : 'default'\"\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"layer.visible ?\r\n                ('igo.geo.layer.hideLayer' | translate) :\r\n                ('igo.geo.layer.showLayer' | translate)\"\r\n  (click)=\"toggleVisibility()\">\r\n  <mat-icon\r\n    matBadge=\"?\"\r\n    matBadgeColor=\"accent\"\r\n    matBadgeSize=\"small\"\r\n    matBadgePosition=\"after\"\r\n    [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n    [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n    [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n  </mat-icon>\r\n</button>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    class=\"actions-button\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]= \"'igo.geo.layer.moreOptions' | translate\"\r\n    mat-icon-button\r\n    color=\"primary\"\r\n    (click)=\"toggleLayerTool()\">\r\n    <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n  </button>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"showLegend$ | async\"\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  Renderer2,\r\n  ElementRef,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { layerIsQueryable } from '../../query/shared/query.utils';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-item',\r\n  templateUrl: './layer-item.component.html',\r\n  styleUrls: ['./layer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerItemComponent implements OnInit, OnDestroy {\r\n  public focusedCls = 'igo-layer-item-focused';\r\n\r\n  @Input()\r\n  get activeLayer() {\r\n    return this._activeLayer;\r\n  }\r\n  set activeLayer(value) {\r\n    if (value && this.layer && value.id === this.layer.id && !this.selectionMode) {\r\n      this.layerTool$.next(true);\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n  }\r\n  private _activeLayer;\r\n\r\n  layerTool$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  queryBadgeHidden$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  @Input()\r\n  get selectAll() {\r\n    return this._selectAll;\r\n  }\r\n  set selectAll(value: boolean) {\r\n    this._selectAll = value;\r\n    if (value === true) {\r\n      this.layerCheck = true;\r\n    }\r\n  }\r\n  private _selectAll = false;\r\n\r\n  @Input() layerCheck;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  layers$: BehaviorSubject<Layer> = new BehaviorSubject<Layer>(undefined);\r\n\r\n  @Input()\r\n  get layer() {\r\n    return this._layer;\r\n  }\r\n  set layer(value) {\r\n    this._layer = value;\r\n    this.layers$.next(value);\r\n  }\r\n  private _layer;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendIfVisible: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() orderable: boolean = true;\r\n\r\n  @Input() lowerDisabled: boolean = false;\r\n\r\n  @Input() raiseDisabled: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Input() selectionMode;\r\n\r\n  @Input() changeDetection;\r\n\r\n  get opacity() {\r\n    return this.layer.opacity * 100;\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.layer.opacity = opacity / 100;\r\n  }\r\n\r\n  @Output() action: EventEmitter<Layer> = new EventEmitter<Layer>(undefined);\r\n  @Output() checkbox = new EventEmitter<{\r\n    layer: Layer;\r\n    check: boolean;\r\n  }>();\r\n\r\n  constructor(\r\n    private networkService: NetworkService,\r\n    private renderer: Renderer2,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  ngOnInit() {\r\n    if (\r\n      this.layer.visible &&\r\n      this.expandLegendIfVisible &&\r\n      this.layer.firstLoadComponent === true\r\n    ) {\r\n      this.layer.firstLoadComponent = false;\r\n      this.layer.legendCollapsed = false;\r\n    }\r\n    this.toggleLegend(this.layer.legendCollapsed);\r\n    this.updateQueryBadge();\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layer && this.layer.options.active) {\r\n        this.layerTool$.next(true);\r\n        this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n      }\r\n    });\r\n\r\n    if (this.changeDetection) {\r\n      this.changeDetection.subscribe(() => this.cdRef.detectChanges());\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    this.toggleLegend(this.showLegend$.value);\r\n  }\r\n\r\n  toggleVisibility() {\r\n    this.layer.visible = !this.layer.visible;\r\n    if (this.toggleLegendOnVisibilityChange) {\r\n      this.toggleLegend(!this.layer.visible);\r\n    }\r\n    this.updateQueryBadge();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    if (\r\n      inResolutionRange === false &&\r\n      this.updateLegendOnResolutionChange === true\r\n    ) {\r\n      this.toggleLegend(true);\r\n    }\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n\r\n  private updateQueryBadge() {\r\n    const hidden =\r\n      this.queryBadge === false ||\r\n      this.layer.visible === false ||\r\n      !layerIsQueryable(this.layer);\r\n    this.queryBadgeHidden$.next(hidden);\r\n  }\r\n\r\n  toggleLayerTool() {\r\n    this.layerTool$.next(!this.layerTool$.getValue());\r\n    if (this.layerTool$.getValue() === true) {\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n    this.action.emit(this.layer);\r\n  }\r\n\r\n  public check() {\r\n    this.layerCheck = !this.layerCheck;\r\n    this.checkbox.emit({layer: this.layer, check: this.layerCheck});\r\n  }\r\n}\r\n","export enum LayerListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\nexport enum LayerListSelectVisibleEnum {\r\n  ALL_VISIBLE = 'ALL_VISIBLE',\r\n  ALL_HIDDEN = 'ALL_HIDDEN',\r\n  MIXED = 'MIXED',\r\n  NULL = 'NULL'\r\n}\r\n\r\nexport enum LayerListDisplacement {\r\n  Raise = 'raise',\r\n  Lower = 'lower',\r\n}\r\n","<mat-list>\r\n  <igo-layer-list-tool *ngIf=\"showToolbar$ | async\"\r\n    floatLabel=\"auto\"\r\n    [layersAreAllVisible]=\"layersAreAllVisible\"\r\n    [term]=\"layerFilterAndSortOptions.keyword\"\r\n    [onlyVisible]=\"layerFilterAndSortOptions.onlyVisible\"\r\n    [sortAlpha]=\"layerFilterAndSortOptions.sortAlpha\"\r\n    (appliedFilterAndSort)=\"onAppliedFilterAndSortChange($event)\"\r\n    (selection)=\"toggleSelectionMode($event)\">\r\n  </igo-layer-list-tool>\r\n</mat-list>\r\n\r\n<mat-list-item *ngIf=\"selection\" class=\"select-all\">\r\n  <mat-checkbox\r\n    class=\"select-all-checkbox mat-subheading-2\"\r\n    [color]=\"!selectAllCheck && layersChecked.length > 0 ? 'accent' : 'primary'\"\r\n    (change)=\"selectAll()\"\r\n    [checked]=\"selectAllCheck\"\r\n    [indeterminate]=\"!selectAllCheck && layersChecked.length > 0\"> {{selectAllCheck ? ('igo.geo.layer.deselectAll' | translate) : ('igo.geo.layer.selectAll' | translate)}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n<mat-divider></mat-divider>\r\n\r\n<igo-list #igoList [ngClass]=\"{'igo-list-tools-multi': selection, 'igo-list-tools-single': (layerTool && !selection), 'igo-list-no-tools': (!layerTool && !selection)}\" [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n    <igo-layer-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n      igoListItem\r\n      [layer]=\"layer\"\r\n      [activeLayer]=\"activeLayer\"\r\n      [orderable]=\"orderable && !layer.baseLayer\"\r\n      [lowerDisabled]=\"getLowerLayer().id === layer.id\"\r\n      [raiseDisabled]=\"getUpperLayer().id === layer.id\"\r\n      [queryBadge]=\"queryBadge\"\r\n      [expandLegendIfVisible]=\"expandLegendOfVisibleLayers\"\r\n      [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\"\r\n      [toggleLegendOnVisibilityChange]=\"toggleLegendOnVisibilityChange\"\r\n      [selectionMode]=\"selection\"\r\n      [selectAll]=\"selectAllCheck\"\r\n      [layerCheck]=\"layer.options.check\"\r\n      [changeDetection]=\"layerItemChangeDetection$\"\r\n      (action)=\"toggleLayerTool($event)\"\r\n      (checkbox)=\"layersCheck($event)\">\r\n    </igo-layer-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<igo-panel *ngIf=\"!selection && layerTool && activeLayer\" class=\"igo-layer-actions-container\" [title]=\"activeLayer.title\">\r\n  <div class=\"igo-layer-button-group\">\r\n    <button\r\n      *ngIf=\"isLayerRemovable(activeLayer)\"\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.removeLayer' | translate\"\r\n      (click)=\"removeLayers()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Lower)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabled\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Raise)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabled\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <!-- <label>{{ 'igo.geo.layer.opacity' | translate }} </label> -->\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon [matBadge]=\"badgeOpacity\" matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\" class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [value]=\"opacity\"\r\n          (input)=\"changeOpacity($event)\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          (click) = \"$event.stopPropagation()\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n      *ngIf=\"activeLayerIsValid(activeLayer)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayer' | translate\"\r\n      (click)=\"zoomLayerExtents(activeLayer)\">\r\n      <mat-icon matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n\r\n    <ng-container igoLayerItemToolbar\r\n      [ngTemplateOutlet]=\"templateLayerToolbar\"\r\n      [ngTemplateOutletContext]=\"{layer: activeLayer}\">\r\n    </ng-container>\r\n\r\n    <ng-content select=\"[igoLayerItemToolbar]\"></ng-content>\r\n  </div>\r\n</igo-panel>\r\n\r\n<igo-panel *ngIf=\"selection && layers.length > 0\" class=\"igo-layer-actions-container\" [title]=\"'igo.geo.layer.tools' | translate\">\r\n  <div class=\"actions-buttons-multi\">\r\n    <button\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"isAllLayersRemovable(layersChecked) ? ('igo.geo.layer.removeSelectedLayers' | translate) : 'igo.geo.layer.removeSelectedLayersRestriction' | translate\"\r\n      (click)=\"removeLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"'!'\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"isAllLayersRemovable(layersChecked)\"\r\n                svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"eye-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"statusSelectedLayersCheck === 'ALL_HIDDEN' ? ('igo.geo.layer.showSelectedLayers' | translate) : ('igo.geo.layer.hideSelectedLayers' | translate)\"\r\n      (click)=\"toggleVisibility(layersChecked)\">\r\n      <mat-icon\t[svgIcon]=\"(statusSelectedLayersCheck === 'ALL_HIDDEN') ? 'eye-off' : 'eye'\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabledSelection\"\r\n      (click)=\"lowerLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabledSelection\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabledSelection\"\r\n      (click)=\"raiseLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabledSelection\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\"  class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider *ngIf=\"layersChecked.length\"\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [(ngModel)]=\"checkOpacity\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\"\r\n          (click) = \"$event.stopPropagation()\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n      *ngIf=\"layersChecked.length !== 0 && activeLayersAreValid(layersChecked)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayers' | translate\"\r\n      (click)=\"zoomLayersExtents(layersChecked)\">\r\n      <mat-icon svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n  </div>\r\n</igo-panel>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ContentChild,\r\n  OnInit,\r\n  OnDestroy,\r\n  Output,\r\n  EventEmitter,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { LayerListControlsEnum, LayerListDisplacement } from './layer-list.enum';\r\nimport { LayerListSelectVisibleEnum } from './layer-list.enum';\r\nimport {\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  Subscription,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../../metadata/shared/metadata.interface';\r\nimport { LayerListControlsOptions } from '../layer-list-tool/layer-list-tool.interface';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { LinkedProperties, LayersLink } from '../shared/layers/layer.interface';\r\nimport { MatSliderChange } from '@angular/material/slider';\r\nimport * as olextent from 'ol/extent';\r\n\r\n// TODO: This class could use a clean up. Also, some methods could be moved ealsewhere\r\n@Component({\r\n  selector: 'igo-layer-list',\r\n  templateUrl: './layer-list.component.html',\r\n  styleUrls: ['./layer-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n  thresholdToFilterAndSort = 5;\r\n\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  showToolbar$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public layerTool: boolean;\r\n\r\n  public hideSelectedLayers: boolean = true;\r\n  activeLayer$: BehaviorSubject<Layer> = new BehaviorSubject(undefined);\r\n\r\n  layersChecked: Layer[] = [];\r\n  public selection: boolean;\r\n\r\n  private change$$: Subscription;\r\n  private layers$$: Subscription;\r\n  public layerItemChangeDetection$ = new BehaviorSubject(undefined);\r\n\r\n  @ContentChild('igoLayerItemToolbar', /* TODO: add static flag */ {})\r\n  templateLayerToolbar: TemplateRef<any>;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() ogcButton: boolean = true;\r\n\r\n  @Input() timeButton: boolean = true;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = this.removeProblemLayerInList(value);\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n\r\n  set activeLayer(value: Layer) {\r\n    this._activeLayer = value;\r\n    this.activeLayer$.next(value);\r\n  }\r\n  get activeLayer(): Layer {\r\n    return this._activeLayer;\r\n  }\r\n  private _activeLayer: Layer;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input() layerFilterAndSortOptions: LayerListControlsOptions = {};\r\n\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendOfVisibleLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n\r\n  get keyword(): string {\r\n    return this._keyword;\r\n  }\r\n  set keyword(value: string) {\r\n    this._keyword = value;\r\n    this.next();\r\n  }\r\n  private _keyword = undefined;\r\n\r\n  get onlyVisible(): boolean {\r\n    return this._onlyVisible;\r\n  }\r\n  set onlyVisible(value: boolean) {\r\n    this._onlyVisible = value;\r\n    this.next();\r\n  }\r\n  private _onlyVisible = false;\r\n\r\n  get sortAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha = false;\r\n\r\n  get opacity() {\r\n    return Math.round(this.activeLayer$.getValue().opacity * 100);\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.activeLayer$.getValue().opacity = opacity / 100;\r\n  }\r\n\r\n  get badgeOpacity() {\r\n    if (this.opacity === 100) {\r\n      return;\r\n    }\r\n    return this.opacity;\r\n  }\r\n\r\n  get raiseDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getUpperLayer().id === this.activeLayer.id ||\r\n      this.isUpperBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getLowerLayer().id === this.activeLayer.id ||\r\n      this.isLowerBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get raiseDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.raisableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.lowerableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get checkOpacity() {\r\n    return this.layersCheckedOpacity() * 100;\r\n  }\r\n  set checkOpacity(opacity: number) {\r\n    for (const layer of this.layersChecked) {\r\n      layer.opacity = opacity / 100;\r\n    }\r\n  }\r\n\r\n  get layerListDisplacement(): typeof LayerListDisplacement {\r\n    return LayerListDisplacement;\r\n  }\r\n\r\n  public toggleOpacity = false;\r\n\r\n  public selectAllCheck: boolean;\r\n  public selectAllCheck$ = new BehaviorSubject<boolean>(undefined);\r\n  private selectAllCheck$$: Subscription;\r\n\r\n  constructor(private elRef: ElementRef) { }\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.layers.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.showToolbar$.next(this.computeShowToolbar());\r\n        this.layers$.next(this.computeLayers(this.layers.slice(0)));\r\n        this.appliedFilterAndSort.emit({\r\n          keyword: this.keyword,\r\n          sortAlpha: this.sortAlpha,\r\n          onlyVisible: this.onlyVisible\r\n        });\r\n      });\r\n\r\n    this.selectAllCheck$$ = this.selectAllCheck$.subscribe((value) => {\r\n      this.selectAllCheck = value;\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layers) {\r\n        let checks = 0;\r\n        for (const layer of this.layers) {\r\n          layer.status$.subscribe(valStatus => {\r\n            if (valStatus === 0) {\r\n              this.map.removeLayer(layer);\r\n            }\r\n          });\r\n          if (layer.options.active) {\r\n            this.activeLayer = layer;\r\n            this.layerTool = true;\r\n          }\r\n          if (layer.options.check) {\r\n            checks += 1;\r\n          }\r\n        }\r\n        if (this.excludeBaseLayers) {\r\n          this.selectAllCheck =\r\n            checks ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n              ? true\r\n              : false;\r\n        } else {\r\n          this.selectAllCheck =\r\n            checks === this.layers.filter((lay) => lay.showInLayerList).length\r\n              ? true\r\n              : false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n    this.selectAllCheck$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  activeLayerIsValid(layer: Layer): boolean {\r\n    let valid = false;\r\n    const layerExtent = layer.options.extent;\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    if (layerExtent) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = olextent.containsExtent(maxLayerZoomExtent, layerExtent);\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  activeLayersAreValid(layers: Layer[]): boolean {\r\n    let valid = false;\r\n    const layersExtent = olextent.createEmpty();\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent && !layerExtent.includes(Infinity)) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n\r\n    if (!olextent.isEmpty(layersExtent)) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = (olextent.containsExtent(maxLayerZoomExtent, layersExtent));\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  zoomLayerExtents(layer: Layer) {\r\n    this.map.viewController.zoomToExtent(layer.options.extent);\r\n  }\r\n\r\n  zoomLayersExtents(layers: Layer[]) {\r\n    const layersExtent = olextent.createEmpty() as [number, number, number, number];\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n    this.map.viewController.zoomToExtent(layersExtent);\r\n  }\r\n\r\n  changeOpacity(event: MatSliderChange ){\r\n    this.opacity = event.value;\r\n  }\r\n\r\n  clearKeyword() {\r\n    this.keyword = undefined;\r\n  }\r\n\r\n  getLowerLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex < current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isLowerBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index + 1] &&\r\n      this.layers[index + 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getUpperLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex > current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isUpperBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index - 1] &&\r\n      this.layers[index - 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  moveActiveLayer(activeLayer: Layer, actiontype: LayerListDisplacement) {\r\n    const layersToMove = [activeLayer];\r\n    const sortedLayersToMove = [];\r\n    this.getLinkedLayers(activeLayer, layersToMove);\r\n    this.layers.map(layer => {\r\n      if (layersToMove.indexOf(layer) !== -1) {\r\n        sortedLayersToMove.push(layer);\r\n      }\r\n    });\r\n\r\n    if (actiontype === LayerListDisplacement.Raise) {\r\n      this.raiseLayers(sortedLayersToMove, false);\r\n    } else if (actiontype === LayerListDisplacement.Lower) {\r\n      this.lowerLayers(sortedLayersToMove, false);\r\n    }\r\n  }\r\n\r\n  private getLinkedLayers(activeLayer: Layer, layersList: Layer[]) {\r\n    const linkedLayers = activeLayer.options.linkedLayers as LayersLink;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n\r\n    if (isParentLayer) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        if (!link.properties || link.properties.indexOf(LinkedProperties.ZINDEX) === -1) {\r\n          return;\r\n        }\r\n        link.linkedIds.map(linkedId => {\r\n          const childLayer = this.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n          if (childLayer) {\r\n            if (!layersList.includes(childLayer)) {\r\n              layersList.push(childLayer);\r\n            }\r\n          }\r\n        });\r\n      });\r\n    } else {\r\n      // search for parent layer\r\n      this.layers.map(parentLayer => {\r\n        if (parentLayer.options.linkedLayers?.links) {\r\n          parentLayer.options.linkedLayers.links.map(l => {\r\n            if (\r\n              l.properties?.indexOf(LinkedProperties.ZINDEX) !== -1 &&\r\n              l.bidirectionnal !== false &&\r\n              l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n              layersList.push(parentLayer);\r\n              this.getLinkedLayers(parentLayer, layersList);\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  raisableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const previousLayer = this.layers[mapIndex - 1];\r\n      if (\r\n        previousLayer &&\r\n        previousLayer.baseLayer !== true &&\r\n        !layers.find((lay) => previousLayer.id === lay.id) &&\r\n        currentLayer.baseLayer !== true\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  raisableLayer(index: number) {\r\n    if (index < 1) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index - 1].options.check) {\r\n      return this.raisableLayer(index - 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  raiseLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToRaise = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.raisableLayer(index)) {\r\n        layersToRaise.push(layer);\r\n      }\r\n    }\r\n    this.map.raiseLayers(layersToRaise);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const elements = this.computeElementRef();\r\n        if (!this.isScrolledIntoView(elements[0], elements[1].offsetParent)) {\r\n          elements[0].scrollTop = elements[1].offsetParent.offsetTop;\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  lowerableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const nextLayer = this.layers[mapIndex + 1];\r\n      if (\r\n        nextLayer &&\r\n        nextLayer.baseLayer !== true &&\r\n        !layers.find((lay) => nextLayer.id === lay.id)\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  lowerableLayer(index: number) {\r\n    if (\r\n      index >\r\n      this.layers.filter((lay) => lay.baseLayer !== true).length - 2\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index + 1].options.check) {\r\n      return this.lowerableLayer(index + 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  lowerLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToLower = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.lowerableLayer(index)) {\r\n        layersToLower.push(layer);\r\n      }\r\n    }\r\n    this.map.lowerLayers(layersToLower);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const elements = this.computeElementRef('lower');\r\n        if (!this.isScrolledIntoView(elements[0], elements[1].offsetParent)) {\r\n          elements[0].scrollTop =\r\n            elements[1].offsetParent.offsetTop +\r\n            elements[1].offsetParent.offsetHeight -\r\n            elements[0].clientHeight;\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private computeLayers(layers: Layer[]): Layer[] {\r\n    let layersOut = this.filterLayers(layers);\r\n    if (this.sortAlpha) {\r\n      layersOut = this.sortLayersByTitle(layersOut);\r\n    } else {\r\n      layersOut = this.sortLayersByZindex(layersOut);\r\n    }\r\n    return layersOut;\r\n  }\r\n\r\n  onKeywordChange(term) {\r\n    this.keyword = term;\r\n  }\r\n\r\n  onAppliedFilterAndSortChange(appliedFilter: LayerListControlsOptions) {\r\n    this.keyword = appliedFilter.keyword;\r\n    this.onlyVisible = appliedFilter.onlyVisible;\r\n    this.sortAlpha = appliedFilter.sortAlpha;\r\n  }\r\n\r\n  private filterLayers(layers: Layer[]): Layer[] {\r\n    if (\r\n      this.layerFilterAndSortOptions.showToolbar === LayerListControlsEnum.never\r\n    ) {\r\n      return layers;\r\n    }\r\n    if (!this.keyword && !this.onlyVisible) {\r\n      return layers;\r\n    }\r\n\r\n    const keepLayerIds = layers.map((layer: Layer) => layer.id);\r\n\r\n    layers.forEach((layer: Layer) => {\r\n      const layerOptions = (layer.options as MetadataLayerOptions) || {};\r\n      const dataSourceOptions = layer.dataSource.options || {};\r\n      const metadata = layerOptions.metadata || ({} as MetadataOptions);\r\n      const keywords = metadata.keywordList || [];\r\n      const layerKeywords = keywords.map((kw: string) => {\r\n        return kw.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      });\r\n\r\n      if (this.keyword && layer.title) {\r\n        const localKeyword = this.keyword\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const layerTitle = layer.title\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const dataSourceType = dataSourceOptions.type || '';\r\n        const keywordRegex = new RegExp(localKeyword, 'gi');\r\n        const keywordInList =\r\n          layerKeywords.find((kw: string) => keywordRegex.test(kw)) !==\r\n          undefined;\r\n        if (\r\n          !keywordRegex.test(layerTitle) &&\r\n          !(this.keyword.toLowerCase() === dataSourceType.toLowerCase()) &&\r\n          !keywordInList\r\n        ) {\r\n          const index = keepLayerIds.indexOf(layer.id);\r\n          if (index > -1) {\r\n            keepLayerIds.splice(index, 1);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.onlyVisible && layer.visible === false) {\r\n        const index = keepLayerIds.indexOf(layer.id);\r\n        if (index > -1) {\r\n          keepLayerIds.splice(index, 1);\r\n        }\r\n      }\r\n    });\r\n\r\n    return layers.filter(\r\n      (layer: Layer) => keepLayerIds.indexOf(layer.id) !== -1\r\n    );\r\n  }\r\n\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  private sortLayersByTitle(layers: Layer[]) {\r\n    return layers.sort((a, b) => {\r\n      if (this.normalize(a.title) < this.normalize(b.title)) {\r\n        return -1;\r\n      }\r\n      if (this.normalize(a.title) > this.normalize(b.title)) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n  }\r\n\r\n  private normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  private computeShowToolbar(): boolean {\r\n    switch (this.layerFilterAndSortOptions.showToolbar) {\r\n      case LayerListControlsEnum.always:\r\n        return true;\r\n      case LayerListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        if (\r\n          this.layers.length >= this.thresholdToFilterAndSort ||\r\n          this.keyword ||\r\n          this.onlyVisible\r\n        ) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  toggleLayerTool(layer) {\r\n    this.toggleOpacity = false;\r\n    if (this.layerTool && layer === this.activeLayer) {\r\n      this.layerTool = false;\r\n    } else {\r\n      this.layerTool = true;\r\n    }\r\n\r\n    for (const lay of this.layers) {\r\n      lay.options.active = false;\r\n    }\r\n    layer.options.active = true;\r\n    this.activeLayer = layer;\r\n  }\r\n\r\n  removeLayers(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      this.layersChecked = [];\r\n      for (const layer of layers) {\r\n        if (layer.options.removable !== false) {\r\n          layer.map.removeLayer(layer);\r\n        } else {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    } else if (!layers && this.activeLayer.options.removable !== false) {\r\n      this.activeLayer.map.removeLayer(this.activeLayer);\r\n      this.layerTool = false;\r\n    }\r\n  }\r\n\r\n  toggleVisibility(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      for (const layer of layers) {\r\n        layer.visible = this.hideSelectedLayers;\r\n      }\r\n    }\r\n    this.layerItemChangeDetection$.next(true);\r\n  }\r\n\r\n  isLayerRemovable(layer: Layer): boolean {\r\n    return layer.options.removable !== false;\r\n  }\r\n\r\n  isAllLayersRemovable(layers: Layer[]): boolean {\r\n    return layers.every(l => this.isLayerRemovable(l));\r\n  }\r\n\r\n  get statusSelectedLayersCheck(): LayerListSelectVisibleEnum {\r\n    let statusSelectedLayers: LayerListSelectVisibleEnum =\r\n      LayerListSelectVisibleEnum.NULL;\r\n    let findTrue: boolean = false;\r\n    let findFalse: boolean = false;\r\n\r\n    if (this.layersChecked.length === 0) {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.NULL;\r\n    } else {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.MIXED;\r\n      this.hideSelectedLayers = false;\r\n\r\n      for (const layer2 of this.layersChecked) {\r\n        if (layer2.visible === true) {\r\n          findTrue = true;\r\n        }\r\n        if (layer2.visible === false) {\r\n          findFalse = true;\r\n        }\r\n      }\r\n\r\n      if (findTrue === true && findFalse === false) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_VISIBLE;\r\n      }\r\n      if (findTrue === false && findFalse === true) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_HIDDEN;\r\n        this.hideSelectedLayers = true;\r\n      }\r\n    }\r\n\r\n    return statusSelectedLayers;\r\n  }\r\n\r\n  layersCheck(event: { layer: Layer; check: boolean }) {\r\n    event.layer.options.check = event.check;\r\n    if (event.check === true) {\r\n      const eventMapIndex = this.layers.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      for (const layer of this.layersChecked) {\r\n        const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n        if (eventMapIndex < mapIndex) {\r\n          this.layersChecked.splice(\r\n            this.layersChecked.findIndex((lay) => layer.id === lay.id),\r\n            0,\r\n            event.layer\r\n          );\r\n\r\n          if (this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          } else if (!this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter((lay) => lay.showInLayerList).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          }\r\n          return;\r\n        }\r\n      }\r\n      this.layersChecked.push(event.layer);\r\n    } else {\r\n      const index = this.layersChecked.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      this.layersChecked.splice(index, 1);\r\n    }\r\n\r\n    if (this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter(\r\n          (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n        ).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    } else if (!this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter((lay) => lay.showInLayerList).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  toggleSelectionMode(value: boolean) {\r\n    this.selection = value;\r\n    this.activeLayer = undefined;\r\n    if (value === true) {\r\n      this.layerTool = false;\r\n      for (const layer of this.layers) {\r\n        if (layer.options.check) {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  layersCheckedOpacity(): any {\r\n    if (this.layersChecked.length > 1) {\r\n      return 1;\r\n    } else {\r\n      const opacity = [];\r\n      for (const layer of this.layersChecked) {\r\n        opacity.push(layer.opacity);\r\n      }\r\n      return opacity;\r\n    }\r\n  }\r\n\r\n  selectAll() {\r\n    if (!this.selectAllCheck) {\r\n      for (const layer of this.layers) {\r\n        if (\r\n          this.excludeBaseLayers &&\r\n          layer.baseLayer !== true &&\r\n          layer.showInLayerList\r\n        ) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        } else if (!this.excludeBaseLayers && layer.showInLayerList) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n      this.selectAllCheck$.next(true);\r\n    } else {\r\n      for (const layer of this.layers) {\r\n        layer.options.check = false;\r\n      }\r\n      this.layersChecked = [];\r\n      this.selectAllCheck$.next(false);\r\n    }\r\n  }\r\n\r\n  isScrolledIntoView(elemSource, elem) {\r\n    const docViewTop = elemSource.scrollTop;\r\n    const docViewBottom = docViewTop + elemSource.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.clientHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  computeElementRef(type?: string) {\r\n    const checkItems = this.elRef.nativeElement.getElementsByClassName(\r\n      'mat-checkbox-checked'\r\n    );\r\n    const checkItem =\r\n      type === 'lower'\r\n        ? this.elRef.nativeElement.getElementsByClassName(\r\n          'mat-checkbox-checked'\r\n        )[checkItems.length - 1]\r\n        : this.elRef.nativeElement.getElementsByClassName(\r\n          'mat-checkbox-checked'\r\n        )[0];\r\n    const igoList = this.elRef.nativeElement.getElementsByTagName(\r\n      'igo-list'\r\n    )[0];\r\n\r\n    return [igoList, checkItem];\r\n  }\r\n\r\n  removeProblemLayerInList(layersList: Layer[]): Layer[] {\r\n    for (const layer of layersList) {\r\n      if (layer.olLoadingProblem === true) {\r\n        this.map.removeLayer(layer);\r\n      }\r\n    }\r\n    return layersList;\r\n  }\r\n}\r\n","  <mat-list-item>\r\n      <mat-form-field class=\"inputFilter\" [floatLabel]=\"floatLabel\">\r\n        <input\r\n          matInput\r\n          [placeholder]=\"'igo.geo.layer.filterPlaceholder' | translate\"\r\n          [matTooltip]=\"'igo.geo.layer.subsetLayersListKeyword' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          type=\"text\" [(ngModel)]=\"term\">\r\n        <button\r\n          mat-button\r\n          *ngIf=\"term\"\r\n          matSuffix\r\n          mat-icon-button\r\n          aria-label=\"Clear\"\r\n          color=\"warn\"\r\n          (click)=\"clearTerm()\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      </mat-form-field>\r\n\r\n      <div [matTooltip]=\"sortAlpha ?\r\n      ('igo.geo.layer.sortMapOrder' | translate) :\r\n      ('igo.geo.layer.sortAlphabetically' | translate)\" matTooltipShowDelay=\"500\">\r\n        <button class=\"sort-alpha\" [color]=\"sortAlpha ? 'warn' : 'primary'\" mat-icon-button (click)=\"toggleSortAlpha()\">\r\n          <mat-icon [svgIcon]=\"sortAlpha ? 'sort-ascending' : 'sort-alphabetical-ascending'\"></mat-icon>\r\n        </button>\r\n      </div>\r\n\r\n       <div [matTooltip]=\"onlyVisible ?\r\n        ('igo.geo.layer.resetLayersList' | translate) :\r\n        ('igo.geo.layer.subsetLayersListOnlyVisible' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"only-visible\" mat-icon-button [disabled]=\"layersAreAllVisible && !onlyVisible\"\r\n           [color]=\"onlyVisible ? 'warn' : 'primary'\" (click)=\"toggleOnlyVisible()\">\r\n           <mat-icon\r\n             matBadge=\"icon\"\r\n             igoMatBadgeIcon=\"eye\"\r\n             igoMatBadgeInverseColor=\"true\"\r\n             igoMatBadgeInheritColor=\"true\"\r\n             [svgIcon]=\"onlyVisible ? 'filter-remove' : 'filter'\">\r\n           </mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n       <div [matTooltip]=\"selectionMode ?\r\n        ('igo.geo.layer.deactivateSelectionMode' | translate) :\r\n        ('igo.geo.layer.activateSelectionMode' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"selection-mode\" mat-icon-button\r\n           color=\"primary\" (click)=\"toggleSelectionMode()\">\r\n           <mat-icon [svgIcon]=\"selectionMode ? 'checkbox-multiple-marked-outline' : 'checkbox-multiple-blank-outline'\"></mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  EventEmitter,\r\n  Output,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerListControlsOptions } from './layer-list-tool.interface';\r\n\r\n@Component({\r\n  selector: 'igo-layer-list-tool',\r\n  templateUrl: './layer-list-tool.component.html',\r\n  styleUrls: ['./layer-list-tool.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListToolComponent implements OnInit, OnDestroy {\r\n  public onlyVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public sortAlpha$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public term$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n  onlyVisible$$: Subscription;\r\n  sortAlpha$$: Subscription;\r\n  term$$: Subscription;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input()\r\n  set onlyVisible(value: boolean) {\r\n    this.onlyVisible$.next(value);\r\n  }\r\n  get onlyVisible(): boolean {\r\n    return this.onlyVisible$.value;\r\n  }\r\n\r\n  @Input()\r\n  set sortAlpha(value: boolean) {\r\n    this.sortAlpha$.next(value);\r\n  }\r\n  get sortAlpha(): boolean {\r\n    return this.sortAlpha$.value;\r\n  }\r\n\r\n  @Input()\r\n  set term(value: string) {\r\n    this.term$.next(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n\r\n  public selectionMode = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n  @Output() selection = new EventEmitter<boolean>();\r\n\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe(keyword => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n\r\n    this.onlyVisible$$ = this.onlyVisible$.subscribe(onlyVisible => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n    this.sortAlpha$$ = this.sortAlpha$.subscribe(sortAlpha => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.onlyVisible$$.unsubscribe();\r\n    this.sortAlpha$$.unsubscribe();\r\n    this.term$$.unsubscribe();\r\n  }\r\n\r\n  clearTerm() {\r\n    this.term = undefined;\r\n  }\r\n  toggleSortAlpha() {\r\n    this.sortAlpha = !this.sortAlpha;\r\n  }\r\n\r\n  toggleOnlyVisible() {\r\n    this.onlyVisible = !this.onlyVisible;\r\n  }\r\n\r\n  toggleSelectionMode() {\r\n    this.selectionMode = !this.selectionMode;\r\n    this.selection.emit(this.selectionMode);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy, Optional } from '@angular/core';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\n\r\nimport { RouteService } from '@igo2/core';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { LayerListComponent } from './layer-list.component';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { map, debounceTime } from 'rxjs/operators';\r\n\r\n@Directive({\r\n  selector: '[igoLayerListBinding]'\r\n})\r\nexport class LayerListBindingDirective implements OnInit, OnDestroy {\r\n  private component: LayerListComponent;\r\n  private layersOrResolutionChange$$: Subscription;\r\n  layersVisibility$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: LayerListComponent,\r\n    private mapService: MapService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    // this.component.layers = [];\r\n    this.layersOrResolutionChange$$ = combineLatest([\r\n      this.mapService.getMap().layers$,\r\n      this.mapService.getMap().viewController.resolution$]\r\n    ).pipe(\r\n      debounceTime(10)\r\n    ).subscribe((bunch: [Layer[], number]) => {\r\n      const shownLayers = bunch[0].filter((layer: Layer) => {\r\n        return layer.showInLayerList === true;\r\n      });\r\n      this.component.layers = shownLayers;\r\n      this.setLayersVisibilityStatus(shownLayers, this.component.excludeBaseLayers);\r\n    });\r\n  }\r\n\r\n  private setLayersVisibilityStatus(layers: Layer[], excludeBaseLayers: boolean) {\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n    this.layersVisibility$$ = combineLatest(layers\r\n      .filter(layer => layer.baseLayer !== excludeBaseLayers )\r\n      .map((layer: Layer) => layer.visible$))\r\n      .pipe(map((visibles: boolean[]) => visibles.every(Boolean)))\r\n      .subscribe((allLayersAreVisible: boolean) =>\r\n        this.component.layersAreAllVisible = allLayersAreVisible);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layersOrResolutionChange$$.unsubscribe();\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n  }\r\n\r\n}\r\n","\r\n<div class=\"layer-legend-list-container\">\r\n  <mat-slide-toggle \r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.legend.showAll' | translate\"\r\n  [checked]=\"showAllLegendsValue\" class=\"mat-typography\" \r\n  *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\" [labelPosition]=\"'before'\" (change)=\"toggleShowAllLegends($event.checked)\">\r\n    {{'igo.geo.layer.legend.showAll' | translate}}\r\n  </mat-slide-toggle>\r\n  <mat-divider *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\"></mat-divider>\r\n  <igo-list [navigation]=\"false\" [selection]=\"false\">\r\n    <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n      <igo-layer-legend-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n          igoListItem [layer]=\"layer\"\r\n          [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n      </igo-layer-legend-item>\r\n    </ng-template>\r\n  </igo-list>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButton' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButtonButZoom' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisible' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleButZoom' | translate}} \r\n  </p>\r\n\r\n</div>","import { Component, Input, ChangeDetectionStrategy, OnInit, OnDestroy, EventEmitter, Output } from '@angular/core';\r\nimport { Layer } from '../shared';\r\nimport { BehaviorSubject, ReplaySubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-list',\r\n  templateUrl: './layer-legend-list.component.html',\r\n  styleUrls: ['./layer-legend-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n\r\n  hasVisibleOrInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  hasVisibleAndNotInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  layersInUi$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  showAllLegend: boolean = false;\r\n  public change$ = new ReplaySubject<void>(1);\r\n  private change$$: Subscription;\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() allowShowAllLegends: boolean = false;\r\n\r\n  @Input() showAllLegendsValue: boolean = false;\r\n\r\n  @Output() allLegendsShown = new EventEmitter<boolean>(false);\r\n\r\n  constructor() { }\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(debounce(() => {\r\n        return this.layers.length === 0 ? EMPTY : timer(50);\r\n      }))\r\n      .subscribe(() => {\r\n        const layers = this.computeShownLayers(this.layers.slice(0));\r\n        this.layers$.next(layers);\r\n        this.hasVisibleOrInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n        this.hasVisibleAndNotInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && !layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n\r\n        this.layersInUi$.next(\r\n          this.layers.slice(0).filter(layer => layer.showInLayerList !== false && (!this.excludeBaseLayers || !layer.baseLayer))\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n  private computeShownLayers(layers: Layer[]) {\r\n    let shownLayers = layers.filter((layer: Layer) => layer.visible && layer.isInResolutionsRange);\r\n    if (this.showAllLegendsValue) {\r\n      shownLayers = layers;\r\n    }\r\n    return this.sortLayersByZindex(shownLayers);\r\n  }\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  toggleShowAllLegends(toggle: boolean) {\r\n      this.showAllLegendsValue = toggle;\r\n      this.next();\r\n      this.allLegendsShown.emit(toggle);\r\n  }\r\n}\r\n","<button *ngIf=\"options.trackFeature\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.trackFeature' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"toggleTrackFeature()\">\r\n  <mat-icon svgIcon=\"crosshairs-gps\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { VectorLayer } from '../shared/layers';\r\nimport { VectorLayerOptions } from '../shared/layers/vector-layer.interface';\r\n\r\n@Component({\r\n  selector: 'igo-track-feature-button',\r\n  templateUrl: './track-feature-button.component.html',\r\n  styleUrls: ['./track-feature-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TrackFeatureButtonComponent implements OnInit {\r\n\r\n  @Input() layer: VectorLayer;\r\n\r\n  @Input() trackFeature = false;\r\n\r\n  get options(): VectorLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n\r\n  public color: string = 'primary';\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.color = this.trackFeature ? 'primary' : 'basic';\r\n  }\r\n\r\n  toggleTrackFeature() {\r\n    if (this.trackFeature) {\r\n      this.layer.disableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'basic';\r\n    } else {\r\n      this.layer.enableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'primary';\r\n    }\r\n    this.trackFeature = !this.trackFeature;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-item',\r\n  templateUrl: './layer-legend-item.component.html',\r\n  styleUrls: ['./layer-legend-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendItemComponent implements OnInit, OnDestroy {\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  constructor(private networkService: NetworkService) {}\r\n\r\n  ngOnInit() {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <h4 matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoCollapsibleModule,\r\n  IgoImageModule,\r\n  IgoPanelModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoCustomHtmlModule\r\n} from '@igo2/common';\r\n\r\nimport { LayerService } from './shared/layer.service';\r\nimport { StyleService } from './shared/style.service';\r\nimport { LayerListToolService } from './layer-list-tool/layer-list-tool.service';\r\nimport { LayerItemComponent } from './layer-item/layer-item.component';\r\nimport { LayerLegendComponent } from './layer-legend/layer-legend.component';\r\nimport { LayerListComponent } from './layer-list/layer-list.component';\r\nimport { LayerListToolComponent } from './layer-list-tool/layer-list-tool.component';\r\nimport { LayerListBindingDirective } from './layer-list/layer-list-binding.directive';\r\nimport { LayerLegendListBindingDirective } from './layer-legend-list/layer-legend-list-binding.directive';\r\nimport { TrackFeatureButtonComponent } from './track-feature-button/track-feature-button.component';\r\nimport { LayerLegendListComponent } from './layer-legend-list/layer-legend-list.component';\r\nimport { LayerLegendItemComponent } from './layer-legend-item/layer-legend-item.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    CommonModule,\r\n    FormsModule,\r\n    MatDividerModule,\r\n    MatMenuModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSlideToggleModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatSliderModule,\r\n    MatBadgeModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoImageModule,\r\n    IgoPanelModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  exports: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ],\r\n  declarations: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ]\r\n})\r\nexport class IgoLayerModule {\r\n  static forRoot(): ModuleWithProviders<IgoLayerModule> {\r\n    return {\r\n      ngModule: IgoLayerModule,\r\n      providers: [LayerService, StyleService, LayerListToolService]\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoMatBadgeIconModule,\r\n  IgoCollapsibleModule,\r\n  IgoListModule\r\n} from '@igo2/common';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { CatalogBrowserComponent } from './catalog-browser.component';\r\nimport { CatalogBrowserLayerComponent } from './catalog-browser-layer.component';\r\nimport { CatalogBrowserGroupComponent } from './catalog-browser-group.component';\r\nimport { IgoLayerModule } from '../../layer/layer.module';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoMetadataModule,\r\n    IgoLayerModule\r\n  ],\r\n  exports: [\r\n    CatalogBrowserComponent\r\n  ],\r\n  declarations: [\r\n    CatalogBrowserComponent,\r\n    CatalogBrowserGroupComponent,\r\n    CatalogBrowserLayerComponent\r\n  ]\r\n})\r\nexport class IgoCatalogBrowserModule {}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{'igo.geo.catalog.library.addTitle' | translate}}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <form class=\"igo-form\" [formGroup]=\"form\">\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"title\" placeholder=\"{{'igo.geo.printForm.title' | translate}}\" matInput [matAutocomplete]=\"auto2\">\r\n        <mat-autocomplete #auto2=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.title\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.title}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"url\" placeholder=\"URL\" matInput [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.url\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.url}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <mat-select\r\n          formControlName=\"type\"\r\n          placeholder=\"Type\">\r\n          <mat-option\r\n            *ngFor=\"let type of typeCapabilities\"\r\n            [value]=\"type\"\r\n            (click)=\"$event.stopPropagation()\">\r\n              <p mat-line>{{type}}</p>\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n  <span *ngIf=\"error && addedCatalog && emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.externalProvider.unavailableWithEmail', { value: addedCatalog.url, email: emailAddress })}}</p>\r\n  </span>\r\n  <span *ngIf=\"error && addedCatalog && !emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url })}}</p>\r\n  </span>\r\n</div>\r\n<div mat-dialog-actions style=\"justify-content: center\">\r\n  <div class=\"igo-form-button-group add-catalog-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"cancel()\">\r\n      {{'igo.geo.catalog.library.cancel' | translate}}\r\n    </button>\r\n    <button\r\n      id=\"addCatalogBtnDialog\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      color=\"primary\"\r\n      [disabled]=\"!form.valid\"\r\n      (click)=\"addCatalog(form.value)\">\r\n      {{'igo.geo.catalog.library.add' | translate}}\r\n    </button>\r\n  </div>\r\n</div>","import { LanguageService, ConfigService } from '@igo2/core';\r\nimport { Component, OnInit, OnDestroy, Optional, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { FormBuilder, FormGroup, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { TypeCapabilities } from '../../datasource';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n@Component({\r\n  selector: 'igo-add-catalog-dialog',\r\n  templateUrl: './add-catalog-dialog.component.html',\r\n  styleUrls: ['./add-catalog-dialog.component.scss']\r\n})\r\nexport class AddCatalogDialogComponent implements OnInit, OnDestroy {\r\n  public form: FormGroup;\r\n  private defaultAddedCatalogType = 'wms';\r\n  private addedCatalogType$$: Subscription;\r\n  public predefinedCatalogsList$ = new BehaviorSubject<Catalog[]>([]);\r\n  typeCapabilities: string[];\r\n  predefinedCatalogs: Catalog[] = [];\r\n  store: EntityStore<Catalog>;\r\n  error = false;\r\n  addedCatalog: Catalog;\r\n  emailAddress: string;\r\n  private storeViewAll$$: Subscription;\r\n\r\n  constructor(\r\n    private formBuilder: FormBuilder,\r\n    public languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    public dialogRef: MatDialogRef<AddCatalogDialogComponent>,\r\n    @Optional()\r\n    @Inject(MAT_DIALOG_DATA)\r\n    public data: { predefinedCatalogs: Catalog[]; store: EntityStore<Catalog>; error: boolean; addedCatalog: Catalog }\r\n  ) {\r\n    this.store = data.store;\r\n    this.predefinedCatalogs = data.predefinedCatalogs;\r\n    this.error = data.error;\r\n    this.addedCatalog = data.addedCatalog;\r\n    this.form = this.formBuilder.group({\r\n      id: ['', []],\r\n      title: ['', []],\r\n      url: ['', [Validators.required]],\r\n      type: [this.defaultAddedCatalogType, [Validators.required]]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n    this.typeCapabilities = Object.keys(TypeCapabilities);\r\n\r\n    this.addedCatalogType$$ = this.form\r\n      .get('type')\r\n      .valueChanges.subscribe((value) => {\r\n        if (value === 'wmts') {\r\n          this.form.get('title').setValidators(Validators.required);\r\n        } else {\r\n          this.form.get('title').setValidators([]);\r\n        }\r\n        this.form.get('title').updateValueAndValidity();\r\n      });\r\n\r\n    this.computePredefinedCatalogList();\r\n    this.storeViewAll$$ = this.store.view\r\n      .all$()\r\n      .subscribe(() => this.computePredefinedCatalogList());\r\n\r\n    this.emailAddress = this.configService.getConfig('emailAddress');\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.addedCatalogType$$.unsubscribe();\r\n    this.storeViewAll$$.unsubscribe();\r\n  }\r\n\r\n  changeUrlOrTitle(catalog: Catalog) {\r\n    this.form.patchValue(catalog);\r\n    this.error = false;\r\n    this.computePredefinedCatalogList();\r\n  }\r\n\r\n  computePredefinedCatalogList() {\r\n    this.predefinedCatalogsList$.next(\r\n      this.predefinedCatalogs.filter((c) => !this.store.get(c.id))\r\n    );\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    this.error = false;\r\n    this.dialogRef.close(addedCatalog);\r\n  }\r\n\r\n  cancel() {\r\n    this.error = false;\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\">\r\n  <ng-template ngFor let-catalog [ngForOf]=\"getCatalogs() | async\">\r\n    <igo-catalog-library-item\r\n      igoListItem\r\n      color=\"accent\"\r\n      [map]=\"map\"\r\n      [catalog]=\"catalog\"\r\n      (catalogRemove)=\"onCatalogRemove(catalog)\"\r\n      (select)=\"onCatalogSelect(catalog)\">\r\n    </igo-catalog-library-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<div *ngIf=\"addCatalogAllowed\" class=btnAddCatalog>\r\n  <button\r\n    mat-raised-button\r\n    [matTooltip]=\"'igo.geo.catalog.library.addBtn' | translate\"\r\n    matTooltipPosition=\"above\"\r\n    color=\"primary\"\r\n    (click)=\"addCatalogDialog()\">\r\n    {{'igo.geo.catalog.library.addBtn' | translate}}\r\n    <mat-icon svgIcon=\"earth-plus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { LanguageService, MessageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { Observable, Subscription } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\nimport { Md5 } from 'ts-md5';\r\nimport { CapabilitiesService } from '../../datasource';\r\nimport { IgoMap } from '../../map';\r\nimport { standardizeUrl } from '../../utils/id-generator';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\n/**\r\n * Component to browse a list of available catalogs\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library',\r\n  templateUrl: './catalog-library.component.html',\r\n  styleUrls: ['./catalog-library.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Store holding the catalogs\r\n   */\r\n  @Input() store: EntityStore<Catalog>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() addCatalogAllowed: boolean = false;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() predefinedCatalogs: Catalog[] = [];\r\n\r\n  /**\r\n   * Event emitted a catalog is selected or unselected\r\n   */\r\n  @Output() catalogSelectChange = new EventEmitter<{\r\n    selected: boolean;\r\n    catalog: Catalog;\r\n  }>();\r\n\r\n  submitDisabled = true;\r\n  private addingCatalog$$: Subscription;\r\n\r\n  get addedCatalogs(): Catalog[] {\r\n    return (this.storageService.get('addedCatalogs') || []) as Catalog[];\r\n  }\r\n  set addedCatalogs(catalogs: Catalog[]) {\r\n    this.storageService.set('addedCatalogs', catalogs);\r\n  }\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService,\r\n    private dialog: MatDialog\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n\r\n    this.predefinedCatalogs = this.predefinedCatalogs.map(c => {\r\n      c.id = Md5.hashStr(\r\n        (c.type || 'wms') + standardizeUrl(c.url)\r\n      ) as string;\r\n      c.title = c.title === '' || !c.title ? c.url : c.title;\r\n      return c;\r\n    });\r\n  }\r\n\r\n  getCatalogs(): Observable<Catalog[]> {\r\n    return this.store.view.all$();\r\n  }\r\n\r\n  /**\r\n   * When a catalog is selected, update it's state in the store\r\n   * and emit the catalog select change event\r\n   * @internal\r\n   */\r\n  onCatalogSelect(catalog: Catalog) {\r\n    this.store.state.update(\r\n      catalog,\r\n      {\r\n        selected: true,\r\n        focused: true\r\n      },\r\n      true\r\n    );\r\n    this.catalogSelectChange.emit({ selected: true, catalog });\r\n  }\r\n\r\n  private unsubscribeAddingCatalog() {\r\n    if (this.addingCatalog$$) {\r\n      this.addingCatalog$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    if (!addedCatalog) {\r\n      return;\r\n    }\r\n    let id = Md5.hashStr(\r\n      addedCatalog.type + standardizeUrl(addedCatalog.url)\r\n    ) as string;\r\n    const predefinedCatalog = this.predefinedCatalogs.find(\r\n      (c) => c.id === addedCatalog.id\r\n    );\r\n\r\n    if (predefinedCatalog) {\r\n      addedCatalog.version = predefinedCatalog.version;\r\n      addedCatalog.externalProvider = predefinedCatalog.externalProvider;\r\n      id = predefinedCatalog.id;\r\n    }\r\n\r\n    if (this.store.get(id)) {\r\n      const title = this.languageService.translate.instant(\r\n        'igo.geo.catalog.library.inlist.title'\r\n      );\r\n      const message = this.languageService.translate.instant(\r\n        'igo.geo.catalog.library.inlist.message'\r\n      );\r\n      this.messageService.alert(message, title);\r\n      return;\r\n    }\r\n    this.unsubscribeAddingCatalog();\r\n\r\n    this.addingCatalog$$ = this.capabilitiesService\r\n    .getCapabilities(addedCatalog.type as any, addedCatalog.url, addedCatalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          const title = this.languageService.translate.instant('igo.geo.catalog.unavailableTitle');\r\n          if (e.error) {\r\n            this.addCatalogDialog(true, addedCatalog);\r\n            e.error.caught = true;\r\n            return e;\r\n          }\r\n          const message = this.languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url });\r\n          this.messageService.error(message, title);\r\n          throw e;\r\n        })\r\n      )\r\n      .subscribe((capabilities) => {\r\n        let title;\r\n        let version;\r\n        switch (addedCatalog.type) {\r\n          case 'wms':\r\n            title = addedCatalog.title || capabilities.Service.Title;\r\n            version = addedCatalog.version || capabilities.version;\r\n            break;\r\n          case 'arcgisrest':\r\n          case 'imagearcgisrest':\r\n          case 'tilearcgisrest':\r\n            title = addedCatalog.title || capabilities.mapName;\r\n            break;\r\n          case 'wmts':\r\n            title =\r\n              addedCatalog.title ||\r\n              capabilities.ServiceIdentification.ServiceType;\r\n            break;\r\n          default:\r\n            title = addedCatalog.title;\r\n        }\r\n\r\n        const catalogToAdd = ObjectUtils.removeUndefined(\r\n          Object.assign({},\r\n            predefinedCatalog,\r\n            ObjectUtils.removeUndefined({\r\n              id,\r\n              title,\r\n              url: addedCatalog.url,\r\n              type: addedCatalog.type || 'wms',\r\n              externalProvider: addedCatalog.externalProvider || false,\r\n              removable: true,\r\n              version\r\n            })) as Catalog);\r\n        this.store.insert(catalogToAdd);\r\n        const newCatalogs = this.addedCatalogs.slice(0);\r\n        newCatalogs.push(catalogToAdd);\r\n        this.addedCatalogs = newCatalogs;\r\n        this.unsubscribeAddingCatalog();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribeAddingCatalog();\r\n  }\r\n\r\n  onCatalogRemove(catalog) {\r\n    this.store.delete(catalog);\r\n    this.addedCatalogs = this.addedCatalogs\r\n      .slice(0)\r\n      .filter((c) => c.id !== catalog.id);\r\n  }\r\n\r\n  addCatalogDialog(error?, addedCatalog?: Catalog) {\r\n    const dialogRef = this.dialog.open(AddCatalogDialogComponent, {\r\n      width: '700px',\r\n      data: {\r\n        predefinedCatalogs: this.predefinedCatalogs,\r\n        store: this.store,\r\n        error,\r\n        addedCatalog\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((catalog) => {\r\n      this.addCatalog(catalog);\r\n    });\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <h4 mat-line>\r\n    {{title}}\r\n  </h4>\r\n  <mat-icon\r\n    class=\"igo-external-provider\"\r\n    *ngIf=\"catalog.externalProvider\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.catalog.externalProvider.catalog' | translate\"\r\n    color=\"primary\"\r\n    (click)=\"$event.stopPropagation()\"\r\n    svgIcon=\"earth-arrow-right\">\r\n  </mat-icon>\r\n\r\n  <button\r\n  *ngIf=\"catalog.removable\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.catalog.library.remove' | translate\"\r\n  color=\"warn\"\r\n  (click)=\"removeCatalogFromLibrary($event)\">\r\n  <mat-icon svgIcon=\"delete\"></mat-icon>\r\n</button>\r\n\r\n<button\r\n  class=\"igo-blank\"\r\n  *ngIf=\"!catalog.removable\"\r\n  disabled=\"true\"\r\n  mat-icon-button>\r\n  <mat-icon svgIcon=\"blank\"></mat-icon>\r\n</button>\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\nimport { IgoMap } from '../../map';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n/**\r\n * Catalog library item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library-item',\r\n  templateUrl: './catalog-library-item.component.html',\r\n  styleUrls: ['./catalog-library-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryItemComponent {\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() catalogRemove = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return getEntityTitle(this.catalog); }\r\n\r\n  removeCatalogFromLibrary(event) {\r\n    event.stopPropagation();\r\n    this.catalogRemove.emit();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule } from '@igo2/common';\r\n\r\nimport { CatalogLibaryComponent, } from './catalog-library.component';\r\nimport { CatalogLibaryItemComponent } from './catalog-library-item.component';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoListModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatFormFieldModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatAutocompleteModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    CatalogLibaryComponent,\r\n    AddCatalogDialogComponent\r\n  ],\r\n  declarations: [\r\n    CatalogLibaryComponent,\r\n    CatalogLibaryItemComponent,\r\n    AddCatalogDialogComponent\r\n  ]\r\n})\r\nexport class IgoCatalogLibraryModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule, IgoCollapsibleModule, IgoMatBadgeIconModule } from '@igo2/common';\r\n\r\nimport { IgoCatalogBrowserModule } from './catalog-browser/catalog-browser.module';\r\nimport { IgoCatalogLibraryModule } from './catalog-library/catalog-library.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule\r\n  ],\r\n  exports: [\r\n    IgoCatalogBrowserModule,\r\n    IgoCatalogLibraryModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoCatalogModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\nimport { TimeFilterableDataSource } from './time-filter.interface';\r\n\r\n@Pipe({\r\n  name: 'filterableDataSource'\r\n})\r\nexport class FilterableDataSourcePipe implements PipeTransform {\r\n  transform(value: Layer[], arg: string): Layer[] {\r\n    let layers;\r\n\r\n    if (arg === 'time') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as TimeFilterableDataSource;\r\n        return (\r\n          this.isTimeFilterable(datasource) &&\r\n          datasource.options.timeFilter !== undefined &&\r\n          Object.keys(datasource.options.timeFilter).length\r\n        );\r\n      });\r\n    }\r\n    if (arg === 'ogc') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as OgcFilterableDataSource;\r\n        return this.isOgcFilterable(datasource);\r\n      });\r\n    }\r\n    return layers;\r\n  }\r\n\r\n  private isTimeFilterable(dataSource: TimeFilterableDataSource) {\r\n    if (dataSource.options.type !== 'wms') {\r\n      return false;\r\n    }\r\n    return dataSource.options.timeFilterable;\r\n  }\r\n\r\n  private isOgcFilterable(dataSource: OgcFilterableDataSource): boolean {\r\n    let isOgcFilterable = false;\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      dataSource.options.ogcFilters.editable\r\n    ) {\r\n      isOgcFilterable = true;\r\n    }\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      (\r\n        dataSource.options.ogcFilters.pushButtons ||\r\n        dataSource.options.ogcFilters.checkboxes ||\r\n        dataSource.options.ogcFilters.radioButtons ||\r\n        dataSource.options.ogcFilters.select)) {\r\n        isOgcFilterable = true;\r\n    }\r\n    return isOgcFilterable;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { TileArcGISRestDataSource } from '../../datasource/shared/datasources/tilearcgisrest-datasource';\r\n\r\n@Injectable()\r\nexport class TimeFilterService {\r\n  constructor() {}\r\n\r\n  filterByDate(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    date: Date | [Date, Date]\r\n  ) {\r\n    let time;\r\n    let newdateform;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(date)) {\r\n      const dates = [];\r\n      if (date[0]) {\r\n        newdateformStart = this.reformatDateTime(date[0]);\r\n        dates.push(date[0]);\r\n      }\r\n      if (date[1]) {\r\n        newdateformEnd = this.reformatDateTime(date[1]);\r\n        dates.push(date[1]);\r\n      }\r\n      if (dates.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else if (date) {\r\n      newdateform = this.reformatDateTime(date);\r\n      time = newdateform;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  filterByYear(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    year: string | [string, string]\r\n  ) {\r\n    let time;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(year)) {\r\n      const years = [];\r\n      if (year[0]) {\r\n        newdateformStart = year[0];\r\n        years.push(year[0]);\r\n      }\r\n      if (year[1]) {\r\n        newdateformEnd = year[1];\r\n        years.push(year[1]);\r\n      }\r\n      if (years.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else { // to reset filter.\r\n      time = year;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  private reformatDateTime(value) {\r\n    const year = value.getFullYear();\r\n    let month = value.getMonth() + 1;\r\n    let day = value.getUTCDate();\r\n    let hour = value.getUTCHours();\r\n    let minute = value.getUTCMinutes();\r\n\r\n    if (Number(month) < 10) {\r\n      month = '0' + month;\r\n    }\r\n\r\n    if (Number(day) < 10) {\r\n      day = '0' + day;\r\n    }\r\n\r\n    if (Number(hour) < 10) {\r\n      hour = '0' + hour;\r\n    }\r\n\r\n    if (Number(minute) < 10) {\r\n      minute = '0' + minute;\r\n    }\r\n\r\n    return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':00Z';\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from './ogc-filter';\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterService {\r\n  constructor() {}\r\n\r\n  public filterByOgc(wmsDatasource: WMSDataSource, filterString: string) {\r\n    const appliedFilter = new OgcFilterWriter().formatProcessedOgcFilter(filterString, wmsDatasource.options.params.LAYERS);\r\n    wmsDatasource.ol.updateParams({ FILTER: appliedFilter });\r\n  }\r\n\r\n  public setOgcWFSFiltersOptions(wfsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wfsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.paramsWFS.fieldNameGeometry,\r\n        new olProjection({ code: options.paramsWFS.srsName }),\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          options.ogcFilters.filters,\r\n          options.paramsWFS.fieldNameGeometry\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public setOgcWMSFiltersOptions(wmsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wmsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.fieldNameGeometry,\r\n        undefined,\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          // With some wms server, this param must be set to make spatials call.\r\n          options.ogcFilters.filters,\r\n          options.fieldNameGeometry\r\n        );\r\n      }\r\n      this.filterByOgc(\r\n        wmsDatasource as WMSDataSource,\r\n        ogcFilterWriter.buildFilter(options.ogcFilters.filters,\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        wmsDatasource.options\r\n        )\r\n      );\r\n      options.filtered = true;\r\n    } else {\r\n      options.ogcFilters.filters = undefined;\r\n      options.ogcFilters.interfaceOgcFilters = [];\r\n      options.filtered = false;\r\n    }\r\n  }\r\n}\r\n","export enum SpatialFilterQueryType {\r\n    AdmRegion = 'AdmRegion',\r\n    Mun = 'Mun',\r\n    Arrond = 'Arrond',\r\n    CircFed = 'CircFed',\r\n    CircProv = 'CircProv',\r\n    DirReg = 'DirReg',\r\n    MRC = 'MRC',\r\n    RegTour = 'RegTour'\r\n}\r\n\r\nexport enum SpatialFilterType {\r\n    Predefined = 'Predefined',\r\n    Polygon = 'Polygon',\r\n    Point = 'Point'\r\n}\r\n\r\nexport enum SpatialFilterItemType {\r\n    Address = 'Address',\r\n    Thematics = 'Thematics'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { Observable } from 'rxjs';\r\nimport { Feature } from '../../feature/shared';\r\nimport {\r\n  SpatialFilterQueryType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterType\r\n} from './spatial-filter.enum';\r\nimport { SpatialFilterThematic } from './spatial-filter.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SpatialFilterService {\r\n  public baseUrl: string = 'https://geoegl.msp.gouv.qc.ca/apis/terrapi/';\r\n\r\n  /*\r\n   * Type association with URL\r\n   */\r\n  public urlFilterList = {\r\n    AdmRegion: 'regadmin',\r\n    Arrond: 'arrondissements',\r\n    CircFed: 'circ-fed',\r\n    CircProv: 'circ-prov',\r\n    DirReg: 'dir-reg',\r\n    MRC: 'mrc',\r\n    Mun: 'municipalites',\r\n    RegTour: 'tourisme',\r\n    bornes: 'bornes-sumi',\r\n    hydro: 'hydro',\r\n    routes: 'routes'\r\n  };\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.baseUrl =\r\n      this.configService.getConfig('spatialFilter.url') || this.baseUrl;\r\n  }\r\n\r\n  getKeyByValue(object, value) {\r\n    return Object.keys(object).find(key => object[key] === value);\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter list component (NO GEOMETRY)\r\n   */\r\n  loadFilterList(type: SpatialFilterQueryType): Observable<Feature[]> {\r\n    const urlPath = type as string;\r\n    if (urlPath) {\r\n      return this.http\r\n        .get<{ features: Feature[] }>(\r\n          this.baseUrl + this.urlFilterList[urlPath]\r\n        )\r\n        .pipe(\r\n          map(featureCollection =>\r\n            featureCollection.features.map(f => {\r\n              f.meta = {\r\n                id: f.properties.code\r\n              };\r\n              return f;\r\n            })\r\n          )\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Loading item list (STRING)\r\n   */\r\n  loadThematicsList() {\r\n    const url = 'types';\r\n    const items: SpatialFilterThematic[] = [];\r\n    return this.http.get(this.baseUrl + url).pipe(\r\n      map((types: string[]) => {\r\n        types.forEach(type => {\r\n          if (type.startsWith('lieux')) {\r\n            const item: SpatialFilterThematic = {\r\n              name: undefined,\r\n              source: type\r\n            };\r\n            let substr = type.substring(6, type.length);\r\n            let name = substr;\r\n            if (substr.includes('.')) {\r\n              const index = substr.indexOf('.');\r\n              name = substr.substring(index + 1, substr.length);\r\n              substr = substr.substring(0, index);\r\n            }\r\n            try {\r\n              item.name = this.languageService.translate.instant(\r\n                'igo.geo.terrapi.' + name\r\n              );\r\n            } catch (e) {\r\n              item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n            }\r\n\r\n            try {\r\n              item.group = this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.group.' + substr\r\n              );\r\n            } catch (e) {\r\n              item.group = substr.substring(0, 1).toUpperCase() + substr.substring(1, name.length - 1);\r\n            }\r\n\r\n            items.push(item);\r\n          } else {\r\n            if (this.getKeyByValue(this.urlFilterList, type)) {\r\n              const item: SpatialFilterThematic = {\r\n                name: undefined,\r\n                source: type\r\n              };\r\n              const name = this.getKeyByValue(this.urlFilterList, type);\r\n              try {\r\n                item.name = this.languageService.translate.instant(\r\n                  'igo.geo.terrapi.' + name\r\n                );\r\n              } catch (e) {\r\n                item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n              }\r\n              item.source = type;\r\n\r\n              items.push(item);\r\n            }\r\n          }\r\n        });\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter item component (Address or Thematics) depends on predefined zone or draw zone (feature)\r\n   */\r\n  loadFilterItem(\r\n    feature,\r\n    itemType: SpatialFilterItemType,\r\n    type?: SpatialFilterQueryType,\r\n    thematic?: SpatialFilterThematic,\r\n    buffer?: number\r\n  ) {\r\n    if (type) {\r\n      // Predefined type\r\n      const urlType = type as string;\r\n      const url = this.baseUrl + this.urlFilterList[urlType];\r\n      let urlItem = '';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        urlItem = 'adresses';\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        urlItem = thematic.source;\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    } else {\r\n      // Draw type\r\n      const url = this.baseUrl + 'locate';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        const urlItem = '?type=adresses';\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        const urlItem = '?type=' + thematic.source;\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get one territory by id (WITH GEOMETRY)\r\n   */\r\n  loadItemById(\r\n    feature: Feature,\r\n    type: SpatialFilterQueryType\r\n  ): Observable<Feature> {\r\n    const featureType = this.urlFilterList[type];\r\n    const featureCode = '/' + feature.properties.code;\r\n    if (featureType && featureCode) {\r\n      return this.http\r\n        .get<Feature>(this.baseUrl + featureType + featureCode, {\r\n          params: {\r\n            geometry: 'true'\r\n          }\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            f.meta = {\r\n              id: f.properties.code,\r\n              alias: f.properties.nom,\r\n              title: f.properties.nom\r\n            };\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get buffer geometry\r\n   */\r\n  loadBufferGeometry(\r\n    feature: Feature,\r\n    filterType: SpatialFilterType,\r\n    buffer?: number,\r\n    type?: SpatialFilterQueryType,\r\n  ): Observable<Feature> {\r\n    if (filterType === SpatialFilterType.Predefined) {\r\n      const featureType = this.urlFilterList[type];\r\n      const featureCode = '/' + feature.properties.code;\r\n      if (featureType && featureCode) {\r\n        return this.http\r\n          .get<Feature>(this.baseUrl + featureType + featureCode,\r\n            {\r\n              params: {\r\n                geometry: '100',\r\n                bufferOutput: buffer.toString()\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(f => {\r\n              f.meta = {\r\n                id: f.properties.code,\r\n                alias: f.properties.nom,\r\n                title: f.properties.nom\r\n              };\r\n              return f;\r\n            })\r\n          );\r\n      }\r\n    } else {\r\n      return this.http\r\n        .post<Feature>(this.baseUrl + 'geospatial/buffer?', {\r\n          buffer,\r\n          loc: JSON.stringify(feature)\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { Layer } from '../../layer/shared';\r\nimport { OgcFilterWriter, OgcFilterableDataSourceOptions } from '../../filter/shared';\r\n\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DownloadService {\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  open(layer: Layer) {\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.download.title');\r\n    this.messageService.success(\r\n      translate.instant('igo.geo.download.start'),\r\n      title\r\n    );\r\n\r\n    const DSOptions: DataSourceOptions = layer.dataSource.options;\r\n    if (Object.keys(DSOptions.download).length > 0) {\r\n      if (\r\n        DSOptions.download.dynamicUrl &&\r\n        DSOptions.download.url === undefined\r\n      ) {\r\n        let wfsOptions;\r\n        let currentProj = new olProjection({ code: layer.map.projection });\r\n        const paramsWFS = (layer.dataSource.options as any).paramsWFS;\r\n        if (paramsWFS && Object.keys(paramsWFS).length > 0\r\n        ) {\r\n          currentProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : currentProj;\r\n          wfsOptions = (layer.dataSource.options as any).paramsWFS;\r\n        } else {\r\n          wfsOptions = (layer.dataSource.options as any).params;\r\n        }\r\n\r\n        const currentExtent = olproj.transformExtent(\r\n          layer.map.viewController.getExtent(),\r\n          new olProjection({ code: layer.map.projection }),\r\n          currentProj\r\n        );\r\n        const outputFormatDownload =\r\n          wfsOptions.outputFormatDownload === undefined\r\n            ? wfsOptions.outputFormat === undefined ? '' : 'outputformat=' + wfsOptions.outputFormat\r\n            : 'outputformat=' + wfsOptions.outputFormatDownload;\r\n\r\n        const baseurl = DSOptions.download.dynamicUrl\r\n          .replace(/&?outputformat=[^&]*/gi, '')\r\n          .replace(/&?filter=[^&]*/gi, '')\r\n          .replace(/&?bbox=[^&]*/gi, '');\r\n\r\n        const ogcFilters = (layer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n\r\n        let filterQueryString;\r\n        filterQueryString = new OgcFilterWriter()\r\n        .handleOgcFiltersAppliedValue(\r\n          layer.dataSource.options,\r\n          ogcFilters.geometryName,\r\n          currentExtent as [number, number, number, number],\r\n          currentProj);\r\n        if (!filterQueryString) {\r\n          // Prevent getting all the features for empty filter\r\n            filterQueryString = new OgcFilterWriter().buildFilter(\r\n            undefined,\r\n            currentExtent as [number, number, number, number],\r\n            currentProj,\r\n            ogcFilters.geometryName\r\n          );\r\n        } else {\r\n          filterQueryString = 'filter=' + encodeURIComponent(filterQueryString);\r\n        }\r\n        window.open(\r\n          `${baseurl}&${filterQueryString}&${outputFormatDownload}`,\r\n          '_blank'\r\n        );\r\n      } else if (DSOptions.download) {\r\n        window.open(DSOptions.download.url, '_blank');\r\n      }\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"options && options.download && (options.download['dynamicUrl'] || options.download['url']) \"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.download.action' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openDownload(layer)\">\r\n  <mat-icon svgIcon=\"download\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { DownloadDataSourceOptions } from '../shared/download.interface';\r\nimport { DownloadService } from '../shared/download.service';\r\n\r\n@Component({\r\n  selector: 'igo-download-button',\r\n  templateUrl: './download-button.component.html',\r\n  styleUrls: ['./download-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DownloadButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private downloadService: DownloadService) {}\r\n\r\n  openDownload(layer: Layer) {\r\n    this.downloadService.open(layer);\r\n  }\r\n\r\n  get options(): DownloadDataSourceOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.dataSource.options;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { DownloadButtonComponent } from './download-button/download-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [DownloadButtonComponent],\r\n  declarations: [DownloadButtonComponent]\r\n})\r\nexport class IgoDownloadModule {\r\n  static forRoot(): ModuleWithProviders<IgoDownloadModule> {\r\n    return {\r\n      ngModule: IgoDownloadModule\r\n    };\r\n  }\r\n}\r\n","<table class=\"igo-striped mat-typography\" *ngIf=\"ready && feature && isObject(feature.properties) && feature.properties.target !== 'iframe'\">\r\n  <tbody>\r\n    <tr *ngFor=\"let property of filterFeatureProperties(feature) | keyvalue\">\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <mat-icon mat-list-avatar svgIcon=\"{{icon}}\"></mat-icon>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <a href=\"{{property.value}}\" target='_blank' rel=\"noopener noreferrer\"> {{ 'igo.geo.targetHtmlUrl' | translate }} {{title}}</a>\r\n      </td>\r\n\r\n      <td id=\"keyValue\" *ngIf=\"feature.properties.target === undefined\">\r\n        {{property.key }}\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && !isUrl(property.value)\" [innerHTML]=\"property.value\">\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && isUrl(property.value)\">\r\n        <a href=\"{{property.value}}\" target='_blank' rel=\"noopener noreferrer\">\r\n          <img *ngIf=\"isImg(property.value);else notImg\" src=\"{{(property.value | secureImage) | async}}\" width=\"225\" heigth=\"auto\">\r\n          <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' | translate }} </span></ng-template>\r\n        </a>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isObject(property.value)\" [innerHTML]=\"property.value | json\">\r\n      </td>\r\n\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<iframe *ngIf=\"isHtmlDisplay()\" [srcdoc]=\"htmlSanitizer(feature.properties)\" [src]=\"urlSanitizer(feature.properties.url)\"></iframe>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';\r\nimport { Subject } from 'rxjs';\r\nimport { takeUntil } from 'rxjs/operators';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\nimport type { Toolbox } from '@igo2/common';\r\n\r\nimport { Feature } from '../shared';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-feature-details',\r\n  templateUrl: './feature-details.component.html',\r\n  styleUrls: ['./feature-details.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\n\r\nexport class FeatureDetailsComponent implements OnInit, OnDestroy {\r\n  private state: ConnectionState;\r\n  private unsubscribe$ = new Subject<void>();\r\n  ready = false;\r\n\r\n  @Input()\r\n  get source(): SearchSource {\r\n    return this._source;\r\n  }\r\n  set source(value: SearchSource) {\r\n    this._source = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() toolbox: Toolbox;\r\n\r\n  @Input()\r\n  get feature(): Feature {\r\n    return this._feature;\r\n  }\r\n  set feature(value: Feature) {\r\n    this._feature = value;\r\n    this.cdRef.detectChanges();\r\n    this.selectFeature.emit();\r\n  }\r\n\r\n  private _feature: Feature;\r\n  private _source: SearchSource;\r\n\r\n  @Output() routeEvent = new EventEmitter<boolean>();\r\n  @Output() selectFeature = new EventEmitter<boolean>();\r\n  @Output() htmlDisplayEvent = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.feature);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.feature) || 'link';\r\n  }\r\n\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private sanitizer: DomSanitizer,\r\n    private networkService: NetworkService\r\n  ) {\r\n    this.networkService.currentState().pipe(takeUntil(this.unsubscribe$)).subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.ready = true;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribe$.next();\r\n    this.unsubscribe$.complete();\r\n  }\r\n\r\n  urlSanitizer(value): SafeResourceUrl {\r\n    return this.sanitizer.bypassSecurityTrustResourceUrl(value);\r\n  }\r\n\r\n\r\n  isHtmlDisplay(): boolean {\r\n    if (this.feature && this.isObject(this.feature.properties) && this.feature.properties.target === 'iframe') {\r\n      this.htmlDisplayEvent.emit(true);\r\n      return true;\r\n    } else {\r\n      this.htmlDisplayEvent.emit(false);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  htmlSanitizer(value): SafeResourceUrl {\r\n    if (!value.body || userAgent.getBrowserName() === 'Internet Explorer') {\r\n      return;\r\n    }\r\n    const regexBase = /<base href=\"[\\w:\\/\\.]+\">/;\r\n    if (!regexBase.test(value.body)) {\r\n      const url = new URL(value.url, window.location.origin);\r\n      value.body = value.body.replace('<head>', `<head><base href=\"${url.origin}\">`);\r\n    }\r\n\r\n    return this.sanitizer.bypassSecurityTrustHtml(value.body);\r\n  }\r\n\r\n  isObject(value) {\r\n    return typeof value === 'object';\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      return (\r\n        value.slice(0, 8) === 'https://' || value.slice(0, 7) === 'http://'\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  isImg(value) {\r\n    if (this.isUrl(value)) {\r\n      return (\r\n        ['jpg', 'png', 'gif'].includes(value.split('.').pop().toLowerCase())\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  filterFeatureProperties(feature) {\r\n    const allowedFieldsAndAlias = feature.meta ? feature.meta.alias : undefined;\r\n    const properties = {};\r\n    let offlineButtonState;\r\n\r\n    if (this.map) {\r\n      this.map.offlineButtonToggle$.pipe(takeUntil(this.unsubscribe$)).subscribe(state => {\r\n        offlineButtonState = state;\r\n      });\r\n    }\r\n\r\n    if (feature.properties && feature.properties.Route && this.toolbox && !this.toolbox.getTool('directions')) {\r\n      delete feature.properties.Route;\r\n    }\r\n\r\n    if (allowedFieldsAndAlias) {\r\n      Object.keys(allowedFieldsAndAlias).forEach(field => {\r\n        properties[allowedFieldsAndAlias[field]] = feature.properties[field];\r\n      });\r\n      return properties;\r\n    } else if (offlineButtonState !== undefined) {\r\n      if (!offlineButtonState) {\r\n        if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n          const excludeAttribute = feature.meta.excludeAttribute;\r\n          excludeAttribute.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      } else {\r\n        if (feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n        const excludeAttribute = feature.meta.excludeAttribute;\r\n        excludeAttribute.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n        const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n        excludeAttributeOffline.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      }\r\n    }\r\n    return feature.properties;\r\n  }\r\n}\r\n","export enum GeometryType {\r\n    Point = 'Point',\r\n    LineString = 'LineString',\r\n    Polygon = 'Polygon',\r\n    Circle = 'Circle'\r\n}\r\n","import OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport lineIntersect from '@turf/line-intersect';\r\nimport { lineString } from '@turf/helpers';\r\n\r\nimport {\r\n  GeometrySliceMultiPolygonError,\r\n  GeometrySliceLineStringError,\r\n  GeometrySliceTooManyIntersectionError\r\n } from './geometry.errors';\r\n\r\n/**\r\n * Create a default style for draw and modify interactions\r\n * @param color Style color (R, G, B)\r\n * @returns OL style\r\n */\r\nexport function createDrawInteractionStyle(color?: [number, number, number]): olstyle.Circle {\r\n  color = color || [0, 153, 255];\r\n  return new olstyle.Circle({\r\n    stroke: new olstyle.Stroke({\r\n      color: color.concat([1]),\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: color.concat([0.2])\r\n    }),\r\n    radius: 8\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for drawing a hole\r\n * @returns OL style\r\n */\r\nexport function createDrawHoleInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color:  [0, 153, 255, 1],\r\n      width: 2\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Slice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function sliceOlGeometry(\r\n  olGeometry: OlLineString | OlPolygon,\r\n  olSlicer: OlLineString\r\n): Array<OlLineString | OlPolygon> {\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return sliceOlPolygon(olGeometry, olSlicer);\r\n  } else if (olGeometry instanceof OlLineString) {\r\n    return sliceOlLineString(olGeometry, olSlicer);\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL LineString into one or more lines\r\n * @param olLineString OL line string\r\n * @param olSlicer Slicing line\r\n * @returns New OL line strings\r\n */\r\nexport function sliceOlLineString(olLineString: OlLineString, olSlicer: OlLineString): OlLineString[] {\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL Polygon into one or more polygons\r\n * @param olPolygon OL polygon\r\n * @param olSlicer Slicing line\r\n * @returns New OL polygons\r\n */\r\nexport function sliceOlPolygon(olPolygon: OlPolygon, olSlicer: OlLineString): OlPolygon[] {\r\n  if (olPolygon.getLinearRingCount() > 1) {\r\n    throw new GeometrySliceMultiPolygonError();\r\n  }\r\n\r\n  if (olSlicer.getCoordinates().length > 2) {\r\n    throw new GeometrySliceLineStringError();\r\n  }\r\n\r\n  const olGeoJSON = new OlGeoJSON();\r\n  const slicer = olGeoJSON.writeGeometryObject(olSlicer) as any;\r\n  const outerCoordinates = olPolygon.getLinearRing(0).getCoordinates();\r\n\r\n  const parts = [[], []];\r\n  let totalIntersectionCount = 0;\r\n  for (let i = 0, ii = outerCoordinates.length - 1; i < ii; i++) {\r\n    const segmentCoordinates = [outerCoordinates[i], outerCoordinates[i + 1]];\r\n    const segment = lineString(segmentCoordinates);\r\n    const intersections = lineIntersect(segment, slicer).features;\r\n\r\n    const intersectionCount = intersections.length;\r\n    totalIntersectionCount += intersectionCount;\r\n    if (intersectionCount > 1 || totalIntersectionCount > 2) {\r\n      throw new GeometrySliceTooManyIntersectionError();\r\n    }\r\n\r\n    parts[0].push(segmentCoordinates[0]);\r\n    if (intersectionCount === 1) {\r\n      const intersection = intersections[0].geometry.coordinates;\r\n      parts[0].push(intersection);\r\n      parts[1].push(intersection);\r\n      parts.reverse();\r\n    }\r\n  }\r\n\r\n  if (totalIntersectionCount <= 1) {\r\n    return [];\r\n  }\r\n\r\n  parts[0].push(parts[0][0]);\r\n  parts[1].push(parts[1][0]);\r\n\r\n  return [new OlPolygon([parts[0]]), new OlPolygon([parts[1]])];\r\n}\r\n\r\n/**\r\n * Splice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function addLinearRingToOlPolygon(olPolygon: OlPolygon, olLinearRing: OlLinearRing ) {\r\n  // TODO: make some validation and support updating an existing linear ring\r\n  olPolygon.appendLinearRing(olLinearRing);\r\n}\r\n\r\nexport function getMousePositionFromOlGeometryEvent(\r\n  olEvent: BasicEvent\r\n) {\r\n  const olGeometry = olEvent.target as OlGeometry;\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return olGeometry.getFlatCoordinates().slice(-4, -2) as [number, number];\r\n  }\r\n  const olGeometryCast = olGeometry as OlPoint | OlLineString | OlCircle;\r\n  return olGeometryCast.getFlatCoordinates().slice(-2) as [number, number];\r\n}\r\n","/* eslint-disable */\r\n// See this issue: https://github.com/Microsoft/TypeScript/issues/13965\r\n// And the solution: https://github.com/Microsoft/TypeScript/wiki/Breaking-Changes#extending-built-ins-like-error-array-and-map-may-no-longer-work\r\n// for an explanation as to why the prototype is set manually\r\n/* eslint-enable */\r\n\r\nexport class GeometrySliceError extends Error {}\r\n\r\nexport class GeometrySliceMultiPolygonError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice a MultiPolygon.');\r\n    Object.setPrototypeOf(this, GeometrySliceMultiPolygonError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceLineStringError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice with a line that has more than 2 points.');\r\n    Object.setPrototypeOf(this, GeometrySliceLineStringError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceTooManyIntersectionError extends GeometrySliceError {\r\n  constructor() {\r\n    super('More than 2 intersections found between the target polygon and the slicing line.');\r\n    Object.setPrototypeOf(this, GeometrySliceTooManyIntersectionError.prototype);\r\n  }\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlSelect from 'ol/interaction/Select';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { SelectEvent as OlSelectEvent } from 'ol/interaction/Select';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { doubleClick } from 'ol/events/condition';\r\n\r\nimport { Subject, Subscription, fromEvent, BehaviorSubject } from 'rxjs';\r\n\r\nimport { getMousePositionFromOlGeometryEvent } from '../geometry.utils';\r\n\r\nexport interface DrawControlOptions {\r\n  geometryType: typeof OlGeometryType | string;\r\n  drawingLayerSource?: OlVectorSource<OlGeometry>;\r\n  drawingLayer?: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  drawingLayerStyle?: OlStyleLike;\r\n  interactionStyle?: OlStyleLike;\r\n  maxPoints?: number;\r\n}\r\n\r\n/**\r\n * Control to draw entities\r\n */\r\nexport class DrawControl {\r\n  /**\r\n   * Draw start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw changes observable (while drawing)\r\n   */\r\n  public changes$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw modify observable (modify drawn features)\r\n   */\r\n  public modify$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw select observable (modify drawn features)\r\n   */\r\n  public select$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw abort observable (abort drawn features)\r\n   */\r\n     public abort$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Freehand mode observable (defaults to false)\r\n   */\r\n  freehand$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private keyDown$$: Subscription;\r\n\r\n  private olGeometryType: typeof OlGeometryType | undefined | string;\r\n  private olMap: OlMap;\r\n  private olDrawingLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olDrawInteraction: OlDraw;\r\n  private olSelectInteraction: OlSelect;\r\n  private olModifyInteraction: OlModify;\r\n  private onDrawStartKey: EventsKey;\r\n  private onDrawEndKey: EventsKey;\r\n  private onDrawAbortKey: EventsKey;\r\n  private onDrawKey: EventsKey;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olDrawingLayerSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayer.getSource();\r\n  }\r\n\r\n  constructor(private options: DrawControlOptions) {\r\n    this.olDrawingLayer = options.drawingLayer ? options.drawingLayer : this.createOlInnerOverlayLayer();\r\n    this.olGeometryType = this.options.geometryType;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined, activateModifyAndSelect?: boolean) {\r\n    if (!olMap) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlInteractions();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n    this.addOlInteractions(activateModifyAndSelect);\r\n  }\r\n\r\n  /**\r\n   * Return the drawing layer source\r\n   */\r\n  getSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayerSource;\r\n  }\r\n\r\n  /**\r\n   * Set the current geometry type\r\n   * @param geometryType the geometry type\r\n   */\r\n  setGeometryType(geometryType: typeof OlGeometryType) {\r\n    this.olGeometryType = geometryType;\r\n  }\r\n\r\n  /**\r\n   * Create a drawing source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<OlVectorSource<OlGeometry>> {\r\n    return new OlVectorLayer({\r\n      source: this.options.drawingLayerSource ? this.options.drawingLayerSource : new OlVectorSource(),\r\n      style: this.options.drawingLayerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer && this.olMap) {\r\n      this.olMap.removeLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the drawing layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer) {\r\n      this.olMap.addLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (!this.options.drawingLayer && !this.options.drawingLayerSource) {\r\n      this.olDrawingLayerSource.clear(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add interactions to the map an set up some listeners\r\n   */\r\n  addOlInteractions(activateModifyAndSelect?: boolean) {\r\n    // Create Draw interaction\r\n    let olDrawInteraction;\r\n    if (!this.freehand$.getValue()) {\r\n      olDrawInteraction = new OlDraw({\r\n        type: this.olGeometryType,\r\n        source: this.getSource(),\r\n        stopClick: true,\r\n        style: this.options.interactionStyle,\r\n        maxPoints: this.options.maxPoints,\r\n        freehand: false,\r\n        freehandCondition: () => false\r\n      });\r\n\r\n    } else {\r\n      if (this.olGeometryType === 'Point') {\r\n        olDrawInteraction = new OlDraw({\r\n          type: 'Circle',\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n\r\n      } else {\r\n        olDrawInteraction = new OlDraw({\r\n          type: this.olGeometryType,\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      }\r\n    }\r\n\r\n    // Add Draw interaction to map and create listeners\r\n    this.olMap.addInteraction(olDrawInteraction);\r\n    this.olDrawInteraction = olDrawInteraction;\r\n\r\n    this.onDrawStartKey = olDrawInteraction.on('drawstart', (event: OlDrawEvent) => this.onDrawStart(event));\r\n    this.onDrawEndKey = olDrawInteraction.on('drawend', (event: OlDrawEvent) => this.onDrawEnd(event));\r\n    this.onDrawAbortKey = olDrawInteraction.on('drawabort', (event: OlDrawEvent) => this.abort$.next(event.feature.getGeometry()));\r\n\r\n    if (activateModifyAndSelect) {\r\n      // Create a Modify interaction, add it to map and create a listener\r\n      const olModifyInteraction = new OlModify({\r\n        source: this.getSource()\r\n      });\r\n\r\n      this.olMap.addInteraction(olModifyInteraction);\r\n      this.olModifyInteraction = olModifyInteraction;\r\n\r\n      // Create a select interaction and add it to map\r\n      if (!this.olSelectInteraction) {\r\n        const olSelectInteraction = new OlSelect({\r\n          condition: doubleClick,\r\n          style: undefined\r\n        });\r\n        this.olMap.addInteraction(olSelectInteraction);\r\n        this.olSelectInteraction = olSelectInteraction;\r\n\r\n        this.olSelectInteraction.on('select', (event: OlSelectEvent) => this.onSelect(event));\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove interactions\r\n   */\r\n  private removeOlInteractions() {\r\n    this.unsubscribeKeyDown();\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey, this.onDrawAbortKey]);\r\n\r\n    if (this.olMap) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n\r\n    this.olDrawInteraction = undefined;\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * When drawing starts, clear the overlay and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.clearOlInnerOverlaySource();\r\n    this.onDrawKey = olGeometry.on('change', (olGeometryEvent: BasicEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n    this.subscribeKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, update the drawing (feature) geometry observable and add\r\n   * @param event Draw event (drawend)\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    this.unsubscribeKeyDown();\r\n    unByKey(this.onDrawKey);\r\n    const olGeometry = event.feature.getGeometry();\r\n    olGeometry.on('change', () => {\r\n      this.modify$.next(olGeometry);\r\n    });\r\n    this.end$.next(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * When a feature is selected, update the selected feature observable\r\n   * @param event Modify event (modifyend)\r\n   */\r\n  private onSelect(event: OlSelectEvent) {\r\n    if (event.selected.length === 1) {\r\n      this.select$.next(event.selected[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribe to key downs used as drawing interaction shorcuts\r\n   */\r\n  private subscribeKeyDown() {\r\n    this.unsubscribeKeyDown();\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      // On Escape or 'c' keydowns, abort the current drawing\r\n      if (event.key === 'Escape') {\r\n        this.olDrawInteraction.abortDrawing();\r\n        return;\r\n      }\r\n\r\n      // On Backspace or 'u' keydowns, remove last vertex of current drawing\r\n      if (event.key === 'Backspace') {\r\n        this.olDrawInteraction.removeLastPoint();\r\n      }\r\n\r\n      // On Enter or 'f' keydowns, finish current drawing\r\n      if (event.key === 'Enter') {\r\n        this.olDrawInteraction.finishDrawing();\r\n      }\r\n\r\n      // On space bar key down, pan to the current mouse position\r\n      if (event.key === ' ') {\r\n        this.olMap.getView().animate({\r\n          center: this.mousePosition,\r\n          duration: 100\r\n        });\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeKeyDown() {\r\n    if (this.keyDown$$) {\r\n      this.keyDown$$.unsubscribe();\r\n      this.keyDown$$ = undefined;\r\n    }\r\n  }\r\n}\r\n","import { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  label: string;\r\n}\r\n\r\n@Component({\r\n    selector: 'igo-draw-popup-component',\r\n    templateUrl: './draw-popup.component.html',\r\n    styleUrls: ['./draw-popup.component.scss'],\r\n  })\r\n  export class DrawPopupComponent {\r\n\r\n    constructor(\r\n      public dialogRef: MatDialogRef<DrawPopupComponent>,\r\n      @Inject(MAT_DIALOG_DATA) public data: {currentLabel: string}) {}\r\n\r\n    noLabel() {\r\n      this.dialogRef.close();\r\n    }\r\n  }\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">{{'igo.geo.draw.dialogInstruction' | translate}}</p>\r\n  <mat-form-field class=\"example-full-width\">\r\n    <input\r\n      #input\r\n      matInput\r\n      placeholder=\"{{'igo.geo.draw.dialogTitle' | translate}}\"\r\n      value=\"{{data.currentLabel}}\">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button\r\n    mat-raised-button\r\n    (click)=\"noLabel()\">{{'igo.geo.draw.noLabel' | translate}}\r\n  </button>\r\n  <button\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    [mat-dialog-close]=\"input.value\">OK\r\n  </button>\r\n</div>","import { Component } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-draw-shorcuts',\r\n  templateUrl: './draw-shorcuts.component.html',\r\n  styleUrls: ['./draw-shorcuts.component.scss']\r\n})\r\n\r\nexport class DrawShorcutsComponent {}\r\n","<mat-dialog-content>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-return\"></mat-icon>{{'igo.geo.draw.finish' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"backspace-outline\"></mat-icon>{{'igo.geo.draw.undo' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-esc\"></mat-icon>{{'igo.geo.draw.abort' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-space\"></mat-icon>{{'igo.geo.draw.move' | translate}}</span>\r\n  </div>\r\n</mat-dialog-content>\r\n<mat-dialog-actions class=\"shortcuts-close\">\r\n  <button mat-raised-button mat-dialog-close color=\"primary\">OK</button>\r\n</mat-dialog-actions>","\r\nexport const MEASURE_UNIT_AUTO = 'auto';\r\n\r\nexport enum MeasureType {\r\n  Length = 'length',\r\n  Area = 'area'\r\n}\r\n\r\nexport enum MeasureLengthUnit {\r\n  Meters = 'meters',\r\n  Kilometers = 'kilometers',\r\n  Miles = 'miles',\r\n  Feet = 'feet'\r\n}\r\n\r\nexport const MeasureLengthUnitAbbreviation = {\r\n  [MeasureLengthUnit.Meters]: 'm',\r\n  [MeasureLengthUnit.Kilometers]: 'km',\r\n  [MeasureLengthUnit.Miles]: 'mi',\r\n  [MeasureLengthUnit.Feet]: 'ft'\r\n};\r\n\r\nexport enum MeasureAreaUnit {\r\n  SquareMeters = 'squareMeters',\r\n  SquareKilometers = 'squareKilometers',\r\n  SquareMiles = 'squareMiles',\r\n  SquareFeet = 'squareFeet',\r\n  Hectares = 'hectares',\r\n  Acres = 'acres'\r\n}\r\n\r\nexport const MeasureAreaUnitAbbreviation = {\r\n  [MeasureAreaUnit.SquareMeters]: 'm²',\r\n  [MeasureAreaUnit.SquareKilometers]: 'km²',\r\n  [MeasureAreaUnit.SquareMiles]: 'mi²',\r\n  [MeasureAreaUnit.SquareFeet]: 'ft²',\r\n  [MeasureAreaUnit.Hectares]: 'ha',\r\n  [MeasureAreaUnit.Acres]: 'ac'\r\n};\r\n","import { LanguageService } from '@igo2/core';\r\nimport * as olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { getCenter as olGetCenter } from 'ol/extent';\r\nimport {\r\n  getLength as olGetLength,\r\n  getArea as olGetArea\r\n} from 'ol/sphere';\r\n\r\nimport { Measure } from './measure.interfaces';\r\nimport {\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation\r\n} from './measure.enum';\r\n\r\n/**\r\n * Convert value from meters to kilometers\r\n * @param value Value in meters\r\n * @returns Value in kilometers\r\n */\r\nexport function metersToKilometers(value: number): number {\r\n  return value * 0.001;\r\n}\r\n\r\n/**\r\n * Convert value from meters to feet\r\n * @param value Value in meters\r\n * @returns Value in feet\r\n */\r\nexport function metersToFeet(value: number): number {\r\n  return value * 3.2808;\r\n}\r\n\r\n/**\r\n * Convert value from meters to miles\r\n * @param value Value in meters\r\n * @returns Value in miles\r\n */\r\nexport function metersToMiles(value: number): number {\r\n  return value * 0.000621;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square kilometers\r\n * @param value Value in square meters\r\n * @returns Value in square kilometers\r\n */\r\nexport function squareMetersToSquareKilometers(value: number): number {\r\n  return value * 0.000001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square miles\r\n * @param value Value in square meters\r\n * @returns Value in square miles\r\n */\r\nexport function squareMetersToSquareMiles(value: number): number {\r\n  return value * 0.0000003861;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square feet\r\n * @param value Value in square meters\r\n * @returns Value in square feet\r\n */\r\nexport function squareMetersToSquareFeet(value: number): number {\r\n  return value * 10.764;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to hectares\r\n * @param value Value in square meters\r\n * @returns Value in hectares\r\n */\r\nexport function squareMetersToHectares(value: number): number {\r\n  return value * 0.0001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to acres\r\n * @param value Value in square meters\r\n * @returns Value in acres\r\n */\r\nexport function squareMetersToAcres(value: number): number {\r\n  return value * 0.00024711;\r\n}\r\n\r\n/**\r\n * Convert value from meters to the specified length unit\r\n * @param value Value in meters\r\n * @param unit Length unit\r\n * @returns Value in unit\r\n */\r\nexport function metersToUnit(value: number, unit: MeasureLengthUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureLengthUnit.Meters, (val: number) => val],\r\n    [MeasureLengthUnit.Kilometers, metersToKilometers],\r\n    [MeasureLengthUnit.Miles, metersToMiles],\r\n    [MeasureLengthUnit.Feet, metersToFeet],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to the specified area unit\r\n * @param value Value in meters\r\n * @param unit Area unit\r\n * @returns Value in unit\r\n */\r\nexport function squareMetersToUnit(value: number, unit: MeasureAreaUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureAreaUnit.SquareMeters, (val: number) => val],\r\n    [MeasureAreaUnit.SquareKilometers, squareMetersToSquareKilometers],\r\n    [MeasureAreaUnit.SquareMiles, squareMetersToSquareMiles],\r\n    [MeasureAreaUnit.SquareFeet, squareMetersToSquareFeet],\r\n    [MeasureAreaUnit.Hectares, squareMetersToHectares],\r\n    [MeasureAreaUnit.Acres, squareMetersToAcres],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * This method format a measure to a readable format\r\n * @param measure Measure\r\n * @param options Formatting options\r\n * @returns Formatted measure\r\n */\r\nexport function formatMeasure(\r\n  measure: number,\r\n  options?: {\r\n    decimal?: number;\r\n    unit?: MeasureAreaUnit | MeasureLengthUnit;\r\n    unitAbbr?: boolean;\r\n    locale?: string;\r\n  },\r\n  languageService?: LanguageService) {\r\n  let decimal = options.decimal;\r\n  if (decimal === undefined || decimal < 0) {\r\n    decimal = 1;\r\n  }\r\n\r\n  const parts = [];\r\n  if (options.locale !== undefined) {\r\n    parts.push(measure.toLocaleString(options.locale, {\r\n      minimumFractionDigits: decimal,\r\n      maximumFractionDigits: decimal\r\n    }));\r\n  } else {\r\n    parts.push(measure.toFixed(decimal).toString());\r\n  }\r\n\r\n  if (options.unit !== undefined && options.unitAbbr === true) {\r\n    if (languageService) {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] ?\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureLengthUnitAbbreviation[options.unit]) :\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureAreaUnitAbbreviation[options.unit])\r\n      );\r\n    } else {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] || MeasureAreaUnitAbbreviation[options.unit]\r\n      );\r\n    }\r\n  }\r\n\r\n  return parts.filter(p => p !== undefined).join(' ');\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestLengthUnit(value: number): MeasureLengthUnit {\r\n  let unit = MeasureLengthUnit.Meters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureLengthUnit.Kilometers];\r\n  while (converted > 1000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = metersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in square meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestAreaUnit(value: number): MeasureAreaUnit {\r\n  let unit = MeasureAreaUnit.SquareMeters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureAreaUnit.SquareKilometers];\r\n  while (converted > 1000000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = squareMetersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Create a default style for a measure interaction\r\n * @returns OL style\r\n */\r\nexport function createMeasureInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      lineDash: [10, 10],\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    }),\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new olstyle.Stroke({\r\n        color: '#ffcc33',\r\n      }),\r\n      fill: new olstyle.Fill({\r\n        color: 'rgba(255, 255, 255, 0.2)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for a measure layer\r\n * @returns OL style\r\n */\r\nexport function createMeasureLayerStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Compute the length in meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Length in meters\r\n */\r\nexport function measureOlGeometryLength(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetLength(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area in square meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Area in square meters\r\n */\r\nexport function measureOlGeometryArea(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint || olGeometry instanceof OlLineString) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetArea(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area (square meters), length (meters) and last length (meters)\r\n * of an OL geometry with a given projection.\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Computed measure\r\n */\r\nexport function measureOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): Measure {\r\n  const length = measureOlGeometryLength(olGeometry, projection);\r\n  const area = measureOlGeometryArea(olGeometry, projection);\r\n\r\n  const lengths = [];\r\n  const coordinates = olGeometry.getFlatCoordinates();\r\n  const coordinatesLength = coordinates.length;\r\n  for (let i = 0; i <= coordinatesLength - 4; i += 2) {\r\n    const olSegment = new OlLineString([\r\n      [coordinates[i], coordinates[i + 1]],\r\n      [coordinates[i + 2], coordinates[i + 3]]\r\n    ]);\r\n\r\n    lengths.push(measureOlGeometryLength(olSegment, projection));\r\n  }\r\n\r\n  return {\r\n    area,\r\n    length,\r\n    lengths\r\n  };\r\n}\r\n\r\n/**\r\n * Update an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nexport function updateOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n  } else {\r\n    olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n    // TODO: handle multi geometries\r\n    const coordinates = olGeometry.getFlatCoordinates();\r\n    const midpointsLength = olMidpoints.length;\r\n    for (let i = 0; i < midpointsLength; i++) {\r\n      const j = i * 2;\r\n      const olSegment = new OlLineString([\r\n        [coordinates[j], coordinates[j + 1]],\r\n        [coordinates[j + 2], coordinates[j + 3]]\r\n      ]);\r\n\r\n      const midpointCoordinate = olSegment.getCoordinateAt(0.5);\r\n      const olMidpoint = olMidpoints[i];\r\n      if (olMidpoint !== undefined) {\r\n        olMidpoint.setCoordinates(midpointCoordinate);\r\n      } else {\r\n        olMidpoints[i] = new OlPoint(midpointCoordinate);\r\n      }\r\n    }\r\n  }\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Clear an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n */\r\nexport function clearOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle) {\r\n  const olMidpoints = olGeometry.get('_midpoints') || [];\r\n  const midpointsLength = olMidpoints.length;\r\n  for (let i = 0; i < midpointsLength; i++) {\r\n    const olMidpoint = olMidpoints[i];\r\n    if (olMidpoint !== undefined) {\r\n      if (olMidpoint !== undefined) {\r\n        clearOlMidpointTooltip(olMidpoint);\r\n      }\r\n    }\r\n  }\r\n\r\n  olGeometry.set('_midpoints', undefined, true);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Return an array of  OL geometry midpoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nfunction getOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let expectedNumber;\r\n  if (olGeometry instanceof OlCircle) {\r\n    expectedNumber = 0;\r\n  } else {\r\n    expectedNumber = Math.max((olGeometry.getFlatCoordinates().length / 2) - 1, 0);\r\n  }\r\n  // TODO: This works but it's quite messy. If time permits,\r\n  // clean this. Maybe a Tooltip class could handle that\r\n  let olMidpoints = olGeometry.get('_midpoints');\r\n\r\n  if (olMidpoints === undefined) {\r\n    if (olGeometry instanceof OlPoint) {\r\n      olMidpoints = new Array(1);\r\n    } else {\r\n      olMidpoints = new Array(expectedNumber);\r\n    }\r\n    olGeometry.set('_midpoints', olMidpoints, true);\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === 0) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === olMidpoints.length) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber > olMidpoints.length) {\r\n    olMidpoints.push(...new Array(expectedNumber - olMidpoints.length));\r\n    return olMidpoints;\r\n  }\r\n\r\n  for (let i = expectedNumber; i < olMidpoints.length; i++) {\r\n    const olMidpoint = olMidpoints[expectedNumber];\r\n    if (olMidpoint !== undefined) {\r\n      clearOlMidpointTooltip(olMidpoint);\r\n    }\r\n  }\r\n  olMidpoints.splice(expectedNumber);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Remove an OL midpoint's tooltip from the map\r\n * @param olMidpoint OL Point\r\n */\r\nfunction clearOlMidpointTooltip(olMidpoint: OlPoint) {\r\n  const olTooltip = olMidpoint.get('_tooltip');\r\n  if (olTooltip !== undefined) {\r\n    const olMap = olTooltip.getMap();\r\n    if (olMap !== undefined) {\r\n      olMap.removeOverlay(olTooltip);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  let typeGeom = '';\r\n  if (olGeometry instanceof OlLineString) {\r\n  typeGeom = 'line-';\r\n  } else if (olGeometry instanceof OlPolygon) {\r\n    typeGeom = 'polygone-';\r\n    }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipAtPoint(olMidpoint, false, typeGeom);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n  return olMidpoints.map((olMidpoint: OlPoint) => {\r\n    return olMidpoint ? olMidpoint.get('_tooltip') : undefined;\r\n  });\r\n}\r\n\r\n/**\r\n * Update an OL geometry center and return it\r\n * @param olGeometry OL Geometry\r\n * @returns OL point\r\n */\r\nexport function updateOlGeometryCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint {\r\n  let olCenter = olGeometry.get('_center');\r\n  const centerCoordinate = olGetCenter(olGeometry.getExtent());\r\n  if (olCenter !== undefined) {\r\n    olCenter.setCoordinates(centerCoordinate);\r\n  } else {\r\n    olCenter = new OlPoint(centerCoordinate);\r\n    olGeometry.set('_center', olCenter);\r\n  }\r\n\r\n  return olCenter;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipAtPoint(olCenter, true);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = olGeometry.get('_center');\r\n  return olCenter ? olCenter.get('_tooltip') : undefined;\r\n}\r\n\r\n/**\r\n * Get all the tooltips of an OL geometry\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getTooltipsOfOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olTooltips = [].concat(getOlTooltipsAtMidpoints(olGeometry) || []);\r\n  const olCenterTooltip = getOlTooltipAtCenter(olGeometry);\r\n  if (olCenterTooltip !== undefined) {\r\n    olTooltips.push(olCenterTooltip);\r\n  }\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipAtPoint(olPoint: OlPoint, center: boolean = false, srcGeomType: string= ''): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: (center ?\r\n    [ 'igo-map-tooltip',\r\n      'igo-map-tooltip-measure', 'igo-map-tooltip-measure-area'] : ['igo-map-tooltip', 'igo-map-tooltip-measure',\r\n      `igo-map-tooltip-measure-${srcGeomType}segments`]).join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import * as Olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport {\r\n  updateOlGeometryMidpoints,\r\n  updateOlGeometryCenter\r\n} from '../../measure/shared/measure.utils';\r\n\r\n\r\n/**\r\n * Create a default style\r\n * @param fillColor the fill color\r\n * @param strokeColor the stroke color\r\n * @param strokeWidth the stroke width\r\n * @param label a label\r\n * @returns OL style\r\n */\r\nexport function createInteractionStyle(fillColor?: string, strokeColor?: string, strokeWidth?: number, label?: string): Olstyle.Style {\r\n  return new Olstyle.Style({\r\n    stroke: new Olstyle.Stroke({\r\n      color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n      width: strokeWidth ? strokeWidth : 1\r\n    }),\r\n    fill: new Olstyle.Fill({\r\n      color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n    }),\r\n    image: new Olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new Olstyle.Stroke({\r\n        color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n        width: strokeWidth ? strokeWidth : 1\r\n      }),\r\n      fill: new Olstyle.Fill({\r\n        color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsDrawAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else if (olGeometry instanceof OlCircle) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getCenter());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else {\r\n    olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipDrawAtPoint(olMidpoint);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipDrawAtCenter(olGeometry: OlLineString | OlPolygon): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipDrawAtPoint(olCenter);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipDrawAtPoint(olPoint: OlPoint): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: [\r\n      'igo-map-tooltip',\r\n      'igo-map-tooltip-draw'\r\n    ].join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { transform } from 'ol/proj';\r\nimport { MapService } from '../../map/shared/map.service';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n  })\r\nexport class DrawStyleService {\r\n\r\n  private fillColor = 'rgba(255,255,255,0.4)';\r\n  private strokeColor = 'rgba(143,7,7,1)';\r\n  private strokeWidth: number = 1;\r\n  private labelsAreShown = true;\r\n  private icon: string;\r\n\r\n  constructor(\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  getFillColor(): string {\r\n    return this.fillColor;\r\n  }\r\n\r\n  setFillColor(fillColor: string) {\r\n    this.fillColor = fillColor;\r\n  }\r\n\r\n  getStrokeColor(): string {\r\n    return this.strokeColor;\r\n  }\r\n\r\n  setStrokeColor(strokeColor: string) {\r\n    this.strokeColor = strokeColor;\r\n  }\r\n\r\n  getStrokeWidth(): number {\r\n    return this.strokeWidth;\r\n  }\r\n\r\n  getLabelsAreShown() {\r\n    return this.labelsAreShown;\r\n  }\r\n\r\n  toggleLabelsAreShown() {\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n  }\r\n\r\n  setIcon(icon: string) {\r\n    this.icon = icon;\r\n  }\r\n\r\n  getIcon() {\r\n    return this.icon;\r\n  }\r\n\r\n  createDrawingLayerStyle(feature, resolution, labelsAreShown?: boolean, icon?: string): OlStyle.Style {\r\n    let style;\r\n    let labelsAreOffset: boolean = false;\r\n    const proj = this.mapService.getMap().projection;\r\n    const geom = feature.getGeometry();\r\n\r\n    if (geom instanceof OlPoint) {\r\n      labelsAreOffset = !labelsAreOffset;\r\n    }\r\n\r\n    // if feature is a circle\r\n    if (feature.get('rad')) {\r\n      const coordinates = transform(feature.getGeometry().flatCoordinates, proj, 'EPSG:4326');\r\n\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: '20px sans-serif',\r\n          overflow: true\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: feature.get('rad') / Math.cos((Math.PI / 180) * coordinates[1]) / resolution,\r\n          stroke: new OlStyle.Stroke({\r\n            color: this.strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: this.fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n\r\n    // if feature is an icon\r\n    } else if (icon) {\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          offsetY: -26,\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: '20px sans-serif',\r\n          overflow: true\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: this.strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill:  new OlStyle.Fill({\r\n          color: this.fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Icon({\r\n          src: icon\r\n        })\r\n      });\r\n      return style;\r\n\r\n    // if feature is a point, a linestring or a polygon\r\n    } else {\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: '20px sans-serif',\r\n          overflow: true,\r\n          offsetY: labelsAreOffset ? -15 : 0\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: this.strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill: new OlStyle.Fill({\r\n          color: this.fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: 5,\r\n          stroke: new OlStyle.Stroke({\r\n            color: this.strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: this.fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n  })\r\nexport class DrawIconService {\r\n\r\n    protected icons: Array<string>;\r\n\r\n    constructor(\r\n      protected config: ConfigService\r\n    ) {\r\n        this.getIconsList();\r\n    }\r\n\r\n    getIcons() {\r\n        return this.icons;\r\n    }\r\n\r\n    getPath(): any {\r\n      return this.config.getConfig('drawingTool.icons') || [];\r\n    }\r\n\r\n    getIconsList() {\r\n      this.icons = this.getPath();\r\n    }\r\n}\r\n","<div>\r\n  <div class=\"geometry-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      (change)=\"onGeometryTypeChange($event.value)\" [value]=\"geometryType.Point\">\r\n      <mat-button-toggle [value]=\"geometryType.Point\">\r\n        {{('igo.geo.draw.' + geometryType.Point) | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.LineString\">\r\n        {{('igo.geo.draw.' + geometryType.LineString) | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Polygon\">\r\n        {{('igo.geo.draw.' + geometryType.Polygon) | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Circle\">\r\n        {{('igo.geo.draw.' + geometryType.Circle) | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"draw-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"labelsAreShown\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleLabels()\">\r\n      {{'igo.geo.draw.toggleMapTooltips' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <form class=\"igo-form\" [formGroup]=\"form\" >\r\n    <div class=\"fill-color-picker mat-typography\">\r\n      <span>\r\n        <mat-icon class=\"stroke-palette-icon\" svgIcon=\"square\"></mat-icon>\r\n        {{'igo.geo.draw.fill' | translate}}\r\n      </span>\r\n\r\n      <mat-form-field\r\n        class=\"fill-field\"\r\n        appearance=\"outline\"\r\n        floatLabel=\"always\"\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.draw.colorPicker' | translate\">\r\n        <mat-label>{{fillColor}}</mat-label>\r\n\r\n        <input\r\n          formControlName=\"fill\"\r\n          matInput\r\n          type=\"text\"\r\n          [(colorPicker)]=\"fillColor\"\r\n          [style.background]=\"fillColor\"\r\n          [readonly]=\"true\"\r\n          [colorPicker]=\"fillColor\"\r\n          [cpWidth]=\"('200px')\"\r\n          [cpOutputFormat]=\"'rgba'\"\r\n          [cpPosition]=\"'bottom'\"\r\n          [cpPositionOffset]=\"'-75%'\"\r\n          [cpCancelButton]=\"true\"\r\n          [cpCancelButtonText]=\"'igo.geo.draw.cancelColorPicker' | translate\"\r\n          [cpOKButton]=\"true\"\r\n          (colorPickerChange)=\"onColorChange(labelsAreShown, false)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"stroke-color-picker mat-typography\">\r\n      <span>\r\n        <mat-icon class=\"stroke-palette-icon\" svgIcon=\"square-outline\"></mat-icon>\r\n        {{'igo.geo.draw.stroke' | translate}}\r\n      </span>\r\n\r\n      <mat-form-field\r\n        class=\"stroke-field\"\r\n        appearance=\"outline\"\r\n        floatLabel=\"always\"\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.draw.colorPicker' | translate\">\r\n        <mat-label>{{strokeColor}}</mat-label>\r\n\r\n        <input\r\n          formControlName=\"stroke\"\r\n          matInput\r\n          type=\"text\"\r\n          [(colorPicker)]=\"strokeColor\"\r\n          [style.background]=\"strokeColor\"\r\n          [readonly]=\"true\"\r\n          [colorPicker]=\"strokeColor\"\r\n          [cpWidth]=\"('200px')\"\r\n          [cpPosition]=\"'bottom'\"\r\n          [cpPositionOffset]=\"'-75%'\"\r\n          [cpOutputFormat]=\"'rgba'\"\r\n          [cpCancelButton]=\"true\"\r\n          [cpCancelButtonText]=\"'igo.geo.draw.cancelColorPicker' | translate\"\r\n          [cpOKButton]=\"true\"\r\n          (colorPickerChange)=\"onColorChange(labelsAreShown, false)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div>\r\n      <mat-form-field *ngIf=\"icons.length >= 1\">\r\n        <mat-label>{{'igo.geo.draw.icon' | translate}}</mat-label>\r\n        <mat-select>\r\n          <mat-select-trigger>\r\n            <div *ngIf=\"icon\" class=\"box\">\r\n              <img src={{icon}}>\r\n            </div>\r\n          </mat-select-trigger>\r\n          <mat-option value=\"\" (click)=\"onIconChange()\">{{'igo.geo.draw.noIcon' | translate}}</mat-option>\r\n          <mat-option\r\n            *ngFor=\"let icon_html of icons\"\r\n            [value]=\"icon_html\"\r\n            (click)=\"onIconChange(icon_html)\">\r\n            <div class=\"box\">\r\n              <img src={{icon_html}}>\r\n            </div>\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n\r\n  <mat-divider></mat-divider>\r\n\r\n  <div>\r\n    <button *ngIf=\"store.count$.getValue() > 0\"\r\n      class=\"deleteBtn\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.delete' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      (click)=\"deleteDrawings()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-entity-table\r\n      #table\r\n      class=\"table-compact\"\r\n      [store]=\"store\"\r\n      [template]=\"tableTemplate\">\r\n    </igo-entity-table>\r\n  </div>\r\n\r\n  <button\r\n    mat-icon-button\r\n    color=\"accent\"\r\n    disableRipple=\"true\"\r\n    (click)=\"openShorcutsDialog()\">\r\n    <mat-icon\r\n      class=\"shortcuts-icon\"\r\n      svgIcon=\"keyboard-outline\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.shortcuts' | translate\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output\r\n} from '@angular/core';\r\n\r\nimport {\r\n    FEATURE,\r\n    FeatureStore,\r\n    FeatureStoreSelectionStrategy,\r\n    tryBindStoreLayer,\r\n    tryAddLoadingStrategy,\r\n    tryAddSelectionStrategy,\r\n    FeatureMotion,\r\n    FeatureStoreLoadingStrategy\r\n  } from '../../feature';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { GeometryType } from '../shared/draw.enum';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { Draw, FeatureWithDraw } from '../shared/draw.interface';\r\nimport { FormGroup, FormBuilder } from '@angular/forms';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { DrawControl } from '../../geometry/shared/controls/draw';\r\nimport { EntityRecord, EntityTableTemplate } from '@igo2/common';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { getDistance } from 'ol/sphere';\r\nimport { DrawStyleService } from '../shared/draw-style.service';\r\nimport { skip } from 'rxjs/operators';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\nimport { getTooltipsOfOlGeometry } from '../../measure/shared/measure.utils';\r\nimport { createInteractionStyle } from '../shared/draw.utils';\r\nimport { transform } from 'ol/proj';\r\nimport { DrawIconService } from '../shared/draw-icon.service';\r\n\r\n@Component ({\r\n  selector: 'igo-draw',\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\n\r\nexport class DrawComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [{\r\n      name: 'Drawing',\r\n      title: this.languageService.translate.instant('igo.geo.draw.labels'),\r\n      valueAccessor: (feature: FeatureWithDraw) => {\r\n        return feature.properties.draw;\r\n      }\r\n    }]\r\n  };\r\n\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n\r\n  @Output() fillColor: string;\r\n  @Output() strokeColor: string;\r\n  @Output() strokeWidth: number;\r\n\r\n  @Input() map: IgoMap; // Map to draw on\r\n\r\n  @Input() store: FeatureStore<FeatureWithDraw>; // Drawing store\r\n\r\n  public draw$: BehaviorSubject<Draw> = new BehaviorSubject({}); // Observable of draw\r\n\r\n  private olDrawingLayerSource = new OlVectorSource();\r\n  private drawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private drawSelect$$: Subscription;\r\n  private olDrawingLayer: VectorLayer;\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithDraw[]> = new BehaviorSubject([]);\r\n  public fillForm: string;\r\n  public strokeForm: string;\r\n  public drawControlIsDisabled: boolean = true;\r\n  public drawControlIsActive: boolean = false;\r\n  public labelsAreShown: boolean;\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  public position: string = 'bottom';\r\n  public form: FormGroup;\r\n  public icons: Array<string>;\r\n  public icon: string;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formBuilder: FormBuilder,\r\n    private drawStyleService: DrawStyleService,\r\n    private dialog: MatDialog,\r\n    private drawIconService: DrawIconService\r\n  ) {\r\n    this.buildForm();\r\n    this.fillColor = this.drawStyleService.getFillColor();\r\n    this.strokeColor = this.drawStyleService.getStrokeColor();\r\n    this.strokeWidth = this.drawStyleService.getStrokeWidth();\r\n    this.labelsAreShown = this.drawStyleService.getLabelsAreShown();\r\n    this.icons = this.drawIconService.getIcons();\r\n    this.icon = this.drawStyleService.getIcon();\r\n  }\r\n\r\n  // Initialize the store that will contain the entities and create the Draw control\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.drawControl = this.createDrawControl(this.fillColor, this.strokeColor, this.strokeWidth);\r\n    this.drawControl.setGeometryType(this.geometryType.Point as any);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Remove the drawing layer and the interactions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.drawControl.setOlMap(undefined);\r\n    this.subscriptions$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(fillColor?: string, strokeColor?: string, strokeWidth?: number) {\r\n    const drawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.olDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(fillColor, strokeColor, strokeWidth),\r\n    });\r\n\r\n    return drawControl;\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: typeof OlGeometryType) {\r\n    this.drawControl.setGeometryType(geometryType);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Store initialization, including drawing layer creation\r\n   */\r\n  private initStore() {\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n\r\n    this.olDrawingLayer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'igo-draw-layer',\r\n      title: this.languageService.translate.instant('igo.geo.draw.drawing'),\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: (feature, resolution) => {\r\n        return this.drawStyleService.createDrawingLayerStyle(feature, resolution, this.labelsAreShown, this.icon);\r\n      },\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      },\r\n    });\r\n    tryBindStoreLayer(this.store, this.olDrawingLayer);\r\n\r\n    tryAddLoadingStrategy(this.store, new FeatureStoreLoadingStrategy({\r\n      motion: FeatureMotion.None\r\n    }));\r\n\r\n    tryAddSelectionStrategy(this.store, new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      motion: FeatureMotion.None,\r\n      many: true\r\n    }));\r\n    this.store.layer.visible = true;\r\n    this.store.source.ol.on('removefeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const olGeometry = event.feature.getGeometry();\r\n      this.clearLabelsOfOlGeometry(olGeometry);\r\n    });\r\n\r\n    this.subscriptions$$.push(this.store.stateView.manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n      return record.state.selected === true;\r\n    }).pipe(\r\n      skip(1) // Skip initial emission\r\n    ).subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n      this.selectedFeatures$.next(records.map(record => record.entity));\r\n    }));\r\n\r\n    this.subscriptions$$.push(this.store.count$.subscribe(cnt => {\r\n      cnt >= 1 ? this.store.layer.options.showInLayerList = true : this.store.layer.options.showInLayerList = false;\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the color in a color picker\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param isAnIcon wheter the feature is an icon or not\r\n   */\r\n  onColorChange(labelsAreShown: boolean, isAnIcon: boolean) {\r\n    this.fillForm = this.fillColor;\r\n    this.strokeForm = this.strokeColor;\r\n    this.drawStyleService.setFillColor(this.fillColor);\r\n    this.drawStyleService.setStrokeColor(this.strokeColor);\r\n\r\n    if (isAnIcon) {\r\n      this.store.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createDrawingLayerStyle(feature, resolution, labelsAreShown, this.icon);\r\n      });\r\n      this.icon = undefined;\r\n\r\n    } else {\r\n      this.store.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createDrawingLayerStyle(feature, resolution, labelsAreShown);\r\n      });\r\n    }\r\n    this.createDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the Draw control is toggled\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggleIsChecked: boolean) {\r\n    toggleIsChecked ? this.toggleDrawControl() : this.deactivateDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Open a dialog box to enter label and do something\r\n   * @param olGeometry geometry at draw end or selected geometry\r\n   * @param drawEnd event fired at drawEnd?\r\n   */\r\n  private openDialog(olGeometryFeature, isDrawEnd: boolean) {\r\n    setTimeout(() => {\r\n      // open the dialog box used to enter label\r\n      const dialogRef = this.dialog.open(DrawPopupComponent, {\r\n        disableClose: false,\r\n        data: {currentLabel: olGeometryFeature.get('draw')}\r\n      });\r\n\r\n      // when dialog box is closed, get label and set it to geometry\r\n      dialogRef.afterClosed().subscribe((label: string) => {\r\n        this.updateLabelOfOlGeometry(olGeometryFeature, label);\r\n\r\n        // if event was fired at draw end\r\n        if (isDrawEnd) {\r\n          this.onDrawEnd(olGeometryFeature);\r\n\r\n        // if event was fired at select\r\n        } else {\r\n          this.onSelectDraw(olGeometryFeature, label);\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl() {\r\n    this.drawControlIsDisabled = false;\r\n    this.drawControlIsActive = true;\r\n    this.drawEnd$$ = this.drawControl.end$.subscribe((olGeometry: OlGeometry) => {\r\n      this.openDialog(olGeometry, true);\r\n    });\r\n\r\n    this.drawControl.modify$.subscribe((olGeometry: OlGeometry) => {\r\n      this.onModifyDraw(olGeometry);\r\n    });\r\n\r\n    if (!this.drawSelect$$) {\r\n      this.drawSelect$$ = this.drawControl.select$.subscribe((olFeature: OlFeature<OlGeometry>) => {\r\n        this.openDialog(olFeature, false);\r\n      });\r\n    }\r\n\r\n    this.drawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (!this.drawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.drawControl.setOlMap(undefined);\r\n    this.drawControlIsActive = false;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlGeometry, radius?: number) {\r\n    this.addFeatureToStore(olGeometry, radius);\r\n    this.clearLabelsOfOlGeometry(olGeometry);\r\n    this.store.layer.ol.getSource().refresh();\r\n  }\r\n\r\n  private onModifyDraw(olGeometry) {\r\n    const entities = this.store.all();\r\n\r\n    entities.forEach(entity => {\r\n      const entityId = entity.properties.id;\r\n\r\n      const olGeometryId = olGeometry.ol_uid;\r\n\r\n      if (entityId === olGeometryId) {\r\n        this.updateLabelOfOlGeometry(olGeometry, entity.properties.draw);\r\n        this.replaceFeatureInStore(entity, olGeometry);\r\n      }\r\n    });\r\n  }\r\n\r\n  private onSelectDraw(olFeature: OlFeature<OlGeometry>, label: string) {\r\n    const entities = this.store.all();\r\n\r\n    const olGeometry = olFeature.getGeometry() as any;\r\n    olGeometry.ol_uid = olFeature.get('id');\r\n\r\n    const olGeometryCoordinates = JSON.stringify(olGeometry.getCoordinates()[0]);\r\n\r\n    entities.forEach(entity => {\r\n      const entityCoordinates = JSON.stringify(entity.geometry.coordinates[0]);\r\n\r\n      if (olGeometryCoordinates === entityCoordinates) {\r\n        const rad: number = entity.properties.rad ? entity.properties.rad : undefined;\r\n\r\n        this.updateLabelOfOlGeometry(olGeometry, label);\r\n        this.replaceFeatureInStore(entity, olGeometry, rad);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add a feature with draw label to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(olGeometry, radius?: number, feature?: FeatureWithDraw) {\r\n    let rad: number;\r\n    let center4326: Array<number>;\r\n    let point4326: Array<number>;\r\n    let lon4326: number;\r\n    let lat4326: number;\r\n    const featureId = feature ? feature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n\r\n    if (olGeometry instanceof OlCircle || radius) {\r\n      if (radius) {\r\n        rad = radius;\r\n      } else {\r\n        geometry.type = 'Point';\r\n        geometry.coordinates = olGeometry.getCenter();\r\n        const extent4326 = transform([olGeometry.getFlatCoordinates()[2], olGeometry.getFlatCoordinates()[3]], projection, 'EPSG:4326');\r\n        center4326 = transform([olGeometry.getFlatCoordinates()[0], olGeometry.getFlatCoordinates()[1]], projection, 'EPSG:4326');\r\n        lon4326 = center4326[0];\r\n        lat4326 = center4326[1];\r\n        rad = getDistance(center4326, extent4326);\r\n      }\r\n    }\r\n\r\n    if (olGeometry instanceof OlPoint) {\r\n      point4326 = transform(olGeometry.getFlatCoordinates(), projection, 'EPSG:4326');\r\n      lon4326 = point4326[0];\r\n      lat4326 = point4326[1];\r\n    }\r\n\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        draw: olGeometry.get('_label'),\r\n        longitude: lon4326 ? lon4326 : null,\r\n        latitude: lat4326 ? lat4326 : null,\r\n        rad: rad ? rad : null\r\n      },\r\n      meta: {\r\n       id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Replace the feature in the store\r\n   * @param entity the entity to replace\r\n   * @param olGeometry the new geometry to insert in the store\r\n   */\r\n  private replaceFeatureInStore(entity, olGeometry: OlGeometry, radius?: number) {\r\n    this.store.delete(entity);\r\n    this.onDrawEnd(olGeometry, radius);\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      fill: [''],\r\n      stroke: ['']\r\n    });\r\n  }\r\n\r\n  deleteDrawings() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach(selectedFeature => {\r\n      this.olDrawingLayerSource.getFeatures().forEach(drawingLayerFeature => {\r\n        const geometry = drawingLayerFeature.getGeometry() as any;\r\n        if (selectedFeature.properties.id === geometry.ol_uid) {\r\n          this.olDrawingLayerSource.removeFeature(drawingLayerFeature);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometry\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearLabelsOfOlGeometry(olGeometry) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (olTooltip && olTooltip.getMap()) {\r\n        this.map.ol.removeOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the labels toggle\r\n   */\r\n  onToggleLabels() {\r\n    this.drawStyleService.toggleLabelsAreShown();\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n    this.icon ? this.onColorChange(this.labelsAreShown, true) : this.onColorChange(this.labelsAreShown, false);\r\n    }\r\n\r\n  /**\r\n   * Update the label of a geometry when a label is entered in a dialog box\r\n   * @param olGeometry the geometry\r\n   * @param label the label\r\n   */\r\n  private updateLabelOfOlGeometry(olGeometry: OlGeometry, label: string) {\r\n    olGeometry.setProperties({\r\n      _label: label\r\n    }, true);\r\n  }\r\n\r\n  onIconChange(event?) {\r\n    this.icon = event;\r\n    this.drawStyleService.setIcon(this.icon);\r\n    this.store.layer.ol.setStyle((feature, resolution) => {\r\n      return this.drawStyleService.createDrawingLayerStyle(feature, resolution, true, this.icon);\r\n    });\r\n  }\r\n\r\n  openShorcutsDialog() {\r\n    this.dialog.open(DrawShorcutsComponent);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\nimport { DrawComponent } from './draw.component';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatListModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDialogModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule,\r\n    ColorPickerModule\r\n  ],\r\n  declarations: [\r\n    DrawComponent,\r\n    DrawPopupComponent,\r\n    DrawShorcutsComponent\r\n  ],\r\n  exports: [\r\n    DrawComponent\r\n  ]\r\n})\r\nexport class IgoDrawModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoImageModule } from '@igo2/common';\r\n\r\nimport { FeatureDetailsComponent } from './feature-details.component';\r\nimport { FeatureDetailsDirective } from './feature-details.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule,\r\n    IgoImageModule\r\n  ],\r\n  exports: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective],\r\n  declarations: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective]\r\n})\r\nexport class IgoFeatureDetailsModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { FeatureFormComponent } from './feature-form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [\r\n    IgoFormModule,\r\n    FeatureFormComponent\r\n  ],\r\n  declarations: [\r\n    FeatureFormComponent\r\n  ]\r\n})\r\nexport class IgoFeatureFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFeatureDetailsModule } from './feature-details/feature-details.module';\r\nimport { IgoFeatureFormModule } from './feature-form/feature-form.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoFeatureDetailsModule,\r\n    IgoFeatureFormModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoFeatureModule {}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlTranslate from 'ol/interaction/Translate';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlInteraction from 'ol/interaction/Interaction';\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport MapBrowserEvent from 'ol/MapBrowserEvent';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { ModifyEvent as OlModifyEvent } from 'ol/interaction/Modify';\r\nimport { TranslateEvent as OlTranslateEvent } from 'ol/interaction/Translate';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subject, Subscription, fromEvent } from 'rxjs';\r\n\r\nimport {\r\n  addLinearRingToOlPolygon,\r\n  createDrawHoleInteractionStyle,\r\n  getMousePositionFromOlGeometryEvent\r\n} from '../geometry.utils';\r\n\r\nexport interface ModifyControlOptions {\r\n  source?: OlVectorSource<any>;\r\n  layer?: OlVectorLayer<any>;\r\n  layerStyle?: OlStyleLike;\r\n  drawStyle?: OlStyleLike;\r\n  modify?: boolean;\r\n  translate?: boolean;\r\n}\r\n\r\n/**\r\n * Control to modify geometries\r\n */\r\nexport class ModifyControl {\r\n  /**\r\n   * Modify start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Modify end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Geometry changes observable\r\n   */\r\n  public changes$: Subject<OlGeometry> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer<any>;\r\n  public olModifyInteraction: OlModify;\r\n  private onModifyStartKey: any;\r\n  private onModifyEndKey: any;\r\n  private onModifyKey: any;\r\n  private olModifyInteractionIsActive: boolean = false;\r\n  private olTranslateInteraction: OlTranslate;\r\n  private onTranslateStartKey: any;\r\n  private onTranslateEndKey: any;\r\n  private onTranslateKey: any;\r\n  private olTranslateInteractionIsActive: boolean = false;\r\n  private olDrawInteraction: OlDraw;\r\n  private onDrawStartKey: any;\r\n  private onDrawEndKey: any;\r\n  private onDrawKey: any;\r\n  private olDrawInteractionIsActive: boolean = false;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  private keyDown$$: Subscription;\r\n  private drawKeyUp$$: Subscription;\r\n  private drawKeyDown$$: Subscription;\r\n\r\n  private removedOlInteractions: OlInteraction[] = [];\r\n  private olLinearRingsLayer: OlVectorLayer<any>;\r\n\r\n  // This is the geometry to test against when drawing holes\r\n  private olOuterGeometry: OlGeometry;\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<any> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * OL linear rings source\r\n   * @internal\r\n   */\r\n  get olLinearRingsSource(): OlVectorSource<any> {\r\n    return this.olLinearRingsLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * Whether a modify control should be available\r\n   */\r\n  private modify: boolean = true;\r\n\r\n  /**\r\n   * Whether a translate control should be available\r\n   */\r\n  private translate: boolean = true;\r\n\r\n  constructor(private options: ModifyControlOptions) {\r\n    if (options.modify !== undefined) {\r\n      this.modify = options.modify;\r\n    }\r\n    if (options.translate !== undefined) {\r\n      this.translate = options.translate;\r\n    }\r\n\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n    this.olLinearRingsLayer = this.createOlLinearRingsLayer();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlModifyInteraction();\r\n      this.removeOlTranslateInteraction();\r\n      this.removeOlDrawInteraction();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n\r\n    // The order in which these interactions\r\n    // are added is important\r\n    if (this.modify === true) {\r\n      this.addOlDrawInteraction();\r\n    }\r\n\r\n    if (this.translate === true) {\r\n      this.addOlTranslateInteraction();\r\n      this.activateTranslateInteraction();\r\n    }\r\n\r\n    if (this.modify === true) {\r\n      this.addOlModifyInteraction();\r\n      this.activateModifyInteraction();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource<any> {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Add an OL geometry to the overlay and start modifying it\r\n   * @param olGeometry Ol Geometry\r\n   */\r\n  setOlGeometry(olGeometry: OlGeometry) {\r\n    const olFeature = new OlFeature({ geometry: olGeometry });\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  private createOlLinearRingsLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      style: createDrawHoleInteractionStyle(),\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the linear rings layer\r\n   */\r\n  private addOlLinearRingsLayer() {\r\n    this.olMap.addLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings layer\r\n   */\r\n  private removeOlLinearRingsLayer() {\r\n    this.olMap.removeLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings source\r\n   */\r\n  private clearOlLinearRingsSource() {\r\n    this.olLinearRingsSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Add a modify interaction to the map an set up some listeners\r\n   */\r\n  private addOlModifyInteraction() {\r\n    const olModifyInteraction = new OlModify({\r\n      source: this.olOverlaySource,\r\n      style: this.options.drawStyle as OlStyle.Style\r\n    });\r\n    this.olModifyInteraction = olModifyInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the modify interaction\r\n   */\r\n  private removeOlModifyInteraction() {\r\n    if (this.olModifyInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateModifyInteraction();\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  private activateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = true;\r\n    this.onModifyStartKey = this.olModifyInteraction.on(\r\n      'modifystart',\r\n      (event: OlModifyEvent) => this.onModifyStart(event)\r\n    );\r\n    this.onModifyEndKey = this.olModifyInteraction.on(\r\n      'modifyend',\r\n      (event: OlModifyEvent) => this.onModifyEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olModifyInteraction);\r\n  }\r\n\r\n  private deactivateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = false;\r\n\r\n    unByKey([this.onModifyStartKey, this.onModifyEndKey, this.onModifyKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When modifying starts, clear the overlay and start watching for changes\r\n   * @param event Modify start event\r\n   */\r\n  private onModifyStart(event: OlModifyEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onModifyKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        this.changes$.next(olGeometryEvent.target as OlLineString | OlCircle | OlPolygon);\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When modifying ends, update the geometry observable and stop watching for changes\r\n   * @param event Modify end event\r\n   */\r\n  private onModifyEnd(event: OlModifyEvent) {\r\n    unByKey(this.onModifyKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to space key down to pan the map\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key === ' ') {\r\n          // On space bar, pan to the current mouse position\r\n          this.olMap.getView().animate({\r\n            center: this.mousePosition,\r\n            duration: 0\r\n          });\r\n          return;\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a translate interaction to the map an set up some listeners\r\n   */\r\n  private addOlTranslateInteraction() {\r\n    const olTranslateInteraction = new OlTranslate({\r\n      layers: [this.olOverlayLayer]\r\n    });\r\n    this.olTranslateInteraction = olTranslateInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the translate interaction\r\n   */\r\n  private removeOlTranslateInteraction() {\r\n    if (this.olTranslateInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateTranslateInteraction();\r\n    this.olTranslateInteraction = undefined;\r\n  }\r\n\r\n  private activateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = true;\r\n    this.onTranslateStartKey = this.olTranslateInteraction.on(\r\n      'translatestart',\r\n      (event: OlTranslateEvent) => this.onTranslateStart(event)\r\n    );\r\n    this.onTranslateEndKey = this.olTranslateInteraction.on(\r\n      'translateend',\r\n      (event: OlTranslateEvent) => this.onTranslateEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olTranslateInteraction);\r\n  }\r\n\r\n  private deactivateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = false;\r\n    unByKey([\r\n      this.onTranslateStartKey,\r\n      this.onTranslateEndKey,\r\n      this.onTranslateKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olTranslateInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When translation starts, clear the overlay and start watching for changes\r\n   * @param event Translate start event\r\n   */\r\n  private onTranslateStart(event: OlTranslateEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onTranslateKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        // this.changes$.next(olGeometryEvent.target);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Translate end event\r\n   */\r\n  private onTranslateEnd(event: OlTranslateEvent) {\r\n    unByKey(this.onTranslateKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n  }\r\n\r\n  /**\r\n   * Add a draw interaction to the map an set up some listeners\r\n   */\r\n  private addOlDrawInteraction() {\r\n    const olDrawInteraction = new OlDraw({\r\n      type: 'Polygon',\r\n      source: this.olLinearRingsSource,\r\n      stopClick: true,\r\n      style: createDrawHoleInteractionStyle(),\r\n      condition: (event: MapBrowserEvent<any>) => {\r\n        const olOuterGeometry = this.olOuterGeometry || this.getOlGeometry();\r\n        const intersects = olOuterGeometry.intersectsCoordinate(\r\n          event.coordinate\r\n        );\r\n        return intersects;\r\n      }\r\n    });\r\n\r\n    this.olDrawInteraction = olDrawInteraction;\r\n    this.subscribeToDrawKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key down to activate the draw control\r\n   */\r\n  private subscribeToDrawKeyDown() {\r\n    this.drawKeyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyDown();\r\n\r\n        const olGeometry = this.getOlGeometry();\r\n        if (!olGeometry || !(olGeometry instanceof OlPolygon)) {\r\n          return;\r\n        }\r\n\r\n        this.subscribeToDrawKeyUp();\r\n\r\n        this.deactivateModifyInteraction();\r\n        this.deactivateTranslateInteraction();\r\n        this.activateDrawInteraction();\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key up to deactivate the draw control\r\n   */\r\n  private subscribeToDrawKeyUp() {\r\n    this.drawKeyUp$$ = fromEvent(document, 'keyup').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyUp();\r\n        this.unsubscribeToKeyDown();\r\n        this.deactivateDrawInteraction();\r\n\r\n        this.activateModifyInteraction();\r\n        if (this.translate === true) {\r\n          this.activateTranslateInteraction();\r\n        }\r\n        this.subscribeToDrawKeyDown();\r\n\r\n        this.olOuterGeometry = undefined;\r\n        this.clearOlLinearRingsSource();\r\n        this.end$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to draw key down\r\n   */\r\n  private unsubscribeToDrawKeyDown() {\r\n    if (this.drawKeyDown$$ !== undefined) {\r\n      this.drawKeyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key up\r\n   */\r\n  private unsubscribeToDrawKeyUp() {\r\n    if (this.drawKeyUp$$ !== undefined) {\r\n      this.drawKeyUp$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the draw interaction\r\n   */\r\n  private removeOlDrawInteraction() {\r\n    if (this.olDrawInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.unsubscribeToKeyDown();\r\n    this.unsubscribeToDrawKeyUp();\r\n    this.unsubscribeToDrawKeyDown();\r\n    this.deactivateDrawInteraction();\r\n    this.clearOlLinearRingsSource();\r\n    this.olDrawInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * Activate the draw interaction\r\n   */\r\n  private activateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.clearOlLinearRingsSource();\r\n    this.addOlLinearRingsLayer();\r\n\r\n    this.olMap.getInteractions().forEach((olInteraction: OlInteraction) => {\r\n      if (olInteraction instanceof OlDragBoxInteraction) {\r\n        this.olMap.removeInteraction(olInteraction);\r\n        this.removedOlInteractions.push(olInteraction);\r\n      }\r\n    });\r\n\r\n    this.olDrawInteractionIsActive = true;\r\n    this.onDrawStartKey = this.olDrawInteraction.on(\r\n      'drawstart',\r\n      (event: OlDrawEvent) => this.onDrawStart(event)\r\n    );\r\n    this.onDrawEndKey = this.olDrawInteraction.on(\r\n      'drawend',\r\n      (event: OlDrawEvent) => this.onDrawEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olDrawInteraction);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the draw interaction\r\n   */\r\n  private deactivateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.removeOlLinearRingsLayer();\r\n\r\n    this.removedOlInteractions.forEach((olInteraction: OlInteraction) => {\r\n      this.olMap.addInteraction(olInteraction);\r\n    });\r\n    this.removedOlInteractions = [];\r\n\r\n    this.olDrawInteractionIsActive = false;\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When draw start, add a new linerar ring to the geometry and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.olOuterGeometry = this.getOlGeometry().clone();\r\n\r\n    const linearRingCoordinates = olGeometry.getLinearRing().getCoordinates();\r\n    this.addLinearRingToOlGeometry(linearRingCoordinates);\r\n    this.start$.next(this.getOlGeometry());\r\n\r\n    this.onDrawKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        const olGeometryTarget = olGeometryEvent.target as OlPolygon;\r\n        const _linearRingCoordinates = olGeometryTarget\r\n          .getLinearRing(0)\r\n          .getCoordinates();\r\n        this.updateLinearRingOfOlGeometry(_linearRingCoordinates);\r\n        this.changes$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Draw end event\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    unByKey(this.onDrawKey);\r\n    this.olOuterGeometry = undefined;\r\n\r\n    const linearRingCoordinates = event.feature\r\n      .getGeometry()\r\n      .getLinearRing()\r\n      .getCoordinates();\r\n    this.updateLinearRingOfOlGeometry(linearRingCoordinates);\r\n    this.clearOlLinearRingsSource();\r\n    this.end$.next(this.getOlGeometry());\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Add a linear ring to the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private addLinearRingToOlGeometry(coordinates: number[]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    const olLinearRing = new OlLinearRing(coordinates);\r\n    addLinearRingToOlPolygon(olGeometry, olLinearRing);\r\n  }\r\n\r\n  /**\r\n   * Update the last linear ring of the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private updateLinearRingOfOlGeometry(coordinates: number[][]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    // Remove the last linear ring (the one we are updating)\r\n    const olLinearRings = olGeometry.getLinearRings().slice(0, -1);\r\n    const newCoordinates = olLinearRings.map((olLinearRing: OlLinearRing) => {\r\n      return olLinearRing.getCoordinates();\r\n    });\r\n    newCoordinates.push(coordinates);\r\n    olGeometry.setCoordinates(newCoordinates);\r\n  }\r\n\r\n  /**\r\n   * Get the geometry being modified\r\n   * @returns OL Geometry\r\n   */\r\n  private getOlGeometry(): OlGeometry {\r\n    const olFeatures = this.olOverlaySource.getFeatures();\r\n    return olFeatures.length > 0 ? olFeatures[0].getGeometry() : undefined;\r\n  }\r\n}\r\n","export const LAYER = 'Layer';\r\n","<h3 mat-dialog-title>{{'igo.geo.measure.dialog.title' | translate}}</h3>\r\n\r\n<table *ngIf=\"data.length > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.length.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Meters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Kilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Miles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Feet}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInFeet' | translate}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<table *ngIf=\"data.area > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.area.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMeters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat:measureAreaUnit.SquareKilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMiles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Acres}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInAcres' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Hectares}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInHectares' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{'igo.geo.measure.dialog.perimeterInMeters' | translate}}</td>\r\n      <td>{{data.perimeter | measureFormat: measureLengthUnit.Meters}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n","import { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { MeasurerDialogData } from '../shared/measure.interfaces';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit} from '../shared/measure.enum';\r\n\r\n@Component({\r\n  selector: 'igo-measurer-dialog',\r\n  templateUrl: 'measurer-dialog.component.html',\r\n  styleUrls: ['./measurer-dialog.component.scss']\r\n})\r\nexport class MeasurerDialogComponent {\r\n\r\n  measureAreaUnit = MeasureAreaUnit;\r\n\r\n  measureLengthUnit = MeasureLengthUnit;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<MeasurerDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: MeasurerDialogData\r\n  ) {}\r\n\r\n  onNoClick(): void {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n}\r\n","<div>\r\n  <div class=\"measure-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      [value]=\"activeMeasureType\"\r\n      (change)=\"onMeasureTypeChange($event.value)\">\r\n      <mat-button-toggle [value]=\"measureType.Length\">\r\n        {{('igo.geo.measure.' + measureType.Length) | translate}}\r\n      </mat-button-toggle>\r\n      <mat-button-toggle [value]=\"measureType.Area\">\r\n        {{('igo.geo.measure.' + measureType.Area) | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"measure-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.measure.toggleActive' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasLine$ | async)\"\r\n      [checked]=\"displayLines\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayLines($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayLines' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayDistance\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayDistance($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayDistance' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayAreas\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayAreas($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayAreas' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"measureUnitsAuto\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleMeasureUnitsAuto($event.checked)\">\r\n      {{'igo.geo.measure.toggleAutoUnits' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <ng-container *ngIf=\"measure$ | async as measure\">\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Length || activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Length\"\r\n      [measureUnit]=\"measureLengthUnit.Meters\"\r\n      [measure]=\"measure.length\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"(activeMeasureType === measureType.Area ? 'igo.geo.measure.perimeter' : 'igo.geo.measure.length') | translate\"\r\n      (measureUnitChange)=\"onLengthUnitChange($event)\">\r\n    </igo-measurer-item>\r\n\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Area\"\r\n      [measureUnit]=\"measureAreaUnit.SquareMeters\"\r\n      [measure]=\"measure.area\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"'igo.geo.measure.area' | translate\"\r\n      (measureUnitChange)=\"onAreaUnitChange($event)\">\r\n    </igo-measurer-item>\r\n  </ng-container>\r\n\r\n  <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n  <div class=\"measure-store-buttons\">\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.calculate.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"accent\"\r\n      (click)=\"onCalculateClick()\">\r\n      <mat-icon svgIcon=\"calculator\"></mat-icon>\r\n    </button>\r\n\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.delete.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"warn\"\r\n      (click)=\"onDeleteClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <!--button\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.modify.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length !== 1\"\r\n      (click)=\"onModifyClick()\">\r\n      <mat-icon svgIcon=\"edit\"></mat-icon>\r\n    </button-->\r\n  </div>\r\n\r\n  <igo-entity-table\r\n    #table\r\n    class=\"table-compact\"\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport OlStyle from 'ol/style/Style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { LanguageService, StorageScope, StorageService } from '@igo2/core';\r\nimport { EntityRecord, EntityTableTemplate } from '@igo2/common';\r\nimport type { EntityTableComponent } from '@igo2/common';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy\r\n} from '../../feature';\r\nimport { DrawControl, ModifyControl } from '../../geometry/shared';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { Measure, MeasurerDialogData, FeatureWithMeasure } from '../shared/measure.interfaces';\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit,\r\n} from '../shared/measure.enum';\r\nimport {\r\n  measureOlGeometry,\r\n  createMeasureInteractionStyle,\r\n  createMeasureLayerStyle,\r\n  updateOlTooltipsAtMidpoints,\r\n  updateOlTooltipAtCenter,\r\n  getTooltipsOfOlGeometry,\r\n  squareMetersToUnit,\r\n  metersToUnit,\r\n  formatMeasure\r\n} from '../shared/measure.utils';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * Tool to measure lengths and areas\r\n */\r\n@Component({\r\n  selector: 'igo-measurer',\r\n  templateUrl: './measurer.component.html',\r\n  styleUrls: ['./measurer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'length',\r\n        title: this.languageService.translate.instant('igo.geo.measure.lengthHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeLengthUnit;\r\n          const measure = metersToUnit(localFeature.properties.measure.length, unit);\r\n          return formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          });\r\n        }\r\n      },\r\n      {\r\n        name: 'area',\r\n        title: this.languageService.translate.instant('igo.geo.measure.areaHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeAreaUnit;\r\n          const measure = squareMetersToUnit(localFeature.properties.measure.area, unit);\r\n          return measure ? formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          }) : '';\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Reference to the MeasureType enum\r\n   * @internal\r\n   */\r\n  public measureType = MeasureType;\r\n\r\n  /**\r\n   * Reference to the AreaMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureAreaUnit = MeasureAreaUnit;\r\n\r\n  /**\r\n   * Reference to the LengthMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureLengthUnit = MeasureLengthUnit;\r\n\r\n  /**\r\n   * Whether measure units should be automatically determined\r\n   * @internal\r\n   */\r\n  public measureUnitsAuto: boolean = false;\r\n\r\n  /**\r\n   * Whether display of distances of areas\r\n   * @internal\r\n   */\r\n  public displayDistance: boolean = true;\r\n\r\n  /**\r\n   * Whether display of distances of lines\r\n   * @internal\r\n   */\r\n  public displayLines: boolean = true;\r\n\r\n  /**\r\n   * Whether display of areas\r\n   * @internal\r\n   */\r\n  public displayAreas: boolean = true;\r\n\r\n  /**\r\n   * Observable of line boolean\r\n   * @internal\r\n   */\r\n   public hasLine$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area boolean\r\n   * @internal\r\n   */\r\n  public hasArea$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<Measure> = new BehaviorSubject({});\r\n\r\n  /**\r\n   * Observable of selected features\r\n   * @internal\r\n   */\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithMeasure[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * OL draw source\r\n   * @internal\r\n   */\r\n  public showTooltips: boolean = true;\r\n\r\n  /**\r\n   * Whether draw control toggle is disabled or not\r\n   * @internal\r\n   */\r\n  public drawControlIsDisabled: boolean = true;\r\n\r\n  /**\r\n   * Draw line control\r\n   */\r\n  private drawLineControl: DrawControl;\r\n\r\n  /**\r\n   * Draw polygon control\r\n   */\r\n  private drawPolygonControl: DrawControl;\r\n\r\n  /**\r\n   * Modify control\r\n   */\r\n  private modifyControl: ModifyControl;\r\n\r\n  /**\r\n   * Active OL geometry\r\n   */\r\n  private activeOlGeometry: OlLineString | OlPolygon;\r\n\r\n  /**\r\n   * Active mlength unit\r\n   */\r\n  private activeLengthUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  /**\r\n   * Active area unit\r\n   */\r\n  private activeAreaUnit: MeasureAreaUnit = MeasureAreaUnit.SquareMeters;\r\n\r\n  /**\r\n   * Feature added listener key\r\n   */\r\n  private onFeatureAddedKey;\r\n\r\n  /**\r\n   * Feature removed listener key\r\n   */\r\n  private onFeatureRemovedKey;\r\n\r\n  /**\r\n   * Active draw control\r\n   * @internal\r\n   */\r\n  private activeDrawControl: DrawControl;\r\n\r\n  /**\r\n   * Subscription to draw start\r\n   */\r\n  private drawStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to draw end\r\n   */\r\n  private drawEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private drawChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify start\r\n   */\r\n  private modifyStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify end\r\n   */\r\n  private modifyEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private modifyChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to measures selection\r\n   */\r\n  private selectedFeatures$$: Subscription;\r\n\r\n  /**\r\n   * OL draw source\r\n   */\r\n  private olDrawSource = new OlVectorSource();\r\n\r\n  /**\r\n   * The map to measure on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The measures store\r\n   */\r\n  @Input() store: FeatureStore<FeatureWithMeasure>;\r\n\r\n  /**\r\n   * Measure type\r\n   * @internal\r\n   */\r\n  @Input()\r\n  set activeMeasureType(value: MeasureType) { this.setActiveMeasureType(value); }\r\n  get activeMeasureType(): MeasureType { return this._activeMeasureType; }\r\n  private _activeMeasureType: MeasureType;\r\n\r\n  /**\r\n   * The minimum length a segment must have to display a tooltip.\r\n   * It also applies to area tooltips.\r\n   */\r\n  @Input() minSegmentLength: number = 10;\r\n\r\n  @ViewChild('table', { static: true }) table: EntityTableComponent;\r\n\r\n  /**\r\n   * Wheter one of the draw control is active\r\n   * @internal\r\n   */\r\n  get drawControlIsActive(): boolean {\r\n    return this.activeDrawControl !== undefined;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.map.ol.getView().getProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dialog: MatDialog,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * Add draw controls and activate one\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.createDrawLineControl();\r\n    this.createDrawPolygonControl();\r\n    this.createModifyControl();\r\n    this.toggleDrawControl();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    this.checkDistanceAreaToggle();\r\n    this.setActiveMeasureType(MeasureType.Length);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.setActiveMeasureType(undefined);\r\n    this.deactivateModifyControl();\r\n    this.freezeStore();\r\n    this.subscriptions$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onMeasureTypeChange(measureType: MeasureType) {\r\n    this.activeMeasureType = measureType;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggle: boolean) {\r\n    if (toggle === true) {\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.deactivateDrawControl();\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n   onToggleMeasureUnitsAuto(toggle: boolean) {\r\n    this.measureUnitsAuto = toggle;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayDistance(toggle: boolean) {\r\n    this.displayDistance = toggle;\r\n    this.onDisplayDistance();\r\n    toggle ? (this.storageService.set('distanceToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('distanceToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the lines\r\n   * @internal\r\n   */\r\n  onToggleDisplayLines(toggle: boolean) {\r\n    this.displayLines = toggle;\r\n    this.onDisplayLines();\r\n    toggle ? (this.storageService.set('linesToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('linesToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayAreas(toggle: boolean) {\r\n    this.displayAreas = toggle;\r\n    this.onDisplayAreas();\r\n    toggle ? (this.storageService.set('areasToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('areasToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Set display parametres in current values\r\n   * @internal\r\n   */\r\n  checkDistanceAreaToggle(){\r\n    if (this.storageService.get('distanceToggle') === false){\r\n      this.displayDistance = false;\r\n    }\r\n    if (this.storageService.get('linesToggle') === false){\r\n      this.displayLines = false;\r\n    }\r\n    if (this.storageService.get('areasToggle') === false){\r\n      this.displayAreas = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of areas\r\n   * @internal\r\n   */\r\n  onDisplayDistance() {\r\n    if (this.displayDistance) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of lines\r\n   * @internal\r\n   */\r\n  onDisplayLines() {\r\n    if (this.displayLines) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onDisplayAreas() {\r\n    if (this.displayAreas) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onLengthUnitChange(unit: MeasureLengthUnit) {\r\n    this.activeLengthUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onAreaUnitChange(unit: MeasureAreaUnit) {\r\n    this.activeAreaUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  onCalculateClick() {\r\n    const features = this.selectedFeatures$.value;\r\n    const area = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      return sum + localFeature.properties.measure.area || 0;\r\n    }, 0);\r\n    const length = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'Polygon') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n    const perimeter = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'LineString') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n\r\n    this.openDialog({\r\n      area,\r\n      length,\r\n      perimeter\r\n    });\r\n  }\r\n\r\n  onDeleteClick() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach(selectedFeature => {\r\n      this.olDrawSource.getFeatures().forEach(drawingLayerFeature => {\r\n        const geometry = drawingLayerFeature.getGeometry() as any;\r\n        if (selectedFeature.properties.id === geometry.ol_uid) {\r\n          this.olDrawSource.removeFeature(drawingLayerFeature);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  onModifyClick() {\r\n    if (this.selectedFeatures$.value.length !== 1) { return; }\r\n\r\n    if (this.modifyControl.active === true) {\r\n      this.deactivateModifyControl();\r\n      this.toggleDrawControl();\r\n    } else {\r\n      const localFeature = this.selectedFeatures$.value[0];\r\n      const olFeatures = this.store.layer.ol.getSource().getFeatures();\r\n      const olFeature = olFeatures.find((_olFeature: OlFeature<OlGeometry>) => {\r\n        return _olFeature.get('id') === localFeature.properties.id;\r\n      });\r\n\r\n      if (olFeature !== undefined) {\r\n        this.deactivateDrawControl();\r\n        this.activateModifyControl();\r\n\r\n        const olGeometry = olFeature.getGeometry();\r\n        this.clearTooltipsOfOlGeometry(olGeometry as (OlLineString | OlPolygon));\r\n        this.modifyControl.setOlGeometry(olGeometry);\r\n      }\r\n    }\r\n  }\r\n\r\n  private openDialog(data: MeasurerDialogData): void {\r\n    this.dialog.open(MeasurerDialogComponent, {data});\r\n  }\r\n\r\n  /**\r\n   * Initialize the measure store and set up some listeners\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      title: this.languageService.translate.instant('igo.geo.measure.layerTitle'),\r\n      isIgoInternalLayer: true,\r\n      id: `igo-measures-${uuid()}`,\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: createMeasureLayerStyle(),\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: { enabled: false }\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n    store.layer.visible = true;\r\n    layer.visible$.subscribe(visible => {\r\n      if (visible) {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-measure-by-display'));\r\n      }\r\n      else {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-measure-by-display'));\r\n      }\r\n    });\r\n\r\n    tryAddLoadingStrategy(store);\r\n\r\n    tryAddSelectionStrategy(store, new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      many: true\r\n    }));\r\n\r\n    this.onFeatureAddedKey = store.source.ol.on('addfeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const localFeature = event.feature;\r\n      const olGeometry = localFeature.getGeometry() as any;\r\n      this.updateMeasureOfOlGeometry(olGeometry, localFeature.get('measure'));\r\n      this.onDisplayDistance();\r\n    });\r\n\r\n    this.onFeatureRemovedKey = store.source.ol.on('removefeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const olGeometry = event.feature.getGeometry() as any;\r\n      this.clearTooltipsOfOlGeometry(olGeometry);\r\n    });\r\n\r\n    this.selectedFeatures$$ = store.stateView.manyBy$((record: EntityRecord<FeatureWithMeasure>) => {\r\n      return record.state.selected === true;\r\n    }).pipe(\r\n      skip(1) // Skip initial emission\r\n    )\r\n    .subscribe((records: EntityRecord<FeatureWithMeasure>[]) => {\r\n      if (this.modifyControl.active === true) {\r\n        this.deactivateModifyControl();\r\n      }\r\n      this.selectedFeatures$.next(records.map(record => record.entity));\r\n    });\r\n\r\n    this.subscriptions$$.push(this.store.entities$.subscribe(objectsExists => {\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'Polygon')){\r\n        this.hasArea$.next(true);\r\n      } else {\r\n        this.hasArea$.next(false);\r\n      }\r\n\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'LineString')){\r\n        this.hasLine$.next(true);\r\n      } else {\r\n        this.hasLine$.next(false);\r\n      }\r\n    }));\r\n\r\n    this.subscriptions$$.push(this.store.count$.subscribe(cnt => {\r\n      cnt >= 1 ?\r\n        this.store.layer.options.showInLayerList = true :\r\n        this.store.layer.options.showInLayerList = false;\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Freeze any store, meaning the layer is removed, strategies are deactivated\r\n   * and some listener removed\r\n   * @internal\r\n   */\r\n  private freezeStore() {\r\n    const store = this.store;\r\n    this.selectedFeatures$$.unsubscribe();\r\n    unByKey(this.onFeatureAddedKey);\r\n    unByKey(this.onFeatureRemovedKey);\r\n    store.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    store.deactivateStrategyOfType(FeatureStoreSelectionStrategy);\r\n  }\r\n\r\n  /**\r\n   * Create a draw line control\r\n   */\r\n  private createDrawLineControl() {\r\n    this.drawLineControl = new DrawControl({\r\n      geometryType: 'LineString',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createDrawPolygonControl() {\r\n    this.drawPolygonControl = new DrawControl({\r\n      geometryType: 'Polygon',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createModifyControl() {\r\n    this.modifyControl = new ModifyControl({\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate the right control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    // this.deactivateModifyControl();\r\n    if (this.activeMeasureType === MeasureType.Length) {\r\n      this.activateDrawControl(this.drawLineControl);\r\n    } else if (this.activeMeasureType === MeasureType.Area) {\r\n      this.activateDrawControl(this.drawPolygonControl);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param drawControl Draw control\r\n   */\r\n  private activateDrawControl(drawControl: DrawControl) {\r\n    this.drawControlIsDisabled = false;\r\n    this.activeDrawControl = drawControl;\r\n    this.drawStart$$ = drawControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawStart(olGeometry));\r\n    this.drawEnd$$ = drawControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawEnd(olGeometry));\r\n    this.drawChanges$$ = drawControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawChanges(olGeometry));\r\n    this.drawChanges$$ = drawControl.abort$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => {\r\n        this.clearTooltipsOfOlGeometry(olGeometry);\r\n        this.clearMeasures();\r\n      });\r\n    drawControl.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (this.activeDrawControl === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n    if (this.drawStart$$ !== undefined ) { this.drawStart$$.unsubscribe(); }\r\n    if (this.drawEnd$$ !== undefined ) { this.drawEnd$$.unsubscribe(); }\r\n    if (this.drawChanges$$ !== undefined ) { this.drawChanges$$.unsubscribe(); }\r\n\r\n    this.clearTooltipsOfOlSource(this.olDrawSource);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.clearTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.activeDrawControl = undefined;\r\n    this.activeOlGeometry = undefined;\r\n  }\r\n\r\n  private setActiveMeasureType(measureType: MeasureType) {\r\n    this._activeMeasureType = measureType;\r\n    this.clearMeasures();\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = undefined;\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n    this.addFeatureToStore(olGeometry);\r\n    this.clearTooltipsOfOlGeometry(olGeometry);\r\n    this.olDrawSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawChanges(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, Object.assign({}, measure, {\r\n      area: undefined // We don't want to display an area tooltip while drawing.\r\n    }));\r\n    this.measure$.next(measure);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param modifyControl Modify control\r\n   */\r\n  private activateModifyControl() {\r\n    const selection = this.store.getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    selection.deactivate();\r\n    selection.clear();\r\n\r\n    this.modifyStart$$ = this.modifyControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyStart(olGeometry));\r\n    this.modifyEnd$$ = this.modifyControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyEnd(olGeometry));\r\n    this.modifyChanges$$ = this.modifyControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyChanges(olGeometry));\r\n    this.modifyControl.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active modify control\r\n   */\r\n  private deactivateModifyControl() {\r\n    if (this.modifyStart$$ !== undefined ) { this.modifyStart$$.unsubscribe(); }\r\n    if (this.modifyEnd$$ !== undefined ) { this.modifyEnd$$.unsubscribe(); }\r\n    if (this.modifyChanges$$ !== undefined ) { this.modifyChanges$$.unsubscribe(); }\r\n\r\n    if (this.activeOlGeometry !== undefined) {\r\n      if (this.selectedFeatures$.value.length === 1) {\r\n        const localFeature = this.selectedFeatures$.value[0];\r\n        this.addFeatureToStore(this.activeOlGeometry, localFeature);\r\n      }\r\n      this.finalizeMeasureOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n\r\n    this.store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n\r\n    this.activeOlGeometry = undefined;\r\n    this.modifyControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawStart(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyChanges(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawChanges(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  private finalizeMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, measure);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables\r\n   * @param olGeometry Ol linestring or polygon\r\n   * @param measure Measure\r\n   */\r\n  private updateMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon, measure: Measure) {\r\n    olGeometry.setProperties({_measure: measure}, true);\r\n    this.updateTooltipsOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the measures observables\r\n   */\r\n  private clearMeasures() {\r\n    this.measure$.next({});\r\n  }\r\n\r\n  /**\r\n   * Add a feature with measures to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(olGeometry, localFeature?: FeatureWithMeasure) {\r\n    const featureId = localFeature ? localFeature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        measure: olGeometry.get('_measure')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update all the tooltips of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   * @param lengths Lengths of the OL geometry's segments\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = olGeometry.get('_measure');\r\n    const lengths = measure.lengths;\r\n    const area = measure.area;\r\n\r\n    const olMidpointsTooltips = updateOlTooltipsAtMidpoints(olGeometry);\r\n    if (lengths.length === olMidpointsTooltips.length) {\r\n      for (let i = 0; i < olMidpointsTooltips.length; i++) {\r\n        const length = lengths[i];\r\n        if (length !== undefined) {\r\n          this.updateOlTooltip(\r\n            olMidpointsTooltips[i],\r\n            metersToUnit(length, this.activeLengthUnit),\r\n            this.activeLengthUnit,\r\n            MeasureType.Length\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (area !== undefined) {\r\n      this.updateOlTooltip(\r\n        updateOlTooltipAtCenter(olGeometry),\r\n        squareMetersToUnit(area, this.activeAreaUnit),\r\n        this.activeAreaUnit,\r\n        MeasureType.Area\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of a geoemtry\r\n   */\r\n  private showTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (this.shouldShowTooltip(olTooltip)) {\r\n        this.map.ol.addOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometrys\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (olTooltip !== undefined && olTooltip.getMap() !== undefined) {\r\n        this.map.ol.removeOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private updateTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.updateTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private showTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.showTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the map tooltips\r\n   * @param olDrawSource OL vector source\r\n   */\r\n  private clearTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry !== undefined) {\r\n        this.clearTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update an OL tooltip properties and inner HTML and add it to the map if possible\r\n   * @param olTooltip OL tooltip\r\n   * @param measure The measure valeu ti display\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateOlTooltip(\r\n    olTooltip: OlOverlay,\r\n    measure: number,\r\n    unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    type: MeasureType\r\n  ) {\r\n    olTooltip.setProperties({_measure: measure, _unit: unit, _type: type}, true);\r\n    olTooltip.getElement().innerHTML = this.computeTooltipInnerHTML(olTooltip);\r\n    if (this.shouldShowTooltip(olTooltip)) {\r\n      this.map.ol.addOverlay(olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Compute a tooltip's content\r\n   * @param olTooltip OL overlay\r\n   * @returns Inner HTML\r\n   */\r\n  private computeTooltipInnerHTML(olTooltip: OlOverlay): string {\r\n    const properties = olTooltip.getProperties() as any;\r\n    return formatMeasure(properties._measure, {\r\n      decimal: 1,\r\n      unit: properties._unit,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    }, this.languageService);\r\n  }\r\n\r\n  /**\r\n   * Whether a tooltip should be showned based on the length\r\n   * of the segment it is bound to.\r\n   * @param olTooltip OL overlay\r\n   * @returns True if the tooltip should be shown\r\n   */\r\n  private shouldShowTooltip(olTooltip: OlOverlay): boolean {\r\n    if (this.showTooltips === false) {\r\n      return false;\r\n    }\r\n\r\n    const properties = olTooltip.getProperties() as any;\r\n    const measure = properties._measure;\r\n    if (measure === undefined) {\r\n      return false;\r\n    }\r\n\r\n    if (properties._unit === MeasureType.Length) {\r\n      const minSegmentLength = metersToUnit(this.minSegmentLength, properties._unit) || 0;\r\n      return measure > Math.max(minSegmentLength, 0);\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit } from '../shared/measure.enum';\r\nimport { metersToUnit, squareMetersToUnit, formatMeasure } from '../shared/measure.utils';\r\n\r\n/**\r\n * This pipe returns a measure converted from meters (or square meters)\r\n * to the specified unit. It also keeps a certain number of decimals.\r\n */\r\n@Pipe({\r\n  name: 'measureFormat'\r\n})\r\nexport class MeasureFormatPipe implements PipeTransform {\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  transform(\r\n    value: number, unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    unitAbbr: boolean = false,\r\n    decimal: number = 1\r\n  ): number {\r\n    let out;\r\n    if (Object.values(MeasureAreaUnit).indexOf(unit as MeasureAreaUnit) >= 0) {\r\n      out = squareMetersToUnit(value, unit as MeasureAreaUnit);\r\n    } else if (Object.values(MeasureLengthUnit).indexOf(unit as MeasureLengthUnit) >= 0) {\r\n      out = metersToUnit(value, unit as MeasureLengthUnit);\r\n    }\r\n\r\n    return out ? formatMeasure(out, {\r\n      decimal: 1,\r\n      unit,\r\n      unitAbbr,\r\n      locale: 'fr'\r\n    }) : out;\r\n  }\r\n}\r\n","import { DrawControlOptions } from './../shared/controls/draw';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  Optional,\r\n  Self,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { NgControl, ControlValueAccessor } from '@angular/forms';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport * as olproj from 'ol/proj';\r\nimport Point from 'ol/geom/Point';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport {\r\n  MeasureLengthUnit,\r\n  updateOlGeometryMidpoints,\r\n  formatMeasure,\r\n  measureOlGeometry\r\n} from '../../measure';\r\nimport { DrawControl, ModifyControl, ModifyControlOptions } from '../shared/controls';\r\nimport { createDrawInteractionStyle } from '../shared/geometry.utils';\r\nimport { GeoJSONGeometry } from '../shared/geometry.interfaces';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\n\r\n/**\r\n * This input allows a user to draw a new geometry or to edit\r\n * an existing one on a map. A text input is also displayed in the\r\n * form with some instructions.\r\n * This is still WIP.\r\n */\r\n@Component({\r\n  selector: 'igo-geometry-form-field-input',\r\n  templateUrl: './geometry-form-field-input.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class GeometryFormFieldInputComponent implements OnInit, OnDestroy, ControlValueAccessor {\r\n\r\n  private olOverlayLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olGeoJSON = new OlGeoJSON();\r\n  private ready = false;\r\n\r\n  private drawControl: DrawControl;\r\n  private modifyControl: ModifyControl;\r\n  private defaultDrawStyleRadius: number;\r\n  private olGeometryEnds$$: Subscription;\r\n  private olGeometryChanges$$: Subscription;\r\n  private olTooltip = this.createMeasureTooltip();\r\n\r\n  /**\r\n   * Active control\r\n   * @internal\r\n   */\r\n  public activeControl: DrawControl | ModifyControl;\r\n\r\n  /**\r\n   * The map to draw the geometry on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The geometry type\r\n   */\r\n  @Input()\r\n  set geometryType(value: typeof OlGeometryType) {\r\n    this._geometryType = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get geometryType(): typeof OlGeometryType { return this._geometryType; }\r\n  private _geometryType: typeof OlGeometryType;\r\n\r\n  /**\r\n   * The drawGuide around the mouse pointer to help drawing\r\n   */\r\n  @Input() drawGuide: number = null;\r\n\r\n  /**\r\n   * Whether a measure tooltip should be displayed\r\n   */\r\n  @Input() measure: boolean = false;\r\n\r\n  /**\r\n   * Whether draw control should be active or not\r\n   */\r\n  @Input()\r\n  get drawControlIsActive(): boolean { return this._drawControlIsActive; }\r\n  set drawControlIsActive(value: boolean) {\r\n    this._drawControlIsActive = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    this.deactivateControl();\r\n    if (!this._drawControlIsActive) {\r\n      return;\r\n    } else {\r\n      this.toggleControl();\r\n    }\r\n  }\r\n  private _drawControlIsActive: boolean = true;\r\n\r\n  /**\r\n   * Whether freehand draw control should be active or not\r\n   */\r\n  @Input()\r\n  get freehandDrawIsActive(): boolean { return this._freehandDrawIsActive; }\r\n  set freehandDrawIsActive(value: boolean) {\r\n    this._freehandDrawIsActive = value;\r\n    this.deactivateControl();\r\n\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (!this.drawControlIsActive) {\r\n      return;\r\n    }\r\n    this.toggleControl();\r\n  }\r\n  private _freehandDrawIsActive: boolean;\r\n\r\n  /**\r\n   * Control options\r\n   */\r\n  @Input() controlOptions: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Style for the draw control (applies while the geometry is being drawn)\r\n   */\r\n  @Input()\r\n  set drawStyle(value: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle) {\r\n    if (value === undefined) {\r\n      value = createDrawInteractionStyle();\r\n    }\r\n    this._drawStyle = value;\r\n\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(value) as OlStyle.Circle;\r\n    if (olGuideStyle !== undefined) {\r\n      this.defaultDrawStyleRadius = olGuideStyle.getRadius();\r\n    } else {\r\n      this.defaultDrawStyleRadius = null;\r\n    }\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get drawStyle(): OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle { return this._drawStyle; }\r\n  private _drawStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle;\r\n\r\n  /**\r\n   * Style for the overlay layer (applies once the geometry is added to the map)\r\n   * If not specified, drawStyle applies\r\n   */\r\n  @Input()\r\n  set overlayStyle(value: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle) { this._overlayStyle = value; }\r\n  get overlayStyle(): OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle { return this._overlayStyle; }\r\n  private _overlayStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle;\r\n\r\n  /**\r\n   * The geometry value (GeoJSON)\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  @Input()\r\n  set value(value: GeoJSONGeometry) {\r\n    this._value = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (value) {\r\n      this.addGeoJSONToOverlay(value);\r\n    } else {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n    this.onChange(value);\r\n    this.toggleControl();\r\n    this.cdRef.detectChanges();\r\n  }\r\n  get value(): GeoJSONGeometry { return this._value; }\r\n  private _value: GeoJSONGeometry;\r\n\r\n  /**\r\n   * The vector source to add the geometry to\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<OlGeometry> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  @Input()\r\n  set radius(value: any) {\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    if (this.modifyControl.getSource()) {\r\n      this.modifyControl.getSource().refresh();\r\n    }\r\n    if (this.freehandDrawIsActive) {\r\n      let olModify;\r\n      setTimeout(() => {\r\n        olModify = this.modifyControl.olModifyInteraction;\r\n        if (olModify) {\r\n          if (olModify.features_) {\r\n            olModify.features_.clear();\r\n            this.addGeoJSONToOverlay(this.value);\r\n          }\r\n        }\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    @Optional() @Self() public ngControl: NgControl\r\n  ) {\r\n    if (this.ngControl !== undefined) {\r\n      // Setting the value accessor directly (instead of using\r\n      // the providers) to avoid running into a circular import.\r\n      this.ngControl.valueAccessor = this;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an overlay layer, add the initial geometry to it (if any)\r\n   * and toggle the right interaction.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    if (this.drawStyle === undefined) {\r\n      this.drawStyle = createDrawInteractionStyle();\r\n    }\r\n\r\n    if (this.overlayStyle === undefined) {\r\n      this.overlayStyle = this.drawStyle;\r\n    }\r\n\r\n    this.addOlOverlayLayer();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    if (this.value) {\r\n      this.addGeoJSONToOverlay(this.value);\r\n    }\r\n    this.toggleControl();\r\n\r\n    this.ready = true;\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    // This is mandatory when the form control is reused after\r\n    // this component has been destroyed. It seems like the control\r\n    // keeps a reference to this component even after it's destroyed\r\n    // and it attempts to set it's value\r\n    this.ready = false;\r\n\r\n    this.deactivateControl();\r\n    this.olOverlaySource.clear();\r\n    this.map.ol.removeLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnChange(fn: Function) {\r\n    this.onChange = fn;\r\n  }\r\n  private onChange: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnTouched(fn: Function) {\r\n    this.onTouched = fn;\r\n  }\r\n  private onTouched: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  writeValue(value: GeoJSONGeometry) {\r\n    this.value = value;\r\n  }\r\n\r\n  /**\r\n   * Add an overlay layer to the map\r\n   */\r\n  private addOlOverlayLayer() {\r\n    this.olOverlayLayer = new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      zIndex: 500,\r\n      style: null\r\n    });\r\n    this.map.ol.addLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create a draw control and subscribe to it's geometry\r\n   */\r\n  private createDrawControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      geometryType: this.geometryType || 'Point',\r\n      drawingLayer: this.olOverlayLayer,\r\n      interactionStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as DrawControlOptions;\r\n    this.drawControl = new DrawControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Create a modify control and subscribe to it's geometry\r\n   */\r\n  private createModifyControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      layer: this.olOverlayLayer,\r\n      drawStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as ModifyControlOptions;\r\n    this.modifyControl = new ModifyControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Toggle the proper control (draw or modify)\r\n   */\r\n  private toggleControl() {\r\n    let activate;\r\n    if (!this.value && this.geometryType) {\r\n      activate = this.drawControl;\r\n    } else {\r\n      activate = this.modifyControl;\r\n    }\r\n\r\n    // If the control that should be activated\r\n    // is not the same as the current active control,\r\n    // deactivate the current control and activate the new one\r\n    // Otherwise, do nothing and keep the current control active\r\n    if (activate !== this.activeControl) {\r\n      this.deactivateControl();\r\n      this.activateControl(activate);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param control Control\r\n   */\r\n  private activateControl(control: DrawControl | ModifyControl) {\r\n    this.activeControl = control;\r\n    this.olGeometryEnds$$ = control.end$\r\n      .subscribe((olGeometry: OlGeometry) => this.onOlGeometryEnds(olGeometry));\r\n    if (this.measure === true && control === this.drawControl) {\r\n      this.olGeometryChanges$$ = control.changes$\r\n        .subscribe((olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) => this.onOlGeometryChanges(olGeometry));\r\n    }\r\n    control.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active control\r\n   */\r\n  private deactivateControl() {\r\n    this.removeMeasureTooltip();\r\n    if (this.activeControl !== undefined) {\r\n      this.activeControl.setOlMap(undefined);\r\n    }\r\n    if (this.olGeometryEnds$$ !== undefined) {\r\n      this.olGeometryEnds$$.unsubscribe();\r\n    }\r\n    if (this.olGeometryChanges$$ !== undefined) {\r\n      this.olGeometryChanges$$.unsubscribe();\r\n    }\r\n    this.activeControl = undefined;\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryEnds(olGeometry: OlGeometry | undefined) {\r\n    this.removeMeasureTooltip();\r\n    this.setOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryChanges(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    if (olGeometry.getType() !== 'Point') {\r\n      this.updateMeasureTooltip(olGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, convert the output value to GeoJSON and keep it.\r\n   * Restore the double click interaction.\r\n   * @param olGeometry OL geometry\r\n   */\r\n  private setOlGeometry(olGeometry: OlGeometry | undefined) {\r\n    let value;\r\n    if (olGeometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (olGeometry.getType() === 'Circle') { // Because Circle doesn't exist as a GeoJSON object\r\n      olGeometry = this.circleToPoint(olGeometry);\r\n    }\r\n\r\n    value = this.olGeoJSON.writeGeometryObject(olGeometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: 'EPSG:4326'\r\n    });\r\n    if (olGeometry.get('radius')) {\r\n      value.radius = olGeometry.get('radius');\r\n      olGeometry.set('radius', value.radius);\r\n    }\r\n    this.writeValue(value);\r\n  }\r\n\r\n  private circleToPoint(olGeometry) {\r\n    const center = olGeometry.getCenter();\r\n    const coordinates = olproj.transform(center, this.map.projection, 'EPSG:4326');\r\n    const radius = Math.round(olGeometry.getRadius() * (Math.cos((Math.PI / 180) * coordinates[1])));\r\n\r\n    // Convert it to a point object\r\n    olGeometry = new Point(center);\r\n    olGeometry.set('radius', radius, true);\r\n    return olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Add a GeoJSON geometry to the overlay\r\n   * @param geometry GeoJSON geometry\r\n   */\r\n  private addGeoJSONToOverlay(geometry: GeoJSONGeometry) {\r\n    const olGeometry = this.olGeoJSON.readGeometry(geometry, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: this.map.projection\r\n    });\r\n    const olFeature = new OlFeature({\r\n      geometry: olGeometry\r\n    });\r\n    olFeature.setStyle(this.overlayStyle as OlStyle.Style);\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create the measure tooltip\r\n   */\r\n  private createMeasureTooltip() {\r\n    return new OlOverlay({\r\n      element: document.createElement('div'),\r\n      offset: [-30, -10],\r\n      className: [\r\n        'igo-map-tooltip',\r\n        'igo-map-tooltip-measure'\r\n      ].join(' '),\r\n      stopEvent: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the measure tooltip of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   */\r\n  private updateMeasureTooltip(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    const measure = measureOlGeometry(olGeometry, this.map.projection);\r\n    const lengths = measure.lengths;\r\n    const lastIndex = olGeometry.getType() === 'Polygon' ? lengths.length - 2 : lengths.length - 1;\r\n    const lastLength = lengths[lastIndex];\r\n\r\n    const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n    const olLastMidpoint = olMidpoints[lastIndex];\r\n    if (olMidpoints.length === 0 || olLastMidpoint === undefined) {\r\n      this.removeMeasureTooltip();\r\n      return;\r\n    }\r\n\r\n    this.olTooltip.setPosition(olLastMidpoint.getFlatCoordinates());\r\n\r\n    const innerHtml = formatMeasure(lastLength, {\r\n      decimal: 1,\r\n      unit: MeasureLengthUnit.Meters,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    });\r\n    this.olTooltip.getElement().innerHTML = innerHtml;\r\n    if (this.olTooltip.getMap() === undefined) {\r\n      this.map.ol.addOverlay(this.olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the measure tooltip from the map\r\n   */\r\n  private removeMeasureTooltip() {\r\n    if (this.olTooltip.getMap && this.olTooltip.getMap() !== undefined) {\r\n      this.map.ol.removeOverlay(this.olTooltip);\r\n      this.olTooltip.setMap(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adjust the draw style with the specified draw guide distance, if possible\r\n   * @param olStyle Draw style to update\r\n   * @param resolution Resolution (to make the screen size of symbol fit the drawGuide value)\r\n   */\r\n  private updateDrawStyleWithDrawGuide(\r\n    olStyle: OlStyle.Style |\r\n    ((feature, resolution) => OlStyle.Style) |\r\n    OlStyle.Circle,\r\n    resolution: number) {\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(olStyle) as OlStyle.Circle;\r\n    if (olGuideStyle === undefined) {\r\n      return;\r\n    }\r\n\r\n    const drawGuide = this.drawGuide;\r\n    let radius;\r\n    if (!drawGuide || drawGuide < 0) {\r\n      radius = this.defaultDrawStyleRadius;\r\n    } else {\r\n      radius = drawGuide > 0 ? drawGuide / resolution : drawGuide;\r\n    }\r\n    olGuideStyle.setRadius(radius);\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private isStyleWithRadius(olStyle) {\r\n    return typeof olStyle !== 'function' && olStyle.setRadius;\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private getGuideStyleFromDrawStyle(\r\n    olStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle |\r\n    OlStyle.Style[] | ((feature, resolution) => OlStyle.Style)[] | OlStyle.Circle[]\r\n  ) {\r\n    if (Array.isArray(olStyle)) {\r\n      olStyle = olStyle[0];\r\n    }\r\n    if (this.isStyleWithRadius(olStyle)) {\r\n      return olStyle;\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n","<ng-template></ng-template>","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { GeometryFormFieldComponent } from './geometry-form-field.component';\r\nimport { GeometryFormFieldInputComponent } from './geometry-form-field-input.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ],\r\n  declarations: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ]\r\n})\r\nexport class IgoGeometryFormFieldModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoGeometryFormFieldModule } from './geometry-form-field/geometry-form-field.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoGeometryModule {}\r\n","<button *ngIf=\"header && options.timeFilterable && options.timeFilter\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"history\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"header && options.timeFilterable && options.timeFilter\">\r\n  <igo-time-filter-item\r\n    *ngIf=\"timeFilterCollapse && options.timeFilter\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [layer]=\"layer\">\r\n  </igo-time-filter-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { TimeFilterableDataSourceOptions } from '../shared/time-filter.interface';\r\nimport { WMSDataSourceOptions } from '../../datasource/shared/datasources/wms-datasource.interface';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-button',\r\n  templateUrl: './time-filter-button.component.html',\r\n  styleUrls: ['./time-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterButtonComponent implements OnInit {\r\n\r\n  public options: TimeFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.timeFilter as any;\r\n    if (filter && filter.enabled) {\r\n      return 1;\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  public timeFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n  }\r\n}\r\n","<div *ngIf=\"style === 'calendar' && type !=='year'\">\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n    <mat-form-field>\r\n      <mat-datetimepicker-toggle [for]=\"datetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n      <mat-datetimepicker #datetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n      <input matInput autocomplete=\"false\"\r\n        placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\"\r\n        [matDatetimepicker]=\"datetimePicker\"\r\n        [(ngModel)]=\"date\"\r\n        [min]=\"min\"\r\n        [max]=\"max\"\r\n        readonly=\"readonly\"\r\n        (dateChange)=\"handleDateChange($event)\">\r\n    </mat-form-field>\r\n\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle [for]=\"minDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #minDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\"\r\n          [matDatetimepicker]=\"minDatetimePicker\"\r\n          [(ngModel)]=\"startDate\"\r\n          [min]=\"min\"\r\n          [max]=\"getRangeMaxDate()\"\r\n          readonly=\"readonly\"\r\n          (input)=\"startDate\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle [for]=\"maxDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #maxDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\"\r\n          [matDatetimepicker]=\"maxDatetimePicker\"\r\n          [(ngModel)]=\"endDate\"\r\n          [min]=\"getRangeMinDate()\"\r\n          [max]=\"max\"\r\n          readonly=\"readonly\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<div *ngIf=\"style === 'calendar' && type ==='year'\">\r\n\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\" [(ngModel)]=\"year\" (selectionChange)=\"handleYearChange($event)\">\r\n                  <mat-option [value]=\"year\" *ngFor=\"let year of listYears\">{{year}}</mat-option>\r\n            </mat-select>\r\n        </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\" [(ngModel)]=\"startYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"startYear\" *ngFor=\"let startYear of startListYears\">{{startYear}}</mat-option>\r\n            </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n    <mat-form-field>\r\n        <mat-select placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\" [(ngModel)]=\"endYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"endYear\" *ngFor=\"let endYear of endListYears\">{{endYear}}</mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n\r\n</div>\r\n\r\n\r\n  <br>\r\n  <div *ngIf=\"!isRange && style === 'slider' && type === 'year'\" class=\"igo-col igo-col-100 igo-col-100-m mat-typography\">\r\n    <span>{{startYear}}</span>\r\n    <mat-slider\r\n        id=\"time-slider\"\r\n        tickInterval=\"auto\"\r\n        step=\"{{step}}\"\r\n        [min]=\"startYear\"\r\n        [max]=\"endYear\"\r\n        [value]=\"handleSliderValue()\"\r\n        [color]=\"color\"\r\n        thumbLabel\r\n        (input)=\"handleSliderYearChange($event)\"\r\n        (change)=\"handleSliderYearChange($event)\"\r\n        [disabled]= \"!options.enabled || !layer.visible\">\r\n    </mat-slider>\r\n    <span>{{endYear}}</span>\r\n    <p *ngIf= \"options.enabled\" class=\"date-below\">{{year}}</p>\r\n    <div #actions class=\"igo-layer-actions-container\">\r\n      <mat-slide-toggle (change)=\"toggleFilterState()\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" [color]=\"color\" [checked]=\"options.enabled\"\r\n        [disabled]=\"!layer.visible\">\r\n      </mat-slide-toggle>\r\n      <button [disabled]= \"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"playYear($event)\">\r\n        <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n       </button>\r\n      <button [disabled]=\"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n<div *ngIf=\"style === 'slider' && type !== 'year'\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n  <mat-slider\r\n      id=\"time-slider\"\r\n      tickInterval=\"auto\"\r\n      step=\"{{step}}\"\r\n      [min]=\"dateToNumber(min)\"\r\n      [max]=\"dateToNumber(max)\"\r\n      [value]=\"handleSliderValue()\"\r\n      thumbLabel\r\n      (input)=\"handleSliderDateChange($event)\"\r\n      (selectionChange)=\"handleSliderDateChange($event)\">\r\n  </mat-slider>\r\n  <p class=\"date-below\">{{handleSliderTooltip()}}</p>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n   <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { DateAdapter } from '@angular/material/core';\r\nimport { MatSlider } from '@angular/material/slider';\r\nimport * as moment from 'moment';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterOptions } from '../shared/time-filter.interface';\r\nimport { TimeFilterType, TimeFilterStyle } from '../shared/time-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-form',\r\n  templateUrl: './time-filter-form.component.html',\r\n  styleUrls: ['./time-filter-form.component.scss']\r\n})\r\nexport class TimeFilterFormComponent implements OnInit {\r\n  @Input() layer: Layer;\r\n\r\n  @Input() options: TimeFilterOptions;\r\n\r\n  public color = 'primary';\r\n  public date: Date;\r\n  public startDate: Date;\r\n  public endDate: Date;\r\n  public year: any;\r\n  public startYear: any;\r\n  public endYear: any;\r\n  public initStartYear: any;\r\n  public initEndYear: any;\r\n  public listYears: Array<string> = [];\r\n  public startListYears: Array<string> = [];\r\n  public endListYears: Array<string> = [];\r\n\r\n  @Input()\r\n  set currentValue(value: string) {\r\n    if (value) {\r\n      if (this.type !== TimeFilterType.YEAR) {\r\n        const valueArray = value.split('/');\r\n        if (valueArray.length > 0) {\r\n          const startDate = new Date(valueArray[0]);\r\n          const endDate = new Date(valueArray[1]);\r\n          if (!isNaN(startDate.valueOf())) {\r\n            this.startDate = startDate;\r\n          }\r\n          if (!isNaN(endDate.valueOf())) {\r\n            this.endDate = endDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public interval: any;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  @Output() change: EventEmitter<Date | [Date, Date]> = new EventEmitter();\r\n  @Output()\r\n  yearChange: EventEmitter<string | [string, string]> = new EventEmitter();\r\n  @ViewChild(MatSlider) mySlider;\r\n\r\n  get type(): TimeFilterType {\r\n    return this.options.type === undefined\r\n      ? TimeFilterType.DATE\r\n      : this.options.type;\r\n  }\r\n\r\n  get isRange(): boolean {\r\n    return this.options.range === undefined ||\r\n      this.options.style === TimeFilterStyle.SLIDER\r\n      ? false\r\n      : this.options.range;\r\n  }\r\n\r\n  get style(): TimeFilterStyle {\r\n    return this.options.style === undefined\r\n      ? TimeFilterStyle.SLIDER\r\n      : this.options.style;\r\n  }\r\n\r\n  get step(): number {\r\n    let step = 10800000;\r\n    if (this.options.step === undefined) {\r\n      switch (this.type) {\r\n        case TimeFilterType.DATE:\r\n        case TimeFilterType.DATETIME:\r\n          step = 10800000;\r\n          break;\r\n        case TimeFilterType.TIME:\r\n          step = 3600000;\r\n          break;\r\n        case TimeFilterType.YEAR:\r\n          step = 31536000000;\r\n          break;\r\n        default:\r\n          step = 10800000;\r\n      }\r\n    } else {\r\n      step = this.getStepDefinition(this.options.step);\r\n    }\r\n\r\n    return step;\r\n  }\r\n\r\n  get timeInterval(): number {\r\n    return this.options.timeInterval === undefined\r\n      ? 2000\r\n      : this.options.timeInterval;\r\n  }\r\n\r\n  get min(): Date {\r\n    if (this.options.min) {\r\n      const min = new Date(this.options.min);\r\n      return new Date(min.getTime() + min.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get max(): Date {\r\n    if (this.options.max) {\r\n      const max = new Date(this.options.max);\r\n      return new Date(max.getTime() + max.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get is(): boolean {\r\n    return this.options.range === undefined ? false : this.options.range;\r\n  }\r\n\r\n  constructor(private dateAdapter: DateAdapter<Date>) {\r\n    this.dateAdapter.setLocale('fr');\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.startDate === undefined) {\r\n      this.startDate = new Date(this.min);\r\n    }\r\n    if (this.endDate === undefined) {\r\n      this.endDate = new Date(this.max);\r\n    }\r\n    if (this.startYear === undefined) {\r\n      this.startYear = new Date(this.startDate).getFullYear();\r\n      this.initStartYear = this.startYear;\r\n    }\r\n    if (this.endYear === undefined) {\r\n      this.endYear = new Date(this.endDate).getFullYear();\r\n      this.initEndYear = this.endYear;\r\n    }\r\n\r\n    if (!this.isRange) {\r\n      for (let i = this.startYear; i <= this.endYear + 1; i++) {\r\n        this.listYears.push(i);\r\n      }\r\n    } else {\r\n      for (let i = this.startYear; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      for (let i = this.startYear + 1; i <= this.endYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n    }\r\n    this.options.enabled =\r\n      this.options.enabled === undefined ? true : this.options.enabled;\r\n    this.checkFilterValue();\r\n    if (this.options.enabled) {\r\n      if (!this.isRange && this.style === 'slider' && this.type === 'year') {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.storeCurrentFilterValue();\r\n      this.yearChange.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  storeCurrentFilterValue() {\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.options.value = this.year.toString();\r\n    }\r\n  }\r\n\r\n  checkFilterValue() {\r\n    const olSource = this.layer.dataSource.ol as olSourceImageWMS;\r\n    const timeFromWms = olSource.getParams().TIME;\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.year = new Date(timeFromWms.toString()).getFullYear() + 1;\r\n      } else if (this.options.value) {\r\n        this.year = new Date(this.options.value.toString()).getFullYear() + 1;\r\n      } else {\r\n        this.year = new Date(this.min).getFullYear() + 1;\r\n      }\r\n    } else if (\r\n      this.isRange &&\r\n      this.style === TimeFilterStyle.CALENDAR &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.startYear = parseInt(timeFromWms.substr(0, 4), 10);\r\n        this.endYear = parseInt(timeFromWms.substr(5, 4), 10);\r\n        const newStartListYears: any[] = [];\r\n        const newEndListYears: any[] = [];\r\n        for (let i = this.initStartYear; i < this.endYear; i++) {\r\n          newStartListYears.push(i);\r\n        }\r\n        for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n          newEndListYears.push(i);\r\n        }\r\n        this.startListYears = newStartListYears;\r\n        this.endListYears = newEndListYears;\r\n      }\r\n    }\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n  }\r\n\r\n  handleDateChange(event: any) {\r\n    this.setupDateOutput();\r\n    this.applyTypeChange();\r\n\r\n    // Only if is range, use 2 dates to make the range\r\n    if (this.isRange) {\r\n      this.change.emit([this.startDate, this.endDate]);\r\n    } else {\r\n      this.change.emit(this.startDate);\r\n    }\r\n  }\r\n\r\n  handleYearChange(event: any) {\r\n    if (this.isRange) {\r\n      this.endListYears = [];\r\n      for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n      this.startListYears = [];\r\n      for (let i = this.initStartYear + 1; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      this.yearChange.emit([this.startYear, this.endYear]);\r\n    } else {\r\n      this.yearChange.emit(this.year);\r\n    }\r\n  }\r\n\r\n  handleListYearChange(event: any) {\r\n    this.handleYearChange([this.startYear, this.endYear]);\r\n  }\r\n\r\n  handleListYearStartChange(event: any) {\r\n    this.change.emit([this.startDate, this.endDate]);\r\n  }\r\n\r\n  dateToNumber(date: Date): number {\r\n    let newDate;\r\n    if (date) {\r\n      newDate = new Date(date);\r\n    } else {\r\n      newDate = new Date(this.min);\r\n    }\r\n\r\n    return newDate.getTime();\r\n  }\r\n\r\n  setSliderThumbLabel(label: string) {\r\n    const thumbLabel = this.findThumbLabel(\r\n      this.mySlider._elementRef.nativeElement.childNodes\r\n    );\r\n    if (thumbLabel) {\r\n      thumbLabel.textContent = label;\r\n    }\r\n  }\r\n\r\n  findThumbLabel(test: any[]): any {\r\n    let thumbLabel;\r\n\r\n    test.forEach(value => {\r\n      if (value.className === 'mat-slider-thumb-label-text') {\r\n        thumbLabel = value;\r\n      }\r\n\r\n      if (value.children.length > 0 && !thumbLabel) {\r\n        thumbLabel = this.findThumbLabel(value.childNodes);\r\n      }\r\n    }, this);\r\n    return thumbLabel;\r\n  }\r\n\r\n  toggleFilterState() {\r\n    this.options.enabled = !this.options.enabled;\r\n\r\n    if (this.options.enabled) {\r\n      if (\r\n        !this.isRange &&\r\n        TimeFilterStyle.SLIDER &&\r\n        this.type === TimeFilterType.YEAR\r\n      ) {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.stopFilter();\r\n      this.storeCurrentFilterValue();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    this.date = new Date(this.min);\r\n    this.year = this.date.getFullYear();\r\n    if (\r\n      !this.isRange &&\r\n      TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.yearChange.emit(this.year);\r\n    } else {\r\n      this.setupDateOutput();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n          let newMinDateNumber;\r\n          const maxDateNumber = new Date(that.max);\r\n\r\n          newMinDateNumber =\r\n            that.date === undefined ? that.min.getTime() : that.date.getTime();\r\n          newMinDateNumber += that.mySlider.step;\r\n          that.date = new Date(newMinDateNumber);\r\n\r\n          if (newMinDateNumber > maxDateNumber.getTime()) {\r\n            that.stopFilter();\r\n          }\r\n\r\n          that.handleDateChange({ value: that.date, date: that.date });\r\n        },\r\n        this.timeInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  playYear(event: any) {\r\n    if (\r\n      this.year + this.mySlider.step >\r\n      this.max.getFullYear() + this.mySlider.step\r\n    ) {\r\n      this.stopFilter();\r\n      this.resetFilter(event);\r\n    }\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(() => {\r\n        if (\r\n          (this.year + this.mySlider.step) > this.max.getFullYear()) {\r\n          this.stopFilter();\r\n        } else {\r\n          this.year = this.year + this.mySlider.step;\r\n        }\r\n        this.yearChange.emit(this.year);\r\n\r\n      }, this.timeInterval, this);\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  handleSliderDateChange(event: any) {\r\n    this.date = new Date(event.value);\r\n    this.setSliderThumbLabel(this.handleSliderTooltip());\r\n    this.handleDateChange(event);\r\n  }\r\n\r\n  handleSliderYearChange(event: any) {\r\n    this.year = event.value;\r\n    this.yearChange.emit(this.year);\r\n  }\r\n\r\n  handleSliderValue(): number {\r\n    if (this.options.current === true || !this.min) {\r\n      const currentDate = new Date();\r\n      this.date = this.getRoundedDate(currentDate);\r\n    }\r\n    if (this.type === TimeFilterType.YEAR) {\r\n      return this.year;\r\n    } else {\r\n      return this.date === undefined ? this.min.getTime() : this.date.getTime();\r\n    }\r\n  }\r\n\r\n  handleSliderTooltip() {\r\n    let label: string;\r\n\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toDateString()\r\n            : this.date.toDateString();\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toTimeString()\r\n            : this.date.toTimeString();\r\n        break;\r\n      // datetime\r\n      default:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toUTCString()\r\n            : this.date.toUTCString();\r\n        break;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  setupDateOutput() {\r\n    if (this.style === TimeFilterStyle.SLIDER) {\r\n      this.startDate = new Date(this.date);\r\n      this.startDate.setSeconds(-(this.step / 1000));\r\n      this.endDate = new Date(this.startDate);\r\n      this.endDate.setSeconds(this.step / 1000);\r\n    } else if (!this.isRange && !!this.date) {\r\n      this.endDate = new Date(this.date);\r\n      this.startDate = new Date(this.date);\r\n    } else if (this.isRange && (!!this.date || !this.date)) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    } else if (!this.date) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    }\r\n  }\r\n\r\n  applyTypeChange() {\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        if (this.startDate !== undefined || this.endDate !== undefined) {\r\n          this.startDate.setHours(0);\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setHours(23);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        if (this.style === TimeFilterStyle.CALENDAR) {\r\n          if (this.startDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.startDate.getHours();\r\n            const selectedMinute = this.startDate.getMinutes();\r\n            this.startDate = this.min;\r\n            this.startDate.setHours(selectedHour);\r\n            this.startDate.setMinutes(selectedMinute);\r\n          }\r\n\r\n          if (this.endDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.endDate.getHours();\r\n            const selectedMinute = this.endDate.getMinutes();\r\n            this.endDate = this.min;\r\n            this.endDate.setHours(selectedHour);\r\n            this.endDate.setMinutes(selectedMinute);\r\n          }\r\n        }\r\n\r\n        if (!this.isRange && this.step > 60 * 60 * 1000) {\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      // datetime\r\n      default:\r\n      // do nothing\r\n    }\r\n  }\r\n\r\n  getRangeMinDate(): Date {\r\n    return this.startDate === undefined ? this.min : this.startDate;\r\n  }\r\n\r\n  getRangeMaxDate(): Date {\r\n    return this.endDate === undefined ? this.max : this.endDate;\r\n  }\r\n\r\n  /**\r\n   * Round date at a certain time, 10 minutes by Default\r\n   * @param date - Date to Round\r\n   * @param atMinute - round to closest 'atMinute' minute, rounded 10 by default\r\n   * @return the rounded date\r\n   */\r\n  getRoundedDate(date, atMinute = 10) {\r\n    const coeff = 1000 * 60 * atMinute;\r\n    return new Date(Math.round(date.getTime() / coeff) * coeff);\r\n  }\r\n\r\n  /**\r\n   * Get the step (period) definition from the layer dimension tag\r\n   * @param step The step as ISO 8601 example: PT10M for 10 Minutes\r\n   * @return the duration in milliseconds\r\n   */\r\n  getStepDefinition(step) {\r\n    return moment.duration(step).asMilliseconds();\r\n  }\r\n}\r\n","<mat-list-item *ngIf=\"header\">\r\n  <mat-icon\r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"filters\"\r\n    [collapsed]=\"filtersCollapsed\"\r\n    (click)=\"toggleFiltersCollapsed()\"\r\n    svgIcon=\"chevron-up\" >\r\n  </mat-icon>\r\n  <h4 (click)=\"toggleLegendOnClick()\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\"  matLine>{{layer.title}}</h4>\r\n  \r\n  <button *ngIf=\"header\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"layer.visible ?\r\n                  ('igo.geo.layer.hideLayer' | translate) :\r\n                  ('igo.geo.layer.showLayer' | translate)\"\r\n    (click)=\"layer.visible = !layer.visible\">\r\n    <mat-icon\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #filters class=\"igo-datasource-filters-container\">\r\n  <div #legend class=\"igo-layer-legend-container\">\r\n    <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n    </igo-layer-legend>\r\n  </div>\r\n  <igo-time-filter-form\r\n    [layer]= \"layer\"\r\n    [options]=\"datasource.options.timeFilter\"\r\n    [currentValue]=\"datasource.options.params.TIME\"\r\n    (change)=\"handleDateChange($event)\"\r\n    (yearChange)=\"handleYearChange($event)\">\r\n  </igo-time-filter-form>\r\n</div>\r\n","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterableDataSource } from '../shared/time-filter.interface';\r\nimport { TimeFilterService } from '../shared/time-filter.service';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-item',\r\n  templateUrl: './time-filter-item.component.html',\r\n  styleUrls: ['./time-filter-item.component.scss']\r\n})\r\nexport class TimeFilterItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n\r\n  filtersCollapsed: boolean = false;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  get datasource(): TimeFilterableDataSource {\r\n    return this.layer.dataSource as TimeFilterableDataSource;\r\n  }\r\n  constructor(private timeFilterService: TimeFilterService) {}\r\n\r\n  ngOnInit(): void {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  handleYearChange(year: string | [string, string]) {\r\n    this.timeFilterService.filterByYear(this.datasource, year);\r\n  }\r\n\r\n  handleDateChange(date: Date | [Date, Date]) {\r\n    this.timeFilterService.filterByDate(this.datasource, date);\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'time'\">\r\n    <igo-time-filter-item [header]=\"true\" igoListItem [layer]=\"layer\"></igo-time-filter-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-list',\r\n  templateUrl: './time-filter-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterListComponent {\r\n  @Input()\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _layers: Layer[] = [];\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olWKT from 'ol/format/WKT';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WktService {\r\n  constructor() {}\r\n\r\n  public wktToFeature(wkt, wktProj, featureProj) {\r\n    return new olWKT().readFeature(wkt, {\r\n      dataProjection: wktProj,\r\n      featureProjection: featureProj\r\n    });\r\n  }\r\n  public extentToWkt(epsgTO, extent, extentProj) {\r\n    let currentExtent = olproj.transformExtent(extent, extentProj, epsgTO);\r\n    currentExtent = this.roundCoordinateArray(currentExtent, epsgTO, 0);\r\n    const wktPoly = `POLYGON((\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]}))`;\r\n    const wktLine = `LINESTRING(\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]})`;\r\n    const wktMultiPoints = `MULTIPOINT(\r\n        ${extent[0]} ${extent[1]},\r\n        ${extent[0]} ${extent[3]},\r\n        ${extent[2]} ${extent[3]},\r\n        ${extent[2]} ${extent[1]})`;\r\n    return {\r\n      wktPoly,\r\n      wktLine,\r\n      wktMultiPoints\r\n    };\r\n  }\r\n\r\n  private roundCoordinateArray(coordinateArray, projection, decimal = 0) {\r\n    const lproj = olproj.get(projection);\r\n    const units = lproj.getUnits();\r\n    const olUnits = ['ft', 'm', 'us-ft'];\r\n    if (olUnits.indexOf(units) !== -1) {\r\n      coordinateArray = this.roundArray(coordinateArray, decimal);\r\n    }\r\n    return coordinateArray;\r\n  }\r\n\r\n  private roundArray(array, decimal = 0) {\r\n    let x = 0;\r\n    while (x < array.length) {\r\n      array[x] = array[x].toFixed(decimal);\r\n      x++;\r\n    }\r\n    return array;\r\n  }\r\n\r\n  public snrcToWkt(snrc, epsgTO) {\r\n    snrc = snrc.toLowerCase();\r\n    let wktPoly;\r\n    const ew = {\r\n      1: { from: -56, to: -64 },\r\n      2: { from: -64, to: -72 },\r\n      3: { from: -72, to: -80 },\r\n      4: { from: -80, to: -88 },\r\n      5: { from: -88, to: -96 },\r\n      6: { from: -96, to: -104 },\r\n      7: { from: -104, to: -112 },\r\n      8: { from: -112, to: -120 },\r\n      9: { from: -120, to: -128 },\r\n      10: { from: -128, to: -136 }\r\n    };\r\n    const sn = {\r\n      1: { from: 44, to: 48 },\r\n      2: { from: 48, to: 52 },\r\n      3: { from: 52, to: 56 },\r\n      4: { from: 56, to: 60 },\r\n      5: { from: 60, to: 64 },\r\n      6: { from: 64, to: 68 },\r\n      7: { from: 68, to: 72 },\r\n      8: { from: 72, to: 76 },\r\n      9: { from: 76, to: -128 }\r\n    };\r\n    const snrc250kIndex = [\r\n      ['m', 'n', 'o', 'p'],\r\n      ['l', 'k', 'j', 'i'],\r\n      ['e', 'f', 'g', 'h'],\r\n      ['d', 'c', 'b', 'a']\r\n    ];\r\n\r\n    const snrc50kIndex = [\r\n      ['13', '14', '15', '16'],\r\n      ['12', '11', '10', '09'],\r\n      ['05', '06', '07', '08'],\r\n      ['04', '03', '02', '01']\r\n    ];\r\n    const checkSNRC50k = /\\d{2,3}[a-p][0,1][0-9]/gi;\r\n    const checkSNRC250k = /\\d{2,3}[a-p]/gi;\r\n    const checkSNRC1m = /\\d{2,3}/gi;\r\n\r\n    let snrc1m = false;\r\n    let snrc250k = false;\r\n    let snrc50k = false;\r\n\r\n    if (checkSNRC50k.test(snrc)) {\r\n      snrc50k = true;\r\n    } else {\r\n      if (checkSNRC250k.test(snrc)) {\r\n        snrc250k = true;\r\n      } else {\r\n        if (checkSNRC1m.test(snrc)) {\r\n          snrc1m = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (snrc1m) {\r\n      snrc += 'a01';\r\n    } else if (snrc250k) {\r\n      snrc += '01';\r\n    }\r\n    if (/\\d{2,3}[a-p][0,1][0-9]/gi.test(snrc)) {\r\n      const regex1m = /(?=[a-p])/gi;\r\n      const ar1m = snrc.split(regex1m);\r\n      const part1m = ar1m[0];\r\n      const part250k = ar1m[1][0];\r\n      const part50k = ar1m[1].split(part250k)[1];\r\n      let separator = 1;\r\n      if (part1m.length === 3) {\r\n        separator = 2;\r\n      }\r\n      const partEW = part1m.substring(0, separator);\r\n      const partSN = part1m.substring(separator);\r\n      const unit1mEW = 8;\r\n      const unit1mSN = 4;\r\n      const unit250kEW = 2;\r\n      const unit250kSN = 1;\r\n      const unit50kEW = 0.5;\r\n      const unit50kSN = 0.25;\r\n      let index250kEW = 0;\r\n      let index250kSN = 0;\r\n      let index50kEW = 0;\r\n      let index50kSN = 0;\r\n      snrc250kIndex.forEach(element => {\r\n        if (element.indexOf(part250k) !== -1) {\r\n          index250kSN = snrc250kIndex.indexOf(element);\r\n          index250kEW = element.indexOf(part250k);\r\n        }\r\n      });\r\n      snrc50kIndex.forEach(element => {\r\n        if (element.indexOf(part50k) !== -1) {\r\n          index50kSN = snrc50kIndex.indexOf(element);\r\n          index50kEW = element.indexOf(part50k);\r\n        }\r\n      });\r\n\r\n      let increment250kEW = 0;\r\n      let increment250kSN = 0;\r\n      let increment50kEW = 0;\r\n      let increment50kSN = 0;\r\n      let unitPerTypeEW = unit1mEW;\r\n      let unitPerTypeSN = unit1mSN;\r\n      if (snrc250k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = 0;\r\n        increment50kSN = 0;\r\n        unitPerTypeEW = unit250kEW;\r\n        unitPerTypeSN = unit250kSN;\r\n      } else if (snrc50k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = index50kEW * unit50kEW;\r\n        increment50kSN = index50kSN * unit50kSN;\r\n        unitPerTypeEW = unit50kEW;\r\n        unitPerTypeSN = unit50kSN;\r\n      }\r\n\r\n      const coord: {ul?: any, lr?: any, ur?: any, ll?: any} = {\r\n        ul: [\r\n          ew[partEW].to + increment250kEW + increment50kEW,\r\n          sn[partSN].to - increment250kSN - increment50kSN\r\n        ]\r\n      };\r\n\r\n      coord.lr = [\r\n        coord.ul[0] + unitPerTypeEW,\r\n        coord.ul[1] - unitPerTypeSN\r\n      ];\r\n      coord.ur = [coord.ul[0], coord.ul[1] - unitPerTypeSN];\r\n      coord.ll = [coord.ul[0] + unitPerTypeEW, coord.ul[1]];\r\n\r\n      coord.ul = olproj.transform(\r\n        [coord.ul[0], coord.ul[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.lr = olproj.transform(\r\n        [coord.lr[0], coord.lr[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ur = olproj.transform(\r\n        [coord.ur[0], coord.ur[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ll = olproj.transform(\r\n        [coord.ll[0], coord.ll[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n\r\n      // Rounded coordinate to shorten url in get\r\n      coord.ul = this.roundCoordinateArray(coord.ul, epsgTO, 0);\r\n      coord.lr = this.roundCoordinateArray(coord.lr, epsgTO, 0);\r\n      coord.ur = this.roundCoordinateArray(coord.ur, epsgTO, 0);\r\n      coord.ll = this.roundCoordinateArray(coord.ll, epsgTO, 0);\r\n\r\n      wktPoly =\r\n        'POLYGON((' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        '))';\r\n      const wktLine =\r\n        'LINESTRING(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n\r\n      const wktMultiPoints =\r\n        'MULTIPOINT(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n      return {\r\n        wktPoly,\r\n        wktLine,\r\n        wktMultiPoints\r\n      };\r\n    }\r\n  }\r\n}\r\n","<mat-checkbox\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\"\r\n  (click)=\"$event.stopPropagation()\"\r\n  (change)=\"toggleFilterState($event)\"\r\n  [checked]=\"currentFilter.active\">\r\n</mat-checkbox>\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'logical': activeFilters.indexOf(currentFilter) !== 0 && currentFilter.active===true, 'logicalHidden': activeFilters.indexOf(currentFilter) === 0 || currentFilter.active!==true}\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.parentLogical\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.parentLogical ? (('igo.geo.operators.tooltip.'+ currentFilter.parentLogical) | translate) : ''\"\r\n    (selectionChange)=\"changeLogical($event.value)\">\r\n      <mat-option\r\n        [value]=ogcFilterOperator.And\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.And' | translate\">\r\n          {{'igo.geo.operators.And' | translate}}\r\n      </mat-option>\r\n      <mat-option\r\n        [value]=ogcFilterOperator.Or\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.Or' | translate\">\r\n          {{'igo.geo.operators.Or' | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"field\"\r\n  *ngIf=\"(currentFilterIsSpatial$ | async)===false && (fields$ | async) && (fields$| async).length > 0 && (fields$| async)[0].name !== ''\"\r\n  (mouseenter)=\"inputClearable = 'selectField'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <input\r\n  matInput\r\n  [placeholder]=\"'igo.geo.sourceFields.selectField' | translate\"\r\n  [disabled]=\"!currentFilter.active\"\r\n  [matAutocomplete]=\"autoCompleteField\"\r\n  [value]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ''\"\r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ('igo.geo.sourceFields.selectField' | translate)\"\r\n  (input)=\"updateFieldsList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteField=\"matAutocomplete\"\r\n  (optionSelected)='changeField($event.option.id)'>\r\n    <mat-option\r\n      *ngFor=\"let field of filteredFields$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"field.alias\"\r\n      [id]=\"field.name\"\r\n      [matTooltip]=\"field.alias\">\r\n      {{field.alias}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"currentFilter.propertyName && inputClearable === 'selectField' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearSelectedField()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'operator': (currentFilterIsSpatial$ | async)===false , 'dualInput': (currentFilterIsSpatial$ | async)}\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <mat-select\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.operator ? (('igo.geo.operators.tooltip.'+ currentFilter.operator) | translate) : ('igo.geo.filter.selectOperator' | translate)\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.operator\"\r\n    (selectionChange)=\"changeOperator($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let operator of (ogcFilterOperators$ | async) | keyvalue\"\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"operator.key\"\r\n        [matTooltip]=\"('igo.geo.operators.tooltip.'+ operator.key) | translate\">\r\n          {{('igo.geo.operators.'+ operator.key) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"spatialSelector\"\r\n*ngIf=\"currentFilterIsSpatial$ | async\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.igoSpatialSelector\"\r\n    (selectionChange)=\"changeSpatialSelector($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let igoSpatialSelector of igoSpatialSelectors\"\r\n        [value]=\"igoSpatialSelector.type\">\r\n          {{('igo.geo.spatialSelector.'+ igoSpatialSelector.type) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"singleInput\"\r\n*ngIf=\"['expression','pattern'].indexOf(detectProperty()) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [matAutocomplete]=\"autoCompleteValues\"\r\n    [value]=\"detectProperty() === 'expression' ? currentFilter.expression : currentFilter.pattern\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"detectProperty() === 'expression' ? currentFilter.expression || '' : currentFilter.pattern || ''\"\r\n    (input)=\"updateValuesList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteValues=\"matAutocomplete\"\r\n    (optionSelected)=\"changeProperty($event.option.value)\">\r\n    <mat-option\r\n      *ngFor=\"let value of filteredValues$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"value\"\r\n      [matTooltip]=\"value\">\r\n      {{value}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"isClearable() && inputClearable === 'selectProperty' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearProperty()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n<div class=\"igo-layer-button-group\">\r\n  <button\r\n    mat-icon-button\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.filter.removeFilter' | translate\"\r\n    color=\"warn\"\r\n    (click)=\"deleteFilter()\">\r\n    <mat-icon svgIcon=\"delete\"></mat-icon>\r\n  </button>\r\n</div>\r\n\r\n<mat-form-field\r\nclass=\"snrc\"\r\n*ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'snrc'\"\r\n(mouseenter)=\"inputClearable = 'selectSNRC'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholderSnrc' | translate\"\r\n    [value]=\"currentFilter.igoSNRC\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.igoSNRC ? currentFilter.igoSNRC : ''\"\r\n    (input)=\"changeSNRC($event.target.value)\">\r\n  <button\r\n    mat-button\r\n    *ngIf=\"currentFilter.igoSNRC\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active && inputClearable === 'selectSNRC' && currentFilter.active\"\r\n    (click)=\"currentFilter.igoSNRC=''\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n  </mat-form-field>\r\n\r\n  <ng-container *ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'fixedExtent'\">\r\n    <button\r\n    mat-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    *ngIf=\"currentFilter.igoSpatialSelector === 'fixedExtent'\"\r\n    matSuffix\r\n    mat-icon-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"changeMapExtentGeometry()\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialSelector.btnSetExtent' | translate\">\r\n      <mat-icon svgIcon=\"arrow-expand-all\"></mat-icon>\r\n  </button>\r\n</ng-container>\r\n\r\n<br/>\r\n\r\n<mat-form-field\r\nclass=\"dualInput\"\r\n*ngIf=\"!isTemporalOperator() && ['lowerBoundary','begin'].indexOf(detectProperty(1)) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty1'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator1\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(1) === 'lowerBoundary' ? currentFilter.lowerBoundary : currentFilter.begin\"\r\n      (input)=\"updateValuesList($event.target.value,1)\">\r\n    <mat-autocomplete #autoDualValueOperator1=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,1)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(1) && inputClearable === 'selectProperty1' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(1)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"dualInput\"\r\n  *ngIf=\"!isTemporalOperator() && ['upperBoundary','end'].indexOf(detectProperty(2)) !== -1\"\r\n  (mouseenter)=\"inputClearable = 'selectProperty2'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator2\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(2) === 'upperBoundary' ? currentFilter.upperBoundary : currentFilter.end\"\r\n      (input)=\"updateValuesList($event.target.value,2)\">\r\n    <mat-autocomplete #autoDualValueOperator2=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,2)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(2) && inputClearable === 'selectProperty2' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(2)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<igo-ogc-filter-time *ngIf=\"isTemporalOperator()\"\r\n  [(datasource)]=\"datasource\"\r\n  [(currentFilter)]=\"currentFilter\"\r\n  (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n</igo-ogc-filter-time>\r\n\r\n<!--\r\nTODO C'EST PERTINENT je crois\r\n<mat-form-field class=\"field\" *ngIf=\"!(currentFilterIsSpatial$ | async) && (fields$| async) && (fields$| async).length === 1 &&  (fields$| async)[0].name === ''\">\r\n<input [disabled]=\"!currentFilter.active\" matInput #fieldPerUser (keyup)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\"\r\n  (blur)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\" [(ngModel)]=\"currentFilter.propertyName\">\r\n<button mat-button *ngIf=\"currentFilter.propertyName\" matSuffix mat-icon-button aria-label=\"Clear\" (click)=\"currentFilter.propertyName=''\">\r\n  <mat-icon svgIcon=\"close\"></mat-icon>\r\n</button>\r\n</mat-form-field>\r\n\r\n\r\n\r\n<mat-checkbox labelPosition='before' (change)=\"changeCaseSensitive($event)\" [(ngModel)]=\"currentFilter.matchCase\">\r\n  {{('igo.geo.operators.caseSensitive') | translate}}\r\n</mat-checkbox>\r\n\r\n</mat-list-item> -->\r\n","import { Component, Input, OnInit } from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { WktService } from '../../wkt/shared/wkt.service';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-form',\r\n  templateUrl: './ogc-filter-form.component.html',\r\n  styleUrls: ['./ogc-filter-form.component.scss']\r\n})\r\nexport class OgcFilterFormComponent implements OnInit {\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  filteredValues$: Observable<string[]>;\r\n  filteredFields$: Observable<SourceFieldsOptionsParams[]>;\r\n  public allOgcFilterOperators;\r\n  public ogcFilterOperators$ = new BehaviorSubject<{ [key: string]: any }>(\r\n    undefined\r\n  );\r\n  public igoSpatialSelectors;\r\n  public value = '';\r\n  public inputOperator;\r\n  public selectedField$ = new BehaviorSubject<SourceFieldsOptionsParams>(\r\n    undefined\r\n  );\r\n  public fields$ = new BehaviorSubject<SourceFieldsOptionsParams[]>([]);\r\n  public color = 'primary';\r\n  public disabled;\r\n  public currentFilterIsSpatial$ = new BehaviorSubject<boolean>(false);\r\n  public defaultStepMillisecond = 6000;\r\n  public inputClearable: string;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() currentFilter: any;\r\n\r\n  set snrc(value: any) {\r\n    const checkSNRC50k = /^\\d{2}[a-l][0,1][0-9]$/gi;\r\n    const checkSNRC250k = /^\\d{2}[a-p]$/gi;\r\n    const checkSNRC1m = /^\\d{2}$/gi;\r\n    if (\r\n      checkSNRC1m.test(value) ||\r\n      checkSNRC250k.test(value) ||\r\n      checkSNRC50k.test(value)\r\n    ) {\r\n      this._snrc = value;\r\n      this.currentFilter.igoSNRC = value;\r\n    }\r\n  }\r\n\r\n  get snrc(): any {\r\n    return this._snrc;\r\n  }\r\n\r\n  private _snrc = '';\r\n\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  get activeFilters() {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.active === true\r\n    );\r\n  }\r\n\r\n  get allowedOperators() {\r\n    return new OgcFilterWriter().computeAllowedOperators(\r\n      this.fields$.value,\r\n      this.currentFilter.propertyName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType\r\n    );\r\n  }\r\n\r\n  constructor(private wktService: WktService) {\r\n    // TODO: Filter permitted operator based on wfscapabilities\r\n    // Need to work on regex on XML capabilities because\r\n    // comaparison operator's name varies between WFS servers...\r\n    // Ex: IsNull vs PropertyIsNull vs IsNil ...\r\n    this.allOgcFilterOperators = new OgcFilterWriter().operators;\r\n    this.ogcFilterOperators$.next(this.allOgcFilterOperators);\r\n    this.igoSpatialSelectors = [\r\n      {\r\n        type: 'fixedExtent'\r\n      },\r\n      {\r\n        type: 'snrc'\r\n      }\r\n    ];\r\n    // TODO: selectFeature & drawFeature\r\n  }\r\n\r\n  ngOnInit() {\r\n\r\n    if ( this.datasource.options.sourceFields) {\r\n      const sFields = this.datasource.options.sourceFields.filter(\r\n        (sf) =>\r\n          sf.excludeFromOgcFilters === undefined || !sf.excludeFromOgcFilters\r\n      );\r\n      sFields.map((sfs) => {\r\n        if (sfs.values) {\r\n          sfs.values.sort();\r\n        }\r\n      });\r\n      this.fields$.next(sFields);\r\n    }\r\n\r\n    this.updateFieldsList();\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.updateValuesList();\r\n    this.selectedField$.subscribe((f) => {\r\n      this.ogcFilterOperators$.next(this.allowedOperators);\r\n      if (\r\n        Object.keys(this.allowedOperators).indexOf(\r\n          this.currentFilter.operator\r\n        ) === -1\r\n      ) {\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n      }\r\n      this.updateValuesList();\r\n    });\r\n    this.currentFilterIsSpatial();\r\n  }\r\n\r\n  updateFieldsList(value?: string) {\r\n    this.filteredFields$ =\r\n      value && value.length > 0 ? of(this._filterFields(value)) : this.fields$;\r\n    if (this.fields$.value.find((f) => f.name === value)) {\r\n      this.changeField(value);\r\n    }\r\n  }\r\n\r\n  updateValuesList(value?: string, pos?: number) {\r\n    this.filteredValues$ =\r\n      value && value.length > 0\r\n        ? of(this._filterValues(value))\r\n        : this.selectedField$.value\r\n        ? of(this.selectedField$.value.values)\r\n        : of([]);\r\n    if (value && value.length >= 1) {\r\n      this.changeProperty(value, pos);\r\n    }\r\n  }\r\n\r\n  private _filterFields(value: string): SourceFieldsOptionsParams[] {\r\n    const keywordRegex = new RegExp(\r\n      value.normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.fields$.value.filter((val) =>\r\n      keywordRegex.test(\r\n        val.alias.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  private _filterValues(value: string): string[] {\r\n    const keywordRegex = new RegExp(\r\n      value\r\n        .toString()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.selectedField$.value.values.filter((val) =>\r\n      val && keywordRegex.test(\r\n        val\r\n          .toString()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  clearSelectedField() {\r\n    this.currentFilter.propertyName = '';\r\n    this.selectedField$.next(undefined);\r\n    this.clearProperty();\r\n  }\r\n\r\n  isClearable(pos?: number) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return this.currentFilter[detectedProperty];\r\n    }\r\n  }\r\n  clearProperty(pos?: number) {\r\n    // this.autoCompleteInputValues.closePanel();\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return (this.currentFilter[detectedProperty] = '');\r\n    }\r\n  }\r\n\r\n  toggleFilterState(event) {\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    ).active = event.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  deleteFilter() {\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    ogcFilters.interfaceOgcFilters = ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.filterid !== this.currentFilter.filterid\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeLogical(logical: string) {\r\n    this.currentFilter.parentLogical = logical;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeOperator(operator: string) {\r\n    this.currentFilter.operator = operator;\r\n    this.currentFilterIsSpatial();\r\n\r\n    if (\r\n      this.currentFilterIsSpatial$.value &&\r\n      this.currentFilter.wkt_geometry.length === 0\r\n    ) {\r\n      this.changeSpatialSelector(this.currentFilter.igoSpatialSelector);\r\n    } else {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  changeField(field: string) {\r\n    this.currentFilter.propertyName = field;\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  // Issue with mapserver 7.2 and Postgis layers. Fixed in 7.4\r\n  // Due to this issue, the checkbox is hide.\r\n  changeCaseSensitive(matchCase) {\r\n    this.currentFilter.matchCase = matchCase.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        (f) => f.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.refreshFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  changeNumericProperty(value, pos: number) {\r\n    this.changeProperty(parseFloat(value), pos);\r\n  }\r\n\r\n  changeSpatialSelector(value: any) {\r\n    this.currentFilter.igoSpatialSelector = value;\r\n\r\n    if (value === 'fixedExtent') {\r\n      this.changeMapExtentGeometry(false);\r\n    }\r\n    this.currentFilterIsSpatial();\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeSNRC(value: any) {\r\n    this.snrc = value;\r\n    this.changeSNRCGeometry();\r\n  }\r\n\r\n  changeSNRCGeometry() {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.snrc && this.currentFilter.igoSpatialSelector === 'snrc') {\r\n      this.currentFilter.wkt_geometry = this.wktService.snrcToWkt(\r\n        this.snrc,\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeMapExtentGeometry(refresh: boolean = true) {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.currentFilter.igoSpatialSelector === 'fixedExtent') {\r\n      this.currentFilter.wkt_geometry = this.wktService.extentToWkt(\r\n        this.map.projection,\r\n        this.map.viewController.getExtent(),\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    if (refresh) {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  private currentFilterIsSpatial() {\r\n    let isSpatial = false;\r\n    if (this.currentFilter) {\r\n      isSpatial =\r\n        [\r\n          OgcFilterOperator.Contains,\r\n          OgcFilterOperator.Intersects,\r\n          OgcFilterOperator.Within\r\n        ].indexOf(this.currentFilter.operator) !== -1;\r\n    }\r\n    this.currentFilterIsSpatial$.next(isSpatial);\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter.operator.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n}\r\n","<igo-ogc-filter-selection\r\n  *ngIf=\"!advancedOgcFilters\"\r\n  igoListItem\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\"\r\n  [currentFilter]=\"currentFilter\">\r\n</igo-ogc-filter-selection>\r\n\r\n<ng-template \r\n*ngIf=\"advancedOgcFilters && datasource.options.ogcFilters.editable\"\r\nngFor let-currentFilter \r\n[ngForOf]=\"datasource.options.ogcFilters.interfaceOgcFilters\">\r\n<igo-ogc-filter-form\r\n  [currentFilter]=\"currentFilter\"\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\">\r\n</igo-ogc-filter-form>\r\n</ng-template>","import { Component, Input } from '@angular/core';\r\nimport { OgcFilterableDataSource } from '../shared/ogc-filter.interface';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-form',\r\n  templateUrl: './ogc-filterable-form.component.html'\r\n})\r\nexport class OgcFilterableFormComponent {\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters;\r\n  }\r\n\r\n  get advancedOgcFilters(): boolean {\r\n    if (this.datasource.options.ogcFilters) {\r\n      return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n    }\r\n    return;\r\n  }\r\n\r\n  get currentFilter(): any {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters ?\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters[0] : undefined;\r\n  }\r\n\r\n  public color = 'primary';\r\n\r\n  constructor() {}\r\n}\r\n","<mat-list-item>\r\n\r\n  <mat-icon\r\n    *ngIf=\"header\"\r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse [target]=\"ogcFilters\"\r\n    [collapsed]=\"filtersCollapsed\"\r\n    (click)=\"toggleFiltersCollapsed()\"\r\n    svgIcon=\"chevron-up\">\r\n  </mat-icon>\r\n  <h4 (click)=\"toggleLegendOnClick()\" *ngIf=\"header\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\" matLine [matTooltip]=\"layer.title\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n    <button *ngIf=\"isAdvancedOgcFilters() && filtersAreEditable\" [disabled]=\"addFilterDisabled()\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.filter.addFilter' | translate\" [color]=\"color\" (click)=\"addFilterToSequence()\">\r\n      <mat-icon svgIcon=\"plus\"></mat-icon>\r\n    </button>\r\n    <button *ngIf=\"header\"\r\n      mat-icon-button\r\n      [color]=\"layer.visible ? 'primary' : 'default'\"\r\n      collapsibleButton\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"layer.visible ?\r\n                    ('igo.geo.layer.hideLayer' | translate) :\r\n                    ('igo.geo.layer.showLayer' | translate)\"\r\n      (click)=\"layer.visible = !layer.visible\">\r\n      <mat-icon\r\n        [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n        [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n      </mat-icon>\r\n    </button>\r\n</mat-list-item>\r\n\r\n<div #ogcFilters>\r\n    <div *ngIf=\"header\" #legend class=\"igo-layer-legend-container\">\r\n      <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n      </igo-layer-legend>\r\n    </div>\r\n  <igo-ogc-filterable-form [datasource]=\"datasource\" [map]=\"map\" [refreshFilters]=\"refreshFunc\">\r\n  </igo-ogc-filterable-form>\r\n\r\n  <section *ngIf=\"hasSelector && filtersAreEditable\" class=\"mat-typography advancedOgcFilters\">\r\n    <mat-divider></mat-divider>\r\n    <mat-checkbox labelPosition='before' (change)=\"changeOgcFilterType($event)\"\r\n      [(ngModel)]=\"datasource.options.ogcFilters.advancedOgcFilters\">\r\n      {{'igo.geo.filter.advancedOgcFilters' | translate}}\r\n    </mat-checkbox>\r\n  </section>\r\n</div>","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { WFSDataSourceOptionsParams } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions,\r\n  OgcInterfaceFilterOptions\r\n} from '../shared/ogc-filter.interface';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterWriter } from '../shared/ogc-filter';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-item',\r\n  templateUrl: './ogc-filterable-item.component.html',\r\n  styleUrls: ['./ogc-filterable-item.component.scss']\r\n})\r\nexport class OgcFilterableItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  private lastRunOgcFilter;\r\n  private defaultLogicalParent = OgcFilterOperator.And;\r\n  public hasActiveSpatialFilter = false;\r\n  public filtersAreEditable = true;\r\n  public filtersCollapsed = true;\r\n  public hasSelector: boolean = false;\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n  private ogcFilterWriter;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters.bind(this);\r\n  }\r\n\r\n  get datasource(): OgcFilterableDataSource {\r\n    return this.layer.dataSource as OgcFilterableDataSource;\r\n  }\r\n\r\n  constructor(private ogcFilterService: OGCFilterService) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n  }\r\n\r\n  ngOnInit() {\r\n    const ogcFilters = this.datasource.options.ogcFilters;\r\n    if (\r\n      (ogcFilters.pushButtons && ogcFilters.pushButtons.bundles.length > 0) ||\r\n      (ogcFilters.checkboxes && ogcFilters.checkboxes.bundles.length > 0) ||\r\n      (ogcFilters.radioButtons && ogcFilters.radioButtons.bundles.length > 0) ||\r\n      (ogcFilters.select && ogcFilters.select.bundles.length > 0)) {\r\n      if (ogcFilters.advancedOgcFilters === undefined) {\r\n        ogcFilters.advancedOgcFilters = false;\r\n      }\r\n      this.hasSelector = true;\r\n    }\r\n\r\n    switch (this.datasource.options.type) {\r\n      case 'wms':\r\n        this.ogcFilterService.setOgcWMSFiltersOptions(this.datasource);\r\n        break;\r\n      case 'wfs':\r\n        this.ogcFilterService.setOgcWFSFiltersOptions(this.datasource);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    if (ogcFilters) {\r\n      if (ogcFilters.interfaceOgcFilters) {\r\n        this.lastRunOgcFilter = JSON.parse(\r\n          JSON.stringify(ogcFilters.interfaceOgcFilters)\r\n        );\r\n        if (\r\n          ogcFilters.interfaceOgcFilters.filter(f => f.wkt_geometry).length >= 1\r\n        ) {\r\n          this.hasActiveSpatialFilter = true;\r\n        }\r\n      }\r\n\r\n      this.filtersAreEditable = ogcFilters.editable\r\n        ? ogcFilters.editable\r\n        : false;\r\n    }\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  addFilterToSequence() {\r\n    this.filtersCollapsed = false;\r\n    const interfaceOgcFilters: OgcInterfaceFilterOptions[] = this.datasource\r\n      .options.ogcFilters.interfaceOgcFilters;\r\n    const arr = interfaceOgcFilters || [];\r\n    const lastLevel = arr.length === 0 ? 0 : arr[arr.length - 1].level;\r\n    let firstFieldName = '';\r\n    const includedFields = this.datasource.options.sourceFields.filter(f => !f.excludeFromOgcFilters);\r\n    if (includedFields.length > 0) {\r\n      firstFieldName =\r\n        includedFields[0].name === undefined ? '' : includedFields[0].name;\r\n    }\r\n    let fieldNameGeometry;\r\n    const datasourceOptions = this.datasource\r\n      .options as WFSDataSourceOptionsParams;\r\n    if (datasourceOptions.fieldNameGeometry) {\r\n      fieldNameGeometry = datasourceOptions.fieldNameGeometry;\r\n    } else if (\r\n      (this.datasource.options as any).paramsWFS &&\r\n      (this.datasource.options as any).paramsWFS.fieldNameGeometry\r\n    ) {\r\n      fieldNameGeometry = (this.datasource.options as any).paramsWFS\r\n        .fieldNameGeometry;\r\n    }\r\n    const allowedOperators = this.ogcFilterWriter.computeAllowedOperators(\r\n      this.datasource.options.sourceFields,\r\n      firstFieldName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType);\r\n    const firstOperatorName = Object.keys(allowedOperators)[0];\r\n\r\n    arr.push(\r\n      this.ogcFilterWriter.addInterfaceFilter(\r\n        {\r\n          propertyName: firstFieldName,\r\n          operator: firstOperatorName,\r\n          active: true,\r\n          igoSpatialSelector: 'fixedExtent',\r\n          srsName: this.map.projection,\r\n        } as OgcInterfaceFilterOptions,\r\n        fieldNameGeometry,\r\n        lastLevel,\r\n        this.defaultLogicalParent\r\n      )\r\n    );\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters = arr;\r\n  }\r\n\r\n  refreshFilters(force?: boolean) {\r\n    if (force === true) {\r\n      this.lastRunOgcFilter = undefined;\r\n    }\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    const activeFilters = ogcFilters.interfaceOgcFilters ?\r\n      ogcFilters.interfaceOgcFilters.filter(f => f.active === true) : [];\r\n    if (activeFilters.length === 0) {\r\n      ogcFilters.filters = undefined;\r\n      ogcFilters.filtered = false;\r\n    }\r\n    if (activeFilters.length > 1) {\r\n      activeFilters[0].parentLogical = activeFilters[1].parentLogical;\r\n    }\r\n    if (\r\n      activeFilters.filter(\r\n        af => ['Contains', 'Intersects', 'Within'].indexOf(af.operator) !== -1\r\n      ).length === 0\r\n    ) {\r\n      this.hasActiveSpatialFilter = false;\r\n    } else {\r\n      this.hasActiveSpatialFilter = true;\r\n    }\r\n\r\n    if (\r\n      !(JSON.stringify(this.lastRunOgcFilter) === JSON.stringify(activeFilters))\r\n    ) {\r\n      if (this.layer.dataSource.options.type === 'wfs') {\r\n        const ogcDataSource: any = this.layer.dataSource;\r\n        const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n        ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n          activeFilters\r\n        );\r\n        this.layer.dataSource.ol.refresh();\r\n      } else if (\r\n        this.layer.dataSource.options.type === 'wms' &&\r\n        ogcFilters.enabled\r\n      ) {\r\n        let rebuildFilter = '';\r\n        if (activeFilters.length >= 1) {\r\n          const ogcDataSource: any = this.layer.dataSource;\r\n          const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n          ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n            activeFilters\r\n          );\r\n          rebuildFilter = this.ogcFilterWriter.buildFilter(\r\n            ogcLayer.filters,\r\n            undefined,\r\n            undefined,\r\n            (this.layer.dataSource.options as any).fieldNameGeometry,\r\n            ogcDataSource.options\r\n          );\r\n        }\r\n        this.ogcFilterService.filterByOgc(\r\n          this.datasource as WMSDataSource,\r\n          rebuildFilter\r\n        );\r\n        this.datasource.options.ogcFilters.filtered =\r\n          activeFilters.length === 0 ? false : true;\r\n      }\r\n\r\n      this.lastRunOgcFilter = JSON.parse(JSON.stringify(activeFilters));\r\n    } else {\r\n      // identical filter. Nothing triggered\r\n    }\r\n    (this.layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  public isAdvancedOgcFilters(): boolean {\r\n    return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n  }\r\n\r\n  public addFilterDisabled(): boolean {\r\n    return (\r\n      !this.datasource.options.sourceFields ||\r\n      this.datasource.options.sourceFields.length === 0\r\n    );\r\n  }\r\n\r\n  private changeOgcFiltersAdvancedOgcFilters(value: boolean) {\r\n    this.datasource.options.ogcFilters.advancedOgcFilters = value;\r\n  }\r\n\r\n  changeOgcFilterType(isAdvancedOgcFilters) {\r\n    this.changeOgcFiltersAdvancedOgcFilters(isAdvancedOgcFilters.checked);\r\n    if (isAdvancedOgcFilters.checked) {\r\n      this.refreshFilters(true);\r\n    }\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'ogc'\">\r\n    <igo-ogc-filterable-item igoListItem [header]=\"true\" [layer]=\"layer\" \r\n    [map]=\"layer.map\" ></igo-ogc-filterable-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-list',\r\n  templateUrl: './ogc-filterable-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterableListComponent {\r\n\r\n  @Input() layers: Layer[];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  constructor() {}\r\n}\r\n","<button\r\n  *ngIf=\"header && options.ogcFilters && options.ogcFilters.enabled &&\r\n  (options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.editable)\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"filter\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"options.ogcFilters && options.ogcFilters.enabled &&\r\n(options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.editable)\">\r\n  <igo-ogc-filterable-item\r\n    *ngIf=\"ogcFilterCollapse && options.ogcFilters.enabled\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [map]=\"layer.map\"\r\n    [layer]=\"layer\">\r\n  </igo-ogc-filterable-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterableDataSourceOptions, IgoOgcSelector } from '../shared/ogc-filter.interface';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-button',\r\n  templateUrl: './ogc-filter-button.component.html',\r\n  styleUrls: ['./ogc-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterButtonComponent implements OnInit {\r\n\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.ogcFilters as any;\r\n    let cnt = 0;\r\n    if (filter && !filter.advancedOgcFilters) {\r\n      if (filter.pushButtons) {\r\n        const pushButtons = filter.pushButtons as IgoOgcSelector;\r\n        const currentPushButtonGroup = pushButtons.groups.find(gr => gr.enabled);\r\n        let cntPushButtons = 0;\r\n        if (currentPushButtonGroup) {\r\n          currentPushButtonGroup.computedSelectors.map(cb => cntPushButtons += (cb.selectors as any).filter(\r\n            button => button.enabled).length);\r\n        }\r\n        cnt += cntPushButtons;\r\n      }\r\n      if (filter.checkboxes) {\r\n        const checkboxes = filter.checkboxes as IgoOgcSelector;\r\n        const currentCheckboxGroup = checkboxes.groups.find(gr => gr.enabled);\r\n        let cntCheckboxes = 0;\r\n        if (currentCheckboxGroup) {\r\n          currentCheckboxGroup.computedSelectors.map(cb => cntCheckboxes += (cb.selectors as any).filter(\r\n            checkbox => checkbox.enabled).length);\r\n        }\r\n        cnt += cntCheckboxes;\r\n      }\r\n      if (filter.radioButtons) {\r\n        const radioButtons = filter.radioButtons as IgoOgcSelector;\r\n        const currentRadioButtonsGroup = radioButtons.groups.find(gr => gr.enabled);\r\n        let cntRadioButtons = 0;\r\n        if (currentRadioButtonsGroup) {\r\n          currentRadioButtonsGroup.computedSelectors.map(cb => cntRadioButtons += (cb.selectors as any).filter(\r\n            radio => radio.enabled).length);\r\n        }\r\n        cnt += cntRadioButtons;\r\n      }\r\n      if (filter.select) {\r\n        const select = filter.select as IgoOgcSelector;\r\n        const currentSelectGroup = select.groups.find(gr => gr.enabled);\r\n        let cntSelect = 0;\r\n        if (currentSelectGroup) {\r\n          currentSelectGroup.computedSelectors.map(cb => cntSelect += (cb.selectors as any).filter(\r\n            multi => multi.enabled).length);\r\n        }\r\n        cnt += cntSelect;\r\n      }\r\n    } else if (filter && filter.filters && !filter.filters.filters) {\r\n      return 1;\r\n    } else if (filter && filter.filters && filter.filters.filters) {\r\n      return filter.filters.filters.length;\r\n    }\r\n    if (filter.filters && filter.filters.operator === 'During' && filter.filters.active &&\r\n      filter.interfaceOgcFilters && filter.interfaceOgcFilters[0].active) {\r\n      const filterActiveValue = filter.interfaceOgcFilters[0];\r\n      if (filter.filters.calendarModeYear) {\r\n        // year mode check just year\r\n        if ((filterActiveValue.begin.substring(0,4) !== this.options.minDate.substring(0,4) ) ||\r\n        (filterActiveValue.end.substring(0,4) !== this.options.maxDate.substring(0,4) )) {\r\n          cnt += 1;\r\n        }\r\n      } else if ((filterActiveValue.begin !== this.options.minDate) || (filterActiveValue.end !== this.options.maxDate)) {\r\n        cnt += 1;\r\n      }\r\n    }\r\n    return cnt > 0 ? cnt : undefined;\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean;\r\n\r\n  public ogcFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\nimport {\r\n    OgcFilterableDataSource\r\n  } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterTimeService {\r\n\r\n    readonly defaultStepMillisecond = 60000;\r\n\r\n    constructor() {}\r\n\r\n    step(datasource: OgcFilterableDataSource, currentFilter): string {\r\n    return datasource.options.stepDate\r\n      ? datasource.options.stepDate\r\n      : currentFilter.step;\r\n    }\r\n\r\n    stepMillisecond(dataSource: OgcFilterableDataSource, currentFilter): number {\r\n        const step = moment.duration(this.step(dataSource, currentFilter)).asMilliseconds();\r\n        return step === 0 ? this.defaultStepMillisecond : step;\r\n    }\r\n\r\n    stepIsYearDuration(step: string) {\r\n        const year = moment.duration(step);\r\n        return (\r\n            year.years() !== 0 &&\r\n            year.months() === 0 &&\r\n            year.weeks() === 0 &&\r\n            year.days() === 0 &&\r\n            year.hours() === 0 &&\r\n            year.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsMonthDuration(step: string) {\r\n        const month = moment.duration(step);\r\n        return (\r\n            month.months() !== 0 &&\r\n            month.weeks() === 0 &&\r\n            month.days() === 0 &&\r\n            month.hours() === 0 &&\r\n            month.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsWeekDuration(step: string) {\r\n        const week = moment.duration(step);\r\n        return (\r\n            week.weeks() !== 0 &&\r\n            week.days() === 7 &&\r\n            week.hours() === 0 &&\r\n            week.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsDayDuration(step: string) {\r\n        const day = moment.duration(step);\r\n        return day.days() !== 0 && day.hours() === 0 && day.minutes() === 0;\r\n    }\r\n\r\n    stepIsHourDuration(step: string) {\r\n        const hour = moment.duration(step);\r\n        return hour.hours() !== 0 && hour.minutes() === 0;\r\n    }\r\n\r\n    stepIsMinuteDuration(step: string) {\r\n        const minute = moment.duration(step);\r\n        return minute.minutes() !== 0;\r\n    }\r\n\r\n    dateToNumber(date: Date): number {\r\n        let newDate = new Date();\r\n        if (date) {\r\n          newDate = new Date(date);\r\n        }\r\n        return newDate.getTime();\r\n    }\r\n\r\n    public addStep(value, stepMillisecond) {\r\n        return moment(value).add(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n\r\n    public subtractStep(value, stepMillisecond) {\r\n        return moment(value).subtract(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n}\r\n","<form [formGroup]=\"form\">\r\n  <div *ngFor=\"let selector of ogcFiltersSelectors\">\r\n    <div class=\"pushButtonGroups\" *ngIf=\"selector.selectorType === 'pushButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getPushButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"pushButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentPushButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getPushButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentPushButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-button-toggle-group\r\n          formControlName=\"pushButtons\" class=\"mat-typography\" appearance=\"legacy\" vertical={{bundleIsVertical(bundle)}} multiple=\"true\">\r\n          <mat-button-toggle *ngFor=\"let ogcPushButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcPushButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n            [ngStyle]=\"getButtonColor(ogcPushButton)\"\r\n            [checked]=\"ogcPushButton.enabled\" (change)=\"onSelectionChange(ogcPushButton, selector.selectorType)\"\r\n            [value]=\"ogcPushButton\">{{ogcPushButton.title}}\r\n          </mat-button-toggle>\r\n        </mat-button-toggle-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"checkboxGroups\" *ngIf=\"selector.selectorType === 'checkbox'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getCheckboxesGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"checkboxesGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentCheckboxesGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getCheckboxesGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentCheckboxesGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"checkboxes mat-typography\">\r\n          <mat-checkbox *ngFor=\"let ogcCheckbox of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcCheckbox)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcCheckbox.enabled\" (change)=\"onSelectionChange(ogcCheckbox, selector.selectorType)\"\r\n            [value]=\"ogcCheckbox\">{{ogcCheckbox.title}}\r\n          </mat-checkbox>\r\n        </div>\r\n        <p *ngIf=\"isLessResults(bundle, 'checkbox') || isMoreResults(bundle, 'checkbox')\">\r\n          <u *ngIf=\"isLessResults(bundle, 'checkbox')\"\r\n            class=\"lessResults mat-typography\"\r\n            (click)=\"displayLessResults('checkbox')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n          </u>\r\n          <u *ngIf=\"isMoreResults(bundle, 'checkbox')\"\r\n            class=\"moreResults mat-typography\"\r\n            (click)=\"displayMoreResults('checkbox')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n          </u>\r\n        </p>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"radioButtonGroups\" *ngIf=\"selector.selectorType === 'radioButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getRadioButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"radioButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentRadioButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getRadioButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentRadioButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-radio-group\r\n          formControlName=\"radioButtons\" class=\"mat-typography\">\r\n          <mat-radio-button *ngIf=\"bundle.unfiltered\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (change)=\"emptyRadioButtons()\">{{ 'igo.geo.filter.resetFilters' | translate }}\r\n          </mat-radio-button>\r\n          <mat-radio-button *ngFor=\"let ogcRadioButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcRadioButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcRadioButton.enabled\" (change)=\"onSelectionChange(ogcRadioButton, selector.selectorType)\"\r\n            [value]=\"ogcRadioButton\">{{ogcRadioButton.title}}\r\n          </mat-radio-button>\r\n          <p *ngIf=\"isLessResults(bundle, 'radio') || isMoreResults(bundle, 'radio')\">\r\n            <u *ngIf=\"isLessResults(bundle, 'radio')\"\r\n              class=\"lessResults mat-typography\"\r\n              (click)=\"displayLessResults('radio')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n            </u>\r\n            <u *ngIf=\"isMoreResults(bundle, 'radio')\"\r\n              class=\"moreResults mat-typography\"\r\n              (click)=\"displayMoreResults('radio')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n            </u>\r\n          </p>\r\n        </mat-radio-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"selectGroups\" *ngIf=\"selector.selectorType === 'select'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getSelectGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"selectGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentSelectGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getSelectGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentSelectGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered && !bundle.multiple\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptySelect()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field>\r\n            <div *ngIf=\"bundle.multiple; else notMulti\">\r\n              <mat-select\r\n                #selection [multiple]=\"bundle.multiple\" [placeholder]=\"bundle.title\"\r\n                [formControl]=\"select\" [(ngModel)]=\"enableds\">\r\n                <div class=\"checkboxes mat-typography\">\r\n                  <mat-checkbox *ngIf=\"bundle.multiple\"\r\n                    [(ngModel)]=\"allSelected\" [ngModelOptions]=\"{standalone: true}\"\r\n                    (change)=\"toggleAllSelection()\">Tous\r\n                  </mat-checkbox>\r\n                </div>\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  (onSelectionChange)=\"optionClick()\"\r\n                  [value]=\"ogcSelect\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </div>\r\n            <ng-template #notMulti>\r\n              <mat-select\r\n                [placeholder]=\"bundle.title\"\r\n                [formControl]=\"select\" [(ngModel)]=\"enabled\">\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  [value]=\"ogcSelect\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </ng-template>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n  </div>\r\n</form>\r\n\r\n<div *ngIf=\"isTemporalOperator()\">\r\n  <mat-divider></mat-divider>\r\n  <h4 *ngIf=\"!currentFilter.title\">{{ 'igo.geo.filter.reportingDate' | translate }}</h4>\r\n  <h4 *ngIf=\"currentFilter.title\">{{ currentFilter.title }}</h4>\r\n  <igo-ogc-filter-time\r\n    [(datasource)]=\"datasource\"\r\n    [(currentFilter)]=\"currentFilter\"\r\n    (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n  </igo-ogc-filter-time>\r\n</div>","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  IgoOgcFilterObject,\r\n  OgcPushButton,\r\n  OgcSelectorBundle,\r\n  SelectorGroup\r\n\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { IgoMap } from '../../map';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';\r\nimport { debounceTime } from 'rxjs/operators';\r\nimport { OgcFilterOperator } from '../shared/ogc-filter.enum';\r\nimport { MatSelect } from '@angular/material/select';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-selection',\r\n  templateUrl: './ogc-filter-selection.component.html',\r\n  styleUrls: ['./ogc-filter-selection.component.scss']\r\n})\r\nexport class OgcFilterSelectionComponent implements OnInit {\r\n\r\n  @ViewChild('selection') sel: MatSelect;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() checkboxesIndex = 5;\r\n  @Input() radioButtonsIndex = 5;\r\n  @Input() baseIndex = 5;\r\n\r\n  @Input()\r\n  get currentFilter(): any {\r\n    return this._currentFilter;\r\n  }\r\n  set currentFilter(value) {\r\n    this._currentFilter = value;\r\n    if (this._currentFilter?.sliderOptions) {\r\n      this._currentFilter.sliderOptions.enabled = false; // remove slider toggle (animation temporelle)\r\n    }\r\n  }\r\n  private _currentFilter: any;\r\n\r\n  public ogcFilterOperator = OgcFilterOperator;\r\n\r\n  public form: FormGroup;\r\n  private ogcFilterWriter: OgcFilterWriter;\r\n  public color = 'primary';\r\n  public allSelected = false;\r\n  public select = new FormControl();\r\n  public enabled$ = new BehaviorSubject(undefined);\r\n  public enableds$ = new BehaviorSubject([]);\r\n\r\n  public applyFiltersTimeout;\r\n\r\n  get ogcFiltersSelectors() {\r\n    const ogcSelector = [];\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.pushButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.checkboxes);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.radioButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.select);\r\n    }\r\n    ogcSelector.sort((a, b) => {\r\n      if (a.order < b.order) {\r\n        return -1;\r\n      }\r\n      if (a.order > b.order) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    return ogcSelector;\r\n  }\r\n\r\n  get currentPushButtonsGroup() {\r\n    return this.form.get('pushButtonsGroup').value;\r\n  }\r\n  set currentPushButtonsGroup(value) {\r\n    this.form.patchValue({ pushButtonsGroup: value });\r\n  }\r\n\r\n  get currentCheckboxesGroup() {\r\n    return this.form.get('checkboxesGroup').value;\r\n  }\r\n  set currentCheckboxesGroup(value) {\r\n    this.form.patchValue({ checkboxesGroup: value });\r\n  }\r\n\r\n  get currentRadioButtonsGroup() {\r\n    return this.form.get('radioButtonsGroup').value;\r\n  }\r\n  set currentRadioButtonsGroup(value) {\r\n    this.form.patchValue({ radioButtonsGroup: value });\r\n  }\r\n\r\n  get currentSelectGroup() {\r\n    return this.form.get('selectGroup').value;\r\n  }\r\n  set currentSelectGroup(value) {\r\n    this.form.patchValue({ selectGroup: value });\r\n  }\r\n\r\n  get enabled() {\r\n    return this.enabled$.value;\r\n  }\r\n\r\n  set enabled(value) {\r\n    this.enabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors.forEach(selector => {\r\n        value === selector ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get enableds() {\r\n    return this.enableds$.value;\r\n  }\r\n\r\n  set enableds(value) {\r\n    this.enableds$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors.forEach(selector => {\r\n        value.includes(selector) ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  constructor(\r\n    private ogcFilterService: OGCFilterService,\r\n    private formBuilder: FormBuilder,\r\n  ) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n    this.buildForm();\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      pushButtons: ['', [Validators.required]],\r\n      radioButtons: ['', [Validators.required]],\r\n      pushButtonsGroup: ['', [Validators.required]],\r\n      checkboxesGroup: ['', [Validators.required]],\r\n      radioButtonsGroup: ['', [Validators.required]],\r\n      selectGroup: ['', [Validators.required]],\r\n    });\r\n  }\r\n\r\n  getPushButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      return this.datasource.options.ogcFilters.pushButtons.groups;\r\n    }\r\n  }\r\n\r\n  getCheckboxesGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      return this.datasource.options.ogcFilters.checkboxes.groups;\r\n    }\r\n  }\r\n\r\n  getRadioButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      return this.datasource.options.ogcFilters.radioButtons.groups;\r\n    }\r\n  }\r\n\r\n  getSelectGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      return this.datasource.options.ogcFilters.select.groups;\r\n    }\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.datasource.options.ogcFilters) {\r\n      if (this.datasource.options.ogcFilters.pushButtons) {\r\n        this.currentPushButtonsGroup =\r\n          this.datasource.options.ogcFilters.pushButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.pushButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.checkboxes) {\r\n        this.currentCheckboxesGroup =\r\n          this.datasource.options.ogcFilters.checkboxes.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.checkboxes.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.radioButtons) {\r\n        this.currentRadioButtonsGroup =\r\n          this.datasource.options.ogcFilters.radioButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.radioButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.select) {\r\n        this.currentSelectGroup =\r\n          this.datasource.options.ogcFilters.select.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.select.groups[0];\r\n        this.getSelectEnabled();\r\n      }\r\n      this.applyFilters();\r\n    }\r\n\r\n    this.form\r\n    .get('pushButtonsGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onPushButtonsChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n    .get('checkboxesGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onCheckboxesChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtonsGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onRadioButtonsChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('selectGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onSelectChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('pushButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n  }\r\n\r\n  private getSelectEnabled() {\r\n    const enableds = [];\r\n    let enabled;\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      if (compSelect.multiple) {\r\n        compSelect.selectors.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enableds.push(selector);\r\n          }\r\n        });\r\n        this.enableds = enableds;\r\n      } else {\r\n        compSelect.selectors.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enabled = selector;\r\n          }\r\n        });\r\n        this.enabled = enabled;\r\n      }\r\n    });\r\n  }\r\n\r\n  getToolTip(selector): string {\r\n    let toolTip;\r\n    if (selector.tooltip) {\r\n      if (Array.isArray(selector.tooltip)) {\r\n        toolTip = selector.tooltip.join('\\n');\r\n      } else {\r\n        toolTip = selector.tooltip;\r\n      }\r\n    }\r\n    return toolTip || '';\r\n  }\r\n\r\n  // getButtonStyle(pb: OgcPushButton): {} {\r\n\r\n  //   let styles;\r\n  //   if (pb.color) {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? `rgba(${pb.color})` : `rgba(255,255,255,0)`\r\n  //     };\r\n  //   } else {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? 'accent': `rgba(255,255,255,0)`,\r\n  //       'color': pb.enabled ? `rgba(0,0,0,0.9)` : `rgba(33,33,33,0.38)`\r\n  //     }\r\n  //   }\r\n  //   return styles;\r\n  // }\r\n\r\n  getButtonColor(pushButton: OgcPushButton): {} {\r\n    let styles;\r\n    if (pushButton.color && pushButton.enabled) {\r\n      styles = {\r\n        'background-color': `rgba(${pushButton.color})`\r\n      };\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  bundleIsVertical(bundle: OgcSelectorBundle): boolean {\r\n    return bundle.vertical ? bundle.vertical : false;\r\n  }\r\n\r\n  private onPushButtonsChangeGroup() {\r\n    this.getPushButtonsGroups().map(group => group.enabled = false);\r\n    this.getPushButtonsGroups().find(group => group === this.currentPushButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onCheckboxesChangeGroup() {\r\n    this.getCheckboxesGroups().map(group => group.enabled = false);\r\n    this.getCheckboxesGroups().find(group => group === this.currentCheckboxesGroup).enabled = true;\r\n  }\r\n\r\n  private onRadioButtonsChangeGroup() {\r\n    this.getRadioButtonsGroups().map(group => group.enabled = false);\r\n    this.getRadioButtonsGroups().find(group => group === this.currentRadioButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onSelectChangeGroup() {\r\n    this.getSelectGroups().map(group => group.enabled = false);\r\n    this.getSelectGroups().find(group => group === this.currentSelectGroup).enabled = true;\r\n  }\r\n\r\n  onSelectionChange(currentOgcSelection?, selectorType?) {\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    if (selectorType === 'radioButton') {\r\n      this.emptyRadioButtons();\r\n    }\r\n\r\n    if (currentOgcSelection) {\r\n      currentOgcSelection.enabled = !currentOgcSelection.enabled;\r\n    }\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  emptyRadioButtons() {\r\n    this.currentRadioButtonsGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors.map(selector => selector.enabled = false);\r\n\r\n      this.applyFiltersTimeout = setTimeout(() => {\r\n        this.applyFilters();\r\n      }, 750);\r\n   });\r\n  }\r\n\r\n  emptySelect() {\r\n    this.enabled = [];\r\n  }\r\n\r\n  toggleAllSelection() {\r\n    if (this.allSelected) {\r\n      this.sel.options.forEach((item: MatOption) => item.select());\r\n    } else {\r\n      this.sel.options.forEach((item: MatOption) => item.deselect());\r\n    }\r\n  }\r\n\r\n  optionClick() {\r\n    let newStatus = true;\r\n    this.sel.options.forEach((item: MatOption) => {\r\n      if (!item.selected) {\r\n        newStatus = false;\r\n      }\r\n    });\r\n    this.allSelected = newStatus;\r\n  }\r\n\r\n  private applyFilters() {\r\n    let filterQueryString = '';\r\n    const conditions = [];\r\n    const currentGroups = [this.currentPushButtonsGroup, this.currentCheckboxesGroup,\r\n      this.currentRadioButtonsGroup, this.currentSelectGroup];\r\n    for (const currentGroup of currentGroups) {\r\n      if (currentGroup.computedSelectors) {\r\n        currentGroup.computedSelectors.map(selectorBundle => {\r\n          const bundleCondition = [];\r\n          selectorBundle.selectors\r\n          .filter(ogcSelector => ogcSelector.enabled === true)\r\n          .forEach(enabledSelector => bundleCondition.push(enabledSelector.filters));\r\n          if (bundleCondition.length >= 1 ) {\r\n            if (bundleCondition.length === 1) {\r\n              conditions.push(bundleCondition[0]);\r\n            } else {\r\n              conditions.push({logical: selectorBundle.logical, filters: bundleCondition});\r\n            }\r\n          }\r\n        });\r\n      }\r\n    }\r\n    if (this.isTemporalOperator() && this._currentFilter.active) {\r\n      conditions.push(this.datasource.options.ogcFilters.interfaceOgcFilters[0]);\r\n    }\r\n    if (conditions.length >= 1) {\r\n      filterQueryString = this.ogcFilterWriter\r\n        .buildFilter(conditions.length === 1 ?\r\n          conditions[0] : {logical: 'And', filters: conditions } as IgoOgcFilterObject);\r\n    }\r\n    if (this.datasource.options.type === 'wms') {\r\n      this.ogcFilterService.filterByOgc(this.datasource as WMSDataSource, filterQueryString );\r\n    }\r\n    if (this.datasource.options.type === 'wfs') {\r\n      // TODO: Check how to prevent wfs to refresh when filter icon is pushed...\r\n      this.datasource.ol.refresh();\r\n    }\r\n    this.datasource.setOgcFilters(this.datasource.options.ogcFilters, true);\r\n  }\r\n\r\n  isMoreResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return selectorsLength > index;\r\n  }\r\n\r\n  displayMoreResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex += 5 : this.checkboxesIndex += 5;\r\n    return;\r\n  }\r\n\r\n  isLessResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return this.baseIndex !== index && selectorsLength > this.baseIndex;\r\n  }\r\n\r\n  displayLessResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex = this.baseIndex : this.checkboxesIndex = this.baseIndex;\r\n    return;\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter?.operator?.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        filter => filter.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.applyFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n}\r\n","<mat-tab-group\r\n  [selectedIndex]=\"selectedTypeIndex.value\"\r\n  (selectedIndexChange)=\"selectedTypeIndex.setValue($event)\"\r\n  (selectedTabChange)=\"onTypeChange($event)\">\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.predefined' | translate\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.spatialFilter.searchLabel' | translate}}</mat-label>\r\n      <mat-select (selectionChange)=\"onSelectionChange()\" [(value)]=\"selectedQueryType\">\r\n        <mat-option *ngFor=\"let queryType of queryType\" [value]=\"queryType\">\r\n          {{('igo.geo.terrapi.' + queryType) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n    <igo-spatial-filter-list\r\n      [store]=\"store\"\r\n      [queryType]=\"selectedQueryType\"\r\n      [zone]=\"zone\"\r\n      [layers]=\"layers\"\r\n      (zoneChange)=\"zoneChange.emit($event)\"\r\n      (zoneWithBufferChange)=\"zoneWithBufferChange.emit($event)\"\r\n      (bufferChange)=\"bufferChange.emit($event)\"\r\n      (measureUnitChange)=\"measureUnitChange.emit($event)\">\r\n    </igo-spatial-filter-list>\r\n  </mat-tab>\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.draw' | translate\">\r\n    <div class=\"spatial-type-toggle\">\r\n      <mat-button-toggle-group\r\n        [value]=\"activeDrawType\"\r\n        (change)=\"onDrawTypeChange($event.value)\">\r\n        <mat-button-toggle [value]=\"spatialType.Polygon\" [matTooltip]=\"'igo.geo.spatialFilter.drawPolygon' | translate\">\r\n            <mat-icon svgIcon=\"pentagon-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"spatialType.Point\" [matTooltip]=\"'igo.geo.spatialFilter.drawCircle' | translate\">\r\n            <mat-icon svgIcon=\"record-circle-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n      </mat-button-toggle-group>\r\n    </div>\r\n  </mat-tab>\r\n\r\n</mat-tab-group>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { FormControl } from '@angular/forms';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { Layer } from '../../../layer';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-type',\r\n  templateUrl: './spatial-filter-type.component.html',\r\n  styleUrls: ['./spatial-filter-type.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterTypeComponent implements OnInit {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  public queryType: string[] = ['Arrond', 'CircFed', 'CircProv', 'DirReg', 'Mun', 'MRC', 'AdmRegion', 'RegTour'];\r\n  public selectedTypeIndex = new FormControl(0);\r\n\r\n  /**\r\n   * Reference to the SpatialFIlterType enum\r\n   * @internal\r\n   */\r\n  public spatialType = SpatialFilterType;\r\n\r\n  public activeDrawType: SpatialFilterType = this.spatialType.Polygon;\r\n\r\n  @Input() selectedQueryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public type: SpatialFilterType;\r\n\r\n  @Output() eventType = new EventEmitter<SpatialFilterType>();\r\n\r\n  @Output() eventQueryType = new EventEmitter<SpatialFilterQueryType>();\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = this.spatialType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onTypeChange(event) {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = SpatialFilterType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onDrawTypeChange(spatialType: SpatialFilterType) {\r\n    this.activeDrawType = spatialType;\r\n    this.eventType.emit(this.activeDrawType);\r\n  }\r\n\r\n  onSelectionChange() {\r\n    this.eventQueryType.emit(this.selectedQueryType);\r\n    this.zoneChange.emit(undefined);\r\n  }\r\n}\r\n","<form class=\"form-list\">\r\n    <mat-form-field class=\"zone-list\">\r\n        <input #input type=\"text\" placeholder=\"{{'igo.geo.spatialFilter.listLabel' | translate}}\" matInput\r\n        [formControl]=\"formControl\" [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onZoneChange($event.option.value)\"\r\n        [displayWith]=\"displayFn\">\r\n            <mat-option *ngFor=\"let entities of this.store.view.all$() | async\" [value]=\"entities\">\r\n                {{entities.properties.nom}}\r\n            </mat-option>\r\n        </mat-autocomplete>\r\n    </mat-form-field>\r\n<form>\r\n\r\n<div class=\"buffer-div\">\r\n    <form class=\"buffer-form\">\r\n        <mat-form-field class=\"buffer\">\r\n            <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n            [value]=\"0\" [readonly]=\"!zone\">\r\n        </mat-form-field>\r\n    </form>\r\n\r\n    <mat-form-field class=\"unit-field\">\r\n        <mat-select\r\n        [value]=\"measureUnit\"\r\n        (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n        <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n            {{('igo.geo.measure.' + measureUnit) | translate}}\r\n        </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n</div>\r\n","import { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { SpatialFilterService } from './../../shared/spatial-filter.service';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from './../../shared/spatial-filter.enum';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { FormControl } from '@angular/forms';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure/shared';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { Layer } from '../../../layer';\r\n\r\n@Component({\r\n  selector: 'igo-spatial-filter-list',\r\n  templateUrl: './spatial-filter-list.component.html',\r\n  styleUrls: ['./spatial-filter-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterListComponent implements OnInit, OnDestroy {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  @Input()\r\n  get queryType(): SpatialFilterQueryType {\r\n    return this._queryType;\r\n  }\r\n  set queryType(queryType: SpatialFilterQueryType) {\r\n    this.formControl.setValue('');\r\n    this._queryType = queryType;\r\n  }\r\n  private _queryType: SpatialFilterQueryType;\r\n\r\n  @Input()\r\n  get zone() {\r\n    return this._zone;\r\n  }\r\n  set zone(value) {\r\n    this._zone = value;\r\n    if (!value) {\r\n      this.zoneWithBuffer = undefined;\r\n      this.bufferFormControl.setValue(0);\r\n    }\r\n  }\r\n  private _zone;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public zoneWithBuffer;\r\n  public selectedZone: any;\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  public formControl = new FormControl();\r\n\r\n  public bufferFormControl = new FormControl();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  formValueChanges$$: Subscription;\r\n  bufferValueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.formValueChanges$$ = this.formControl.valueChanges.subscribe((value) => {\r\n      if (value.length) {\r\n        this.store.view.filter((feature) => {\r\n          const filterNormalized = value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          const featureNameNormalized = feature.properties.nom.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          return featureNameNormalized.includes(filterNormalized);\r\n        });\r\n      }\r\n    });\r\n\r\n    this.bufferValueChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500),\r\n        distinctUntilChanged()\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value * 1000,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0 && this.layers.length > 0) {\r\n          this.bufferChange.emit(value);\r\n          this.zoneWithBufferChange.emit(this.selectedZone);\r\n        } else if (\r\n            value < 0 ||\r\n            (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n            (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.bufferAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n        }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.formValueChanges$$.unsubscribe();\r\n  }\r\n\r\n  displayFn(feature?: Feature): string | undefined {\r\n    return feature ? feature.properties.nom : undefined;\r\n  }\r\n\r\n  onZoneChange(feature) {\r\n    if (feature && this.queryType) {\r\n      this.spatialFilterService.loadItemById(feature, this.queryType)\r\n      .subscribe((featureGeom: Feature) => {\r\n        this.selectedZone = featureGeom;\r\n        this.zoneChange.emit(featureGeom);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n    }\r\n  }\r\n}\r\n","<igo-geometry-form-field-input\r\n  [formControl]=\"formControl\"\r\n  [map]=\"map\"\r\n  [geometryType]=\"geometryType\"\r\n  [drawGuide]=\"drawGuide$ | async\"\r\n  [measure]=\"measure\"\r\n  [drawControlIsActive]=\"drawControlIsActive\"\r\n  [freehandDrawIsActive]=\"freehandDrawIsActive\"\r\n  [drawStyle]=\"drawStyle$ | async\"\r\n  [overlayStyle]=\"overlayStyle$ | async\"\r\n  [radius]=\"radius\">\r\n</igo-geometry-form-field-input>\r\n\r\n<div class=\"header\">\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onDrawControlChange()\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"freehandDrawIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onfreehandControlChange()\">\r\n      {{'igo.geo.spatialFilter.freehandControl' | translate}}\r\n    </mat-slide-toggle>\r\n</div>\r\n\r\n<div class=\"buffer-unit\" *ngIf=\"isPolygon()\">\r\n  <form class=\"buffer-form\">\r\n    <mat-form-field class=\"buffer\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n      [value]=\"0\" [readonly]=\"this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<div class=\"radius-unit\" *ngIf=\"isPoint()\">\r\n  <form class=\"radius-form\">\r\n    <mat-form-field class=\"radius\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.radius' | translate}}\" [formControl]=\"radiusFormControl\"\r\n      [value]=\"1000\" (input)=\"getRadius()\" [readonly]=\"this.freehandDrawIsActive && this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<mat-label class=\"title mat-typography\">{{'igo.geo.spatialFilter.search' | translate}} : </mat-label>\r\n<mat-radio-group [value]=\"selectedItemType\">\r\n    <mat-radio-button *ngFor=\"let item of itemType\"\r\n      [value]=\"item\"\r\n      (change)=\"onItemTypeChange($event)\">\r\n      {{'igo.geo.spatialFilter.' + item | translate}}\r\n    </mat-radio-button>\r\n</mat-radio-group>\r\n\r\n<div class=\"thematics\" *ngIf=\"(selectedItemType==='Thematics' && !tableTemplate) || (selectedItemType==='Thematics' && tableTemplate && !listIsVisible)\">\r\n  <mat-table>\r\n      <!-- Name Column -->\r\n      <ng-container matColumnDef=\"name\">\r\n        <mat-header-cell *matHeaderCellDef class=\"thematics-header\">{{'igo.geo.spatialFilter.Thematics' | translate}}</mat-header-cell>\r\n      </ng-container>\r\n\r\n      <!-- Select Column -->\r\n      <ng-container matColumnDef=\"select\">\r\n        <mat-header-cell *matHeaderCellDef class=\"checks-header\">\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"isAllSelected()\"\r\n                        [indeterminate]=\"selectedThematics.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </mat-header-cell>\r\n    </ng-container>\r\n\r\n    <mat-header-row *matHeaderRowDef=\"displayedColumns\"></mat-header-row>\r\n    <mat-row *matRowDef=\"let row; columns: displayedColumns;\"></mat-row>\r\n\r\n  </mat-table>\r\n\r\n  <mat-tree [dataSource]=\"dataSource\" [treeControl]=\"treeControl\">\r\n    <!-- This is the tree node template for leaf nodes -->\r\n    <mat-tree-node *matTreeNodeDef=\"let node\" matTreeNodeToggle>\r\n      <li class=\"mat-tree-node\">\r\n        <!-- use a disabled button to provide padding for tree leaf -->\r\n        <button mat-icon-button disabled></button>\r\n        {{node.name}}\r\n        <mat-checkbox class=\"tree-check\" (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"$event ? onToggleChange(node) : null\"\r\n                      [checked]=\"selectedThematics.isSelected(node)\">\r\n        </mat-checkbox>\r\n      </li>\r\n    </mat-tree-node>\r\n\r\n    <!-- This is the tree node template for expandable nodes -->\r\n    <mat-nested-tree-node *matTreeNodeDef=\"let node; when: hasChild\">\r\n        <div class=\"mat-tree-node\">\r\n          <button mat-icon-button\r\n            (click)=\"onToggleClick(node)\">\r\n            <mat-icon [svgIcon]=\"treeControl.isExpanded(node) ? 'chevron-down' : 'chevron-right'\"></mat-icon>\r\n          </button>\r\n          {{node.name}}\r\n          <mat-checkbox class=\"tree-check-2\" (change)=\"$event ? childrensToggle(node) : null\"\r\n                        [checked]=\"isAllSelected(node)\"\r\n                        [indeterminate]=\"hasChildrenSelected(node) && !isAllSelected(node)\">\r\n          </mat-checkbox>\r\n        </div>\r\n        <ul class=\"tree-ul\" [class.example-tree-invisible]=\"!treeControl.isExpanded(node)\">\r\n          <ng-container matTreeNodeOutlet></ng-container>\r\n        </ul>\r\n    </mat-nested-tree-node>\r\n\r\n  </mat-tree>\r\n</div>\r\n\r\n<div class=\"buttons\">\r\n\r\n  <button *ngIf=\"isPredefined()\" mat-raised-button class=\"clear-search-button\" [disabled]=\"disabledClearSearch()\"\r\n    (click)=\"clearSearch()\">\r\n      {{'igo.geo.spatialFilter.clearSearch' | translate}}\r\n  </button>\r\n\r\n  <button *ngIf=\"isPolygon() || isPoint()\" mat-raised-button class=\"clear-form-button\" [disabled]=\"this.formControl.value === null\"\r\n    (click)=\"clearDrawZone()\">\r\n    {{'igo.geo.spatialFilter.clearForm' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"search-button\" [disabled]=\"disableSearchButton()\" color=\"primary\"\r\n    (click)=\"toggleSearchButton()\">\r\n    {{'igo.geo.spatialFilter.goSearch' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"remove-button\" [disabled]=\"allLayers.length === 0\" (click)=\"clearButton()\">\r\n    {{'igo.geo.spatialFilter.removeLayer' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"export-button\" [disabled]=\"!store.entities$.getValue().length\" (click)=\"export.emit()\">\r\n    {{'igo.geo.spatialFilter.exportLayer' | translate}}\r\n  </button>\r\n\r\n</div>\r\n\r\n<button\r\n  class=\"chevron-down\"\r\n  *ngIf=\"store.all().length && tableTemplate && !listIsVisible\"\r\n  mat-icon-button\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.spatialFilter.showSearchResults' | translate\"\r\n  (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n</button>\r\n\r\n<div class=\"results\" *ngIf=\"store.all().length && tableTemplate && listIsVisible\">\r\n  <button\r\n    *ngIf=\"listIsVisible\"\r\n    mat-icon-button\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialFilter.hideSearchResults' | translate\"\r\n    (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n  </button>\r\n  <igo-entity-table\r\n    class=\"results-list\"\r\n    [template]=\"tableTemplate\"\r\n    [store]=\"store\"\r\n    (entitySelectChange)=\"entityChange.emit($event)\">\r\n  </igo-entity-table>\r\n</div>\r\n","import OlFeature from 'ol/Feature';\r\nimport {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\nimport { IgoMap } from '../../../map';\r\nimport { SpatialFilterItemType } from './../../shared/spatial-filter.enum';\r\nimport { Feature } from './../../../feature/shared/feature.interfaces';\r\nimport { FormControl } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { GeoJSONGeometry } from '../../../geometry/shared/geometry.interfaces';\r\nimport * as olStyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { MatTreeNestedDataSource } from '@angular/material/tree';\r\nimport { SpatialFilterService } from '../../shared/spatial-filter.service';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { EntityStore, EntityStoreFilterSelectionStrategy, EntityTableColumnRenderer, EntityTableTemplate } from '@igo2/common';\r\nimport { Layer, VectorLayer } from '../../../layer/shared';\r\nimport { NestedTreeControl } from '@angular/cdk/tree';\r\nimport { SpatialFilterThematic } from './../../shared/spatial-filter.interface';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { FeatureMotion, FeatureStoreSelectionStrategy } from '../../../feature';\r\nimport { FeatureDataSource } from '../../../datasource/shared';\r\n\r\n/**\r\n * Spatial-Filter-Item (search parameters)\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-item',\r\n  templateUrl: './spatial-filter-item.component.html',\r\n  styleUrls: ['./spatial-filter-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterItemComponent implements OnDestroy, OnInit {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get type(): SpatialFilterType {\r\n    return this._type;\r\n  }\r\n  set type(type: SpatialFilterType) {\r\n    this._type = type;\r\n    const index = this.geometryTypes.findIndex(geom => geom === this.type);\r\n    this.geometryType = this.geometryTypes[index];\r\n    this.formControl.reset();\r\n    this.radius = undefined;\r\n    this.drawGuide$.next(null);\r\n    this.drawStyle$.next(undefined);\r\n\r\n    // Necessary to keep reference to the geometry form field input\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      const geojson: GeoJSONGeometry = {\r\n        type: 'Point',\r\n        coordinates: ''\r\n      };\r\n      this.formControl.setValue(geojson);\r\n    }\r\n\r\n    // Necessary to apply the right style when geometry type is Point\r\n    if (this.type === SpatialFilterType.Point) {\r\n      this.radius = 1000; // Base radius\r\n      this.radiusFormControl.setValue(this.radius);\r\n      this.PointStyle = (feature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const geom = feature.getGeometry() as OlPoint;\r\n        const coordinates = olproj.transform(geom.getCoordinates(), this.map.projection, 'EPSG:4326');\r\n        return new olStyle.Style ({\r\n          image: new olStyle.Circle ({\r\n            radius: this.radius / (Math.cos((Math.PI / 180) * coordinates[1])) / resolution, // Latitude correction\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PointStyle;\r\n      this.drawStyle$.next(this.overlayStyle);\r\n    } else {\r\n      // If geometry types is Polygon\r\n      this.radius = undefined;\r\n      this.PolyStyle = () => {\r\n        return new olStyle.Style ({\r\n          stroke: new olStyle.Stroke({\r\n            width: 2,\r\n            color: 'rgba(0, 153, 255)'\r\n          }),\r\n          fill: new olStyle.Fill({\r\n            color: 'rgba(0, 153, 255, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      const color = [0, 153, 255];\r\n      const drawStyle = () => {\r\n        return new olStyle.Style({\r\n          image: new olStyle.Circle ({\r\n            radius: 8,\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          }),\r\n          stroke: new olStyle.Stroke({\r\n            color: color.concat([1]),\r\n            width: 2\r\n          }),\r\n          fill:  new olStyle.Fill({\r\n            color: color.concat([0.2])\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PolyStyle;\r\n      this.drawStyle$.next(drawStyle);\r\n    }\r\n    this.overlayStyle$.next(this.overlayStyle);\r\n  }\r\n  private _type: SpatialFilterType;\r\n\r\n  @Input() queryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() loading;\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n    this._store.entities$.subscribe(() => { this.cdRef.detectChanges(); });\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  @Input() allLayers: Layer[] = [];\r\n\r\n  @Input()\r\n  get thematicLength(): number {\r\n    return this._thematicLength;\r\n  }\r\n  set thematicLength(value: number) {\r\n    this._thematicLength = value;\r\n  }\r\n  private _thematicLength: number;\r\n\r\n  @Output() toggleSearch = new EventEmitter();\r\n\r\n  @Output() itemTypeChange = new EventEmitter<SpatialFilterItemType>();\r\n\r\n  @Output() thematicChange = new EventEmitter<SpatialFilterThematic[]>();\r\n\r\n  @Output() drawZoneEvent = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferEvent = new EventEmitter<number>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  @Output() radiusEvent = new EventEmitter<number>();\r\n  @Output() freehandControl = new EventEmitter<boolean>();\r\n\r\n  @Output() clearButtonEvent = new EventEmitter();\r\n\r\n  @Output() clearSearchEvent = new EventEmitter();\r\n\r\n  @Output() export = new EventEmitter();\r\n\r\n  @Output() openWorkspace = new EventEmitter();\r\n  @Output() entityChange = new EventEmitter<any>();\r\n\r\n  public itemType: SpatialFilterItemType[] = [SpatialFilterItemType.Address, SpatialFilterItemType.Thematics];\r\n  public selectedItemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  public selectedSourceAddress;\r\n\r\n  treeControl: NestedTreeControl<SpatialFilterThematic> = new NestedTreeControl<SpatialFilterThematic>(node => node.children);\r\n\r\n  // For thematics and results tables\r\n  public displayedColumns: string[] = ['name', 'select'];\r\n  public childrens: SpatialFilterThematic[] = [];\r\n  public groups: string[] = [];\r\n  public thematics: SpatialFilterThematic[] = [];\r\n  public dataSource = new MatTreeNestedDataSource<SpatialFilterThematic>();\r\n  public selectedThematics = new SelectionModel<SpatialFilterThematic>(true, []);\r\n\r\n  // For geometry form field input\r\n  value$: BehaviorSubject<GeoJSONGeometry> = new BehaviorSubject(undefined);\r\n  drawGuide$: BehaviorSubject<number> = new BehaviorSubject(null);\r\n  overlayStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n  drawStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n\r\n  private value$$: Subscription;\r\n  private radiusChanges$$: Subscription;\r\n  private bufferChanges$$: Subscription;\r\n\r\n  public formControl = new FormControl();\r\n  public geometryType: typeof OlGeometryType | string;\r\n  public geometryTypeField = false;\r\n  public geometryTypes: string[] = ['Point', 'Polygon'];\r\n  public drawGuideField = false;\r\n  public drawGuide: number = null;\r\n  public drawGuidePlaceholder = '';\r\n  public measure = false;\r\n  public drawControlIsActive = true;\r\n  public freehandDrawIsActive = false;\r\n  public drawStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public drawZone;\r\n  public overlayStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PointStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PolyStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n\r\n  public radius: number;\r\n  public buffer: number = 0;\r\n  public radiusFormControl = new FormControl();\r\n  public bufferFormControl = new FormControl();\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  public zoneWithBuffer;\r\n\r\n  public listIsVisible = true;\r\n  public tableTemplate: EntityTableTemplate;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.spatialFilterService.loadThematicsList()\r\n    .subscribe((items: SpatialFilterThematic[]) => {\r\n      for (const item of items) {\r\n        this.childrens.push(item);\r\n        this.childrens.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      }\r\n      this.groups.push(this.languageService.translate.instant('igo.geo.terrapi.limites'));\r\n      const limits: SpatialFilterThematic = {\r\n        name: this.groups[0],\r\n        children: []\r\n      };\r\n      this.thematics.push(limits);\r\n      this.childrens.forEach(child => {\r\n        if (child.group && (this.groups.indexOf(child.group) === -1)) {\r\n          this.groups.push(child.group);\r\n          const thematic: SpatialFilterThematic = {\r\n            name: child.group,\r\n            children: []\r\n          };\r\n          this.thematics.push(thematic);\r\n        }\r\n\r\n        if (!child.group) {\r\n          if (\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.AdmRegion') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Mun') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Arrond') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircFed') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircProv') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.DirReg') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.MRC') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.RegTour')) {\r\n              child.group = limits.name;\r\n          } else if (child.name === this.languageService.translate.instant('igo.geo.terrapi.routes')) {\r\n            child.group = this.languageService.translate.instant('igo.geo.spatialFilter.group.transport');\r\n          } else {\r\n            const thematic: SpatialFilterThematic = {\r\n              name: child.name,\r\n              children: [],\r\n              source: child.source\r\n            };\r\n            this.thematics.push(thematic);\r\n          }\r\n        }\r\n        this.thematics.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      });\r\n      this.thematics.forEach(thematic => {\r\n        for (const child of this.childrens) {\r\n          if (child.group === thematic.name) {\r\n            thematic.children.push(child);\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.dataSource.data = this.thematics;\r\n\r\n    this.drawGuide$.next(null);\r\n    this.value$.next(this.formControl.value ? this.formControl.value : undefined);\r\n    this.value$$ = this.formControl.valueChanges.subscribe((value: GeoJSONGeometry) => {\r\n      if (value) {\r\n        this.value$.next(value);\r\n        this.drawZone = this.formControl.value as Feature;\r\n        if (this.buffer !== 0) {\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n          this.bufferFormControl.setValue(this.buffer);\r\n        }\r\n      } else {\r\n        this.value$.next(undefined);\r\n        this.drawZone = undefined;\r\n      }\r\n    });\r\n\r\n    this.value$.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.radiusChanges$$ = this.radiusFormControl.valueChanges.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.bufferChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500)\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value * 1000\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n        } else if (\r\n          value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.buffer = 0;\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.bufferAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n        }\r\n    });\r\n\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map: this.map,\r\n      hitTolerance: 15,\r\n      motion: FeatureMotion.Default,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n\r\n    this.store.addStrategy(selectionStrategy, true);\r\n    this.store.addStrategy(selectedRecordStrategy, false);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the value stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.value$$.unsubscribe();\r\n    this.radiusChanges$$.unsubscribe();\r\n    this.bufferChanges$$.unsubscribe();\r\n    this.cdRef.detach();\r\n    if (this.radiusChanges$$) {\r\n      this.radiusChanges$$.unsubscribe();\r\n    }\r\n    if (this.value$$) {\r\n      this.value$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onItemTypeChange(event) {\r\n    this.selectedItemType = event.value;\r\n    this.itemTypeChange.emit(this.selectedItemType);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      if (this.isPolygon()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n      } else if (this.isPoint()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value * 1000) :\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value / 1000);\r\n      }\r\n    }\r\n  }\r\n\r\n  isPredefined() {\r\n    return this.type === SpatialFilterType.Predefined;\r\n  }\r\n\r\n  isPolygon() {\r\n    return this.type === SpatialFilterType.Polygon;\r\n  }\r\n\r\n  isPoint() {\r\n    return this.type === SpatialFilterType.Point;\r\n  }\r\n\r\n  hasChild(_: number, node: SpatialFilterThematic) {\r\n    if (node.children) {\r\n      return node.children.length;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  onToggleClick(node: SpatialFilterThematic) {\r\n    this.treeControl.isExpanded(node) ? this.treeControl.collapse(node) : this.treeControl.expand(node);\r\n  }\r\n\r\n  isAllSelected(node?: SpatialFilterThematic) {\r\n    let numSelected;\r\n    let numNodes = 0;\r\n    if (!node) {\r\n      numSelected = this.selectedThematics.selected.length;\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          numNodes++;\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.thematics.find(thematic => thematic.source === children.source)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    } else {\r\n      numSelected = node.children.length;\r\n      node.children.forEach(children => {\r\n        if (this.selectedThematics.selected.find(thematic => thematic === children)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (numNodes >= 1) {\r\n      return numSelected === numNodes;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  hasChildrenSelected(node: SpatialFilterThematic) {\r\n    let bool = false;\r\n    node.children.forEach(child => {\r\n      if (this.selectedThematics.selected.find(thematic => thematic.source === child.source)) {\r\n        bool = true;\r\n      }\r\n    });\r\n    return bool;\r\n  }\r\n\r\n  /**\r\n   * Apply header checkbox\r\n   */\r\n  masterToggle() {\r\n    this.isAllSelected() ?\r\n      this.selectedThematics.clear() :\r\n      this.selectAll();\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n\r\n    if (this.isAllSelected()) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.expand(thematic);\r\n        }\r\n      });\r\n    } else {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.collapse(thematic);\r\n        }\r\n      });\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  selectAll(node?: SpatialFilterThematic) {\r\n    if (!node) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          this.selectedThematics.select(thematic);\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.selectedThematics.selected.find(thematic => thematic.source === children.source)) {\r\n          this.selectedThematics.select(children);\r\n        }\r\n      });\r\n    } else {\r\n      if (this.hasChild(0, node)) {\r\n        node.children.forEach(children => this.selectedThematics.select(children));\r\n      }\r\n    }\r\n  }\r\n\r\n  childrensToggle(node: SpatialFilterThematic) {\r\n    this.isAllSelected(node) ?\r\n    node.children.forEach(child => this.selectedThematics.deselect(child)) :\r\n    this.selectAll(node);\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.treeControl.expand(node);\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  /**\r\n   * Apply changes to the thematics selected tree and emit event\r\n   */\r\n  onToggleChange(nodeSelected: SpatialFilterThematic) {\r\n    let selected = false;\r\n    if (this.selectedThematics.selected.find(thematic => thematic.source === nodeSelected.source) !== undefined) {\r\n      selected = true;\r\n    }\r\n\r\n    this.childrens.forEach(children => {\r\n      if (children === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(children);\r\n      }\r\n      if (children === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(children);\r\n      }\r\n    });\r\n    this.thematics.forEach(thematic => {\r\n      if (thematic === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(thematic);\r\n      }\r\n      if (thematic === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(thematic);\r\n      }\r\n    });\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  onDrawControlChange() {\r\n    this.drawControlIsActive = !this.drawControlIsActive;\r\n  }\r\n\r\n  onfreehandControlChange() {\r\n    this.freehandDrawIsActive = !this.freehandDrawIsActive;\r\n    this.freehandControl.emit(this.freehandDrawIsActive);\r\n  }\r\n\r\n  /**\r\n   * Launch search button\r\n   */\r\n  toggleSearchButton() {\r\n    if (!this.isPredefined()) {\r\n      if (this.buffer > 0) {\r\n        this.zoneWithBuffer.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.zoneWithBuffer.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.zoneWithBuffer);\r\n      } else {\r\n        this.drawZone.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.drawZone.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.drawZone);\r\n      }\r\n    }\r\n    if (this.isPoint()) {\r\n      this.radiusEvent.emit(this.radius);\r\n    } else if (this.isPolygon()) {\r\n      this.bufferEvent.emit(this.buffer);\r\n    }\r\n    this.toggleSearch.emit();\r\n    this.store.entities$.pipe(\r\n      debounceTime(500)\r\n    ).subscribe((value) => {\r\n      if (value.length && this.layers.length === this.thematicLength + 1) {\r\n        this.openWorkspace.emit();\r\n        this.createTableTemplate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Launch clear button (clear store and map layers)\r\n   */\r\n  clearButton() {\r\n    this.loading = true;\r\n    if (this.store) {\r\n      this.store.clear();\r\n    }\r\n    if (this.isPoint() || this.isPolygon()) {\r\n      this.drawZone = undefined;\r\n      this.formControl.reset();\r\n    }\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.clearButtonEvent.emit();\r\n    this.loading = false;\r\n    this.tableTemplate = undefined;\r\n  }\r\n\r\n  clearDrawZone() {\r\n    this.formControl.reset();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n  }\r\n\r\n  /**\r\n   * Launch clear search (clear field if type is predefined)\r\n   */\r\n  clearSearch() {\r\n    this.selectedThematics.clear();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.thematicChange.emit([]);\r\n    this.clearSearchEvent.emit();\r\n  }\r\n\r\n  /**\r\n   * Verify conditions of incomplete fields or busy service\r\n   */\r\n  disableSearchButton(): boolean {\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address) {\r\n        if (this.queryType !== undefined && this.zone !== undefined) {\r\n          return this.loading;\r\n        }\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.queryType !== undefined && this.zone !== undefined && this.selectedThematics.selected.length > 0) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon || this.type === SpatialFilterType.Point) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address && this.formControl.value !== null) {\r\n        return this.loading;\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.selectedThematics.selected.length > 0 && this.formControl.value !== null) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  disabledClearSearch() {\r\n    let disable = true;\r\n    this.selectedItemType === SpatialFilterItemType.Address ?\r\n      disable = this.queryType === undefined :\r\n      disable = this.queryType === undefined && this.selectedThematics.selected.length === 0;\r\n\r\n    return disable;\r\n  }\r\n\r\n  /**\r\n   * Manage radius value at user change\r\n   */\r\n  getRadius() {\r\n    let formValue;\r\n    if (this.formControl.value !== null) {\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        formValue = this.formControl.value.radius :\r\n        formValue = this.formControl.value.radius / 1000;\r\n    } else {\r\n      formValue = undefined;\r\n    }\r\n\r\n    if (this.type === SpatialFilterType.Point) {\r\n      if (!this.freehandDrawIsActive) {\r\n        if (\r\n          this.radiusFormControl.value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && this.radiusFormControl.value >= 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && this.radiusFormControl.value >= 100)) {\r\n          this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n            this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n          this.radius = 1000;\r\n          this.measureUnit === MeasureLengthUnit.Meters ?\r\n            this.radiusFormControl.setValue(this.radius) :\r\n            this.radiusFormControl.setValue(this.radius / 1000);\r\n          this.drawGuide$.next(this.radius);\r\n          return;\r\n        }\r\n      } else {\r\n        if (formValue) {\r\n          if (formValue >= 100000) {\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n            this.formControl.reset();\r\n            return;\r\n          }\r\n          if (formValue !== this.radiusFormControl.value) {\r\n            this.radiusFormControl.setValue(formValue);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      if (this.measureUnit === MeasureLengthUnit.Meters) {\r\n        this.radius = this.radiusFormControl.value;\r\n        this.drawGuide$.next(this.radius);\r\n      } else {\r\n        this.radius = this.radiusFormControl.value * 1000;\r\n        this.drawGuide$.next(this.radius * 1000);\r\n      }\r\n      this.overlayStyle$.next(this.PointStyle);\r\n      this.drawStyle$.next(this.PointStyle);\r\n    }\r\n  }\r\n\r\n  toggleVisibleList() {\r\n    this.listIsVisible = !this.listIsVisible;\r\n  }\r\n\r\n  private createTableTemplate() {\r\n    const typeColumn = {\r\n      name: 'meta.title',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.type'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const nameColumn = {\r\n      name: 'properties.nom',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.searchResults'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const columns = [typeColumn, nameColumn];\r\n\r\n    this.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n}\r\n","<div class=\"datetime-container\">\r\n  <mat-slide-toggle \r\n    *ngIf=\"this.currentFilter.sliderOptions?.enabled\"\r\n    [(ngModel)]=\"sliderMode\"\r\n    (change)=\"modeChange($event)\">\r\n    {{'igo.geo.filter.sliderModeTitle' | translate}}\r\n  </mat-slide-toggle>\r\n\r\n  <div class=\"slider-container\" *ngIf=\"sliderMode\">\r\n    <igo-ogc-filter-time-slider\r\n      [begin]=\"beginValue\"\r\n      [max]=\"this.restrictedToStep() ? this.maxDate : this.endValue\"\r\n      [currentFilter]=\"currentFilter\" \r\n      [datasource]=\"datasource\"\r\n      (changeProperty)=\"changePropertyByPass($event)\"\r\n    >\r\n    </igo-ogc-filter-time-slider>\r\n    \r\n  </div>\r\n\r\n  <div *ngIf=\"!sliderMode\">\r\n\r\n    <div class=\"year-input-container\" *ngIf=\"calendarTypeYear\">\r\n      <!-- to emulate a year-picker, 2 input: first input to show user just year and second input hiden and bind \r\n        with the datepicker  -->\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.startYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearBegin}}\"\r\n          (change)= \"yearOnlyInputChange($event, beginDatepicker, 'begin')\"\r\n          [disabled]= \"filterStateDisable\"\r\n          >\r\n        <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n  \r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #beginDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"beginValue\"\r\n          (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #beginYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"beginDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [min]=\"handleDate(datasource.options.minDate)\"\r\n          [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.endYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearEnd}}\"\r\n          (change)= \"yearOnlyInputChange($event, endDatepicker, 'end')\"\r\n          [disabled] = \"filterStateDisable\">\r\n        <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #endDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"endValue\"\r\n          (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #endYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"endDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n          [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [max]=\"handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n      <button class=\"reset-button\" \r\n        mat-icon-button\r\n        color=\"primary\" \r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class='toggle-filter-state' \r\n        (change)=\"toggleFilterState()\" \r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [checked]=\"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n\r\n    </div>\r\n\r\n    <div class=\"datetime-input-container\" *ngIf=\"calendarType()!=='year'\">\r\n      <div class=\"datetime-input\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n          <input #begin\r\n            matInput\r\n            [matDatepicker]=\"beginDatepicker\"\r\n            [placeholder]=\"'igo.geo.timeFilter.startDate' | translate\"\r\n            [attr.disabled]=\"!currentFilter.active\"\r\n            (dateChange)=\"changeTemporalProperty(begin.value, 1)\"\r\n            [matDatepickerFilter]=\"dateFilter.bind(this, 'begin')\"\r\n            [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n            [min]=\"handleDate(datasource.options.minDate)\"\r\n            [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\" \r\n            [disabled]= \"filterStateDisable\">\r\n          <span class=\"filler\"></span>\r\n          <mat-datepicker\r\n            #beginDatepicker\r\n            [startView]=\"calendarView()\"\r\n            [startAt]=\"beginValue\"\r\n            (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n            (monthSelected)=\"monthSelected($event, beginDatepicker, 'begin')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let hour of beginHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let minute of beginMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"datetime-input\" *ngIf=\"!restrictedToStep()\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n            <input #end\r\n              matInput\r\n              [matDatepicker]=\"endDatepicker\"\r\n              [placeholder]=\"'igo.geo.timeFilter.endDate' | translate\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (dateChange)=\"changeTemporalProperty(end.value, 2)\"\r\n              [matDatepickerFilter]=\"dateFilter.bind(this, 'end')\"\r\n              [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n              [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n              [max]=\"handleDate(datasource.options.maxDate)\" \r\n              [disabled]= \"filterStateDisable\">\r\n            <span class=\"filler\"></span>\r\n            <mat-datepicker #endDatepicker\r\n              [startView]=\"calendarView()\"\r\n              [startAt]=\"endValue\"\r\n              (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n              (monthSelected)=\"monthSelected($event, endDatepicker, 'end')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\" >\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let hour of endHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let minute of endMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <button class=\"reset-button\" \r\n        mat-icon-button color=\"primary\"\r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class=\"toggle-filter-state\" \r\n        (change)=\"toggleFilterState()\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        [checked]= \"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  ElementRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { FormControl } from '@angular/forms';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\nimport {\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFilterableDataSource,\r\n  OgcFilterDuringOptions\r\n} from '../shared/ogc-filter.interface';\r\n\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time',\r\n  templateUrl: './ogc-filter-time.component.html',\r\n  styleUrls: ['./ogc-filter-time.component.scss']\r\n})\r\nexport class OgcFilterTimeComponent implements OnInit {\r\n  @Input() datasource: OgcFilterableDataSource;\r\n  @Input() currentFilter: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: string;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n\r\n  beginHours: number[];\r\n  endHours: number[];\r\n  beginMinutes: number[];\r\n  endMinutes: number[];\r\n  beginHourFormControl = new FormControl();\r\n  beginMinuteFormControl = new FormControl();\r\n  endHourFormControl = new FormControl();\r\n  endMinuteFormControl = new FormControl();\r\n  _beginValue: Date;\r\n  _endValue: Date;\r\n  readonly _defaultMin: string = '1900-01-01';\r\n  readonly _defaultMax: string = '2052-01-06';\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderModeEnabled: boolean = true;\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  public sliderMode = false;\r\n\r\n  readonly defaultStepMillisecond = 60000;\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  public onlyYearBegin: number;\r\n  public onlyYearEnd: number;\r\n  public calendarTypeYear = false;\r\n  public resetIcon = 'replay';\r\n  public filterStateDisable: boolean;\r\n\r\n  @ViewChild('endDatepickerTime') endDatepickerTime: ElementRef;\r\n  @ViewChild('beginDatepickerTime') beginDatepickerTime: ElementRef;\r\n  @ViewChild('beginTime') beginTime: HTMLInputElement;\r\n  @ViewChild('endTime') endTime: HTMLInputElement;\r\n\r\n  get step(): string {\r\n    return this.datasource.options.stepDate\r\n      ? this.datasource.options.stepDate\r\n      : this.currentFilter.step;\r\n  }\r\n\r\n  get stepMilliseconds(): number {\r\n    const step = moment.duration(this.step).asMilliseconds();\r\n    return step === 0 ? this.defaultStepMillisecond : step;\r\n  }\r\n\r\n  set beginValue(begin: Date) {\r\n    this._beginValue = begin;\r\n  }\r\n\r\n  get beginValue(): Date {\r\n    return this._beginValue;\r\n  }\r\n\r\n  set endValue(end: Date) {\r\n    this._endValue = end;\r\n  }\r\n\r\n  get endValue(): Date {\r\n    return this._endValue;\r\n  }\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? 2000\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get maxDate(): string {\r\n    return this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    return this.currentFilter.displayFormat ? this.currentFilter.displayFormat : this._defaultDisplayFormat;\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {}\r\n\r\n  ngOnInit(){\r\n    if (this.currentFilter.sliderOptions) {\r\n      this.currentFilter.sliderOptions.enabled = this.currentFilter.sliderOptions.enabled !== undefined ?\r\n        this.currentFilter.sliderOptions.enabled : this._defaultSliderModeEnabled;\r\n    }\r\n    this.beginValue = this.parseFilter(this.handleMin());\r\n    this.endValue = this.parseFilter(this.handleMax());\r\n\r\n    this.onlyYearBegin = this.beginValue.getUTCFullYear();\r\n    this.onlyYearEnd = this.endValue.getUTCFullYear();\r\n    this.calendarTypeYear = this.isCalendarYearMode();\r\n    this.setFilterStateDisable();\r\n    this.updateHoursMinutesArray();\r\n    // update value for now value\r\n    this.updateValues();\r\n  }\r\n\r\n  parseFilter(filter): Date {\r\n    if (!filter){\r\n      return new Date();\r\n    } else if ( isNaN( new Date(filter).getTime() ) ) {\r\n      if (filter.search('now') >= 0 ) {\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if (filter.match(/\\+/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('+') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if (filter.match(/\\-/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('-') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return new Date();\r\n      }\r\n      if (filter.search('today') >= 0){\r\n        const _now = moment().endOf('day').toDate();\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if ( filter.match(/\\+/) ) {\r\n          const intervalInt = parseInt( filter.substring(filter.search('+') + 1, interval.index), 10 );\r\n          return moment(_now).add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if ( filter.match(/\\-/) ) {\r\n          const intervalInt = parseInt(filter.substring(filter.search('-') + 1, interval.index), 10);\r\n          return moment(_now).subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return _now;\r\n      }\r\n      return new Date();\r\n    }\r\n    if (this.currentFilter.calendarModeYear) {\r\n      const date = this.getDateFromStringWithoutTime(filter);\r\n      return date;\r\n    } else {\r\n      return filter ? new Date(filter) : new Date();\r\n    }\r\n  }\r\n\r\n  changeTemporalProperty(value, position?, refreshFilter = true) {\r\n    let valueTmp = this.getDateTime(value, position);\r\n    if (this.isCalendarYearMode()) {\r\n      let dateStringFromYearNotime;\r\n      if (position === 1) {\r\n        this.beginValue = value;\r\n        this.onlyYearBegin = this.beginValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearBegin}-01-01`;\r\n      } else {\r\n        this.endValue = value;\r\n        this.onlyYearEnd = this.endValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearEnd}-01-01`;\r\n      }\r\n      // call service with string date without time\r\n      this.changeProperty.next({ value: dateStringFromYearNotime, pos: position, refreshFilter });\r\n      return;\r\n    }\r\n    if (position === 2 && this.calendarType() === 'date' && !this.sliderMode) {\r\n      /* Above month: see yearSelected or monthSelected */\r\n      valueTmp = moment(valueTmp).endOf('day').toDate();\r\n    }\r\n\r\n    if (position === 1) {\r\n      this.beginValue = valueTmp;\r\n      if (this.restrictedToStep()) {\r\n        this.changeTemporalProperty(this.ogcFilterTimeService.addStep(valueTmp, this.stepMilliseconds), 2, refreshFilter);\r\n      }\r\n    } else {\r\n      this.endValue = valueTmp;\r\n    }\r\n    this.updateHoursMinutesArray();\r\n    this.changeProperty.next({ value: valueTmp.toISOString(), pos: position, refreshFilter });\r\n  }\r\n\r\n  handleDate(value): Date {\r\n    if (!value || value === '') {\r\n      return undefined;\r\n    }\r\n    if (typeof(value) === 'string' && this.currentFilter.calendarModeYear) {\r\n      return this.getDateFromStringWithoutTime(value);\r\n    }\r\n    return new Date(value);\r\n  }\r\n\r\n  calendarType() {\r\n    if (this.currentFilter.calendarModeYear) {\r\n      return 'year';\r\n    }\r\n    if (this.stepMilliseconds < 86400000) {\r\n      return 'datetime';\r\n    }\r\n    return 'date';\r\n  }\r\n\r\n  isCalendarYearMode(): boolean {\r\n    if (this.calendarType() === 'year') {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  yearOnlyInputChange(changeEvent, datePicker?: any, property?: string) {\r\n    const year = changeEvent.target.value;\r\n    const date = this.getDateFromStringWithoutTime(year);\r\n    this.yearSelected(date, datePicker, property);\r\n  }\r\n\r\n  yearSelected(year, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        // change value 01 jan to 31 dec same year\r\n        year = moment(year).endOf('year').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep() && !this.calendarTypeYear) {\r\n        this.yearSelected(year, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(year, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  monthSelected(month, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        month = moment(month).endOf('month').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep()) {\r\n        this.monthSelected(month, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(month, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  calendarView() {\r\n    const test = this.stepMilliseconds;\r\n    const diff = Math.abs(\r\n      this.parseFilter(this.currentFilter.end).getTime() -\r\n        this.parseFilter(this.currentFilter.begin).getTime()\r\n    );\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      return 'multi-year';\r\n    } else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      return 'year';\r\n    } else if (test < 86400000 && diff < 86400000) {\r\n      return 'clock';\r\n    } else {\r\n      return 'month';\r\n    }\r\n  }\r\n\r\n  dateFilter(type: string, date: string): boolean {\r\n    const dateValue = new Date(date);\r\n    const diff = dateValue.getTime() - new Date(this.handleMin()).getTime();\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'years', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'years', true);\r\n        return (monthDiffPlus1 % moment.duration(this.step).asYears()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (monthDiff % moment.duration(this.step).asYears()) === 0;\r\n      }\r\n    }\r\n    else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'months', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'months', true);\r\n        return (monthDiffPlus1 % moment.duration(this.step).asMonths()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (monthDiff % moment.duration(this.step).asMonths()) === 0;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsWeekDuration(this.step)) {\r\n      const weekDiff = moment(dateValue).diff(moment(this.handleMin()), 'weeks', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const weekDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'weeks', true);\r\n        return (weekDiffPlus1 % moment.duration(this.step).asWeeks()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (weekDiff % moment.duration(this.step).asWeeks()) === 0;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsDayDuration(this.step)) {\r\n      const dayDiff = moment(dateValue).diff(moment(this.handleMin()), 'days', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const dayDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'days', true);\r\n        const _mod = (dayDiffPlus1 % moment.duration(this.step).asDays());\r\n        return (_mod < 0.0000001 && _mod > -0.0000001) || _mod === 0 ; // 1 millisecond = 1.1574074074074076e-8\r\n      } else if ( type === 'begin' ) {\r\n        const _mod = ((dayDiff % moment.duration(this.step).asDays()) + 1);\r\n        return (_mod < 0.0000001 && _mod > -0.0000001 && _mod !== 0) || _mod === 1 ; // 1 millisecond = 1.1574074074074076e-8\r\n      }\r\n    } else if ( this.ogcFilterTimeService.stepIsHourDuration(this.step) ) {\r\n      const hourDiff = moment(dateValue).diff(moment(this.handleMin()), 'hours', true);\r\n      return (hourDiff % moment.duration(this.step).asHours()) === 0;\r\n\r\n    } else if ( this.ogcFilterTimeService.stepIsMinuteDuration(this.step) ) {\r\n      return true;\r\n    }\r\n\r\n    return diff % this.stepMilliseconds === 0;\r\n  }\r\n\r\n  getDateTime(date, pos) {\r\n    const valuetmp = new Date(date);\r\n    let valuetmp2;\r\n    if (!this.sliderMode) {\r\n      switch (pos) {\r\n        case 1: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n            this.beginHourFormControl.value,\r\n            this.beginMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n        case 2: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n              this.endHourFormControl.value,\r\n              this.endMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return new Date(valuetmp2 ? valuetmp2 : valuetmp);\r\n  }\r\n\r\n  handleMinuteIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsMinuteDuration(this.step)) {\r\n      if (this.stepMilliseconds < 3600000) {\r\n        return this.stepMilliseconds / 1000 === 60 ? 1 : this.stepMilliseconds / 1000;\r\n      } else {\r\n        return (this.stepMilliseconds % 3600000) / 60;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  handleHourIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return this.stepMilliseconds / 1000 / 60 / 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  fullBeginHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginHours = Array.from(\r\n        {\r\n          length:\r\n            (this.endHourFormControl.value - 0) / this.handleHourIncrement() + 1\r\n        },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.beginHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.beginHourFormControl.setValue(this.beginValue.getHours());\r\n  }\r\n\r\n  fullEndHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endHours = Array.from(\r\n        {\r\n          length:\r\n            (23 - this.beginHourFormControl.value) /\r\n              this.handleHourIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginHourFormControl.value + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.endHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.endHourFormControl.setValue(this.endValue.getHours());\r\n  }\r\n\r\n  fullBeginMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginMinutes = Array.from(\r\n        {\r\n          length:\r\n            (this.endMinuteFormControl.value - 0) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.beginMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.beginMinuteFormControl.setValue(this.beginValue.getMinutes());\r\n  }\r\n\r\n  fullEndMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endMinutes = Array.from(\r\n        {\r\n          length:\r\n            (59 - this.beginMinuteFormControl.value) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginMinuteFormControl.value + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.endMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.endMinuteFormControl.setValue(this.endValue.getMinutes());\r\n  }\r\n\r\n  updateHoursMinutesArray() {\r\n    const beginTmp = new Date(this.beginValue);\r\n    const endTmp = new Date(this.endValue);\r\n    if (beginTmp.setHours(0, 0) === endTmp.setHours(0, 0)) {\r\n      this.fullBeginHoursArray(true);\r\n      this.fullEndHoursArray(true);\r\n      if (this.beginValue.getHours() === this.endValue.getHours()) {\r\n        this.fullBeginMinutesArray(true);\r\n        this.fullEndMinutesArray(true);\r\n      }\r\n    } else {\r\n      this.fullBeginHoursArray();\r\n      this.fullEndHoursArray();\r\n      this.fullBeginMinutesArray();\r\n      this.fullEndMinutesArray();\r\n    }\r\n  }\r\n\r\n  private updateValues() {\r\n    this.changeTemporalProperty(this.beginValue, 1, false);\r\n    this.changeTemporalProperty(this.endValue, 2, true);\r\n  }\r\n\r\n  public restrictedToStep(): boolean {\r\n    return this.currentFilter.restrictToStep\r\n      ? this.currentFilter.restrictToStep : false;\r\n  }\r\n\r\n  public handleMin() {\r\n    return this.currentFilter.begin ? this.currentFilter.begin :\r\n              (this.datasource.options.minDate ? this.datasource.options.minDate : this._defaultMin);\r\n  }\r\n\r\n  public handleMax() {\r\n    return this.currentFilter.end ? this.currentFilter.end :\r\n              (this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax);\r\n  }\r\n\r\n  changePropertyByPass(event) {\r\n    this.changeProperty.next(event);\r\n  }\r\n\r\n  modeChange(event) {\r\n    if (!event.checked) {\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  setFilterStateDisable() {\r\n    if (this.currentFilter) {\r\n      this.filterStateDisable = !this.currentFilter.active;\r\n    } else {\r\n      this.filterStateDisable = false;\r\n    }\r\n    if(this.calendarType() === 'datetime') {\r\n      if (this.filterStateDisable === true) {\r\n        this.beginHourFormControl.disable();\r\n        this.beginMinuteFormControl.disable();\r\n        this.endHourFormControl.disable();\r\n        this.endMinuteFormControl.disable();\r\n      } else {\r\n        this.beginHourFormControl.enable();\r\n        this.beginMinuteFormControl.enable();\r\n        this.endHourFormControl.enable();\r\n        this.endMinuteFormControl.enable();\r\n      }\r\n    }\r\n  }\r\n  getDateFromStringWithoutTime(stringDate: string): Date {\r\n    // warning create date with no time make a date UTC with TZ and the date create maybe not the same year, month and day\r\n    // exemple:\r\n    // new Date('2022-01-01') -> Fri Dec 31 2021 19:00:00 GMT-0500 (heure normale de l’Est nord-américain)\r\n    // to create same date as string, add time 00 in the creation\r\n    // new Date('2022-01-01 00:00:00') -> Sat Jan 01 2022 00:00:00 GMT-0500 (heure normale de l’Est nord-américain)\r\n    let year;\r\n    let month = '01';\r\n    let day = '01';\r\n    if (stringDate.length === 10) {\r\n       const dateItems = stringDate.split('-');\r\n        if (dateItems.length !== 3) {\r\n          throw new Error('Error in config date begin-end for ogcFilter: Date without time format need to be YYYY-MM-DD or YYYY');\r\n        } else {\r\n          year = dateItems[0];\r\n          month = dateItems[1];\r\n          day = dateItems[2];\r\n        }\r\n    } else if (stringDate.length === 4) {\r\n      year = stringDate;\r\n    } else {\r\n      return new Date(stringDate);\r\n    }\r\n    return new Date(`${year}-${month}-${day} 00:00:00`);\r\n  }\r\n\r\n  resetFilter() {\r\n    let filterOriginConfig = this.datasource.options.ogcFilters.filters as OgcFilterDuringOptions;\r\n\r\n    let minDefaultDate;\r\n    let maxDefaultDate;\r\n    let minDefaultISOString;\r\n    let maxDefaultISOString;\r\n\r\n    if (this.calendarTypeYear) {\r\n      if (filterOriginConfig.end === 'today') {\r\n        let todayDateStringNoTime = new Date().toLocaleDateString('en-CA'); // '2022-02-13'\r\n        maxDefaultISOString = `${todayDateStringNoTime.substring(0,4)}-01-01`;\r\n      } else {\r\n        maxDefaultISOString = `${filterOriginConfig.end.substring(0,4)}-01-01`;\r\n      }\r\n      minDefaultISOString = `${filterOriginConfig.begin.substring(0,4)}-01-01`;\r\n      minDefaultDate = this.getDateFromStringWithoutTime(minDefaultISOString);\r\n      maxDefaultDate = this.getDateFromStringWithoutTime(maxDefaultISOString);\r\n    } else {\r\n      minDefaultDate = this.parseFilter(filterOriginConfig.begin);\r\n      maxDefaultDate = this.parseFilter(filterOriginConfig.end);\r\n      minDefaultISOString = minDefaultDate.toISOString();\r\n      maxDefaultISOString = maxDefaultDate.toISOString();\r\n    }\r\n\r\n    if ((this.currentFilter.begin !== minDefaultISOString ) ||\r\n    (this.currentFilter.end !== maxDefaultISOString)) {\r\n      this.beginValue = minDefaultDate;\r\n      this.endValue = maxDefaultDate;\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  toggleFilterState() {\r\n    if (this.currentFilter.active === true) {\r\n      this.currentFilter.active = false;\r\n    } else {\r\n      this.currentFilter.active = true;\r\n    }\r\n    this.setFilterStateDisable();\r\n    this.updateValues();\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\n\r\nimport * as moment_ from 'moment';\r\nimport { MatSlider } from '@angular/material/slider';\r\nconst moment = moment_;\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time-slider',\r\n  templateUrl: './ogc-filter-time-slider.component.html',\r\n  styleUrls: ['./ogc-filter-time-slider.component.scss']\r\n})\r\nexport class OgcFilterTimeSliderComponent implements OnInit {\r\n  @Input() currentFilter: any;\r\n  @Input() begin: any;\r\n  @Input() max: any;\r\n  @Input() datasource: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: any;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n  @ViewChild(MatSlider) slider: MatSlider;\r\n\r\n  interval;\r\n  sliderValue: number = 1;\r\n  calculatedStep: number = 0;\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderInterval: number = 2000;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? this._defaultSliderInterval\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    if (this.currentFilter.sliderOptions?.displayFormat){\r\n      return this.currentFilter.sliderOptions.displayFormat;\r\n    }\r\n    if (this.currentFilter.displayFormat) {\r\n      return this.currentFilter.displayFormat;\r\n    }\r\n    return this._defaultDisplayFormat;\r\n  }\r\n\r\n  get beginMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.begin);\r\n  }\r\n\r\n  get maxMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.max);\r\n  }\r\n\r\n  get stepMillisecond(): number {\r\n    return this.ogcFilterTimeService.stepMillisecond(this.datasource, this.currentFilter);\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {\r\n    this.sliderDisplayWith = this.sliderDisplayWith.bind(this);\r\n  }\r\n\r\n  ngOnInit(){\r\n    this.calculateStep();\r\n    this.handleSliderInput({value: 1});\r\n  }\r\n\r\n  sliderDisplayWith(value) {\r\n    let dateTmp = new Date(this.beginMillisecond + ((value - 1) * this.stepMillisecond));\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'year').toDate();\r\n    } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'month').toDate();\r\n    }\r\n\r\n    return moment(dateTmp).format(this.displayFormat);\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n\r\n          if (this.slider.value < this.calculatedStep) {\r\n            const _increment = '_increment';\r\n            const _emitInputEvent = '_emitInputEvent';\r\n            this.slider[_increment](1);\r\n            this.slider[_emitInputEvent]();\r\n          } else {\r\n            this.stopFilter();\r\n          }\r\n        },\r\n        this.sliderInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n    this.slider.value = 1;\r\n    const _increment = '_increment';\r\n    const _emitInputEvent = '_emitInputEvent';\r\n    this.slider[_emitInputEvent]();\r\n  }\r\n\r\n  handleSliderInput(matSliderChange) {\r\n    if (matSliderChange) {\r\n\r\n      if ( this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'year').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'year').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'month').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'month').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).startOf('month').toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsDayDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsHourDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsMinuteDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n            const dateTmp = new Date(this.beginMillisecond + (this.stepMillisecond * (matSliderChange.value - 1)));\r\n            this.changeProperty.next({value: dateTmp.toISOString(), pos: 1, refreshFilter: false});\r\n            this.changeProperty.next({value: new Date(this.ogcFilterTimeService.addStep(dateTmp.toISOString(),\r\n                                        this.stepMillisecond)).toISOString(),\r\n                                        pos: 2, refreshFilter: true});\r\n      }\r\n    }\r\n  }\r\n\r\n  calculateStep(){\r\n    for (let i = 1; (this.maxMillisecond - (this.beginMillisecond + (i * this.stepMillisecond))) >= -1; i++) {\r\n      this.calculatedStep = i;\r\n    }\r\n  }\r\n\r\n}\r\n","<div class=\"slider-container\">\r\n  <mat-slider\r\n    id=\"time-slider\"\r\n    [step]=\"1\"\r\n    [min]=\"1\"\r\n    [max]=\"calculatedStep\"\r\n    [(ngModel)]=\"sliderValue\"\r\n    [displayWith]=\"sliderDisplayWith\"\r\n    (input)=\"handleSliderInput($event)\"\r\n    thumbLabel\r\n    >\r\n  </mat-slider>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n    <mat-icon [svgIcon]=\"playIcon\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n    <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n  </button>\r\n  \r\n</div>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule, MatNativeDateModule, MAT_DATE_LOCALE } from '@angular/material/core';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatTreeModule } from '@angular/material/tree';\r\n\r\nimport {\r\n  MatDatetimepickerModule,\r\n  MatNativeDatetimeModule\r\n} from '@mat-datetimepicker/core';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoEntityModule\r\n} from '@igo2/common';\r\nimport { IgoGeometryModule } from './../geometry/geometry.module';\r\n\r\nimport { FilterableDataSourcePipe } from './shared/filterable-datasource.pipe';\r\nimport { IgoLayerModule } from '../layer/layer.module';\r\nimport { TimeFilterButtonComponent } from './time-filter-button/time-filter-button.component';\r\nimport { TimeFilterFormComponent } from './time-filter-form/time-filter-form.component';\r\nimport { TimeFilterItemComponent } from './time-filter-item/time-filter-item.component';\r\nimport { TimeFilterListBindingDirective } from './time-filter-list/time-filter-list-binding.directive';\r\nimport { TimeFilterListComponent } from './time-filter-list/time-filter-list.component';\r\nimport { TimeFilterService } from './shared/time-filter.service';\r\n\r\nimport { OgcFilterFormComponent } from './ogc-filter-form/ogc-filter-form.component';\r\nimport { OgcFilterableFormComponent } from './ogc-filterable-form/ogc-filterable-form.component';\r\nimport { OgcFilterableItemComponent } from './ogc-filterable-item/ogc-filterable-item.component';\r\nimport { OgcFilterableListBindingDirective } from './ogc-filterable-list/ogc-filterable-list-binding.directive';\r\nimport { OgcFilterableListComponent } from './ogc-filterable-list/ogc-filterable-list.component';\r\nimport { OgcFilterButtonComponent } from './ogc-filter-button/ogc-filter-button.component';\r\nimport { OGCFilterService } from './shared/ogc-filter.service';\r\nimport { OGCFilterTimeService } from './shared/ogc-filter-time.service';\r\nimport { OgcFilterSelectionComponent } from './ogc-filter-selection/ogc-filter-selection.component';\r\n\r\nimport { SpatialFilterTypeComponent } from './spatial-filter/spatial-filter-type/spatial-filter-type.component';\r\nimport { SpatialFilterListComponent } from './spatial-filter/spatial-filter-list/spatial-filter-list.component';\r\nimport { SpatialFilterItemComponent } from './spatial-filter/spatial-filter-item/spatial-filter-item.component';\r\nimport { SpatialFilterService } from './shared/spatial-filter.service';\r\nimport { OgcFilterTimeComponent } from './ogc-filter-time/ogc-filter-time.component';\r\nimport { OgcFilterTimeSliderComponent } from './ogc-filter-time/ogc-filter-time-slider.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatAutocompleteModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTabsModule,\r\n    MatRadioModule,\r\n    MatMenuModule,\r\n    MatTableModule,\r\n    MatTreeModule,\r\n    MatButtonToggleModule,\r\n    MatCheckboxModule,\r\n    MatSliderModule,\r\n    MatSlideToggleModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatDatetimepickerModule,\r\n    MatNativeDatetimeModule,\r\n    IgoLanguageModule,\r\n    IgoLayerModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoEntityModule,\r\n    IgoKeyValueModule,\r\n    IgoGeometryModule,\r\n    MatBadgeModule\r\n  ],\r\n  exports: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  declarations: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  providers: [TimeFilterService, OGCFilterService, OGCFilterTimeService, SpatialFilterService]\r\n})\r\nexport class IgoFilterModule {\r\n  static forRoot(): ModuleWithProviders<IgoFilterModule> {\r\n    return {\r\n      ngModule: IgoFilterModule,\r\n      providers: [\r\n        {\r\n          provide: MAT_DATE_LOCALE,\r\n          useValue: 'fr-FR'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const ExportFormat = strEnum(['URL', 'GeoJSON', 'GML', 'GPX', 'KML', 'Shapefile', 'CSVcomma', 'CSVsemicolon']);\r\nexport type ExportFormat = keyof typeof ExportFormat;\r\n\r\nexport const EncodingFormat = strEnum(['UTF8', 'LATIN1']);\r\nexport type EncodingFormat = keyof typeof EncodingFormat;\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { ExportFormat, EncodingFormat } from './export.type';\r\n\r\nimport {\r\n  ExportInvalidFileError,\r\n  ExportNothingToExportError\r\n} from './export.errors';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ExportService {\r\n  static ogreFormats = {\r\n    GML: 'gml',\r\n    GPX: 'gpx',\r\n    KML: 'kml',\r\n    Shapefile: 'ESRI Shapefile',\r\n    CSVcomma: 'CSVcomma',\r\n    CSVsemicolon: 'CSVsemicolon'\r\n  };\r\n\r\n  static noOgreFallbacks = ['GML', 'GPX', 'KML'];\r\n\r\n  private ogreUrl: string;\r\n  private aggregateInComment: boolean = true;\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const gpxAggregateInComment = this.config.getConfig(\r\n      'importExport.gpxAggregateInComment'\r\n    );\r\n    if (gpxAggregateInComment !== undefined) {\r\n      this.aggregateInComment = gpxAggregateInComment;\r\n    }\r\n  }\r\n\r\n  export(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<void> {\r\n    const exportOlFeatures = this.generateFeature(olFeatures, format);\r\n\r\n    return this.exportAsync(exportOlFeatures, format, title, encoding, projectionIn, projectionOut);\r\n  }\r\n\r\n  private generateFeature(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat\r\n  ): OlFeature<OlGeometry>[] {\r\n    if (format === ExportFormat.GPX && this.aggregateInComment) {\r\n      return this.generateAggregatedFeature(olFeatures);\r\n    }\r\n\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature\r\n        .getKeys()\r\n        .filter((key: string) => !key.startsWith('_'));\r\n      const properties = keys.reduce(\r\n        (acc: object, key: string) => {\r\n          acc[key] = olFeature.get(key);\r\n          return acc;\r\n        },\r\n        { geometry: olFeature.getGeometry() }\r\n      );\r\n      return new OlFeature(properties);\r\n    });\r\n  }\r\n\r\n  private generateAggregatedFeature(olFeatures: OlFeature<OlGeometry>[]): OlFeature<OlGeometry>[] {\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature.getKeys().filter((key: string) => !key.startsWith('_'));\r\n      let comment: string = '';\r\n      const properties = keys.reduce((acc: object, key: string) => {\r\n        if (key && key !== 'geometry') {\r\n          key === 'id' && olFeature.get('draw') ? comment += key + ':' + olFeature.get('draw') + '   \\r\\n'\r\n          : comment += key + ':' + olFeature.get(key) + '   \\r\\n';\r\n        }\r\n        acc[key] = olFeature.get(key);\r\n        return acc;\r\n      },\r\n      {\r\n        geometry: olFeature.getGeometry()\r\n      });\r\n      const newFeature = new OlFeature(properties);\r\n      newFeature.set('name', olFeature.getId());\r\n      newFeature.set('cmt', comment);\r\n\r\n      return newFeature;\r\n    });\r\n  }\r\n\r\n  private exportAsync(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<void> {\r\n    const doExport = (observer: Observer<void>) => {\r\n      const nothingToExport = this.nothingToExport(olFeatures, format);\r\n      if (nothingToExport) {\r\n        observer.error(new ExportNothingToExportError());\r\n        return;\r\n      }\r\n\r\n      const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n      if (ogreFormats.indexOf(format) >= 0) {\r\n        if (!this.ogreUrl) {\r\n          if (ExportService.noOgreFallbacks.indexOf(format) >= 0) {\r\n            this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n          } else {\r\n            observer.error(new ExportInvalidFileError());\r\n          }\r\n          return;\r\n        }\r\n        this.exportWithOgre(olFeatures, observer, format, title, encoding, projectionIn, projectionOut);\r\n      } else {\r\n        this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n      }\r\n    };\r\n\r\n    return new Observable(doExport);\r\n  }\r\n\r\n  protected exportToFile(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const olFormat = new olformat[format]();\r\n    const featuresText = olFormat.writeFeatures(olFeatures, {\r\n      dataProjection: projectionOut,\r\n      featureProjection: projectionIn,\r\n      featureType: 'feature',\r\n      featureNS: 'http://example.com/feature'\r\n    });\r\n\r\n    const fileName = `${title}.${format.toLowerCase()}`;\r\n\r\n    downloadContent(featuresText, 'text/plain;charset=utf-8', fileName);\r\n    observer.complete();\r\n  }\r\n\r\n  private exportWithOgre(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: string,\r\n    title: string,\r\n    encodingType: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const featuresText: string = new olformat.GeoJSON().writeFeatures(\r\n      olFeatures,\r\n      {\r\n        dataProjection: projectionOut,\r\n        featureProjection: projectionIn\r\n      }\r\n    );\r\n\r\n    const url = `${this.ogreUrl}/convertJson`;\r\n    const form = document.createElement('form');\r\n    form.style.display = 'none';\r\n    document.body.appendChild(form);\r\n    form.setAttribute('method', 'post');\r\n    form.setAttribute('target', '_blank');\r\n    form.setAttribute('action', url);\r\n\r\n    if (encodingType === EncodingFormat.UTF8) {\r\n      form.acceptCharset = 'UTF-8';\r\n      form.enctype = 'application/x-www-form-urlencoded; charset=utf-8;';\r\n    } else if (encodingType === EncodingFormat.LATIN1) {\r\n      const enctype = 'ISO-8859-1';\r\n      const encoding = document.createElement('input');\r\n      encoding.setAttribute('type', 'hidden');\r\n      encoding.setAttribute('name', 'encoding');\r\n      encoding.setAttribute('value', enctype);\r\n      form.appendChild(encoding);\r\n    }\r\n\r\n    if (format === 'CSVsemicolon') {\r\n      const options = document.createElement('input');\r\n      options.setAttribute('type', 'hidden');\r\n      options.setAttribute('name', 'lco');\r\n      options.setAttribute('value', 'SEPARATOR=SEMICOLON');\r\n      form.appendChild(options);\r\n    }\r\n\r\n    const geojsonField = document.createElement('input');\r\n    geojsonField.setAttribute('type', 'hidden');\r\n    geojsonField.setAttribute('name', 'json');\r\n    geojsonField.setAttribute('value', featuresText);\r\n    form.appendChild(geojsonField);\r\n\r\n    const outputNameField = document.createElement('input');\r\n    let outputName = format === 'Shapefile' ? `${title}.zip` : `${title}.${format.toLowerCase()}`;\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      outputName = `${title}.csv`;\r\n    }\r\n    outputName = outputName.replace(' ', '_');\r\n    outputName = outputName.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n    outputNameField.setAttribute('type', 'hidden');\r\n    outputNameField.setAttribute('name', 'outputName');\r\n    outputNameField.setAttribute('value', outputName);\r\n    form.appendChild(outputNameField);\r\n\r\n    let ogreFormat = ExportService.ogreFormats[format];\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      ogreFormat = 'CSV';\r\n    }\r\n    const outputFormatField = document.createElement('input');\r\n    outputFormatField.setAttribute('type', 'hidden');\r\n    outputFormatField.setAttribute('name', 'format');\r\n    outputFormatField.setAttribute('value', ogreFormat);\r\n    form.appendChild(outputFormatField);\r\n\r\n    form.submit();\r\n    document.body.removeChild(form);\r\n\r\n    observer.complete();\r\n  }\r\n\r\n  private nothingToExport(olFeatures: OlFeature<OlGeometry>[], format: string): boolean {\r\n    if (olFeatures.length === 0) {\r\n      return true;\r\n    }\r\n    if (format === 'GPX') {\r\n      const pointOrLine = olFeatures.find(olFeature => {\r\n        return (\r\n          ['Point', 'LineString', 'MultiLineString'].indexOf(olFeature.getGeometry().getType()) >= 0\r\n        );\r\n      });\r\n      return pointOrLine === undefined;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadContent(content: string, mimeType: string, fileName: string) {\r\n  const uri = `data:${mimeType},${encodeURIComponent(content)}`;\r\n  downloadFromUri(uri, fileName);\r\n}\r\n\r\n/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadFromUri(uri: string, fileName: string) {\r\n  const element = document.createElement('a');\r\n  element.setAttribute('href', uri);\r\n  element.setAttribute('download', fileName);\r\n  element.style.display = 'none';\r\n  document.body.appendChild(element);\r\n\r\n  element.click();\r\n\r\n  document.body.removeChild(element);\r\n}\r\n","import * as olStyle from 'ol/style';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureDataSourceOptions } from '../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature/shared/feature.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { ClusterParam } from '../../layer/shared/clusterParam';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { ClusterDataSourceOptions } from '../../datasource/shared/datasources/cluster-datasource.interface';\r\n\r\nexport function addLayerAndFeaturesToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    source,\r\n    style: new olStyle.Style({\r\n      stroke,\r\n      fill,\r\n      image: new olStyle.Circle({\r\n        radius: 5,\r\n        stroke,\r\n        fill\r\n      })\r\n    })\r\n  });\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addLayerAndFeaturesStyledToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = feature => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    const baseStyle = styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n    );\r\n\r\n    style = feature => {\r\n      return styleService.createClusterStyle(feature, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style')\r\n    );\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      'default.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList('default.distance');\r\n\r\n    const baseStyle = styleService.createStyle(\r\n      styleListService.getStyleList('default.clusterStyle')\r\n    );\r\n\r\n    style = feature => {\r\n      return styleService.createClusterStyle(feature, clusterParam, baseStyle);\r\n    };\r\n  } else {\r\n    style = styleService.createStyle(\r\n      styleListService.getStyleList('default.style')\r\n    );\r\n  }\r\n\r\n  let source;\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else if (styleListService.getStyleList(layerTitle.toString())) {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    source,\r\n    style\r\n  });\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  styleListService?: StyleListService,\r\n  styleService?: StyleService\r\n) {\r\n  if (features.length === 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const layerTitle = computeLayerTitleFromFile(file);\r\n\r\n  if (!styleListService) {\r\n    addLayerAndFeaturesToMap(features, map, layerTitle);\r\n  } else {\r\n    addLayerAndFeaturesStyledToMap(\r\n      features,\r\n      map,\r\n      layerTitle,\r\n      styleListService,\r\n      styleService\r\n    );\r\n  }\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant('igo.geo.dropGeoFile.success.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.success.text', {\r\n    value: layerTitle\r\n  });\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError,\r\n    'Invalid SRS definition': handleSRSImportError,\r\n    'Error 500 with OGRE': handleOgreServerImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    languageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalid.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalid.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.unreadable.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.unreadable.text', {\r\n    value: file.name\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.tooLarge.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.tooLarge.text', {\r\n    value: file.name,\r\n    size: sizeMb\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.empty.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.empty.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSRSImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalidSRS.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalidSRS.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleOgreServerImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const title = languageService.translate.instant('igo.geo.dropGeoFile.ogreServer.title');\r\n  const message = languageService.translate.instant('igo.geo.dropGeoFile.ogreServer.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name\r\n    .split('.')\r\n    .pop()\r\n    .toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportOgreServerError extends ImportError {\r\n  constructor() {\r\n      super('Error 500 with OGRE');\r\n      Object.setPrototypeOf(this, ImportOgreServerError.prototype);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  ImportInvalidFileError,\r\n  ImportUnreadableFileError,\r\n  ImportSizeError,\r\n  ImportSRSError,\r\n  ImportOgreServerError\r\n} from './import.errors';\r\nimport { computeLayerTitleFromFile, getFileExtension } from './import.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportService {\r\n  static allowedMimeTypes = [\r\n    'application/gml+xml',\r\n    'application/vnd.google-earth.kml+xml',\r\n    'application/gpx+xml',\r\n    'application/json'\r\n  ];\r\n\r\n  static allowedZipMimeTypes = [\r\n    'application/zip',\r\n    'application/x-zip-compressed',\r\n    'application/x-zip'\r\n  ];\r\n\r\n  static allowedExtensions = ['geojson', 'kml', 'gpx', 'json', 'gml'];\r\n\r\n  private ogreUrl: string;\r\n  private clientSideFileSizeMax: number;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const configFileSizeMb = this.config.getConfig('importExport.clientSideFileSizeMaxMb');\r\n    this.clientSideFileSizeMax = (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n  }\r\n\r\n  import(\r\n    file: File,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<Feature[]> {\r\n    return this.importAsync(file, projectionIn, projectionOut);\r\n  }\r\n\r\n  private getFileImporter(\r\n    file: File\r\n  ): (\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) => void {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n    const allowedMimeTypes = [\r\n      ...ImportService.allowedMimeTypes,\r\n      ...ImportService.allowedZipMimeTypes\r\n    ];\r\n    const allowedExtensions = ImportService.allowedExtensions;\r\n\r\n    if (\r\n      allowedMimeTypes.indexOf(mimeType) < 0 &&\r\n      allowedExtensions.indexOf(extension) < 0\r\n    ) {\r\n      return undefined;\r\n    } else if (\r\n      mimeType === 'application/json' ||\r\n      ['json', 'geojson', 'kml', 'gpx'].indexOf(extension) >= 0\r\n    ) {\r\n      return this.importFile;\r\n    } else if (this.ogreUrl !== undefined) {\r\n      return this.importFileWithOgre;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private importAsync(\r\n    file: File,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<Feature[]> {\r\n    const doImport = (observer: Observer<Feature[]>) => {\r\n      if (file.size >= this.clientSideFileSizeMax) {\r\n        observer.error(new ImportSizeError());\r\n        return;\r\n      }\r\n      const importer = this.getFileImporter(file);\r\n      if (importer === undefined) {\r\n        observer.error(new ImportInvalidFileError());\r\n        return;\r\n      }\r\n\r\n      importer.call(this, file, observer, projectionIn, projectionOut);\r\n    };\r\n\r\n    return new Observable(doImport);\r\n  }\r\n\r\n  private importFile(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const reader = new FileReader();\r\n\r\n    reader.onload = (event: any) => {\r\n      try {\r\n        const features = this.parseFeaturesFromFile(\r\n          file,\r\n          event.target.result,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n        observer.next(features);\r\n      } catch (e) {\r\n        observer.error(new ImportUnreadableFileError());\r\n      }\r\n\r\n      observer.complete();\r\n    };\r\n\r\n    reader.onerror = evt => {\r\n      observer.error(new ImportUnreadableFileError());\r\n    };\r\n\r\n    reader.readAsText(file, 'UTF-8');\r\n  }\r\n\r\n  private importFileWithOgre(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const url = `${this.ogreUrl}/convert`;\r\n    const formData = new FormData();\r\n    formData.append('upload', file);\r\n    formData.append('sourceSrs', projectionIn);\r\n    formData.append('targetSrs', projectionOut);\r\n    formData.append('formatOutput', 'GEOJSON');\r\n    formData.append('skipFailures', '');\r\n\r\n    this.http.post(url, formData, { headers: new HttpHeaders() })\r\n    .subscribe(\r\n      (response: { errors?: string[] } | object | null) => {\r\n        if (response === null) {\r\n          observer.error(new ImportUnreadableFileError());\r\n          return;\r\n        }\r\n\r\n        const errors = (response as any).errors || [];\r\n        if (errors.length > 0) {\r\n          observer.error(new ImportUnreadableFileError());\r\n        } else {\r\n          const features = this.parseFeaturesFromGeoJSON(\r\n            file,\r\n            response,\r\n            projectionOut\r\n          );\r\n          observer.next(features);\r\n          observer.complete();\r\n        }\r\n      },\r\n      (error: any) => {\r\n        error.error.caught = true;\r\n        const errMsg = error.error.msg || '';\r\n        if (errMsg === 'No valid files found') {\r\n          observer.error(new ImportInvalidFileError());\r\n        } else if (errMsg && errMsg.startWith('ERROR 1: Failed to process SRS definition')\r\n        ) {\r\n          observer.error(new ImportSRSError());\r\n        } else if (error.status === 500) {\r\n          observer.error(new ImportOgreServerError());\r\n        } else {\r\n          observer.error(new ImportUnreadableFileError());\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  private parseFeaturesFromFile(\r\n    file: File,\r\n    data: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n\r\n    const GeoJSON = new olformat.GeoJSON();\r\n\r\n    let format;\r\n    if (mimeType === 'application/vnd.google-earth.kml+xml') {\r\n      format = new olformat.KML();\r\n    } else if (mimeType === 'application/gml+xml') {\r\n      format = new olformat.GML();\r\n    } else if (mimeType === 'application/gpx+xml') {\r\n      format = new olformat.GPX();\r\n    } else {\r\n      switch (extension) {\r\n        case 'kml':\r\n          format = new olformat.KML();\r\n          break;\r\n        case 'gpx':\r\n          format = new olformat.GPX();\r\n          break;\r\n        case 'gml':\r\n          format = new olformat.GML();\r\n          break;\r\n        default:\r\n          format = GeoJSON;\r\n          break;\r\n      }\r\n    }\r\n\r\n    const olFeatures = format.readFeatures(data, {\r\n      dataProjection: projectionIn,\r\n      featureProjection: projectionOut\r\n    });\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(GeoJSON.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features;\r\n  }\r\n\r\n  private parseFeaturesFromGeoJSON(\r\n    file: File,\r\n    data: object,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const olFormat = new olformat.GeoJSON();\r\n    const olFeatures = olFormat.readFeatures(data);\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(olFormat.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features as Feature[];\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleListService {\r\n  private styleList: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in styleList file\r\n   */\r\n  public getStyleList(key: string): any {\r\n    return ObjectUtils.resolve(this.styleList, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all styleList's variables\r\n   */\r\n  public load(options: StyleListOptions) {\r\n    const baseStyleList = options.default || {};\r\n    if (!options.path) {\r\n      this.styleList = baseStyleList;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`StyleList file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((styleListResponse: object) => {\r\n          this.styleList = ObjectUtils.mergeDeep(baseStyleList, styleListResponse);\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","<div class=\"import-export-toggle mat-typography\">\r\n  <mat-button-toggle-group\r\n        [value]=\"selectedMode\"\r\n        (change)=\"onImportExportChange($event)\">\r\n        <mat-button-toggle [value]=\"'import'\">\r\n          {{'igo.geo.importExportForm.importTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"'export'\">\r\n          {{'igo.geo.importExportForm.exportTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n  </mat-button-toggle-group>\r\n</div>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"importForm\" *ngIf=\"selectedMode === 'import'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.importProjPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"inputProj\">\r\n        <mat-option\r\n          *ngFor=\"let projection of (projections$ | async)\"\r\n          [value]=\"projection\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line *ngIf=\"projection.translateKey\">{{('igo.geo.importExportForm.projections.' + projection.translateKey) | translate: projection}}</p>\r\n          <p mat-line *ngIf=\"!projection.translateKey\">{{projection.alias}}</p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"importForm.invalid ? ('igo.geo.importExportForm.projections.choose' | translate) : ('igo.geo.importExportForm.importButton' | translate)\"\r\n    class=\"igo-form-button-group\">\r\n    <button\r\n      [disabled]=\"importForm.invalid || (loading$ | async)\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"fileInput.click()\">\r\n        {{'igo.geo.importExportForm.importButton' | translate}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n    <input\r\n      hidden\r\n      #fileInput\r\n      type=\"file\"\r\n      [style.display]=\"'none'\"\r\n      (click)=\"fileInput.value = null\"\r\n      (change)=\"importFiles($event.target.files)\">\r\n  </div>\r\n</form>\r\n<section class=\"mat-typography\" *ngIf=\"selectedMode === 'import'\">\r\n  <h4>{{'igo.geo.importExportForm.importClarifications' | translate}}</h4>\r\n  <ul>\r\n    <li>{{'igo.geo.importExportForm.importSizeMax' | translate: {size: fileSizeMb} }}</li>\r\n    <li>{{'igo.geo.importExportForm.importFormatAuthorized' | translate}}</li>\r\n    <li>{{'igo.geo.importExportForm.importShpZip' | translate}}</li>\r\n  </ul>\r\n</section>\r\n\r\n<section class=\"mat-typography\" *ngIf=\"(exportableLayers$ | async).length === 0 && selectedMode === 'export'\">\r\n  <h4>{{'igo.geo.importExportForm.exportNoLayersExportable' | translate}}</h4>\r\n</section>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"form\" *ngIf=\"(exportableLayers$ | async).length > 0 && selectedMode === 'export'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportLayerPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"layers\" multiple>\r\n        <mat-select-trigger>\r\n          {{layers.length ? getLayerTitleById(layers[0]) : ''}}\r\n          <span *ngIf=\"layers.length > 1\" class=\"export-select-trigger\">\r\n            (+{{layers.length - 1}} {{(layers?.length === 2 ? 'igo.geo.importExportForm.other' : 'igo.geo.importExportForm.others') | translate }})\r\n          </span>\r\n        </mat-select-trigger>\r\n        <mat-option\r\n          *ngFor=\"let layer of (exportableLayers$ | async)\"\r\n          [ngClass]=\"{'igo-export-layer-mat-option': layerHasSelectedFeatures(layer)}\"\r\n          [value]=\"layer.id\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line>{{layer.title}}</p>\r\n          <p mat-line>\r\n            <mat-slide-toggle *ngIf=\"layerHasSelectedFeatures(layer)\"\r\n              [labelPosition]=\"'after'\"\r\n              (click)=\"onlySelectedClick($event,layer.id)\"\r\n              (checked)=\"inLayersIdToExportSelectionOnly(layer)\"\r\n              (change)=\"onlySelected($event,layer.id)\">\r\n              <small>{{'igo.geo.importExportForm.exportSelectedFeature' | translate}}</small>\r\n            </mat-slide-toggle>\r\n          </p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportFormatPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"format\">\r\n        <ng-container *ngIf=\"(formats$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let format of (formats$ | async) | keyvalue\" [value]=\"format.key\">\r\n            {{'igo.geo.export.format.' + format.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n        <mat-option *ngIf=\"(formats$ | async).length === 0\" disabled=\"true\">\r\n          {{'igo.geo.export.noFormat.title' | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"forceNaming && form.value.format !== 'URL'\">\r\n    <mat-form-field>\r\n        <input matInput formControlName=\"name\" placeholder=\"{{'igo.geo.importExportForm.exportFileNamePlaceholder' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon'\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.encodingPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"encoding\">\r\n        <ng-container *ngIf=\"(encodings$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let encoding of (encodings$ | async) | keyvalue\" [value]=\"encoding.key\">\r\n            {{'igo.geo.export.encoding.' + encoding.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"export-combine-layers mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon')\">\r\n    <mat-slide-toggle\r\n        formControlName=\"combineLayers\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportCombineResults' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-separator mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon') && form.value.combineLayers\">\r\n    <mat-slide-toggle\r\n        formControlName=\"separator\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportSeparator' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-options mat-typography\" *ngIf=\"form.value.format !== 'URL'\">\r\n    <mat-slide-toggle\r\n        formControlName=\"featureInMapExtent\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportFeatureInExtent' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (loading$ | async)\"\r\n      (click)=\"handleExportFormSubmit(form.value)\">\r\n      {{form.value.format !== 'URL'  ? ('igo.geo.importExportForm.exportButton' | translate): (form.value.layers.length > 1  ? ('igo.geo.importExportForm.exportButtonLinks' | translate): ('igo.geo.importExportForm.exportButtonLink' | translate))}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n  </div>\r\n\r\n</form>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { FormGroup, FormBuilder, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  MessageService,\r\n  LanguageService,\r\n  ConfigService,\r\n  StorageService\r\n} from '@igo2/core';\r\nimport { strEnum } from '@igo2/utils';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\nimport olPoint from 'ol/geom/Point';\r\nimport { circular } from 'ol/geom/Polygon';\r\n\r\nimport {\r\n  handleFileExportError,\r\n  handleFileExportSuccess\r\n} from '../shared/export.utils';\r\nimport { ExportOptions } from '../shared/export.interface';\r\nimport { ExportFormat, EncodingFormat } from '../shared/export.type';\r\nimport { ExportService } from '../shared/export.service';\r\nimport { ImportService } from '../shared/import.service';\r\nimport {\r\n  handleFileImportSuccess,\r\n  handleFileImportError\r\n} from '../shared/import.utils';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { skipWhile } from 'rxjs/operators';\r\nimport { EntityRecord, Workspace } from '@igo2/common';\r\nimport type { WorkspaceStore } from '@igo2/common';\r\nimport { WfsWorkspace } from '../../workspace/shared/wfs-workspace';\r\nimport { EditionWorkspace } from '../../workspace/shared/edition-workspace';\r\nimport { FeatureWorkspace } from '../../workspace/shared/feature-workspace';\r\nimport { MatSlideToggleChange } from '@angular/material/slide-toggle';\r\nimport { InputProjections, ProjectionsLimitationsOptions } from '../../map/';\r\nimport { DownloadService } from '../../download/shared/download.service';\r\nimport { computeProjectionsConstraints } from '../../map';\r\n\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Component({\r\n  selector: 'igo-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class ImportExportComponent implements OnDestroy, OnInit {\r\n  public form: FormGroup;\r\n  public importForm: FormGroup;\r\n  public formats$ = new BehaviorSubject(undefined);\r\n  public encodings$ = new BehaviorSubject(undefined);\r\n  public exportableLayers$: BehaviorSubject<AnyLayer[]> = new BehaviorSubject(\r\n    []\r\n  );\r\n  public loading$ = new BehaviorSubject(false);\r\n  public forceNaming = false;\r\n  public controlFormat = 'format';\r\n\r\n  private layers$$: Subscription;\r\n  private exportableLayers$$: Subscription;\r\n  private formats$$: Subscription;\r\n  private encodings$$: Subscription;\r\n  private formLayer$$: Subscription;\r\n  private exportOptions$$: Subscription;\r\n\r\n\r\n  private espgCodeRegex = new RegExp('^\\\\d{4,6}');\r\n  private clientSideFileSizeMax: number;\r\n  public fileSizeMb: number;\r\n\r\n  public projections$: BehaviorSubject<InputProjections[]> = new BehaviorSubject([]);\r\n  private projectionsConstraints: ProjectionsLimitationsOptions;\r\n\r\n  public popupChecked: boolean = false;\r\n\r\n  private previousLayerSpecs$: BehaviorSubject<\r\n    {\r\n      id: string;\r\n      visible: boolean;\r\n      opacity: number;\r\n      queryable: boolean;\r\n    }[]\r\n  > = new BehaviorSubject(undefined);\r\n\r\n  @Input() selectFirstProj: boolean = false;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  private _projectionsLimitations: ProjectionsLimitationsOptions = {};\r\n  @Input()\r\n  set projectionsLimitations(value: ProjectionsLimitationsOptions) {\r\n    this._projectionsLimitations = value;\r\n    this.computeProjections();\r\n  }\r\n  get projectionsLimitations(): ProjectionsLimitationsOptions {\r\n    return this._projectionsLimitations || {};\r\n  }\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  @Input() selectedMode = 'import';\r\n\r\n  @Output() selectMode = new EventEmitter<string>();\r\n\r\n  @Input() exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  @Output() exportOptionsChange = new EventEmitter<ExportOptions>();\r\n\r\n  get layers() {\r\n    return this.form.get('layers').value;\r\n  }\r\n  set layers(value) {\r\n    this.form.patchValue({ layers: value });\r\n  }\r\n\r\n  get inputProj() {\r\n    return this.importForm.get('inputProj').value;\r\n  }\r\n  set inputProj(value) {\r\n    this.importForm.patchValue({ inputProj: value });\r\n  }\r\n\r\n  get popupAllowed(): boolean {\r\n    return this.storageService.get('importExportPopupAllowed') as boolean || false;\r\n  }\r\n\r\n  set popupAllowed(value: boolean) {\r\n    this.storageService.set('importExportPopupAllowed', value);\r\n  }\r\n\r\n  constructor(\r\n    private importService: ImportService,\r\n    private exportService: ExportService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    private formBuilder: FormBuilder,\r\n    private config: ConfigService,\r\n    private cdRef: ChangeDetectorRef,\r\n    private storageService: StorageService,\r\n    private downloadService: DownloadService\r\n  ) {\r\n    this.loadConfig();\r\n    this.buildForm();\r\n    this.computeProjections();\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      this.exportableLayers$.next(\r\n        layers.filter((layer: Layer) => {\r\n          return (\r\n            (layer instanceof VectorLayer && layer.exportable === true) ||\r\n            (layer.dataSource.options.download &&\r\n              layer.dataSource.options.download.url)\r\n          );\r\n        }) as AnyLayer[]\r\n      );\r\n    });\r\n    const configFileSizeMb = this.config.getConfig(\r\n      'importExport.clientSideFileSizeMaxMb'\r\n    );\r\n    this.clientSideFileSizeMax =\r\n      (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n    this.fileSizeMb = this.clientSideFileSizeMax / Math.pow(1024, 2);\r\n\r\n    this.exportOptions$$ = this.exportOptions$\r\n      .pipe(skipWhile((exportOptions) => !exportOptions))\r\n      .subscribe((exportOptions) => {\r\n        this.form.patchValue(exportOptions, { emitEvent: true });\r\n        if (exportOptions.layers) {\r\n          this.computeFormats(\r\n            exportOptions.layers.map((l) => this.map.getLayerById(l))\r\n          );\r\n        }\r\n      });\r\n    this.formLayer$$ = this.form\r\n      .get('format')\r\n      .valueChanges\r\n      .subscribe((format) => {\r\n        const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n        if (\r\n          !this.popupChecked &&\r\n          this.form.get('layers').value?.length > 1 &&\r\n          (ogreFormats.indexOf(format) >= 0 || format === ExportFormat.URL)) {\r\n          if (!this.handlePopup(true)) {\r\n            this.form.patchValue({ format: undefined }, { emitEvent: false });\r\n          }\r\n        }\r\n      });\r\n\r\n    this.formLayer$$ = this.form\r\n      .get('layers')\r\n      .valueChanges.subscribe((layersId) => {\r\n        this.handlePreviousLayerSpecs();\r\n        const selectedLayers = layersId instanceof Array ? layersId : [layersId];\r\n        this.form.patchValue({ layers: selectedLayers }, { emitEvent: false });\r\n        const layers = selectedLayers.map((l) => this.map.getLayerById(l));\r\n        this.computeFormats(layers);\r\n\r\n        if (\r\n          Object.keys(this.formats$.value).indexOf(this.form.value.format) ===\r\n          -1\r\n        ) {\r\n          this.form.patchValue({ format: undefined });\r\n        }\r\n\r\n        this.loading$.next(true);\r\n        const previousSpecs: {\r\n          id: string;\r\n          visible: boolean;\r\n          opacity: number;\r\n          queryable: boolean;\r\n        }[] = [];\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer instanceof VectorLayer &&\r\n            layer.dataSource.ol.getFeatures().length === 0\r\n          ) {\r\n            previousSpecs.push({\r\n              id: layer.id,\r\n              visible: layer.visible,\r\n              opacity: layer.opacity,\r\n              queryable: (layer as any).queryable\r\n            });\r\n            layer.opacity = 0;\r\n            layer.visible = true;\r\n          }\r\n        });\r\n\r\n        this.previousLayerSpecs$.next(previousSpecs);\r\n        setTimeout(() => {\r\n          this.loading$.next(false);\r\n        }, 500);\r\n      });\r\n\r\n    this.formats$$ = this.formats$\r\n      .pipe(skipWhile((formats) => !formats))\r\n      .subscribe((formats) => {\r\n        if (Object.keys(formats).length === 1) {\r\n          this.form.patchValue({ format: formats[Object.keys(formats)[0]] });\r\n        }\r\n      });\r\n\r\n    this.encodings$$ = this.encodings$\r\n      .pipe(skipWhile((encodings) => !encodings))\r\n      .subscribe((encodings) => {\r\n        if (Object.keys(encodings).length === 1) {\r\n          this.form.patchValue({ encoding: encodings[Object.keys(encodings)[0]] });\r\n        }\r\n      });\r\n\r\n    this.exportableLayers$$ = this.exportableLayers$\r\n      .pipe(skipWhile((layers) => !layers))\r\n      .subscribe((layers) => {\r\n        if (layers.length === 1) {\r\n          this.form.patchValue({ layers: layers[0].id });\r\n        }\r\n      });\r\n\r\n    this.form.controls[this.controlFormat].valueChanges.subscribe((format) => {\r\n      if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n        this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      } else {\r\n        this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      }\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    if (this.selectFirstProj) {\r\n      if (this.projections$.value.length === 0) {\r\n        this.importForm.patchValue({ inputProj: { translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4326', zone: '' } });\r\n      } else {\r\n        this.importForm.patchValue({ inputProj: this.projections$.value[0] });\r\n      }\r\n    } else {\r\n      this.importForm.patchValue({ inputProj: undefined });\r\n    }\r\n  }\r\n\r\n  private computeProjections() {\r\n    this.projectionsConstraints = computeProjectionsConstraints(this.projectionsLimitations);\r\n    const projections: InputProjections[] = [];\r\n\r\n    if (this.projectionsConstraints.nad83) {\r\n      projections.push({ translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4269', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.wgs84) {\r\n      projections.push({ translateKey: 'wgs84', alias: 'WGS84', code: 'EPSG:4326', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.webMercator) {\r\n      projections.push({ translateKey: 'webMercator', alias: 'Web Mercator', code: 'EPSG:3857', zone: '' });\r\n    }\r\n\r\n    if (this.projectionsConstraints.mtm) {\r\n      // all mtm zones\r\n      const minZone = this.projectionsConstraints.mtmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.mtmZone.maxZone;\r\n\r\n      for (let mtmZone = minZone; mtmZone <= maxZone; mtmZone++) {\r\n        const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n        projections.push({ translateKey: 'mtm', alias: `MTM ${mtmZone}`, code, zone: `${mtmZone}` });\r\n      }\r\n    }\r\n\r\n    if (this.projectionsConstraints.utm) {\r\n      // all utm zones\r\n      const minZone = this.projectionsConstraints.utmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.utmZone.maxZone;\r\n\r\n      for (let utmZone = minZone; utmZone <= maxZone; utmZone++) {\r\n        const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n        projections.push({ translateKey: 'utm', alias: `UTM ${utmZone}`, code, zone: `${utmZone}` });\r\n      }\r\n    }\r\n\r\n    let configProjection = [];\r\n    if (this.projectionsConstraints.projFromConfig) {\r\n      configProjection = this.config.getConfig('projections') || [];\r\n    }\r\n\r\n    this.projections$.next(configProjection.concat(projections));\r\n  }\r\n\r\n  private getWorkspaceByLayerId(id: string): Workspace {\r\n    const wksFromLayerId = this.store\r\n      .all()\r\n      .find(workspace => (workspace as WfsWorkspace | FeatureWorkspace | EditionWorkspace).layer.id === id);\r\n    if (wksFromLayerId) {\r\n      return wksFromLayerId;\r\n    }\r\n    return;\r\n  }\r\n\r\n  public getLayerTitleById(id): string {\r\n    return this.map.getLayerById(id)?.title;\r\n  }\r\n\r\n\r\n  layerHasSelectedFeatures(layer: Layer): boolean {\r\n    const wksFromLayer = this.getWorkspaceByLayerId(layer.id);\r\n    if (wksFromLayer) {\r\n      const recs = wksFromLayer.entityStore.stateView\r\n        .firstBy((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        });\r\n      return recs ? true : false;\r\n    }\r\n  }\r\n\r\n  public onlySelected(event: MatSlideToggleChange, id: string) {\r\n    let layersWithSelection = this.form.value.layersWithSelection;\r\n    if (event.checked) {\r\n      layersWithSelection.push(id);\r\n    } else {\r\n      layersWithSelection = layersWithSelection.filter(layerId => layerId !== id);\r\n    }\r\n    this.form.patchValue({ layersWithSelection });\r\n  }\r\n\r\n  public onlySelectedClick(event, id: string) {\r\n    if (this.form.value.layers.find(layerId => layerId === id)) {\r\n      event.stopPropagation();\r\n    }\r\n  }\r\n\r\n  public inLayersIdToExportSelectionOnly(layer: Layer): boolean {\r\n    return this.form.value.layersWithSelection.find(layerId => layerId === layer.id) ? true : false;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.exportableLayers$$.unsubscribe();\r\n    this.formats$$.unsubscribe();\r\n    this.encodings$$.unsubscribe();\r\n    this.formLayer$$.unsubscribe();\r\n    if (this.exportOptions$$) {\r\n      this.exportOptions$$.unsubscribe();\r\n    }\r\n    this.exportOptionsChange.emit(this.form.value);\r\n    this.handlePreviousLayerSpecs();\r\n  }\r\n\r\n  private handlePreviousLayerSpecs() {\r\n    const previousSpecs = this.previousLayerSpecs$.value;\r\n    if (previousSpecs && previousSpecs.length) {\r\n      previousSpecs.forEach((specs) => {\r\n        const previousLayer = this.map.getLayerById(specs.id);\r\n        previousLayer.visible = specs.visible;\r\n        previousLayer.opacity = specs.opacity;\r\n        (previousLayer as any).queryable = specs.queryable;\r\n      });\r\n    }\r\n    this.previousLayerSpecs$.next(undefined);\r\n  }\r\n\r\n  importFiles(files: File[]) {\r\n    let inputProj = this.inputProj.code;\r\n    if (this.espgCodeRegex.test(inputProj)) {\r\n      inputProj = `EPSG:${inputProj}`;\r\n    }\r\n\r\n    this.loading$.next(true);\r\n    for (const file of files) {\r\n      this.importService.import(file, inputProj).subscribe(\r\n        (features: Feature[]) => this.onFileImportSuccess(file, features),\r\n        (error: Error) => this.onFileImportError(file, error),\r\n        () => {\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  handlePopup(preCheck: boolean = true): boolean {\r\n    const p1 = window.open('', 'popup', 'width=1, height=1');\r\n    p1.close();\r\n    const p2 = window.open('', 'popup', 'width=1, height=1');\r\n    if (!p2 || p2.closed || typeof p2.closed === 'undefined' || p2 === null) {\r\n      this.onPopupBlockedError(preCheck);\r\n      this.popupAllowed = false;\r\n    } else {\r\n      p2.close();\r\n      this.popupAllowed = true;\r\n      this.popupChecked = true;\r\n    }\r\n    return this.popupAllowed;\r\n  }\r\n\r\n  handleExportFormSubmit(data: ExportOptions) {\r\n    this.loading$.next(true);\r\n\r\n    const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n    if (!this.popupChecked && data.layers.length > 1 &&\r\n      (ogreFormats.indexOf(data.format) >= 0 || data.format === ExportFormat.URL) && !this.popupAllowed) {\r\n      this.handlePopup();\r\n    }\r\n\r\n    let geomTypesCSV: { geometryType: string, features: any[] }[] = [];\r\n    let featuresCSV: any[] = [];\r\n    let filename: string = \"\";\r\n\r\n    for (const [layerIndex, layer] of data.layers.entries()) {\r\n      const lay = this.map.getLayerById(layer);\r\n      if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma)\r\n      || !data.combineLayers || data.layers.length === 1) {\r\n        filename = lay.title;\r\n        if (data.name) {\r\n          filename = data.name;\r\n        }\r\n      } else {\r\n        filename = this.languageService.translate.instant('igo.geo.export.combinedLayers');\r\n      }\r\n      const dSOptions: DataSourceOptions = lay.dataSource.options;\r\n      if (data.format === ExportFormat.URL && dSOptions.download && (dSOptions.download.url || dSOptions.download.dynamicUrl)) {\r\n        setTimeout(() => {\r\n          // better look an feel\r\n          const url = dSOptions.download.url || dSOptions.download.dynamicUrl;\r\n          url.match(/service=wfs/gi) ? this.downloadService.open(lay) : window.open(url , '_blank');\r\n          this.loading$.next(false);\r\n        }, 500);\r\n        return;\r\n      }\r\n      const wks = this.getWorkspaceByLayerId(layer);\r\n      let olFeatures;\r\n      if (wks && wks.entityStore && wks.entityStore.stateView.all().length) {\r\n\r\n        if (data.layersWithSelection.indexOf(layer) !== -1 && data.featureInMapExtent) {\r\n          // Only export selected feature && into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent && e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.layersWithSelection.indexOf(layer) !== -1 && !data.featureInMapExtent) {\r\n          // Only export selected feature &&  (into map extent OR not)\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.featureInMapExtent) {\r\n          // Only into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent).map(e => (e.entity as Feature).ol);\r\n        } else {\r\n          // All features\r\n          olFeatures = wks.entityStore.stateView.all().map(e => (e.entity as Feature).ol);\r\n        }\r\n      }\r\n      else {\r\n        const ol = lay.dataSource.ol as olVectorSource<OlGeometry> | olClusterSource ;\r\n        if (data.featureInMapExtent) {\r\n          olFeatures = ol.getFeaturesInExtent(\r\n            lay.map.viewController.getExtent()\r\n          );\r\n        } else {\r\n          olFeatures = ol.getFeatures();\r\n        }\r\n        if (lay.dataSource instanceof ClusterDataSource) {\r\n          olFeatures = olFeatures.flatMap((cluster: any) =>\r\n            cluster.get('features')\r\n          );\r\n        }\r\n      }\r\n\r\n      const translate = this.languageService.translate;\r\n      let geomTypes: { geometryType: string, features: any[] }[] = [];\r\n      if (data.format === ExportFormat.Shapefile || data.format === ExportFormat.GPX) {\r\n        olFeatures.forEach((olFeature) => {\r\n          const featureGeomType = olFeature.getGeometry().getType();\r\n          const currentGeomType = geomTypes.find(geomType => geomType.geometryType === featureGeomType);\r\n          if (currentGeomType) {\r\n            currentGeomType.features.push(olFeature);\r\n          } else {\r\n            geomTypes.push({ geometryType: featureGeomType, features: [olFeature] });\r\n          }\r\n        });\r\n      } else {\r\n        geomTypes = [{ geometryType: '', features: olFeatures }];\r\n      }\r\n\r\n      geomTypes.forEach(geomType => {\r\n        geomType.features.forEach(feature => {\r\n          const radius: number = feature.get('rad');\r\n          if (radius) {\r\n            const center4326: Array<number> = [feature.get('longitude'), feature.get('latitude')];\r\n            const circle = circular(center4326, radius, 500);\r\n            circle.transform('EPSG:4326', feature.get('_projection'));\r\n            feature.setGeometry(circle);\r\n          }\r\n        });\r\n      });\r\n\r\n      if (data.format === ExportFormat.GPX) {\r\n        const gpxFeatureCnt = geomTypes.length;\r\n        geomTypes = geomTypes.filter(geomType => ['LineString', 'Point'].includes(geomType.geometryType));\r\n        const gpxFeatureCntPointOrPoly = geomTypes.length;\r\n        if (gpxFeatureCnt > gpxFeatureCntPointOrPoly) {\r\n          const title = translate.instant('igo.geo.export.gpx.error.poly.title');\r\n          const message = translate.instant('igo.geo.export.gpx.error.poly.text');\r\n          this.messageService.error(message, title, { timeOut: 20000 });\r\n        }\r\n      } else if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n        geomTypes.forEach(geomType => geomTypesCSV.push(geomType));\r\n\r\n        if (layerIndex !== data.layers.length - 1) {\r\n          continue;\r\n        } else {\r\n          let previousFeature = undefined;\r\n          geomTypesCSV.forEach(geomType => {\r\n            geomType.features.forEach(currentFeature => {\r\n              if (data.separator) {\r\n                if (previousFeature) {\r\n                  if (currentFeature.get('_featureStore').layer.options.title !==\r\n                  previousFeature.get('_featureStore').layer.options.title) {\r\n                    const titleEmptyRows = this.createTitleEmptyRows(previousFeature, currentFeature);\r\n                    featuresCSV.push(titleEmptyRows[2]);\r\n                    featuresCSV.push(titleEmptyRows[0]);\r\n                    featuresCSV.push(titleEmptyRows[1]);\r\n                  }\r\n                } else {\r\n                  const titleEmptyRows = this.createTitleEmptyRows(currentFeature, currentFeature);\r\n                  featuresCSV.push(titleEmptyRows[0]);\r\n                }\r\n              }\r\n              featuresCSV.push(currentFeature);\r\n              previousFeature = currentFeature;\r\n            });\r\n          });\r\n        }\r\n      }\r\n\r\n      if (geomTypes.length === 0) {\r\n        this.loading$.next(false);\r\n        const title = translate.instant('igo.geo.export.nothing.title');\r\n        const message = translate.instant('igo.geo.export.nothing.text');\r\n        this.messageService.error(message, title, { timeOut: 20000 });\r\n\r\n      } else {\r\n        if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) || !data.combineLayers) {\r\n          geomTypes.map(geomType =>\r\n            this.exportService.export(geomType.features, data.format, filename + geomType.geometryType, data.encoding, this.map.projection)\r\n            .subscribe(\r\n              () => {},\r\n              (error: Error) => this.onFileExportError(error),\r\n              () => {\r\n                this.onFileExportSuccess();\r\n\r\n                geomType.features.forEach(feature => {\r\n                  this.circleToPoint(feature);\r\n                });\r\n\r\n                this.loading$.next(false);\r\n            }\r\n          ));\r\n        }\r\n      }\r\n    };\r\n    if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n      this.exportService.export(featuresCSV, data.format, filename, data.encoding, this.map.projection)\r\n      .subscribe(\r\n        () => {},\r\n        (error: Error) => this.onFileExportError(error),\r\n        () => {\r\n          this.onFileExportSuccess();\r\n\r\n          featuresCSV.forEach(feature => {\r\n            this.circleToPoint(feature);\r\n          });\r\n\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private createTitleEmptyRows(previousFeature, currentFeature) {\r\n    const titleRow = currentFeature.clone();\r\n    const headerRow = currentFeature.clone();\r\n    const emptyRow = currentFeature.clone();\r\n    const previousFeatureKeys: Array<string> = previousFeature.getKeys();\r\n    let firstKeyPrevious: string = '';\r\n    for (const key in previousFeatureKeys) {\r\n      if (previousFeatureKeys[key] !== 'geometry') {\r\n        firstKeyPrevious = previousFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n\r\n    const currentFeatureKeys: Array<string> = currentFeature.getKeys();\r\n    let firstKeyCurrent: string = '';\r\n    for (const key in currentFeatureKeys) {\r\n      if (currentFeatureKeys[key] !== 'geometry') {\r\n        firstKeyCurrent = currentFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    const allKeys: Array<string> = currentFeature.getKeys();\r\n    previousFeatureKeys.forEach(previousKey => {\r\n      if (allKeys.includes(previousKey) && previousKey !== firstKeyPrevious) {\r\n        allKeys.push(previousKey);\r\n      }\r\n    });\r\n    allKeys.unshift(firstKeyPrevious);\r\n\r\n    let firstKeyAll: string = '';\r\n    for (const key in allKeys) {\r\n      if (allKeys[key] !== 'geometry') {\r\n        firstKeyAll = allKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    allKeys.forEach(key => {\r\n      const sameKeys: boolean = previousFeatureKeys.length === currentFeatureKeys.length &&\r\n      previousFeatureKeys.every((value, index) => value === currentFeatureKeys[index]);\r\n      if (key === firstKeyAll && !sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title + \" ===============>\", true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyAll && sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyCurrent) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key !== 'geometry') {\r\n        titleRow.unset(key, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else {\r\n        titleRow.unset(key, true);\r\n        emptyRow.unset(key, true);\r\n      }\r\n\r\n      if (!(currentFeatureKeys.includes(key))) {\r\n        headerRow.unset(key, true);\r\n      }\r\n    });\r\n    const titleEmptyRows = [titleRow, headerRow, emptyRow];\r\n    return titleEmptyRows;\r\n  }\r\n\r\n  private circleToPoint(feature) {\r\n    const radius: number = feature.get('rad');\r\n\r\n    if (radius) {\r\n      const point = new olPoint([feature.get('longitude'), feature.get('latitude')]);\r\n      point.transform('EPSG:4326', feature.get('_projection'));\r\n      feature.setGeometry(point);\r\n    }\r\n  }\r\n\r\n  private buildForm() {\r\n    this.importForm = this.formBuilder.group({\r\n      inputProj: ['', [Validators.required]]\r\n    });\r\n\r\n    if (this.forceNaming) {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n        name: ['', [Validators.required]]\r\n      });\r\n    } else {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n      });\r\n    }\r\n  }\r\n\r\n  private onFileImportSuccess(file: File, features: Feature[]) {\r\n    if (!this.config.getConfig('importWithStyle')) {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService\r\n      );\r\n    } else {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService,\r\n        this.styleListService,\r\n        this.styleService\r\n      );\r\n    }\r\n  }\r\n\r\n  private onFileImportError(file: File, error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileImportError(\r\n      file,\r\n      error,\r\n      this.messageService,\r\n      this.languageService,\r\n      this.fileSizeMb\r\n    );\r\n  }\r\n\r\n  private onPopupBlockedError(preCheck: boolean = true) {\r\n    this.loading$.next(false);\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.export.popupBlocked.title');\r\n    const extraMessage = preCheck ?\r\n      translate.instant('igo.geo.export.popupBlocked.selectAgain') :\r\n      translate.instant('igo.geo.export.popupBlocked.retry');\r\n    const message = translate.instant('igo.geo.export.popupBlocked.text', { extraMessage });\r\n    this.messageService.error(message, title, { timeOut: 20000 });\r\n  }\r\n\r\n  private onFileExportError(error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileExportError(error, this.messageService, this.languageService);\r\n  }\r\n\r\n  private loadConfig() {\r\n    if (this.config.getConfig('importExport.forceNaming') !== undefined) {\r\n      this.forceNaming = this.config.getConfig('importExport.forceNaming');\r\n    }\r\n    this.computeFormats();\r\n    this.loadEncodings();\r\n  }\r\n\r\n  public encodingDefaultValue(format: ExportFormat) {\r\n    if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n      this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      return EncodingFormat.LATIN1;\r\n    } else {\r\n      this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      return EncodingFormat.UTF8;\r\n    }\r\n  }\r\n\r\n  private loadEncodings() {\r\n    this.encodings$.next(EncodingFormat);\r\n  }\r\n\r\n  private computeFormats(layers?: AnyLayer[]) {\r\n    let appliedformats: string[] = Object.keys(ExportFormat);\r\n    const formatsType = {\r\n      onlyUrl: false,\r\n      onlyVector: false,\r\n      vectorAndUrl: false,\r\n      customList: false\r\n    };\r\n    const customList = [];\r\n    if (layers && layers.length) {\r\n      layers.forEach((layer) => {\r\n        if (!layer) {\r\n          return;\r\n        }\r\n        if (layer.dataSource.options.download?.allowedFormats) {\r\n          formatsType.customList = true;\r\n          customList.push({layer: layer.title, formats: this.validateListFormat(layer.dataSource.options.download.allowedFormats)});\r\n        } else if (\r\n          !(layer instanceof VectorLayer) &&\r\n          layer.dataSource.options.download &&\r\n          layer.dataSource.options.download.url\r\n        ) {\r\n          formatsType.onlyUrl = true;\r\n        } else if (\r\n          layer.dataSource.options.download &&\r\n          (layer.dataSource.options.download.url || layer.dataSource.options.download.dynamicUrl)\r\n        ) {\r\n          formatsType.vectorAndUrl = true;\r\n        } else if (layer instanceof VectorLayer) {\r\n          formatsType.onlyVector = true;\r\n        }\r\n      });\r\n\r\n      if (formatsType.onlyUrl === true && formatsType.onlyVector === false) {\r\n        appliedformats = ['URL'];\r\n      } else if (\r\n        formatsType.onlyVector === true &&\r\n        formatsType.onlyUrl === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (ExportFormat.URL in this.formats$.value) {\r\n          const keys = Object.keys(this.formats$.value).filter(\r\n            (key) => key !== 'URL'\r\n          );\r\n          appliedformats = keys;\r\n        }\r\n      } else if (\r\n        formatsType.vectorAndUrl === true &&\r\n        formatsType.onlyUrl === false &&\r\n        formatsType.onlyVector === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (!(ExportFormat.URL in this.formats$.value)) {\r\n          const keys = Object.keys(this.formats$.value);\r\n          keys.push('URL');\r\n          appliedformats = keys;\r\n        }\r\n      }\r\n    }\r\n    if (this.config.getConfig('importExport.formats') !== undefined) {\r\n      const validatedListFormat = this.validateListFormat(\r\n        this.config.getConfig('importExport.formats')\r\n      );\r\n      appliedformats = validatedListFormat;\r\n    }\r\n    if (formatsType.customList) {\r\n      let commonFormats;\r\n      const layersWithCustomFormats = [];\r\n      let previousCustomListFormats = customList[0].formats;\r\n      customList.map(list => {\r\n        layersWithCustomFormats.push(list.layer);\r\n        commonFormats = list.formats.filter(value => previousCustomListFormats.includes(value));\r\n        previousCustomListFormats = list.formats;\r\n      });\r\n      const finalFormats = commonFormats.filter(value => appliedformats.includes(value));\r\n      if (finalFormats.length > 0) {\r\n        this.formats$.next(strEnum(finalFormats));\r\n\r\n        if (layers && layers.length) {\r\n          if (layers.length > 1) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant('igo.geo.export.customList.text', { value: layersWithCustomFormats.join() }),\r\n              this.languageService.translate.instant('igo.geo.export.customList.title')\r\n            );\r\n          }\r\n        }\r\n      } else {\r\n        this.formats$.next([]);\r\n        this.messageService.alert(\r\n          this.languageService.translate.instant('igo.geo.export.noFormat.text'),\r\n          this.languageService.translate.instant('igo.geo.export.noFormat.title')\r\n        );\r\n      }\r\n      return;\r\n    } else {\r\n      this.formats$.next(strEnum(appliedformats));\r\n    }\r\n  }\r\n\r\n  private validateListFormat(formats: string[]): string[] {\r\n    return formats\r\n      .filter((format) => {\r\n        if (\r\n          format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GPX.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.KML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.Shapefile.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.URL.toUpperCase()\r\n        ) {\r\n          return format;\r\n        }\r\n      })\r\n      .map((format) => {\r\n        if (format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase()) {\r\n          format = ExportFormat.CSVcomma;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase()) {\r\n          format = ExportFormat.CSVsemicolon;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GML.toUpperCase()) {\r\n          format = ExportFormat.GML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GPX.toUpperCase()) {\r\n          format = ExportFormat.GPX;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase()) {\r\n          format = ExportFormat.GeoJSON;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.KML.toUpperCase()) {\r\n          format = ExportFormat.KML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.Shapefile.toUpperCase()) {\r\n          format = ExportFormat.Shapefile;\r\n          return format;\r\n        }\r\n\r\n        if (format.toUpperCase() === ExportFormat.URL.toUpperCase()) {\r\n          format = ExportFormat.URL;\r\n          return format;\r\n        }\r\n      });\r\n  }\r\n\r\n  public modeChanged(mode) {\r\n    this.selectMode.emit(mode);\r\n  }\r\n\r\n  private onFileExportSuccess() {\r\n    handleFileExportSuccess(this.messageService, this.languageService);\r\n  }\r\n\r\n  onImportExportChange(event) {\r\n    this.selectedMode = event.value;\r\n  }\r\n}\r\n","import { ProjectionsLimitationsOptions } from './projection.interfaces';\r\n\r\n/**\r\n * Return a number of zone MTM for a longitude for province of Quebec only\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneMtm(lon: number): number {\r\n    let lonMin = -54;\r\n    const lonMax = -81;\r\n    if (lon < lonMax || lon > lonMin) {\r\n      return 0;\r\n    }\r\n    else {\r\n      const deltaLon = 3;\r\n      let zone = 2;\r\n      while (Math.abs(lon - lonMin) > deltaLon) {\r\n        lonMin = lonMin - deltaLon;\r\n        zone++;\r\n      }\r\n      return zone;\r\n    }\r\n  }\r\n/**\r\n * Return a number of zone UTM for a longitude\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneUtm(lon: number): number {\r\n  let lonMin = -180;\r\n  const lonMax = 180;\r\n  const deltaLon = 6;\r\n  let zone = 1;\r\n  while (Math.abs(lon - lonMin) > deltaLon) {\r\n    lonMin = lonMin + deltaLon;\r\n    zone++;\r\n  }\r\n  return zone;\r\n}\r\n\r\n/**\r\n * Compute the contraints of projections\r\n * @param projectionsLimitations: ProjectionsLimitationsOptions\r\n * @returns projectionsContraints: ProjectionsLimitationsOptions\r\n */\r\nexport function computeProjectionsConstraints(\r\n    projectionsLimitations: ProjectionsLimitationsOptions):\r\n    ProjectionsLimitationsOptions {\r\n    const mtmZone = projectionsLimitations.mtmZone;\r\n    const utmZone = projectionsLimitations.utmZone;\r\n    const projectionsConstraints = {\r\n        projFromConfig: projectionsLimitations.projFromConfig === false ? false : true,\r\n        nad83: projectionsLimitations.nad83 === false ? false : true,\r\n        wgs84: projectionsLimitations.wgs84 === false ? false : true,\r\n        webMercator: projectionsLimitations.webMercator === false ? false : true,\r\n        utm: projectionsLimitations.utm === false ? false : true,\r\n        mtm: projectionsLimitations.mtm === false ? false : true,\r\n        utmZone: {\r\n        minZone: utmZone && utmZone.minZone ? utmZone.minZone : 17,\r\n        maxZone: utmZone && utmZone.maxZone ? utmZone.maxZone : 21,\r\n        },\r\n        mtmZone: {\r\n        minZone: mtmZone && mtmZone.minZone ? mtmZone.minZone : 2,\r\n        maxZone: mtmZone && mtmZone.maxZone ? mtmZone.maxZone : 10,\r\n        }\r\n    };\r\n    return projectionsConstraints;\r\n  }\r\n","import {\r\n  getEntityProperty,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { ExportNothingToExportError } from './export.errors';\r\n\r\nexport function handleFileExportError(\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  if (error instanceof ExportNothingToExportError) {\r\n    handleNothingToExportError(messageService, languageService);\r\n    return;\r\n  }\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.failed.title');\r\n  const message = translate.instant('igo.geo.export.failed.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleFileExportSuccess(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.success.title');\r\n  const message = translate.instant('igo.geo.export.success.text');\r\n  messageService.success(message, title);\r\n}\r\n\r\nexport function handleNothingToExportError(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.nothing.title');\r\n  const message = translate.instant('igo.geo.export.nothing.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\n/**\r\n * Export array to CSV\r\n *\r\n * @param rows Array of arrays to export as CSV\r\n * @param separator Cell separator\r\n */\r\nexport function exportToCSV(rows: any[][], fileName: string, separator: string = ';') {\r\n  const lines = rows.map((row: any[][], index: number) => row.join(separator));\r\n  const csvContent = lines.join('\\n');\r\n  downloadContent(csvContent, 'text/csv;charset=utf-8', fileName);\r\n}\r\n\r\n/**\r\n * Return an array of values from an array of entities.\r\n *\r\n * @param entities Array of entities\r\n * @param scolumns Columns definition of the output data\r\n */\r\nexport function entitiesToRowData(entities: object[], columns: EntityTableColumn[]) {\r\n  return entities.map((entity: object) => {\r\n    return columns.map((column: EntityTableColumn) => {\r\n      let valueAccessor;\r\n      if (column.renderer === undefined || column.renderer === EntityTableColumnRenderer.Default) {\r\n        valueAccessor = column.valueAccessor;\r\n      }\r\n      valueAccessor = valueAccessor ? valueAccessor : getEntityProperty;\r\n      return valueAccessor(entity, column.name);\r\n    });\r\n  });\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { StyleListService } from './style-list.service';\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\nexport let STYLELIST_OPTIONS = new InjectionToken<StyleListOptions>('styleListOptions');\r\n\r\nexport function provideStyleListOptions(options: StyleListOptions) {\r\n  return {\r\n    provide: STYLELIST_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function styleListFactory(\r\n  styleListService: StyleListService,\r\n  options: StyleListOptions\r\n) {\r\n  return () => styleListService.load(options);\r\n}\r\n\r\nexport function provideStyleListLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: styleListFactory,\r\n    multi: true,\r\n    deps: [StyleListService, STYLELIST_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideStyleListOptions, provideStyleListLoader } from './style-list.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoStyleListModule {\r\n  static forRoot(): ModuleWithProviders<IgoStyleListModule> {\r\n    return {\r\n      ngModule: IgoStyleListModule,\r\n      providers: [provideStyleListOptions({}), provideStyleListLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoDrapDropModule, IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { ExportButtonComponent } from './export-button/export-button.component';\r\nimport { ImportExportComponent } from './import-export/import-export.component';\r\nimport { DropGeoFileDirective } from './shared/drop-geo-file.directive';\r\nimport { IgoStyleListModule } from './style-list/style-list.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    IgoKeyValueModule,\r\n    IgoDrapDropModule,\r\n    IgoStyleListModule.forRoot()\r\n  ],\r\n  exports: [ImportExportComponent, DropGeoFileDirective, IgoStyleListModule, ExportButtonComponent],\r\n  declarations: [ImportExportComponent, DropGeoFileDirective, ExportButtonComponent]\r\n})\r\nexport class IgoImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoImportExportModule> {\r\n    return {\r\n      ngModule: IgoImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule } from '@igo2/common';\r\nimport { MapBrowserComponent } from './map-browser/map-browser.component';\r\nimport { ZoomButtonComponent } from './zoom-button/zoom-button.component';\r\nimport { GeolocateButtonComponent } from './geolocate-button/geolocate-button.component';\r\nimport { HomeExtentButtonComponent } from './home-extent-button/home-extent-button.component';\r\nimport { RotationButtonComponent } from './rotation-button/rotation-button.component';\r\nimport { BaseLayersSwitcherComponent } from './baselayers-switcher/baselayers-switcher.component';\r\nimport { MiniBaseMapComponent } from './baselayers-switcher/mini-basemap.component';\r\nimport { MapOfflineDirective } from './shared/mapOffline.directive';\r\nimport { OfflineButtonComponent } from './offline-button/offline-button.component';\r\nimport { PointerPositionDirective } from './shared/map-pointer-position.directive';\r\nimport { HoverFeatureDirective } from './shared/hover-feature.directive';\r\nimport { SwipeControlComponent } from './swipe-control/swipe-control.component';\r\nimport { MapCenterComponent } from './map-center/map-center.component';\r\nimport { MenuButtonComponent } from './menu-button/menu-button.component';\r\nimport { InfoSectionComponent } from './info-section/info-section.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ],\r\n  declarations: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ]\r\n})\r\nexport class IgoMapModule {}\r\n","<mat-form-field\r\n  class=\"measure-field\"\r\n  appearance=\"outline\"\r\n  floatLabel=\"always\">\r\n  <mat-label>{{placeholder}}</mat-label>\r\n  <input\r\n    matInput\r\n    [readonly]=\"true\"\r\n    [value]=\"((measure$ | async) || 0) | measureFormat: measureUnit\">\r\n</mat-form-field>\r\n<mat-form-field class=\"unit-field\">\r\n  <mat-select\r\n    [value]=\"measureUnit\"\r\n    [disabled]=\"auto\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n      {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit\r\n} from '../shared/measure.enum';\r\nimport { computeBestAreaUnit, computeBestLengthUnit } from '../shared/measure.utils';\r\n\r\n/**\r\n * Measurer item\r\n */\r\n@Component({\r\n  selector: 'igo-measurer-item',\r\n  templateUrl: './measurer-item.component.html',\r\n  styleUrls: ['./measurer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerItemComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Measure observable\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the measure observable when the auto mode is on\r\n   * @internal\r\n   */\r\n  public measure$$: Subscription;\r\n\r\n  /**\r\n   * Measure type\r\n   */\r\n  @Input() measureType: MeasureType;\r\n\r\n  /**\r\n   * Measure unit\r\n   */\r\n  @Input() measureUnit: MeasureAreaUnit | MeasureLengthUnit;\r\n\r\n  /**\r\n   * Measure\r\n   */\r\n  @Input()\r\n  set measure(value: number) {\r\n    this.measure$.next(value);\r\n  }\r\n  get measure(): number { return this.measure$.value; }\r\n\r\n  /**\r\n   * Whther measure units should be automatically determined\r\n   */\r\n  @Input()\r\n  set auto(value: boolean) { this.toggleAutoUnit(value); }\r\n  get auto(): boolean { return this._auto; }\r\n  private _auto: boolean = false;\r\n\r\n  /**\r\n   * Placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Event emitted when the measure unit changes\r\n   */\r\n  @Output() measureUnitChange = new EventEmitter<MeasureAreaUnit | MeasureLengthUnit>();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    if (this.measureType === MeasureType.Area) {\r\n      return Object.values(MeasureAreaUnit);\r\n    }\r\n    return Object.values(MeasureLengthUnit);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Toggle the auto unit off\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toggleAutoUnit(false);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureAreaUnit | MeasureLengthUnit) {\r\n    this.measureUnit = unit;\r\n    this.measureUnitChange.emit(unit);\r\n  }\r\n\r\n  private toggleAutoUnit(toggle: boolean) {\r\n    if (this.measure$$ !== undefined) {\r\n      this.measure$$.unsubscribe();\r\n    }\r\n    if (toggle === true) {\r\n      this.measure$$ = this.measure$.subscribe((measure: number) => {\r\n        this.computeBestMeasureUnit(measure);\r\n      });\r\n    }\r\n    this._auto = toggle;\r\n  }\r\n\r\n  private computeBestMeasureUnit(measure: number) {\r\n    let measureUnit = this.measureUnit;\r\n    if (this.measureType === MeasureType.Area) {\r\n      measureUnit = computeBestAreaUnit(measure);\r\n    } else if (this.measureType === MeasureType.Length) {\r\n      measureUnit = computeBestLengthUnit(measure);\r\n    }\r\n    if (measureUnit !== this.measureUnit) {\r\n      this.onMeasureUnitChange(measureUnit);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\n\r\nimport { MeasureFormatPipe } from './measure-format.pipe';\r\nimport { MeasurerItemComponent } from './measurer-item.component';\r\nimport { MeasurerComponent } from './measurer.component';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDividerModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule\r\n  ],\r\n  declarations: [\r\n    MeasureFormatPipe,\r\n    MeasurerItemComponent,\r\n    MeasurerComponent,\r\n    MeasurerDialogComponent\r\n  ],\r\n  exports: [\r\n    MeasureFormatPipe,\r\n    MeasurerComponent\r\n  ]\r\n})\r\nexport class IgoMeasurerModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoMeasurerModule } from './measurer/measurer.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n    IgoMeasurerModule\r\n  ]\r\n})\r\nexport class IgoMeasureModule {}\r\n","export enum OverlayAction {\r\n    None,\r\n    Move,\r\n    Zoom,\r\n    ZoomIfOutMapExtent\r\n  }\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayAction } from './overlay.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OverlayService {\r\n  public features$ = new BehaviorSubject<[Feature[], OverlayAction]>([\r\n    [],\r\n    undefined\r\n  ]);\r\n\r\n  constructor() {}\r\n\r\n  setFeatures(features: Feature[], action: OverlayAction = OverlayAction.None) {\r\n    this.features$.next([features, action]);\r\n  }\r\n\r\n  clear() {\r\n    this.features$.next([[], OverlayAction.None]);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayService } from '../shared/overlay.service';\r\nimport { OverlayAction } from '../shared/overlay.enum';\r\n\r\n@Directive({\r\n  selector: '[igoOverlay]'\r\n})\r\nexport class OverlayDirective implements OnInit, OnDestroy {\r\n  private features$$: Subscription;\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private overlayService: OverlayService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.features$$ = this.overlayService.features$.subscribe(res =>\r\n      this.handleFeatures(res[0], res[1])\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.features$$.unsubscribe();\r\n  }\r\n\r\n  private handleFeatures(features: Feature[], action: OverlayAction) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\nimport { OverlayDirective } from './shared/overlay.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [OverlayDirective],\r\n  declarations: [OverlayDirective]\r\n})\r\nexport class IgoOverlayModule {\r\n  static forRoot(): ModuleWithProviders<IgoOverlayModule> {\r\n    return {\r\n      ngModule: IgoOverlayModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { Observable, Subject, forkJoin } from 'rxjs';\r\nimport { map as rxMap } from 'rxjs/operators';\r\n\r\nimport { saveAs } from 'file-saver';\r\nimport jspdf from 'jspdf';\r\nimport html2canvas from 'html2canvas';\r\nimport * as JSZip from 'jszip';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { SecureImagePipe } from '@igo2/common';\r\nimport { MessageService, ActivityService, LanguageService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { formatScale } from '../../map/shared/map.utils';\r\nimport { LegendMapViewOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { getLayersLegends } from '../../layer/utils/outputLegend';\r\n\r\nimport { PrintOptions } from './print.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class PrintService {\r\n  zipFile: JSZip;\r\n  nbFileToProcess: number;\r\n  activityId: string;\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private activityService: ActivityService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  print(map: IgoMap, options: PrintOptions): Subject<any> {\r\n    const status$ = new Subject();\r\n\r\n    const paperFormat: string = options.paperFormat;\r\n    const resolution = +options.resolution; // Default is 96\r\n    const orientation = options.orientation;\r\n    const legendPostion = options.legendPosition;\r\n\r\n    this.activityId = this.activityService.register();\r\n    const doc = new jspdf({\r\n      orientation,\r\n      format: paperFormat.toLowerCase()\r\n    });\r\n\r\n    const dimensions = [\r\n      doc.internal.pageSize.width,\r\n      doc.internal.pageSize.height\r\n    ];\r\n\r\n    const margins = [10, 10, 10, 10];\r\n    const width = dimensions[0] - margins[3] - margins[1];\r\n    const height = dimensions[1] - margins[0] - margins[2];\r\n    const size = [width, height];\r\n    let titleSizeResults = [0, 0];\r\n\r\n    if (options.title !== undefined) {\r\n      titleSizeResults = this.getTitleSize(options.title, width, height, doc); // return : size(pt) and left margin (mm)\r\n      this.addTitle(doc, options.title, titleSizeResults[0], margins[3] + titleSizeResults[1], titleSizeResults[0] * (25.4 / 72));\r\n    }\r\n    if (options.subtitle !== undefined) {\r\n      let subtitleSizeResult = 0;\r\n      const titleH = titleSizeResults[0];\r\n      subtitleSizeResult = this.getSubTitleSize(options.subtitle, width, height, doc); // return : size(pt) and left margin (mm)\r\n      this.addSubTitle(doc, options.subtitle, titleH * 0.7, margins[3] + subtitleSizeResult, titleH * 1.7 * (25.4 / 72));\r\n      margins[0] = margins[0] + titleSizeResults[0] * 0.7 * (25.4 / 72);\r\n    }\r\n    if (options.showProjection === true || options.showScale === true) {\r\n      this.addProjScale(\r\n        doc,\r\n        map,\r\n        resolution,\r\n        options.showProjection,\r\n        options.showScale\r\n        );\r\n    }\r\n    if (options.comment !== '') {\r\n      this.addComment(doc, options.comment);\r\n    }\r\n\r\n    this.addMap(doc, map, resolution, size, margins).subscribe(\r\n      async (status: SubjectStatus) => {\r\n        if (status === SubjectStatus.Done) {\r\n          await this.addScale(doc, map, margins);\r\n          await this.handleMeasureLayer(doc, map, margins);\r\n          if (options.legendPosition !== 'none') {\r\n            if (['topleft', 'topright', 'bottomleft', 'bottomright'].indexOf(options.legendPosition) > -1 ) {\r\n              await this.addLegendSamePage(doc, map, margins, resolution, options.legendPosition);\r\n            } else if (options.legendPosition === 'newpage') {\r\n              await this.addLegend(doc, map, margins, resolution);\r\n            }\r\n          } else {\r\n            await this.saveDoc(doc);\r\n          }\r\n        }\r\n\r\n        if (status === SubjectStatus.Done || status === SubjectStatus.Error) {\r\n          this.activityService.unregister(this.activityId);\r\n          status$.next(SubjectStatus.Done);\r\n        }\r\n      }\r\n    );\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Add measure overlay on the map on the document when the measure layer is present\r\n   * @param  doc - Pdf document where measure tooltip will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async handleMeasureLayer(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n  ) {\r\n    if (map.layers.find(layer => layer.visible && layer.id.startsWith('igo-measures-'))) {\r\n      let canvasOverlayHTMLMeasures;\r\n      const mapOverlayMeasuresHTML = map.ol.getOverlayContainer();\r\n      await html2canvas(mapOverlayMeasuresHTML, {\r\n        scale: 1,\r\n        backgroundColor: null\r\n      }).then(e => {\r\n        canvasOverlayHTMLMeasures = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTMLMeasures, margins); // this adds measure overlays\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get html code for all layers legend\r\n   * @param  map IgoMap\r\n   * @param  width The width that the legend need to be\r\n   * @return Html code for the legend\r\n   */\r\n  getLayersLegendHtml(\r\n    map: IgoMap,\r\n    width: number,\r\n    resolution: number\r\n  ): Observable<string> {\r\n    return new Observable((observer) => {\r\n      let html = '';\r\n      const legends = getLayersLegends(\r\n        map.layers,\r\n        {\r\n          resolution: map.viewController.getResolution(),\r\n          extent: map.viewController.getExtent(),\r\n          projection: map.viewController.getOlProjection().getCode(),\r\n          scale: map.viewController.getScale(resolution),\r\n          size: map.ol.getSize()\r\n        } as LegendMapViewOptions\r\n      );\r\n      if (legends.length === 0) {\r\n        observer.next(html);\r\n        observer.complete();\r\n        return;\r\n      }\r\n      // Define important style to be sure that all container is convert\r\n      // to image not just visible part\r\n      html += '<style media=\"screen\" type=\"text/css\">';\r\n      html += '.html2canvas-container { width: ' + width + 'mm !important; height: 2000px !important; }';\r\n      html += 'table.tableLegend {table-layout: auto;}';\r\n      html += 'div.styleLegend {padding-top: 5px; padding-right:5px;padding-left:5px;padding-bottom:5px;}';\r\n      html += '</style>';\r\n      // The font size will also be lowered afterwards (globally along the legend size)\r\n      // this allows having a good relative font size here and to keep ajusting the legend size\r\n      // while keeping good relative font size\r\n      html += '<font size=\"3\" face=\"Times\" >';\r\n      html += '<div class=\"styleLegend\">';\r\n      html += '<table class=\"tableLegend\" >';\r\n\r\n      // For each legend, define an html table cell\r\n      const images$ = legends.map((legend) =>\r\n        this.getDataImage(legend.url).pipe(\r\n          rxMap((dataImage) => {\r\n            let htmlImg = '<tr><td>' + legend.title.toUpperCase() + '</td></tr>';\r\n            htmlImg += '<tr><td><img src=\"' + dataImage + '\"></td></tr>';\r\n            return htmlImg;\r\n          })\r\n        )\r\n      );\r\n      forkJoin(images$).subscribe((dataImages) => {\r\n        html = dataImages.reduce((acc, current) => (acc += current), html);\r\n        html += '</table>';\r\n        html += '</div>';\r\n        observer.next(html);\r\n        observer.complete();\r\n      });\r\n    });\r\n  }\r\n\r\n  getDataImage(url: string): Observable<string> {\r\n    const secureIMG = new SecureImagePipe(this.http);\r\n    return secureIMG.transform(url);\r\n  }\r\n\r\n  /**\r\n   * Get all the legend in a single image\r\n   * * @param  format - Image format. default value to \"png\"\r\n   * @return The image of the legend\r\n   */\r\n  async getLayersLegendImage(\r\n    map,\r\n    format: string = 'png',\r\n    doZipFile: boolean,\r\n    resolution: number\r\n  ) {\r\n    const status$ = new Subject();\r\n    // Get html code for the legend\r\n    const width = 200; // milimeters unit, originally define for document pdf\r\n    let html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    format = format.toLowerCase();\r\n\r\n    // If no legend show No LEGEND in an image\r\n    if (html.length === 0) {\r\n      html = '<font size=\"12\" face=\"Courier New\" >';\r\n      html += '<div align=\"center\"><b>NO LEGEND</b></div>';\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      let status = SubjectStatus.Done;\r\n      try {\r\n        if (!doZipFile) {\r\n          // Save the canvas as file\r\n          this.saveCanvasImageAsFile(canvas, 'legendImage', format);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(canvas, 'legendImage' + '.' + format);\r\n        }\r\n        div.parentNode.removeChild(div); // remove temp div (IE)\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n      status$.next(status);\r\n    }\r\n\r\n    return status$;\r\n  }\r\n\r\n  getTitleSize(title: string, pageWidth: number, pageHeight: number, doc: jspdf) {\r\n    const pdfResolution = 96;\r\n    const titleSize = Math.round(2 * (pageHeight + 145) * 0.05) / 2;\r\n    doc.setFont('Times', 'bold');\r\n    const width = doc.getTextWidth(title);\r\n\r\n    const titleWidth = doc.getStringUnitWidth(title) * titleSize / doc.internal.scaleFactor;\r\n    const titleTailleMinimale = Math.round( 2 * (pageHeight + 150 ) * 0.037) / 2;\r\n    let titleFontSize = 0;\r\n\r\n    let titleMarginLeft;\r\n    if (titleWidth >= (pageWidth)) {\r\n      titleMarginLeft = 0;\r\n      titleFontSize = Math.round(((pageWidth / title.length) * pdfResolution) / 25.4);\r\n      // If the formula to find the font size gives below the defined minimum size\r\n      if (titleFontSize < titleTailleMinimale) {\r\n        titleFontSize = titleTailleMinimale;\r\n      }\r\n    } else {\r\n      titleMarginLeft = (pageWidth - titleWidth) / 2 ;\r\n      titleFontSize = titleSize;\r\n    }\r\n    return [titleFontSize, titleMarginLeft];\r\n  }\r\n\r\n  getSubTitleSize(subtitle: string, pageWidth: number, pageHeight: number, doc: jspdf) {\r\n    const subtitleSize = 0.7 * Math.round(2 * (pageHeight + 145) * 0.05) / 2; // 70% of the title's font size\r\n\r\n    doc.setFont('Times', 'bold');\r\n\r\n    const subtitleWidth = doc.getStringUnitWidth(subtitle) * subtitleSize / doc.internal.scaleFactor;\r\n\r\n    let subtitleMarginLeft;\r\n    if (subtitleWidth >= (pageWidth)) {\r\n      subtitleMarginLeft = 0;\r\n    } else {\r\n      subtitleMarginLeft = (pageWidth - subtitleWidth) / 2 ;\r\n    }\r\n    return subtitleMarginLeft;\r\n  }\r\n\r\n  private addTitle(doc: jspdf, title: string, titleFontSize: number, titleMarginLeft: number, titleMarginTop: number) {\r\n    doc.setFont('Times', 'bold');\r\n    doc.setFontSize(titleFontSize);\r\n    doc.text(title, titleMarginLeft, titleMarginTop);\r\n  }\r\n\r\n  private addSubTitle(doc: jspdf, subtitle: string, subtitleFontSize: number, subtitleMarginLeft: number, subtitleMarginTop: number) {\r\n    doc.setFont('Times', 'bold');\r\n    doc.setFontSize(subtitleFontSize);\r\n    doc.text(subtitle, subtitleMarginLeft, subtitleMarginTop);\r\n  }\r\n  /**\r\n   * Add comment to the document\r\n   * * @param  doc - pdf document\r\n   * * @param  comment - Comment to add in the document\r\n   * * @param  size - Size of the document\r\n   */\r\n  private addComment(doc: jspdf, comment: string) {\r\n    const commentSize = 16;\r\n    const commentMarginLeft = 20;\r\n    const marginBottom = 5;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    doc.setFont('courier');\r\n    doc.setFontSize(commentSize);\r\n    doc.text(comment, commentMarginLeft, heightPixels);\r\n  }\r\n  /**\r\n   * Add projection and/or scale to the document\r\n   * @param  doc - pdf document\r\n   * @param  map - Map of the app\r\n   * @param  dpi - DPI resolution of the document\r\n   * @param  projection - Bool to indicate if projection need to be added\r\n   * @param  scale - Bool to indicate if scale need to be added\r\n   */\r\n  private addProjScale(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    dpi: number,\r\n    projection: boolean,\r\n    scale: boolean\r\n  ) {\r\n    const translate = this.languageService.translate;\r\n    const projScaleSize = 16;\r\n    const projScaleMarginLeft = 20;\r\n    const marginBottom = 15;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    let textProjScale: string = '';\r\n    if (projection === true) {\r\n      const projText = translate.instant('igo.geo.printForm.projection');\r\n      textProjScale += projText + ': ' + map.projection;\r\n    }\r\n    if (scale === true) {\r\n      if (projection === true) {\r\n        textProjScale += '   ';\r\n      }\r\n      const scaleText = translate.instant('igo.geo.printForm.scale');\r\n      const mapScale = map.viewController.getScale(dpi);\r\n      textProjScale += scaleText + ': ~ 1 / ' + formatScale(mapScale);\r\n    }\r\n    doc.setFont('courier');\r\n    doc.setFontSize(projScaleSize);\r\n    doc.text(textProjScale, projScaleMarginLeft, heightPixels);\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addLegend(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>,\r\n    resolution: number\r\n  ) {\r\n    // Get html code for the legend\r\n    const width = doc.internal.pageSize.width;\r\n    const html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    // If no legend, save the map directly\r\n    if (html === '') {\r\n      await this.saveDoc(doc);\r\n      return true;\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      const pourcentageReduction = 0.85;\r\n      const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution, pourcentageReduction\r\n        * (25.4 * canvas.height) / resolution];\r\n      let imgData;\r\n      doc.addPage();\r\n      imgData = canvas.toDataURL('image/png');\r\n      doc.addImage(imgData, 'PNG', 10, 10, imageSize[0], imageSize[1]);\r\n      div.parentNode.removeChild(div); // remove temp div (IE style)\r\n    }\r\n\r\n    await this.saveDoc(doc);\r\n\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n     private async addLegendSamePage(\r\n      doc: jspdf,\r\n      map: IgoMap,\r\n      margins: Array<number>,\r\n      resolution: number,\r\n      legendPosition: string\r\n    ) {\r\n      // Get html code for the legend\r\n      const width = doc.internal.pageSize.width;\r\n      const html = await this.getLayersLegendHtml(\r\n        map,\r\n        width,\r\n        resolution\r\n      ).toPromise();\r\n      // If no legend, save the map directly\r\n      if (html === '') {\r\n        await this.saveDoc(doc);\r\n        return true;\r\n      }\r\n      // Create div to contain html code for legend\r\n      const div = window.document.createElement('div');\r\n      div.style.position = 'absolute';\r\n      div.style.top = '0';\r\n      // Add html code to convert in the new window\r\n      window.document.body.appendChild(div);\r\n      div.innerHTML = html;\r\n      await this.timeout(1);\r\n      const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n        console.log(e);\r\n      });\r\n      let marginsLegend;\r\n      if (canvas) {\r\n        const pourcentageReduction = 0.85;\r\n        const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution,\r\n           pourcentageReduction * (25.4 * canvas.height) / resolution];\r\n        // Move the legend to the correct position on the page\r\n        if ( legendPosition === 'bottomright') {\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1], margins[1],\r\n           margins[2], doc.internal.pageSize.width - margins[1] - imageSize[0]];\r\n        } else if (legendPosition === 'topright') {\r\n          marginsLegend = [margins[0], margins[1], doc.internal.pageSize.height - margins[0] - imageSize[1],\r\n          doc.internal.pageSize.width - margins[1] - imageSize[0] ];\r\n        } else if (legendPosition === 'bottomleft') {\r\n          // When the legend is in the bottom left, raise the legend slightly upward so that attributions are visible\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1] - 15,\r\n          doc.internal.pageSize.width - margins[3] - imageSize[0], margins[2] + 15, margins[3] ];\r\n        } else if (legendPosition === 'topleft') {\r\n          marginsLegend = [margins[0], doc.internal.pageSize.width - margins[3] - imageSize[0],\r\n           doc.internal.pageSize.height - margins[0] - imageSize[1], margins[3] ];\r\n        }\r\n        this.addCanvas(doc, canvas, marginsLegend); // this adds the legend\r\n        div.parentNode.removeChild(div); // remove temp div (IE style)\r\n        await this.saveDoc(doc);\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Add scale and attributions on the map on the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addScale(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n    ) {\r\n      const mapSize = map.ol.getSize();\r\n      const extent = map.ol.getView().calculateExtent(mapSize);\r\n      // Get the scale and attribution\r\n      // we use cloneNode to modify the nodes to print without modifying it on the page, using deep:true to get children\r\n      let canvasOverlayHTML;\r\n      const mapOverlayHTML = map.ol.getOverlayContainerStopEvent();\r\n      // Remove the UI buttons from the nodes\r\n      const OverlayHTMLButtons = mapOverlayHTML.getElementsByTagName('button');\r\n      const OverlayHTMLButtonsarr = Array.from(OverlayHTMLButtons);\r\n      for (const OverlayHTMLButton of OverlayHTMLButtonsarr) {\r\n        OverlayHTMLButton.setAttribute('data-html2canvas-ignore', 'true');\r\n      }\r\n      // Change the styles of hyperlink in the printed version\r\n      // Transform the Overlay into a canvas\r\n      // scale is necessary to make it in google chrome\r\n      // background as null because otherwise it is white and cover the map\r\n      // allowtaint is to allow rendering images in the attributions\r\n      // useCORS: true pour permettre de renderer les images (ne marche pas en local)\r\n      const canvas = await html2canvas(mapOverlayHTML, {\r\n        scale: 1,\r\n        backgroundColor: null,\r\n        allowTaint: true,\r\n        useCORS: true,\r\n      }).then( e => {\r\n        canvasOverlayHTML = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTML, margins); // this adds scales and attributions\r\n }\r\n\r\n  defineNbFileToProcess(nbFileToProcess) {\r\n    this.nbFileToProcess = nbFileToProcess;\r\n  }\r\n\r\n  private timeout(ms) {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n\r\n  private addCanvas(\r\n    doc: jspdf,\r\n    canvas: HTMLCanvasElement,\r\n    margins: Array<number>\r\n  ) {\r\n    let image;\r\n    if (canvas) {\r\n      image = canvas.toDataURL('image/png');\r\n    }\r\n\r\n    if (image !== undefined) {\r\n      const imageSize = this.getImageSizeToFitPdf(doc, canvas, margins);\r\n      doc.addImage(\r\n        image,\r\n        'PNG',\r\n        margins[3],\r\n        margins[0],\r\n        imageSize[0],\r\n        imageSize[1]\r\n      );\r\n      doc.rect(margins[3], margins[0], imageSize[0], imageSize[1]);\r\n    }\r\n  }\r\n\r\n  // TODO fix printing with image resolution\r\n  private addMap(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    resolution: number,\r\n    size: Array<number>,\r\n    margins: Array<number>\r\n  ) {\r\n    const status$ = new Subject();\r\n\r\n    const mapSize = map.ol.getSize();\r\n    const extent = map.ol.getView().calculateExtent(mapSize);\r\n\r\n    const widthPixels = Math.round((size[0] * resolution) / 25.4);\r\n    const heightPixels = Math.round((size[1] * resolution) / 25.4);\r\n\r\n    let timeout;\r\n\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      const canvases = event.target.getViewport().getElementsByTagName('canvas');\r\n      const mapStatus$$ = map.status$.subscribe((mapStatus: SubjectStatus) => {\r\n        clearTimeout(timeout);\r\n\r\n        if (mapStatus !== SubjectStatus.Done) {\r\n          return;\r\n        }\r\n\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            )\r\n          );\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      });\r\n\r\n      // If no loading as started after 200ms, then probably no loading\r\n      // is required.\r\n      timeout = window.setTimeout(() => {\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            )\r\n          );\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      }, 200);\r\n    });\r\n\r\n    this.renderMap(map, [widthPixels, heightPixels], extent);\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Download an image of the map with addition of informations\r\n   * @param  map - Map of the app\r\n   * @param  format - Image format. default value to \"png\"\r\n   * @param  projection - Indicate if projection need to be add. Default to false\r\n   * @param  scale - Indicate if scale need to be add. Default to false\r\n   * @param  legend - Indicate if the legend of layers need to be download. Default to false\r\n   * @param  title - Title to add for the map - Default to blank\r\n   * @param  subtitle - Subtitle to add for the map - Default to blank\r\n   * @param  comment - Comment to add for the map - Default to blank\r\n   * @param  doZipFile - Indicate if we do a zip with the file\r\n   * @return Image file of the map with extension format given as parameter\r\n   */\r\n  downloadMapImage(\r\n    map: IgoMap,\r\n    resolution: number,\r\n    format = 'png',\r\n    projection = false,\r\n    scale = false,\r\n    legend = false,\r\n    title = '',\r\n    subtitle = '',\r\n    comment = '',\r\n    doZipFile = true\r\n  ) {\r\n    const status$ = new Subject();\r\n    // const resolution = map.ol.getView().getResolution();\r\n    this.activityId = this.activityService.register();\r\n    const translate = this.languageService.translate;\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      format = format.toLowerCase();\r\n      const oldCanvas = event.target\r\n        .getViewport()\r\n        .getElementsByTagName('canvas')[0];\r\n      const newCanvas = document.createElement('canvas');\r\n      const newContext = newCanvas.getContext('2d');\r\n      // Postion in height to set the canvas in new canvas\r\n      let positionHCanvas = 0;\r\n      // Position in width to set the Proj/Scale in new canvas\r\n      let positionWProjScale = 10;\r\n      // Get height/width of map canvas\r\n      const width = oldCanvas.width;\r\n      let height = oldCanvas.height;\r\n      // Set Font to calculate comment width\r\n      newContext.font = '20px Calibri';\r\n      const commentWidth = newContext.measureText(comment).width;\r\n      // Add height for title if defined\r\n      height = title !== '' ? height + 30 : height;\r\n      // Add height for title if defined\r\n      height = subtitle !== '' ? height + 30 : height;\r\n      // Add height for projection or scale (same line) if defined\r\n      height = projection !== false || scale !== false ? height + 30 : height;\r\n      const positionHProjScale = height - 10;\r\n      // Define number of line depending of the comment length\r\n      const commentNbLine = Math.ceil(commentWidth / width);\r\n      // Add height for multiline comment if defined\r\n      height = comment !== '' ? height + commentNbLine * 30 : height;\r\n      let positionHComment = height - commentNbLine * 20 + 5;\r\n      // Set the new canvas with the new calculated size\r\n      newCanvas.width = width;\r\n      newCanvas.height = height;\r\n      // Patch Jpeg default black background to white\r\n      if (format === 'jpeg') {\r\n        newContext.fillStyle = '#ffffff';\r\n        newContext.fillRect(0, 0, width, height);\r\n        newContext.fillStyle = '#000000';\r\n      }\r\n      // If a title need to be added to canvas\r\n      if (title !== '') {\r\n        // Set font for title\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 30;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(title, width / 2, 20, width * 0.9);\r\n      }\r\n      if (subtitle !== '') {\r\n        // Set font for subtitle\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 60;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(subtitle, width / 2, 50, width * 0.9);\r\n      }\r\n      // Set font for next section\r\n      newContext.font = '20px Calibri';\r\n      // If projection need to be added to canvas\r\n      if (projection !== false) {\r\n        const projText = translate.instant('igo.geo.printForm.projection');\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          projText + ': ' + map.projection,\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n        positionWProjScale += 200; // Width position change for scale position\r\n      }\r\n\r\n      // If scale need to be added to canvas\r\n      if (scale !== false) {\r\n        const scaleText = translate.instant('igo.geo.printForm.scale');\r\n        const mapScale = map.viewController.getScale(resolution);\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          scaleText + ': ~ 1 / ' + formatScale(mapScale),\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n      }\r\n      // If a comment need to be added to canvas\r\n      if (comment !== '') {\r\n        newContext.textAlign = 'center';\r\n        // If only one line, no need to multiline the comment\r\n        if (commentNbLine === 1) {\r\n          newContext.fillText(comment, width / 2, positionHComment);\r\n        } else {\r\n          // Separate the setenses to be approx. the same length\r\n          const nbCommentChar = comment.length;\r\n          const CommentLengthToCut = Math.floor(nbCommentChar / commentNbLine);\r\n          let commentCurrentLine = '';\r\n          let positionFirstCutChar = 0;\r\n          let positionLastBlank;\r\n          // Loop for the number of line calculated\r\n          for (let i = 0; i < commentNbLine; i++) {\r\n            // For all line except last\r\n            if (commentNbLine - 1 > i) {\r\n              // Get comment current line to find the right place tu cut comment\r\n              commentCurrentLine = comment.substr(\r\n                positionFirstCutChar,\r\n                CommentLengthToCut\r\n              );\r\n              // Cut the setence at blank\r\n              positionLastBlank = commentCurrentLine.lastIndexOf(' ');\r\n              newContext.fillText(\r\n                commentCurrentLine.substr(0, positionLastBlank),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n              positionFirstCutChar += positionLastBlank;\r\n              // Go to next line for insertion\r\n              positionHComment += 20;\r\n            } else {\r\n              // Don't cut last part\r\n              newContext.fillText(\r\n                comment.substr(positionFirstCutChar),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add map to new canvas\r\n      newContext.drawImage(oldCanvas, 0, positionHCanvas);\r\n\r\n      let status = SubjectStatus.Done;\r\n      try {\r\n        // Save the canvas as file\r\n        if (!doZipFile) {\r\n          this.saveCanvasImageAsFile(newCanvas, 'map', format);\r\n        } else if (format.toLowerCase() === 'tiff') {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(\r\n            newCanvas,\r\n            'map' + map.projection.replace(':', '_') + '.' + format\r\n          );\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, 'map' + '.' + format);\r\n        }\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n\r\n      status$.next(status);\r\n\r\n      if (format.toLowerCase() === 'tiff') {\r\n        const tiwContent = this.getWorldFileInformation(map);\r\n        const blob = new Blob([tiwContent], {\r\n          type: 'text/plain;charset=utf-8'\r\n        });\r\n        if (!doZipFile) {\r\n          // saveAs automaticly replace ':' for '_'\r\n          saveAs(blob, 'map' + map.projection + '.tfw');\r\n          this.saveFileProcessing();\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.addFileToZip(\r\n            'map' + map.projection.replace(':', '_') + '.tfw',\r\n            blob\r\n          );\r\n        }\r\n      }\r\n    });\r\n    map.ol.renderSync();\r\n\r\n    return status$;\r\n  }\r\n\r\n  private renderMap(map, size, extent) {\r\n    map.ol.updateSize();\r\n    map.ol.renderSync();\r\n  }\r\n\r\n  /**\r\n   * Save document\r\n   * @param  doc - Document to save\r\n   */\r\n  protected async saveDoc(doc: jspdf) {\r\n    await doc.save('map.pdf', { returnPromise: true });\r\n  }\r\n\r\n  /**\r\n   * Calculate the best Image size to fit in pdf\r\n   * @param doc - Pdf Document\r\n   * @param canvas - Canvas of image\r\n   * @param margins - Page margins\r\n   */\r\n  private getImageSizeToFitPdf(doc, canvas, margins) {\r\n    // Define variable to calculate best size to fit in one page\r\n    const pageHeight =\r\n      doc.internal.pageSize.getHeight() - (margins[0] + margins[2]);\r\n    const pageWidth =\r\n      doc.internal.pageSize.getWidth() - (margins[1] + margins[3]);\r\n    const canHeight = canvas.height;\r\n    const canWidth = canvas.width;\r\n    const heightRatio = canHeight / pageHeight;\r\n    const widthRatio = canWidth / pageWidth;\r\n    const maxRatio = heightRatio > widthRatio ? heightRatio : widthRatio;\r\n    const imgHeigh = maxRatio > 1 ? canHeight / maxRatio : canHeight;\r\n    const imgWidth = maxRatio > 1 ? canWidth / maxRatio : canWidth;\r\n\r\n    return [imgWidth, imgHeigh];\r\n  }\r\n\r\n  /**\r\n   * Get a world file information for tiff\r\n   * @param  map - Map of the app\r\n   */\r\n  private getWorldFileInformation(map) {\r\n    const currentResolution = map.viewController.getResolution();\r\n    const currentExtent = map.viewController.getExtent(); // Return [minx, miny, maxx, maxy]\r\n    return [\r\n      currentResolution,\r\n      0,\r\n      0,\r\n      -currentResolution,\r\n      currentExtent[0] + currentResolution / 0.5,\r\n      currentExtent[3] - currentResolution / 0.5\r\n    ].join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Save canvas image as file\r\n   * @param canvas - Canvas to save\r\n   * @param name - Name of the file\r\n   * @param format - file format\r\n   */\r\n  private saveCanvasImageAsFile(canvas, name, format) {\r\n    const blobFormat = 'image/' + format;\r\n    const that = this;\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      // If navigator is Internet Explorer\r\n      if (navigator.msSaveBlob) {\r\n        navigator.msSaveBlob(canvas.msToBlob(), name + '.' + format);\r\n        this.saveFileProcessing();\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          // download image\r\n          saveAs(blob, name + '.' + format);\r\n          that.saveFileProcessing();\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to a zip\r\n   * @param canvas - File to add to the zip\r\n   * @param  name -Name of the fileoverview\r\n   */\r\n  private generateCanvaFileToZip(canvas, name) {\r\n    const blobFormat = 'image/' + 'jpeg';\r\n    const that = this;\r\n    if (\r\n      !this.hasOwnProperty('zipFile') ||\r\n      typeof this.zipFile === 'undefined'\r\n    ) {\r\n      this.zipFile = new JSZip();\r\n    }\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      if (navigator.msSaveBlob) {\r\n        this.addFileToZip(name, canvas.msToBlob());\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          that.addFileToZip(name, blob);\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to zip, if all file are zipped, download\r\n   * @param name - Name of the files\r\n   * @param blob - Contain of file\r\n   */\r\n  private addFileToZip(name, blob) {\r\n    // add file to zip\r\n    this.zipFile.file(name, blob);\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Download zip file\r\n      this.getZipFile();\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  private saveFileProcessing() {\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the zipped file\r\n   * @return Retun a zip file\r\n   */\r\n  private getZipFile() {\r\n    const that = this;\r\n    this.zipFile.generateAsync({ type: 'blob' }).then((blob) => {\r\n      // 1) generate the zip file\r\n      saveAs(blob, 'map.zip');\r\n      delete that.zipFile;\r\n    });\r\n  }\r\n}\r\n","import { Layer } from '../shared/layers/layer';\r\nimport { LegendMapViewOptions, OutputLayerLegend } from '../shared/layers/layer.interface';\r\n\r\n/**\r\n * Get all the layers legend\r\n * @return Array of legend\r\n */\r\nexport function getLayersLegends(layers: Layer[], view?: LegendMapViewOptions): OutputLayerLegend[] {\r\n  const legends = [];\r\n\r\n  for (const layer of layers) {\r\n    if (layer.visible === false) { continue; }\r\n\r\n    const legendUrls = layer.dataSource.getLegend(undefined, view) || [];\r\n    for (const legendUrl of legendUrls) {\r\n      if (legendUrl.url === undefined) { continue; }\r\n\r\n      // Add legend info to the list\r\n      legends.push({\r\n        title: layer.title,\r\n        url: legendUrl.url\r\n      });\r\n    }\r\n  }\r\n\r\n  return legends;\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const PrintOutputFormat = strEnum(['Pdf', 'Image']);\r\n\r\nexport type PrintOutputFormat = keyof typeof PrintOutputFormat;\r\n\r\nexport const PrintPaperFormat = strEnum([\r\n  'A0',\r\n  'A1',\r\n  'A2',\r\n  'A3',\r\n  'A4',\r\n  'A5',\r\n  'Letter',\r\n  'Legal'\r\n]);\r\nexport type PrintPaperFormat = keyof typeof PrintPaperFormat;\r\n\r\nexport const PrintOrientation = strEnum(['landscape', 'portrait']);\r\nexport type PrintOrientation = keyof typeof PrintOrientation;\r\n\r\nexport const PrintResolution = strEnum(['72', '96', '150', '300']);\r\nexport type PrintResolution = keyof typeof PrintResolution;\r\n\r\nexport const PrintSaveImageFormat = strEnum([\r\n  'Bmp',\r\n  'Gif',\r\n  'Jpeg',\r\n  'Png',\r\n  'Tiff'\r\n]);\r\nexport type PrintSaveImageFormat = keyof typeof PrintSaveImageFormat;\r\n\r\nexport const PrintLegendPosition = strEnum([\r\n  'none',\r\n  'topright',\r\n  'topleft',\r\n  'bottomleft',\r\n  'bottomright',\r\n  'newpage'\r\n]);\r\nexport type PrintLegendPosition = keyof typeof PrintLegendPosition;\r\n","<form class=\"igo-form\" [formGroup]=\"form\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"title\"\r\n        placeholder=\"{{'igo.geo.printForm.title' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"subtitle\"\r\n        placeholder=\"{{'igo.geo.printForm.subtitle' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"comment\"\r\n        placeholder=\"{{'igo.geo.printForm.comment' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <div class=\"print-slide-toggle-container mat-typography\">\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showProjection\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showProjection' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showScale\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showScale' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"doZipFile\"\r\n        [labelPosition]=\"'before'\"\r\n        [style.display]=\"isPrintService ? 'none' : ''\">\r\n        {{'igo.geo.printForm.doZipFile' | translate}}\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"legendPosition\"\r\n        placeholder=\"{{'igo.geo.printForm.legendPosition' | translate}}\">\r\n        <mat-option *ngFor=\"let legendPosition of legendPositions | keyvalue \" [value]=\"legendPosition.key\">\r\n            {{'igo.geo.printForm.legendPositions.' + legendPosition.value | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select (selectionChange)=\"toggleImageSaveProp()\"\r\n        formControlName=\"outputFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.outputFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let outputFormat of outputFormats | keyvalue \" [value]=\"outputFormat.key\">\r\n            {{outputFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"paperFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.paperFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let paperFormat of paperFormats | keyvalue \" [value]=\"paperFormat.key\">\r\n          {{('igo.geo.printForm.paperFormats.' + paperFormat.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'none' : 'block'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"imageFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.imageFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let imageFormat of imageFormats | keyvalue \" [value]=\"imageFormat.key\">\r\n          {{imageFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" style=\"display: none;\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"resolution\"\r\n        placeholder=\"{{'igo.geo.printForm.resolution' | translate}}\">\r\n        <mat-option *ngFor=\"let resolution of resolutions | keyvalue \" [value]=\"resolution.key\">\r\n          {{resolution.value + ' PPI'}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"orientation\"\r\n        placeholder=\"{{'igo.geo.printForm.orientation' | translate}}\">\r\n        <mat-option *ngFor=\"let orientation of orientations | keyvalue \" [value]=\"orientation.key\">\r\n          {{('igo.geo.printForm.' + orientation.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group print-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (disabled$ | async)\"\r\n      (click)=\"handleFormSubmit(form.value, form.valid)\">\r\n      {{'igo.geo.printForm.saveBtn' | translate}}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n","import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';\r\nimport {\r\n  FormGroup,\r\n  FormBuilder,\r\n  FormControl,\r\n  Validators\r\n} from '@angular/forms';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\n@Component({\r\n  selector: 'igo-print-form',\r\n  templateUrl: './print-form.component.html',\r\n  styleUrls: ['./print-form.component.scss']\r\n})\r\nexport class PrintFormComponent implements OnInit {\r\n  public form: FormGroup;\r\n  public outputFormats = PrintOutputFormat;\r\n  public paperFormats = PrintPaperFormat;\r\n  public orientations = PrintOrientation;\r\n  public resolutions = PrintResolution;\r\n  public imageFormats = PrintSaveImageFormat;\r\n  public legendPositions = PrintLegendPosition;\r\n  public isPrintService = true;\r\n\r\n  @Input() disabled$: BehaviorSubject<boolean>;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this.imageFormatField.value;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this.imageFormatField.setValue(value || PrintSaveImageFormat.Jpeg, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this.outputFormatField.value;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this.outputFormatField.setValue(value || PrintOutputFormat.Pdf, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this.paperFormatField.value;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this.paperFormatField.setValue(value || PrintPaperFormat.Letter, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this.orientationField.value;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this.orientationField.setValue(value || PrintOrientation.landscape, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this.resolutionField.value;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this.resolutionField.setValue(value || PrintResolution['96'], {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this.legendPositionField.value;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this.legendPositionField.setValue(value || PrintLegendPosition.none, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get title(): string {\r\n    return this.titleField.value;\r\n  }\r\n  set title(value: string) {\r\n    this.titleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get subtitle(): string {\r\n    return this.subtitleField.value;\r\n  }\r\n  set subtitle(value: string) {\r\n    this.subtitleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get comment(): string {\r\n    return this.commentField.value;\r\n  }\r\n  set comment(value: string) {\r\n    this.commentField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showProjection(): boolean {\r\n    return this.showProjectionField.value;\r\n  }\r\n  set showProjection(value: boolean) {\r\n    this.showProjectionField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showScale(): boolean {\r\n    return this.showScaleField.value;\r\n  }\r\n  set showScale(value: boolean) {\r\n    this.showScaleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showLegend(): boolean {\r\n    return this.showLegendField.value;\r\n  }\r\n  set showLegend(value: boolean) {\r\n    this.showLegendField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  @Input()\r\n  get doZipFile(): boolean {\r\n    return this.doZipFileField.value;\r\n  }\r\n  set doZipFile(value: boolean) {\r\n    this.doZipFileField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  get outputFormatField() {\r\n    return (this.form.controls as any).outputFormat as FormControl;\r\n  }\r\n\r\n  get paperFormatField() {\r\n    return (this.form.controls as any).paperFormat as FormControl;\r\n  }\r\n\r\n  get imageFormatField() {\r\n    return (this.form.controls as any).imageFormat as FormControl;\r\n  }\r\n\r\n  get orientationField() {\r\n    return (this.form.controls as any).orientation as FormControl;\r\n  }\r\n\r\n  get resolutionField() {\r\n    return (this.form.controls as any).resolution as FormControl;\r\n  }\r\n\r\n  get commentField() {\r\n    return (this.form.controls as any).comment as FormControl;\r\n  }\r\n\r\n  get showProjectionField() {\r\n    return (this.form.controls as any).showProjection as FormControl;\r\n  }\r\n\r\n  get showScaleField() {\r\n    return (this.form.controls as any).showScale as FormControl;\r\n  }\r\n\r\n  get showLegendField() {\r\n    return (this.form.controls as any).showLegend as FormControl;\r\n  }\r\n\r\n  get doZipFileField() {\r\n    return (this.form.controls as any).doZipFile as FormControl;\r\n  }\r\n\r\n  get titleField() {\r\n    return (this.form.controls as any).title as FormControl;\r\n  }\r\n\r\n  get subtitleField() {\r\n    return (this.form.controls as any).subtitle as FormControl;\r\n  }\r\n\r\n  get legendPositionField() {\r\n    return (this.form.controls as any).legendPosition as FormControl;\r\n  }\r\n\r\n  @Output() submit: EventEmitter<PrintOptions> = new EventEmitter();\r\n\r\n  constructor(private formBuilder: FormBuilder) {\r\n    this.form = this.formBuilder.group({\r\n      title: ['', []],\r\n      subtitle: ['', []],\r\n      comment: ['', []],\r\n      outputFormat: ['', [Validators.required]],\r\n      paperFormat: ['', [Validators.required]],\r\n      imageFormat: [ '', [Validators.required]],\r\n      resolution: ['', [Validators.required]],\r\n      orientation: ['', [Validators.required]],\r\n      legendPosition: ['', [Validators.required]],\r\n      showProjection: false,\r\n      showScale: false,\r\n      showLegend: false,\r\n      doZipFile: [{hidden: this.isPrintService }]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.doZipFileField.setValue(false);\r\n  }\r\n\r\n  handleFormSubmit(data: PrintOptions, isValid: boolean) {\r\n    data.isPrintService = this.isPrintService;\r\n    if (isValid) {\r\n      this.submit.emit(data);\r\n    }\r\n  }\r\n\r\n  toggleImageSaveProp() {\r\n    if (this.outputFormatField.value === 'Image') {\r\n      this.isPrintService = false;\r\n    } else {\r\n      this.isPrintService = true;\r\n    }\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\nimport { PrintService } from '../shared/print.service';\r\n\r\n@Component({\r\n  selector: 'igo-print',\r\n  templateUrl: './print.component.html'\r\n})\r\nexport class PrintComponent {\r\n  public disabled$ = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this._outputFormat;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this._outputFormat = value;\r\n  }\r\n  private _outputFormat: PrintOutputFormat;\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this._paperFormat;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this._paperFormat = value;\r\n  }\r\n  private _paperFormat: PrintPaperFormat;\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this._orientation;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this._orientation = value;\r\n  }\r\n  private _orientation: PrintOrientation;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this._imageFormat;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this._imageFormat = value;\r\n  }\r\n  private _imageFormat: PrintSaveImageFormat;\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this._legendPosition;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this._legendPosition = value;\r\n  }\r\n  private _legendPosition: PrintLegendPosition;\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this._resolution;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this._resolution = value;\r\n  }\r\n  private _resolution: PrintResolution;\r\n\r\n  constructor(private printService: PrintService) {}\r\n\r\n  handleFormSubmit(data: PrintOptions) {\r\n\r\n    this.disabled$.next(true);\r\n\r\n    if (data.isPrintService === true) {\r\n      this.printService\r\n        .print(this.map, data)\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          this.disabled$.next(false);\r\n        });\r\n    } else {\r\n      let nbFileToProcess = 1;\r\n\r\n      if (data.showLegend) {\r\n        nbFileToProcess++;\r\n      }\r\n      if (data.imageFormat.toLowerCase() === 'tiff') {\r\n        nbFileToProcess++;\r\n      }\r\n\r\n      this.printService.defineNbFileToProcess(nbFileToProcess);\r\n\r\n      const resolution = +data.resolution;\r\n\r\n      let nbRequests = data.showLegend ? 2 : 1;\r\n      this.printService\r\n        .downloadMapImage(\r\n          this.map,\r\n          resolution,\r\n          data.imageFormat,\r\n          data.showProjection,\r\n          data.showScale,\r\n          data.showLegend,\r\n          data.title,\r\n          data.subtitle,\r\n          data.comment,\r\n          data.doZipFile\r\n        )\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          nbRequests--;\r\n          if (!nbRequests) {\r\n            this.disabled$.next(false);\r\n          }\r\n        });\r\n      if (data.showLegend) {\r\n        this.printService\r\n          .getLayersLegendImage(\r\n            this.map,\r\n            data.imageFormat,\r\n            data.doZipFile,\r\n            +resolution\r\n          )\r\n          .then(() => {\r\n            nbRequests--;\r\n            if (!nbRequests) {\r\n              this.disabled$.next(false);\r\n            }\r\n          });\r\n      }\r\n    }\r\n  }\r\n}\r\n","<igo-print-form\r\n  [outputFormat]=\"outputFormat\"\r\n  [paperFormat]=\"paperFormat\"\r\n  [orientation]=\"orientation\"\r\n  [imageFormat]=\"imageFormat\"\r\n  [resolution]=\"resolution\"\r\n  [legendPosition]=\"legendPosition\"\r\n  [disabled$]=\"disabled$\"\r\n  (submit)=\"handleFormSubmit($event)\">\r\n</igo-print-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule } from '@igo2/common';\r\n\r\nimport { PrintComponent } from './print/print.component';\r\nimport { PrintFormComponent } from './print-form/print-form.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule\r\n  ],\r\n  exports: [PrintComponent, PrintFormComponent],\r\n  declarations: [PrintComponent, PrintFormComponent]\r\n})\r\nexport class IgoPrintModule {}\r\n","import { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\n\r\nimport { QuerySearchSource } from './query-search-source';\r\n\r\n/**\r\n * Map search source factory\r\n * @ignore\r\n */\r\nexport function querySearchSourceFactory(config: ConfigService) {\r\n  return new QuerySearchSource(\r\n    config.getConfig(`searchSources.${QuerySearchSource.id}`) || {}\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the map search source\r\n */\r\nexport function provideQuerySearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: querySearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { QueryDirective } from './shared/query.directive';\r\nimport { QueryService } from './shared/query.service';\r\nimport { provideQuerySearchSource } from './shared/query-search-source.providers';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  exports: [QueryDirective],\r\n  declarations: [QueryDirective],\r\n  providers: [QueryService]\r\n})\r\nexport class IgoQueryModule {\r\n  static forRoot(): ModuleWithProviders<IgoQueryModule> {\r\n    return {\r\n      ngModule: IgoQueryModule,\r\n      providers: [provideQuerySearchSource()]\r\n    };\r\n  }\r\n}\r\n","import { DirectionsSource } from '../directions-sources/directions-source';\r\n\r\nexport class DirectionsSourceService {\r\n  constructor(public sources: DirectionsSource[]) {}\r\n}\r\n\r\nexport function directionsSourceServiceFactory(sources: DirectionsSource[]) {\r\n  return new DirectionsSourceService(sources);\r\n}\r\n\r\nexport function provideDirectionsSourceService() {\r\n  return {\r\n    provide: DirectionsSourceService,\r\n    useFactory: directionsSourceServiceFactory,\r\n    deps: [DirectionsSource]\r\n  };\r\n}\r\n","export enum DirectionsFormat {\r\n  GeoJSON,\r\n  JSON\r\n}\r\nexport enum SourceDirectionsType {\r\n  Route = 'route',\r\n  Trip = 'trip'\r\n}\r\n\r\nexport enum ProposalType {\r\n  Coord = 'coord',\r\n  Text = 'text'\r\n}\r\n\r\nexport enum DirectionType {\r\n  Stop = 'stop',\r\n  Route = 'route',\r\n  Vertex = 'vertex'\r\n}\r\n\r\nexport enum DirectionRelativePositionType {\r\n  Start = 'start',\r\n  Intermediate = 'intermediate',\r\n  End = 'end'\r\n}\r\n","import olFeature from 'ol/Feature';\r\nimport * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olGeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olProj from 'ol/proj';\r\n\r\nimport { uuid, NumberUtils } from '@igo2/utils';\r\n\r\nimport { Direction, FeatureWithDirection, FeatureWithStop, Stop } from './directions.interface';\r\nimport { createOverlayMarkerStyle } from '../../overlay/shared/overlay-marker-style.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { tryAddLoadingStrategy } from '../../feature/shared/strategies.utils';\r\nimport { FeatureStoreLoadingStrategy } from '../../feature/shared/strategies/loading';\r\nimport { FEATURE, FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { DirectionRelativePositionType, DirectionType } from './directions.enum';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './store';\r\n\r\n/**\r\n * Function that updat the sort of the list base on the provided field.\r\n * @param source stop store\r\n * @param direction asc / desc sort order\r\n * @param field the field to use to sort the view\r\n */\r\nexport function updateStoreSorting(stopsStore: StopsStore, direction: 'asc' | 'desc' = 'asc', field = 'position') {\r\n  stopsStore.view.sort({\r\n    direction,\r\n    valueAccessor: (entity: Stop) => entity[field]\r\n  });\r\n}\r\n\r\nexport function computeRelativePosition(index: number, totalLength): DirectionRelativePositionType {\r\n  let relativePosition = DirectionRelativePositionType.Intermediate;\r\n  if (index === 0) {\r\n    relativePosition = DirectionRelativePositionType.Start;\r\n  } else if (index === totalLength - 1) {\r\n    relativePosition = DirectionRelativePositionType.End;\r\n  }\r\n  return relativePosition;\r\n}\r\n\r\nexport function computeStopsPosition(stopsStore: StopsStore) {\r\n\r\n  const stopsToComputePosition = [...stopsStore.all()];\r\n  stopsToComputePosition.sort((a, b) => a.position - b.position);\r\n  stopsToComputePosition.map((stop, i) => {\r\n    stop.position = i;\r\n    stop.relativePosition = computeRelativePosition(stop.position, stopsToComputePosition.length);\r\n  });\r\n  if (stopsToComputePosition) {\r\n    stopsStore.updateMany(stopsToComputePosition);\r\n  }\r\n}\r\n\r\n/**\r\n * Function that add a stop to the stop store. Stop are always added before the last stop.\r\n * @param stopsStore stop store as an EntityStore\r\n */\r\nexport function addStopToStore(stopsStore: StopsStore): Stop {\r\n\r\n  const id = uuid();\r\n  const stops = stopsStore.all();\r\n  let positions: number[];\r\n  if (stopsStore.count === 0) {\r\n    positions = [0];\r\n  } else {\r\n    positions = stops.map(stop => stop.position);\r\n  }\r\n  const maxPosition: number = Math.max(...positions);\r\n  const insertPosition: number = maxPosition;\r\n  const lastPosition: number = maxPosition + 1;\r\n\r\n  const stopToUpdate = stopsStore.all().find(stop => stop.position === maxPosition);\r\n  if (stopToUpdate) {\r\n    stopToUpdate.position = lastPosition;\r\n    stopToUpdate.relativePosition = computeRelativePosition(lastPosition, stopsStore.count + 1);\r\n  }\r\n\r\n  stopsStore.insert({ id, position: insertPosition, relativePosition: computeRelativePosition(insertPosition, stopsStore.count + 1) });\r\n\r\n  updateStoreSorting(stopsStore);\r\n  return stopsStore.get(id);\r\n}\r\n\r\nexport function removeStopFromStore(stopsStore: StopsStore, stop: Stop) {\r\n  stopsStore.delete(stop);\r\n  computeStopsPosition(stopsStore);\r\n}\r\n\r\n/**\r\n * Create a style for the directions stops and routes\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function directionsStyle(\r\n  feature: olFeature<OlGeometry>,\r\n  resolution: number\r\n): olStyle.Style | olStyle.Style[] {\r\n  const vertexStyle = [\r\n    new olStyle.Style({\r\n      geometry: feature.getGeometry(),\r\n      image: new olStyle.Circle({\r\n        radius: 7,\r\n        stroke: new olStyle.Stroke({ color: '#FF0000', width: 3 })\r\n      })\r\n    })\r\n  ];\r\n\r\n  const stopStyle = createOverlayMarkerStyle({\r\n    text: feature.get('stopText'),\r\n    opacity: feature.get('stopOpacity'),\r\n    markerColor: feature.get('stopColor'),\r\n    markerOutlineColor: [255, 255, 255]\r\n  });\r\n\r\n  const routeStyle = [\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(106, 121, 130, ${feature.get('active') ? 0.75 : 0})`, width: 10 })\r\n    }),\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(79, 169, 221, ${feature.get('active') ? 0.75 : 0})`, width: 6 })\r\n    })\r\n  ];\r\n\r\n  if (feature.get('type') === DirectionType.Stop) {\r\n    return stopStyle;\r\n  }\r\n  if (feature.get('type') === 'vertex') {\r\n    return vertexStyle;\r\n  }\r\n  if (feature.get('type') === DirectionType.Route) {\r\n    return routeStyle;\r\n  }\r\n}\r\n\r\nexport function initStopsFeatureStore(stopsFeatureStore: StopsFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stopsLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-stops-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.stopLayer'),\r\n    zIndex: 911,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-stops-layer',\r\n      links: [\r\n        {\r\n          bidirectionnal: false,\r\n          syncedDelete: true,\r\n          linkedIds: ['igo-direction-route-layer'],\r\n          properties: []\r\n        }\r\n      ]\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stopsFeatureStore, stopsLayer);\r\n  stopsFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stopsFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initRoutesFeatureStore(routesFeatureStore: RoutesFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const routeLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-route-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.routeLayer'),\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(routesFeatureStore, routeLayer);\r\n  routesFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(routesFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initStepFeatureStore(stepFeatureStore: StepFeatureStore) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stepLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-step-layer',\r\n    title: '',\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: false,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: false,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stepFeatureStore, stepLayer);\r\n  stepFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stepFeatureStore, loadingStrategy);\r\n}\r\n\r\n\r\nexport function addStopToStopsFeatureStore(\r\n  stop: Stop,\r\n  stopsStore: StopsStore,\r\n  stopsFeatureStore: StopsFeatureStore,\r\n  projection: string,\r\n  languageService: LanguageService) {\r\n  let stopColor;\r\n  let stopText;\r\n\r\n\r\n  switch (stop.relativePosition) {\r\n    case DirectionRelativePositionType.Start:\r\n      stopColor = '#008000';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.start');\r\n      break;\r\n    case DirectionRelativePositionType.End:\r\n      stopColor = '#f64139';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.end');\r\n      break;\r\n    default:\r\n      stopColor = '#ffd700';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.intermediate') + ' #' + stop.position;\r\n      break;\r\n  }\r\n\r\n  const geometry = new olGeom.Point(\r\n    olProj.transform(stop.coordinates, projection, stopsFeatureStore.map.projection)\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: stopsFeatureStore.map.projection,\r\n    dataProjection: stopsFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n  const previousStop = stopsFeatureStore.get(stop.id);\r\n  const previousStopRevision = previousStop ? previousStop.meta.revision : 0;\r\n\r\n  const stopFeatureStore: FeatureWithStop = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: stopsFeatureStore.map.projection,\r\n    properties: {\r\n      id: stop.id,\r\n      type: DirectionType.Stop,\r\n      stopText,\r\n      stopColor,\r\n      stopOpacity: 1,\r\n      stop\r\n    },\r\n    meta: {\r\n      id: stop.id,\r\n      revision: previousStopRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  stopsFeatureStore.update(stopFeatureStore);\r\n}\r\n\r\nexport function addDirectionToRoutesFeatureStore(\r\n  routesFeatureStore: RoutesFeatureStore,\r\n  direction: Direction,\r\n  projection: string,\r\n  active: boolean = false,\r\n  moveToExtent = false) {\r\n  const geom = direction.geometry.coordinates;\r\n  const geometry4326 = new olGeom.LineString(geom);\r\n  const geometry = geometry4326.transform(\r\n    projection,\r\n    routesFeatureStore.map.projection\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: routesFeatureStore.map.projection,\r\n    dataProjection: routesFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n\r\n  const previousRoute = routesFeatureStore.get(direction.id);\r\n  const previousRouteRevision = previousRoute\r\n    ? previousRoute.meta.revision\r\n    : 0;\r\n\r\n  const routeFeatureStore: FeatureWithDirection = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: routesFeatureStore.map.projection,\r\n    properties: {\r\n      id: direction.id,\r\n      type: DirectionType.Route,\r\n      active,\r\n      direction\r\n    },\r\n    meta: {\r\n      id: direction.id,\r\n      revision: previousRouteRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  routesFeatureStore.update(routeFeatureStore);\r\n}\r\n\r\nexport function formatDistance(distance: number): string {\r\n  if (distance === 0) {\r\n    return;\r\n  }\r\n  if (distance >= 100000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 1000, 1) + ' km';\r\n  }\r\n  if (distance >= 10000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  if (distance >= 1000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  return NumberUtils.roundToNDecimal(distance, 0) + ' m';\r\n}\r\n\r\nexport function formatDuration(duration: number): string {\r\n  if (duration >= 3600) {\r\n    const hour = Math.floor(duration / 3600);\r\n    const minute = Math.round((duration / 3600 - hour) * 60);\r\n    if (minute === 60) {\r\n      return hour + 1 + ' h';\r\n    }\r\n    return hour + ' h ' + minute + ' min';\r\n  }\r\n\r\n  if (duration >= 60) {\r\n    return Math.round(duration / 60) + ' min';\r\n  }\r\n  return duration + ' s';\r\n}\r\n\r\nexport function formatInstruction(\r\n  type,\r\n  modifier,\r\n  route,\r\n  direction,\r\n  stepPosition,\r\n  exit,\r\n  languageService: LanguageService,\r\n  lastStep = false\r\n) {\r\n  const translate = languageService.translate;\r\n  let directive;\r\n  let image = 'forward';\r\n  let cssClass = 'rotate-270';\r\n  const translatedDirection = translateBearing(direction, languageService);\r\n  const translatedModifier = translateModifier(modifier, languageService);\r\n  const prefix = modifier === 'straight' ? '' : translate.instant('igo.geo.directions.modifier.prefix');\r\n\r\n  let aggregatedDirection = prefix + translatedModifier;\r\n\r\n\r\n  if (modifier?.search('slight') >= 0) {\r\n    aggregatedDirection = translatedModifier;\r\n  }\r\n\r\n  if (modifier === 'uturn') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-90';\r\n  } else if (modifier === 'sharp right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'slight right') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-290';\r\n  } else if (modifier === 'straight') {\r\n    image = 'forward';\r\n  } else if (modifier === 'slight left') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-250';\r\n  } else if (modifier === 'left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'sharp left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  }\r\n\r\n  if (type === 'turn') {\r\n    if (modifier === 'straight') {\r\n      directive = translate.instant('igo.geo.directions.turn.straight', { route });\r\n    } else if (modifier === 'uturn') {\r\n      directive = translate.instant('igo.geo.directions.turn.uturn', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.turn.else', { route, aggregatedDirection, translatedModifier });\r\n    }\r\n  } else if (type === 'new name') {\r\n    directive = translate.instant('igo.geo.directions.new name', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'depart') {\r\n    directive = translate.instant('igo.geo.directions.depart', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'arrive') {\r\n    if (lastStep) {\r\n      const coma = !translatedModifier ? '' : ', ';\r\n      aggregatedDirection = !translatedModifier ? '' : aggregatedDirection;\r\n      directive = translate.instant('igo.geo.directions.arrive.lastStep', { coma, aggregatedDirection });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.arrive.intermediate', { route });\r\n      image = 'map-marker';\r\n      cssClass = '';\r\n    }\r\n  } else if (type === 'merge') {\r\n    directive = translate.instant('igo.geo.directions.merge', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'on ramp') {\r\n    directive = translate.instant('igo.geo.directions.on ramp', { aggregatedDirection });\r\n  } else if (type === 'off ramp') {\r\n    directive = translate.instant('igo.geo.directions.off ramp', { aggregatedDirection });\r\n  } else if (type === 'fork') {\r\n    if (modifier.search('left') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.left', { route });\r\n    } else if (modifier.search('right') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.right', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.fork.else', { route });\r\n    }\r\n  } else if (type === 'end of road') {\r\n    directive = translate.instant('igo.geo.directions.end of road', { translatedModifier, route });\r\n  } else if (type === 'use lane') {\r\n    directive = translate.instant('igo.geo.directions.use lane');\r\n  } else if (type === 'continue' && modifier !== 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.continue.notUturn', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'roundabout') {\r\n    const cntSuffix = exit === 1 ?\r\n      translate.instant('igo.geo.directions.cntSuffix.first') :\r\n      translate.instant('igo.geo.directions.cntSuffix.secondAndMore');\r\n    directive = translate.instant('igo.geo.directions.roundabout', { exit, cntSuffix, route });\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'rotary') {\r\n    directive = translate.instant('igo.geo.directions.rotary');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'roundabout turn') {\r\n    directive = translate.instant('igo.geo.directions.roundabout turn');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'exit roundabout') {\r\n    directive = translate.instant('igo.geo.directions.exit roundabout', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'notification') {\r\n    directive = translate.instant('igo.geo.directions.notification');\r\n  } else if (modifier === 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.uturnText', { translatedDirection, route });\r\n  } else {\r\n    directive = translate.instant('igo.geo.directions.unknown');\r\n  }\r\n\r\n  image = lastStep ? 'flag-variant' : image;\r\n  cssClass = lastStep ? '' : cssClass;\r\n  image = stepPosition === 0 ? 'compass' : image;\r\n  cssClass = stepPosition === 0 ? '' : cssClass;\r\n\r\n  return { instruction: directive, image, cssClass };\r\n}\r\n\r\nexport function translateModifier(modifier, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (modifier === 'uturn') {\r\n    return translate.instant('igo.geo.directions.uturn');\r\n  } else if (modifier === 'sharp right') {\r\n    return translate.instant('igo.geo.directions.sharp right');\r\n  } else if (modifier === 'right') {\r\n    return translate.instant('igo.geo.directions.right');\r\n  } else if (modifier === 'slight right') {\r\n    return translate.instant('igo.geo.directions.slight right');\r\n  } else if (modifier === 'sharp left') {\r\n    return languageService.translate.instant('igo.geo.directions.sharp left');\r\n  } else if (modifier === 'left') {\r\n    return languageService.translate.instant('igo.geo.directions.left');\r\n  } else if (modifier === 'slight left') {\r\n    return languageService.translate.instant('igo.geo.directions.slight left');\r\n  } else if (modifier === 'straight') {\r\n    return languageService.translate.instant('igo.geo.directions.straight');\r\n  } else {\r\n    return modifier;\r\n  }\r\n}\r\n\r\nexport function translateBearing(bearing: number, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (bearing >= 337 || bearing < 23) {\r\n    return translate.instant('igo.geo.cardinalPoints.n');\r\n  } else if (bearing < 67) {\r\n    return translate.instant('igo.geo.cardinalPoints.ne');\r\n  } else if (bearing < 113) {\r\n    return translate.instant('igo.geo.cardinalPoints.e');\r\n  } else if (bearing < 157) {\r\n    return translate.instant('igo.geo.cardinalPoints.se');\r\n  } else if (bearing < 203) {\r\n    return translate.instant('igo.geo.cardinalPoints.s');\r\n  } else if (bearing < 247) {\r\n    return translate.instant('igo.geo.cardinalPoints.sw');\r\n  } else if (bearing < 293) {\r\n    return translate.instant('igo.geo.cardinalPoints.w');\r\n  } else if (bearing < 337) {\r\n    return translate.instant('igo.geo.cardinalPoints.nw');\r\n  } else {\r\n    return;\r\n  }\r\n}\r\n\r\n\r\n","<div cdkDropList class=\"stops-list\" (cdkDropListDropped)=\"drop($event)\">\r\n  <div touchleave  \r\n  (touchenter)=\"onStopEnter(stop)\"\r\n  (touchleave)=\"onStopLeave()\"\r\n  (mouseover)=\"onStopEnter(stop)\"\r\n  (mouseleave)=\"onStopLeave()\"\r\n  (cdkDragStarted)=\"stopIsDragged=true\"\r\n  (cdkDragEnded)=\"stopIsDragged=false\"\r\n  cdkDragLockAxis=\"y\" class=\"stop-box mat-typography\" *ngFor=\"let stop of stopsStore.view.all$() | async; let i = index;\" cdkDrag>\r\n    <div [ngClass]=\"getNgClass(stop)\">\r\n      <mat-form-field>\r\n        <input id=\"{{stop.id}}\" type=\"text\"\r\n            [placeholder]=\"getPlaceholder(stop)\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"stop.text\"\r\n            aria-label=\"Number\"\r\n            matInput\r\n            (focus)=\"onInputFocus(stop)\"\r\n            [(ngModel)]=\"stop.text\"\r\n            (keyup)=\"setStopText($event,stop)\"\r\n            (keydown.enter)=\"$event.preventDefault()\"\r\n            [matAutocomplete]=\"auto\">\r\n        <button \r\n            mat-button \r\n            *ngIf=\"(stop.text || stop.coordinates) && stopWithHover && stop.id===stopWithHover.id\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"'igo.geo.directionsForm.clearStop' | translate\"\r\n            matSuffix mat-icon-button color=\"warn\" aria-label=\"Clear\" (click)=\"clearStop(stop)\">\r\n            <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      \r\n        <mat-autocomplete [displayWith]=\"getOptionText\" #auto=\"matAutocomplete\" (optionSelected)=\"chooseProposal($event,stop)\">\r\n          <mat-optgroup *ngFor=\"let source of stop.searchProposals\" [label]=\"source.source.title\" [disabled]=\"source.source.enabled === false\">\r\n          <mat-option *ngFor=\"let result of source.results\" [value]=\"result\" \r\n          matTooltipShowDelay=\"500\" [matTooltip]=\"result.meta ? result.meta.title : ''\">\r\n            {{ result.meta ? result.meta.title : '' }}\r\n          </mat-option>\r\n          </mat-optgroup>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n\r\n\r\n\r\n    <div class=\"igo-form-button-group\" *ngIf=\"!stopIsDragged && stopWithHover && stop.id === stopWithHover.id\">\r\n      <button class=\"swipe-vertical\" cdkDragHandle mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.moveStop' | translate\" color=\"primary\">\r\n        <mat-icon svgIcon=\"gesture-swipe-vertical\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"(stopsStore.count$ | async)> 2\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\" (click)=\"removeStop(stop)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n      <button *ngIf=\"(stopsStore.count$ | async)<= 2\" disabled=\"true\" mat-icon-button tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\">\r\n        <mat-icon svgIcon=\"blank\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n</div>","import { Component, EventEmitter, Input, OnDestroy, Output } from '@angular/core';\r\nimport { CdkDragDrop, moveItemInArray } from '@angular/cdk/drag-drop';\r\n\r\nimport * as olProj from 'ol/proj';\r\nimport * as olObservable from 'ol/Observable';\r\n\r\nimport { Stop } from '../shared/directions.interface';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport pointOnFeature from '@turf/point-on-feature';\r\nimport { computeRelativePosition, removeStopFromStore, updateStoreSorting } from '../shared/directions.utils';\r\nimport { MatAutocomplete } from '@angular/material/autocomplete';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { StopsFeatureStore, StopsStore } from '../shared/store';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { DirectionRelativePositionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-inputs',\r\n  templateUrl: './directions-inputs.component.html',\r\n  styleUrls: ['./directions-inputs.component.scss']\r\n})\r\nexport class DirectionsInputsComponent implements OnDestroy {\r\n\r\n  private readonly invalidKeys = ['Control', 'Shift', 'Alt'];\r\n  private onMapClickEventKeys = [];\r\n  public stopWithHover: Stop;\r\n  public stopIsDragged: boolean = false;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() projection: string;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n\r\n  @Output() stopInputHasFocus: EventEmitter<boolean> = new EventEmitter<boolean>(false);\r\n  constructor(private languageService: LanguageService) { }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unlistenMapSingleClick();\r\n  }\r\n  onStopEnter(stop: Stop) {\r\n    this.stopWithHover = stop;\r\n  }\r\n  onStopLeave() {\r\n    this.stopWithHover = undefined;\r\n  }\r\n\r\n  getOptionText(option) {\r\n    if (option instanceof Object) {\r\n      return option?.meta ? option.meta.title : '';\r\n    }\r\n    return option;\r\n  }\r\n\r\n  chooseProposal(event: { source: MatAutocomplete, option: MatOption }, stop: Stop) {\r\n    const result: Feature = event.option.value;\r\n    if (result) {\r\n      let geomCoord;\r\n      const geom = result.geometry;\r\n      if (geom.type === 'Point') {\r\n        geomCoord = geom.coordinates;\r\n      } else {\r\n        const point = pointOnFeature(result.geometry);\r\n        geomCoord = [\r\n          point.geometry.coordinates[0],\r\n          point.geometry.coordinates[1]\r\n        ];\r\n      }\r\n      if (geomCoord) {\r\n        stop.coordinates = geomCoord;\r\n        stop.text = result.meta.title;\r\n        this.stopsStore.update(stop);\r\n      }\r\n    }\r\n  }\r\n\r\n  setStopText(event: KeyboardEvent, stop: Stop) {\r\n    this.unlistenMapSingleClick();\r\n    const term = (event.target as HTMLInputElement).value;\r\n    if (term.length === 0) {\r\n      this.clearStop(stop);\r\n    } else if (this.validateTerm(term)) {\r\n      stop.text = term;\r\n      this.stopsStore.update(stop);\r\n    }\r\n  }\r\n\r\n  validateTerm(term: string) {\r\n    if (\r\n      this.keyIsValid(term) &&\r\n      (term.length >= this.length || term.length === 0)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private keyIsValid(key: string) {\r\n    return this.invalidKeys.find(value => value === key) === undefined;\r\n  }\r\n\r\n  getNgClass(stop: Stop): string {\r\n    if (!this.stopWithHover) {\r\n      return 'igo-input-container';\r\n    } else if (stop.id === this.stopWithHover.id) {\r\n      return 'igo-input-container reduce';\r\n    } else {\r\n      return 'igo-input-container';\r\n    }\r\n  }\r\n\r\n  getPlaceholder(stop: Stop): string {\r\n    let extra = '';\r\n    if (stop.relativePosition) {\r\n      if (stop.relativePosition === DirectionRelativePositionType.Intermediate) {\r\n        extra = ' #' + stop.position;\r\n      }\r\n      return this.languageService.translate.instant('igo.geo.directionsForm.' + stop.relativePosition) + extra;\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  removeStop(stop: Stop) {\r\n    removeStopFromStore(this.stopsStore, stop);\r\n  }\r\n\r\n  clearStop(stop: Stop) {\r\n    this.stopsStore.update({ id: stop.id, relativePosition: stop.relativePosition, position: stop.position });\r\n  }\r\n\r\n  drop(event: CdkDragDrop<string[]>) {\r\n    this.moveStops(event.previousIndex, event.currentIndex);\r\n  }\r\n\r\n  private moveStops(fromIndex, toIndex) {\r\n    if (fromIndex !== toIndex) {\r\n      const stops = [...this.stopsStore.view.all()];\r\n      moveItemInArray(stops, fromIndex, toIndex);\r\n      stops.map((stop, i) => {\r\n        stop.relativePosition = computeRelativePosition(i, stops.length);\r\n        stop.position = i;\r\n      });\r\n      this.stopsStore.updateMany(stops);\r\n      updateStoreSorting(this.stopsStore);\r\n    }\r\n  }\r\n\r\n  onInputFocus(stop: Stop) {\r\n    if (!stop.text || stop.text?.length === 0) {\r\n      this.unlistenMapSingleClick();\r\n      this.stopInputHasFocus.emit(true);\r\n      this.listenMapSingleClick(stop);\r\n    }\r\n  }\r\n\r\n  private listenMapSingleClick(stop: Stop) {\r\n    const key = this.stopsFeatureStore.layer.map.ol.once('singleclick', event => {\r\n      const clickCoordinates = olProj.transform(\r\n        event.coordinate,\r\n        this.stopsFeatureStore.layer.map.projection,\r\n        this.projection\r\n      );\r\n      const roundedCoord = roundCoordTo(clickCoordinates as [number, number], this.coordRoundedDecimals);\r\n      stop.text = roundedCoord.join(',');\r\n      stop.coordinates = roundedCoord;\r\n      this.stopsStore.update(stop);\r\n      setTimeout(() => {\r\n        this.stopInputHasFocus.emit(false);\r\n      }, 500);\r\n    });\r\n    this.onMapClickEventKeys.push(key);\r\n  }\r\n\r\n  private unlistenMapSingleClick() {\r\n    this.onMapClickEventKeys.map(key => {\r\n      olObservable.unByKey(key);\r\n    });\r\n    this.onMapClickEventKeys = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable } from 'rxjs';\r\n\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsSource } from '../directions-sources/directions-source';\r\nimport { DirectionsSourceService } from './directions-source.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DirectionsService {\r\n  constructor(private directionsSourceService: DirectionsSourceService) {}\r\n\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]>[] {\r\n    if (coordinates.length === 0) {\r\n      return;\r\n    }\r\n    return this.directionsSourceService.sources\r\n      .filter((source: DirectionsSource) => source.enabled)\r\n      .map((source: DirectionsSource) => this.routeSource(source, coordinates, directionsOptions));\r\n  }\r\n\r\n  routeSource(\r\n    source: DirectionsSource,\r\n    coordinates: [number, number][],\r\n    directionsOptions: DirectionOptions = {}\r\n  ): Observable<Direction[]> {\r\n    const request = source.route(coordinates, directionsOptions );\r\n    return request;\r\n  }\r\n}\r\n","import { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchSource } from './sources/source';\r\nimport { SearchResult } from './search.interfaces';\r\n\r\n/**\r\n * Function that checks whether a search source implements TextSearch\r\n * @param source Search source\r\n * @returns True if the search source implements TextSearch\r\n */\r\nexport function sourceCanSearch(source: SearchSource): boolean {\r\n  return (source as any).search !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch\r\n */\r\nexport function sourceCanReverseSearch(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch AND is shown in the pointer summary\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch AND is shown in the pointer summary\r\n */\r\nexport function sourceCanReverseSearchAsSummary(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined && source.showInPointerSummary === true;\r\n}\r\n\r\n/**\r\n * Return a search result out of an Feature. This is used to adapt\r\n * the IGO query module to the new Feature/SearchResult interfaces\r\n * @param feature feature\r\n * @param source Search source\r\n * @returns SearchResult\r\n */\r\nexport function featureToSearchResult(\r\n  feature: Feature,\r\n  source: SearchSource\r\n): SearchResult<Feature> {\r\n  feature.sourceId = source.getId();\r\n  return {\r\n    source,\r\n    data: feature,\r\n    meta: {\r\n      dataType: FEATURE,\r\n      id: feature.meta.id as string,\r\n      title: feature.meta.title,\r\n      icon: feature.meta.icon || 'map-marker'\r\n    }\r\n  };\r\n}\r\n\r\nexport function findDiff(str1: string, str2: string){\r\n  let diff = '';\r\n  str2.split('').forEach((val, i) => {\r\n    if (val !== str1.charAt(i)) {\r\n      diff += val;\r\n    }\r\n  });\r\n  return diff;\r\n}\r\n\r\n\r\n/**\r\n * Return a score calculation based on \"from\" term with the \"to\" term,\r\n * where the perfect match is 100 and a total difference is 0 or under.\r\n * @param from string\r\n * @param to string\r\n * @param caseSensitive boolean\r\n * @returns number\r\n */\r\nexport function computeTermSimilarity(from, to, caseSensitive: boolean = false): number {\r\n  if (!from || !to) {\r\n    return 0;\r\n  }\r\n  const termFrom = caseSensitive ? from : from.toLowerCase();\r\n  const termTo = caseSensitive ? to : to.toLowerCase();\r\n  const fromToDiff = findDiff(termFrom, termTo);\r\n  const toFromDiff = findDiff(termTo, termFrom);\r\n  const totalDiff = fromToDiff + toFromDiff;\r\n\r\n  let delta = 0;\r\n  if (totalDiff.length) {\r\n    delta = totalDiff.length / termFrom.length * 100;\r\n  }\r\n\r\n  return 100 - Math.floor(delta);\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceSettings } from './sources/source.interfaces';\r\n\r\n/**\r\n * Service where all available search sources are registered.\r\n */\r\nexport class SearchSourceService {\r\n\r\n  constructor(private sources: SearchSource[]) {}\r\n\r\n  /**\r\n   * Return available search sources\r\n   * @returns Search sources\r\n   */\r\n  getSources(): SearchSource[] {\r\n    return this.sources;\r\n  }\r\n\r\n  /**\r\n   * Return enabled search sources\r\n   * @returns Search sources\r\n   */\r\n  getEnabledSources(): SearchSource[] {\r\n    return this.getSources().filter(\r\n      (source: SearchSource) => source.enabled === true\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable search sources of given type\r\n   * @param type Search type\r\n   * @todo It would be better to track the enabled search sources\r\n   *  without updating their 'enabled' property.\r\n   */\r\n  enableSourcesByType(type: string) {\r\n    this.getSources().forEach((source: SearchSource) => {\r\n      if ((source.constructor as typeof SearchSource).type === type) {\r\n        source.enabled = true;\r\n      } else {\r\n        source.enabled = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set Param from the selected settings\r\n   * @param source search-source\r\n   * @param setting settings\r\n   */\r\n  setParamFromSetting(source: SearchSource, setting: SearchSourceSettings) {\r\n    source.setParamFromSetting(setting);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { stringToLonLat } from '../../map';\r\nimport { MapService } from '../../map/shared/map.service';\r\n\r\nimport { SearchSource, TextSearch, ReverseSearch } from './sources/source';\r\nimport {\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './sources/source.interfaces';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { Research } from './search.interfaces';\r\nimport {\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch,\r\n  sourceCanReverseSearchAsSummary\r\n} from './search.utils';\r\n\r\n/**\r\n * This service perform researches in all the search sources enabled.\r\n * It returns Research objects who's 'request' property needs to be\r\n * subscribed to in order to trigger the research. This services has\r\n * keeps internal state of the researches it performed\r\n * and the results they yielded.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchService {\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  /**\r\n   * Perform a research by text\r\n   * @param term Any text\r\n   * @returns Researches\r\n   */\r\n  search(term: string, options: TextSearchOptions = {}): Research[] {\r\n    if (!this.termIsValid(term)) {\r\n      return [];\r\n    }\r\n\r\n    const proj = this.mapService.getMap()?.projection || 'EPSG:3857';\r\n    const response = stringToLonLat(term, proj, {\r\n      forceNA: options.forceNA\r\n    });\r\n    if (response.lonLat) {\r\n      return this.reverseSearch(response.lonLat, { distance: response.radius, conf: response.conf });\r\n    } else if (response.message) {\r\n      console.log(response.message);\r\n    }\r\n\r\n    options.extent = this.mapService\r\n      .getMap()\r\n      ?.viewController.getExtent('EPSG:4326');\r\n\r\n    let sources;\r\n\r\n    if (options.getEnabledOnly || options.getEnabledOnly === undefined) {\r\n      sources = this.searchSourceService.getEnabledSources();\r\n    } else {\r\n      sources = this.searchSourceService.getSources();\r\n    }\r\n\r\n    if (options.sourceId) {\r\n      sources = sources.filter((source) => source.getId() === options.sourceId);\r\n    } else if (options.searchType) {\r\n      sources = sources.filter(\r\n        (source) => source.getType() === options.searchType\r\n      );\r\n    }\r\n\r\n    sources = sources.filter(sourceCanSearch);\r\n    return this.searchSources(sources, term, options);\r\n  }\r\n\r\n  /**\r\n   * Perform a research by lon/lat\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Researches\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    asPointerSummary: boolean = false\r\n  ) {\r\n    const reverseSourceFonction = asPointerSummary\r\n      ? sourceCanReverseSearchAsSummary\r\n      : sourceCanReverseSearch;\r\n    const sources = this.searchSourceService\r\n      .getEnabledSources()\r\n      .filter(reverseSourceFonction);\r\n    return this.reverseSearchSources(sources, lonLat, options || {});\r\n  }\r\n\r\n  /**\r\n   * Create a text research out of all given search sources\r\n   * @param sources Search sources that implement TextSearch\r\n   * @param term Search term\r\n   * @returns Observable of Researches\r\n   */\r\n  private searchSources(\r\n    sources: SearchSource[],\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as TextSearch).search(term, options),\r\n        reverse: false,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a reverse research out of all given search sources\r\n   * @param sources Search sources that implement ReverseSearch\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Observable of Researches\r\n   */\r\n  private reverseSearchSources(\r\n    sources: SearchSource[],\r\n    lonLat: [number, number],\r\n    options: ReverseSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as ReverseSearch).reverseSearch(\r\n          lonLat,\r\n          options\r\n        ),\r\n        reverse: true,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate that a search term is valid\r\n   * @param term Search term\r\n   * @returns True if the search term is valid\r\n   */\r\n  private termIsValid(term: string): boolean {\r\n    return typeof term === 'string' && term !== '';\r\n  }\r\n}\r\n","<div class=\"igo-form-button-group\">\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.addStop' | translate\" color=\"primary\" (click)=\"addStop()\">\r\n    <mat-icon svgIcon=\"map-marker-plus\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1 || (stopsStore.count$ | async)>=1\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.resetDirectionsBtn' | translate\" color=\"warn\" (click)=\"resetStops()\">\r\n    <mat-icon svgIcon=\"file-restore\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"zoomRoute()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.zoomRoute' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"magnify-plus-outline\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyDirectionsToClipboard()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.copy' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyLinkToClipboard()\" \r\n    [matTooltip]=\"'igo.geo.directionsForm.link' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"link\"></mat-icon>\r\n  </button>\r\n</div>","import { Component, Input, Optional } from '@angular/core';\r\nimport { LanguageService, MessageService, RouteService } from '@igo2/core';\r\nimport { Clipboard } from '@igo2/utils';\r\nimport { Subject } from 'rxjs';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { FeatureWithDirection } from '../shared/directions.interface';\r\n\r\nimport { addStopToStore, formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StopsStore } from '../shared/store';\r\n\r\n@Component({\r\n  selector: 'igo-directions-buttons',\r\n  templateUrl: './directions-buttons.component.html',\r\n  styleUrls: ['./directions-buttons.component.scss']\r\n})\r\nexport class DirectionsButtonsComponent {\r\n\r\n  get activeRoute() {\r\n    return this.routesFeatureStore.all().find(route => route.properties.active);\r\n  }\r\n  @Input() contextUri: string;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private route: RouteService) { }\r\n\r\n  resetStops() {\r\n    this.stopsStore.clearStops();\r\n  }\r\n\r\n  // stop are always added before the last stop.\r\n  addStop(): void {\r\n    addStopToStore(this.stopsStore);\r\n  }\r\n\r\n\r\n  copyLinkToClipboard() {\r\n    const successful = Clipboard.copy(this.getUrl());\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyTitle'\r\n      );\r\n      const msg = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyMsgLink'\r\n      );\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  zoomRoute() {\r\n    this.zoomToActiveRoute$.next();\r\n  }\r\n\r\n  copyDirectionsToClipboard() {\r\n    const directionsBody = this.directionsToText();\r\n    const successful = Clipboard.copy(directionsBody);\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyTitle'\r\n      );\r\n      const msg = translate.instant('igo.geo.directionsForm.dialog.copyMsg');\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  private directionsToText() {\r\n    const indent = '\\t';\r\n    let activeRouteDirective =\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.instructions'\r\n      ) + ':\\n';\r\n    let wayPointList = '';\r\n    const summary =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.summary') +\r\n      ': \\n' +\r\n      indent +\r\n      this.activeRoute.properties.direction.title +\r\n      '\\n' +\r\n      indent +\r\n      formatDistance(this.activeRoute.properties.direction.distance) +\r\n      '\\n' +\r\n      indent +\r\n      formatDuration(this.activeRoute.properties.direction.duration) +\r\n      '\\n\\n' +\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.stopsList'\r\n      ) +\r\n      ':\\n';\r\n\r\n    const url =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.link') +\r\n      ':\\n' +\r\n      indent +\r\n      this.getUrl();\r\n\r\n    let wayPointsCnt = 1;\r\n    this.stopsStore.view.all().forEach(stop => {\r\n      let coord = '';\r\n      let stopText = '';\r\n      if (stop.text !== roundCoordTo(stop.coordinates).join(',')) {\r\n        stopText = stop.text;\r\n        coord = ` ( ${roundCoordTo(stop.coordinates).join(',')} )`;\r\n      } else {\r\n        stopText = roundCoordTo(stop.coordinates).join(\r\n          ','\r\n        );\r\n      }\r\n\r\n      wayPointList =\r\n        wayPointList +\r\n        indent +\r\n        wayPointsCnt.toLocaleString() +\r\n        '. ' +\r\n        stopText +\r\n        coord +\r\n        '\\n';\r\n      wayPointsCnt++;\r\n    });\r\n\r\n    let localCnt = 0;\r\n    this.activeRoute.properties.direction.steps.forEach(step => {\r\n      const instruction = this.formatStep(step, localCnt).instruction;\r\n      const distance =\r\n        formatDistance(step.distance) === undefined\r\n          ? ''\r\n          : ' (' + formatDistance(step.distance) + ')';\r\n      activeRouteDirective =\r\n        activeRouteDirective +\r\n        indent +\r\n        (localCnt + 1).toLocaleString() +\r\n        '. ' +\r\n        instruction +\r\n        distance +\r\n        '\\n';\r\n      localCnt++;\r\n    });\r\n\r\n    const directionsBody =\r\n      summary + wayPointList + '\\n' + url + '\\n\\n' + activeRouteDirective;\r\n\r\n    return directionsBody;\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeRoute.properties.direction.steps.length - 1\r\n    );\r\n  }\r\n\r\n  private getUrl() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n    let context = '';\r\n    if (this.contextUri) {\r\n      context = `context=${this.contextUri}&`;\r\n    }\r\n\r\n    const pos = this.routesFeatureStore.all()\r\n    .map((direction: FeatureWithDirection) => direction.properties.id).indexOf(this.activeRoute.properties.id);\r\n    let routingOptions = '';\r\n    if (pos !== 0) {\r\n      const routingOptionsKey = this.route.options.directionsOptionsKey;\r\n      routingOptions = `&${routingOptionsKey}=result:${pos}`;\r\n    }\r\n    const directionsKey = this.route.options.directionsCoordKey;\r\n    const stopsCoordinates = this.stopsStore.view.all().map(stop => roundCoordTo(stop.coordinates, 6));\r\n    let directionsUrl = '';\r\n    if (stopsCoordinates.length >= 2) {\r\n      directionsUrl = `${directionsKey}=${stopsCoordinates.join(';')}`;\r\n      return `${location.origin}${location.pathname}?${context}tool=directions&sidenav=1&${directionsUrl}${routingOptions}`;\r\n    }\r\n    return;\r\n  }\r\n}\r\n","<div class=\"igo-input-container\" *ngIf=\"directions && activeDirection\">\r\n    <mat-form-field *ngIf=\"directions && directions.length > 1\">\r\n        <mat-select placeholder=\"{{'igo.geo.directionsForm.drivingOptions' | translate}}\"\r\n            (selectionChange)=\"changeRoute()\" [(ngModel)]=\"activeDirection\">\r\n            <mat-option *ngFor=\"let direction of directions; let cnt = index;\" [value]=\"direction\">\r\n                Option {{cnt + 1}} : {{formatDistance(direction.distance)}}\r\n                ({{formatDuration(direction.duration)}})\r\n            </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n\r\n    <mat-divider *ngIf=\"directions && directions.length === 0\"></mat-divider>\r\n\r\n    <mat-list (mouseleave)=\"onStepsListBlur()\">\r\n        <h2 mat-header class=\"igo-route-title mat-typography\">{{activeDirection.title}}</h2>\r\n        <h2 mat-subheader>{{formatDistance(activeDirection.distance)}}, {{formatDuration(activeDirection.duration)}}</h2>\r\n        <mat-list-item class=\"igo-steps\" \r\n            (mouseenter)=\"showSegment(step)\" \r\n            (click)=\"showSegment(step,true)\" \r\n            *ngFor=\"let step of activeDirection.steps; let cnt = index;\" igoListItem>\r\n            <mat-icon [ngClass]=\"formatStep(step,cnt).cssClass\" mat-list-icon svgIcon=\"{{formatStep(step,cnt).image}}\">\r\n            </mat-icon>\r\n\r\n            <h4 mat-line>{{cnt +1}}. {{formatStep(step,cnt).instruction}}</h4>\r\n            <h4 mat-line class=\"right\">{{formatDistance(step.distance)}}</h4>\r\n        </mat-list-item>\r\n\r\n        <mat-divider></mat-divider>\r\n\r\n    </mat-list>\r\n\r\n</div>","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Direction, FeatureWithStep, IgoStep } from '../shared/directions.interface';\r\nimport { formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StepFeatureStore } from '../shared/store';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olGeom from 'ol/geom';\r\n\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { DirectionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-results',\r\n  templateUrl: './directions-results.component.html',\r\n  styleUrls: ['./directions-results.component.scss']\r\n})\r\nexport class DirectionsResultsComponent implements OnInit, OnDestroy {\r\n\r\n  public activeDirection: Direction;\r\n  public directions: Direction[];\r\n\r\n  private entities$$: Subscription;\r\n\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) { }\r\n\r\n  ngOnInit(): void {\r\n    this.entities$$ = this.routesFeatureStore.entities$\r\n      .pipe(debounceTime(200))\r\n      .subscribe(entities => {\r\n        const activeFeatureWithDirection = entities.find(entity => entity.properties.active);\r\n        this.directions = entities.map(entity => entity.properties.direction);\r\n        if (activeFeatureWithDirection) {\r\n          this.activeDirection = activeFeatureWithDirection.properties.direction;\r\n        } else {\r\n          this.activeDirection = undefined;\r\n        }\r\n        this.cdRef.detectChanges();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.entities$$.unsubscribe();\r\n  }\r\n\r\n  changeRoute() {\r\n    this.routesFeatureStore.entities$.value.map(entity =>\r\n      entity.properties.active = !entity.properties.active\r\n    );\r\n    this.routesFeatureStore.layer.ol.getSource().getFeatures().map(feature =>\r\n      feature.set('active', !feature.get('active'))\r\n    );\r\n  }\r\n\r\n  formatDistance(distance: number): string {\r\n    return formatDistance(distance);\r\n  }\r\n\r\n  formatDuration(duration: number): string {\r\n    return formatDuration(duration);\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeDirection.steps.length - 1\r\n    );\r\n  }\r\n\r\n  onStepsListBlur() {\r\n    this.stepFeatureStore.clear();\r\n  }\r\n\r\n  showSegment(step: IgoStep, zoomToExtent = false) {\r\n    this.showRouteSegmentGeometry(step, zoomToExtent);\r\n  }\r\n\r\n  showRouteSegmentGeometry(step: IgoStep, zoomToExtent = false) {\r\n\r\n    const coordinates = step.geometry.coordinates;\r\n    const vertexId = 'vertex';\r\n    const geometry4326 = new olGeom.LineString(coordinates);\r\n    const geometryMapProjection = geometry4326.transform(\r\n      'EPSG:4326',\r\n      this.stepFeatureStore.layer.map.projection\r\n    );\r\n    const routeSegmentCoordinates = (geometryMapProjection as any).getCoordinates();\r\n    const lastPoint = routeSegmentCoordinates[0];\r\n\r\n    const geometry = new olGeom.Point(lastPoint);\r\n    const feature = new olFeature({ geometry });\r\n\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.stepFeatureStore.layer.map.projection,\r\n      dataProjection: this.stepFeatureStore.layer.map.projection\r\n    }) as FeatureGeometry;\r\n\r\n    const previousVertex = this.stepFeatureStore.get(vertexId);\r\n    const previousVertexRevision = previousVertex\r\n      ? previousVertex.meta.revision\r\n      : 0;\r\n\r\n    const stepFeature: FeatureWithStep = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.stepFeatureStore.layer.map.projection,\r\n      properties: {\r\n        id: vertexId,\r\n        step,\r\n        type: DirectionType.Vertex\r\n      },\r\n      meta: {\r\n        id: vertexId,\r\n        revision: previousVertexRevision + 1\r\n      },\r\n      ol: feature\r\n    };\r\n    this.stepFeatureStore.update(stepFeature);\r\n    if (zoomToExtent) {\r\n      this.stepFeatureStore.layer.map.viewController.zoomToExtent(feature.getGeometry().getExtent() as [number, number, number, number]);\r\n    }\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { debounceTime, distinctUntilChanged, map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport * as olCondition from 'ol/events/condition';\r\nimport * as olInteraction from 'ol/interaction';\r\nimport * as olProj from 'ol/proj';\r\nimport { TranslateEvent } from 'ol/interaction/Translate';\r\nimport Collection from 'ol/Collection';\r\nimport { SelectEvent } from 'ol/interaction/Select';\r\n\r\nimport { DirectionOptions, FeatureWithStopProperties, Stop } from './shared/directions.interface';\r\nimport { Subject, Subscription } from 'rxjs';\r\nimport { addDirectionToRoutesFeatureStore, addStopToStopsFeatureStore, addStopToStore,\r\n  initRoutesFeatureStore, initStepFeatureStore, initStopsFeatureStore, updateStoreSorting } from './shared/directions.utils';\r\nimport { Feature } from '../feature/shared/feature.interfaces';\r\nimport { DirectionsService } from './shared/directions.service';\r\nimport { DirectionType, ProposalType } from './shared/directions.enum';\r\nimport { roundCoordTo, stringToLonLat } from '../map';\r\nimport { SearchService } from '../search/shared/search.service';\r\nimport { ChangeUtils, ObjectUtils } from '@igo2/utils';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './shared/store';\r\nimport { FeatureStoreLoadingStrategy } from '../feature/shared/strategies/loading';\r\nimport { Research, SearchResult } from '../search/shared/search.interfaces';\r\nimport { QueryService } from '../query/shared/query.service';\r\n\r\n@Component({\r\n  selector: 'igo-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class DirectionsComponent implements OnInit, OnDestroy {\r\n\r\n  private watcher: EntityStoreWatcher<Stop>;\r\n\r\n  public projection: string = 'EPSG:4326';\r\n\r\n  private zoomRoute$$: Subscription;\r\n  private storeEmpty$$: Subscription;\r\n  private storeChange$$: Subscription;\r\n  private routesQueries$$: Subscription[] = [];\r\n\r\n  private selectStopInteraction: olInteraction.Select;\r\n  private translateStop: olInteraction.Translate;\r\n  private selectedRoute;\r\n  private focusOnStop: boolean = false;\r\n  private isTranslating: boolean = false;\r\n\r\n  public previousStops: Stop[] = [];\r\n\r\n  private searchs$$: Subscription[] = [];\r\n\r\n  @Input() contextUri: string;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private languageService: LanguageService,\r\n    private directionsService: DirectionsService,\r\n    private searchService: SearchService,\r\n    private queryService: QueryService\r\n  ) { }\r\n\r\n\r\n  ngOnInit(): void {\r\n    this.queryService.queryEnabled = false;\r\n    this.initEntityStores();\r\n    setTimeout(() => {\r\n      initStopsFeatureStore(this.stopsFeatureStore, this.languageService);\r\n      initRoutesFeatureStore(this.routesFeatureStore, this.languageService);\r\n      initStepFeatureStore(this.stepFeatureStore);\r\n      this.initOlInteraction();\r\n    }, 1);\r\n\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.queryService.queryEnabled = true;\r\n    this.storeEmpty$$.unsubscribe();\r\n    this.storeChange$$.unsubscribe();\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    this.zoomRoute$$.unsubscribe();\r\n    this.freezeStores();\r\n  }\r\n\r\n  private freezeStores() {\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute);\r\n    this.stopsFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.routesFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.stepFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n  }\r\n\r\n  private initEntityStores() {\r\n    this.watcher = new EntityStoreWatcher(this.stopsStore, this.cdRef);\r\n    this.monitorEmptyEntityStore();\r\n    this.monitorEntityStoreChange();\r\n    this.monitorActiveRouteZoom();\r\n  }\r\n\r\n  private monitorActiveRouteZoom() {\r\n    this.zoomRoute$$ = this.zoomToActiveRoute$.subscribe(() => {\r\n      if (this.routesFeatureStore.count >= 1) {\r\n        const activeRoute = this.routesFeatureStore.all().find(route => route.properties.active);\r\n\r\n        if (activeRoute) {\r\n          activeRoute.ol.getGeometry();\r\n          const routeExtent = activeRoute.ol.getGeometry().getExtent();\r\n          this.routesFeatureStore.layer.map.viewController.zoomToExtent(routeExtent as [number, number, number, number]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private initOlInteraction() {\r\n    this.selectStopInteraction = new olInteraction.Select({\r\n      layers: [this.stopsFeatureStore.layer.ol],\r\n      hitTolerance: 7,\r\n      condition: (event) => {\r\n        return event.type === 'pointermove' && !event.dragging;\r\n      }\r\n    });\r\n\r\n    this.translateStop = new olInteraction.Translate({\r\n      features: this.selectStopInteraction.getFeatures()\r\n    });\r\n    this.translateStop.on('translating', (evt: TranslateEvent) => {\r\n      this.isTranslating = true;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n    this.translateStop.on('translateend', (evt: TranslateEvent) => {\r\n      this.isTranslating = false;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n\r\n    this.selectedRoute = new olInteraction.Select({\r\n      layers: [this.routesFeatureStore.layer.ol],\r\n      condition: olCondition.click,\r\n      hitTolerance: 7,\r\n      filter: feature => {\r\n        return feature.get('type') === DirectionType.Route &&\r\n          feature.get('active') &&\r\n          !this.isTranslating;\r\n      }\r\n    });\r\n    this.selectedRoute.on('select', (evt: SelectEvent) => {\r\n      if (this.focusOnStop === false) {\r\n        const selectCoordinates = roundCoordTo(\r\n          olProj.transform(\r\n            (evt as any).mapBrowserEvent.coordinate,\r\n            this.routesFeatureStore.layer.map.projection,\r\n            this.projection\r\n          ) as [number, number], this.coordRoundedDecimals);\r\n        const addedStop = addStopToStore(this.stopsStore);\r\n        addedStop.text = selectCoordinates.join(',');\r\n        addedStop.coordinates = [selectCoordinates[0], selectCoordinates[1]];\r\n      }\r\n    });\r\n\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  onStopInputHasFocusChange(stopInputHasFocus: boolean) {\r\n    stopInputHasFocus ?\r\n      this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute) :\r\n      this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  private executeStopTranslation(\r\n    features: Collection<any>\r\n  ) {\r\n    if (features.getLength() === 0) {\r\n      return;\r\n    }\r\n    const firstFeature = features.getArray()[0];\r\n    const translatedStopId = firstFeature.getId();\r\n\r\n    const translationCoordinates = olProj.transform(\r\n      firstFeature.getGeometry().getCoordinates(),\r\n      this.stopsFeatureStore.layer.map.projection,\r\n      this.projection\r\n    );\r\n    const translatedStop = this.stopsStore.get(translatedStopId);\r\n    const roundedCoord = roundCoordTo(translationCoordinates as [number, number], this.coordRoundedDecimals);\r\n    translatedStop.coordinates = roundedCoord;\r\n    translatedStop.text = roundedCoord.join(',');\r\n    this.stopsStore.update(translatedStop);\r\n  }\r\n\r\n\r\n  private monitorEmptyEntityStore() {\r\n    // Watch if the store is empty to reset it\r\n    this.storeEmpty$$ = this.stopsStore.count$\r\n      .pipe(\r\n        distinctUntilChanged()\r\n      ).subscribe((count) => {\r\n        if (count < 2) {\r\n          addStopToStore(this.stopsStore);\r\n          if (this.stopsStore.count === 2) {\r\n            this.stopsStore.storeInitialized$.next(true);\r\n            return;\r\n          }\r\n          this.stopsStore.storeInitialized$.next(false);\r\n        }\r\n        this.routesQueries$$.map((u) => u.unsubscribe());\r\n      });\r\n  }\r\n\r\n  private monitorEntityStoreChange() {\r\n    this.storeChange$$ = this.stopsStore.entities$\r\n      .pipe(debounceTime(this.debounce))\r\n      .subscribe((stops: Stop[]) => {\r\n        this.handleStopDiff(stops);\r\n        updateStoreSorting(this.stopsStore);\r\n        this.handleStopsFeature();\r\n        this.getRoutes(this.isTranslating);\r\n      });\r\n  }\r\n\r\n  cancelSearch() {\r\n    this.searchs$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  private handleStopDiff(stops: Stop[]) {\r\n    const simplifiedStops = stops.map((stop: Stop) => {\r\n      return ObjectUtils.removeUndefined({ ...{ id: stop.id, text: stop.text, coordinates: stop.coordinates } });\r\n    });\r\n    const diff = ChangeUtils.findChanges(this.previousStops, simplifiedStops, ['coordinates']);\r\n    const stopIdToProcess = diff.added.concat(diff.modified);\r\n    if (stopIdToProcess) {\r\n      stopIdToProcess.map((change) => {\r\n        const changedStop = (change.newValue as Stop);\r\n        if (changedStop) {\r\n          const stop: Stop = this.stopsStore.get(changedStop.id);\r\n          const term = stop.text;\r\n          if (!term || term.length === 0) {\r\n            return;\r\n          }\r\n          const response = stringToLonLat(term, this.stopsFeatureStore.layer.map.projection);\r\n          let researches: Research[];\r\n          let isCoord = false;\r\n          if (response.lonLat) {\r\n            isCoord = true;\r\n          }\r\n          researches = this.searchService.search(term, { searchType: 'Feature' });\r\n          this.cancelSearch();\r\n          const requests$ = researches.map(res => res.request\r\n            .pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n\r\n          );\r\n          this.searchs$$ = requests$.map((request) => {\r\n            return request.pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n              .subscribe((res: SearchResult[]) => {\r\n                if (res.length > 0) {\r\n                  const source = res[0].source;\r\n                  const meta = res[0].meta;\r\n                  const results = res.map(r => r.data);\r\n                  if (!stop.searchProposals) {\r\n                    stop.searchProposals = [];\r\n                  }\r\n                  stop.searchProposals = stop.searchProposals.filter(sp => sp.type === (isCoord ? ProposalType.Coord : ProposalType.Text));\r\n                  let storedSource = stop.searchProposals.find(sp => sp.source === source);\r\n                  if (storedSource) {\r\n                    storedSource.results = results;\r\n                  } else {\r\n                    stop.searchProposals.push({\r\n                      type: isCoord ? ProposalType.Coord : ProposalType.Text,\r\n                      source,\r\n                      meta,\r\n                      results\r\n                    });\r\n                  }\r\n                }\r\n                this.cdRef.detectChanges();\r\n              });\r\n          });\r\n        }\r\n      });\r\n    }\r\n    this.previousStops = simplifiedStops;\r\n  }\r\n\r\n  private handleStopsFeature() {\r\n    const stops = this.stopsStore.all();\r\n    const stopsWithCoordinates = stops.filter(stop => stop.coordinates);\r\n    stopsWithCoordinates.map(stop => this.addStopOverlay(stop));\r\n    this.stopsFeatureStore.all().map(\r\n      (stopFeature: Feature<FeatureWithStopProperties>) => {\r\n        if (!this.stopsStore.get(stopFeature.properties.id)) {\r\n          this.stopsFeatureStore.delete(stopFeature);\r\n        }\r\n      });\r\n    const stopsWithoutCoordinates = stops.filter(stop => !stop.coordinates);\r\n    stopsWithoutCoordinates.map(stop => {\r\n      const stopFeature = this.stopsFeatureStore.get(stop.id);\r\n      if (stopFeature) {\r\n        this.stopsFeatureStore.delete(stopFeature);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getRoutes(isOverview: boolean = false) {\r\n    const stopsWithCoordinates = this.stopsStore.view\r\n      .all()\r\n      .filter(stop => stop.coordinates);\r\n    if (stopsWithCoordinates.length < 2) {\r\n      this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n      return;\r\n    }\r\n\r\n    const roundedCoordinates = stopsWithCoordinates.map((stop) => {\r\n      const roundedCoord = roundCoordTo(stop.coordinates, this.coordRoundedDecimals);\r\n      return roundedCoord;\r\n    });\r\n    const overviewDirectionsOptions: DirectionOptions = {\r\n      overview: true,\r\n      steps: false,\r\n      alternatives: false,\r\n      continue_straight: false\r\n    };\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    const routeResponse = this.directionsService.route(\r\n      roundedCoordinates,\r\n      isOverview ? overviewDirectionsOptions : undefined\r\n    );\r\n    if (routeResponse) {\r\n      routeResponse.map(res =>\r\n        this.routesQueries$$.push(\r\n          res.subscribe(directions => {\r\n            this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n            directions.map(direction =>\r\n              addDirectionToRoutesFeatureStore(\r\n                this.routesFeatureStore,\r\n                direction,\r\n                this.projection,\r\n                direction === directions[0] ? true : false)\r\n            );\r\n          })\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  public addStopOverlay(stop: Stop) {\r\n    addStopToStopsFeatureStore(stop, this.stopsStore, this.stopsFeatureStore, this.projection, this.languageService);\r\n  }\r\n}\r\n","<igo-directions-buttons [contextUri]=\"contextUri\" [zoomToActiveRoute$]=\"zoomToActiveRoute$\" [routesFeatureStore]=\"routesFeatureStore\" [stopsStore]=\"stopsStore\"></igo-directions-buttons>\r\n\r\n<igo-directions-inputs (stopInputHasFocus)=\"onStopInputHasFocusChange($event)\" [coordRoundedDecimals]=\"coordRoundedDecimals\" [projection]=\"projection\" [stopsFeatureStore]=\"stopsFeatureStore\" [stopsStore]=\"stopsStore\" [debounce]=\"debounce\" [length]=\"length\"></igo-directions-inputs>\r\n<br>\r\n<igo-directions-results [stepFeatureStore]=\"stepFeatureStore\" [routesFeatureStore]=\"routesFeatureStore\"></igo-directions-results>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { provideDirectionsSourceService } from './shared/directions-source.service';\r\nimport { DragDropModule } from '@angular/cdk/drag-drop';\r\nimport { DirectionsInputsComponent } from './directions-inputs/directions-inputs.component';\r\nimport { DirectionsComponent } from './directions.component';\r\nimport { DirectionsButtonsComponent } from './directions-buttons/directions-buttons.component';\r\nimport { DirectionsResultsComponent } from './directions-results/directions-results.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    DragDropModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatListModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatAutocompleteModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  declarations: [\r\n     DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  providers: [provideDirectionsSourceService()]\r\n})\r\nexport class IgoDirectionsModule {\r\n  static forRoot(): ModuleWithProviders<IgoDirectionsModule> {\r\n    return {\r\n      ngModule: IgoDirectionsModule\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceService } from './search-source.service';\r\n\r\n/**\r\n * Search source factory\r\n * @ignore\r\n */\r\nexport function searchSourceServiceFactory(sources: SearchSource[]) {\r\n  return new SearchSourceService(sources);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the SearchSource service\r\n */\r\nexport function provideSearchSourceService() {\r\n  return {\r\n    provide: SearchSourceService,\r\n    useFactory: searchSourceServiceFactory,\r\n    deps: [SearchSource]\r\n  };\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpClient, HttpParams, HttpParameterCodec } from '@angular/common/http';\r\n\r\nimport { Observable, of, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport pointOnFeature from '@turf/point-on-feature';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\nimport { GoogleLinks } from './../../../utils/googleLinks';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  IChercheData,\r\n  IChercheResponse,\r\n  IChercheReverseData,\r\n  IChercheReverseResponse\r\n} from './icherche.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class IChercheSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n\r\n// Fix the \"+\" is replaced with space \" \" in a query string\r\n// https://github.com/angular/angular/issues/11058\r\nexport class IgoHttpParameterCodec implements HttpParameterCodec {\r\n  encodeKey(key: string): string {\r\n    return encodeURIComponent(key);\r\n  }\r\n\r\n  encodeValue(value: string): string {\r\n    return encodeURIComponent(value);\r\n  }\r\n\r\n  decodeKey(key: string): string {\r\n    return decodeURIComponent(key);\r\n  }\r\n\r\n  decodeValue(value: string): string {\r\n    return decodeURIComponent(value);\r\n  }\r\n}\r\n\r\n/**\r\n * ICherche search source\r\n */\r\n@Injectable()\r\nexport class IChercheSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'icherche';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  private hashtagsLieuxToKeep = [];\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    @Inject(IChercheSearchResultFormatter)\r\n    private formatter: IChercheSearchResultFormatter,\r\n    injector: Injector\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n\r\n    const types = this.options.params?.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : [\r\n            'adresses',\r\n            'codes-postaux',\r\n            'routes',\r\n            'intersections',\r\n            'municipalites',\r\n            'mrc',\r\n            'regadmin',\r\n            'lieux'\r\n          ];\r\n\r\n    return {\r\n      title: 'igo.geo.search.icherche.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1,\r\n              hashtags: ['adresse']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldAddress',\r\n              value: 'anciennes-adresses',\r\n              enabled: types.indexOf('anciennes-adresses') !== -1,\r\n              hashtags: ['anciennes-adresses']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.postalCode',\r\n              value: 'codes-postaux',\r\n              enabled: types.indexOf('codes-postaux') !== -1,\r\n              hashtags: ['code-postal']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              hashtags: ['route']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.intersection',\r\n              value: 'intersections',\r\n              enabled: types.indexOf('intersections') !== -1,\r\n              hashtags: ['intersection', '+']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1,\r\n              hashtags: ['municipalité', 'mun']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldCity',\r\n              value: 'anciennes-municipalites',\r\n              enabled: types.indexOf('anciennes-municipalites') !== -1,\r\n              hashtags: ['anciennes-municipalites']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1,\r\n              hashtags: ['mrc']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1,\r\n              hashtags: ['région-administrative', 'regadmin']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.entreprise',\r\n              value: 'entreprises',\r\n              enabled: types.indexOf('entreprises') !== -1,\r\n              available: false,\r\n              hashtags: ['entreprise']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.place',\r\n              value: 'lieux',\r\n              enabled: types.indexOf('lieux') !== -1,\r\n              hashtags: ['lieu']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.exit',\r\n              value: 'sorties-autoroute',\r\n              enabled: types.indexOf('sorties-autoroute') !== -1,\r\n              hashtags: ['sortie', 'sorties', 'exit']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.km',\r\n              value: 'bornes-km',\r\n              enabled: types.indexOf('bornes-km') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repère', 'km']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.gcc',\r\n              value: 'bornes-gcc',\r\n              enabled: types.indexOf('bornes-gcc') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repère', 'gcc', 'ccg']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cn',\r\n              value: 'bornes-cn',\r\n              enabled: types.indexOf('bornes-cn') !== -1,\r\n              hashtags: ['borne', 'bornes', 'cn']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.sumi',\r\n              value: 'bornes-sumi',\r\n              enabled: types.indexOf('bornes-sumi') !== -1,\r\n              hashtags: ['borne', 'bornes', 'sumi']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.hq',\r\n              value: 'hq',\r\n              enabled: types.indexOf('hq') !== -1,\r\n              hashtags: ['hq']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cadastre',\r\n              value: 'cadastre',\r\n              enabled: types.indexOf('cadastre') !== -1,\r\n              hashtags: ['cadastre']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30 || !ecmax\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'loc',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.map',\r\n              value: 'true',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.quebec',\r\n              value: 'false',\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(term, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http.get(`${this.searchUrl}/geocode`, { params }).pipe(\r\n      map((response: IChercheResponse) => this.extractResults(response, term)),\r\n      catchError((err) => {\r\n        err.error.toDisplay = true;\r\n        err.error.title = this.languageService.translate.instant(\r\n          this.getDefaultOptions().title\r\n        );\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          const regex = new RegExp(`^${v.value}(\\\\.|$)`);\r\n          const typesMatched = types.filter((value) => regex.test(value));\r\n          v.available = typesMatched.length > 0;\r\n          if (v.value === 'lieux') {\r\n            this.hashtagsLieuxToKeep = [\r\n              ...(new Set(\r\n                typesMatched\r\n                  .map((t) => t.split('.'))\r\n                  .reduce((a, b) => a.concat(b))\r\n                  .filter((t) => t !== 'lieux')\r\n              ) as any)\r\n            ];\r\n          }\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    const queryParams: any = Object.assign(\r\n      {\r\n        geometry: true,\r\n        bbox: true,\r\n        icon: true,\r\n        type:\r\n          'adresses,codes-postaux,municipalites,mrc,regadmin,lieux,entreprises,bornes-sumi'\r\n      },\r\n      this.params,\r\n      this.computeOptionsParam(term, options || {}).params,\r\n      {\r\n        q: this.computeTerm(term),\r\n        page: options.page\r\n      }\r\n    );\r\n\r\n    if (queryParams.loc === 'true') {\r\n      const [xMin, yMin, xMax, yMax] = options.extent;\r\n      queryParams.loc = `${xMin},${yMin};${xMax},${yMin};${xMax},${yMax};${xMin},${yMax};${xMin},${yMin}`;\r\n    } else if (queryParams.loc === 'false') {\r\n      delete queryParams.loc;\r\n    }\r\n\r\n    if (/#[A-Za-z]+/.test(queryParams.q)) {\r\n      queryParams.type = 'lieux';\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(queryParams),\r\n      encoder: new IgoHttpParameterCodec()\r\n    });\r\n  }\r\n\r\n  private extractResults(response: IChercheResponse, term: string): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheData) => {\r\n      return this.formatter.formatResult(this.dataToResult(data, term, response));\r\n    });\r\n  }\r\n\r\n  private dataToResult(\r\n    data: IChercheData,\r\n    term: string,\r\n    response?: IChercheResponse\r\n  ): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.highlight.title || data.properties.nom;\r\n    const subtitleHtml = data.highlight.title2\r\n      ? ' <small> ' + data.highlight.title2 + '</small>'\r\n      : '';\r\n    const subtitleHtml2 = data.highlight.title3\r\n      ? '<br><small> ' + data.highlight.title3 + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml + subtitleHtml2,\r\n        icon: data.icon || 'map-marker',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.nom),\r\n        nextPage:\r\n          response.features.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    if (!data.geometry) {\r\n      return Object.assign({ type: data.index }, properties);\r\n    }\r\n\r\n    const googleLinksProperties: {\r\n      GoogleMaps: string;\r\n      GoogleStreetView?: string;\r\n    } = {\r\n      GoogleMaps: ''\r\n    };\r\n\r\n    let googleMaps;\r\n    if (data.geometry.type === 'Point') {\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    } else {\r\n      const point = pointOnFeature(data.geometry);\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        point.geometry.coordinates[0],\r\n        point.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    let googleMapsNom;\r\n    if (data.index === 'routes') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + data.properties.municipalite\r\n      );\r\n    } else if (data.index === 'municipalites') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + 'ville'\r\n      );\r\n    } else if (data.index === 'mrc') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        'mrc+' + data.properties.nom\r\n      );\r\n    } else if (data.index === 'regadmin') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ',+QC'\r\n      );\r\n    } else {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom || data.highlight.title\r\n      );\r\n    }\r\n\r\n    googleLinksProperties.GoogleMaps =\r\n      '<a href=' +\r\n      googleMaps +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByCoord') +\r\n      '</a> <br /> <a href=' +\r\n      googleMapsNom +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByName') +\r\n      '</a>';\r\n\r\n    if (data.geometry.type === 'Point') {\r\n      googleLinksProperties.GoogleStreetView = GoogleLinks.getGoogleStreetViewLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(\r\n      { type: data.index },\r\n      properties,\r\n      googleLinksProperties,\r\n      routing\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    // Keep hashtags for \"lieux\"\r\n    const hashtags = term.match(/(#[A-Za-z]+)/g) || [];\r\n    let keep = false;\r\n    keep = hashtags.some((hashtag) => {\r\n      const hashtagKey = hashtag.substring(1);\r\n      return this.hashtagsLieuxToKeep.some(\r\n        (h) =>\r\n          h\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '') ===\r\n          hashtagKey\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n      );\r\n    });\r\n\r\n    if (!keep) {\r\n      term = term.replace(/(#[A-Za-z]+)/g, '');\r\n    }\r\n\r\n    return term.replace(/[^\\wÀ-ÿ !\\-\\+\\(\\)\\.\\/½¼¾,'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n}\r\n\r\n/**\r\n * IChercheReverse search source\r\n */\r\n@Injectable()\r\nexport class IChercheReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'icherchereverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    injector: Injector,\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const types =\r\n      this.options.params && this.options.params.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : ['adresses', 'municipalites', 'mrc', 'regadmin'];\r\n\r\n    return {\r\n      title: 'igo.geo.search.ichercheReverse.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              available: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.district',\r\n              value: 'arrondissements',\r\n              enabled: types.indexOf('arrondissements') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'radius',\r\n          name: 'bufferInput',\r\n          values: [\r\n            {\r\n              title: '100 m',\r\n              value: 100,\r\n              enabled: !this.options.distance || this.options.distance === 100\r\n            },\r\n            {\r\n              title: '500 m',\r\n              value: 500,\r\n              enabled: this.options.distance === 500\r\n            },\r\n            {\r\n              title: '1 km',\r\n              value: 1000,\r\n              enabled: this.options.distance === 1000\r\n            },\r\n            {\r\n              title: '2 km',\r\n              value: 2000,\r\n              enabled: this.options.distance === 2000\r\n            },\r\n            {\r\n              title: '5 km',\r\n              value: 5000,\r\n              enabled: this.options.distance === 5000\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    return this.http.get(`${this.searchUrl}/locate`, { params }).pipe(\r\n      map((response: IChercheReverseResponse) => {\r\n        return this.extractResults(response);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          v.available = types.indexOf(v.value as string) > -1;\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    if (options.distance || this.options.distance) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        bufferInput: options.distance || this.options.distance\r\n      });\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          loc: lonLat.join(','),\r\n          sort: 'distance',\r\n          geometry: true,\r\n          icon: true\r\n        },\r\n        options.params || {},\r\n        this.params\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: IChercheReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private getSubtitle(data: IChercheReverseData) {\r\n    if (!this.settings.length) {\r\n      return '';\r\n    }\r\n    let subtitle = '';\r\n    switch (data.properties.type) {\r\n      case 'arrondissements':\r\n        subtitle = data.properties.municipalite + ' (Arrondissement)';\r\n        break;\r\n      default:\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        const type = typeSetting.values.find(\r\n          (t) => t.value === data.properties.type\r\n        );\r\n        if (type) {\r\n          subtitle = this.languageService.translate.instant(type.title);\r\n        }\r\n    }\r\n    return subtitle;\r\n  }\r\n\r\n  private dataToResult(data: IChercheReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.properties.nom;\r\n    const subtitleHtml = ' <small> ' + this.getSubtitle(data) + '</small>';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.icon || 'map-marker',\r\n        pointerSummaryTitle: this.getSubtitle(data)+ ': ' + data.properties.nom\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheReverseData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheReverseSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(properties, routing);\r\n  }\r\n\r\n  private computeExtent(\r\n    data: IChercheReverseData\r\n  ): [number, number, number, number] | undefined {\r\n    return data.bbox\r\n      ? [data.bbox[0], data.bbox[2], data.bbox[1], data.bbox[3]]\r\n      : undefined;\r\n  }\r\n}\r\n","import { Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  IChercheSearchSource,\r\n  IChercheSearchResultFormatter,\r\n  IChercheReverseSearchSource\r\n} from './icherche';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultIChercheSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new IChercheSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultIChercheSearchResultFormatter() {\r\n  return {\r\n    provide: IChercheSearchResultFormatter,\r\n    useFactory: defaultIChercheSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ICherche search source factory\r\n * @ignore\r\n */\r\nexport function ichercheSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: IChercheSearchResultFormatter,\r\n  injector: Injector\r\n) {\r\n  return new IChercheSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheSearchSource.id}`),\r\n    formatter,\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search source\r\n */\r\nexport function provideIChercheSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheSearchSourceFactory,\r\n    multi: true,\r\n    deps: [\r\n      HttpClient,\r\n      LanguageService,\r\n      StorageService,\r\n      ConfigService,\r\n      IChercheSearchResultFormatter,\r\n      Injector\r\n    ]\r\n  };\r\n}\r\n\r\n/**\r\n * IChercheReverse search source factory\r\n * @ignore\r\n */\r\nexport function ichercheReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  injector: Injector\r\n) {\r\n  return new IChercheReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheReverseSearchSource.id}`),\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideIChercheReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, Injector]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport * as olproj from 'ol/proj';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport * as olformat from 'ol/format';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, ReverseSearch } from './source';\r\nimport { SearchSourceOptions, ReverseSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { GoogleLinks } from '../../../utils/googleLinks';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { lonLatConversion, roundCoordTo, convertDDToDMS } from '../../../map/shared/map.utils';\r\nimport { OsmLinks } from '../../../utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class CoordinatesSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n/**\r\n * CoordinatesReverse search source\r\n */\r\n@Injectable()\r\nexport class CoordinatesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'coordinatesreverse';\r\n  static type = FEATURE;\r\n\r\n  private projections;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    @Inject('options') options: SearchSourceOptions,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('projections') projections: Projection[],\r\n  ) {\r\n    super(options, storageService);\r\n    this.projections = projections;\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return CoordinatesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CoordinatesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'igo.geo.search.coordinates.name',\r\n      order: 1,\r\n      showInSettings: false\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param options options of ReverseSearchOptions (distance, conf, zoom, params)\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    return of([this.dataToResult(lonLat, options)]);\r\n  }\r\n\r\n  private dataToResult(data: [number, number], options: ReverseSearchOptions): SearchResult<Feature> {\r\n    const dataDMS = convertDDToDMS(data);\r\n    const convertedCoord = lonLatConversion(data, this.projections);\r\n    const coords = convertedCoord.reduce((obj, item) => (\r\n      obj[item.alias] = item.igo2CoordFormat, obj), {});\r\n\r\n    const roundedCoordString = roundCoordTo(data, 6).join(', ');\r\n    const roundedCoordStringDMS = dataDMS.join(', ');\r\n\r\n    let geometry: FeatureGeometry = {\r\n      type: 'Point',\r\n      coordinates: [data[0], data[1]]\r\n    };\r\n\r\n    const properties = {};\r\n    let subtitleHtml = '';\r\n    if (options.distance) {\r\n      const radiusKey = this.languageService.translate.instant('igo.geo.search.coordinates.radius');\r\n      properties[radiusKey] = options.distance;\r\n      subtitleHtml = '<br><small>Rayon: ' + options.distance + ' m</small>';\r\n\r\n      // Create polygon\r\n      const center = olproj.transform([data[0], data[1]], 'EPSG:4326', 'EPSG:3857');\r\n      const circleGeometry = new OlCircle(center, options.distance);\r\n      const polygonGeometry = fromCircle(circleGeometry);\r\n      const writer = new olformat.GeoJSON();\r\n      geometry = JSON.parse(writer.writeGeometry(polygonGeometry.transform('EPSG:3857', 'EPSG:4326')));\r\n    }\r\n\r\n    if (options.conf) {\r\n      const confKey = this.languageService.translate.instant('igo.geo.search.coordinates.conf');\r\n      properties[confKey] = options.conf;\r\n      subtitleHtml += subtitleHtml === '' ? '<br>' : '<small> - </small>';\r\n      subtitleHtml += '<small>Confiance: ' + options.conf + '%</small>';\r\n    }\r\n\r\n    const coordKey = this.languageService.translate.instant('igo.geo.search.coordinates.coord');\r\n    properties[coordKey] = roundedCoordString;\r\n\r\n    const coordKeyDMS = this.languageService.translate.instant('igo.geo.search.coordinates.coordDMS');\r\n    properties[coordKeyDMS] = roundedCoordStringDMS;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent: undefined,\r\n        properties: Object.assign(\r\n          properties,\r\n          coords,\r\n          {\r\n            GoogleMaps: GoogleLinks.getGoogleMapsCoordLink(data[0], data[1]),\r\n            GoogleStreetView: GoogleLinks.getGoogleStreetViewLink(\r\n              data[0],\r\n              data[1]\r\n            ),\r\n            OpenStreetMap: OsmLinks.getOpenStreetMapLink(data[0], data[1], 14),\r\n            Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n          }\r\n        ),\r\n        meta: {\r\n          id: data[0].toString() + ',' + data[1].toString(),\r\n          title: roundedCoordString\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id: data[0].toString() + ',' + data[1].toString(),\r\n        title: roundedCoordString,\r\n        titleHtml: roundedCoordString + subtitleHtml,\r\n        icon: 'map-marker',\r\n        score: 100, // every coord exists\r\n      }\r\n    };\r\n  }\r\n}\r\n","import { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  CoordinatesReverseSearchSource,\r\n  CoordinatesSearchResultFormatter\r\n} from './coordinates';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { ProjectionService } from '../../../map/shared/projection.service';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultCoordinatesSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new CoordinatesSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultCoordinatesSearchResultFormatter() {\r\n  return {\r\n    provide: CoordinatesSearchResultFormatter,\r\n    useFactory: defaultCoordinatesSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * CoordinatesReverse search source factory\r\n * @ignore\r\n */\r\nexport function CoordinatesReverseSearchSourceFactory(\r\n  config: ConfigService,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  _projectionService: ProjectionService\r\n) {\r\n  return new CoordinatesReverseSearchSource(\r\n    config.getConfig(`searchSources.${CoordinatesReverseSearchSource.id}`),\r\n    languageService,\r\n    storageService,\r\n    (config.getConfig('projections') as Projection[]) || []\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideCoordinatesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: CoordinatesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService, LanguageService, StorageService, ProjectionService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\nimport { LAYER } from '../../../layer';\r\nimport { QueryableDataSourceOptions, QueryFormat } from '../../../query';\r\nimport { QueryHtmlTarget } from './../../../query/shared/query.enums';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { TextSearchOptions } from './source.interfaces';\r\nimport {\r\n  ILayerSearchSourceOptions,\r\n  ILayerData,\r\n  ILayerItemResponse,\r\n  ILayerServiceResponse,\r\n  ILayerDataSource\r\n} from './ilayer.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class ILayerSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(data: ILayerData): ILayerData {\r\n    const allowedKey = [\r\n      'title',\r\n      'abstract',\r\n      'groupTitle',\r\n      'metadataUrl',\r\n      'downloadUrl',\r\n      'urlInfo',\r\n      'name'\r\n    ];\r\n\r\n    const property = Object.entries(data.properties)\r\n      .filter(([key]) => allowedKey.indexOf(key) !== -1)\r\n      .reduce((out: { [key: string]: any }, entries: [string, any]) => {\r\n        const [key, value] = entries;\r\n        let newKey;\r\n        try {\r\n          newKey = this.languageService.translate.instant(\r\n            'igo.geo.search.ilayer.properties.' + key\r\n          );\r\n        } catch (e) {\r\n          newKey = key;\r\n        }\r\n        out[newKey] = value ? value : '';\r\n        return out;\r\n      }, {});\r\n\r\n    const dataR = Object.assign({}, data);\r\n    dataR.properties = property as ILayerDataSource;\r\n\r\n    return dataR;\r\n  }\r\n}\r\n\r\n/**\r\n * ILayer search source\r\n */\r\n@Injectable()\r\nexport class ILayerSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'ilayer';\r\n  static type = LAYER;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: ILayerSearchSourceOptions,\r\n    @Inject(ILayerSearchResultFormatter)\r\n    private formatter: ILayerSearchResultFormatter\r\n  ) {\r\n    super(options, storageService);\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return ILayerSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return ILayerSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): ILayerSearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n    return {\r\n      title: 'igo.geo.search.ilayer.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.layer',\r\n              value: 'layer',\r\n              enabled: true,\r\n              hashtags: ['layer', 'layers', 'couche', 'couches']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.groupLayer',\r\n              value: 'group',\r\n              enabled: false,\r\n              hashtags: ['gr-layer', 'gr-layers', 'gr-couche', 'gr-couches']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50 || !ecmax\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a layer by name or keyword\r\n   * @param term Layer name or keyword\r\n   * @returns Observable of <SearchResult<LayerOptions>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<ILayerItemResponse>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q') || !params.get('type')) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(\r\n        map((response: ILayerServiceResponse) => this.extractResults(response, term))\r\n      );\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(\r\n        Object.assign(\r\n          {\r\n            q: this.computeTerm(term)\r\n          },\r\n          this.params,\r\n          this.computeOptionsParam(term, options || {}).params,\r\n          {\r\n            page: options.page\r\n          }\r\n        )\r\n      )\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    return term.replace(/(#[^\\s]*)/g, '').replace(/[^\\wÀ-ÿ !\\-\\(\\),'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  private extractResults(\r\n    response: ILayerServiceResponse, term: string\r\n  ): SearchResult<ILayerItemResponse>[] {\r\n    return response.items.map((data: ILayerData) =>\r\n    this.dataToResult(data, term, response)\r\n    );\r\n  }\r\n\r\n  private dataToResult(\r\n    data: ILayerData,\r\n    term: string,\r\n    response?: ILayerServiceResponse\r\n  ): SearchResult<ILayerItemResponse> {\r\n    const layerOptions = this.computeLayerOptions(data);\r\n\r\n    const titleHtml = data.highlight.title || data.properties.title;\r\n    const groupTitle = data.highlight.groupTitle || data.properties.groupTitle;\r\n    const subtitleHtml = groupTitle\r\n      ? ' <small style=\"color: #6f6969\"> ' + groupTitle + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: LAYER,\r\n        id: [this.getId(), data.properties.id].join('.'),\r\n        title: data.properties.title,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.properties.type === 'Layer' ? 'layers' : 'map',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.name),\r\n        nextPage:\r\n          response.items.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      },\r\n      data: layerOptions\r\n    };\r\n  }\r\n\r\n  private computeLayerOptions(data: ILayerData): ILayerItemResponse {\r\n    const url = data.properties.url;\r\n    const queryParams: QueryableDataSourceOptions = this.extractQueryParamsFromSourceUrl(\r\n      url\r\n    );\r\n    return ObjectUtils.removeUndefined({\r\n      sourceOptions: {\r\n        id: data.properties.id,\r\n        type: data.properties.format,\r\n        url,\r\n        queryFormat: queryParams.queryFormat,\r\n        queryHtmlTarget: queryParams.queryHtmlTarget,\r\n        params: data.properties.format === 'wms' ? {LAYERS: data.properties.name} : undefined,\r\n        layer: data.properties.format === 'wms' ? undefined : data.properties.name,\r\n        optionsFromCapabilities: true,\r\n        crossOrigin: 'anonymous'\r\n      },\r\n      title: data.properties.title,\r\n      maxResolution: getResolutionFromScale(\r\n        Number(data.properties.maxScaleDenom)\r\n      ),\r\n      minResolution: getResolutionFromScale(\r\n        Number(data.properties.minScaleDenom)\r\n      ),\r\n      metadata: {\r\n        url: data.properties.metadataUrl,\r\n        extern: data.properties.metadataUrl ? true : undefined,\r\n        abstract: data.properties.abstract || undefined\r\n      },\r\n      properties: this.formatter.formatResult(data).properties\r\n    });\r\n  }\r\n\r\n  private extractQueryParamsFromSourceUrl(\r\n    url: string\r\n  ): { queryFormat: QueryFormat; queryHtmlTarget: QueryHtmlTarget } {\r\n    let queryFormat;\r\n    let queryHtmlTarget;\r\n    const formatOpt = (this.options as ILayerSearchSourceOptions).queryFormat;\r\n    if (formatOpt) {\r\n      for (const key of Object.keys(formatOpt)) {\r\n        const value = formatOpt[key];\r\n        if (value === '*') {\r\n          queryFormat = QueryFormat[key.toUpperCase()];\r\n          break;\r\n        }\r\n\r\n        const urls = ((value as any) as { urls: string[] }).urls;\r\n        if (Array.isArray(urls)) {\r\n          urls.forEach(urlOpt => {\r\n            if (url.indexOf(urlOpt) !== -1) {\r\n              queryFormat = QueryFormat[key.toUpperCase()];\r\n            }\r\n          });\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (\r\n        queryFormat === QueryFormat.HTML ||\r\n        queryFormat === QueryFormat.HTMLGML2\r\n      ) {\r\n        queryHtmlTarget = 'iframe';\r\n      }\r\n    }\r\n\r\n    return {\r\n      queryFormat,\r\n      queryHtmlTarget\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { ILayerSearchSource, ILayerSearchResultFormatter } from './ilayer';\r\n\r\n/**\r\n * ILayer search result formatter factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new ILayerSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search result formatter\r\n */\r\nexport function provideILayerSearchResultFormatter() {\r\n  return {\r\n    provide: ILayerSearchResultFormatter,\r\n    useFactory: ilayerSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ILayer search source factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: ILayerSearchResultFormatter\r\n) {\r\n  return new ILayerSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${ILayerSearchSource.id}`),\r\n    formatter\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search source\r\n */\r\nexport function provideILayerSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ilayerSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, ILayerSearchResultFormatter]\r\n  };\r\n}\r\n","import { FEATURE } from '../../feature';\r\nimport { LAYER } from '../../layer';\r\n\r\nexport const SEARCH_TYPES = [FEATURE, LAYER];\r\n","<div class=\"igo-search-selector\">\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-selector-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSelectorMenu\">\r\n    <mat-icon svgIcon=\"menu-down\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #searchSelectorMenu=\"matMenu\"\r\n    class=\"no-border-radius\"\r\n    xPosition=\"before\"\r\n    yPosition=\"above\">\r\n    <mat-radio-group\r\n      class=\"igo-search-selector-radio-group\"\r\n      [value]=\"searchType$ | async\"\r\n      (change)=\"onSearchTypeChange($event.value)\">\r\n      <mat-radio-button *ngFor=\"let searchType of searchTypes\" [value]=\"searchType\">\r\n        {{getSearchTypeTitle(searchType) | translate}}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n  </mat-menu>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-selector',\r\n  templateUrl: './search-selector.component.html',\r\n  styleUrls: ['./search-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSelectorComponent implements OnInit, OnDestroy {\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * The search type enabled\r\n   */\r\n  @Input()\r\n  set searchType(value: string) { this.setSearchType(value); }\r\n  get searchType(): string { return this.searchType$.value; }\r\n\r\n  /**\r\n   * Event emitted when the enabled search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  constructor(private searchSourceService: SearchSourceService) {}\r\n\r\n  ngOnInit() {\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Enable the selected search type\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Get a search type's title. The title\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  getSearchTypeTitle(searchType: string) {\r\n    return `igo.geo.search.${searchType.toLowerCase()}.title`;\r\n  }\r\n\r\n  /**\r\n   * Emit an event and enable the search sources of the given type.\r\n   * @param searchType Search type\r\n   */\r\n  private setSearchType(searchType: string | undefined) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchTypeChange.emit(searchType);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { SearchSelectorComponent } from './search-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatTabsModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSelectorComponent],\r\n  declarations: [SearchSelectorComponent]\r\n})\r\nexport class IgoSearchSelectorModule {}\r\n","<div class=\"igo-search-settings\">\r\n\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-settings-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSettingsMenu\">\r\n    <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n  </button>\r\n  <mat-menu\r\n    #searchSettingsMenu=\"matMenu\"\r\n    class=\"no-border-radius\">\r\n    <div class=\"checkAllButton\" *ngIf=\"getSearchSources().length>4\">\r\n      <button mat-raised-button\r\n        (click)=\"checkUncheckAllSources($event)\">{{!searchSourcesAllEnabled  ? ('igo.geo.search.searchSources.unselectAll' | translate): ('igo.geo.search.searchSources.selectAll' | translate)}}</button>\r\n    </div>\r\n      <ng-container *ngFor=\"let source of getSearchSources()\">\r\n        <span class=\"igo-search-settings-search-source\">\r\n          <mat-checkbox\r\n            class=\"igo-search-settings-checkbox\"\r\n            [checked]=\"source.enabled\"\r\n            [value]=\"source\"\r\n            (click)=\"$event.stopPropagation()\"\r\n            (change)=\"onCheckSearchSource($event, source)\">\r\n          </mat-checkbox>\r\n          <button *ngIf=\"source.settings.length > 0\"\r\n            [matMenuTriggerFor]=\"sub_menu\"\r\n            mat-menu-item>{{source.title}}\r\n          </button>\r\n          <button\r\n            mat-menu-item\r\n            *ngIf=\"source.settings.length === 0\">\r\n            {{source.title}}\r\n          </button>\r\n        </span>\r\n          <mat-menu #sub_menu=\"matMenu\">\r\n            <ng-container *ngFor=\"let setting of source.settings\">\r\n              <button\r\n                  mat-menu-item\r\n                  [matMenuTriggerFor]=\"test_sub_menu\">\r\n                {{'igo.geo.search.searchSources.settings.'+ setting.title | translate}}\r\n              </button>\r\n              <mat-menu #test_sub_menu=\"matMenu\"\r\n                [ngSwitch]=\"setting.type\"\r\n                yPosition=\"above\">\r\n                <span *ngSwitchCase=\"'radiobutton'\">\r\n                  <mat-radio-group\r\n                    class=\"igo-search-settings-radio-group\"\r\n                    [value]=\"setting\">\r\n                    <mat-radio-button *ngFor=\"let settingValue of setting.values\"\r\n                      class=\"mat-typography\"\r\n                      [value]=\"settingValue\"\r\n                      [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                      [checked]=\"settingValue.enabled\"\r\n                      (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"settingsValueCheckedRadioButton($event, source, setting, settingValue)\">\r\n                      {{settingValue.title | translate}}\r\n                    </mat-radio-button>\r\n                  </mat-radio-group>\r\n                </span>\r\n                <span *ngSwitchCase=\"'checkbox'\">\r\n                  <div class=\"checkAllButton\" *ngIf=\"setting.values.length > 3\">\r\n                    <button mat-raised-button\r\n                      (click)=\"checkUncheckAll($event, source, setting)\">{{setting.allEnabled || setting.allEnabled === undefined  ? ('igo.geo.search.searchSources.settings.unselectAll' | translate): ('igo.geo.search.searchSources.settings.selectAll' | translate)}}</button>\r\n                  </div>\r\n                  <mat-checkbox *ngFor=\"let settingValue of getAvailableValues(setting)\"\r\n                    class=\"mat-menu-item\"\r\n                    [style.display]=\"displayBlock\"\r\n                    [checked]=\"settingValue.enabled\"\r\n                    [value]=\"setting\"\r\n                    [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                    (click)=\"$event.stopPropagation()\"\r\n                    (change)=\"settingsValueCheckedCheckbox($event, source, setting, settingValue)\">\r\n                    {{settingValue.title | translate}}\r\n                  </mat-checkbox>\r\n                </span>\r\n              </mat-menu>\r\n            </ng-container>\r\n          </mat-menu>\r\n      </ng-container>\r\n      <span *ngIf=\"hasPointerReverseSearchSource && !isTouchScreen\">\r\n        <mat-divider></mat-divider>\r\n        <span class=\"pointer-summary-slide-toggle-container mat-typography\">\r\n          <mat-slide-toggle class=\"pointer-summary-option\" (change)=\"changePointerReverseSearch($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.pointerSearchSummary.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"pointerSummaryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.pointerSearchSummary.title' | translate}}\r\n          </mat-slide-toggle>\r\n          <mat-slide-toggle class=\"pointer-summary-option\" (change)=\"changeSearchResultsGeometry($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.searchResultsGeometry.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"searchResultsGeometryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.searchResultsGeometry.title' | translate}}\r\n          </mat-slide-toggle>\r\n        </span>\r\n      </span>\r\n  </mat-menu>\r\n</div>\r\n","import { MatCheckboxChange } from '@angular/material/checkbox';\r\nimport { MatRadioChange } from '@angular/material/radio';\r\n\r\nimport {\r\n  Component,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  HostListener,\r\n  Input\r\n} from '@angular/core';\r\n\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\nimport { SearchSource } from '../shared/sources/source';\r\nimport {\r\n  SearchSourceSettings,\r\n  SettingOptions\r\n} from '../shared/sources/source.interfaces';\r\nimport {\r\n  sourceCanReverseSearchAsSummary,\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch\r\n} from '../shared/search.utils';\r\nimport { MediaService, StorageService } from '@igo2/core';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-settings',\r\n  templateUrl: './search-settings.component.html',\r\n  styleUrls: ['./search-settings.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSettingsComponent implements OnInit {\r\n  public hasPointerReverseSearchSource: boolean = false;\r\n  public searchSourcesAllEnabled: boolean = false;\r\n\r\n  public buffer = [];\r\n  public lastKeyTime = Date.now();\r\n\r\n  public displayBlock = 'block';\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the enabled search source changes\r\n   */\r\n  @Output() searchSourceChange = new EventEmitter<SearchSource>();\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry summary is changed\r\n   */\r\n  @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    if (event.key === 'F2') {\r\n      this.pointerSummaryEnabled = !this.pointerSummaryEnabled;\r\n      this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.hasPointerReverseSearchSource = this.hasReverseSearchSourcesForPointerSummary();\r\n  }\r\n\r\n  /**\r\n   * Get all search sources\r\n   * @internal\r\n   */\r\n  getSearchSources(): SearchSource[] {\r\n    const textSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n\r\n    const reverseSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanReverseSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n    const sources = textSearchSources.concat(reverseSearchSources);\r\n    this.computeSourcesCheckAllBehavior(sources);\r\n    return sources;\r\n  }\r\n\r\n  /**\r\n   * Get all search sources usable for pointer summary\r\n   * @internal\r\n   */\r\n  hasReverseSearchSourcesForPointerSummary(): boolean {\r\n    if (\r\n      this.searchSourceService\r\n        .getEnabledSources()\r\n        .filter(sourceCanReverseSearchAsSummary).length\r\n    ) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (checkbox style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedCheckbox(\r\n    event: MatCheckboxChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    settingValue.enabled = event.checked;\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (settings)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSettingCheckAllBehavior(setting: SearchSourceSettings) {\r\n    if (setting.allEnabled === undefined) {\r\n      if (setting.values.find((settingValue) => settingValue.enabled)) {\r\n        setting.allEnabled = false;\r\n      } else {\r\n        setting.allEnabled = true;\r\n      }\r\n    } else {\r\n      setting.allEnabled = !setting.allEnabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (sources)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSourcesCheckAllBehavior(sources: SearchSource[]) {\r\n    const enabledSourcesCnt = sources.filter((source) => source.enabled).length;\r\n    const disabledSourcesCnt = sources.filter((source) => !source.enabled)\r\n      .length;\r\n    this.searchSourcesAllEnabled =\r\n      enabledSourcesCnt >= disabledSourcesCnt ? false : true;\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAll(event, source: SearchSource, setting: SearchSourceSettings) {\r\n    event.stopPropagation();\r\n    this.computeSettingCheckAllBehavior(setting);\r\n    setting.values.forEach((settingValue) => {\r\n      settingValue.enabled = setting.allEnabled;\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAllSources(event) {\r\n    event.stopPropagation();\r\n    this.getSearchSources().map((source) => {\r\n      source.enabled = this.searchSourcesAllEnabled;\r\n      this.searchSourceChange.emit(source);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (radiobutton style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedRadioButton(\r\n    event: MatRadioChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    setting.values.forEach((conf) => {\r\n      if (conf.value !== settingValue.value) {\r\n        conf.enabled = !event.source.checked;\r\n      } else {\r\n        conf.enabled = event.source.checked;\r\n      }\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  onCheckSearchSource(event: MatCheckboxChange, source: SearchSource) {\r\n    source.enabled = event.checked;\r\n    const storage = (this.storageService.get(source.getId() + '.options') || {}) as SettingOptions;\r\n    storage.enabled = source.enabled;\r\n    this.storageService.set(\r\n      source.getId() + '.options',\r\n      storage\r\n    );\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  getAvailableValues(setting: SearchSourceSettings) {\r\n    return setting.values.filter((s) => s.available !== false);\r\n  }\r\n\r\n  getAvailableHashtagsValues(setting: SettingOptions) {\r\n    if (setting.hashtags) {\r\n      return setting.hashtags.map((h) => '#' + h).join(', ');\r\n    }\r\n    return;\r\n  }\r\n\r\n  stopPropagation(event) {\r\n    event.stopPropagation();\r\n  }\r\n\r\n  changePointerReverseSearch(event) {\r\n    this.pointerSummaryEnabled = event.checked;\r\n    this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n  }\r\n\r\n  changeSearchResultsGeometry(event) {\r\n    this.searchResultsGeometryEnabled = event.checked;\r\n    this.searchResultsGeometryStatus.emit(this.searchResultsGeometryEnabled);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { SearchSettingsComponent } from './search-settings.component';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  declarations: [SearchSettingsComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatCheckboxModule,\r\n    MatDividerModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSettingsComponent]\r\n})\r\nexport class IgoSearchSettingsModule { }\r\n","<div class=\"igo-search-bar-container\" [ngClass]=\"{empty: empty$ | async}\">\r\n  <mat-form-field [floatLabel]=\"floatLabel\" [appearance]=\"appearance\">\r\n    <mat-label *ngIf=\"label\">{{label}}</mat-label>\r\n    <input\r\n      #input\r\n      matInput\r\n      autocomplete=\"off\"\r\n      [ngClass]=\"{'hasSearchIcon': searchIcon}\"\r\n      [disabled]=\"disabled$ | async\"\r\n      [placeholder]=\"placeholder ? placeholder : (placeholder$ | async) ? (placeholder$.value | translate) : undefined\"\r\n      [value]=\"term$ | async\"\r\n      (keyup)=\"onKeyup($event)\"\r\n      (touchend)=\"onKeyup($event)\">\r\n  </mat-form-field>\r\n\r\n  <div class=\"search-bar-buttons\">\r\n    <button\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      *ngIf=\"searchIcon !== undefined\">\r\n      <mat-icon svgIcon=\"{{searchIcon}}\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      *ngIf=\"(empty$ | async)===false\"\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      (click)=\"onClearButtonClick()\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-search-selector\r\n      *ngIf=\"searchSelector\"\r\n      [searchTypes]=\"searchTypes\"\r\n      [searchType]=\"searchType$ | async\"\r\n      (searchTypeChange)=\"onSearchTypeChange($event)\">\r\n    </igo-search-selector>\r\n\r\n    <igo-search-settings\r\n      *ngIf=\"searchSettings\"\r\n      [pointerSummaryEnabled]=\"pointerSummaryEnabled\"\r\n      (pointerSummaryStatus)=\"pointerSummaryStatus.emit($event)\"\r\n      [searchResultsGeometryEnabled]=\"searchResultsGeometryEnabled\"\r\n      (searchResultsGeometryStatus)=\"searchResultsGeometryStatus.emit($event)\"\r\n      (searchSourceChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-settings>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport {\r\n  FloatLabelType,\r\n  MatFormFieldAppearance\r\n} from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce, distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * Searchbar that triggers a research in all search sources enabled.\r\n * If the store input is defined, the search results will be loaded\r\n * into that store. An event is always emitted when a research is completed.\r\n */\r\n@Component({\r\n  selector: 'igo-search-bar',\r\n  templateUrl: './search-bar.component.html',\r\n  styleUrls: ['./search-bar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchBarComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Invalid keys\r\n   */\r\n  static invalidKeys = [\r\n    'Control',\r\n    'Shift',\r\n    'Alt',\r\n    'ArrowDown',\r\n    'ArrowUp',\r\n    'ArrowRight',\r\n    'ArrowLeft'\r\n  ];\r\n\r\n  readonly placeholder$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.search.placeholder'\r\n  );\r\n\r\n  readonly empty$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  /**\r\n   * Subscription to the ssearch bar term\r\n   */\r\n  private term$$: Subscription;\r\n\r\n  /**\r\n   * Search term stream\r\n   */\r\n  private stream$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Subscription to the search term stream\r\n   */\r\n  private stream$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  private researches$$: Subscription[];\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set searchType(value: string) {\r\n    this.setSearchType(value);\r\n  }\r\n  get searchType(): string {\r\n    return this.searchType$.value;\r\n  }\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated by the searchbar setting\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry setting is changed\r\n   */\r\n   @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this.setTerm(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n  readonly term$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Whether this component is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) {\r\n    this.disabled$.next(value);\r\n  }\r\n  get disabled(): boolean {\r\n    return this.disabled$.value;\r\n  }\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n  /**\r\n   * Whether a float label should be displayed\r\n   */\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  @Input() appearance: MatFormFieldAppearance = 'legacy';\r\n\r\n  @Input() placeholder: string;\r\n\r\n  @Input() label: string;\r\n\r\n  /**\r\n   * Icons color (search and clear)\r\n   */\r\n  @Input() color = 'primary';\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Debounce time between each keystroke\r\n   */\r\n  @Input() debounce = 200;\r\n\r\n  /**\r\n   * Minimum term length required to trigger a research\r\n   */\r\n  @Input() minLength = 2;\r\n\r\n  /**\r\n   * Search icon\r\n   */\r\n  @Input() searchIcon: string;\r\n\r\n  /**\r\n   * Search Selector\r\n   */\r\n  @Input() searchSelector = false;\r\n\r\n  /**\r\n   * Search Settings\r\n   */\r\n  @Input() searchSettings = false;\r\n\r\n  /**\r\n   * Force coordinates in north america\r\n   */\r\n  @Input() forceNA = false;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * Event emitted when the search term changes\r\n   */\r\n  @Output() searchTermChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed\r\n   */\r\n  @Output() search = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() clearFeature = new EventEmitter();\r\n\r\n  /**\r\n   * Event emitted when the search settings changes\r\n   */\r\n  @Output() searchSettingsChange = new EventEmitter();\r\n\r\n  /**\r\n   * Input element\r\n   * @internal\r\n   */\r\n  @ViewChild('input', { static: true }) input: ElementRef;\r\n\r\n  /**\r\n   * Whether the search bar is empty\r\n   * @internal\r\n   */\r\n  get empty(): boolean {\r\n    return this.term.length === 0;\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe((term: string) => {\r\n      this.empty$.next(term === undefined || term.length === 0);\r\n    });\r\n\r\n    this.stream$$ = this.stream$\r\n      .pipe(\r\n        debounce((term: string) => (term === '' ? EMPTY : timer(this.debounce)))\r\n      )\r\n      .subscribe((term: string) => this.onSetTerm(term));\r\n\r\n    this.handlePlaceholder();\r\n\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the search term stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.term$$.unsubscribe();\r\n    this.stream$$.unsubscribe();\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When a user types, validates the key and send it into the\r\n   * stream if it's valid\r\n   * @param event Keyboard event\r\n   * @internal\r\n   */\r\n  onKeyup(event: KeyboardEvent) {\r\n    const key = event.key;\r\n    if (!this.keyIsValid(key)) {\r\n      return;\r\n    }\r\n    const term = (event.target as HTMLInputElement).value;\r\n    this.setTerm(term);\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   * @internal\r\n   */\r\n  onClearButtonClick() {\r\n    this.clear();\r\n    this.clearFeature.emit();\r\n  }\r\n\r\n  /**\r\n   * Update search type\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Update the placeholder with the enabled search type. The placeholder\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  setSearchType(searchType: string) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.doSearch(this.term);\r\n    this.searchSettingsChange.emit();\r\n    this.handlePlaceholder();\r\n  }\r\n\r\n  /**\r\n   * Send the term into the stream only if this component is not disabled\r\n   * @param term Search term\r\n   */\r\n  setTerm(term: string) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    term = term || '';\r\n\r\n    if (term !== this.term) {\r\n      this.term$.next(term);\r\n    }\r\n\r\n    const slug = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (slug.length >= this.minLength || slug.length === 0) {\r\n      this.stream$.next(term);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   */\r\n  private clear() {\r\n    this.term$.next('');\r\n    this.stream$.next('');\r\n    this.input.nativeElement.focus();\r\n  }\r\n\r\n  /**\r\n   * Validate if a given key stroke is a valid input\r\n   */\r\n  private keyIsValid(key: string) {\r\n    return SearchBarComponent.invalidKeys.indexOf(key) === -1;\r\n  }\r\n\r\n  /**\r\n   * When the search term changes, emit an event and trigger a\r\n   * research in every enabled search sources.\r\n   * @param term Search term\r\n   */\r\n  private onSetTerm(term: string | undefined) {\r\n    this.searchTermChange.emit(term);\r\n    this.doSearch(term);\r\n  }\r\n\r\n  private handlePlaceholder() {\r\n    const searchTypes = [\r\n      ...new Set(\r\n        this.searchSourceService\r\n          .getEnabledSources()\r\n          .filter((ss) => !['map', 'coordinatesreverse'].includes(ss.getId()))\r\n          .map((ss) => ss.getType())\r\n      )\r\n    ];\r\n\r\n    let placeholder = `igo.geo.search.placeholder`;\r\n    if (searchTypes.length === 1) {\r\n      placeholder = `igo.geo.search.${searchTypes[0].toLowerCase()}.placeholder`;\r\n    } else if (searchTypes.length === 0) {\r\n      placeholder = `igo.geo.search.emptyType.placeholder`;\r\n    }\r\n    this.placeholder$.next(placeholder);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchTypeChange.emit(searchType);\r\n\r\n    const placeholder = `igo.geo.search.${searchType.toLowerCase()}.placeholder`;\r\n    this.placeholder$.next(placeholder);\r\n\r\n    this.setTerm(this.term);\r\n  }\r\n\r\n  /**\r\n   * Execute the search\r\n   * @param term Search term\r\n   */\r\n  private doSearch(rawTerm: string | undefined) {\r\n    if (this.researches$$) {\r\n      this.researches$$.map((research) => research.unsubscribe());\r\n      this.researches$$ = undefined;\r\n    }\r\n\r\n    let terms;\r\n    if (this.termSplitter && rawTerm.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = rawTerm.split(this.termSplitter).filter((t) => t.length >= this.minLength);\r\n      if (this.store) {\r\n        this.store.clear();\r\n      }\r\n    } else {\r\n      terms = [rawTerm];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      const slug = term ? term.replace(/(#[^\\s]*)/g, '').trim() : '';\r\n      if (slug === '') {\r\n        if (this.store !== undefined) {\r\n          this.store.clear();\r\n        }\r\n        return;\r\n      }\r\n\r\n      researches = researches.concat(this.searchService.search(term, {\r\n        forceNA: this.forceNA\r\n      }));\r\n    });\r\n    this.researches$$ = researches.map((research) => {\r\n      return research.request.subscribe((results: SearchResult[]) => {\r\n        this.onResearchCompleted(research, results);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * When a research  is completed, emit an event and update\r\n   * the store's items.\r\n   * @param research Research\r\n   * @param results Research results\r\n   */\r\n  private onResearchCompleted(research: Research, results: SearchResult[]) {\r\n    this.search.emit({ research, results });\r\n\r\n    if (this.store !== undefined) {\r\n      const newResults = this.store\r\n        .all()\r\n        .filter((result) => result.source !== research.source)\r\n        .concat(results);\r\n      this.store.updateMany(newResults);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoSearchSelectorModule } from '../search-selector/search-selector.module';\r\nimport { IgoSearchSettingsModule } from '../search-settings/search-settings.module';\r\nimport { SearchBarComponent } from './search-bar.component';\r\nimport { SearchUrlParamDirective } from './search-url-param.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    IgoLanguageModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    SearchBarComponent,\r\n  ],\r\n  declarations: [\r\n    SearchBarComponent,\r\n    SearchUrlParamDirective\r\n  ]\r\n})\r\nexport class IgoSearchBarModule {}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"icon\" mat-list-avatar svgIcon=\"{{showIcons ? icon : 'blank'}}\"></mat-icon>\r\n\r\n  <h4 matLine *ngIf=\"titleHtml\" [innerHtml]=\"titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"tooltipHtml\" matTooltipClass=\"search-result-tooltip\"></h4>\r\n  <h4 matLine *ngIf=\"!titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"title\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"withZoomButton\"\r\n    igoStopPropagation\r\n    mat-icon-button\r\n    (click)=\"onZoomHandler()\">\r\n    <mat-icon svgIcon=\"magnify\"></mat-icon>\r\n  </button>\r\n\r\n  <ng-content\r\n    select=[igoSearchItemToolbar]>\r\n  </ng-content>\r\n\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, EventEmitter, Output } from '@angular/core';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport {\r\n  getEntityTitle,\r\n  getEntityTitleHtml,\r\n  getEntityIcon\r\n} from '@igo2/common';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { FeatureMotion, moveToOlFeatures } from '../../feature';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Search results list item\r\n */\r\n@Component({\r\n  selector: 'igo-search-results-item',\r\n  templateUrl: './search-results-item.component.html',\r\n  styleUrls: ['./search-results-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsItemComponent {\r\n  /**\r\n   * Search result item\r\n   */\r\n  @Input() result: SearchResult;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search result title\r\n   * @internal\r\n   */\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  @Output() zoomEvent = new EventEmitter<boolean>();\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get title(): string {\r\n    return getEntityTitle(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result HTML title\r\n   * @internal\r\n   */\r\n  get titleHtml(): string {\r\n    return getEntityTitleHtml(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result tooltip\r\n   * @internal\r\n   */\r\n  get tooltipHtml(): string {\r\n    return this.titleHtml\r\n      .replace(/<small?[^>]+(>|$)/g, '\\n')\r\n      .replace(/<\\/?[^>]+(>|$)/g, '');\r\n  }\r\n\r\n  /**\r\n   * Search result icon\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.result);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  onZoomHandler() {\r\n    const olFeature = this.format.readFeature(this.result.data, {\r\n      dataProjection: this.result.data.projection,\r\n      featureProjection: this.map.projection\r\n    });\r\n    moveToOlFeatures(this.map, [olFeature], FeatureMotion.Default);\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <ng-template\r\n    #groupTemplate\r\n    ngFor let-group\r\n    [ngForOf]=\"results$ | async\">\r\n\r\n    <igo-collapsible [class]=\"group.source.getId()\"\r\n      *ngIf=\"mode === searchResultMode.Grouped; else flatTemplate\"\r\n      [title]=\"computeGroupTitle(group)\"\r\n      [collapsed]=\"collapsed[group.source.title]\"\r\n      (toggle)=\"collapsed[group.source.title] = $event\">\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </igo-collapsible>\r\n\r\n    <ng-template #flatTemplate>\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </ng-template>\r\n\r\n    <ng-template #storeItemTemplate let-results=\"results\">\r\n      <ng-template ngFor let-result [ngForOf]=\"results\">\r\n        <igo-search-results-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [map]=\"map\"\r\n          [result]=\"result\"\r\n          [showIcons]=\"showIcons\"\r\n          [withZoomButton]=\"withZoomButton\"\r\n          [focused]=\"store.state.get(result).focused\"\r\n          [selected]=\"store.state.get(result).selected\"\r\n          (focus)=\"resultFocus.emit(result)\"\r\n          (unfocus)=\"resultUnfocus.emit(result)\"\r\n          (select)=\"onResultSelect(result)\"\r\n          (mouseenter)=\"resultFocus.emit(result)\"\r\n          (mouseleave)=\"resultUnfocus.emit(result)\">\r\n\r\n          <ng-container igoSearchItemToolbar\r\n            [ngTemplateOutlet]=\"templateSearchToolbar\"\r\n            [ngTemplateOutletContext]=\"{result: result}\">\r\n          </ng-container>\r\n\r\n        </igo-search-results-item>\r\n      </ng-template>\r\n      <span class=\"moreResults mat-typography\" *ngIf=\"isMoreResults(group)\" (click)=\"displayMoreResults(group)\">\r\n        <u>{{ 'igo.geo.search.displayMoreResults' | translate }}</u>\r\n      </span>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ContentChild,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { Observable, EMPTY, timer, BehaviorSubject, Subscription } from 'rxjs';\r\nimport { debounce, map } from 'rxjs/operators';\r\n\r\nimport { EntityState, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { TextSearchOptions } from '../shared/sources/source.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchSource } from '../shared/sources/source';\r\n\r\nexport enum SearchResultMode {\r\n  Grouped = 'grouped',\r\n  Flat = 'flat'\r\n}\r\n\r\n/**\r\n * List of search results with focus and selection capabilities.\r\n * This component is dumb and only emits events.\r\n */\r\n@Component({\r\n  selector: 'igo-search-results',\r\n  templateUrl: './search-results.component.html',\r\n  styleUrls: ['./search-results.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Reference to the SearchResultMode enum\r\n   * @internal\r\n   */\r\n  public searchResultMode = SearchResultMode;\r\n\r\n  /**\r\n   * Search results store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<SearchResult>;\r\n\r\n  private settingsChange$$: Subscription;\r\n\r\n  public pageIterator: {sourceId: string}[] = [];\r\n\r\n  public collapsed: {sourceId: string}[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Search results display mode\r\n   */\r\n  @Input() mode: SearchResultMode = SearchResultMode.Grouped;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.pageIterator = [];\r\n  }\r\n  public _term: string;\r\n\r\n  @Input() settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Event emitted when a result is focused\r\n   */\r\n  @Output() resultFocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is unfocused\r\n   */\r\n  @Output() resultUnfocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is selected\r\n   */\r\n  @Output() resultSelect = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed after displaying more results is clicked\r\n   */\r\n  @Output() moreResults = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Events emitted when a result is focus or unfocus by mouse event\r\n   */\r\n  @Output() resultMouseenter = new EventEmitter<SearchResult>();\r\n  @Output() resultMouseleave = new EventEmitter<SearchResult>();\r\n\r\n  @ContentChild('igoSearchItemToolbar', /* TODO: add static flag */ {}) templateSearchToolbar: TemplateRef<any>;\r\n\r\n  get results$(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    if (this._results$ === undefined) {\r\n      this._results$ = this.liftResults();\r\n    }\r\n    return this._results$;\r\n  }\r\n  private _results$: Observable<\r\n    {source: SearchSource; results: SearchResult[]}[]\r\n  >;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n              private searchService: SearchService) {}\r\n\r\n  /**\r\n   * Bind the search results store to the watcher\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.settingsChange$$ = this.settingsChange$.subscribe(() => {\r\n      this.pageIterator = [];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unbind the search results store from the watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.settingsChange$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Compute a group title\r\n   * @param group Search results group\r\n   * @returns Group title\r\n   * @internal\r\n   */\r\n  computeGroupTitle(group: {source: SearchSource; results: SearchResult[]}): string {\r\n    const parts = [group.source.title];\r\n    const count = group.results.length;\r\n    if (count > 1) {\r\n      parts.push(`(${count})`);\r\n    }\r\n    return parts.join(' ');\r\n  }\r\n\r\n  /**\r\n   * When a result is selected, update it's state in the store and emit\r\n   * an event. A selected result is also considered focused\r\n   * @param result Search result\r\n   * @internal\r\n   */\r\n  onResultSelect(result: SearchResult) {\r\n    if (this.store.state.get(result)) {\r\n      if (this.store.state.get(result).selected === true) {\r\n        return;\r\n      }\r\n    }\r\n    this.store.state.update(result, {focused: true, selected: true}, true);\r\n    this.resultSelect.emit(result);\r\n  }\r\n\r\n  /**\r\n   * Return an observable of the search results, grouped by search source\r\n   * @returns Observable of grouped search results\r\n   * @internal\r\n   */\r\n   private liftResults(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    return this.store.stateView.all$().pipe(\r\n      debounce((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return results.length === 0 ? EMPTY : timer(200);\r\n      }),\r\n      map((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return this.groupResults(results.map(r => r.entity).sort(this.sortByOrder));\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n  private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n    return r1.source.displayOrder - r2.source.displayOrder;\r\n  }\r\n\r\n  /**\r\n   * Group results by search source\r\n   * @param results Search results from all sources\r\n   * @returns Search results grouped by source\r\n   */\r\n  private groupResults(results: SearchResult[]): {source: SearchSource; results: SearchResult[]}[] {\r\n    const grouped = new Map<SearchSource, SearchResult[]>();\r\n    results.forEach((result: SearchResult) => {\r\n      const source = result.source;\r\n      let sourceResults = grouped.get(source);\r\n      if (sourceResults === undefined) {\r\n        sourceResults = [];\r\n        grouped.set(source, sourceResults);\r\n      }\r\n      sourceResults.push(result);\r\n    });\r\n\r\n    return Array.from(grouped.keys()).map((source: SearchSource) => {\r\n      if (this.pageIterator[source.getId()] === undefined) {\r\n        this.pageIterator[source.getId()] = 1;\r\n      }\r\n      return {source, results: grouped.get(source)};\r\n    });\r\n  }\r\n\r\n  isMoreResults(group: { source: SearchSource; results: SearchResult[] }) {\r\n    // getStrategyOfType is to avoid display more result based on a filtered state\r\n    const stategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    const active = stategy?.active || false;\r\n    return !active && group.results &&\r\n      group.results[group.results.length - 1].meta.nextPage === true;\r\n  }\r\n\r\n  displayMoreResults(group: {source: SearchSource; results: SearchResult[]}) {\r\n    const options: TextSearchOptions = {\r\n      sourceId: group.source.getId(),\r\n      page: ++this.pageIterator[group.source.getId()]\r\n    };\r\n\r\n    let terms;\r\n    if (this.termSplitter && this.term.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = this.term.split(this.termSplitter);\r\n    } else {\r\n      terms = [this.term];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      researches = researches.concat(this.searchService.search(term, options));\r\n    });\r\n\r\n    researches.map(research => {\r\n      research.request.subscribe((results: SearchResult[]) => {\r\n        const newResults = group.results.concat(results);\r\n        if (!results.length) {\r\n          newResults[newResults.length - 1].meta.nextPage = false;\r\n        }\r\n        this.moreResults.emit({research, results: newResults});\r\n      });\r\n    });\r\n    return;\r\n  }\r\n}\r\n","<button\r\nigoStopPropagation\r\n(mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n*ngIf=\"layer.meta.dataType === 'Layer'\"\r\nmat-icon-button\r\ntooltip-position=\"below\"\r\nmatTooltipShowDelay=\"500\"\r\n[matTooltip]=\"(tooltip$ | async) | translate\"\r\n[color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n(click)=\"onToggleClick($event)\">\r\n<mat-icon\r\n  matBadge=\"icon\"\r\n  igoMatBadgeIcon=\"eye-off\"\r\n  igoMatBadgeInverseColor=\"true\"\r\n  [matBadgeHidden]=\"(inRange$ | async)\"\r\n  matBadgeDisabled=\"true\"\r\n  matBadgeSize=\"small\"\r\n  matBadgePosition=\"after\"\r\n  [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n</mat-icon>\r\n</button>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayerOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { LAYER } from '../../layer/shared/layer.enums';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-search-add-button',\r\n  templateUrl: './search-results-add-button.component.html',\r\n  styleUrls: ['./search-results-add-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultAddButtonComponent implements OnInit, OnDestroy {\r\n  public tooltip$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.catalog.layer.addToMap'\r\n  );\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private layersSubcriptions = [];\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() layer: SearchResult;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added: boolean;\r\n\r\n  /**\r\n   * The map to add the search result layer to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private layerService: LayerService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    if (this.layer.meta.dataType === 'Layer') {\r\n      this.added =\r\n        this.map.layers.findIndex(\r\n          lay => lay.id === this.layer.data.sourceOptions.id\r\n        ) !== -1;\r\n    }\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(value => {\r\n      this.isInResolutionsRange(value);\r\n      this.tooltip$.next(this.computeTooltip());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addLayerToMap();\r\n    }\r\n  }\r\n\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.removeLayerFromMap();\r\n      this.layersSubcriptions.map(s => s.unsubscribe());\r\n      this.layersSubcriptions = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private addLayerToMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const layerOptions = (this.layer as SearchResult<LayerOptions>).data;\r\n    if (layerOptions.sourceOptions.optionsFromApi === undefined) {\r\n      layerOptions.sourceOptions.optionsFromApi = true;\r\n    }\r\n    this.layersSubcriptions.push(\r\n      this.layerService\r\n        .createAsyncLayer(layerOptions)\r\n        .subscribe(layer => this.map.addLayer(layer))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private removeLayerFromMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const oLayer = this.map.getLayerById(this.layer.data.sourceOptions.id);\r\n    this.map.removeLayer(oLayer);\r\n  }\r\n\r\n  isInResolutionsRange(resolution: number) {\r\n    const minResolution = this.layer.data.minResolution || 0;\r\n    const maxResolution = this.layer.data.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      resolution >= minResolution && resolution <= maxResolution\r\n    );\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoStopPropagationModule\r\n} from '@igo2/common';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { SearchResultsComponent } from './search-results.component';\r\nimport { SearchResultsItemComponent } from './search-results-item.component';\r\nimport { SearchResultAddButtonComponent } from './search-results-add-button.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatButtonModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoMetadataModule,\r\n  ],\r\n  exports: [\r\n    SearchResultsComponent,\r\n    SearchResultAddButtonComponent\r\n  ],\r\n  declarations: [\r\n    SearchResultsComponent,\r\n    SearchResultsItemComponent,\r\n    SearchResultAddButtonComponent\r\n  ]\r\n})\r\nexport class IgoSearchResultsModule {}\r\n","import { FeatureGeometry } from './../../feature/shared/feature.interfaces';\r\nimport {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  AfterContentChecked\r\n} from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchService } from './search.service';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport { transform } from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport * as olgeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { SearchResult, Research } from './search.interfaces';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion, FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { sourceCanReverseSearchAsSummary } from './search.utils';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoSearchPointerSummary]'\r\n})\r\nexport class SearchPointerSummaryDirective implements OnInit, OnDestroy, AfterContentChecked {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private lonLat: [number, number];\r\n  private pointerSearchStore: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n  private reverseSearch$$: Subscription[] = [];\r\n  private hasPointerReverseSearchSource: boolean = false;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private searchPointerSummaryFeatureId: string = 'searchPointerSummaryFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoSearchPointerSummaryDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], {map: this.map});\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      if (this.store && !layers.find(l => l.id === 'searchPointerSummaryId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id : 'searchPointerSummaryId',\r\n      title: 'searchPointerSummary',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: pointerPositionSummaryMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n  }\r\n\r\n  ngAfterContentChecked(): void {\r\n      if (!this.searchSourceService.getEnabledSources().filter(sourceCanReverseSearchAsSummary).length) {\r\n        this.hasPointerReverseSearchSource = false;\r\n      } else {\r\n        this.hasPointerReverseSearchSource = true;\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unsubscribeReverseSearch();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerSearchStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Build an object based on the closest feature by type (base on type and distance properties )\r\n   * @param results SearchResult[]\r\n   * @returns OL style function\r\n   */\r\n  private computeSummaryClosestFeature(results: SearchResult[]): {} {\r\n    const closestResultByType = {};\r\n\r\n    results.map(result => {\r\n      if (result.data.properties.type && result.data.properties.distance >= 0) {\r\n        if (closestResultByType.hasOwnProperty(result.data.properties.type)) {\r\n          const prevDistance = closestResultByType[result.data.properties.type].distance;\r\n          if (result.data.properties.distance < prevDistance) {\r\n            const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n            closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n          }\r\n        } else {\r\n          const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n          closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n        }\r\n      }\r\n    });\r\n\r\n    return closestResultByType;\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: SearchResult[]) {\r\n    const closestResultByType = this.computeSummaryClosestFeature(resultsUnderPointerPosition);\r\n    const summarizedClosestType = Object.keys(closestResultByType);\r\n    const processedSummarizedClosestType = [];\r\n    const summary = [];\r\n    resultsUnderPointerPosition.map(result => {\r\n      const typeIndex = summarizedClosestType.indexOf(result.data.properties.type);\r\n      if (typeIndex !== -1) {\r\n        summary.push(closestResultByType[result.data.properties.type].title);\r\n        summarizedClosestType.splice(typeIndex, 1);\r\n        processedSummarizedClosestType.push(result.data.properties.type);\r\n      } else {\r\n        if (processedSummarizedClosestType.indexOf(result.data.properties.type) === -1) {\r\n          summary.push(result.meta.pointerSummaryTitle || result.meta.title);\r\n        }\r\n      }\r\n    });\r\n    if (summary.length) {\r\n      this.addPointerOverlay(summary.join('\\n'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n  /**\r\n   * Unsubscribe to reverse seatch store.\r\n   * @internal\r\n   */\r\n  unsubscribeReverseSearch() {\r\n    this.reverseSearch$$.map(s => s.unsubscribe());\r\n    this.reverseSearch$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger reverse search when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoSearchPointerSummaryEnabled ||\r\n      !this.hasPointerReverseSearchSource || this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n      this.clearLayer();\r\n      this.unsubscribeReverseSearch();\r\n    }\r\n\r\n    this.lonLat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.onSearchCoordinate();\r\n    }, this.igoSearchPointerSummaryDelay);\r\n  }\r\n\r\n    /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n     private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n      return r1.source.displayOrder - r2.source.displayOrder;\r\n    }\r\n\r\n  private onSearchCoordinate() {\r\n    this.pointerSearchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonLat, { params: { geometry: 'false', icon: 'false' } }, true);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        this.reverseSearch$$.push(\r\n          results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n            this.onSearch({ research: results[i], results: _results });\r\n          }));\r\n      }\r\n    }\r\n  }\r\n\r\n  private onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    const newResults = this.pointerSearchStore.all()\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.pointerSearchStore.load(newResults.sort(this.sortByOrder));\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addPointerOverlay(text: string) {\r\n    this.clearLayer();\r\n\r\n    const geometry = new olgeom.Point(\r\n      transform(this.lonLat, 'EPSG:4326', this.mapProjection)\r\n    );\r\n    const feature = new olFeature({ geometry });\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.mapProjection,\r\n      dataProjection: this.mapProjection\r\n    }) as FeatureGeometry;\r\n\r\n    const f: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.mapProjection,\r\n      properties: {\r\n        id: this.searchPointerSummaryFeatureId,\r\n        pointerSummary: text\r\n      },\r\n      meta: {\r\n        id: this.searchPointerSummaryFeatureId\r\n      },\r\n      ol: feature\r\n    };\r\n    this.store.setLayerFeatures([f], FeatureMotion.None);\r\n  }\r\n\r\n/**\r\n * Clear the pointer store features\r\n */\r\nprivate clearLayer() {\r\n  if (this.store) {\r\n    this.store.clearLayer();\r\n  }\r\n}\r\n\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function pointerPositionSummaryMarker(feature: olFeature<OlGeometry>, resolution: number): olstyle.Style {\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: './assets/igo2/geo/icons/cross_black_18px.svg',\r\n      imgSize: [18, 18], // for ie\r\n    }),\r\n\r\n    text: new olstyle.Text({\r\n      text: feature.get('pointerSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'bottom',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      backgroundFill: new olstyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new olstyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: -10,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { SearchService } from './shared/search.service';\r\nimport { provideSearchSourceService } from './shared/search-source-service.providers';\r\nimport { provideDefaultIChercheSearchResultFormatter } from './shared/sources/icherche.providers';\r\nimport { provideDefaultCoordinatesSearchResultFormatter } from './shared/sources/coordinates.providers';\r\nimport { provideILayerSearchResultFormatter } from './shared/sources/ilayer.providers';\r\n\r\nimport { IgoSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoSearchSelectorModule } from './search-selector/search-selector.module';\r\nimport { IgoSearchResultsModule } from './search-results/search-results.module';\r\nimport { IgoSearchSettingsModule } from './search-settings/search-settings.module';\r\nimport { SearchPointerSummaryDirective } from './shared/search-pointer-summary.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule,\r\n    SearchPointerSummaryDirective\r\n  ],\r\n  declarations: [SearchPointerSummaryDirective]\r\n})\r\nexport class IgoSearchModule {\r\n  static forRoot(): ModuleWithProviders<IgoSearchModule> {\r\n    return {\r\n      ngModule: IgoSearchModule,\r\n      providers: [\r\n        SearchService,\r\n        provideSearchSourceService(),\r\n        provideDefaultIChercheSearchResultFormatter(),\r\n        provideDefaultCoordinatesSearchResultFormatter(),\r\n        provideILayerSearchResultFormatter()\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { OnUpdateInputs, WidgetComponent } from '@igo2/common';\r\n\r\nimport { Layer } from '../../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Event emitted on complete\r\n   */\r\n  @Output() complete = new EventEmitter<void>();\r\n\r\n  /**\r\n   * Event emitted on cancel\r\n   */\r\n  @Output() cancel = new EventEmitter<void>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Implemented as part of OnUpdateInputs\r\n   */\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * On close, emit the cancel event\r\n   */\r\n  onClose() {\r\n    this.cancel.emit();\r\n  }\r\n\r\n}\r\n","<igo-ogc-filterable-item\r\n  igoListItem\r\n  [layer]=\"layer\"\r\n  [header]=\"false\" \r\n  [map]=\"map\" >\r\n</igo-ogc-filterable-item>","import { InjectionToken } from '@angular/core';\r\n\r\nimport { Widget, WidgetService } from '@igo2/common';\r\n\r\nimport { OgcFilterComponent } from './ogc-filter/ogc-filter.component';\r\n\r\nexport const OgcFilterWidget = new InjectionToken<Widget>('OgcFilterWidget');\r\n\r\nexport function ogcFilterWidgetFactory(widgetService: WidgetService): Widget {\r\n  return widgetService.create(OgcFilterComponent);\r\n}\r\n\r\nexport function provideOgcFilterWidget() {\r\n  return {\r\n    provide: OgcFilterWidget,\r\n    useFactory: ogcFilterWidgetFactory,\r\n    deps: [WidgetService]\r\n  };\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFilterModule } from '../../../filter/filter.module';\r\nimport { OgcFilterComponent } from './ogc-filter.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [OgcFilterComponent],\r\n  declarations: [OgcFilterComponent]\r\n})\r\nexport class IgoOgcFilterModule {}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface WfsWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class WfsWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: WfsWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\n\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { StorageService } from '@igo2/core';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): WfsWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n    const wks = new WfsWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate } from '@igo2/common';\r\nimport { StorageService } from '@igo2/core';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy } from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { WfsWorkspace } from './wfs-workspace';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WmsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private layerService: LayerService, private storageService: StorageService) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): WfsWorkspace {\r\n    if (\r\n      !layer.options.workspace ||\r\n      map.layers.find(lay => lay.id === layer.id + '.WfsWorkspaceTableDest') ||\r\n      layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      bidirectionnal: true,\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n\r\n    let wks;\r\n    let wksLayerOption = {\r\n      srcId: layer.id,\r\n      workspaceId: undefined,\r\n      enabled: false,\r\n      queryOptions: {\r\n        mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n        tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n      },\r\n      pageSize: layer.options.workspace?.pageSize,\r\n      pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n    };\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        isIgoInternalLayer: true,\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: wksLayerOption,\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          queryFormatAsWms: (dataSource.options as QueryableDataSourceOptions).queryFormatAsWms,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters$.value, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        if (!layer.options.workspace?.enabled) {\r\n          return;\r\n        }\r\n        wks = new WfsWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        });\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            enabled: true,\r\n            srcId: layer.id,\r\n            workspaceId: workspaceLayer.id,\r\n            queryOptions: {\r\n              mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n              tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n            },\r\n            pageSize: layer.options.workspace?.pageSize,\r\n            pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { LanguageService } from '@igo2/core';\r\nimport { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  type: string;\r\n  cancel: boolean;\r\n}\r\n\r\n@Component({\r\n    selector: 'igo-confirmation-popup-component',\r\n    templateUrl: './confirmation-popup.component.html',\r\n    styleUrls: ['./confirmation-popup.component.scss']\r\n  })\r\n  export class ConfirmationPopupComponent {\r\n\r\n    constructor(\r\n      public dialogRef: MatDialogRef<ConfirmationPopupComponent>,\r\n      public languageService: LanguageService,\r\n      @Inject(MAT_DIALOG_DATA) public data: {type: string, cancel: boolean}) {}\r\n\r\n    cancelAction() {\r\n      this.data.cancel = true;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n\r\n    confirmedAction() {\r\n      this.data.cancel = false;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n  }\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">{{data.type === 'add' ?\r\n    languageService.translate.instant('igo.geo.workspace.addConfirmation') :\r\n    languageService.translate.instant('igo.geo.workspace.deleteConfirmation')}}</p>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    (click)=\"confirmedAction()\">Ok\r\n  </button>\r\n  <button\r\n    mat-raised-button\r\n    (click)=\"cancelAction()\">{{languageService.translate.instant('igo.geo.workspace.cancel')}}\r\n  </button>\r\n</div>","import { MatDialog } from '@angular/material/dialog';\r\nimport {\r\n  Workspace,\r\n  WorkspaceOptions,\r\n  EntityRecord\r\n} from '@igo2/common';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { EditionWorkspaceService } from './edition-workspace.service';\r\nimport { ConfirmationPopupComponent } from '../confirmation-popup/confirmation-popup.component';\r\nimport { DrawControl } from '../../geometry';\r\nimport { createInteractionStyle, GeometryType } from '../../draw';\r\nimport { featureToOl } from '../../feature';\r\n\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport * as OlStyle from 'ol/style';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport Collection from 'ol/Collection';\r\nimport OlFeature from 'ol/Feature';\r\nimport { FeatureDataSource } from '../../datasource/shared';\r\n\r\nexport interface EditionWorkspaceOptions extends WorkspaceOptions {\r\n  layer: ImageLayer | VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class EditionWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): ImageLayer | VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  private drawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private olDrawingLayerSource = new OlVectorSource();\r\n  private olDrawingLayer: VectorLayer;\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n  public modify; // Reference to the ol interaction\r\n\r\n  public modifyStyle = new OlStyle.Style({\r\n    stroke: new OlStyle.Stroke({\r\n      color: 'rgba(255,255,255,1)',\r\n      width: 1\r\n    }),\r\n    fill: new OlStyle.Fill({\r\n      color: 'rgba(0,161,222,1)'\r\n    }),\r\n    image: new OlStyle.Circle({\r\n      radius: 7,\r\n      stroke: new OlStyle.Stroke({\r\n        color: 'rgba(255,255,255,1)',\r\n        width: 1\r\n      }),\r\n      fill: new OlStyle.Fill({\r\n        color: 'rgba(0,161,222,1)'\r\n      })\r\n    })\r\n  });\r\n\r\n  private filterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.newFeature === true;\r\n  };\r\n\r\n  public fillColor: string;\r\n  public strokeColor: string;\r\n  public strokeWidth: number;\r\n\r\n  constructor(\r\n    protected options: EditionWorkspaceOptions,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private dialog: MatDialog,\r\n    private configService: ConfigService) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n\r\n    this.drawControl = this.createDrawControl();\r\n    this.drawControl.setGeometryType(this.geometryType.Point as any);\r\n\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n\r\n    this.olDrawingLayer = new VectorLayer({\r\n      id: 'igo-draw-layer',\r\n      title: 'edition',\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      },\r\n    });\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n\r\n  deleteFeature(feature, workspace) {\r\n    setTimeout(() => {\r\n      const dialogRef = this.dialog.open(ConfirmationPopupComponent, {\r\n        disableClose: false,\r\n        data: {type: 'delete'}\r\n    });\r\n\r\n      dialogRef.afterClosed().subscribe(result => {\r\n        if (result === false) {\r\n          const baseUrl = workspace.layer.dataSource.options.edition.baseUrl;\r\n          const deleteUrl = workspace.layer.dataSource.options.edition.deleteUrl;\r\n          let id;\r\n          let url;\r\n          if (baseUrl) {\r\n            url = this.configService.getConfig('edition.url') + baseUrl + '?' + deleteUrl;\r\n          } else {\r\n            url = this.configService.getConfig('edition.url') + deleteUrl;\r\n          }\r\n\r\n          for (const column of workspace.meta.tableTemplate.columns) {\r\n            for (const property in feature.properties) {\r\n              let columnName = column.name;\r\n              if (columnName.includes('properties.')) {\r\n                columnName = columnName.split('.')[1];\r\n              }\r\n              if (columnName === property && column.primary === true) {\r\n                id = feature.properties[property];\r\n              }\r\n            }\r\n          }\r\n          if (url) {\r\n            url += id;\r\n            this.editionWorkspaceService.deleteFeature(workspace, url);\r\n          }\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  editFeature(feature, workspace: EditionWorkspace) {\r\n    feature.edition = true;\r\n    let id;\r\n    let find = false;\r\n    const editionOpt = workspace.layer.dataSource.options.edition;\r\n    for (const column of workspace.meta.tableTemplate.columns ) {\r\n\r\n      // Update domain list\r\n      if (column.type === 'list' || column.type === 'autocomplete') {\r\n        this.editionWorkspaceService.getDomainValues(column.relation.table).subscribe(result => {\r\n          column.domainValues = result;\r\n        });\r\n      }\r\n      if (find === false) {\r\n        for (const property in feature.properties) {\r\n          let columnName = column.name;\r\n          if (columnName.includes('properties.')) {\r\n            columnName = columnName.split('.')[1];\r\n          }\r\n          if (columnName === property && column.primary === true) {\r\n            id = feature.properties[property];\r\n            find = true;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (id) {\r\n      feature.original_properties = JSON.parse(JSON.stringify(feature.properties));\r\n      feature.original_geometry = feature.geometry;\r\n      feature.idkey = id;\r\n      this.addFeatureToStore(feature, workspace);\r\n    } else {\r\n      // Only for edition with it's own geometry\r\n      if (!feature.newFeature && editionOpt.geomType) {\r\n        feature.newFeature = true;\r\n        this.editionWorkspaceService.adding$.next(true);\r\n        workspace.entityStore.state.updateAll({ newFeature: false });\r\n        workspace.entityStore.stateView.filter(this.filterClauseFunc);\r\n        if (editionOpt.addWithDraw) {\r\n          const geometryType = editionOpt.geomType;\r\n          this.onGeometryTypeChange(geometryType, feature, workspace);\r\n        } else {\r\n          workspace.entityStore.insert(feature);\r\n          workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(fillColor?: string, strokeColor?: string, strokeWidth?: number) {\r\n    const drawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.olDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(fillColor, strokeColor, strokeWidth),\r\n    });\r\n\r\n    return drawControl;\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: typeof OlGeometryType, feature, workspace: EditionWorkspace) {\r\n      this.drawControl.setGeometryType(geometryType);\r\n      this.toggleDrawControl(feature, workspace);\r\n    }\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl(feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  public deactivateDrawControl() {\r\n    if (!this.drawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.drawControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.drawEnd$$ = this.drawControl.end$.subscribe((olGeometry: OlGeometry) => {\r\n      this.addFeatureToStore(feature, workspace, olGeometry);\r\n    });\r\n\r\n    this.drawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to layer. The loading strategy of the layer\r\n   * will trigger and add the feature to the workspace store.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(feature, workspace: EditionWorkspace, olGeometry?: OlGeometry) {\r\n    const projection = this.map.ol.getView().getProjection();\r\n    let geometry = feature.geometry;\r\n\r\n    // If an olGeometry is passed, it means that it is a new feature\r\n    if (olGeometry) {\r\n      workspace.entityStore.insert(feature);\r\n      workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n      geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n        featureProjection: projection,\r\n        dataProjection: 'EPSG:4326'\r\n      }) as any;\r\n\r\n      feature.geometry = geometry;\r\n    }\r\n\r\n    feature.projection = 'EPSG:4326';\r\n\r\n    const featureOl = featureToOl(feature, projection.getCode());\r\n\r\n    this.olDrawingLayer.dataSource.ol.clear();\r\n    this.olDrawingLayer.dataSource.ol.addFeature(featureOl);\r\n    this.map.addLayer(this.olDrawingLayer);\r\n\r\n    this.deactivateDrawControl();\r\n    this.createModifyInteraction(featureOl, feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Delete drawings layer and source from the map AND feature from the entity store.\r\n   * Layer refresh will automatically add the new feature into the store.\r\n   */\r\n  deleteDrawings() {\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n    this.olDrawingLayerSource.clear();\r\n    this.map.ol.removeInteraction(this.modify);\r\n  }\r\n\r\n  /**\r\n   * Create a modify interaction to allow a geometry change one feature at the time (drag and drop)\r\n   */\r\n  createModifyInteraction(olFeature: OlFeature<OlGeometry>, feature, workspace: EditionWorkspace) {\r\n    this.map.ol.removeInteraction(this.modify);\r\n    const olCollection = new Collection([olFeature], { unique: true });\r\n    this.modify = new OlModify({\r\n      features: olCollection\r\n    });\r\n\r\n    this.map.ol.addInteraction(this.modify);\r\n    olCollection.forEach(feature => {\r\n      feature.setStyle(this.modifyStyle);\r\n    });\r\n\r\n    this.modify.on('modifyend', (event) => {\r\n      const olGeometry = event.features.getArray()[0]?.getGeometry();\r\n      if (olGeometry) {\r\n        this.addFeatureToStore(feature, workspace, olGeometry);\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse, HttpHeaders } from '@angular/common/http';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate,\r\n  EntityTableButton} from '@igo2/common';\r\nimport { ConfigService, LanguageService, MessageService, StorageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { catchError, map, skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy} from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { EditionWorkspace } from './edition-workspace';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { BehaviorSubject, Observable, throwError } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionWorkspaceService {\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n  public adding$ = new BehaviorSubject<boolean>(false);\r\n  public relationLayers$ = new BehaviorSubject<ImageLayer[] | VectorLayer[]>(undefined);\r\n  public rowsInMapExtentCheckCondition$ = new BehaviorSubject<boolean>(true);\r\n  public loading = false;\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private http: HttpClient,\r\n    private dialog: MatDialog,\r\n    public authInterceptor?: AuthInterceptor) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): EditionWorkspace {\r\n    if (layer.options.workspace?.enabled !== true || layer.dataSource.options.edition.enabled !== true) {\r\n      return;\r\n    }\r\n    let wksConfig;\r\n    if (layer.options.workspace) {\r\n      wksConfig = layer.options.workspace;\r\n    } else {\r\n      wksConfig = {};\r\n    }\r\n    wksConfig.srcId = layer.id;\r\n    wksConfig.workspaceId = layer.id;\r\n    wksConfig.enabled = true;\r\n    wksConfig.pageSize = layer.options.workspace?.pageSize;\r\n    wksConfig.pageSizeOptions = layer.options.workspace?.pageSizeOptions;\r\n\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      bidirectionnal: true,\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n    let wks;\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: {\r\n          srcId: layer.id,\r\n          workspaceId: undefined,\r\n          enabled: false,\r\n          queryOptions: {\r\n            mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n            tabQuery: false\r\n          },\r\n          pageSize: layer.options.workspace?.pageSize,\r\n          pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n        },\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters$.value, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined,\r\n          edition: dataSource.options.edition\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        wks = new EditionWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        }, this, this.dialog, this.configService);\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            wksConfig\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: EditionWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    let rendererType = EntityTableColumnRenderer.UnsanitizedHTML;\r\n    let buttons = [];\r\n    let columns = [];\r\n    let relationsColumn = [];\r\n\r\n    buttons = [{\r\n      name: 'edition',\r\n      title: undefined,\r\n      renderer: EntityTableColumnRenderer.ButtonGroup,\r\n      primary: false,\r\n      valueAccessor: () => {\r\n        return [{\r\n          editMode: false,\r\n          icon: 'pencil',\r\n          color: 'primary',\r\n          click: (feature) => { workspace.editFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: false,\r\n          icon: 'delete',\r\n          color: 'warn',\r\n          click: (feature) => { workspace.deleteFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'check',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.saveFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'alpha-x',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.cancelEdit(workspace, feature); }\r\n        }] as EntityTableButton[];\r\n      }\r\n    }];\r\n\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: rendererType,\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: false,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n\r\n    columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n\r\n      let column = {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: rendererType,\r\n        valueAccessor: undefined,\r\n        cellClassFunc: () => {\r\n          const cellClass = {};\r\n          if (field.type) {\r\n            cellClass[`class_${field.type}`] = true;\r\n            return cellClass;\r\n          }\r\n        },\r\n        primary: field.primary === true ? true : false,\r\n        visible: field.visible,\r\n        validation: field.validation,\r\n        type: field.type,\r\n        domainValues: undefined,\r\n        relation: undefined,\r\n        multiple: field.multiple,\r\n        step: field.step,\r\n        tooltip: field.tooltip\r\n      };\r\n\r\n      if (field.type === 'list' || field.type === 'autocomplete') {\r\n        this.getDomainValues(field.relation.table).subscribe(result => {\r\n          column.domainValues = result;\r\n          column.relation = field.relation;\r\n        });\r\n      }\r\n      return column;\r\n    });\r\n\r\n    relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n          if (this.adding$.getValue() === false) {\r\n            this.ws$.next(relation.title);\r\n          }\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    columns.push(...buttons);\r\n\r\n    workspace.meta.tableTemplate = {\r\n      selection: false,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  public saveFeature(feature, workspace: EditionWorkspace) {\r\n    if (!this.validateFeature(feature, workspace)){\r\n      return false;\r\n    }\r\n\r\n    this.sanitizeParameter(feature, workspace);\r\n\r\n    let url = this.configService.getConfig('edition.url');\r\n\r\n    if (workspace.layer.dataSource.options.edition.baseUrl) {\r\n      url += workspace.layer.dataSource.options.edition.baseUrl;\r\n    }\r\n\r\n    if (feature.newFeature) {\r\n      url += workspace.layer.dataSource.options.edition.addUrl;\r\n\r\n      const addHeaders = workspace.layer.dataSource.options.edition.addHeaders;\r\n      const headers = new HttpHeaders(addHeaders);\r\n\r\n      this.addFeature(feature, workspace, url, headers);\r\n    } else {\r\n      if (workspace.layer.dataSource.options.edition.modifyProtocol !== \"post\") {\r\n        url += '?' + workspace.layer.dataSource.options.edition.modifyUrl + feature.idkey;\r\n      }\r\n      else {\r\n        url += workspace.layer.dataSource.options.edition.modifyUrl;\r\n      }\r\n\r\n      const protocole = workspace.layer.dataSource.options.edition.modifyProtocol;\r\n      const modifyHeaders = workspace.layer.dataSource.options.edition.modifyHeaders;\r\n      const headers = new HttpHeaders(modifyHeaders);\r\n\r\n      this.modifyFeature(feature, workspace, url, headers, protocole);\r\n    }\r\n  }\r\n\r\n  public addFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}) {\r\n    // TODO: adapt to any kind of geometry\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      //feature.properties[geom] = feature.geometry;\r\n      feature.properties[\"longitude\"] = feature.geometry.coordinates[0];\r\n      feature.properties[\"latitude\"] = feature.geometry.coordinates[1];\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if (sf.name === property && sf.validation?.readonly) {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http.post(`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        workspace.entityStore.stateView.clear();\r\n        workspace.deleteDrawings();\r\n        workspace.entityStore.delete(feature);\r\n\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addSuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        this.adding$.next(false);\r\n        this.rowsInMapExtentCheckCondition$.next(true);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const genericErrorMessage = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addError'\r\n        );\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n        } else {\r\n          this.messageService.error(genericErrorMessage);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  public deleteFeature(workspace: EditionWorkspace, url: string) {\r\n    this.loading = true;\r\n    this.http.delete(`${url}`, {}).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.deleteSuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n          const genericErrorMessage = this.languageService.translate.instant(\r\n            'igo.geo.workspace.addError'\r\n          );\r\n          const messages = workspace.layer.dataSource.options.edition.messages;\r\n          if (messages) {\r\n            let text;\r\n            messages.forEach(message => {\r\n              const key = Object.keys(message)[0];\r\n              if (error.error.message.includes(key)) {\r\n                text = message[key];\r\n                this.messageService.error(text);\r\n              }\r\n            });\r\n            if (!text) {\r\n              this.messageService.error(genericErrorMessage);\r\n            }\r\n          } else {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n      }\r\n    );\r\n  }\r\n\r\n  public modifyFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}, protocole = 'patch' ) {\r\n    //TODO: adapt to any kind of geometry\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      //feature.properties[geom] = feature.geometry;\r\n      feature.properties[\"longitude\"] = feature.geometry.coordinates[0];\r\n      feature.properties[\"latitude\"] = feature.geometry.coordinates[1];\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || property === 'boundedBy') {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http[protocole](`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        this.cancelEdit(workspace, feature, true);\r\n\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.modifySuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n\r\n        let relationLayers = [];\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              relationLayers.push(layer);\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n        this.relationLayers$.next(relationLayers);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const genericErrorMessage = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addError'\r\n        );\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n        } else {\r\n          this.messageService.error(genericErrorMessage);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  cancelEdit(workspace: EditionWorkspace, feature, fromSave = false) {\r\n    feature.edition = false;\r\n    this.adding$.next(false);\r\n    workspace.deleteDrawings();\r\n\r\n    if (feature.newFeature) {\r\n      workspace.entityStore.stateView.clear();\r\n      workspace.entityStore.delete(feature);\r\n      workspace.deactivateDrawControl();\r\n\r\n      this.rowsInMapExtentCheckCondition$.next(true);\r\n    } else {\r\n      if (!fromSave) {\r\n        feature.properties = feature.original_properties;\r\n        feature.geometry = feature.original_geometry;\r\n      }\r\n      delete feature.original_properties;\r\n      delete feature.original_geometry;\r\n    }\r\n  }\r\n\r\n  getDomainValues(table: string): Observable<any> {\r\n    let url = this.configService.getConfig('edition.url') + table;\r\n\r\n    return this.http.get<any>(url).pipe(\r\n      map(result => {\r\n        return result;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        return throwError(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Refresh both wms and wfs layer\r\n   * A new wfs loader is used to ensure cache is not retrieving old data\r\n   * WMS params are updated to ensure layer is correctly refreshed\r\n   */\r\n  refreshMap(layer: VectorLayer, map: IgoMap) {\r\n    const wfsOlLayer = layer.dataSource.ol;\r\n    const loader = (extent, resolution, proj, success, failure) => {\r\n      layer.customWFSLoader(\r\n        layer.ol.getSource(),\r\n        layer.options.sourceOptions,\r\n        this.authInterceptor,\r\n        extent,\r\n        resolution,\r\n        proj,\r\n        success,\r\n        failure,\r\n        true\r\n      );\r\n    };\r\n    wfsOlLayer.setLoader(loader);\r\n    wfsOlLayer.refresh();\r\n\r\n    for (const lay of map.layers) {\r\n      if (\r\n        lay.id !== layer.id &&\r\n        lay.options.linkedLayers?.linkId.includes(layer.id.substr(0, layer.id.indexOf('.') - 1)) &&\r\n        lay.options.linkedLayers?.linkId.includes('WmsWorkspaceTableSrc')\r\n      )\r\n        {\r\n          const wmsOlLayer = lay.dataSource.ol as olSourceImageWMS;\r\n          let params = wmsOlLayer.getParams();\r\n          params._t = new Date().getTime();\r\n          wmsOlLayer.updateParams(params);\r\n        }\r\n    }\r\n  }\r\n\r\n  validateFeature(feature, workspace: EditionWorkspace) {\r\n    const translate = this.languageService.translate;\r\n    let message ;\r\n    let key;\r\n    let valid = true;\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.hasOwnProperty('validation') && column.validation) {\r\n        key = getColumnKeyWithoutPropertiesTag(column.name);\r\n        Object.keys( column.validation).forEach((type) => {\r\n          switch (type) {\r\n            case 'mandatory': {\r\n              if (column.validation[type] && (!feature.properties.hasOwnProperty(key) || !feature.properties[key])) {\r\n                valid = false;\r\n                  message = translate.instant('igo.geo.formValidation.mandatory',\r\n                  {\r\n                    column: column.title\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'minValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] < column.validation[type]) {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.minValue',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'maxValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] > column.validation[type]) {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.maxValue',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'minLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length < column.validation[type])\r\n              {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.minLength',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'maxLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length > column.validation[type])\r\n              {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.maxLength',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            }\r\n          });\r\n      }\r\n    });\r\n    return valid;\r\n  }\r\n\r\n  sanitizeParameter(feature, workspace: EditionWorkspace) {\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.type === 'list' && feature.properties[getColumnKeyWithoutPropertiesTag(column.name)]) {\r\n        feature.properties[getColumnKeyWithoutPropertiesTag(column.name)] =\r\n          feature.properties[getColumnKeyWithoutPropertiesTag(column.name)].toString();\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n}\r\n\r\nfunction getColumnKeyWithoutPropertiesTag(column: string) {\r\n  if (column.includes('properties.')) {\r\n    return column.split('.')[1];\r\n  }\r\n  return column;\r\n}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface FeatureWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class FeatureWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: FeatureWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\n\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { StorageService } from '@igo2/core';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): FeatureWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n\r\n    const wks = new FeatureWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: FeatureWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Directive, Input, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Workspace, WorkspaceStore, WorkspaceSelectorComponent } from '@igo2/common';\r\n\r\nimport { Layer, ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { WFSDataSource, WMSDataSource, FeatureDataSource } from '../../datasource';\r\nimport { OgcFilterableDataSourceOptions } from '../../filter';\r\n\r\nimport { WfsWorkspaceService } from '../shared/wfs-workspace.service';\r\nimport { WmsWorkspaceService } from '../shared/wms-workspace.service';\r\nimport { EditionWorkspaceService } from '../shared/edition-workspace.service';\r\nimport { FeatureWorkspaceService } from '../shared/feature-workspace.service';\r\nimport { FeatureStoreInMapExtentStrategy } from '../../feature/shared/strategies/in-map-extent';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\n\r\n@Directive({\r\n  selector: '[igoWorkspaceSelector]'\r\n})\r\nexport class WorkspaceSelectorDirective implements OnInit, OnDestroy {\r\n\r\n  private layers$$: Subscription;\r\n  private entities$$: Subscription[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() changeWorkspace = new EventEmitter<string>();\r\n  @Output() disableSwitch = new EventEmitter<boolean>();\r\n  @Output() relationLayers = new EventEmitter<ImageLayer[] | VectorLayer[]>();\r\n  @Output() rowsInMapExtentCheckCondition = new EventEmitter<boolean>();\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.component.store;\r\n  }\r\n\r\n  constructor(\r\n    private component: WorkspaceSelectorComponent,\r\n    private wfsWorkspaceService: WfsWorkspaceService,\r\n    private wmsWorkspaceService: WmsWorkspaceService,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private featureWorkspaceService: FeatureWorkspaceService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((layers: Layer[]) =>\r\n        this.onLayersChange(layers)\r\n      );\r\n\r\n    this.featureWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wmsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wfsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.adding$.subscribe((adding) => { this.disableSwitch.emit(adding); });\r\n    this.editionWorkspaceService.relationLayers$.subscribe((layers) => { this.relationLayers.emit(layers); });\r\n    this.editionWorkspaceService.rowsInMapExtentCheckCondition$.subscribe((condition) => {\r\n      this.rowsInMapExtentCheckCondition.emit(condition);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.entities$$.map(entities => entities.unsubscribe());\r\n  }\r\n\r\n  private onLayersChange(layers: Layer[]) {\r\n    const editableLayers = layers.filter((layer: Layer) =>\r\n      this.layerIsEditable(layer)\r\n    );\r\n    const editableLayersIds = editableLayers.map((layer: Layer) => layer.id);\r\n\r\n    const workspacesToAdd = editableLayers\r\n      .map((layer: VectorLayer) => this.getOrCreateWorkspace(layer))\r\n      .filter((workspace: Workspace | undefined) => workspace !== undefined);\r\n\r\n    const workspacesToRemove = this.workspaceStore.all()\r\n      .filter((workspace: Workspace) => {\r\n        return editableLayersIds.indexOf(workspace.id) < 0;\r\n      });\r\n\r\n    if (workspacesToRemove.length > 0) {\r\n      workspacesToRemove.forEach((workspace: Workspace) => {\r\n        workspace.entityStore.deactivateStrategyOfType(FeatureStoreInMapExtentStrategy);\r\n        workspace.deactivate();\r\n      });\r\n      this.workspaceStore.state.updateMany(workspacesToRemove, {active: false, selected: false});\r\n      this.workspaceStore.deleteMany(workspacesToRemove);\r\n    }\r\n\r\n    if (workspacesToAdd.length > 0) {\r\n      this.workspaceStore.insertMany(workspacesToAdd);\r\n    }\r\n  }\r\n\r\n  private getOrCreateWorkspace(layer: VectorLayer | ImageLayer): Workspace | undefined {\r\n    const workspace = this.workspaceStore.get(layer.id);\r\n    if (workspace !== undefined) {\r\n      return;\r\n    }\r\n    if (layer.dataSource instanceof WFSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      const wfsWks = this.wfsWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return wfsWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      if (!layer.dataSource.options.paramsWFS) { return; }\r\n      const wmsWks = this.wmsWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      wmsWks?.inResolutionRange$.subscribe((inResolutionRange) => {\r\n        (layer.dataSource.options as QueryableDataSourceOptions).queryable = !inResolutionRange;\r\n        (wmsWks.layer.dataSource.options as QueryableDataSourceOptions).queryable = inResolutionRange;\r\n      });\r\n      return wmsWks;\r\n    } else if (\r\n        layer.dataSource instanceof FeatureDataSource &&\r\n        (layer as VectorLayer).exportable === true &&\r\n        layer.dataSource.options.edition?.enabled !== true) {\r\n      const featureWks = this.featureWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return featureWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled === true) {\r\n      const editionWks = this.editionWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      return editionWks;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  private layerIsEditable(layer: Layer): boolean {\r\n    const dataSource = layer.dataSource;\r\n    if (dataSource instanceof WFSDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof FeatureDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof WMSDataSource) {\r\n      const dataSourceOptions = (dataSource.options ||\r\n        {}) as OgcFilterableDataSourceOptions;\r\n      return (dataSourceOptions.ogcFilters?.enabled || dataSource.options.paramsWFS?.featureTypes !== undefined);\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceSelectorDirective } from './workspace-selector.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceSelectorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceUpdatorDirective } from './workspace-updator.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceUpdatorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceUpdatorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceUpdatorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { ConfirmationPopupComponent } from './confirmation-popup.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatDialogModule,\r\n    MatButtonToggleModule\r\n  ],\r\n  exports: [ConfirmationPopupComponent],\r\n  declarations: [ConfirmationPopupComponent]\r\n})\r\nexport class IgoConfirmationPopupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport { provideOgcFilterWidget } from './widgets/widgets';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoOgcFilterModule } from './widgets/ogc-filter/ogc-filter.module';\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceUpdatorModule } from './workspace-updator/workspace-updator.module';\r\nimport { IgoConfirmationPopupModule } from './confirmation-popup/confirmation-popup.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoWidgetModule,\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    IgoConfirmationPopupModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    provideOgcFilterWidget()\r\n  ]\r\n})\r\nexport class IgoGeoWorkspaceModule {}\r\n","import { EntityStore } from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureWithDirection, FeatureWithStep, FeatureWithStop, Stop } from './directions.interface';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * stops.\r\n */\r\nexport class StopsStore extends EntityStore<Stop> {\r\n\r\n    public storeInitialized$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n    public clearStops() {\r\n        this.storeInitialized$.next(false);\r\n        this.clear();\r\n    }\r\n\r\n}\r\n\r\nexport class StopsFeatureStore extends FeatureStore<FeatureWithStop> {\r\n\r\n}\r\nexport class RoutesFeatureStore extends FeatureStore<FeatureWithDirection> {\r\n\r\n}\r\nexport class StepFeatureStore extends FeatureStore<FeatureWithStep> {\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsFormat, SourceDirectionsType } from '../shared/directions.enum';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { DirectionsSourceOptions } from './directions-source.interface';\r\n\r\n@Injectable()\r\nexport class OsrmDirectionsSource extends DirectionsSource {\r\n  get enabled(): boolean {\r\n    return this.options.enabled !== false;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  static _name = 'OSRM Québec';\r\n  private directionsUrl =\r\n    'https://geoegl.msp.gouv.qc.ca/services/itineraire/route/v1/driving/';\r\n  private options: DirectionsSourceOptions;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    super();\r\n    this.options = this.config.getConfig('directionsSources.osrm') || {};\r\n    this.directionsUrl = this.options.url || this.directionsUrl;\r\n  }\r\n\r\n  getName(): string {\r\n    return OsrmDirectionsSource._name;\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]> {\r\n    const directionsParams = this.getRouteParams(directionsOptions);\r\n    return this.http\r\n      .get<JSON[]>(this.directionsUrl + coordinates.join(';'), {\r\n        params: directionsParams\r\n      })\r\n      .pipe(map(res => this.extractRoutesData(res)));\r\n  }\r\n\r\n  private extractRoutesData(response): Direction[] {\r\n    const routeResponse = [];\r\n    response.routes.forEach(route => {\r\n      routeResponse.push(this.formatRoute(route, response.waypoints));\r\n    });\r\n    return routeResponse;\r\n  }\r\n\r\n  private getRouteParams(directionsOptions: DirectionOptions = {}): HttpParams {\r\n\r\n    directionsOptions.alternatives = directionsOptions.alternatives !== undefined ? directionsOptions.alternatives : true;\r\n    directionsOptions.steps = directionsOptions.steps !== undefined ? directionsOptions.steps : true;\r\n    directionsOptions.geometries = directionsOptions.geometries !== undefined ? directionsOptions.geometries : 'geojson';\r\n    directionsOptions.overview = directionsOptions.overview !== undefined ? directionsOptions.overview : false;\r\n    directionsOptions.continue_straight = directionsOptions.continue_straight !== undefined ? directionsOptions.continue_straight : false;\r\n\r\n    return new HttpParams({\r\n      fromObject: {\r\n        alternatives: directionsOptions.alternatives ? 'true' : 'false',\r\n        overview: directionsOptions.overview ? 'simplified' : 'full',\r\n        steps: directionsOptions.steps ? 'true' : 'false',\r\n        geometries: directionsOptions.geometries ? directionsOptions.geometries : 'geojson',\r\n        continue_straight: directionsOptions.continue_straight ? 'true' : 'false',\r\n      }\r\n    });\r\n  }\r\n\r\n  private formatRoute(roadNetworkRoute: any, waypoints: any): Direction {\r\n    const stepsUI = [];\r\n    roadNetworkRoute.legs.forEach(leg => {\r\n      leg.steps.forEach(step => {\r\n        stepsUI.push(step);\r\n      });\r\n    });\r\n    return {\r\n      id: uuid(),\r\n      title: roadNetworkRoute.legs[0].summary,\r\n      source: OsrmDirectionsSource._name,\r\n      sourceType: SourceDirectionsType.Route,\r\n      order: 1,\r\n      format: DirectionsFormat.GeoJSON,\r\n      icon: 'directions',\r\n      projection: 'EPSG:4326',\r\n      waypoints,\r\n      distance: roadNetworkRoute.distance,\r\n      duration: roadNetworkRoute.duration,\r\n      geometry: roadNetworkRoute.geometry,\r\n      legs: roadNetworkRoute.legs,\r\n      steps: stepsUI,\r\n      weight: roadNetworkRoute.weight,\r\n      weight_name: roadNetworkRoute.weight_name\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { OsrmDirectionsSource } from './osrm-directions-source';\r\n\r\nexport function osrmDirectionsSourcesFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new OsrmDirectionsSource(http, config);\r\n}\r\n\r\nexport function provideOsrmDirectionsSource() {\r\n  return {\r\n    provide: DirectionsSource,\r\n    useFactory: osrmDirectionsSourcesFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olWKT from 'ol/format/WKT';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n/**\r\n * Cadastre search source\r\n */\r\n@Injectable()\r\nexport class CadastreSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'cadastre';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return CadastreSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CadastreSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Cadastre (Québec)',\r\n      searchUrl: 'https://carto.cptaq.gouv.qc.ca/php/find_lot_v1.php?'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    term = term.endsWith(',') ? term.slice(0, -1) : term;\r\n    term = term.startsWith(',') ? term.substr(1) : term;\r\n    term = term.replace(/ /g, '');\r\n\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('numero') || !params.get('numero').match(/^[0-9,]+$/g)) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params, responseType: 'text' })\r\n      .pipe(map((response: string) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          numero: term,\r\n          epsg: '4326'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: string, term: string): SearchResult<Feature>[] {\r\n    return response\r\n      .split('<br />')\r\n      .filter((lot: string) => lot.length > 0)\r\n      .map((lot: string) => this.dataToResult(lot, term));\r\n  }\r\n\r\n  private dataToResult(data: string, term: string): SearchResult<Feature> {\r\n    const lot = data.split(';');\r\n    const numero = lot[0];\r\n    const wkt = lot[7];\r\n    const geometry = this.computeGeometry(wkt);\r\n\r\n    const properties = {\r\n      NoLot: numero,\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    const id = [this.getId(), 'cadastre', numero].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: numero,\r\n        score: computeTermSimilarity(term.trim(), numero),\r\n        icon: 'map-marker'\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: numero\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeGeometry(wkt: string): FeatureGeometry {\r\n    const feature = new olWKT().readFeature(wkt, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: 'EPSG:4326'\r\n    });\r\n    return {\r\n      type: feature.getGeometry().getType(),\r\n      coordinates: feature.getGeometry().getCoordinates()\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { CadastreSearchSource } from './cadastre';\r\n\r\n/**\r\n * Cadastre search source factory\r\n * @ignore\r\n */\r\nexport function cadastreSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new CadastreSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${CadastreSearchSource.id}`),\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Cadastre search source\r\n */\r\nexport function provideCadastreSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: cadastreSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\nimport { NominatimData } from './nominatim.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * Nominatim search source\r\n */\r\n@Injectable()\r\nexport class NominatimSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'nominatim';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    storageService: StorageService\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return NominatimSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return NominatimSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Nominatim (OSM)',\r\n      searchUrl: 'https://nominatim.openstreetmap.org/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'amenity',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.food',\r\n              value:\r\n                'bar,bbq,biergaten,cafe,drinking_water,fast_food,food_court,ice_cream,pub,restaurant',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.health',\r\n              value:\r\n                'baby_hatch,clinic,dentist,doctors,hospital,nursing_home,pharmacy,social_facility,veterinary',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.entertainment',\r\n              value:\r\n                'arts_centre,brothel,casino,cinema,community_center_fountain,gambling,nightclub,planetarium \\\r\n                          ,public_bookcase,social_centre,stripclub,studio,swingerclub,theatre,internet_cafe',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.finance',\r\n              value: 'atm,bank,bureau_de_change',\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: true\r\n            },\r\n            {\r\n              title: '20',\r\n              value: 20,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'countrycodes',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.canada',\r\n              value: 'CA',\r\n              enabled: true\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.all',\r\n              value: null,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'multiple object',\r\n          name: 'dedupe',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.true',\r\n              value: 0,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.false',\r\n              value: 1,\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q')) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(map((response: NominatimData[]) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          q: this.computeTerm(term),\r\n          format: 'json'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: NominatimData[], term: string): SearchResult<Feature>[] {\r\n    return response.map((data: NominatimData) => this.dataToResult(data, term));\r\n  }\r\n\r\n  private dataToResult(data: NominatimData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const geometry = this.computeGeometry(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), 'place', data.place_id].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.display_name,\r\n        icon: 'map-marker',\r\n        score: computeTermSimilarity(term.trim(), data.display_name)\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.display_name\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: NominatimData): { [key: string]: any } {\r\n    return {\r\n      display_name: data.display_name,\r\n      place_id: data.place_id,\r\n      osm_type: data.osm_type,\r\n      class: data.class,\r\n      type: data.type\r\n    };\r\n  }\r\n\r\n  private computeGeometry(data: NominatimData): FeatureGeometry {\r\n    return {\r\n      type: 'Point',\r\n      coordinates: [parseFloat(data.lon), parseFloat(data.lat)]\r\n    };\r\n  }\r\n\r\n  private computeExtent(data: NominatimData): [number, number, number, number] {\r\n    return [\r\n      parseFloat(data.boundingbox[2]),\r\n      parseFloat(data.boundingbox[0]),\r\n      parseFloat(data.boundingbox[3]),\r\n      parseFloat(data.boundingbox[1])\r\n    ];\r\n  }\r\n\r\n  private computeTerm(term: string): string {\r\n    return this.computeTermTags(term);\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from query in Nominatim's format (+[])\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTermTags(term: string): string {\r\n    const hashtags = super.getHashtagsValid(term, 'amenity');\r\n    if (!hashtags) {\r\n      return this.computeTermSettings(term);\r\n    }\r\n\r\n    if (!hashtags.length) {\r\n      return null;\r\n    }\r\n\r\n    term = term.replace(/(#[^\\s]*)/g, '');\r\n    hashtags.forEach(tag => {\r\n      term += '+[' + tag + ']';\r\n    });\r\n\r\n    return term;\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from settings in Nominatim's format (+[])\r\n   * @param term Query\r\n   */\r\n  private computeTermSettings(term: string): string {\r\n    this.options.settings.forEach(settings => {\r\n      if (settings.name === 'amenity') {\r\n        settings.values.forEach(conf => {\r\n          if (conf.enabled && typeof conf.value === 'string') {\r\n            const splitted = conf.value.split(',');\r\n            splitted.forEach(value => {\r\n              term += '+[' + value + ']';\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return term;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { NominatimSearchSource } from './nominatim';\r\n\r\n/**\r\n * Nominatim search source factory\r\n * @ignore\r\n */\r\nexport function nominatimSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService,\r\n  storageService: StorageService\r\n) {\r\n  return new NominatimSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${NominatimSearchSource.id}`),\r\n    storageService\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Nominatim search source\r\n */\r\nexport function provideNominatimSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: nominatimSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService, StorageService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  StoredQueriesData,\r\n  StoredQueriesResponse,\r\n  StoredQueriesReverseData,\r\n  StoredQueriesReverseResponse,\r\n  StoredQueriesSearchSourceOptions,\r\n  StoredQueriesFields,\r\n  StoredQueriesReverseSearchSourceOptions\r\n} from './storedqueries.interfaces';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * StoredQueries search source\r\n */\r\n@Injectable()\r\nexport class StoredQueriesSearchSource extends SearchSource\r\n  implements TextSearch {\r\n  static id = 'storedqueries';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [\r\n    'boundedBy',\r\n    'id',\r\n    'coord_x',\r\n    'coord_y'\r\n  ];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesSearchSourceOptions;\r\n    if (this.storedQueriesOptions && !this.storedQueriesOptions.available) {\r\n      return;\r\n    }\r\n\r\n    const defaultStoredqueryId = 'rtss';\r\n    const defaultFieldSplitter: StoredQueriesFields[] = [\r\n      { name: 'rtss', defaultValue: '-99' },\r\n      { name: 'chainage', defaultValue: '0', splitPrefix: '\\\\+' }\r\n    ];\r\n    const defaultOutputformat = 'text/xml; subtype=gml/3.1.1';\r\n    const defaultSrsname = 'EPSG:4326';\r\n    const defaultResultTitle = 'title';\r\n\r\n    if (!this.storedQueriesOptions) {\r\n      console.log(\r\n        ' No configuration for this search source (storedqueries). You will use the default values'\r\n      );\r\n      this.storedQueriesOptions = {\r\n        storedquery_id: defaultStoredqueryId,\r\n        fields: defaultFieldSplitter,\r\n        outputformat: defaultOutputformat,\r\n        srsname: defaultSrsname,\r\n        resultTitle: defaultResultTitle\r\n      };\r\n      this.resultTitle = defaultResultTitle;\r\n      console.log('Default values', this.storedQueriesOptions);\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.fields) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"fields\" into options. ex: fields: {\"name\": \"rtss\", \"defaultValue\": \"-99\"}'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n\r\n    const storedQueryId = this.storedQueriesOptions.storedquery_id.toLowerCase();\r\n    if (\r\n      storedQueryId.includes('getfeaturebyid') &&\r\n      this.storedQueriesOptions.outputformat\r\n        .toLowerCase()\r\n        .includes('getfeaturebyid')\r\n    ) {\r\n      let err =\r\n        'You must set a geojson format for your stored query. This is due to an openlayers issue)';\r\n      err += ' (wfs 1.1.0 & gml 3.1.1 limitation)';\r\n      throw new Error(err);\r\n    }\r\n\r\n    if (!(this.storedQueriesOptions.fields instanceof Array)) {\r\n      this.storedQueriesOptions.fields = [this.storedQueriesOptions.fields];\r\n    }\r\n\r\n    this.multipleFieldsQuery =\r\n      this.storedQueriesOptions.fields.length > 1 ? true : false;\r\n\r\n    this.storedQueriesOptions.fields.forEach((field, index) => {\r\n      if (this.multipleFieldsQuery && !field.splitPrefix && index !== 0) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field spliter into your field definition (optional for the first one!)'\r\n        );\r\n      }\r\n      if (!field.defaultValue) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field default value into your field definition'\r\n        );\r\n      }\r\n    });\r\n\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  // URL CALL EXAMPLES:\r\n  //  GetFeatureById (mandatory storedquery for wfs server) (outputformat must be in geojson)\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=2.0.0&request=GetFeature&storedquery_id=urn:ogc:def:query:OGC-WFS::GetFeatureById&srsname=epsg:4326&outputformat=geojson&ID=a_num_route.132\r\n  //  Custom StoredQuery\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=rtss&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&rtss=0013801110000c&chainage=12\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const storedqueriesParams = this.termSplitter(\r\n      term,\r\n      this.storedQueriesOptions.fields\r\n    );\r\n    const params = this.computeRequestParams(\r\n      options || {},\r\n      storedqueriesParams\r\n    );\r\n    this.options.params = this.options.params ? this.options.params : {};\r\n    this.options.params.page = options.page ? String(options.page) : '1';\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            let resultArray = this.extractResults(this.extractWFSData(response), term);\r\n            resultArray.sort((a, b) =>\r\n              (a.meta.score > b.meta.score) ? 1 :\r\n              (a.meta.score === b.meta.score) ? ((a.meta.titleHtml < b.meta.titleHtml) ? 1 : -1) : -1);\r\n            resultArray.reverse();\r\n            if (resultArray.length > Number(this.options.params.limit)) {\r\n              const idxEnd = Number(this.options.params.limit) * Number(this.options.params.page);\r\n              const resultTotLenght = resultArray.length;\r\n              resultArray = resultArray.slice(0, idxEnd);\r\n              if (idxEnd < resultTotLenght) {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = true;\r\n              } else {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = false;\r\n              }\r\n            }\r\n            return resultArray;\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response), term);\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private termSplitter(term: string, fields: StoredQueriesFields[]): {} {\r\n    const splittedTerm = {};\r\n    let remainingTerm = term;\r\n    let cnt = 0;\r\n\r\n    // Used to build the default values\r\n    fields.forEach(field => {\r\n      splittedTerm[field.name] = field.defaultValue;\r\n      const splitterRegex = new RegExp(field.splitPrefix + '(.+)', 'i');\r\n      if (splitterRegex.test(remainingTerm)) {\r\n        cnt = field.splitPrefix ? (cnt += 1) : cnt;\r\n        remainingTerm = remainingTerm.split(splitterRegex)[1];\r\n      }\r\n    });\r\n    if (cnt === 0) {\r\n      splittedTerm[fields[0].name] = term;\r\n      return splittedTerm;\r\n    }\r\n    remainingTerm = term;\r\n    const localFields = [...fields].reverse();\r\n    localFields.forEach(field => {\r\n      const splitterRegex = new RegExp(field.splitPrefix || '' + '(.+)', 'i');\r\n      if (remainingTerm || remainingTerm !== '') {\r\n        const values = remainingTerm.split(splitterRegex);\r\n        remainingTerm = values[0];\r\n        if (values[1]) {\r\n          splittedTerm[field.name] = values[1].trim();\r\n        }\r\n      }\r\n    });\r\n    return splittedTerm;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    options: TextSearchOptions,\r\n    queryParams\r\n  ): HttpParams {\r\n    const wfsversion = this.storedQueriesOptions.storedquery_id\r\n      .toLowerCase()\r\n      .includes('getfeaturebyid')\r\n      ? '2.0.0'\r\n      : '1.1.0';\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'wfs',\r\n          version: wfsversion,\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        queryParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesResponse, term: string\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesData) => {\r\n      return this.dataToResult(data, term);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        // extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.title,\r\n        titleHtml: data.properties[title],\r\n        icon: 'map-marker',\r\n        score: (data.properties.title) ?\r\n        computeTermSimilarity(term.trim(), data.properties.title) :\r\n        computeTermSimilarity(term.trim(), data.properties[title]),\r\n\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: StoredQueriesData): { [key: string]: any } {\r\n    const properties = Object.assign(\r\n      {},\r\n      ObjectUtils.removeKeys(\r\n        data.properties,\r\n        StoredQueriesSearchSource.propertiesBlacklist\r\n      ),\r\n      { Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>' }\r\n    );\r\n    return properties;\r\n  }\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source\r\n */\r\n\r\n// EXAMPLE CALLS\r\n /* eslint-disable max-len */\r\n// https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=lim_adm&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&long=-71.292469&lat=46.748107\r\n//\r\n\r\n@Injectable()\r\nexport class StoredQueriesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'storedqueriesreverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesReverseSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesReverseSearchSourceOptions;\r\n\r\n    if (!this.storedQueriesOptions || (this.storedQueriesOptions && !this.storedQueriesOptions.available) ) {\r\n      return;\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.longField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"longField\" to map the longitude coordinate to the query params.'\r\n      );\r\n    }\r\n    if (!this.storedQueriesOptions.latField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"latField\" to map the latitude coordinate to the query params.'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries (reverse)',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            return this.extractResults(this.extractWFSData(response));\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response));\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    const longLatParams = {};\r\n    longLatParams[this.storedQueriesOptions.longField] = lonLat[0];\r\n    longLatParams[this.storedQueriesOptions.latField] = lonLat[1];\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'WFS',\r\n          version: '1.1.0',\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        longLatParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties[title],\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(\r\n    data: StoredQueriesReverseData\r\n  ): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      StoredQueriesReverseSearchSource.propertiesBlacklist\r\n    );\r\n    const routing = {\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    return Object.assign(properties, { type: data.properties.doc_type }, routing);\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  StoredQueriesSearchSource,\r\n  StoredQueriesReverseSearchSource\r\n} from './storedqueries';\r\n\r\n/**\r\n * StoredQueries search source factory\r\n * @ignore\r\n */\r\nexport function storedqueriesSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueries search source\r\n */\r\nexport function provideStoredQueriesSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source factory\r\n * @ignore\r\n */\r\n\r\nexport function storedqueriesReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesReverseSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueriesReverse search source\r\n */\r\nexport function provideStoredQueriesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { WfsWorkspace } from './wfs-workspace';\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { EditionWorkspace } from './edition-workspace';\r\nimport { Observable } from 'rxjs';\r\nimport { EntityStoreFilterCustomFuncStrategy, EntityRecord } from '@igo2/common';\r\nimport { map } from 'rxjs/operators';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { StorageScope } from '@igo2/core';\r\n\r\n\r\nexport function getRowsInMapExtent(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.rowsInMapExtent.${layerId}`) as boolean || true;\r\n}\r\n\r\nexport function setRowsInMapExtent(value, layerId, storageService) {\r\n  storageService.set(`workspace.rowsInMapExtent.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function getSelectedOnly(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.selectedOnly.${layerId}`) as boolean || false;\r\n}\r\n\r\nexport function setSelectedOnly(value, layerId, storageService) {\r\n  storageService.set(`workspace.selectedOnly.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function mapExtentStrategyActiveToolTip(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<string> {\r\n  return ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy).active$.pipe(\r\n    map((active: boolean) => active ? 'igo.geo.workspace.inMapExtent.active.tooltip' : 'igo.geo.workspace.inMapExtent.inactive.tooltip')\r\n  );\r\n}\r\n\r\nexport function noElementSelected(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<boolean> {\r\n  return ws.entityStore.stateView.manyBy$((record: EntityRecord<Feature>) => {\r\n    return record.state.selected === true;\r\n  }).pipe(\r\n    map((entities: EntityRecord<Feature>[]) => entities.length >= 1)\r\n  );\r\n}\r\n\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/simple-map\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoPointerPosition\r\n  [pointerPositionDelay]=\"pointerCoordDelay\"\r\n  (pointerPositionCoord)=\"onPointerMove($event)\">\r\n    <igo-info-section [infoContent]=\"pointerCoord\"></igo-info-section>\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n\r\n<p *ngIf=\"!isTouchScreen\">{{pointerCoord}}</p>","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'simple-map',\r\n    component: AppSimpleMapComponent\r\n  }\r\n];\r\n\r\nexport const AppSimpleMapRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-simple-map',\r\n  templateUrl: './simple-map.component.html',\r\n  styleUrls: ['./simple-map.component.scss']\r\n})\r\nexport class AppSimpleMapComponent {\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    rotation: 0.75\r\n  };\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  onPointerMove(event) {\r\n    this.pointerCoord = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\nimport { AppSimpleMapRoutingModule } from './simple-map-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppSimpleMapComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSimpleMapRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppSimpleMapComponent]\r\n})\r\nexport class AppSimpleMapModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list\r\n    [map]=\"map\"\r\n    [layers]=\"map.layers\"\r\n    [expandLegendOfVisibleLayers]=\"false\"\r\n    floatLabel=\"never\"\r\n    [queryBadge]=\"true\">\r\n\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n        <igo-download-button [layer]=\"layer\"></igo-download-button>\r\n        <igo-ogc-filter-button [header]=\"true\" [layer]=\"layer\"></igo-ogc-filter-button>\r\n        <igo-time-filter-button [header]=\"true\" [layer]=\"layer\"></igo-time-filter-button>\r\n        <igo-track-feature-button [layer]=\"layer\" [trackFeature]=\"true\"></igo-track-feature-button>\r\n      </ng-template>\r\n\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'layer',\r\n    component: AppLayerComponent\r\n  }\r\n];\r\n\r\nexport const AppLayerRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-layer',\r\n  templateUrl: './layer.component.html',\r\n  styleUrls: ['./layer.component.scss']\r\n})\r\nexport class AppLayerComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    maxLayerZoomExtent: [-11000000, 4500000, -4500000, 10000000],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourceCustomEPSG: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson_utf8',\r\n        srsName: 'EPSG:32198',\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '12072'\r\n        }\r\n      },\r\n      formatOptions: {\r\n        dataProjection: 'EPSG:32198'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourceCustomEPSG)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS (Custom EPSG)',\r\n          visible: true,\r\n          source: dataSource,\r\n          removable: false\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'parc_routier',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Réseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habité',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'sh_dis_eco',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'sh_dis_eco',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'nurc:Arc_Sample_Parent',\r\n        visible: false,\r\n        legendOptions: {\r\n          // collapsed: false,\r\n          display: true,\r\n          // url: 'https://v.seloger.com/s/width/1144/visuels/0/m/l/4/0ml42xbt1n3itaboek3qec5dtskdgw6nlscu7j69k.jpg',\r\n          stylesAvailable: [\r\n            { name: 'rain', title: 'Pluie' },\r\n            { name: 'raster', title: 'Défaut' }\r\n          ] //\r\n        },\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://demo.geo-solutions.it/geoserver/ows',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'nurc:Arc_Sample', // , test:Linea_costa\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embâcle',\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\nimport { AppLayerRoutingModule } from './layer-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLayerComponent],\r\n  imports: [\r\n    AppLayerRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLayerComponent]\r\n})\r\nexport class AppLayerModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'legend',\r\n    component: AppLegendComponent\r\n  }\r\n];\r\n\r\nexport const AppLegendRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-legend',\r\n  templateUrl: './legend.component.html',\r\n  styleUrls: ['./legend.component.scss']\r\n})\r\nexport class AppLegendComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with display:false',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: false,\r\n        html: 'test html'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_dis_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend in html',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: true,\r\n        html: '<h2 style=\"background-color: blue;\">HTML légende</h2>'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: false,\r\n        params: {\r\n          LAYERS: 'sh_sreg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with url param',\r\n      visible: true,\r\n      legendOptions: {\r\n        url: `data:image/jpeg;base64,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`\r\n\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_reg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'MELS_CS_ANGLO_S',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Réseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habité',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: '2 styles nurc:Arc_Sample_Parent',\r\n        visible: true,\r\n        legendOptions: {\r\n          // collapsed: false,\r\n          display: true,\r\n          // url: 'https://v.seloger.com/s/width/1144/visuels/0/m/l/4/0ml42xbt1n3itaboek3qec5dtskdgw6nlscu7j69k.jpg',\r\n          stylesAvailable: [\r\n            { name: 'rain', title: 'Pluie' },\r\n            { name: 'raster', title: 'Défaut' }\r\n          ] //\r\n        },\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://demo.geo-solutions.it/geoserver/ows',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'nurc:Arc_Sample', // , test:Linea_costa\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embâcle',\r\n          visible: true,\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map with a legend list</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this\r\n      example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Legends\">\r\n    <igo-layer-legend-list [layers]=\"map.layers\"\r\n    [excludeBaseLayers]=\"true\"\r\n    [allowShowAllLegends]=\"true\"\r\n    [updateLegendOnResolutionChange]=\"false\"\r\n    [showAllLegendsValue]=\"false\">\r\n  </igo-layer-legend-list>\r\n\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\nimport { AppLegendRoutingModule } from './legend-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLegendComponent],\r\n  imports: [\r\n    AppLegendRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLegendComponent]\r\n})\r\nexport class AppLegendModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'overlay',\r\n    component: AppOverlayComponent\r\n  }\r\n];\r\n\r\nexport const AppOverlayRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, AfterViewInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-overlay',\r\n  templateUrl: './overlay.component.html',\r\n  styleUrls: ['./overlay.component.scss']\r\n})\r\nexport class AppOverlayComponent implements OnInit, AfterViewInit {\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    const feature1: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 1\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Point',\r\n        coordinates: [-73, 46.6]\r\n      }\r\n    };\r\n\r\n    const feature2: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 2\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'LineString',\r\n        coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n      }\r\n    };\r\n\r\n    const feature3: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 3\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Polygon',\r\n        coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n      }\r\n    };\r\n\r\n    this.map.overlay.setFeatures(\r\n      [feature1, feature2, feature3],\r\n      FeatureMotion.None\r\n    );\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Overlay</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/overlay\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoOverlayModule } from '@igo2/geo';\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\nimport { AppOverlayRoutingModule } from './overlay-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOverlayComponent],\r\n  imports: [\r\n    AppOverlayRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule\r\n  ],\r\n  exports: [AppOverlayComponent]\r\n})\r\nexport class AppOverlayModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Geometry Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'geometry',\r\n    component: AppGeometryComponent\r\n  }\r\n];\r\n\r\nexport const AppGeometryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-geometry',\r\n  templateUrl: './geometry.component.html',\r\n  styleUrls: ['./geometry.component.scss']\r\n})\r\nexport class AppGeometryComponent implements OnInit, OnDestroy {\r\n\r\n  map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  view = {\r\n    center: [-73, 47.2],\r\n    zoom: 15\r\n  };\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formService: FormService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'geometry',\r\n        title: 'Geometry',\r\n        options:  {\r\n          validator: Validators.required\r\n        },\r\n        type: 'geometry',\r\n        inputs: {\r\n          map: this.map,\r\n          geometryTypeField: true,\r\n          geometryType: 'Polygon',\r\n          drawGuideField: true,\r\n          drawGuide: 50,\r\n          drawGuidePlaceholder: 'Draw Guide',\r\n          drawStyle: new olstyle.Style({\r\n            stroke: new olstyle.Stroke({\r\n              color: [255, 0, 0, 1],\r\n              width: 2\r\n            }),\r\n            fill:  new olstyle.Fill({\r\n              color: [255, 0, 0, 0.2]\r\n            }),\r\n            image: new olstyle.Circle({\r\n              radius: 8,\r\n              stroke: new olstyle.Stroke({\r\n                color: [255, 0, 0, 1]\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: [255, 0, 0, 0.2]\r\n              })\r\n            })\r\n          })\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options:  {\r\n          validator: Validators.required\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      name: 'Place',\r\n      geometry: JSON.stringify({type: 'Polygon', coordinates: [[\r\n        [-106, 42],\r\n        [-107, 31],\r\n        [-81, 32],\r\n        [-82, 42],\r\n        [-106, 42]\r\n      ]]})\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\nimport { IgoGeometryModule, IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\nimport { AppGeometryRoutingModule } from './geometry-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppGeometryComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppGeometryRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule,\r\n    IgoGeometryModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppGeometryComponent]\r\n})\r\nexport class AppGeometryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'feature',\r\n    component: AppFeatureComponent\r\n  }\r\n];\r\n\r\nexport const AppFeatureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  VectorLayer,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-feature',\r\n  templateUrl: './feature.component.html',\r\n  styleUrls: ['./feature.component.scss']\r\n})\r\nexport class AppFeatureComponent implements OnInit, OnDestroy {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  public tableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'properties.id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'properties.name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'properties.description',\r\n        title: 'Description'\r\n      }\r\n    ]\r\n  };\r\n\r\n  public store = new FeatureStore([], { map: this.map });\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const loadingStrategy = new FeatureStoreLoadingStrategy({});\r\n    this.store.addStrategy(loadingStrategy);\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      motion: FeatureMotion.Default\r\n    });\r\n    this.store.addStrategy(selectionStrategy);\r\n\r\n    this.store.load([\r\n      {\r\n        meta: { id: 1 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-72, 47.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 1,\r\n          name: 'Name 1',\r\n          description: 'Description 1'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 2 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'LineString',\r\n          coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 2,\r\n          name: 'Name 2',\r\n          description: 'Description 2'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 3 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Polygon',\r\n          coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 3,\r\n          name: 'Name 3',\r\n          description: 'Description 3'\r\n        }\r\n      }\r\n    ]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'MVT test',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector'\r\n      })\r\n      .subscribe(dataSource => {\r\n        const layer = this.layerService.createLayer({\r\n          title: 'Vector Layer',\r\n          source: dataSource,\r\n          animation: {\r\n            duration: 2000\r\n          },\r\n          mapboxStyle: {\r\n            url: 'assets/mapboxStyleExample-feature.json',\r\n            source: 'source_nameX'\r\n          }\r\n        }) as VectorLayer;\r\n        this.map.addLayer(layer);\r\n        this.store.bindLayer(layer);\r\n        loadingStrategy.activate();\r\n        selectionStrategy.activate();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Feature</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geom/feature\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoEntityTableModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFeatureModule } from '@igo2/geo';\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\nimport { AppFeatureRoutingModule } from './feature-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFeatureComponent],\r\n  imports: [\r\n    AppFeatureRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoEntityTableModule,\r\n    IgoMapModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppFeatureComponent]\r\n})\r\nexport class AppFeatureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\nimport { AppHoverComponent } from './hover.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'hover',\r\n    component: AppHoverComponent\r\n  }\r\n];\r\n\r\nexport const AppHoverRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService, WFSDataSourceOptions, VectorLayerOptions, WFSDataSource } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-hover',\r\n  templateUrl: './hover.component.html',\r\n  styleUrls: ['./hover.component.scss']\r\n})\r\nexport class AppHoverComponent {\r\n  public selected;\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public pointerHoverFeatureDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 8,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n\r\n    this.dataSourceService\r\n    .createAsyncDataSource({\r\n      type: 'wmts',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n      layer: 'carte_gouv_qc_public',\r\n      matrixSet: 'EPSG_3857',\r\n      version: '1.3.0'\r\n    })\r\n    .subscribe(dataSource => {\r\n      this.map.addLayer(\r\n        this.layerService.createLayer({\r\n          title: 'Quebec',\r\n          visible: true,\r\n          baseLayer: true,\r\n          source: dataSource\r\n        })\r\n      );\r\n    });\r\n\r\n    interface WFSDataOptions\r\n      extends WFSDataSourceOptions {}\r\n\r\n    const wfsDatasourcePolygon: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'adn_bassin_n1_public_v',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '3.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePolygon)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (polygon)',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourcePoint: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'CASERNE',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePoint)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (point)',\r\n          visible: true,\r\n          source: dataSource,\r\n          styleByAttribute: {\r\n            attribute: 'en_caserne',\r\n            data: ['true', 'false'],\r\n            stroke: ['red', 'blue'],\r\n            fill: ['#ffffff', '#ffffff'],\r\n            radius: [7, 7],\r\n            width: [2, 2]\r\n          },\r\n          hoverStyle: {\r\n            label: {\r\n              attribute: 'Caserne: ${nom_service_incendie} \\n Mun: ${ville}',\r\n              style: {\r\n                textAlign: 'left',\r\n                textBaseline: 'top',\r\n                font: '12px Calibri,sans-serif',\r\n                fill: { color: '#000' },\r\n                backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n                backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n                stroke: { color: '#fff', width: 3 },\r\n                overflow: true,\r\n                offsetX: 20,\r\n                offsetY: 10,\r\n                padding: [2.5, 2.5, 2.5, 2.5]\r\n              }\r\n            },\r\n            baseStyle: {\r\n              circle: {\r\n                stroke: {\r\n                  color: 'orange',\r\n                  width: 5\r\n                },\r\n                width: [5],\r\n                radius: 15\r\n              }\r\n            }\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Hover</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/hover\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoHoverFeature\r\n  [igoHoverFeatureDelay]=\"pointerHoverFeatureDelay\"\r\n  [igoHoverFeatureEnabled]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppHoverComponent } from './hover.component';\r\nimport { AppHoverRoutingModule } from './hover-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHoverComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppHoverRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppHoverComponent]\r\n})\r\nexport class AppHoverModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'measure',\r\n    component: AppMeasureComponent\r\n  }\r\n];\r\n\r\nexport const AppMeasureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithMeasure\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-measure',\r\n  templateUrl: './measure.component.html',\r\n  styleUrls: ['./measure.component.scss']\r\n})\r\nexport class AppMeasureComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public store = new FeatureStore<FeatureWithMeasure>([], {map: this.map});\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/measure\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-measurer [store]=\"store\" [map]=\"map\"></igo-measurer>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoMeasureModule } from '@igo2/geo';\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\nimport { AppMeasureRoutingModule } from './measure-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMeasureComponent],\r\n  imports: [\r\n    AppMeasureRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoMeasureModule\r\n  ],\r\n  exports: [AppMeasureComponent]\r\n})\r\nexport class AppMeasureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'draw',\r\n    component: AppDrawComponent\r\n  }\r\n];\r\n\r\nexport const AppDrawRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithDraw,\r\n  MapService\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-draw',\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss']\r\n})\r\nexport class AppDrawComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public store = new FeatureStore<FeatureWithDraw>([], {map: this.map});\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/draw\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-draw [store]=\"store\" [map]=\"map\"></igo-draw>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoDrawModule } from '@igo2/geo';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\nimport { AppDrawRoutingModule } from './draw-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDrawComponent],\r\n  imports: [\r\n    AppDrawRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoDrawModule\r\n  ],\r\n  exports: [AppDrawComponent]\r\n})\r\nexport class AppDrawModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Query</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/query\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay\r\n    igoQuery\r\n    [queryFeatures]=\"true\"\r\n    (query)=\"handleQueryResults($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Details\">\r\n    <ng-container *ngIf=\"feature$ | async as feature\">\r\n      <h1>Query Title : <span style=\"background-color: #e0e0e0;\">{{getTitle(feature)}}</span></h1>\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppQueryComponent } from './query.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'query',\r\n    component: AppQueryComponent\r\n  }\r\n];\r\n\r\nexport const AppQueryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olPoint from 'ol/geom/Point';\r\nimport olPolygon from 'ol/geom/Polygon';\r\nimport olLineString from 'ol/geom/LineString';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  FeatureDataSource,\r\n  DataSourceService,\r\n  LayerService,\r\n  OverlayService,\r\n  Feature,\r\n  QueryableDataSourceOptions,\r\n  QueryFormat,\r\n  QueryHtmlTarget,\r\n  SearchResult,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-query',\r\n  templateUrl: './query.component.html',\r\n  styleUrls: ['./query.component.scss']\r\n})\r\nexport class AppQueryComponent {\r\n  public feature$ = new BehaviorSubject<Feature>(undefined);\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryTitle: 'num_rts',\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryFormat: QueryFormat.HTMLGML2,\r\n        queryHtmlTarget: QueryHtmlTarget.IFRAME,\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS html with a pre call in GML',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector',\r\n        queryable: true,\r\n        queryTitle: 'So beautiful ${name}',\r\n        sourceFields: [\r\n          { name: 'name', alias: 'Alias name' },\r\n          { name: 'description', alias: 'Alias description' }\r\n        ]\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Vector Layer',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n        this.addFeatures(dataSource as FeatureDataSource);\r\n      });\r\n  }\r\n\r\n  addFeatures(dataSource: FeatureDataSource) {\r\n    const feature1 = new olFeature({\r\n      name: 'feature1',\r\n      geometry: new olLineString([\r\n        olproj.transform([-72, 47.8], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-73.5, 47.4], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-72.4, 48.6], 'EPSG:4326', 'EPSG:3857')\r\n      ]),\r\n    });\r\n\r\n    const feature2 = new olFeature({\r\n      name: 'feature2',\r\n      geometry: new olPoint(\r\n        olproj.transform([-73, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n      ),\r\n    });\r\n\r\n    const feature3 = new olFeature({\r\n      name: 'feature3',\r\n      geometry: new olPolygon([\r\n        [\r\n          olproj.transform([-71, 46.8], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-73, 47], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-71.2, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n        ]\r\n      ]),\r\n    });\r\n\r\n    dataSource.ol.addFeatures([feature1, feature2, feature3]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Vector tile with custom getfeatureinfo url',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true,\r\n          queryUrl: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=SDA_REGION_S_20K&LAYERS=SDA_REGION_S_20K&DPI=96&MAP_RESOLUTION=96&FORMAT_OPTIONS=dpi%3A96&INFO_FORMAT=geojson&FEATURE_COUNT=5&I=50&J=50&CRS=EPSG:{srid}&STYLES=&WIDTH=101&HEIGHT=101&BBOX={xmin},{ymin},{xmax},{ymax}',\r\n          queryLayerFeatures: false,\r\n          queryFormat: 'geojson'\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n\r\n      this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/incendie.fcgi',\r\n        queryable: true,\r\n        queryUrl: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=SDA_MUNIC_S_20K&LAYERS=SDA_MUNIC_S_20K&DPI=96&MAP_RESOLUTION=96&FORMAT_OPTIONS=dpi%3A96&INFO_FORMAT=geojson&FEATURE_COUNT=5&I=50&J=50&CRS=EPSG:{srid}&STYLES=&WIDTH=101&HEIGHT=101&BBOX={xmin},{ymin},{xmax},{ymax}',\r\n        queryFormat: 'geojson',\r\n        params: {\r\n          layers: 'caserne',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS with custom getfeatureinfo url',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n  }\r\n\r\n  handleQueryResults(results) {\r\n    const features: Feature[] = results.features;\r\n    let feature: Feature;\r\n    if (features.length && features[0]) {\r\n      feature = features[0];\r\n      this.feature$.next(feature);\r\n      this.map.queryResultsOverlay.setFeatures([feature], FeatureMotion.None);\r\n    }\r\n\r\n  }\r\n\r\n  getTitle(result: SearchResult) {\r\n    return getEntityTitle(result);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppQueryComponent } from './query.component';\r\nimport { AppQueryRoutingModule } from './query-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppQueryComponent],\r\n  imports: [\r\n    AppQueryRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppQueryComponent]\r\n})\r\nexport class AppQueryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppCatalogComponent } from './catalog.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'catalog',\r\n    component: AppCatalogComponent\r\n  }\r\n];\r\n\r\nexport const AppCatalogRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService, ConfigService, StorageService } from '@igo2/core';\r\nimport { IgoMap, LayerService, Catalog, CatalogItem, CatalogService } from '@igo2/geo';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-catalog',\r\n  templateUrl: './catalog.component.html',\r\n  styleUrls: ['./catalog.component.scss']\r\n})\r\nexport class AppCatalogComponent implements OnInit {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public catalogStore = new EntityStore<Catalog>([]);\r\n\r\n  public catalogItemStore = new EntityStore<CatalogItem>([]);\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private catalogService: CatalogService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => this.map.addLayer(layer));\r\n\r\n    this.loadCatalogs();\r\n  }\r\n\r\n  /**\r\n   * When the selected catalog changes, toggle the the CatalogBrowser tool.\r\n   * @internal\r\n   * @param event Select event\r\n   */\r\n  onCatalogSelectChange(event: {selected: boolean; catalog: Catalog}) {\r\n    this.loadCatalogItems(event.catalog);\r\n  }\r\n\r\n  /**\r\n   * Get all the available catalogs from the CatalogService and\r\n   * load them into the store.\r\n   */\r\n  private loadCatalogs() {\r\n    this.catalogService.loadCatalogs()\r\n      .subscribe((catalogs: Catalog[]) => {\r\n        this.catalogStore.clear();\r\n        this.catalogStore.load(catalogs.concat((this.storageService.get('addedCatalogs') || []) as Catalog[]));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Get the selected catalog's items from the CatalogService and\r\n   * load them into the store.\r\n   * @param catalog Selected catalog\r\n   */\r\n  private loadCatalogItems(catalog: Catalog) {\r\n    this.catalogService.loadCatalogItems(catalog)\r\n      .subscribe((items: CatalogItem[]) => {\r\n        this.catalogItemStore.clear();\r\n        this.catalogItemStore.load(items);\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Catalog</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/catalog\">code of this example</a><br>\r\n    See catalog section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Catalog Library\">\r\n    <igo-catalog-library\r\n      [store]=\"catalogStore\"\r\n      (catalogSelectChange)=\"onCatalogSelectChange($event)\">\r\n    </igo-catalog-library>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Catalog Browser\">\r\n    <igo-catalog-browser\r\n      [store]=\"catalogItemStore\"\r\n      [map]=\"map\">\r\n    </igo-catalog-browser>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoCatalogModule } from '@igo2/geo';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppCatalogComponent } from './catalog.component';\r\nimport { AppCatalogRoutingModule } from './catalog-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppCatalogComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppCatalogRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoConfigModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoCatalogModule\r\n  ],\r\n  exports: [AppCatalogComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppCatalogModule {}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid context');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n","export enum TypePermission {\r\n  null,\r\n  read,\r\n  write\r\n}\r\n\r\nexport enum Scope {\r\n  public,\r\n  protected,\r\n  private\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\n\r\nimport { BehaviorSubject, Observable, of, Subject } from 'rxjs';\r\nimport {\r\n  map,\r\n  tap,\r\n  catchError,\r\n  debounceTime,\r\n  mergeMap,\r\n  first,\r\n  skip\r\n} from 'rxjs/operators';\r\n\r\nimport olPoint from 'ol/geom/Point';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\nimport Cluster from 'ol/source/Cluster';\r\nimport olVectorSource from 'ol/source/Vector';\r\n\r\nimport { Tool } from '@igo2/common';\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport {\r\n  ConfigService,\r\n  RouteService,\r\n  Message,\r\n  MessageService,\r\n  LanguageService\r\n} from '@igo2/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport type { IgoMap, Layer } from '@igo2/geo';\r\n\r\nimport { TypePermission } from './context.enum';\r\nimport {\r\n  ContextsList,\r\n  ContextServiceOptions,\r\n  Context,\r\n  DetailedContext,\r\n  ContextMapView,\r\n  ContextPermission,\r\n  ContextProfils\r\n} from './context.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ContextService {\r\n  public context$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public contexts$ = new BehaviorSubject<ContextsList>({ ours: [] });\r\n  public defaultContextId$ = new BehaviorSubject<string>(undefined);\r\n  public editedContext$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public importedContext: Array<DetailedContext> = [];\r\n  public toolsChanged$ = new Subject<DetailedContext>();\r\n  private mapViewFromRoute: ContextMapView = {};\r\n  private options: ContextServiceOptions;\r\n  private baseUrl: string;\r\n\r\n  // Until the ContextService is completely refactored, this is needed\r\n  // to track the current tools\r\n  private tools: Tool[];\r\n  private toolbar: string[];\r\n\r\n  get defaultContextUri(): string {\r\n    return this._defaultContextUri || this.options.defaultContextUri;\r\n  }\r\n  set defaultContextUri(uri: string) {\r\n    this._defaultContextUri = uri;\r\n  }\r\n  private _defaultContextUri: string;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private languageService: LanguageService,\r\n    private config: ConfigService,\r\n    private messageService: MessageService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.options = Object.assign(\r\n      {\r\n        basePath: 'contexts',\r\n        contextListFile: '_contexts.json',\r\n        defaultContextUri: '_default'\r\n      },\r\n      this.config.getConfig('context')\r\n    );\r\n\r\n    this.baseUrl = this.options.url;\r\n\r\n    this.readParamsFromRoute();\r\n\r\n    if (this.authService.hasAuthService) {\r\n      this.authService.logged$.subscribe((logged) => {\r\n        if (logged) {\r\n          this.contexts$.pipe(skip(1), first()).subscribe((c) => {\r\n            this.handleContextsChange();\r\n          });\r\n          this.loadContexts();\r\n        }\r\n      });\r\n    } else {\r\n      this.loadContexts();\r\n      this.handleContextsChange(false);\r\n    }\r\n  }\r\n\r\n  get(permissions?: string[], hidden?: boolean): Observable<ContextsList> {\r\n    let url = this.baseUrl + '/contexts';\r\n    if (permissions && this.authService.authenticated) {\r\n      url += '?permission=' + permissions.join();\r\n      if (hidden) {\r\n        url += '&hidden=true';\r\n      }\r\n    }\r\n    return this.http.get<ContextsList>(url);\r\n  }\r\n\r\n  getById(id: string): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.get<Context>(url);\r\n  }\r\n\r\n  getDetails(id: string): Observable<DetailedContext> {\r\n    const url = `${this.baseUrl}/contexts/${id}/details`;\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, id);\r\n        throw res;\r\n      })\r\n    );\r\n  }\r\n\r\n  getDefault(): Observable<DetailedContext> {\r\n    const url = this.baseUrl + '/contexts/default';\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      tap((context) => {\r\n        this.defaultContextId$.next(context.id);\r\n      })\r\n    );\r\n  }\r\n\r\n  getProfilByUser(): Observable<ContextProfils[]> {\r\n    if (this.baseUrl) {\r\n      const url = this.baseUrl + '/profils?';\r\n      return this.http.get<ContextProfils[]>(url);\r\n    }\r\n    return of([]);\r\n  }\r\n\r\n  setDefault(id: string): Observable<any> {\r\n    const url = this.baseUrl + '/contexts/default';\r\n    return this.http.post(url, { defaultContextId: id });\r\n  }\r\n\r\n  hideContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/hide';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  showContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/show';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  delete(id: string, imported = false): Observable<void> {\r\n    const contexts: ContextsList = { ours: [] };\r\n    Object.keys(this.contexts$.value).forEach(\r\n      (key) =>\r\n        (contexts[key] = this.contexts$.value[key].filter((c) => c.id !== id))\r\n    );\r\n\r\n    if (imported) {\r\n      this.importedContext = this.importedContext.filter((c) => c.id !== id);\r\n      return of(this.contexts$.next(contexts));\r\n    }\r\n\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.delete<void>(url).pipe(\r\n      tap((res) => {\r\n        this.contexts$.next(contexts);\r\n      })\r\n    );\r\n  }\r\n\r\n  create(context: DetailedContext): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts';\r\n    return this.http.post<Context>(url, context).pipe(\r\n      map((contextCreated) => {\r\n        if (this.authService.authenticated) {\r\n          contextCreated.permission = TypePermission[TypePermission.write];\r\n        } else {\r\n          contextCreated.permission = TypePermission[TypePermission.read];\r\n        }\r\n        this.contexts$.value.ours.unshift(contextCreated);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCreated;\r\n      })\r\n    );\r\n  }\r\n\r\n  clone(id: string, properties = {}): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/clone';\r\n    return this.http.post<Context>(url, properties).pipe(\r\n      map((contextCloned) => {\r\n        contextCloned.permission = TypePermission[TypePermission.write];\r\n        this.contexts$.value.ours.unshift(contextCloned);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCloned;\r\n      })\r\n    );\r\n  }\r\n\r\n  update(id: string, context: Context): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.patch<Context>(url, context);\r\n  }\r\n\r\n  // =================================================================\r\n\r\n  addToolAssociation(contextId: string, toolId: string): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools`;\r\n    const association = {\r\n      toolId\r\n    };\r\n    return this.http.post<void>(url, association);\r\n  }\r\n\r\n  deleteToolAssociation(contextId: string, toolId: string): Observable<any> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools/${toolId}`;\r\n    return this.http.delete(url);\r\n  }\r\n\r\n  getPermissions(id: string): Observable<ContextPermission[]> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/permissions';\r\n    return this.http.get<ContextPermission[]>(url);\r\n  }\r\n\r\n  addPermissionAssociation(\r\n    contextId: string,\r\n    profil: string,\r\n    type: TypePermission\r\n  ): Observable<ContextPermission[]> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions`;\r\n    const association = {\r\n      profil,\r\n      typePermission: type\r\n    };\r\n\r\n    return this.http.post<ContextPermission[]>(url, association).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, undefined, true);\r\n        throw [res]; // TODO Not sure about this.\r\n      })\r\n    );\r\n  }\r\n\r\n  deletePermissionAssociation(\r\n    contextId: string,\r\n    permissionId: string\r\n  ): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions/${permissionId}`;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  // ======================================================================\r\n\r\n  getLocalContexts(): Observable<ContextsList> {\r\n    const url = this.getPath(this.options.contextListFile);\r\n    return this.http.get<ContextsList>(url).pipe(\r\n      map((res: any) => {\r\n        return { ours: res };\r\n      })\r\n    );\r\n  }\r\n\r\n  getLocalContext(uri: string): Observable<DetailedContext> {\r\n    const url = this.getPath(`${uri}.json`);\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      mergeMap((res) => {\r\n        if (!res.base) {\r\n          return of(res);\r\n        }\r\n        const urlBase = this.getPath(`${res.base}.json`);\r\n        return this.http.get<DetailedContext>(urlBase).pipe(\r\n          map((resBase: DetailedContext) => {\r\n            const resMerge = res;\r\n            resMerge.map = ObjectUtils.mergeDeep(resBase.map, res.map);\r\n            resMerge.layers = (resBase.layers || [])\r\n              .concat(res.layers || [])\r\n              .reverse()\r\n              .filter(\r\n                (l, index, self) =>\r\n                  !l.id || self.findIndex((l2) => l2.id === l.id) === index\r\n              )\r\n              .reverse();\r\n            resMerge.toolbar = res.toolbar || resBase.toolbar;\r\n            resMerge.message = res.message || resBase.message;\r\n            resMerge.messages = res.messages || resBase.messages;\r\n            resMerge.tools = (res.tools || [])\r\n              .concat(resBase.tools || [])\r\n              .filter(\r\n                (t, index, self) =>\r\n                  self.findIndex((t2) => t2.name === t.name) === index\r\n              );\r\n            return resMerge;\r\n          }),\r\n          catchError((err) => {\r\n            this.handleError(err, uri);\r\n            throw err;\r\n          })\r\n        );\r\n      }),\r\n      catchError((err2) => {\r\n        this.handleError(err2, uri);\r\n        throw err2;\r\n      })\r\n    );\r\n  }\r\n\r\n  loadContexts(permissions?: string[], hidden?: boolean) {\r\n    let request;\r\n    if (this.baseUrl) {\r\n      request = this.get(permissions, hidden);\r\n    } else {\r\n      request = this.getLocalContexts();\r\n    }\r\n    request.subscribe((contexts) => {\r\n      contexts.ours = this.importedContext.concat(contexts.ours);\r\n      this.contexts$.next(contexts);\r\n    });\r\n  }\r\n\r\n  loadDefaultContext() {\r\n    const loadFct = (direct = false) => {\r\n      if (!direct && this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe(\r\n          (_context: DetailedContext) => {\r\n            this.defaultContextUri = _context.uri;\r\n            this.addContextToList(_context);\r\n            this.setContext(_context);\r\n          },\r\n          () => {\r\n            this.defaultContextId$.next(undefined);\r\n            this.loadContext(this.defaultContextUri);\r\n          }\r\n        );\r\n      } else {\r\n        this.loadContext(this.defaultContextUri);\r\n      }\r\n    };\r\n\r\n    if (this.route && this.route.options.contextKey) {\r\n      this.route.queryParams.pipe(debounceTime(100)).subscribe((params) => {\r\n        const contextParam = params[this.route.options.contextKey as string];\r\n        let direct = false;\r\n        if (contextParam) {\r\n          this.defaultContextUri = contextParam;\r\n          direct = true;\r\n        }\r\n        loadFct(direct);\r\n      });\r\n    } else {\r\n      loadFct();\r\n    }\r\n  }\r\n\r\n  loadContext(uri: string) {\r\n    const context = this.context$.value;\r\n\r\n    if (context && context.uri === uri) {\r\n      return;\r\n    }\r\n\r\n    this.getContextByUri(uri)\r\n      .pipe(first())\r\n      .subscribe(\r\n        (_context: DetailedContext) => {\r\n          this.addContextToList(_context);\r\n          this.setContext(_context);\r\n        },\r\n        (err) => {\r\n          if (uri !== this.options.defaultContextUri) {\r\n            this.loadContext(this.options.defaultContextUri);\r\n          }\r\n        }\r\n      );\r\n  }\r\n\r\n  setContext(context: DetailedContext) {\r\n    this.handleContextMessage(context);\r\n    const currentContext = this.context$.value;\r\n    if (currentContext && context && context.id === currentContext.id) {\r\n      if (context.map.view.keepCurrentView === undefined) {\r\n        context.map.view.keepCurrentView = true;\r\n      }\r\n      this.context$.next(context);\r\n      return;\r\n    }\r\n\r\n    if (!context.map) {\r\n      context.map = { view: {} };\r\n    }\r\n\r\n    Object.assign(context.map.view, this.mapViewFromRoute);\r\n\r\n    this.context$.next(context);\r\n  }\r\n\r\n  loadEditedContext(uri: string) {\r\n    this.getContextByUri(uri).subscribe((_context: DetailedContext) => {\r\n      this.setEditedContext(_context);\r\n    });\r\n  }\r\n\r\n  setEditedContext(context: DetailedContext) {\r\n    this.editedContext$.next(context);\r\n  }\r\n\r\n  getContextFromMap(igoMap: IgoMap, empty?: boolean): DetailedContext {\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: uuid(),\r\n      title: '',\r\n      scope: 'private',\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj,\r\n          maxZoomOnExtent: igoMap.viewController.maxZoomOnExtent\r\n        }\r\n      },\r\n      layers: [],\r\n      tools: []\r\n    };\r\n\r\n    let layers = [];\r\n    if (empty === true) {\r\n      layers = igoMap.layers$\r\n        .getValue()\r\n        .filter(\r\n          (lay) =>\r\n            lay.baseLayer === true ||\r\n            lay.options.id === 'searchPointerSummaryId'\r\n        )\r\n        .sort((a, b) => a.zIndex - b.zIndex);\r\n    } else {\r\n      layers = igoMap.layers$.getValue().filter(lay => !lay.id.includes('WfsWorkspaceTableDest')).sort((a, b) => a.zIndex - b.zIndex);\r\n    }\r\n\r\n    let i = 0;\r\n    for (const l of layers) {\r\n      const layer: any = l;\r\n      const opts = {\r\n        id: layer.options.id ? String(layer.options.id) : undefined,\r\n        layerOptions: {\r\n          title: layer.options.title,\r\n          zIndex: ++i,\r\n          visible: layer.visible\r\n        },\r\n        sourceOptions: {\r\n          type: layer.dataSource.options.type,\r\n          params: layer.dataSource.options.params,\r\n          url: layer.dataSource.options.url,\r\n          queryable: layer.queryable\r\n        }\r\n      };\r\n      if (opts.sourceOptions.type) {\r\n        context.layers.push(opts);\r\n      }\r\n    }\r\n\r\n    context.tools = this.tools.map((tool) => {\r\n      return { id: String(tool.id), global: tool.global };\r\n    });\r\n\r\n    return context;\r\n  }\r\n\r\n  getContextFromLayers(\r\n    igoMap: IgoMap,\r\n    layers: Layer[],\r\n    name: string\r\n  ): DetailedContext {\r\n    const currentContext = this.context$.getValue();\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: name,\r\n      title: name,\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj\r\n        }\r\n      },\r\n      layers: [],\r\n      toolbar: [],\r\n      tools: [],\r\n      extraFeatures: []\r\n    };\r\n\r\n    const currentLayers = igoMap.layers$.getValue();\r\n    context.layers = currentLayers\r\n      .filter((l) => l.baseLayer)\r\n      .map((l) => {\r\n        return {\r\n          baseLayer: true,\r\n          sourceOptions: l.options.sourceOptions,\r\n          title: l.options.title,\r\n          visible: l.visible\r\n        };\r\n      });\r\n\r\n    layers.forEach((layer) => {\r\n      const layerFound = currentContext.layers.find(\r\n        (contextLayer) =>\r\n          layer.id === contextLayer.source.id && !contextLayer.baseLayer\r\n      );\r\n\r\n      if (layerFound) {\r\n        let layerStyle = layerFound[`style`];\r\n        if (layerFound[`styleByAttribute`]) {\r\n          layerStyle = undefined;\r\n        } else if (layerFound[`clusterBaseStyle`]) {\r\n          layerStyle = undefined;\r\n          delete layerFound.sourceOptions[`source`];\r\n          delete layerFound.sourceOptions[`format`];\r\n        }\r\n        const opts = {\r\n          baseLayer: layerFound.baseLayer,\r\n          title: layer.options.title,\r\n          zIndex: layer.zIndex,\r\n          styleByAttribute: layerFound[`styleByAttribute`],\r\n          clusterBaseStyle: layerFound[`clusterBaseStyle`],\r\n          style: layerStyle,\r\n          clusterParam: layerFound[`clusterParam`],\r\n          visible: layer.visible,\r\n          opacity: layer.opacity,\r\n          sourceOptions: layerFound.sourceOptions\r\n        };\r\n        context.layers.push(opts);\r\n      } else {\r\n        if (!(layer.ol.getSource() instanceof olVectorSource)) {\r\n          const catalogLayer = layer.options;\r\n          catalogLayer.zIndex = layer.zIndex;\r\n          delete catalogLayer.source;\r\n          context.layers.push(catalogLayer);\r\n        } else {\r\n          let features;\r\n          const writer = new GeoJSON();\r\n          if (layer.ol.getSource() instanceof Cluster) {\r\n            const clusterSource = layer.ol.getSource() as Cluster;\r\n            features = writer.writeFeatures(\r\n              clusterSource.getFeatures(),\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          } else {\r\n            const source = layer.ol.getSource() as any;\r\n            features = writer.writeFeatures(\r\n              source.getFeatures(),\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          }\r\n          features = JSON.parse(features);\r\n          features.name = layer.options.title;\r\n          context.extraFeatures.push(features);\r\n        }\r\n      }\r\n    });\r\n\r\n    context.toolbar = this.toolbar;\r\n    context.tools = this.tools;\r\n\r\n    return context;\r\n  }\r\n\r\n  setTools(tools: Tool[]) {\r\n    this.tools = tools;\r\n  }\r\n\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar = toolbar;\r\n  }\r\n\r\n  private handleContextMessage(context: DetailedContext) {\r\n    if (this.context$.value && context.uri && this.context$.value.uri !== context.uri) {\r\n      this.messageService.removeAllAreNotError();\r\n    }\r\n\r\n    context.messages = context.messages ? context.messages : [];\r\n    context.messages.push(context.message);\r\n    context.messages.map(message => {\r\n      if (message) {\r\n        message.title = message.title\r\n          ? this.languageService.translate.instant(message.title)\r\n          : undefined;\r\n        message.text = message.text\r\n          ? this.languageService.translate.instant(message.text)\r\n          : undefined;\r\n        this.messageService.message(message as Message);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getContextByUri(uri: string): Observable<DetailedContext> {\r\n    if (this.baseUrl) {\r\n      let contextToLoad;\r\n      for (const key of Object.keys(this.contexts$.value)) {\r\n        contextToLoad = this.contexts$.value[key].find((c) => {\r\n          return c.uri === uri;\r\n        });\r\n        if (contextToLoad) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (contextToLoad && contextToLoad.imported) {\r\n        return of(contextToLoad);\r\n      }\r\n\r\n      // TODO : use always id or uri\r\n      const id = contextToLoad ? contextToLoad.id : uri;\r\n      return this.getDetails(id);\r\n    }\r\n\r\n    const importedContext = this.contexts$.value.ours.find((currentContext) => {\r\n      return currentContext.uri === uri && currentContext.imported === true;\r\n    });\r\n\r\n    if (importedContext) {\r\n      return of(importedContext);\r\n    } else {\r\n      return this.getLocalContext(uri);\r\n    }\r\n  }\r\n\r\n  getContextLayers(igoMap: IgoMap) {\r\n    const layers: Layer[] = [];\r\n    const mapLayers = igoMap.layers$.getValue();\r\n    mapLayers.forEach((layer) => {\r\n      if (!layer.baseLayer && layer.options.id !== 'searchPointerSummaryId') {\r\n        layers.push(layer);\r\n      }\r\n    });\r\n    return layers;\r\n  }\r\n\r\n  private readParamsFromRoute() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n\r\n    this.route.queryParams.subscribe((params) => {\r\n      const centerKey = this.route.options.centerKey;\r\n      if (centerKey && params[centerKey as string]) {\r\n        const centerParams = params[centerKey as string];\r\n        this.mapViewFromRoute.center = centerParams.split(',').map(Number);\r\n        this.mapViewFromRoute.geolocate = false;\r\n      }\r\n\r\n      const projectionKey = this.route.options.projectionKey;\r\n      if (projectionKey && params[projectionKey as string]) {\r\n        const projectionParam = params[projectionKey as string];\r\n        this.mapViewFromRoute.projection = projectionParam;\r\n      }\r\n\r\n      const zoomKey = this.route.options.zoomKey;\r\n      if (zoomKey && params[zoomKey as string]) {\r\n        const zoomParam = params[zoomKey as string];\r\n        this.mapViewFromRoute.zoom = Number(zoomParam);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getPath(file: string) {\r\n    const basePath = this.options.basePath.replace(/\\/$/, '');\r\n\r\n    return `${basePath}/${file}`;\r\n  }\r\n\r\n  private handleError(\r\n    error: HttpErrorResponse,\r\n    uri: string,\r\n    permissionError?: boolean\r\n  ) {\r\n    const context = this.contexts$.value.ours.find((obj) => obj.uri === uri);\r\n    const titleContext = context ? context.title : uri;\r\n    error.error.title = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.title'\r\n    );\r\n\r\n    error.error.message = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.text',\r\n      { value: titleContext }\r\n    );\r\n\r\n    error.error.toDisplay = true;\r\n\r\n    if (permissionError) {\r\n      error.error.title = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermissionTitle'\r\n      );\r\n      error.error.message = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermission'\r\n      );\r\n    }\r\n    this.messageService.error(error.error.message, error.error.title);\r\n  }\r\n\r\n  private handleContextsChange(\r\n    keepCurrentContext = true\r\n  ) {\r\n    const context = this.context$.value;\r\n    const editedContext = this.editedContext$.value;\r\n    if (!context || context.uri === this.options.defaultContextUri) {\r\n      keepCurrentContext = false;\r\n    }\r\n    if (!keepCurrentContext || !this.findContext(context)) {\r\n      this.defaultContextUri = undefined;\r\n      this.loadDefaultContext();\r\n    } else {\r\n      this.getContextByUri(context.uri)\r\n        .pipe(first())\r\n        .subscribe(\r\n          (newContext: DetailedContext) => {\r\n            this.toolsChanged$.next(newContext);\r\n          }\r\n        );\r\n\r\n      if (this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe();\r\n      }\r\n    }\r\n    const editedFound = this.findContext(editedContext);\r\n    if (!editedFound || editedFound.permission !== 'write') {\r\n      this.setEditedContext(undefined);\r\n    }\r\n  }\r\n\r\n  private addContextToList(context: Context) {\r\n    const contextFound = this.findContext(context);\r\n    if (!contextFound) {\r\n      const contextSimplifie = {\r\n        id: context.id,\r\n        uri: context.uri,\r\n        title: context.title,\r\n        scope: context.scope,\r\n        permission: TypePermission[TypePermission.read]\r\n      };\r\n\r\n      if (this.contexts$.value && this.contexts$.value.public) {\r\n        this.contexts$.value.public.push(contextSimplifie);\r\n        this.contexts$.next(this.contexts$.value);\r\n      }\r\n    }\r\n  }\r\n\r\n  private findContext(context: Context) {\r\n    if (!context) {\r\n      return false;\r\n    }\r\n\r\n    const contexts = this.contexts$.value;\r\n    let found;\r\n    for (const key of Object.keys(contexts)) {\r\n      const value = contexts[key];\r\n      found = value.find(\r\n        (c) =>\r\n          (context.id && c.id === context.id) ||\r\n          (context.uri && c.uri === context.uri)\r\n      );\r\n      if (found) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    return found;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { ContextImportExportComponent } from './context-import-export/context-import-export.component';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    MatTooltipModule,\r\n  ],\r\n  exports: [\r\n    ContextImportExportComponent\r\n  ],\r\n  declarations: [\r\n    ContextImportExportComponent\r\n  ]\r\n})\r\nexport class IgoContextImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextImportExportModule> {\r\n    return {\r\n      ngModule: IgoContextImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { MapViewOptions, MapBrowserComponent, MapControlsOptions, MapScaleLineOptions } from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext, ContextMapView } from './context.interface';\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Directive({\r\n  selector: '[igoMapContext]'\r\n})\r\nexport class MapContextDirective implements OnInit, OnDestroy {\r\n  private component: MapBrowserComponent;\r\n  private context$$: Subscription;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter(context => context !== undefined))\r\n      .subscribe(context => this.handleContextChange(context));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    // This creates a new ol.Map when the context changes. Doing that\r\n    // allows the print tool to work properly even when the map's canvas\r\n    // has been tainted (CORS) with the layers of another context. This could\r\n    // have some side effects such as unbinding all listeners on the first map.\r\n    // A better solution would be to create a new map (preview) before\r\n    // printing and avoid the tainted canvas issue. This will come later so\r\n    // this snippet of code is kept here in case it takes too long becomes\r\n    // an issue\r\n\r\n    // const target = this.component.map.ol.getTarget();\r\n    // this.component.map.ol.setTarget(undefined);\r\n    // this.component.map.init();\r\n    // this.component.map.ol.setTarget(target);\r\n\r\n    const viewContext: ContextMapView = context.map.view;\r\n    if (!this.component.view || viewContext.keepCurrentView !== true) {\r\n      this.component.view = viewContext as MapViewOptions;\r\n    }\r\n\r\n    const controlsContext: MapControlsOptions = context.map.controls;\r\n    if (!this.component.controls && controlsContext) {\r\n      if (this.mediaService.isMobile()) {\r\n        if (typeof(controlsContext.scaleLine) !== 'boolean') {\r\n          const scaleLineOption = controlsContext.scaleLine as MapScaleLineOptions;\r\n          if (!scaleLineOption.minWidth) {\r\n            scaleLineOption.minWidth = Math.min(64, scaleLineOption.minWidth);\r\n            controlsContext.scaleLine = scaleLineOption;\r\n          }\r\n        }\r\n      }\r\n      this.component.controls = controlsContext;\r\n    }\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy, Optional, Input } from '@angular/core';\r\n\r\nimport { Subscription, merge } from 'rxjs';\r\nimport { buffer, debounceTime, filter } from 'rxjs/operators';\r\n\r\nimport { RouteService, ConfigService } from '@igo2/core';\r\nimport {\r\n  MapBrowserComponent,\r\n  Layer,\r\n  LayerService,\r\n  LayerOptions,\r\n  StyleListService,\r\n  StyleService\r\n} from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext } from './context.interface';\r\nimport {\r\n  addImportedFeaturesToMap,\r\n  addImportedFeaturesStyledToMap\r\n} from '../../context-import-export/shared/context-import.utils';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\n\r\n@Directive({\r\n  selector: '[igoLayerContext]'\r\n})\r\nexport class LayerContextDirective implements OnInit, OnDestroy {\r\n  private context$$: Subscription;\r\n  private queryParams: any;\r\n\r\n  private contextLayers: Layer[] = [];\r\n\r\n  @Input() removeLayersOnContextChange: boolean = true;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    private component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private layerService: LayerService,\r\n    private configService: ConfigService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter((context) => context !== undefined))\r\n      .subscribe((context) => this.handleContextChange(context));\r\n\r\n    if (\r\n      this.route &&\r\n      this.route.options.visibleOnLayersKey &&\r\n      this.route.options.visibleOffLayersKey &&\r\n      this.route.options.contextKey\r\n    ) {\r\n      const queryParams$$ = this.route.queryParams.subscribe((params) => {\r\n        if (Object.keys(params).length > 0) {\r\n          this.queryParams = params;\r\n          queryParams$$.unsubscribe();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.layers === undefined) {\r\n      return;\r\n    }\r\n    if (this.removeLayersOnContextChange === true) {\r\n      this.map.removeAllLayers();\r\n    } else {\r\n      this.map.removeLayers(this.contextLayers);\r\n    }\r\n    this.contextLayers = [];\r\n\r\n    const layersAndIndex$ = merge(\r\n      ...context.layers.map((layerOptions: LayerOptions, index: number) => {\r\n        return this.layerService.createAsyncLayer(layerOptions, context.uri);\r\n      })\r\n    );\r\n\r\n    layersAndIndex$\r\n      .pipe(buffer(layersAndIndex$.pipe(debounceTime(500))))\r\n      .subscribe((layers: Layer[]) => {\r\n        layers = layers\r\n          .filter((layer: Layer) => layer !== undefined)\r\n          .map((layer) => {\r\n            layer.visible = this.computeLayerVisibilityFromUrl(layer);\r\n            layer.zIndex = layer.zIndex;\r\n\r\n            return layer;\r\n          });\r\n\r\n        this.contextLayers.concat(layers);\r\n        this.map.addLayers(layers);\r\n\r\n        if (context.extraFeatures) {\r\n          context.extraFeatures.forEach((featureCollection) => {\r\n            const format = new GeoJSON();\r\n            const title = featureCollection.name;\r\n            featureCollection = JSON.stringify(featureCollection);\r\n            featureCollection = format.readFeatures(featureCollection, {\r\n              dataProjection: 'EPSG:4326',\r\n              featureProjection: 'EPSG:3857'\r\n            });\r\n            if (!this.configService.getConfig('importWithStyle')) {\r\n              addImportedFeaturesToMap(featureCollection, this.map, title);\r\n            } else {\r\n              addImportedFeaturesStyledToMap(\r\n                featureCollection,\r\n                this.map,\r\n                title,\r\n                this.styleListService,\r\n                this.styleService\r\n              );\r\n            }\r\n          });\r\n        }\r\n      });\r\n  }\r\n\r\n  private computeLayerVisibilityFromUrl(layer: Layer): boolean {\r\n    const params = this.queryParams;\r\n    const currentContext = this.contextService.context$.value.uri;\r\n    const currentLayerid: string = layer.id;\r\n\r\n    let visible = layer.visible;\r\n    if (!params || !currentLayerid) {\r\n      return visible;\r\n    }\r\n\r\n    const contextParams = params[this.route.options.contextKey as string];\r\n    if (contextParams === currentContext || !contextParams) {\r\n      let visibleOnLayersParams = '';\r\n      let visibleOffLayersParams = '';\r\n      let visiblelayers: string[] = [];\r\n      let invisiblelayers: string[] = [];\r\n\r\n      if (\r\n        this.route.options.visibleOnLayersKey &&\r\n        params[this.route.options.visibleOnLayersKey as string]\r\n      ) {\r\n        visibleOnLayersParams =\r\n          params[this.route.options.visibleOnLayersKey as string];\r\n      }\r\n      if (\r\n        this.route.options.visibleOffLayersKey &&\r\n        params[this.route.options.visibleOffLayersKey as string]\r\n      ) {\r\n        visibleOffLayersParams =\r\n          params[this.route.options.visibleOffLayersKey as string];\r\n      }\r\n\r\n      /* This order is important because to control whichever\r\n       the order of * param. First whe open and close everything.*/\r\n      if (visibleOnLayersParams === '*') {\r\n        visible = true;\r\n      }\r\n      if (visibleOffLayersParams === '*') {\r\n        visible = false;\r\n      }\r\n\r\n      // After, managing named layer by id (context.json OR id from datasource)\r\n      visiblelayers = visibleOnLayersParams.split(',');\r\n      invisiblelayers = visibleOffLayersParams.split(',');\r\n      if (visiblelayers.indexOf(currentLayerid) > -1 || visiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = true;\r\n      }\r\n      if (invisiblelayers.indexOf(currentLayerid) > -1 || invisiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = false;\r\n      }\r\n    }\r\n\r\n    return visible;\r\n  }\r\n}\r\n","import * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  IgoMap,\r\n  VectorLayer,\r\n  QueryableDataSourceOptions,\r\n  StyleService,\r\n  StyleListService,\r\n  StyleByAttribute,\r\n  ClusterParam,\r\n  ClusterDataSourceOptions,\r\n  ClusterDataSource\r\n} from '@igo2/geo';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { DetailedContext } from '../../context-manager/shared/context.interface';\r\nimport { ContextService } from '../../context-manager/shared/context.service';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  context: DetailedContext,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  contextService: ContextService\r\n) {\r\n  if (Object.keys(context).length <= 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const contextTitle = computeLayerTitleFromFile(file);\r\n\r\n  addContextToContextList(context, contextTitle, contextService);\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant(\r\n    'igo.context.contextImportExport.import.success.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.success.text',\r\n    {\r\n      value: contextTitle\r\n    }\r\n  );\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    languageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.invalid.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.invalid.text',\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.tooLarge.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.tooLarge.text',\r\n    {\r\n      value: file.name,\r\n      size: sizeMb\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.unreadable.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.unreadable.text',\r\n    {\r\n      value: file.name\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.empty.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.empty.text',\r\n    {\r\n      value: file.name\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function addContextToContextList(\r\n  context: DetailedContext,\r\n  contextTitle: string,\r\n  contextService: ContextService\r\n) {\r\n  context.title = contextTitle;\r\n  context.imported = true;\r\n  contextService.contexts$.value.ours.unshift(context);\r\n  contextService.contexts$.next(contextService.contexts$.value);\r\n  contextService.importedContext.unshift(context);\r\n  contextService.loadContext(context.uri);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name.split('.').pop().toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n\r\nexport function addImportedFeaturesToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    source,\r\n    style: new olStyle.Style({\r\n      stroke,\r\n      fill,\r\n      image: new olStyle.Circle({\r\n        radius: 5,\r\n        stroke,\r\n        fill\r\n      })\r\n    })\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addImportedFeaturesStyledToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService\r\n): VectorLayer {\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    const baseStyle = styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n    );\r\n\r\n    style = (feature) => {\r\n      return styleService.createClusterStyle(feature, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style')\r\n    );\r\n  } else {\r\n    style = styleService.createStyle(\r\n      styleListService.getStyleList('default.style')\r\n    );\r\n  }\r\n  let source;\r\n\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    source,\r\n    style\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n","export enum ContextListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-bookmark-dialog',\r\n  templateUrl: './bookmark-dialog.component.html'\r\n})\r\nexport class BookmarkDialogComponent {\r\n  public title: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<BookmarkDialogComponent>) {}\r\n}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{ 'igo.context.bookmarkButton.dialog.title' | translate }}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <mat-form-field>\r\n    <input matInput required autocomplete=\"off\"\r\n      maxlength=\"128\"\r\n      [placeholder]=\"'igo.context.bookmarkButton.dialog.placeholder' | translate\"\r\n      [(ngModel)]=\"title\">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\"\r\n         [disabled]=\"!title\"\r\n         (click)=\"dialogRef.close(title)\">\r\n    {{'igo.common.confirmDialog.confirmBtn' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)=\"dialogRef.close(false)\">\r\n    {{'igo.common.confirmDialog.cancelBtn' | translate}}\r\n  </button>\r\n</div>\r\n","<mat-list-item\r\n  class=\"mat-list-item\"\r\n  [ngClass]=\"{'mat-list-item-light': hidden}\">\r\n  <button mat-list-avatar\r\n    *ngIf=\"auth.authenticated\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"auth.authenticated ? ('igo.context.contextManager.favorite' | translate) : ''\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon *ngIf=\"!context.iconImage\" svgIcon=\"{{context.icon ? context.icon : context.scope === 'public' ? 'earth' : 'star'}}\"></mat-icon>\r\n    <img *ngIf=\"context.iconImage\" [src]=\"context.iconImage\">\r\n  </button>\r\n  <h4 matLine>{{context.title}}</h4>\r\n\r\n  <div *ngIf=\"auth.authenticated\"\r\n       igoStopPropagation\r\n       class=\"igo-actions-container\">\r\n\r\n     <button *ngIf=\"collapsed && selected && (context.permission === typePermission[typePermission.write] || context.imported)\"\r\n       class=\"save-button\"\r\n       mat-icon-button\r\n       [matTooltip]=\"'igo.context.contextManager.save' | translate\"\r\n       matTooltipShowDelay=\"500\"\r\n       [color]=\"color\"\r\n       (click)=\"save.emit(context)\">\r\n       <mat-icon svgIcon=\"content-save\"></mat-icon>\r\n     </button>\r\n\r\n    <div #actions class=\"igo-actions-expand-container\">\r\n\r\n      <button *ngIf=\"canShare && !context.imported\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.managePermissions' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"managePermissions.emit(context)\">\r\n        <mat-icon svgIcon=\"account-arrow-right\"></mat-icon>\r\n      </button>\r\n\r\n      <!--button\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.manageTools' | translate\"\r\n        [color]=\"color\"\r\n        (click)=\"manageTools.emit(context)\">\r\n        <mat-icon svgIcon=\"widgets\"></mat-icon>\r\n      </button-->\r\n\r\n      <button *ngIf=\"!context.imported\"\r\n        class=\"clone-button\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.clone' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"clone.emit(context)\">\r\n        <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] && !context.imported\"\r\n        class=\"edit-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.edit' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"edit.emit(context)\">\r\n        <mat-icon svgIcon=\"pencil\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"!context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.hide' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"hide.emit(context)\">\r\n        <mat-icon svgIcon=\"eye\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.show' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"show.emit(context)\">\r\n        <mat-icon svgIcon=\"eye-off\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] || context.imported\"\r\n        class=\"delete-button\"\r\n        mat-icon-button\r\n        color=\"warn\"\r\n        [matTooltip]=\"'igo.context.contextManager.delete' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"delete.emit(context)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <button\r\n      class=\"actions-button\"\r\n      mat-icon-button\r\n      igoCollapse\r\n      [color]=\"color\"\r\n      [target]=\"actions\"\r\n      [collapsed]=collapsed\r\n      (click)=\"collapsed = !collapsed\">\r\n      <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { TypePermission } from '../shared/context.enum';\r\nimport { DetailedContext } from '../shared/context.interface';\r\n\r\n@Component({\r\n  selector: 'igo-context-item',\r\n  templateUrl: './context-item.component.html',\r\n  styleUrls: ['./context-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextItemComponent {\r\n  public typePermission = TypePermission;\r\n  public color = 'primary';\r\n  public collapsed = true;\r\n\r\n  @Input()\r\n  get context(): DetailedContext {\r\n    return this._context;\r\n  }\r\n  set context(value: DetailedContext) {\r\n    this._context = value;\r\n  }\r\n  private _context: DetailedContext;\r\n\r\n  @Input()\r\n  get default(): boolean {\r\n    return this._default;\r\n  }\r\n  set default(value: boolean) {\r\n    this._default = value;\r\n  }\r\n  private _default = false;\r\n\r\n  @Input() selected: boolean;\r\n\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n\r\n  get hidden(): boolean {\r\n    return this.context.hidden;\r\n  }\r\n\r\n  get canShare(): boolean {\r\n    return this.storageService.get('canShare') === true;\r\n  }\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  favoriteClick(context) {\r\n    if (this.auth.authenticated) {\r\n      this.favorite.emit(context);\r\n    }\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <mat-form-field *ngIf=\"showFilter()\" [ngClass]=\"auth.authenticated && configService.getConfig('context') ? 'context-filter-min-width' : 'context-filter-max-width'\">\r\n    <input\r\n      matInput\r\n      type=\"text\"\r\n      [placeholder]=\"'igo.context.contextManager.filterPlaceHolder' | translate\"\r\n      [(ngModel)]=\"term\">\r\n    <button\r\n      mat-button\r\n      mat-icon-button\r\n      matSuffix\r\n      class=\"clear-button\"\r\n      *ngIf=\"term.length\"\r\n      aria-label=\"Clear\"\r\n      color=\"warn\"\r\n      (click)=\"clearFilter()\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <button\r\n  *ngIf=\"!sortedAlpha\"\r\n  class=\"sort-alpha\"\r\n  mat-icon-button\r\n  [matTooltip]=\"'igo.context.contextManager.sortAlphabetically' | translate\"\r\n  matTooltipShowDelay=\"500\"\r\n  (click)=\"toggleSort(true)\">\r\n  <mat-icon color=\"primary\" svgIcon=\"sort-alphabetical-variant\"></mat-icon>\r\n  </button>\r\n  <button\r\n    *ngIf=\"sortedAlpha\"\r\n    class=\"sort-alpha\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.sortContextOrder' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    (click)=\"toggleSort(false)\">\r\n    <mat-icon color=\"warn\" svgIcon=\"sort-variant-remove\"></mat-icon>\r\n  </button>\r\n\r\n  <igo-actionbar *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"add-context-button\"\r\n    [iconColor]=\"color\"\r\n    [store]=\"actionStore\"\r\n    [withIcon]=\"true\"\r\n    icon=\"plus\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"false\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n  <button *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"users-filter\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.filterUser' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matMenuTriggerFor]=\"accountMenu\">\r\n    <mat-icon color=\"primary\" svgIcon=\"filter-menu\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu #accountMenu=\"matMenu\">\r\n    <ng-container *ngFor=\"let user of users\">\r\n      <span class=\"profilsMenu\">\r\n        <mat-checkbox\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(user).checked\"\r\n          [indeterminate]=\"getPermission(user).indeterminate\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(user)\">\r\n        </mat-checkbox>\r\n        <button *ngIf=\"user.childs\"\r\n          [matMenuTriggerFor]=\"subAccountMenu\"\r\n          mat-menu-item>\r\n          {{user.title}}\r\n        </button>\r\n        <button\r\n          mat-menu-item\r\n          *ngIf=\"!user.childs\">\r\n          {{user.title}}\r\n        </button>\r\n      </span>\r\n\r\n      <mat-menu #subAccountMenu=\"matMenu\">\r\n        <mat-checkbox *ngFor=\"let child of user.childs\"\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(child).checked\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(child, user)\">\r\n          {{child.title}}\r\n        </mat-checkbox>\r\n      </mat-menu>\r\n    </ng-container>\r\n\r\n    <span class=\"profilsMenu\">\r\n      <mat-checkbox\r\n        class=\"mat-menu-item\"\r\n        [checked]=\"showHidden\"\r\n        (click)=\"$event.stopPropagation()\"\r\n        (change)=\"showHiddenContexts.emit()\">\r\n      </mat-checkbox>\r\n      <button mat-menu-item>\r\n        {{ 'igo.context.contextManager.showHidden' | translate }}\r\n      </button>\r\n    </span>\r\n  </mat-menu>\r\n\r\n  <ng-template ngFor let-groupContexts [ngForOf]=\"contexts$ | async | keyvalue\">\r\n\r\n    <igo-collapsible *ngIf=\"groupContexts.value.length && auth.authenticated\" [title]=\"titleMapping[groupContexts.key] | translate\"\r\n      [collapsed]=\"collapsed[titleMapping[groupContexts.key]]\" (toggle)=\"collapsed[titleMapping[groupContexts.key]] = $event\">\r\n\r\n      <ng-template ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n        <igo-context-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n          [context]=\"context\"\r\n          [default]=\"context.id && this.defaultContextId && this.defaultContextId === context.id\"\r\n          (edit)=\"edit.emit(context)\"\r\n          (delete)=\"delete.emit(context)\"\r\n          (clone)=\"clone.emit(context)\"\r\n          (save)=\"save.emit(context)\"\r\n          (hide)=\"hideContext(context)\"\r\n          (show)=\"showContext(context)\"\r\n          (favorite)=\"favorite.emit(context)\"\r\n          (manageTools)=\"manageTools.emit(context)\"\r\n          (managePermissions)=\"managePermissions.emit(context)\"\r\n          (select)=\"select.emit(context)\"\r\n          (unselect)=\"unselect.emit(context)\">\r\n        </igo-context-item>\r\n      </ng-template>\r\n\r\n    </igo-collapsible>\r\n\r\n    <ng-template *ngIf=\"groupContexts.value.length && !auth.authenticated\" ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n      <igo-context-item\r\n        igoListItem\r\n        color=\"accent\"\r\n        [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n        [context]=\"context\"\r\n        [default]=\"this.defaultContextId === context.id\"\r\n        (select)=\"select.emit(context)\"\r\n        (unselect)=\"unselect.emit(context)\">\r\n      </igo-context-item>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport {\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission,\r\n  ContextProfils\r\n} from '../shared/context.interface';\r\nimport { ContextListControlsEnum } from './context-list.enum';\r\nimport {\r\n  Subscription,\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { BookmarkDialogComponent } from '../../context-map-button/bookmark-button/bookmark-dialog.component';\r\nimport { debounce } from 'rxjs/operators';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { ContextService } from '../shared/context.service';\r\n\r\n@Component({\r\n  selector: 'igo-context-list',\r\n  templateUrl: './context-list.component.html',\r\n  styleUrls: ['./context-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextListComponent implements OnInit, OnDestroy {\r\n  private contextsInitial: ContextsList = { ours: [] };\r\n  contexts$: BehaviorSubject<ContextsList> = new BehaviorSubject(\r\n    this.contextsInitial\r\n  );\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  private change$$: Subscription;\r\n\r\n  @Input()\r\n  get contexts(): ContextsList {\r\n    return this._contexts;\r\n  }\r\n  set contexts(value: ContextsList) {\r\n    this._contexts = value;\r\n    this.cdRef.detectChanges();\r\n    this.next();\r\n  }\r\n  private _contexts: ContextsList = { ours: [] };\r\n\r\n  @Input()\r\n  get selectedContext(): DetailedContext {\r\n    return this._selectedContext;\r\n  }\r\n  set selectedContext(value: DetailedContext) {\r\n    this._selectedContext = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _selectedContext: DetailedContext;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get defaultContextId(): string {\r\n    return this._defaultContextId;\r\n  }\r\n  set defaultContextId(value: string) {\r\n    this._defaultContextId = value;\r\n  }\r\n  private _defaultContextId: string;\r\n\r\n  public collapsed: { contextScope }[] = [];\r\n\r\n  @Output() select = new EventEmitter<DetailedContext>();\r\n  @Output() unselect = new EventEmitter<DetailedContext>();\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() create = new EventEmitter<{ title: string; empty: boolean }>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() showHiddenContexts = new EventEmitter<boolean>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n  @Output() filterPermissionsChanged = new EventEmitter<\r\n    ContextUserPermission[]\r\n  >();\r\n\r\n  public titleMapping = {\r\n    ours: 'igo.context.contextManager.ourContexts',\r\n    shared: 'igo.context.contextManager.sharedContexts',\r\n    public: 'igo.context.contextManager.publicContexts'\r\n  };\r\n\r\n  public users: ContextProfils[];\r\n  public permissions: ContextUserPermission[] = [];\r\n\r\n  public actionStore = new ActionStore([]);\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public color = 'primary';\r\n\r\n  public showHidden = false;\r\n\r\n  /**\r\n   * Context filter term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.next();\r\n  }\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  public _term: string = '';\r\n\r\n  get sortedAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortedAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha: boolean = undefined;\r\n\r\n  public showContextFilter = ContextListControlsEnum.always;\r\n\r\n  public thresholdToFilter = 5;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private contextService: ContextService,\r\n    public configService: ConfigService,\r\n    public auth: AuthService,\r\n    private dialog: MatDialog,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.contexts.ours.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.contexts$.next(this.filterContextsList(this.contexts));\r\n      });\r\n\r\n    this.actionStore.load([\r\n      {\r\n        id: 'emptyContext',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContext'\r\n        ),\r\n        icon: 'map-outline',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContextTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'contextFromMap',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMap'\r\n        ),\r\n        icon: 'map-check',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMapTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(false);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private filterContextsList(contexts: ContextsList) {\r\n    if (this.term === '') {\r\n      if (this.sortedAlpha) {\r\n        contexts = this.sortContextsList(contexts);\r\n      }\r\n      return contexts;\r\n    } else {\r\n      const ours = contexts.ours.filter((context) => {\r\n        const filterNormalized = this.term\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const contextTitleNormalized = context.title\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        return contextTitleNormalized.includes(filterNormalized);\r\n      });\r\n\r\n      let updateContexts: ContextsList = {\r\n        ours\r\n      };\r\n\r\n      if (this.contexts.public) {\r\n        const publics = contexts.public.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.public = publics;\r\n      }\r\n\r\n      if (this.contexts.shared) {\r\n        const shared = contexts.shared.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.shared = shared;\r\n      }\r\n\r\n      if (this.sortedAlpha) {\r\n        updateContexts = this.sortContextsList(updateContexts);\r\n      }\r\n      return updateContexts;\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n\r\n  public showFilter() {\r\n    switch (this.showContextFilter) {\r\n      case ContextListControlsEnum.always:\r\n        return true;\r\n      case ContextListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        let totalLength = this.contexts.ours.length;\r\n        this.contexts.public\r\n          ? (totalLength += this.contexts.public.length)\r\n          : (totalLength += 0);\r\n        this.contexts.shared\r\n          ? (totalLength += this.contexts.shared.length)\r\n          : (totalLength += 0);\r\n        if (totalLength >= this.thresholdToFilter) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  sortContextsList(contexts: ContextsList) {\r\n    if (contexts) {\r\n      const contextsList = JSON.parse(JSON.stringify(contexts));\r\n      contextsList.ours.sort((a, b) => {\r\n        if (this.normalize(a.title) < this.normalize(b.title)) {\r\n          return -1;\r\n        }\r\n        if (this.normalize(a.title) > this.normalize(b.title)) {\r\n          return 1;\r\n        }\r\n        return 0;\r\n      });\r\n\r\n      if (contextsList.shared) {\r\n        contextsList.shared.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      } else if (contextsList.public) {\r\n        contextsList.public.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      }\r\n      return contextsList;\r\n    }\r\n  }\r\n\r\n  normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  toggleSort(sortAlpha: boolean) {\r\n    this.sortedAlpha = sortAlpha;\r\n  }\r\n\r\n  clearFilter() {\r\n    this.term = '';\r\n  }\r\n\r\n  createContext(empty?: boolean) {\r\n    this.dialog\r\n      .open(BookmarkDialogComponent, { disableClose: false })\r\n      .afterClosed()\r\n      .pipe(take(1))\r\n      .subscribe((title: string) => {\r\n        if (title) {\r\n          this.create.emit({ title, empty });\r\n        }\r\n      });\r\n  }\r\n\r\n  getPermission(user?): ContextUserPermission {\r\n    if (user) {\r\n      const permission = this.permissions.find((p) => p.name === user.name);\r\n      return permission;\r\n    }\r\n  }\r\n\r\n  userSelection(user, parent?) {\r\n    const permission = this.getPermission(user);\r\n    if (permission) {\r\n      permission.checked = !permission.checked;\r\n      this.storageService.set(\r\n        'contexts.permissions.' + permission.name,\r\n        permission.checked\r\n      );\r\n      permission.indeterminate = false;\r\n    }\r\n\r\n    if (parent) {\r\n      let indeterminate = false;\r\n\r\n      for (const c of parent.childs) {\r\n        const cPermission = this.getPermission(c);\r\n        if (cPermission.checked !== permission.checked) {\r\n          indeterminate = true;\r\n          break;\r\n        }\r\n      }\r\n      const parentPermission = this.getPermission(parent);\r\n      if (parentPermission) {\r\n        parentPermission.checked = permission.checked;\r\n        this.storageService.set(\r\n          'contexts.permissions.' + parentPermission.name,\r\n          permission.checked\r\n        );\r\n        parentPermission.indeterminate = indeterminate;\r\n      }\r\n    }\r\n\r\n    if (user.childs) {\r\n      for (const c of user.childs) {\r\n        const childrenPermission = this.getPermission(c);\r\n        if (\r\n          childrenPermission &&\r\n          childrenPermission.checked !== permission.checked\r\n        ) {\r\n          childrenPermission.checked = permission.checked;\r\n          this.storageService.set(\r\n            'contexts.permissions.' + childrenPermission.name,\r\n            permission.checked\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    this.filterPermissionsChanged.emit(this.permissions);\r\n  }\r\n\r\n  hideContext(context: DetailedContext) {\r\n    context.hidden = true;\r\n    if (!this.showHidden) {\r\n      const contexts: ContextsList = { ours: [], shared: [], public: [] };\r\n      contexts.ours = this.contexts.ours.filter((c) => c.id !== context.id);\r\n      contexts.shared = this.contexts.shared.filter((c) => c.id !== context.id);\r\n      contexts.public = this.contexts.public.filter((c) => c.id !== context.id);\r\n      this.contexts = contexts;\r\n    }\r\n    this.hide.emit(context);\r\n  }\r\n\r\n  showContext(context: DetailedContext) {\r\n    context.hidden = false;\r\n    this.show.emit(context);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Self,\r\n  OnInit,\r\n  OnDestroy,\r\n  HostListener\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { MessageService, LanguageService, StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfirmDialogService } from '@igo2/common';\r\nimport { MapService } from '@igo2/geo';\r\n\r\nimport {\r\n  Context,\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission\r\n} from '../shared/context.interface';\r\nimport { ContextService } from '../shared/context.service';\r\nimport { ContextListComponent } from './context-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoContextListBinding]'\r\n})\r\nexport class ContextListBindingDirective implements OnInit, OnDestroy {\r\n  private component: ContextListComponent;\r\n  private contexts$$: Subscription;\r\n  private selectedContext$$: Subscription;\r\n  private defaultContextId$$: Subscription;\r\n\r\n  @HostListener('select', ['$event'])\r\n  onSelect(context: Context) {\r\n    this.contextService.loadContext(context.uri);\r\n  }\r\n\r\n  @HostListener('edit', ['$event'])\r\n  onEdit(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('save', ['$event'])\r\n  onSave(context: Context) {\r\n    const map = this.mapService.getMap();\r\n    const contextFromMap = this.contextService.getContextFromMap(map);\r\n\r\n    const msgSuccess = () => {\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.saveMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.saveTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    };\r\n\r\n    if (context.imported) {\r\n      contextFromMap.title = context.title;\r\n      this.contextService.delete(context.id, true);\r\n      this.contextService.create(contextFromMap).subscribe((contextCreated) => {\r\n        this.contextService.loadContext(contextCreated.uri);\r\n        msgSuccess();\r\n      });\r\n      return;\r\n    }\r\n\r\n    const changes: any = {\r\n      layers: contextFromMap.layers,\r\n      map: {\r\n        view: contextFromMap.map.view\r\n      }\r\n    };\r\n\r\n    this.contextService.update(context.id, changes).subscribe(() => {\r\n      msgSuccess();\r\n    });\r\n  }\r\n\r\n  @HostListener('favorite', ['$event'])\r\n  onFavorite(context: Context) {\r\n    this.contextService.setDefault(context.id).subscribe(() => {\r\n      this.contextService.defaultContextId$.next(context.id);\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.favoriteMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.favoriteTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    });\r\n  }\r\n\r\n  @HostListener('manageTools', ['$event'])\r\n  onManageTools(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('managePermissions', ['$event'])\r\n  onManagePermissions(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('delete', ['$event'])\r\n  onDelete(context: Context) {\r\n    const translate = this.languageService.translate;\r\n    this.confirmDialogService\r\n      .open(\r\n        translate.instant('igo.context.contextManager.dialog.confirmDelete')\r\n      )\r\n      .subscribe((confirm) => {\r\n        if (confirm) {\r\n          this.contextService\r\n            .delete(context.id, context.imported)\r\n            .subscribe(() => {\r\n              const message = translate.instant(\r\n                'igo.context.contextManager.dialog.deleteMsg',\r\n                {\r\n                  value: context.title\r\n                }\r\n              );\r\n              const title = translate.instant(\r\n                'igo.context.contextManager.dialog.deleteTitle'\r\n              );\r\n              this.messageService.info(message, title);\r\n            });\r\n        }\r\n      });\r\n  }\r\n\r\n  @HostListener('clone', ['$event'])\r\n  onClone(context: DetailedContext) {\r\n    const properties = {\r\n      title: context.title + '-copy',\r\n      uri: context.uri + '-copy'\r\n    };\r\n    this.contextService.clone(context.id, properties).subscribe(() => {\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.cloneMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.cloneTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    });\r\n  }\r\n\r\n  @HostListener('create', ['$event'])\r\n  onCreate(opts: { title: string; empty: boolean }) {\r\n    const { title, empty } = opts;\r\n    const context = this.contextService.getContextFromMap(\r\n      this.component.map,\r\n      empty\r\n    );\r\n    context.title = title;\r\n    this.contextService.create(context).subscribe(() => {\r\n      const translate = this.languageService.translate;\r\n      const titleD = translate.instant(\r\n        'igo.context.bookmarkButton.dialog.createTitle'\r\n      );\r\n      const message = translate.instant(\r\n        'igo.context.bookmarkButton.dialog.createMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      this.messageService.success(message, titleD);\r\n      this.contextService.loadContext(context.uri);\r\n    });\r\n  }\r\n\r\n  @HostListener('filterPermissionsChanged')\r\n  loadContexts() {\r\n    const permissions = ['none'];\r\n    for (const p of this.component.permissions) {\r\n      if (p.checked === true || p.indeterminate === true) {\r\n        permissions.push(p.name);\r\n      }\r\n    }\r\n    this.component.showHidden\r\n      ? this.contextService.loadContexts(permissions, true)\r\n      : this.contextService.loadContexts(permissions, false);\r\n  }\r\n\r\n  @HostListener('showHiddenContexts')\r\n  showHiddenContexts() {\r\n    this.component.showHidden = !this.component.showHidden;\r\n    this.storageService.set('contexts.showHidden', this.component.showHidden);\r\n    this.loadContexts();\r\n  }\r\n\r\n  @HostListener('show', ['$event'])\r\n  onShowContext(context: DetailedContext) {\r\n    this.contextService.showContext(context.id).subscribe();\r\n  }\r\n\r\n  @HostListener('hide', ['$event'])\r\n  onHideContext(context: DetailedContext) {\r\n    this.contextService.hideContext(context.id).subscribe();\r\n  }\r\n\r\n  constructor(\r\n    @Self() component: ContextListComponent,\r\n    private contextService: ContextService,\r\n    private mapService: MapService,\r\n    private languageService: LanguageService,\r\n    private confirmDialogService: ConfirmDialogService,\r\n    private messageService: MessageService,\r\n    private auth: AuthService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input contexts\r\n    this.component.contexts = { ours: [] };\r\n    this.component.showHidden = this.storageService.get(\r\n      'contexts.showHidden'\r\n    ) as boolean;\r\n\r\n    this.contexts$$ = this.contextService.contexts$.subscribe((contexts) =>\r\n      this.handleContextsChange(contexts)\r\n    );\r\n\r\n    this.defaultContextId$$ = this.contextService.defaultContextId$.subscribe(\r\n      (id) => {\r\n        this.component.defaultContextId = id;\r\n      }\r\n    );\r\n\r\n    // See feature-list.component for an explanation about the debounce time\r\n    this.selectedContext$$ = this.contextService.context$\r\n      .pipe(debounceTime(100))\r\n      .subscribe((context) => (this.component.selectedContext = context));\r\n\r\n    this.auth.authenticate$.subscribe((authenticate) => {\r\n      if (authenticate) {\r\n        this.contextService.getProfilByUser().subscribe((profils) => {\r\n          this.component.users = profils;\r\n          this.component.permissions = [];\r\n          const profilsAcc = this.component.users.reduce((acc, cur) => {\r\n            acc = acc.concat(cur);\r\n            acc = cur.childs ? acc.concat(cur.childs) : acc;\r\n            return acc;\r\n          }, []);\r\n\r\n          for (const user of profilsAcc) {\r\n            const permission: ContextUserPermission = {\r\n              name: user.name,\r\n              checked: this.storageService.get(\r\n                'contexts.permissions.' + user.name\r\n              ) as boolean\r\n            };\r\n            if (permission.checked === null) {\r\n              permission.checked = true;\r\n            }\r\n            this.component.permissions.push(permission);\r\n          }\r\n\r\n          const permissions = ['none'];\r\n          for (const p of this.component.permissions) {\r\n            if (p.checked === true || p.indeterminate === true) {\r\n              permissions.push(p.name);\r\n            }\r\n          }\r\n\r\n          this.component.showHidden\r\n            ? this.contextService.loadContexts(permissions, true)\r\n            : this.contextService.loadContexts(permissions, false);\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.contexts$$.unsubscribe();\r\n    this.selectedContext$$.unsubscribe();\r\n    this.defaultContextId$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextsChange(contexts: ContextsList) {\r\n    this.component.contexts = contexts;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, EMPTY } from 'rxjs';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { Poi } from './poi.interface';\r\n\r\n@Injectable()\r\nexport class PoiService {\r\n  private baseUrl: string;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.baseUrl = this.config.getConfig('context.url');\r\n  }\r\n\r\n  get(): Observable<Poi[]> {\r\n    if (!this.baseUrl) {\r\n      return EMPTY;\r\n    }\r\n\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.get<Poi[]>(url);\r\n  }\r\n\r\n  delete(id: string): Observable<void> {\r\n    const url = this.baseUrl + '/pois/' + id;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  create(context: Poi): Observable<Poi> {\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.post<Poi>(url, context);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule, IgoStopPropagationModule } from '@igo2/common';\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { BookmarkButtonComponent } from './bookmark-button/bookmark-button.component';\r\nimport { BookmarkDialogComponent } from './bookmark-button/bookmark-dialog.component';\r\nimport { PoiButtonComponent } from './poi-button/poi-button.component';\r\nimport { PoiDialogComponent } from './poi-button/poi-dialog.component';\r\nimport { PoiService } from './poi-button/shared/poi.service';\r\nimport { UserDialogComponent } from './user-button/user-dialog.component';\r\nimport { UserButtonComponent } from './user-button/user-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    IgoStopPropagationModule,\r\n    IgoAuthModule,\r\n    FormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatDialogModule,\r\n    MatInputModule\r\n  ],\r\n  exports: [BookmarkButtonComponent, PoiButtonComponent, UserButtonComponent, BookmarkDialogComponent],\r\n  declarations: [\r\n    BookmarkButtonComponent,\r\n    BookmarkDialogComponent,\r\n    PoiButtonComponent,\r\n    PoiDialogComponent,\r\n    UserButtonComponent,\r\n    UserDialogComponent\r\n  ],\r\n  providers: [PoiService]\r\n})\r\nexport class IgoContextMapButtonModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMapButtonModule> {\r\n    return {\r\n      ngModule: IgoContextMapButtonModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoCollapsibleModule,\r\n  IgoStopPropagationModule,\r\n  IgoActionbarModule\r\n} from '@igo2/common';\r\n\r\nimport { MapContextDirective } from './shared/map-context.directive';\r\nimport { LayerContextDirective } from './shared/layer-context.directive';\r\nimport { ContextListComponent } from './context-list/context-list.component';\r\nimport { ContextListBindingDirective } from './context-list/context-list-binding.directive';\r\nimport { ContextItemComponent } from './context-item/context-item.component';\r\nimport { ContextFormComponent } from './context-form/context-form.component';\r\nimport { ContextEditComponent } from './context-edit/context-edit.component';\r\nimport { ContextEditBindingDirective } from './context-edit/context-edit-binding.directive';\r\nimport { ContextPermissionsComponent } from './context-permissions/context-permissions.component';\r\nimport { ContextPermissionsBindingDirective } from './context-permissions/context-permissions-binding.directive';\r\nimport { IgoContextMapButtonModule } from '../context-map-button/context-map-button.module';\r\nimport { IgoContextImportExportModule } from '../context-import-export/context-import-export.module';\r\n\r\nconst CONTEXT_DIRECTIVES = [\r\n  MapContextDirective,\r\n  LayerContextDirective\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatCheckboxModule,\r\n    MatRadioModule,\r\n    MatDialogModule,\r\n    MatMenuModule,\r\n    MatOptionModule,\r\n    MatAutocompleteModule,\r\n    IgoAuthModule,\r\n    IgoListModule,\r\n    IgoKeyValueModule,\r\n    IgoCollapsibleModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoContextImportExportModule,\r\n    IgoContextMapButtonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ],\r\n  declarations: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ]\r\n})\r\nexport class IgoContextManagerModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextManagerModule> {\r\n    return {\r\n      ngModule: IgoContextManagerModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ExportOptions } from '@igo2/geo';\r\n\r\nexport enum ImportExportType {\r\n  layer = 'layer',\r\n  context = 'context'\r\n}\r\n\r\nexport enum ImportExportMode {\r\n  import = 'import',\r\n  export = 'export'\r\n}\r\n\r\n/**\r\n * Service that holds the state of the importExport module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportExportState {\r\n\r\n  readonly importExportType$: BehaviorSubject<ImportExportType> = new BehaviorSubject(ImportExportType.layer);\r\n  readonly selectedMode$: BehaviorSubject<ImportExportMode> = new BehaviorSubject(ImportExportMode.import);\r\n  readonly exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(undefined);\r\n\r\n  setImportExportType(type: ImportExportType) {\r\n    this.importExportType$.next(type);\r\n  }\r\n\r\n  setMode(mode: ImportExportMode) {\r\n    this.selectedMode$.next(mode);\r\n  }\r\n\r\n  setsExportOptions(exportOptions: ExportOptions) {\r\n      this.exportOptions$.next(exportOptions);\r\n    }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Toolbox, ToolService } from '@igo2/common';\r\n\r\nimport { ExportOptions } from '@igo2/geo';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ImportExportMode, ImportExportState } from '../import-export/import-export.state';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolState {\r\n  get toolbox(): Toolbox {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  public openSidenav$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private importExportState: ImportExportState\r\n    ) {}\r\n\r\n    toolToActivateFromOptions(toolToActivate: { tool: string; options: {[key: string]: any} }) {\r\n    if (!toolToActivate) { return; }\r\n    if (toolToActivate.tool === 'importExport') {\r\n      let exportOptions: ExportOptions = this.importExportState.exportOptions$.value;\r\n      if (!exportOptions) {\r\n        exportOptions = {\r\n          layers: toolToActivate.options.layers,\r\n          featureInMapExtent: toolToActivate.options.featureInMapExtent\r\n        };\r\n      } else {\r\n        exportOptions.layers = toolToActivate.options.layers;\r\n        exportOptions.featureInMapExtent = toolToActivate.options.featureInMapExtent;\r\n      }\r\n      this.importExportState.setsExportOptions(exportOptions);\r\n      this.importExportState.setMode(ImportExportMode.export);\r\n    }\r\n\r\n    if (this.toolbox.getTool(toolToActivate.tool)) {\r\n      this.toolbox.activateTool(toolToActivate.tool);\r\n      this.openSidenav$.next(true);\r\n    }\r\n  }\r\n}\r\n","import {\r\n    FeatureMotion,\r\n    FeatureStoreSelectionStrategy,\r\n    FeatureWorkspace,\r\n    WfsWorkspace,\r\n    EditionWorkspace\r\n} from '@igo2/geo';\r\n\r\n\r\nexport function handleZoomAuto(workspace: FeatureWorkspace | WfsWorkspace | EditionWorkspace, storageService) {\r\n    const zoomStrategy = workspace.entityStore\r\n        .getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    zoomStrategy.setMotion(storageService.get('zoomAuto') as boolean ? FeatureMotion.Default : FeatureMotion.None);\r\n}\r\n\r\n\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\n\r\n/**\r\n * Service that holds the state of storage service\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageState {\r\n  get storageService(): StorageService {\r\n    return this.igoStorageService;\r\n  }\r\n\r\n  constructor(private igoStorageService: StorageService) {}\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  FeatureWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private toolState: ToolState,\r\n    private mediaService: MediaService\r\n  ) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(\r\n        skipWhile(\r\n          (storageChange: StorageServiceEvent) =>\r\n            storageChange.key !== 'zoomAuto' || storageChange.event === StorageServiceEventEnum.CLEARED\r\n        )\r\n      )\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    return [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set(\r\n            'zoomAuto',\r\n            !this.storageService.get('zoomAuto') as boolean\r\n          );\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.tooltip',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), {\r\n            selected: false\r\n          });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: FeatureWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'featureDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterCustomFuncStrategy\r\n          );\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterSelectionStrategy\r\n          );\r\n          const layersWithSelection = filterSelectionStrategy.active\r\n            ? [ws.layer.id]\r\n            : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: {\r\n              layers: [ws.layer.id],\r\n              featureInMapExtent: filterStrategy.active,\r\n              layersWithSelection\r\n            } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  WfsWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  // rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange.key !== 'zoomAuto' || storageChange.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: WfsWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: WfsWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).ogcFilters$?.value?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  EditionWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange.key !== 'zoomAuto' || storageChange.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: EditionWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: EditionWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).ogcFilters$?.value?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  EntityRecord,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  Widget,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy } from '@igo2/common';\r\nimport { WfsWorkspace, FeatureWorkspace, EditionWorkspace } from '@igo2/geo';\r\nimport { FeatureActionsService } from './shared/feature-actions.service';\r\nimport { WfsActionsService } from './shared/wfs-actions.service';\r\nimport { StorageService } from '@igo2/core';\r\nimport { EditionActionsService } from './shared/edition-actions.service';\r\n\r\n/**\r\n * Service that holds the state of the workspace module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WorkspaceState implements OnDestroy {\r\n\r\n  public workspacePanelExpanded: boolean = false;\r\n\r\n  readonly workspaceEnabled$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n  readonly rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n  readonly selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  readonly workspaceMaximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n  private actionMaximize$$: Subscription[] = [];\r\n\r\n  private rowsInMapExtentCheckCondition$$: Subscription;\r\n  private selectOnlyCheckCondition$$: Subscription;\r\n\r\n  /** Subscription to the active workspace */\r\n  private activeWorkspace$$: Subscription;\r\n\r\n  /** Subscription to the active workspace widget */\r\n  private activeWorkspaceWidget$$: Subscription;\r\n\r\n  /** Active widget observable. Only one may be active for all available workspaces */\r\n  readonly activeWorkspaceWidget$: BehaviorSubject<Widget> = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the active workspace\r\n   */\r\n  public workspace$ = new BehaviorSubject<Workspace>(undefined);\r\n\r\n  /**\r\n   * Store that holds all the available workspaces\r\n   */\r\n  get store(): WorkspaceStore { return this._store; }\r\n  private _store: WorkspaceStore;\r\n\r\n  constructor(\r\n    private featureActionsService: FeatureActionsService,\r\n    private wfsActionsService: WfsActionsService,\r\n    private editionActionsService: EditionActionsService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.initWorkspaces();\r\n  }\r\n\r\n  /**\r\n   * Initialize the workspace store. Each time a workspace is activated,\r\n   * subscribe to it's active widget. Tracking the active widget is useful\r\n   * to make sure only one widget is active at a time.\r\n   */\r\n  private initWorkspaces() {\r\n    this._store = new WorkspaceStore([]);\r\n    this._store.stateView\r\n      .firstBy$((record: EntityRecord<Workspace>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Workspace>) => {\r\n        const workspace = record ? record.entity : undefined;\r\n        this.workspace$.next(workspace);\r\n      });\r\n\r\n    this._store.stateView.all$()\r\n    .subscribe((workspaces: EntityRecord<Workspace>[]) => {\r\n      workspaces.map((wks: EntityRecord<Workspace>) => {\r\n        if (wks.entity.actionStore.empty) {\r\n          if (wks.entity instanceof WfsWorkspace) {\r\n            this.wfsActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof FeatureWorkspace) {\r\n            this.featureActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof EditionWorkspace) {\r\n            this.editionActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          }\r\n        }\r\n\r\n      });\r\n    });\r\n\r\n    this.actionMaximize$$.push(this.featureActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.wfsActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.editionActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.activeWorkspace$$ = this.workspace$\r\n      .subscribe((workspace: Workspace) => {\r\n        if (this.activeWorkspaceWidget$$ !== undefined) {\r\n          this.activeWorkspaceWidget$$.unsubscribe();\r\n          this.activeWorkspaceWidget$$ = undefined;\r\n        }\r\n\r\n        if (workspace !== undefined) {\r\n          this.activeWorkspaceWidget$$ = workspace.widget$\r\n            .subscribe((widget: Widget) => this.activeWorkspaceWidget$.next(widget));\r\n        }\r\n      });\r\n\r\n    this.rowsInMapExtentCheckCondition$$ = this.rowsInMapExtentCheckCondition$.subscribe((rowsInMapExtent) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          if (filterStrategy) {\r\n            if (rowsInMapExtent) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.selectOnlyCheckCondition$$ = this.selectOnlyCheckCondition$.subscribe((selectOnly) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          if (filterStrategy) {\r\n            if (selectOnly) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private setWorkspaceIsMaximized(maximized: boolean) {\r\n    this.storageService.set('workspaceMaximize', maximized);\r\n    this.workspaceMaximize$.next(maximized);\r\n  }\r\n\r\n  public setActiveWorkspaceById(id: string) {\r\n    const wksFromId = this.store\r\n    .all()\r\n    .find(workspace => workspace.id === id);\r\n    if (wksFromId) {\r\n      this.store.activateWorkspace(wksFromId);\r\n    }\r\n  }\r\n\r\n  public setActiveWorkspaceByTitle(title: string) {\r\n    const wksFromTitle = this.store\r\n      .all()\r\n      .find(workspace => workspace.title === title);\r\n    if (wksFromTitle) {\r\n      this.store.activateWorkspace(wksFromTitle);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown all the workspaces\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.teardownWorkspaces();\r\n    this.actionMaximize$$.map(a => a.unsubscribe());\r\n    if (this.rowsInMapExtentCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n    if (this.selectOnlyCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown the workspace store and any subscribers\r\n   */\r\n  private teardownWorkspaces() {\r\n    this.store.clear();\r\n    if (this.activeWorkspaceWidget$$ !== undefined) {\r\n      this.activeWorkspaceWidget$$.unsubscribe();\r\n    }\r\n    if (this.activeWorkspace$$ !== undefined) {\r\n      this.activeWorkspace$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { EntityRecord, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreStrategyFuncOptions } from '@igo2/common';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\nimport { SearchResult, SearchSourceService, SearchSource, CommonVectorStyleOptions } from '@igo2/geo';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchState {\r\n  public searchOverlayStyle: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleSelection: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleFocus: CommonVectorStyleOptions = {};\r\n\r\n  public focusedOrResolution$$: Subscription;\r\n  public selectedOrResolution$$: Subscription;\r\n\r\n  readonly searchTermSplitter$: BehaviorSubject<string> = new BehaviorSubject('|');\r\n\r\n  readonly searchTerm$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchDisabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchResultsGeometryEnabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchSettingsChange$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly selectedResult$: BehaviorSubject<SearchResult> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store that holds the search results\r\n   */\r\n  readonly store: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n\r\n  /**\r\n   * Search types currently enabled in the search source service\r\n   */\r\n  get searchTypes(): string[] {\r\n    return this.searchSourceService\r\n      .getEnabledSources()\r\n      .map((source: SearchSource) => (source.constructor as any).type);\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService) {\r\n    const searchOverlayStyle = this.configService.getConfig('searchOverlayStyle') as {\r\n      base?: CommonVectorStyleOptions,\r\n      selection?: CommonVectorStyleOptions,\r\n      focus?: CommonVectorStyleOptions\r\n    };\r\n    if (searchOverlayStyle) {\r\n      this.searchOverlayStyle = searchOverlayStyle.base;\r\n      this.searchOverlayStyleSelection = searchOverlayStyle.selection;\r\n      this.searchOverlayStyleFocus = searchOverlayStyle.focus;\r\n    }\r\n\r\n    const searchResultsGeometryEnabled = this.storageService.get('searchResultsGeometryEnabled') as boolean;\r\n    if (searchResultsGeometryEnabled) {\r\n      this.searchResultsGeometryEnabled$.next(searchResultsGeometryEnabled);\r\n    }\r\n    this.store.addStrategy(this.createCustomFilterTermStrategy(), false);\r\n  }\r\n\r\n  private createCustomFilterTermStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<SearchResult>) => {\r\n      return record.entity.meta.score === 100;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  /**\r\n   * Activate custom strategy\r\n   *\r\n   */\r\n  activateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate custom strategy\r\n   *\r\n   */\r\n  deactivateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  enableSearch() {\r\n    this.searchDisabled$.next(false);\r\n  }\r\n\r\n  disableSearch() {\r\n    this.searchDisabled$.next(true);\r\n  }\r\n\r\n  setSearchTerm(searchTerm: string) {\r\n    this.searchTerm$.next(searchTerm);\r\n  }\r\n\r\n  setSearchType(searchType: string) {\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  setSearchSettingsChange() {\r\n    this.searchSettingsChange$.next(true);\r\n  }\r\n\r\n  setSelectedResult(result: SearchResult) {\r\n    this.selectedResult$.next(result);\r\n  }\r\n\r\n  setSearchResultsGeometryStatus(value) {\r\n    this.storageService.set('searchResultsGeometryEnabled', value);\r\n    this.searchResultsGeometryEnabled$.next(value);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoSearchModule } from '@igo2/geo';\r\n\r\nimport { SearchBarBindingDirective } from './search-bar-binding.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [IgoSearchModule],\r\n  declarations: [SearchBarBindingDirective],\r\n  exports: [SearchBarBindingDirective],\r\n})\r\nexport class IgoAppSearchBarModule {}\r\n","import { NgModule, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoFlexibleModule, IgoCustomHtmlModule, IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoSearchModule,\r\n  IgoFeatureDetailsModule\r\n} from '@igo2/geo';\r\n\r\nimport { SearchResultsToolComponent } from './search-results-tool.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFeatureModule,\r\n    IgoSearchModule,\r\n    IgoFlexibleModule,\r\n    IgoPanelModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  declarations: [SearchResultsToolComponent],\r\n  exports: [SearchResultsToolComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n})\r\nexport class IgoAppSearchResultsToolModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoAppSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoAppSearchResultsToolModule } from './search-results-tool/search-results-tool.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n   IgoAppSearchBarModule,\r\n   IgoAppSearchResultsToolModule\r\n  ],\r\n})\r\nexport class IgoAppSearchModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Search</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/search\">code of this example</a><br>\r\n    See search section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n    <br>\r\n    <span *ngIf=\"!isTouchScreen\" title=\"Details\">\r\n      F2 activate/deactivate the pointer location.\r\n    </span>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser #mapBrowser [map]=\"map\" [view]=\"view\" igoOverlay [igoContextMenu]=actionbarMenu\r\n\r\n    igoSearchPointerSummary\r\n    [igoSearchPointerSummaryDelay]=\"500\"\r\n    [igoSearchPointerSummaryEnabled]=\"igoSearchPointerSummaryEnabled\"\r\n    (menuPosition)=\"onContextMenuOpen($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Search\">\r\n    <igo-search-bar\r\n      (pointerSummaryStatus)=\"onPointerSummaryStatusChange($event)\"\r\n      [searchSettings]=\"true\"\r\n      [store]=\"searchStore\"\r\n      [termSplitter]=\"termSplitter\"\r\n      (searchTermChange)=\"onSearchTermChange($event)\"\r\n      (search)=\"onSearch($event)\"\r\n      (clearFeature)=\"removeFeatureFromMap()\"\r\n      (searchSettingsChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-bar>\r\n\r\n    <igo-search-results\r\n      [store]=\"searchStore\"\r\n      [term]=\"term\"\r\n      [termSplitter]=\"termSplitter\"\r\n      placeholder=\"false\"\r\n      [settingsChange$]=\"settingsChange$\"\r\n      (resultFocus)=\"onResultFocus($event)\"\r\n      (resultSelect)=\"onResultFocus($event)\"\r\n      (moreResults)=\"onSearch($event)\">\r\n        <ng-template #igoSearchItemToolbar let-result=\"result\">\r\n          <igo-search-add-button\r\n            [map]=\"map\"\r\n            [layer]=\"result\">\r\n          </igo-search-add-button>\r\n        </ng-template>\r\n    </igo-search-results>\r\n\r\n  </igo-panel>\r\n\r\n  <igo-panel *ngIf=\"selectedFeature\" title=\"Details\">\r\n    <igo-feature-details [feature]=\"selectedFeature\"></igo-feature-details>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"false\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSearchComponent } from './search.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'search',\r\n    component: AppSearchComponent\r\n  }\r\n];\r\n\r\nexport const AppSearchRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  Component,\r\n  ElementRef,\r\n  OnDestroy,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport * as proj from 'ol/proj';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityStore, ActionStore } from '@igo2/common';\r\nimport {\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion,\r\n  GoogleLinks,\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  Layer,\r\n  ProjectionService,\r\n  Research,\r\n  SearchResult,\r\n  SearchService\r\n} from '@igo2/geo';\r\n\r\nimport { SearchState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-search',\r\n  templateUrl: './search.component.html',\r\n  styleUrls: ['./search.component.scss']\r\n})\r\nexport class AppSearchComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  public igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  public termSplitter: string = '|';\r\n\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public osmLayer: Layer;\r\n\r\n  @ViewChild('mapBrowser', { read: ElementRef, static: true }) mapBrowser: ElementRef;\r\n\r\n  public lonlat;\r\n  public mapProjection: string;\r\n  public term: string;\r\n\r\n  public settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  get searchStore(): EntityStore<SearchResult> {\r\n    return this.searchState.store;\r\n  }\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  public selectedFeature: Feature;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private projectionService: ProjectionService,\r\n    private mapService: MapService,\r\n    private layerService: LayerService,\r\n    private searchState: SearchState,\r\n    private searchService: SearchService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => {\r\n        this.osmLayer = layer;\r\n        this.map.addLayer(layer);\r\n      });\r\n  }\r\n\r\n  onPointerSummaryStatusChange(value) {\r\n    this.igoSearchPointerSummaryEnabled = value;\r\n  }\r\n\r\n  onSearchTermChange(term = '') {\r\n    this.term = term;\r\n    const termWithoutHashtag = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (termWithoutHashtag.length < 2) {\r\n      this.searchStore.clear();\r\n      this.selectedFeature = undefined;\r\n    }\r\n  }\r\n\r\n  onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    this.searchStore.state.updateAll({ focused: false, selected: false });\r\n    const newResults = this.searchStore.entities$.value\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.searchStore.updateMany(newResults);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.settingsChange$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map when it's being focused\r\n   * @internal\r\n   * @param result A search result that could be a feature\r\n   */\r\n  onResultFocus(result: SearchResult) {\r\n    this.tryAddFeatureToMap(result);\r\n    this.selectedFeature = (result as SearchResult<Feature>).data;\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map overlay\r\n   * @param layer A search result that could be a feature\r\n   */\r\n  private tryAddFeatureToMap(layer: SearchResult) {\r\n    if (layer.meta.dataType !== FEATURE) {\r\n      return undefined;\r\n    }\r\n\r\n    // Somethimes features have no geometry. It happens with some GetFeatureInfo\r\n    if (layer.data.geometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.map.searchResultsOverlay.setFeatures(\r\n      [layer.data] as Feature[],\r\n      FeatureMotion.Default\r\n    );\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'coordinates',\r\n        title: 'coordinates',\r\n        handler: this.onSearchCoordinate.bind(this)\r\n      },\r\n      {\r\n        id: 'googleMaps',\r\n        title: 'googleMap',\r\n        handler: this.onOpenGoogleMaps.bind(this),\r\n        args: ['1']\r\n      },\r\n      {\r\n        id: 'googleStreetView',\r\n        title: 'googleStreetView',\r\n        handler: this.onOpenGoogleStreetView.bind(this)\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /*\r\n   * Remove a feature to the map overlay\r\n   */\r\n  removeFeatureFromMap() {\r\n    this.map.searchResultsOverlay.clear();\r\n  }\r\n\r\n  onContextMenuOpen(event: { x: number; y: number }) {\r\n    const position = this.mapPosition(event);\r\n    const coord = this.mapService.getMap().ol.getCoordinateFromPixel(position);\r\n    this.mapProjection = this.mapService.getMap().projection;\r\n    this.lonlat = proj.transform(coord, this.mapProjection, 'EPSG:4326');\r\n  }\r\n\r\n  mapPosition(event: { x: number; y: number }) {\r\n    const contextmenuPoint = event;\r\n    contextmenuPoint.y =\r\n      contextmenuPoint.y -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().top +\r\n      window.scrollY;\r\n    contextmenuPoint.x =\r\n      contextmenuPoint.x -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().left +\r\n      window.scrollX;\r\n    const position = [contextmenuPoint.x, contextmenuPoint.y];\r\n    return position;\r\n  }\r\n\r\n  onPointerSearch(event) {\r\n    this.lonlat = event;\r\n    this.onSearchCoordinate();\r\n  }\r\n\r\n  onSearchCoordinate() {\r\n    this.searchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonlat);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n          this.onSearch({ research: results[i], results: _results });\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  onOpenGoogleMaps() {\r\n    window.open(GoogleLinks.getGoogleMapsCoordLink(this.lonlat[0], this.lonlat[1]));\r\n  }\r\n\r\n  onOpenGoogleStreetView() {\r\n    window.open(\r\n      GoogleLinks.getGoogleStreetViewLink(this.lonlat[0], this.lonlat[1])\r\n    );\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport {\r\n  IgoPanelModule,\r\n  IgoActionbarModule,\r\n  IgoContextMenuModule\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoMapModule,\r\n  IgoSearchModule,\r\n  provideIChercheSearchSource,\r\n  provideILayerSearchSource,\r\n  provideNominatimSearchSource,\r\n  provideIChercheReverseSearchSource,\r\n  provideCoordinatesReverseSearchSource,\r\n  provideCadastreSearchSource,\r\n  provideStoredQueriesSearchSource,\r\n  provideStoredQueriesReverseSearchSource\r\n} from '@igo2/geo';\r\n\r\nimport { IgoAppSearchModule } from '@igo2/integration';\r\n\r\nimport { AppSearchComponent } from './search.component';\r\nimport { AppSearchRoutingModule } from './search-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSearchComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSearchRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoMessageModule.forRoot(),\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoSearchModule.forRoot(),\r\n    IgoAppSearchModule,\r\n    IgoActionbarModule,\r\n    IgoContextMenuModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppSearchComponent],\r\n  providers: [\r\n    provideCoordinatesReverseSearchSource(),\r\n    provideCadastreSearchSource(),\r\n    provideIChercheSearchSource(),\r\n    provideILayerSearchSource(),\r\n    provideNominatimSearchSource(),\r\n    provideIChercheReverseSearchSource(),\r\n    provideStoredQueriesSearchSource(),\r\n    provideStoredQueriesReverseSearchSource()\r\n  ]\r\n})\r\nexport class AppSearchModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppPrintComponent } from './print.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'print',\r\n    component: AppPrintComponent\r\n  }\r\n];\r\n\r\nexport const AppPrintRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-print',\r\n  templateUrl: './print.component.html',\r\n  styleUrls: ['./print.component.scss']\r\n})\r\nexport class AppPrintComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: false\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Quebec Base Map',\r\n        sourceOptions: {\r\n          type: 'wmts',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n          layer: 'carte_gouv_qc_ro',\r\n          matrixSet: 'EPSG_3857',\r\n          version: '1.3.0',\r\n          crossOrigin: 'anonymous',\r\n          attributions: \"© <a href='http://www.droitauteur.gouv.qc.ca/copyright.php' target='_blank'><img src='https://geoegl.msp.gouv.qc.ca/gouvouvert/public/images/quebec/gouv_qc_logo.png' width='64' height='14'>Gouvernement du Québec</a> / <a href='https://www.igouverte.org/' target='_blank'>IGO2</a>\"\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'School board',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'MELS_CS_ANGLO_S',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n    //\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Embacle',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    // this.layerService\r\n    //   .createAsyncLayer({\r\n    //     title: 'Geomet',\r\n    //     sourceOptions: {\r\n    //       type: 'wms',\r\n    //       url: 'http://geo.weather.gc.ca/geomet/?lang=fr',\r\n    //       params: {\r\n    //         LAYERS: 'RADAR_1KM_RDBR',\r\n    //         VERSION: '1.3.0'\r\n    //       },\r\n    //       crossOrigin: 'anonymous'\r\n    //     }\r\n    //   })\r\n    //   .subscribe(l => this.map.addLayer(l));\r\n\r\n    /*\r\n        //CORS error if activate (for test)\r\n        this.layerService\r\n          .createAsyncLayer({\r\n            title: 'Geomet',\r\n            sourceOptions: {\r\n              type: 'wms',\r\n              url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wms',\r\n              params: {\r\n                layers: 'swtq',\r\n                version: '1.3.0',\r\n              }\r\n            }\r\n          })\r\n          .subscribe(l => this.map.addLayer(l));\r\n    */\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Print</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/print\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-print [map]=\"map\"></igo-print>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport { IgoMapModule, IgoPrintModule } from '@igo2/geo';\r\n\r\nimport { AppPrintComponent } from './print.component';\r\nimport { AppPrintRoutingModule } from './print-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppPrintComponent],\r\n  imports: [\r\n    AppPrintRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoPrintModule\r\n  ],\r\n  exports: [AppPrintComponent]\r\n})\r\nexport class AppPrintModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'import-export',\r\n    component: AppImportExportComponent\r\n  }\r\n];\r\n\r\nexport const AppImportExportRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\nimport { WorkspaceStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class AppImportExportComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  public store = new WorkspaceStore([]);\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Import / Export</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/import-export\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-import-export [store]=\"store\" [map]=\"map\"></igo-import-export>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoImportExportModule,\r\n  provideStyleListOptions\r\n} from '@igo2/geo';\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\nimport { AppImportExportRoutingModule } from './import-export-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppImportExportComponent],\r\n  imports: [\r\n    AppImportExportRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoImportExportModule\r\n  ],\r\n  exports: [AppImportExportComponent],\r\n  providers: [\r\n    provideStyleListOptions({\r\n      path: './assets/import-style.json'\r\n    })\r\n  ]\r\n})\r\nexport class AppImportExport {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'directions',\r\n    component: AppDirectionsComponent\r\n  }\r\n];\r\n\r\nexport const AppDirectionsRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  ProjectionService,\r\n  StopsStore,\r\n  StopsFeatureStore,\r\n  RoutesFeatureStore,\r\n  StepFeatureStore\r\n} from '@igo2/geo';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class AppDirectionsComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9,\r\n    geolocate: false\r\n  };\r\n\r\n  public stopsStore: StopsStore = new StopsStore([]);\r\n  public stopsFeatureStore: StopsFeatureStore = new StopsFeatureStore([], { map: this.map });\r\n  public stepFeatureStore: StepFeatureStore = new StepFeatureStore([], { map: this.map });\r\n  public routesFeatureStore: RoutesFeatureStore = new RoutesFeatureStore([], { map: this.map });\r\n  public zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private projectionService: ProjectionService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Directions</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/directions\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-directions\r\n    [stopsStore]=\"stopsStore\"\r\n    [stopsFeatureStore]=\"stopsFeatureStore\"\r\n    [stepFeatureStore]=\"stepFeatureStore\"\r\n    [routesFeatureStore]=\"routesFeatureStore\"\r\n    [zoomToActiveRoute$]=\"zoomToActiveRoute$\">  \r\n  </igo-directions>\r\n\r\n\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoDirectionsModule,\r\n  provideOsrmDirectionsSource\r\n} from '@igo2/geo';\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\nimport { AppDirectionsRoutingModule } from './directions-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDirectionsComponent],\r\n  imports: [\r\n    AppDirectionsRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoDirectionsModule\r\n  ],\r\n  exports: [AppDirectionsComponent],\r\n  providers: [provideOsrmDirectionsSource()]\r\n})\r\nexport class AppDirectionsModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'time-filter',\r\n    component: AppTimeFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppTimeFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  TimeFilterableDataSourceOptions,\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-time-filter',\r\n  templateUrl: './time-filter.component.html',\r\n  styleUrls: ['./time-filter.component.scss']\r\n})\r\nexport class AppTimeFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasource: TimeFilterableDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n    //   params: {\r\n    //     layers: 'vg_observation_v_inondation_embacle_wmst',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   timeFilterable: true,\r\n    //   timeFilter: {\r\n    //     min: '2017-01-01',\r\n    //     max: '2018-01-01',\r\n    //     range: true,\r\n    //     type: TimeFilterType.DATETIME,\r\n    //     style: TimeFilterStyle.SLIDER,\r\n    //     step: 86400000,\r\n    //     timeInterval: 2000\r\n    //   }\r\n    // };\r\n\r\n    const datasourceYear: TimeFilterableDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      },\r\n      timeFilterable: true,\r\n      timeFilter: {\r\n        min: '2013',\r\n        max: '2019',\r\n        range: false,\r\n        type: TimeFilterType.YEAR,\r\n        style: TimeFilterStyle.SLIDER,\r\n        step: 1,\r\n        timeInterval: 2000\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle YEAR',\r\n            visible: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Time filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>npm install --save moment@2.22.2</li>\r\n    <li>npm install --save @mat-datetimepicker/core@3.0.0-beta.0</li>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/time-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-time-filter-list [layers]=\"map.layers\"></igo-time-filter-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\nimport { AppTimeFilterRoutingModule } from './time-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTimeFilterComponent],\r\n  imports: [\r\n    AppTimeFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppTimeFilterComponent]\r\n})\r\nexport class AppTimeFilterModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'ogc-filter',\r\n    component: AppOgcFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppOgcFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  WFSDataSourceOptions,\r\n  WFSDataSourceOptionsParams,\r\n  OgcFilterableDataSourceOptions,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcFilterOperatorType,\r\n  OgcFilterDuringOptions\r\n} from '@igo2/geo';\r\n\r\nimport {Fill, Stroke, Circle, Style} from 'ol/style';\r\n\r\n@Component({\r\n  selector: 'app-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss']\r\n})\r\nexport class AppOgcFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const datasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'code_municipalite', alias: '# de la municipalitée' },\r\n        { name: 'date_observation', excludeFromOgcFilters: true },\r\n        { name: 'urgence', values: ['immédiate', 'inconnue'] }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters: {\r\n          logical: 'Or',\r\n          filters: [\r\n            {\r\n              operator: 'PropertyIsEqualTo',\r\n              propertyName: 'code_municipalite',\r\n              expression: '10043'\r\n            },\r\n            {\r\n              operator: 'Intersects',\r\n              geometryName: 'the_geom',\r\n              wkt_geometry: `MULTIPOLYGON(((\r\n              -8379441.158019895 5844447.897707146,\r\n              -8379441.158019895 5936172.331649357,\r\n              -8134842.66750733 5936172.331649357,\r\n              -8134842.66750733 5844447.897707146,\r\n              -8379441.158019895 5844447.897707146\r\n            ), (\r\n              -8015003 5942074,\r\n              -8015003 5780349,\r\n              -7792364 5780349,\r\n              -7792364 5942074,\r\n              -8015003 5942074\r\n            )))`\r\n            }\r\n          ] as AnyBaseOgcFilterOptions[]\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (PropertyIsEqualTo OR Intersects)',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'orange',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilter: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-21T00:00:00-05:00',\r\n            end: '2016-01-26T00:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-10T00:00:00-05:00',\r\n      stepDate: 'P2D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilter)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: P2D)',\r\n            id: '1',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n\r\n    const datasourceDuringFilterTime: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T04:00:00-05:00',\r\n            end: '2016-01-12T16:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-14T20:00:00-05:00',\r\n      stepDate: 'PT4H'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTime)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: PT4H)',\r\n            id: '2',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'blue',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeMonth: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T00:00:00-05:00',\r\n            end: '2016-03-31T00:00:00-05:00',\r\n            displayFormat: 'MMMM'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2018-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeMonth)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: P1M)',\r\n            id: '3',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'yellow',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeYear: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2014-01-01T00:00:00-05:00',\r\n            end: '2019-12-31T00:00:00-05:00',\r\n            sliderOptions: {\r\n              interval: 2000,\r\n              displayFormat: 'YY'\r\n            },\r\n            displayFormat: 'YYYY'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2014-01-01T00:00:00-05:00',\r\n      maxDate: '2019-12-31T00:00:00-05:00',\r\n      stepDate: 'P1Y'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: P1Y)',\r\n            id: '4',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'green',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeInterval: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: 'today - 2 days', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n            end: 'today', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeInterval)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Interval from Now, Step: P1D)',\r\n            id: '5',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'black',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeRestrictedToStep: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2019-01-01 00:00:00',\r\n            restrictToStep: true\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeRestrictedToStep)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, RestrictToStep, Step: P1M)',\r\n            id: '6',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'black'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const wmsOgcFilterOptions: WMSoptions = {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'vg_observation_v_inondation23avril2017_wmst',\r\n          VERSION: '1.3.0'\r\n        },\r\n        sourceFields: [\r\n          { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n        ],\r\n        ogcFilters: {\r\n          enabled: true,\r\n          editable: true,\r\n          filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation'\r\n          } as OgcFilterDuringOptions,\r\n          allowedOperatorsType: OgcFilterOperatorType.Time\r\n        }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wmsOgcFilterOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Inondation (During, optionsFromCapabilities)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WMSoptions\r\n      extends WMSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const filterableWMSwithPushButtons: WMSoptions = {\r\n      type: 'wms',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        LAYERS: 'radars_photos',\r\n        VERSION: '1.3.0'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        pushButtons: {\r\n          selectorType: 'pushButton',\r\n          order: 2,\r\n          groups : [\r\n            {title: 'Nom du group1 - push', name: '1 - push', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Régions',\r\n              logical: 'Or',\r\n              vertical: true,\r\n              selectors: [\r\n                {\r\n                  title: 'Montréal & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'Or',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montréal'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Outside Montréal & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'And',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montréal'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        checkboxes: {\r\n          selectorType: 'checkbox',\r\n          order: 1,\r\n          groups : [\r\n            {title: 'Nom du group1 - checkbox', name: '1 - checkbox', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Type de radar photo',\r\n              logical: 'Or',\r\n              selectors: [\r\n                {\r\n                  title: 'Radar photo fixe',\r\n                  enabled: true,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo mobile',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo mobile'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo fixe + feu rouge',\r\n                  enabled: false,\r\n                  color: '0,200,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe et surveillance au feu rouge'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar feu rouge',\r\n                  enabled: false,\r\n                  color: '255,0,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Appareil de surveillance au feu rouge'\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        allowedOperatorsType: OgcFilterOperatorType.Basic\r\n        },\r\n      paramsWFS: {\r\n        featureTypes: 'radars_photos',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '1.1.0',\r\n        outputFormat: 'geojson',\r\n        outputFormatDownload: 'shp'\r\n      } as WFSDataSourceOptionsParams\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(filterableWMSwithPushButtons)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Filterable WMS layers with predefined filters (push buttons)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasourceWmsWith2Layers: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   params: {\r\n    //     layers: 'stations_meteoroutieres,histo_stations_meteoroutieres',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'histo_stations_meteoroutieres',\r\n    //     fieldNameGeometry: 'geometry',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'geojson',\r\n    //     outputFormatDownload: 'shp'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWmsWith2Layers)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Layer build from 2 WMS layers',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n\r\n    // const datasourceWms: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: '/geoserver/wms',\r\n    //   urlWfs: '/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true,\r\n    //     filters: {\r\n    //       operator: 'PropertyIsEqualTo',\r\n    //       propertyName: 'waterway',\r\n    //       expression: 'riverbank'\r\n    //     }\r\n    //   },\r\n    //   sourceFields: [\r\n    //     { name: 'waterway', alias: 'Chemin d eau' },\r\n    //     { name: 'osm_id' },\r\n    //     { name: 'landuse', values: ['yes', 'no'] }\r\n    //   ],\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWms)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Geoserver water_areas',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Ogc filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/ogc-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-ogc-filterable-list [map]=\"map\" [layers]=\"map.layers\">\r\n\r\n    </igo-ogc-filterable-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\nimport { AppOgcFilterRoutingModule } from './ogc-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOgcFilterComponent],\r\n  imports: [\r\n    AppOgcFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppOgcFilterComponent]\r\n})\r\nexport class AppOgcFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Spatial filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>npm install --save moment@2.22.2</li>\r\n    <li>npm install --save @mat-datetimepicker/core@3.0.0-beta.0</li>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/spatial-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay igoQuery\r\n    (query)=\"handleQueryResults($event)\"\r\n    [queryFeatures]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Spatial Filter\">\r\n    <igo-spatial-filter-type\r\n      [store]=\"spatialListStore\"\r\n      [selectedQueryType]=\"queryType\"\r\n      [zone]=\"zone\"\r\n      (eventType)=\"getOutputType($event)\"\r\n      (eventQueryType)=\"getOutputQueryType($event)\"\r\n      (zoneChange)=\"onZoneChange($event)\">\r\n    </igo-spatial-filter-type>\r\n\r\n    <igo-spatial-filter-item\r\n      [type]=\"type\"\r\n      [queryType]=\"queryType\"\r\n      [map]=\"map\"\r\n      [zone]=\"zone\"\r\n      [loading]=\"loading\"\r\n      [store]=\"store\"\r\n      [layers]=\"layers\"\r\n      (radiusEvent)=\"radius = $event\"\r\n      (freehandControl)=\"freehandDrawIsActive = $event\"\r\n      (drawZoneEvent)=\"zone = $event\"\r\n      (itemTypeChange)=\"itemType = $event\"\r\n      (thematicChange)=\"thematics = $event\"\r\n      (toggleSearch)=\"getOutputToggleSearch()\"\r\n      (clearButtonEvent)=\"layers = $event\"\r\n      (clearSearchEvent)=\"getOutputClearSearch()\">\r\n    </igo-spatial-filter-item>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Details\">\r\n    <ng-container *ngIf=\"selectedFeature$ | async as feature\">\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'spatial-filter',\r\n    component: AppSpatialFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppSpatialFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, Input } from '@angular/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  Feature,\r\n  moveToOlFeatures,\r\n  FeatureMotion,\r\n  ClusterDataSource,\r\n  featureToOl,\r\n  DataSource,\r\n  QueryableDataSourceOptions,\r\n  Layer,\r\n  SpatialFilterService,\r\n  SpatialFilterQueryType,\r\n  SpatialFilterType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterThematic\r\n} from '@igo2/geo';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\nimport olSourceCluster from 'ol/source/Cluster';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Component({\r\n  selector: 'app-spatial-filter',\r\n  templateUrl: './spatial-filter.component.html',\r\n  styleUrls: ['./spatial-filter.component.scss']\r\n})\r\nexport class AppSpatialFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  view = {\r\n    center: [-71.9, 46.9],\r\n    zoom: 10\r\n  };\r\n\r\n  @Input() type: SpatialFilterType;\r\n  @Input() itemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  @Input() freehandDrawIsActive: boolean;\r\n\r\n  public layers: Layer[] = [];\r\n\r\n  public queryType: SpatialFilterQueryType;\r\n  public thematics: SpatialFilterThematic[];\r\n  public zone: Feature;\r\n  public radius: number;\r\n\r\n  public selectedFeature$: BehaviorSubject<Feature> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  public store = new EntityStore<Feature>([]); // Store to print results at the end\r\n\r\n  public spatialListStore = new EntityStore<Feature>([]);\r\n\r\n  public loading = false;\r\n\r\n  constructor(\r\n    private spatialFilterService: SpatialFilterService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource,\r\n            baseLayer: true,\r\n            visible: true\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  getOutputType(event: SpatialFilterType) {\r\n    this.type = event;\r\n    this.queryType = undefined;\r\n    this.radius = undefined;\r\n  }\r\n\r\n  getOutputQueryType(event: SpatialFilterQueryType) {\r\n    this.queryType = event;\r\n    if (this.queryType) {\r\n      this.loadFilterList();\r\n    }\r\n  }\r\n\r\n  private loadFilterList() {\r\n    this.spatialFilterService\r\n      .loadFilterList(this.queryType)\r\n      .subscribe((features: Feature[]) => {\r\n        features.sort((a, b) => {\r\n          if (a.properties.nom < b.properties.nom) {\r\n            return -1;\r\n          }\r\n          if (a.properties.nom > b.properties.nom) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n        this.spatialListStore.clear();\r\n        this.spatialListStore.load(features);\r\n      });\r\n  }\r\n\r\n  getOutputToggleSearch() {\r\n    this.loadThematics();\r\n  }\r\n\r\n  getOutputClearSearch() {\r\n    this.zone = undefined;\r\n    this.queryType = undefined;\r\n  }\r\n\r\n  private loadThematics() {\r\n    this.loading = true;\r\n    this.tryAddFeaturesToMap([this.zone]);\r\n    if (!this.thematics) {\r\n      const theme: SpatialFilterThematic = {\r\n        name: ''\r\n      };\r\n      this.thematics = [theme];\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon) {\r\n      this.radius = undefined;\r\n    }\r\n    this.thematics.forEach(thematic => {\r\n      this.spatialFilterService\r\n        .loadFilterItem(\r\n          this.zone,\r\n          this.itemType,\r\n          this.queryType,\r\n          thematic,\r\n          this.radius\r\n        )\r\n        .subscribe((features: Feature[]) => {\r\n          this.store.insertMany(features);\r\n          const featuresPoint: Feature[] = [];\r\n          const featuresLinePoly: Feature[] = [];\r\n          let idPoint;\r\n          let idLinePoly;\r\n          features.forEach(feature => {\r\n            if (feature.geometry.type === 'Point') {\r\n              featuresPoint.push(feature);\r\n              idPoint = feature.meta.id;\r\n            } else {\r\n              featuresLinePoly.push(feature);\r\n              idLinePoly = feature.meta.id;\r\n            }\r\n          });\r\n          this.tryAddPointToMap(featuresPoint, idPoint);\r\n          this.tryAddLayerToMap(featuresLinePoly, idLinePoly);\r\n          this.loading = false;\r\n          if (features.length >= 10000) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.maxSizeAlert'\r\n              ),\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.warning'\r\n              ),\r\n              { timeOut: 10000 }\r\n            );\r\n          }\r\n          if (!features.length) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.zeroResults'\r\n              ),\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.warning'\r\n              ),\r\n              { timeOut: 10000 }\r\n            );\r\n          }\r\n        });\r\n    });\r\n  }\r\n\r\n  onZoneChange(feature: Feature) {\r\n    this.zone = feature;\r\n    if (feature) {\r\n      this.tryAddFeaturesToMap([feature]);\r\n      this.zoomToFeatureExtent(feature);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add zone feature to the map overlay\r\n   */\r\n  public tryAddFeaturesToMap(features: Feature[]) {\r\n    let i = 1;\r\n    for (const feature of features) {\r\n      if (this.type === SpatialFilterType.Predefined) {\r\n        for (const layer of this.map.layers) {\r\n          if (\r\n            layer.options._internal &&\r\n            layer.options._internal.code === feature.properties.code\r\n          ) {\r\n            return;\r\n          }\r\n          if (layer.title.startsWith('Zone')) {\r\n            this.map.removeLayer(layer);\r\n          }\r\n        }\r\n      }\r\n      for (const layer of this.map.layers) {\r\n        if (layer.title.startsWith('Zone')) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            title: ('Zone ' + i) as string,\r\n            _internal: {\r\n              code:\r\n                this.type === SpatialFilterType.Predefined\r\n                  ? feature.properties.code\r\n                  : undefined\r\n            },\r\n            source: dataSource,\r\n            visible: true,\r\n            style: (_feature, resolution) => {\r\n              const coordinates = (features[0] as any).coordinates;\r\n              return new olstyle.Style({\r\n                image: new olstyle.Circle({\r\n                  radius: coordinates\r\n                    ? this.radius /\r\n                      Math.cos((Math.PI / 180) * coordinates[1]) /\r\n                      resolution\r\n                    : undefined,\r\n                  fill: new olstyle.Fill({\r\n                    color: 'rgba(200, 200, 20, 0.2)'\r\n                  }),\r\n                  stroke: new olstyle.Stroke({\r\n                    width: 1,\r\n                    color: 'orange'\r\n                  })\r\n                }),\r\n                stroke: new olstyle.Stroke({\r\n                  width: 1,\r\n                  color: 'orange'\r\n                }),\r\n                fill: new olstyle.Fill({\r\n                  color: 'rgba(200, 200, 20, 0.2)'\r\n                })\r\n              });\r\n            }\r\n          });\r\n          const featuresOl = features.map(f => {\r\n            return featureToOl(f, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry> | olSourceCluster;\r\n          ol.addFeatures(featuresOl);\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to point features to the map\r\n   * Necessary to create clusters\r\n   */\r\n  private tryAddPointToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length >= 1) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.map.layers) {\r\n        if (layer.title.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'cluster',\r\n          id,\r\n          queryable: true,\r\n          distance: 120,\r\n          meta: {\r\n            title: 'Cluster'\r\n          }\r\n        } as QueryableDataSourceOptions)\r\n        .subscribe((dataSource: ClusterDataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            title: (features[0].meta.title + ' ' + i) as string,\r\n            source: dataSource,\r\n            visible: true,\r\n            clusterParam: {\r\n              clusterRanges: [{ minRadius: 1, maxRadius: 5, style: {} }]\r\n            }\r\n          });\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceCluster;\r\n          ol.getSource().addFeatures(featuresOl);\r\n          if (this.map.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.map.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add line or polygon features to the map\r\n   */\r\n  private tryAddLayerToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length > 1) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.map.layers) {\r\n        if (layer.title.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          id,\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            title: (features[0].meta.title + ' ' + i) as string,\r\n            source: dataSource,\r\n            visible: true\r\n          });\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry> | olSourceCluster;\r\n          ol.addFeatures(featuresOl);\r\n          if (this.map.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.map.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n        });\r\n    }\r\n  }\r\n\r\n  zoomToFeatureExtent(feature) {\r\n    if (feature) {\r\n      const olFeature = this.format.readFeature(feature, {\r\n        dataProjection: feature.projection,\r\n        featureProjection: this.map.projection\r\n      });\r\n      moveToOlFeatures(this.map, [olFeature], FeatureMotion.Zoom);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Permit the query action on one item result\r\n   */\r\n  handleQueryResults(results) {\r\n    const features: Feature[] = results.features;\r\n    let feature;\r\n    if (features.length) {\r\n      feature = features[0];\r\n    }\r\n    this.selectedFeature$.next(feature);\r\n  }\r\n}\r\n","import { CommonModule } from '@angular/common';\r\nimport { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoFormModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule, IgoQueryModule, IgoFeatureModule, IgoFeatureDetailsModule } from '@igo2/geo';\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\nimport { AppSpatialFilterRoutingModule } from './spatial-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSpatialFilterComponent],\r\n  imports: [\r\n    AppSpatialFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoMessageModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoFilterModule,\r\n    IgoFormModule,\r\n    CommonModule\r\n  ],\r\n  exports: [AppSpatialFilterComponent]\r\n})\r\nexport class AppSpatialFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Workspace</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/workspace\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-workspace-selector\r\n    igoWorkspaceSelector\r\n    [store]=\"workspaceStore\"\r\n    [map]=\"map\">\r\n  </igo-workspace-selector>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-entity-table-paginator\r\n      *ngIf=\"workspace.inResolutionRange$ | async\"\r\n      [store]=\"workspace.entityStore\"\r\n      [paginatorOptions]=\"paginatorOptions\"\r\n      [entitySortChange$]=\"entitySortChange$\"\r\n      (paginatorChange)=\"paginatorChange($event)\">\r\n    </igo-entity-table-paginator>\r\n  </ng-container>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-actionbar\r\n      *ngIf=\"workspace.actionStore\"\r\n      [store]=\"workspace.actionStore\"\r\n      [horizontal]=\"true\"\r\n      [withToggleButton]=\"true\"\r\n      [withTitle]=\"true\"\r\n      [mode]=\"actionbarMode\">\r\n    </igo-actionbar>\r\n\r\n    <igo-entity-table\r\n      *ngIf=\"workspace.entityStore && workspace.meta && workspace.meta.tableTemplate && (workspace.inResolutionRange$ | async)\"\r\n      class=\"table-compact table-centered\"\r\n      [paginator]=\"workspacePaginator\"\r\n      [scrollBehavior]=\"scrollBehavior\"\r\n      [store]=\"workspace.entityStore\"\r\n      [template]=\"workspace.meta.tableTemplate\">\r\n    </igo-entity-table>\r\n    <mat-card-content\r\n    *ngIf=\"(workspace.inResolutionRange$ | async) === false\">\r\n      No data available at this scale. Please zoom in. \r\n    </mat-card-content>\r\n\r\n    <igo-workspace-widget-outlet [workspace]=\"workspace\"></igo-workspace-widget-outlet>\r\n\r\n  </ng-container>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'workspace',\r\n    component: AppWorkspaceComponent\r\n  }\r\n];\r\n\r\nexport const AppWorkspaceRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { Observable, BehaviorSubject } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  ActionbarMode,\r\n  EntityRecord,\r\n  EntityTableScrollBehavior,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WFSDataSourceOptions\r\n} from '@igo2/geo';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { WorkspaceState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-workspace',\r\n  templateUrl: './workspace.component.html',\r\n  styleUrls: ['./workspace.component.scss']\r\n})\r\nexport class AppWorkspaceComponent implements OnInit {\r\n\r\n  public workspacePaginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public paginatorOptions: EntityTablePaginatorOptions = {\r\n    pageSize: 5, // Number of items to display on a page.\r\n    pageSizeOptions: [1, 5, 10, 15, 30, 50, 100], // The set of provided page size options to display to the user.\r\n    showFirstLastButtons: true // Whether to show the first/last buttons UI to the user.\r\n  };\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-72, 47.2],\r\n    zoom: 5\r\n  };\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.workspaceState.store;\r\n  }\r\n\r\n  public selectedWorkspace$: Observable<Workspace>;\r\n\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public scrollBehavior = EntityTableScrollBehavior.Instant;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    public workspaceState: WorkspaceState,\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.selectedWorkspace$ = this.workspaceStore.stateView\r\n      .firstBy$(\r\n        (record: EntityRecord<Workspace>) => record.state.selected === true\r\n      )\r\n      .pipe(\r\n        map((record: EntityRecord<Workspace>) => {\r\n          const entity = record === undefined ? undefined : record.entity;\r\n          if (entity) {\r\n            // In fact, the download action is not fully functionnal into the igo2-lib demo\r\n            // The reason why it's has been remove is that this button trigger a tool (importExport)\r\n            // and this tool is not available in the igo2-lib demo.\r\n            // This is why it's has been removed frome the actions's list.\r\n            // Refer to the igo2 demo at https://infra-geo-ouverte.github.io/igo2/\r\n            entity.actionStore.view.filter((action) => {\r\n              return action.id !== 'wfsDownload';\r\n            });\r\n          }\r\n          return entity;\r\n\r\n        })\r\n      );\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const wmsDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ahocevar.com/geoserver/wms',\r\n    //   urlWfs: 'https://ahocevar.com/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   },\r\n    //   sourceFields: [\r\n    //     {name: 'waterway', alias: 'Chemin d eau'},\r\n    //     {name: 'osm_id'},\r\n    //     {name: 'landuse'}\r\n    //   ],\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   serverType: 'geoserver'\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(wmsDataSourceOptions as OgcFilterableDataSourceOptions)\r\n    //   .subscribe(dataSource => {\r\n    //     const layer = {\r\n    //       optionsFromCapabilities: true,\r\n    //       title: 'WMS Geoserver filterable ',\r\n    //       visible: true,\r\n    //       source: dataSource\r\n    //     };\r\n    //     this.map.addLayer(this.layerService.createLayer(layer));\r\n    //   });\r\n\r\n    const wfsDataSourceOptions: WFSDataSourceOptions = {\r\n      type: 'wfs',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        featureTypes: 'etablissement_mtq',\r\n        fieldNameGeometry: 'geometry',\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson'\r\n      },\r\n      sourceFields: [\r\n        { name: 'idetablis', alias: 'ID' },\r\n        { name: 'nometablis', alias: 'Name' },\r\n        { name: 'typetablis', alias: 'Type' }\r\n      ]\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        const layer = {\r\n          title: 'Simple WFS ',\r\n          maxResolution: 3000,\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.workspacePaginator = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport {\r\n  IgoActionModule,\r\n  IgoEntityModule,\r\n  IgoWorkspaceModule,\r\n  IgoPanelModule\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoGeoWorkspaceModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\nimport { AppWorkspaceRoutingModule } from './workspace-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppWorkspaceComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppWorkspaceRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoActionModule,\r\n    IgoEntityModule,\r\n    IgoWorkspaceModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoGeoWorkspaceModule\r\n  ],\r\n  exports: [AppWorkspaceComponent]\r\n})\r\nexport class AppWorkspaceModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Context</mat-card-title>\r\n  <mat-card-content>\r\n    <p>* Dependencies: LanguageService</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/context/context\">code of this example</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/contexts\"> contexts</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    igoMapContext\r\n    igoLayerContext\r\n    [map]=\"map\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Contexts list\">\r\n    <igo-context-list igoContextListBinding [map]=\"map\"></igo-context-list>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list igoLayerListBinding [map]=\"map\">\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n      </ng-template>\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppContextComponent } from './context.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'context',\r\n    component: AppContextComponent\r\n  }\r\n];\r\n\r\nexport const AppContextRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, OverlayService, MapService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-context',\r\n  templateUrl: './context.component.html',\r\n  styleUrls: ['./context.component.scss']\r\n})\r\nexport class AppContextComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private mapService: MapService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { HttpClientJsonpModule } from '@angular/common/http';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoMetadataModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\nimport { IgoContextManagerModule } from '@igo2/context';\r\n\r\nimport { AppContextComponent } from './context.component';\r\nimport { AppContextRoutingModule } from './context-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppContextComponent],\r\n  imports: [\r\n    HttpClientJsonpModule,\r\n    AppContextRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoMetadataModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoContextManagerModule\r\n  ],\r\n  exports: [AppContextComponent]\r\n})\r\nexport class AppContextModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { RouterModule, Routes } from '@angular/router';\r\n\r\nconst routes: Routes = [\r\n  { path: '', redirectTo: '/home', pathMatch: 'full' },\r\n  { path: '**', redirectTo: '/home' }\r\n];\r\n\r\n@NgModule({\r\n  imports: [RouterModule.forRoot(routes, { useHash: true })],\r\n  exports: [RouterModule]\r\n})\r\nexport class AppRoutingModule {}\r\n","import { MediaMatcher } from '@angular/cdk/layout';\r\nimport {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  OnDestroy,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { version } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-root',\r\n  templateUrl: './app.component.html',\r\n  styleUrls: ['./app.component.scss']\r\n})\r\nexport class AppComponent implements OnDestroy {\r\n  mobileQuery: MediaQueryList;\r\n\r\n  public title = 'IGO';\r\n  public version = version;\r\n  private themeClass = 'deeppurple-theme';\r\n  private _mobileQueryListener: () => void;\r\n\r\n  constructor(\r\n    private changeDetectorRef: ChangeDetectorRef,\r\n    private media: MediaMatcher,\r\n    private renderer: Renderer2\r\n  ) {\r\n    this.mobileQuery = media.matchMedia('(max-width: 600px)');\r\n    this._mobileQueryListener = () => changeDetectorRef.detectChanges();\r\n    this.mobileQuery.addEventListener('change', this._mobileQueryListener);\r\n\r\n    this.renderer.addClass(document.body, this.themeClass);\r\n\r\n    this.detectOldBrowser();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.mobileQuery.removeEventListener('change', this._mobileQueryListener);\r\n  }\r\n\r\n  private detectOldBrowser() {\r\n    const oldBrowser = userAgent.satisfies({\r\n      ie: '<11',\r\n      chrome: '<64',\r\n      firefox: '<60'\r\n    });\r\n\r\n    if (oldBrowser) {\r\n      console.log('Very old browser ! ', userAgent.getBrowser());\r\n    }\r\n  }\r\n}\r\n","<div class=\"example-container\" [class.example-is-mobile]=\"mobileQuery.matches\">\r\n  <mat-toolbar color=\"primary\" class=\"example-toolbar\">\r\n    <button mat-icon-button (click)=\"snav.toggle()\"><mat-icon svgIcon=\"menu\"></mat-icon></button>\r\n    <h1>{{title}}</h1>\r\n    <h5>{{version.lib}}</h5>\r\n  </mat-toolbar>\r\n\r\n  <mat-sidenav-container class=\"example-sidenav-container\" [style.marginTop.px]=\"mobileQuery.matches ? 56 : 0\">\r\n    <mat-sidenav #snav opened=\"true\" [mode]=\"mobileQuery.matches ? 'over' : 'side'\" [fixedInViewport]=\"mobileQuery.matches\" fixedTopGap=\"56\">\r\n      <mat-nav-list>\r\n        <a mat-list-item routerLink=\".\">Home</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"activity\">Activity</a>\r\n        <a mat-list-item routerLink=\"config\">Config</a>\r\n        <a mat-list-item routerLink=\"language\">Language</a>\r\n        <a mat-list-item routerLink=\"media\">Media</a>\r\n        <a mat-list-item routerLink=\"message\">Message</a>\r\n        <a mat-list-item routerLink=\"request\">Request</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"auth-form\">Authentification</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"action\">Action</a>\r\n        <a mat-list-item routerLink=\"dynamic-component\">Dynamic Component</a>\r\n        <a mat-list-item routerLink=\"entity-table\">Entity Table</a>\r\n        <a mat-list-item routerLink=\"entity-selector\">Entity Selector</a>\r\n        <a mat-list-item routerLink=\"form\">Form</a>\r\n        <a mat-list-item routerLink=\"table\">Table</a>\r\n        <a mat-list-item routerLink=\"tool\">Tool</a>\r\n        <a mat-list-item routerLink=\"widget\">Widget</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"simple-map\">Simple map</a>\r\n        <a mat-list-item routerLink=\"layer\">Layer</a>\r\n        <a mat-list-item routerLink=\"legend\">Legend</a>\r\n        <a mat-list-item routerLink=\"overlay\">Overlay</a>\r\n        <a mat-list-item routerLink=\"geometry\">Geometry</a>\r\n        <a mat-list-item routerLink=\"feature\">Feature</a>\r\n        <a mat-list-item routerLink=\"hover\">Hover</a>\r\n        <a mat-list-item routerLink=\"measure\">Measure</a>\r\n        <a mat-list-item routerLink=\"draw\">Draw</a>\r\n        <a mat-list-item routerLink=\"query\">Query</a>\r\n        <a mat-list-item routerLink=\"catalog\">Catalog</a>\r\n        <a mat-list-item routerLink=\"search\">Search</a>\r\n        <a mat-list-item routerLink=\"print\">Print</a>\r\n        <a mat-list-item routerLink=\"import-export\">Import/Export</a>\r\n        <a mat-list-item routerLink=\"directions\">Directions</a>\r\n        <a mat-list-item routerLink=\"time-filter\">Time filter</a>\r\n        <a mat-list-item routerLink=\"ogc-filter\">OGC filter</a>\r\n        <a mat-list-item routerLink=\"spatial-filter\">Spatial filter</a>\r\n        <a mat-list-item routerLink=\"workspace\">Workspace</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"context\">Context</a>\r\n\r\n      </mat-nav-list>\r\n    </mat-sidenav>\r\n\r\n    <mat-sidenav-content>\r\n      <router-outlet></router-outlet>\r\n    </mat-sidenav-content>\r\n\r\n  </mat-sidenav-container>\r\n</div>\r\n","import { BrowserModule, DomSanitizer } from '@angular/platform-browser';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\nimport { APP_INITIALIZER, NgModule } from '@angular/core';\r\nimport { HammerModule } from '@angular/platform-browser';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconRegistry, MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSidenavModule } from '@angular/material/sidenav';\r\nimport { MatToolbarModule } from '@angular/material/toolbar';\r\nimport { AppHomeModule } from './core/home/home.module';\r\nimport { AppActivityModule } from './core/activity/activity.module';\r\nimport { AppConfigModule } from './core/config/config.module';\r\nimport { AppLanguageModule } from './core/language/language.module';\r\nimport { AppMediaModule } from './core/media/media.module';\r\nimport { AppMessageModule } from './core/message/message.module';\r\nimport { AppRequestModule } from './core/request/request.module';\r\n\r\nimport { AppActionModule } from './common/action/action.module';\r\nimport { AppDynamicComponentModule } from './common/dynamic-component/dynamic-component.module';\r\nimport { AppEntityTableModule } from './common/entity-table/entity-table.module';\r\nimport { AppEntitySelectorModule } from './common/entity-selector/entity-selector.module';\r\nimport { AppFormModule } from './common/form/form.module';\r\nimport { AppTableModule } from './common/table/table.module';\r\nimport { AppToolModule } from './common/tool/tool.module';\r\nimport { AppWidgetModule } from './common/widget/widget.module';\r\n\r\nimport { AppAuthFormModule } from './auth/auth-form/auth-form.module';\r\n\r\nimport { AppSimpleMapModule } from './geo/simple-map/simple-map.module';\r\nimport { AppLayerModule } from './geo/layer/layer.module';\r\nimport { AppLegendModule } from './geo/legend/legend.module';\r\nimport { AppOverlayModule } from './geo/overlay/overlay.module';\r\nimport { AppGeometryModule } from './geo/geometry/geometry.module';\r\nimport { AppFeatureModule } from './geo/feature/feature.module';\r\nimport { AppHoverModule } from './geo/hover/hover.module';\r\nimport { AppMeasureModule } from './geo/measure/measure.module';\r\nimport { AppDrawModule } from './geo/draw/draw.module';\r\nimport { AppQueryModule } from './geo/query/query.module';\r\nimport { AppCatalogModule } from './geo/catalog/catalog.module';\r\nimport { AppSearchModule } from './geo/search/search.module';\r\nimport { AppPrintModule } from './geo/print/print.module';\r\nimport { AppImportExport } from './geo/import-export/import-export.module';\r\nimport { AppDirectionsModule } from './geo/directions/directions.module';\r\nimport { AppTimeFilterModule } from './geo/time-filter/time-filter.module';\r\nimport { AppOgcFilterModule } from './geo/ogc-filter/ogc-filter.module';\r\nimport { AppSpatialFilterModule } from './geo/spatial-filter/spatial-filter.module';\r\nimport { AppWorkspaceModule } from './geo/workspace/workspace.module';\r\n\r\nimport { AppContextModule } from './context/context/context.module';\r\n\r\nimport { AppRoutingModule } from './app-routing.module';\r\nimport { AppComponent } from './app.component';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@NgModule({\r\n  declarations: [AppComponent],\r\n  imports: [\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatSidenavModule,\r\n    MatToolbarModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n\r\n    AppHomeModule,\r\n    AppActivityModule,\r\n    AppConfigModule,\r\n    AppLanguageModule,\r\n    AppMediaModule,\r\n    AppMessageModule,\r\n    AppRequestModule,\r\n\r\n    AppActionModule,\r\n    AppDynamicComponentModule,\r\n    AppEntityTableModule,\r\n    AppEntitySelectorModule,\r\n    AppFormModule,\r\n    AppTableModule,\r\n    AppToolModule,\r\n    AppWidgetModule,\r\n\r\n    AppAuthFormModule,\r\n\r\n    AppSimpleMapModule,\r\n    AppLayerModule,\r\n    AppLegendModule,\r\n    AppOverlayModule,\r\n    AppGeometryModule,\r\n    AppFeatureModule,\r\n    AppHoverModule,\r\n    AppMeasureModule,\r\n    AppDrawModule,\r\n    AppQueryModule,\r\n    AppCatalogModule,\r\n    AppSearchModule,\r\n    AppPrintModule,\r\n    AppImportExport,\r\n    AppDirectionsModule,\r\n    AppTimeFilterModule,\r\n    AppOgcFilterModule,\r\n    AppSpatialFilterModule,\r\n    AppWorkspaceModule,\r\n\r\n    AppContextModule,\r\n\r\n    AppRoutingModule,\r\n\r\n    HammerModule\r\n  ],\r\n  providers: [\r\n    {provide: APP_INITIALIZER, useFactory: appInitializerFactory, deps: [LanguageService], multi: true},\r\n  ],\r\n  bootstrap: [AppComponent]\r\n})\r\nexport class AppModule {\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n\r\nexport function appInitializerFactory(languageService: LanguageService) {\r\n  return () => new Promise<any>((resolve: any) => {\r\n      languageService.translate.getTranslation(languageService.getLanguage()).subscribe(() => {\r\n        console.info(`Successfully initialized '${languageService.getLanguage()}' language.'`);\r\n      }, err => {\r\n        console.error(`Problem with '${languageService.getLanguage()}' language initialization.'`);\r\n      }, () => {\r\n        resolve(null);\r\n      });\r\n  });\r\n}\r\n","import { enableProdMode } from '@angular/core';\r\nimport { platformBrowserDynamic } from '@angular/platform-browser-dynamic';\r\n\r\nimport { AppModule } from './app/app.module';\r\nimport { environment } from './environments/environment';\r\n\r\nimport 'hammerjs';\r\n\r\nif (environment.production) {\r\n  enableProdMode();\r\n}\r\n\r\nplatformBrowserDynamic()\r\n  .bootstrapModule(AppModule)\r\n  .catch(err => console.log(err));\r\n","var map = {\n\t\"./af\": 62275,\n\t\"./af.js\": 62275,\n\t\"./ar\": 90857,\n\t\"./ar-dz\": 11218,\n\t\"./ar-dz.js\": 11218,\n\t\"./ar-kw\": 14754,\n\t\"./ar-kw.js\": 14754,\n\t\"./ar-ly\": 66680,\n\t\"./ar-ly.js\": 66680,\n\t\"./ar-ma\": 92178,\n\t\"./ar-ma.js\": 92178,\n\t\"./ar-sa\": 56522,\n\t\"./ar-sa.js\": 56522,\n\t\"./ar-tn\": 95682,\n\t\"./ar-tn.js\": 95682,\n\t\"./ar.js\": 90857,\n\t\"./az\": 70164,\n\t\"./az.js\": 70164,\n\t\"./be\": 79774,\n\t\"./be.js\": 79774,\n\t\"./bg\": 60947,\n\t\"./bg.js\": 60947,\n\t\"./bm\": 21832,\n\t\"./bm.js\": 21832,\n\t\"./bn\": 89650,\n\t\"./bn-bd\": 74477,\n\t\"./bn-bd.js\": 74477,\n\t\"./bn.js\": 89650,\n\t\"./bo\": 66005,\n\t\"./bo.js\": 66005,\n\t\"./br\": 98492,\n\t\"./br.js\": 98492,\n\t\"./bs\": 70534,\n\t\"./bs.js\": 70534,\n\t\"./ca\": 52061,\n\t\"./ca.js\": 52061,\n\t\"./cs\": 84737,\n\t\"./cs.js\": 84737,\n\t\"./cv\": 61167,\n\t\"./cv.js\": 61167,\n\t\"./cy\": 77996,\n\t\"./cy.js\": 77996,\n\t\"./da\": 9528,\n\t\"./da.js\": 9528,\n\t\"./de\": 14540,\n\t\"./de-at\": 49430,\n\t\"./de-at.js\": 49430,\n\t\"./de-ch\": 67978,\n\t\"./de-ch.js\": 67978,\n\t\"./de.js\": 14540,\n\t\"./dv\": 83426,\n\t\"./dv.js\": 83426,\n\t\"./el\": 6616,\n\t\"./el.js\": 6616,\n\t\"./en-au\": 63816,\n\t\"./en-au.js\": 63816,\n\t\"./en-ca\": 32162,\n\t\"./en-ca.js\": 32162,\n\t\"./en-gb\": 83305,\n\t\"./en-gb.js\": 83305,\n\t\"./en-ie\": 61954,\n\t\"./en-ie.js\": 61954,\n\t\"./en-il\": 43060,\n\t\"./en-il.js\": 43060,\n\t\"./en-in\": 59923,\n\t\"./en-in.js\": 59923,\n\t\"./en-nz\": 13540,\n\t\"./en-nz.js\": 13540,\n\t\"./en-sg\": 16505,\n\t\"./en-sg.js\": 16505,\n\t\"./eo\": 41907,\n\t\"./eo.js\": 41907,\n\t\"./es\": 86640,\n\t\"./es-do\": 41246,\n\t\"./es-do.js\": 41246,\n\t\"./es-mx\": 56131,\n\t\"./es-mx.js\": 56131,\n\t\"./es-us\": 36430,\n\t\"./es-us.js\": 36430,\n\t\"./es.js\": 86640,\n\t\"./et\": 62551,\n\t\"./et.js\": 62551,\n\t\"./eu\": 32711,\n\t\"./eu.js\": 32711,\n\t\"./fa\": 54572,\n\t\"./fa.js\": 54572,\n\t\"./fi\": 33390,\n\t\"./fi.js\": 33390,\n\t\"./fil\": 87860,\n\t\"./fil.js\": 87860,\n\t\"./fo\": 48216,\n\t\"./fo.js\": 48216,\n\t\"./fr\": 99291,\n\t\"./fr-ca\": 98527,\n\t\"./fr-ca.js\": 98527,\n\t\"./fr-ch\": 58407,\n\t\"./fr-ch.js\": 58407,\n\t\"./fr.js\": 99291,\n\t\"./fy\": 47054,\n\t\"./fy.js\": 47054,\n\t\"./ga\": 49540,\n\t\"./ga.js\": 49540,\n\t\"./gd\": 73917,\n\t\"./gd.js\": 73917,\n\t\"./gl\": 51486,\n\t\"./gl.js\": 51486,\n\t\"./gom-deva\": 56245,\n\t\"./gom-deva.js\": 56245,\n\t\"./gom-latn\": 48868,\n\t\"./gom-latn.js\": 48868,\n\t\"./gu\": 59652,\n\t\"./gu.js\": 59652,\n\t\"./he\": 89019,\n\t\"./he.js\": 89019,\n\t\"./hi\": 42040,\n\t\"./hi.js\": 42040,\n\t\"./hr\": 63402,\n\t\"./hr.js\": 63402,\n\t\"./hu\": 79322,\n\t\"./hu.js\": 79322,\n\t\"./hy-am\": 27609,\n\t\"./hy-am.js\": 27609,\n\t\"./id\": 57942,\n\t\"./id.js\": 57942,\n\t\"./is\": 98275,\n\t\"./is.js\": 98275,\n\t\"./it\": 73053,\n\t\"./it-ch\": 4378,\n\t\"./it-ch.js\": 4378,\n\t\"./it.js\": 73053,\n\t\"./ja\": 46176,\n\t\"./ja.js\": 46176,\n\t\"./jv\": 679,\n\t\"./jv.js\": 679,\n\t\"./ka\": 92726,\n\t\"./ka.js\": 92726,\n\t\"./kk\": 72953,\n\t\"./kk.js\": 72953,\n\t\"./km\": 86957,\n\t\"./km.js\": 86957,\n\t\"./kn\": 59181,\n\t\"./kn.js\": 59181,\n\t\"./ko\": 47148,\n\t\"./ko.js\": 47148,\n\t\"./ku\": 27752,\n\t\"./ku.js\": 27752,\n\t\"./ky\": 65675,\n\t\"./ky.js\": 65675,\n\t\"./lb\": 41263,\n\t\"./lb.js\": 41263,\n\t\"./lo\": 65746,\n\t\"./lo.js\": 65746,\n\t\"./lt\": 11143,\n\t\"./lt.js\": 11143,\n\t\"./lv\": 38753,\n\t\"./lv.js\": 38753,\n\t\"./me\": 44054,\n\t\"./me.js\": 44054,\n\t\"./mi\": 31573,\n\t\"./mi.js\": 31573,\n\t\"./mk\": 30202,\n\t\"./mk.js\": 30202,\n\t\"./ml\": 68523,\n\t\"./ml.js\": 68523,\n\t\"./mn\": 79794,\n\t\"./mn.js\": 79794,\n\t\"./mr\": 56681,\n\t\"./mr.js\": 56681,\n\t\"./ms\": 56975,\n\t\"./ms-my\": 39859,\n\t\"./ms-my.js\": 39859,\n\t\"./ms.js\": 56975,\n\t\"./mt\": 3691,\n\t\"./mt.js\": 3691,\n\t\"./my\": 5152,\n\t\"./my.js\": 5152,\n\t\"./nb\": 7607,\n\t\"./nb.js\": 7607,\n\t\"./ne\": 21526,\n\t\"./ne.js\": 21526,\n\t\"./nl\": 86368,\n\t\"./nl-be\": 40076,\n\t\"./nl-be.js\": 40076,\n\t\"./nl.js\": 86368,\n\t\"./nn\": 68420,\n\t\"./nn.js\": 68420,\n\t\"./oc-lnc\": 51906,\n\t\"./oc-lnc.js\": 51906,\n\t\"./pa-in\": 94504,\n\t\"./pa-in.js\": 94504,\n\t\"./pl\": 54721,\n\t\"./pl.js\": 54721,\n\t\"./pt\": 74645,\n\t\"./pt-br\": 54548,\n\t\"./pt-br.js\": 54548,\n\t\"./pt.js\": 74645,\n\t\"./ro\": 71977,\n\t\"./ro.js\": 71977,\n\t\"./ru\": 26042,\n\t\"./ru.js\": 26042,\n\t\"./sd\": 78849,\n\t\"./sd.js\": 78849,\n\t\"./se\": 27739,\n\t\"./se.js\": 27739,\n\t\"./si\": 50084,\n\t\"./si.js\": 50084,\n\t\"./sk\": 92449,\n\t\"./sk.js\": 92449,\n\t\"./sl\": 23086,\n\t\"./sl.js\": 23086,\n\t\"./sq\": 33139,\n\t\"./sq.js\": 33139,\n\t\"./sr\": 30607,\n\t\"./sr-cyrl\": 30063,\n\t\"./sr-cyrl.js\": 30063,\n\t\"./sr.js\": 30607,\n\t\"./ss\": 40131,\n\t\"./ss.js\": 40131,\n\t\"./sv\": 21665,\n\t\"./sv.js\": 21665,\n\t\"./sw\": 5642,\n\t\"./sw.js\": 5642,\n\t\"./ta\": 33622,\n\t\"./ta.js\": 33622,\n\t\"./te\": 74825,\n\t\"./te.js\": 74825,\n\t\"./tet\": 48336,\n\t\"./tet.js\": 48336,\n\t\"./tg\": 39238,\n\t\"./tg.js\": 39238,\n\t\"./th\": 99463,\n\t\"./th.js\": 99463,\n\t\"./tk\": 39986,\n\t\"./tk.js\": 39986,\n\t\"./tl-ph\": 29672,\n\t\"./tl-ph.js\": 29672,\n\t\"./tlh\": 40043,\n\t\"./tlh.js\": 40043,\n\t\"./tr\": 51212,\n\t\"./tr.js\": 51212,\n\t\"./tzl\": 50110,\n\t\"./tzl.js\": 50110,\n\t\"./tzm\": 80482,\n\t\"./tzm-latn\": 38309,\n\t\"./tzm-latn.js\": 38309,\n\t\"./tzm.js\": 80482,\n\t\"./ug-cn\": 42495,\n\t\"./ug-cn.js\": 42495,\n\t\"./uk\": 54157,\n\t\"./uk.js\": 54157,\n\t\"./ur\": 80984,\n\t\"./ur.js\": 80984,\n\t\"./uz\": 64141,\n\t\"./uz-latn\": 43662,\n\t\"./uz-latn.js\": 43662,\n\t\"./uz.js\": 64141,\n\t\"./vi\": 12607,\n\t\"./vi.js\": 12607,\n\t\"./x-pseudo\": 66460,\n\t\"./x-pseudo.js\": 66460,\n\t\"./yo\": 92948,\n\t\"./yo.js\": 92948,\n\t\"./zh-cn\": 62658,\n\t\"./zh-cn.js\": 62658,\n\t\"./zh-hk\": 39352,\n\t\"./zh-hk.js\": 39352,\n\t\"./zh-mo\": 38274,\n\t\"./zh-mo.js\": 38274,\n\t\"./zh-tw\": 98451,\n\t\"./zh-tw.js\": 98451\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 46700;"]}