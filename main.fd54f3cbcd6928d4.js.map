{"version":3,"file":"main.fd54f3cbcd6928d4.js","mappings":"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I,MAAMo5M,IAAyB,IAAbA,IAAiB,EACnC71I,MAAU,KACR,MAAM1kE,EAAkBpF,EAASjB,IAAIyF,GAC/BtC,EAAOkD,EAAgBT,cAC7B,OAAOS,EAAgBX,UAAUxC,eAAeC,EAAI,IAErD7E,UAAWiF,IACV,MAAM8C,EAAkBpF,EAASjB,IAAIyF,GAC/BtC,EAAOkD,EAAgBT,cAC7BS,EAAgBX,UAAUm7M,eAAe19M,EAAMI,GAC/C3B,GAAO,EACR,EAEP,UCjJI6xC,kBACFqtK,SAGFC,QACGC,gBAAgBb,IAChBx+J,MAAMj9B,GAAO1iB,QAAQC,IAAIyiB,GAAI,oBCdhC,QACA,aACA,gBACA,WACA,eACA,kBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,cACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,YACA,eACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,gBACA,mBACA,eACA,kBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,WACA,cACA,aACA,gBACA,aACA,gBACA,YACA,eACA,mBACA,sBACA,kBACA,qBACA,aACA,gBACA,aACA,gBACA,WACA,cACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,iBACA,oBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,cACA,iBACA,aACA,gBACA,cACA,iBACA,cACA,kBACA,qBACA,iBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,mBACA,sBACA,aACA,gBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,oBAIA,cACA,YACA,WACA,CACA,eACA,eACA,8CACA,gCACA9Q,CACA,CACA,YACA,CACAqtM,kBACA,sBACA,EACAA,aACAC,aACAD","names":["Base64","static","s","i","charCodeAt","this","ALPHA","indexOf","charAt","b10","pads","imax","length","x","String","PADCHAR","getByte64","push","fromCharCode","join","getByte","userAgent","Bowser","window","navigator","Clipboard","element","successful","textArea","createTextArea","selectText","copyTextToClipboard","destroyTextArea","text","document","createElement","value","body","appendChild","removeChild","getOSName","oldContentEditable","contentEditable","oldReadOnly","readOnly","range","createRange","selection","getSelection","contenteditable","readonly","selectNodeContents","removeAllRanges","addRange","setSelectionRange","select","compareVersion","execCommand","StringUtils","s1","s2","p","toString","changeData","getChanges","nextS","slice","mtc","ins","sbs","nextThis","del","result","diff","l","m","match","slen","o","fis","isThisLonger","longer","shorter","bi","split","len","cd","fil","sub","rc","getMatchingSubstring","rotateArray","array","n","res","Array","ADDED","ChangeType","ChangeUtils","obj1","obj2","ignoreKeys","items","added","deleted","modified","obj1Clone","obj2Clone","fromItem","index","findIndex","id","change","type","DELETED","toItem","splice","fromItemClone","JSON","parse","stringify","toItemClone","keysChanged","compareObject","undefined","MODIFIED","oldValue","newValue","map","itemAdded","baseKey","keys","Set","Object","forEach","key","keyString","isArray","concat","ObjectUtils","obj","keysArray","replace","current","shift","item","Date","target","source","ignoreUndefined","output","assign","isObject","filter","mergeDeep","src","prop","hasOwnProperty","copyDeep","summaryCapitalizeObject","capitalizeObject","upperCaseCount","property","upperCaseProperty","toUpperCase","count","capitalizedProperty","capitalizedPropertyObject","singlePossibility","paramClosestToLowercase","f","toLowerCase","reduce","prev","y","removeUndefined","removeNull","a","b","direction","nullsFirst","nullScore","ax","bx","_","$1","$2","Infinity","an","bn","nn","localeCompare","obj1Props","getOwnPropertyNames","obj2Props","_obj","NumberUtils","num","decimal","roundFactor","Math","pow","round","strEnum","create","S4","random","substring","uuid","SubjectStatus","Watcher","constructor","Subject","status","_status","status$","next","subscribe","callback","scope","watch","status$$","pipe","distinctUntilChanged","handleStatusChange","call","unsubscribe","unwatch","Waiting","ActivityService","BehaviorSubject","ids","register","counter$","unregister","factory","ɵfac","ActivityInterceptor","activityService","intercept","req","activity","headers","get","actReq","clone","delete","handle","finalize","i0","IgoActivityModule","ngModule","providers","provide","HTTP_INTERCEPTORS","useClass","multi","lib","releaseDate","ConfigService","injector","config","getConfig","load","options","baseConfig","default","path","http","HttpClient","Promise","resolve","_reject","catchError","error","console","log","throwError","configResponse","version","CONFIG_OPTIONS","InjectionToken","provideConfigOptions","useValue","configService","IgoConfigModule","APP_INITIALIZER","useFactory","configFactory","deps","LanguageLoader","prefix","suffix","getTranslation","lang","igoLocale$","appLocale$","forkJoin","translations","acc","provideDefaultLanguageLoader","loader","TranslateLoader","defaultLanguageLoader","IgoMissingTranslationHandler","params","translateService","langs","Error","substr","IgoLanguageModule","TranslateModule","missingTranslationHandler","MissingTranslationHandler","IgoMessageModule","CommonModule","ToastrModule","positionClass","timeOut","extendedTimeOut","messageClass","closeButton","progressBar","enableHtml","tapToDismiss","maxOpened","preventDuplicates","resetTimeoutOnDuplicate","countDuplicates","includeTitleDuplicates","ERROR","MessageType","LanguageService","translate","getBrowserLang","getLanguage","setDefaultLang","language$","language","setLanguage","combineLatest","use","reloadLang","MessageService","languageService","activeMessageTranslations","debounceTime","r","toastr","toasts","toast","activeMessageTranslation","find","amt","toastId","translatedTextInterpolateParams","textInterpolateParams","translatedTitleInterpolateParams","titleInterpolateParams","k","instant","textKey","titleKey","first","toastRef","componentInstance","message","title","ToastrService","showError","httpError","caught","messageType","toastrConfig","iconClasses","messages$","currentDate","from","to","showIcon","handleTemplate","messageShown","SUCCESS","success","INFO","info","SHOW","show","ALERT","WARNING","alert","handleNgxToastr","translatedTitlenterpolateParams","translatedTitle","activeToast","warning","remove","removeAllAreNotError","mess","template","html","Injector","ErrorInterceptor","originalReq","interceptError","errorContainer","handleError","handleCaughtError","handleUncaughtError","HttpErrorResponse","errorObj","_a","statusText","url","toDisplay","messageService","IgoErrorModule","parentModule","dbConfig","name","objectStoresMeta","store","storeConfig","keyPath","autoIncrement","storeSchema","keypath","unique","IgoCoreModule","matIconRegistry","domSanitizer","addSvgIconSet","bypassSecurityTrustResourceUrl","HttpClientModule","forRoot","NgxIndexedDBModule","ROUTE_SERVICE_OPTIONS","RouteService","router","route","centerKey","zoomKey","projectionKey","contextKey","searchKey","visibleOnLayersKey","visibleOffLayersKey","directionsCoordKey","directionsOptionsKey","toolKey","wmsUrlKey","wmsLayersKey","wmtsUrlKey","wmtsLayersKey","arcgisUrlKey","arcgisLayersKey","iarcgisUrlKey","iarcgisLayersKey","tarcgisUrlKey","tarcgisLayersKey","vectorKey","queryParams","decodeURIComponent","location","search","includes","pair","navigate","Mobile","Media","MediaOrientation","Portrait","MediaService","breakpointObserver","observe","Breakpoints","matches","media$","orientation$","Landscape","Tablet","Desktop","getMedia","getOrientation","isTouchScreen","documentElement","isMobile","isDesktop","SESSION","StorageScope","StorageServiceEventEnum","StorageService","sessionStorage","getItem","LOCAL","localStorage","set","previousValue","setItem","currentValue","storageChange$","event","removeItem","REMOVED","clear","CLEARED","getNumber","v","endposition","CompressionService","Map","generateBase64Index","base64Index","indexBase64","compressBlob","blob","Observable","observer","reader","FileReader","readAsDataURL","onload","base64","valueOf","text64","compressed","compressStringBase64","object","decompressBlob","compressedData","decompressed","decompressStringBase64","byteCharacters","atob","byteNumbers","byteArray","Uint8Array","Blob","out","bits","chr","rem","c","j","NetworkService","EventEmitter","connection","onLine","checkNetworkState","onlineSubscription","fromEvent","previousMessageId","messageObj","state","emitEvent","offlineSubscription","stateChangeEventEmitter","emit","ngOnDestroy","e","currentState","reportState","startWith","EntityTableColumnRenderer","Default","EntityTableScrollBehavior","Auto","EntityTableSelectionState","None","entity","t","safeObject","getEntityId","meta","getEntityProperty","idProperty","getEntityTitle","titleProperty","getEntityIcon","icon","iconProperty","EntityStateManager","ReplaySubject","getKey","size","setMany","entities","setAll","update","changes","exclusive","updateMany","updateManyExclusive","reverse","reverseMany","reversedChanges","reverseChanges","updateAll","allKeys","getAllKeys","some","changeKey","entries","bunch","storeKeys","change$","EntityView","source$","lifted","joins","getKey$","count$","empty","empty$","_index","all","values$","all$","firstBy","clause","firstBy$","values","manyBy","manyBy$","sort","destroy","values$$","createIndex","filter$","addFilter","filterIndex","filters$","removeFilter","sort$","lift","observables$","liftJoinedSource","liftSource","skip","_values","filters","processValues","setValues","sources$","joinData","computeJoinedValue","joinIndex","filterValues","sortValues","clauses","every","v1","v2","valueAccessor","generateIndex","EntityStore","_pristine","strategies","getProperty","createStateManager","view","createDataView","stateView","createStateView","pristine","entities$","softClear","updateCount","insert","insertMany","deleteMany","addStrategy","strategy","activate","_strategy","bindStore","removeStrategy","unbindStore","getStrategyOfType","activateStrategyOfType","deactivateStrategyOfType","deactivate","currentRecord","statesAreTheSame","revision","ref","record","newState","currentStateIsEmpty","newStateIsEmpty","EntityStoreWatcher","cdRef","setChangeDetector","setStore","teardownObservers","innerStateIndex","setupObservers","detectChanges","entities$$","onEntitiesChange","state$$","onStateChange","changesDetected","storeIndex","innerIndex","storeValue","innerValue","EntityStoreStrategy","stores","active","active$","doDeactivate","doActivate","EntityStoreFilterCustomFuncStrategy","super","filterStore","unfilterStore","filterAll","unfilterAll","filterClauseFunc","filterId","EntityStoreFilterSelectionStrategy","has","selected","ctx_r0","EntitySelectorComponent","titleAccessor","emptyText","multiAllText","multiNoneText","disabled","ngOnInit","watcher","selected$$","records","onSelectFromStore","onSelectionChange","multiSelect","_value","multiSelectValue","emptyValue","selectedChange","selected$","updateMultiToggleWithEntities","multiText$","selectors","ctx","StopPropagationDirective","onClick","stopPropagation","EntityTablePaginatorComponent","mediaService","hidePageSize","pageIndex","pageSize","showFirstLastButtons","paginationLabelTranslation$$","rangeLabel","page","of","label","startIndex","max","min","ngOnChanges","unsubscribeAll","count$$","emitPaginator","entitySortChange$$","entitySortChange$","paginator","firstPage","initPaginatorOptions","translateLabels","paginatorOptions","_b","_c","pageSizeOptions","_d","_e","_f","_intl","firstPageLabel","getRangeLabel","itemsPerPageLabel","lastPageLabel","nextPageLabel","previousPageLabel","paginatorChange","MatPaginator","ImageErrorDirective","el","errorImageUrl","hideError","onError","nativeElement","style","display","EntityTableRowDirective","renderer","selectOnClick","highlightSelection","_selected","toggleSelected","scroll","addCls","selectedCls","highlightedCls","removeCls","scrollIntoView","scrollMode","behavior","block","inline","cls","addClass","removeClass","SanitizeHtmlPipe","_sanitizer","transform","bypassSecurityTrustHtml","pure","SecureImagePipe","HttpHeaders","activityInterceptor","regexDepot","RegExp","test","responseType","err","switchMap","onloadend","complete","Cacheable","maxCacheCount","onToggleRows","$event","ctx_r13","onShiftToggleRow","record_r11","onDateChange","onChange","onValueChange","onBooleanValueChange","onSelectValueChange","onAutocompleteValueChange","onButtonClick","EntityTableComponent","formBuilder","_focusMonitor","_elementRef","ngControl","_parentForm","_controlName","_defaultErrorStateMatcher","dateAdapter","UntypedFormGroup","filteredOptions","entityTableColumnRenderer","entityTableSelectionState","sortNullsFirst","withPaginator","MatTableDataSource","setLocale","_paginator","dataSource","columns","column","visible","selectionCheckbox","selectMany","fixedHeader","tableHeight","handleDatasource","getColumnKeyWithoutPropertiesTag","properties","checked","formGroup","controls","setValue","option","viewValue","moment","format","enableEdit","validation","mandatory","setControl","control","multiple","parseInt","valueChanges","domainValues","filterNormalized","normalize","formControlValue","isStringValidNumber","isEdition","linkColumnForce","date","utc","newKey","getValidationAttributeValue","disable","unsubscribeStore","selection$$","firstSelected","firstSelectedStateviewPosition","pageMax","pageToReach","floor","selectionState$","computeSelectionState","dataSource$$","data","getTrackByFunction","refresh","onSort","getValue","entitySortChange","onRowClick","lastRecordCheckedKey","entityClick","onRowSelect","entitySelectChange","toggle","onToggleRow","selectNode","stopImmediatePropagation","recordIndex","lastRecordChecked","indexes","_record","selectedRecords","selectionCount","All","Some","columnIsSortable","sortable","rowIsSelected","isImg","isUrl","pop","Boolean","list_id","Number","list_option","edition","validationType","getColumnRenderer","getTableClass","getHeaderClass","func","headerClassFunc","Function","getRowClass","rowClassFunc","getCellClass","tableFunc","cellClassFunc","columnFunc","clickFunc","MatFormFieldControl","useExisting","Dock","ActionbarMode","action","ActionbarItemComponent","color","withTitle","withIcon","withTooltip","disabled$","noDisplay","noDisplay$","args","ngClass","ngClass$$","updateNgClass","isObservable","icon$$","updateIcon","checkCondition","checkCondition$$","updateCheckCondition","tooltip","tooltip$$","updateTooltip","availability","availability$$","available","disabled$$","display$$","noDisplay$$","trigger","ngClass$","tooltip$","checkCondition$","icon$","scrollUp","onTriggerAction","scrollDown","ctx_r1","ActionbarComponent","overlay","elRef","actionbarMode","collapsed","handler","withToggleButton","horizontal","iconColor","scrollActive","xPosition","yPosition","_overlayClass","overlayClass","withTitleClass","withIconClass","horizontalClass","heightCondition","clientHeight","scrollHeight","positionConditionTop","scrollTop","positionConditionLow","scrollBy","IgoActionbarModule","MatButtonModule","MatIconModule","MatTooltipModule","MatMenuModule","MatListModule","MatCardModule","MatCheckboxModule","IgoActionModule","IgoBadgeIconDirective","hidden","inverseColor","inheritColor","igoMatBadgeIcon","getNamedSvgIcon","svgObj","svg","updateSvg","matBadgeHidden","updateHidden","matBadgeDisabled","updateDisabled","igoMatBadgeInverseColor","updateColor","igoMatBadgeInheritColor","igoMatBadgeColor","igoMatBadgeBackgroundColor","backgroundColor","badge","querySelector","alignItems","justifyContent","innerHTML","background","getComputedStyle","getPropertyValue","originalColor","IgoMatBadgeIconModule","MatBadgeModule","ClickoutDirective","handleMouseClick","contains","clickout","IgoClickoutModule","CollapseDirective","_collapsed","_target","collapseTarget","expandTarget","click","CollapsibleComponent","_title","IgoCollapsibleModule","ConfirmDialogComponent","dialogRef","ConfirmDialogService","dialog","open","disableClose","confirmMessage","afterClosed","IgoConfirmDialogModule","imports","MatDialogModule","ContextMenuDirective","viewContainerRef","elementRef","onContextMenu","TouchEvent","touches","pageX","pageY","MouseEvent","close","preventDefault","menuPosition","overlayRef","positionStrategy","position","flexibleConnectedTo","withPositions","originX","originY","overlayX","overlayY","scrollStrategy","scrollStrategies","attach","TemplatePortal","menuContext","$implicit","clickTarget","overlayElement","take","dispose","LongPressDirective","touchDuration","onlyIOS","touchstart","touchEnd","touchTimeout","setTimeout","longpress","touchend","clearTimeout","IgoContextMenuModule","CustomHtmlComponent","_html","IgoCustomHtmlModule","MatInputModule","DOMService","getDom","dom","response","toPromise","IgoDOMModule","IgoDrapDropModule","DynamicComponent","componentFactory","subscriptions","inputs","inputs$$","subscribers","setTarget","componentRef","createComponent","updateInputs","updateSubscribers","unobserveAllInputs","instance","propName","unobserveInput","inputValue","observeInput","setInputValue","onUpdateInputs","prototype","getPrototypeOf","descriptor","getOwnPropertyDescriptor","outputs","emitter","subscriber","_subscriber","observable","DynamicComponentService","resolver","componentCls","resolveComponentFactory","DynamicOutletComponent","dynamicComponentService","component","eq","inputsAreEquivalents","subscribersAreEquivalents","dynamicComponent","renderComponent","ViewContainerRef","IgoDynamicOutletModule","IgoDynamicComponentModule","IgoFlexibleModule","FormComponent","autocomplete","hasButtons","buttons","children","formData","setData","onSubmit","submitForm","getData","getAllFormFields","form","groups","group","fields","field","updateDataWithFormField","reset","IgoFormFormModule","FormsModule","ReactiveFormsModule","FormService","addControl","validator","validators","getValidators","setValidators","extendFieldConfig","partial","validatorOption","validatorStr","getValidator","Validators","FormFieldService","getFieldByType","FormFieldComponent","formFieldService","fieldInputs","fieldSubscribers","fieldOptions","getFieldComponent","getFieldInputs","errors","placeholder","disableSwitch","formControl","required","getFieldSubscribers","IgoFormFieldModule","MatFormFieldModule","MatSelectModule","FormGroupComponent","getFieldColSpan","colSpan","cols","getFieldNgClass","getErrorMessage","messages","errorMessages","getControlErrorMessage","IgoFormGroupModule","IgoFormModule","IgoEntitySelectorModule","IgoStopPropagationModule","IgoEntityTablePaginatorModule","MatPaginatorModule","IgoImageModule","IgoEntityTableModule","MatTableModule","MatAutocompleteModule","MatSortModule","MatDatepickerModule","IgoEntityModule","InteractiveTourLoader","jsonURL","getPathToConfigFile","loadConfigTour","getJSON","allToursOptions","getTourOptionData","toolName","nameInConfigFile","InteractiveTourService","interactiveTourLoader","shepherdService","nextIndex","isAppHaveTour","haveTour","isToolHaveTourConfig","disabledTourButton","stepConfig","conditions","condition","isTourDisplayInMobile","getButtons","buttonKind","classes","getAction","actionName","addProgress","self","nbTry","checkExist","setInterval","getCurrentStep","attachTo","cancel","clearInterval","currentStepElement","getElement","querySelectorAll","classList","add","header","stepsArray","steps","progress","className","innerText","insertBefore","checkNext","tour","service","nextStep","_setupModal","executeAction","step","actionConfig","executeActionPromise","waitFor","maxTry","maxWait","getShepherdSteps","shepherdSteps","on","popperOptions","modifiers","offset","beforeShowPromise","previousStep","beforeChange","beforeShow","noBackButton","class","highlightClass","scrollTo","scrollToElement","canClickTarget","disableInteraction","when","onShow","hide","onHide","startTour","defaultStepOptions","cancelIcon","enabled","modal","confirmCancel","addSteps","tourObject","start","Toolbox","activeToolHistory","tool","setToolbar","toolbar","initStore","tools$","activeTool$$","getTool","getTools","setTools","tools","getToolbar","toolbar$","activateTool","activatePreviousTool","deactivateTool","previous","clearActiveToolHistory","setActiveTool","activeTool$","ToolService","toolbox","startInteractiveTour","InteractiveTourComponent","interactiveTourService","toolService","tourToStart","getClass","styleButton","getTourToStart","activeToolName","isActiveTool","isToolHaveTour","showTourButton","inMobileAndShow","IgoInteractiveTourModule","KeyValuePipe","keyValues","IgoKeyValueModule","ListItemDirective","_color","_focused","_disabled","focused","beforeFocus","beforeUnfocus","toggleFocusedClass","focus","unfocus","beforeSelect","beforeUnselect","toggleSelectedClass","unselect","beforeDisable","beforeEnable","toggleDisabledClass","enable","getOffsetTop","offsetTop","padding","focusedCls","disabledCls","ListComponent","_navigation","_selection","navigation","selectedItem","_selectedItem","focusedItem","_focusedItem","handleKeyboardEvent","navigationEnabled","enableNavigation","ngAfterViewInit","listItems","init","listItems$$","focusNext","toArray","igoList","getFocusedIndex","isScrolledIntoView","offsetHeight","focusPrevious","disableNavigation","scrollToItem","elem","docViewTop","elemTop","findSelectedItem","findFocusedItem","item2","handleItemBeforeSelect","handleItemSelect","handleItemBeforeFocus","handleItemFocus","IgoListModule","PanelComponent","_withHeader","cursorPointer","withHeader","IgoPanelModule","SpinnerComponent","shown","shown$","SpinnerActivityDirective","spinner","counter$$","IgoSpinnerModule","MatProgressSpinnerModule","TableDataSource","DataSource","_database","_model","_sort","_filterChange","connect","merge","dataChange","sortChange","getFilteredData","getSortedData","disconnect","filterable","propertyA","propertyB","TableActionColor","ctx_r14","handleClickAction","TableComponent","_hasFIlterInput","SelectionModel","database","model","hasFilterInput","displayedColumns","displayed","unshift","actions","changed","getActionColor","colorId","row","isAllSelected","masterToggle","MatSort","IgoTableModule","CdkTableModule","ActionStore","White","ToolboxColor","toolSlideInOut","speed","transition","animate","ToolboxComponent","classColorGrey","Grey","classColorPrimary","Primary","toolbar$$","onToolbarChange","onActiveToolChange","actionStore","onAnimationStart","animating$","onAnimationComplete","getToolInputs","onAnimate","animation$","_tool","_toolbox","activeTool","toolActivated","childrenToolActivated","parent","unAnimate","animating$$","animation","changeDetection","IgoToolboxModule","IgoToolModule","WidgetOutletComponent","onCancel","onComplete","destroyWidget","getEffectiveSubscribers","baseSubscribers","baseSubscriber","widget","IgoWidgetOutletModule","WidgetService","widgetCls","IgoWidgetModule","WorkspaceSelectorComponent","getWorkspaceTitle","workspace","onSelectedChange","activateWorkspace","IgoWorkspaceSelectorModule","WorkspaceWidgetOutletComponent","widget$","widgetInputs$","widgetSubscribers$","onWidgetCancel","deactivateWidget","onWidgetComplete","IgoWorkspaceWidgetOutletModule","IgoWorkspaceModule","TableDatabase","copiedData","ToolComponent","compType","WorkspaceStore","activeWorkspace$","deactivateWorkspace","Workspace","entityStore","hasWidget","activateWidget","AppHomeRoutingModule","RouterModule","AppHomeComponent","AppHomeModule","AppActivityRoutingModule","AppActivityComponent","idsActivity","counter","AppActivityModule","environment","production","igo","projections","code","alias","def","extent","auth","intern","allowAnonymous","interactiveTour","tourInMobile","importExport","catalog","sources","queryFormat","queryHtmlTarget","regFilters","tooltipType","searchSources","storedqueriesreverse","nominatim","icherche","searchUrl","order","limit","coordinatesreverse","showInPointerSummary","icherchereverse","ilayer","AppConfigRoutingModule","AppConfigComponent","configLanguage","AppConfigModule","AppLanguageRoutingModule","AppLanguageComponent","changeLanguage","AppLanguageModule","AppMediaRoutingModule","AppMediaComponent","media","orientation","AppMediaModule","AppMessageRoutingModule","AppMessageComponent","AppMessageModule","AppRequestRoutingModule","AppRequestComponent","callHttp","rep","callHttpError","AppRequestModule","AppActionRoutingModule","AppActionComponent","added$","AppActionModule","AppSalutationComponent","AppExplanationComponent","AppDynamicComponentRoutingModule","AppDynamicComponentComponent","toggleComponent","AppDynamicComponentModule","AppEntityTableRoutingModule","AppEntityTableComponent","description","image","AppEntityTableModule","AppEntitySelectorRoutingModule","AppEntitySelectorComponent","getTitle","AppEntitySelectorModule","AppFormRoutingModule","AppFormComponent","formService","choices","valueChanges$$","submitDisabled","valid","form$","fillForm","data$","clearForm","AppFormModule","AppTableRoutingModule","AppTableComponent","showName","handleSelect","rows","AppTableModule","AppSalutationToolComponent","__decorate","tslib_es6","ChangeDetectorRef","AppAboutToolComponent","AppToolRoutingModule","AppToolComponent","panelTitle","activateSalutationTool","AppToolModule","AppSalutationWidgetComponent","AppWidgetRoutingModule","AppWidgetComponent","widgetService","AppWidgetModule","TokenService","token","tokenKey","decode","jwtDecode","isExpired","jwt","currentTime","getTime","exp","AuthService","tokenService","languageForce","anonymous","authenticate$","authenticated","logged$","globalCacheBusterNotifier","hasAuthService","login","username","password","myHeader","encodePassword","loginCall","loginWithToken","infosUser","typeConnection","loginAnonymous","post","tap","logout","isAuthenticated","getToken","decodeToken","goToRedirectUrl","redirectUrl","loginRoute","navigateByUrl","homeRoute","getUserInfo","getProfils","updateUser","user","patch","logged","isAnonymous","isAdmin","tokenDecoded","locale","AuthGoogleComponent","authService","appRef","apiKey","clientId","loadSDKGoogle","loadPlatform","warn","handleSignInClick","gapi","auth2","getAuthInstance","signIn","handleSignOutClick","signOut","handleClientLoad","initClient","client","discoveryDocs","then","updateTextButton","isSignedIn","listen","updateSigninStatus","loginGoogle","access_token","btn","tick","fjs","getElementsByTagName","js","parentNode","AuthInternComponent","fb","_allowAnonymous","loading","loginUser","errorMsg","AuthFacebookComponent","appId","loadSDKFacebook","subscribeEvents","FB","Event","statusChangeCallback","loginFacebook","authResponse","accessToken","getElementById","AuthMicrosoftComponent","msalService","msalGuardConfig","PublicClientApplication","cache","cacheLocation","broadcastService","MsalBroadcastService","inProgress$","InteractionStatus","takeUntil","_destroying$","checkAccount","loginMicrosoft","loginPopup","getConf","authRequest","setActiveAccount","account","acquireTokenSilent","tokenId","idToken","catch","__awaiter","InteractionRequiredAuthError","acquireTokenPopup","conf","MSAL_GUARD_CONFIG","MsalServiceb2c","hash","redirectHash","initializeWrapperLibrary","WrapperSKU","initialize","request","acquireTokenRedirect","silentRequest","handleRedirectObservable","handleRedirectPromise","loginRedirect","logoutRequest","logoutRedirect","logoutPopup","ssoSilent","getLogger","logger","setLogger","MSAL_INSTANCE","MsalBroadcastServiceb2c","msalInstance","_msalSubject","msalSubject$","asObservable","_inProgress","addEventCallback","EventMessageUtils","verbose","eventType","AuthMicrosoftb2cComponent","browserAuthOptions","loginMicrosoftb2c","onLogin","home","AuthFormComponent","_backgroundDisable","_hasAlreadyConnectedDiv","_hasLogoutDiv","_showAlreadyConnectedDiv","_showLogoutDiv","backgroundDisable","isLogoutRoute","hasAlreadyConnectedDiv","hasLogoutDiv","showAlreadyConnectedDiv","showLogoutDiv","showLoginDiv","analyzeRoute","getName","logoutRoute","firstName","sourceId","events","NavigationStart","changeEvent","currentRoute","isLoginRoute","AuthInterceptor","refreshInProgress","trustHosts","hostname","hostsWithCredentials","hostsWithAuthByKey","withCredentials","handleHostsWithCredentials","hostWithKey","handleHostsAuthByKey","refreshToken","href","host","authReq","hashUser","Md5","interceptXhr","xhr","setRequestHeader","alterUrlWithKeyAuth","urlDecomposed","urlWithKeyAdded","paramsToKeep","reqUrl","hostWithCredentials","domainRegFilters","hostWithAuthByKey","keyProperty","keyValue","MSALConfigFactory","msConf","redirectUri","authority","MSALConfigFactoryb2c","MSALAngularConfigFactory","interactionType","InteractionType","scopes","loginHint","MSALAngularConfigFactoryb2c","provideAuthMicrosoft","MsalService","AuthStorageService","userIgo","preference","mergePreference","IgoAuthModule","MsalModule","AppAuthFormRoutingModule","AppAuthFormComponent","AppAuthFormModule","MetadataService","metadata","extern","openMetadata","MetadataButtonComponent","metadataService","layer","_layer","abstract","MetadataAbstractComponent","layerTitle","MAT_DIALOG_DATA","IgoMetadataModule","stringToLonLat","str","mapProjection","opts","lonLat","coordStr","negativeLon","degreesLon","minutesLon","secondsLon","directionLon","decimalLon","negativeLat","degreesLat","minutesLat","secondsLat","directionLat","decimalLat","zone","radius","lon","lat","projectionStr","projectionRegex","lonlatCoord","lonLatPattern","lonLatRegex","dmsCoord","dmsCoordPattern","dmsRegex","patternUtm","utmRegex","patternMtm","mtmRegex","ddCoord","patternDd","ddRegex","dmdCoord","patternDmd","dmdRegex","patternBELL","bellRegex","mmCoord","mmPattern","mmRegex","isXYCoords","toLocaleUpperCase","trim","parseFloat","convertDMSToDD","epsgUtm","olproj","epsgMtm","forceNA","dest","abs","degrees","minutes","seconds","neg","dd","convertDDToDMS","lonLatDD","lonLatDMS","ceil","int","toFixed","formatScale","scale","getResolutionFromScale","dpi","inchesPerMeter","ctrlKeyDown","originalEvent","altKey","MAC","metaKey","ctrlKey","shiftKey","roundCoordTo","coord","roundCoordToString","Layer","authInterceptor","geoDBService","layerDBService","legendCollapsed","firstLoadComponent","olLoadingProblem","displayed$","isInResolutionsRange$","visible$","ol","createOlLayer","zIndex","baseLayer","maxResolution","maxScaleDenom","minResolution","minScaleDenom","opacity","legendOptions","legend","setLegend","isIgoInternalLayer","getZIndex","setZIndex","setOpacity","isInResolutionsRange","setMaxResolution","updateInResolutionsRange","getMaxResolution","setMinResolution","getMinResolution","setVisible","hasBeenVisible$","showMessage","showInLayerList","setMap","igoMap","unobserveResolution","observeResolution","hasBeenVisible$$","resolution$$","viewController","resolution$","resolution","getResolution","OPACITY","LinkedProperties","TooltipType","TITLE","ImageWatcher","loaded","handleLoadStart","handleLoadEnd","handleLoadError","un","__watchers__","watcherIndex","params_","LAYERS","computeMVTOptionsOnHover","layerOptions","sourceOptions","igoStyle","styleByAttribute","hoverStyle","featureClass","TileWatcher","tile","generateIdFromSourceOptions","wms","generateWMSIdFromSourceOptions","wmts","generateWMTSIdFromSourceOptions","xyz","generateXYZIdFromSourceOptions","feature","generateFeatureIdFromSourceOptions","wfs","generateWfsIdFromSourceOptions","arcgisrest","generateArcgisRestIdFromSourceOptions","imagearcgisrest","tilearcgisrest","osm","_options","tiledebug","generateId","layers","standardizeUrl","featureTypes","origin","urlStandardized","dataService","createOlSource","getLegend","FeatureDataSource","getSourceFormatFromOptions","OlVectorSource","olFormatCls","formatType","olformat","formatOptions","onUnwatch","queryTitle","ClusterDataSource","olSourceCluster","VectorWatcher","olSource","getUrl","ImageLayer","valStatus","olOptions","olLayerImage","getSource","setImageLoadFunction","customLoader","interceptor","XMLHttpRequest","alteredUrlWithKeyAuth","abort","getImage","arrayBufferView","TextDecoder","imageUrl","URL","createObjectURL","send","TileLayer","tileLayer","olLayerTile","tileSource","setTileLoadFunction","modifiedUrl","BasicNumericOperator","OgcFilterOperatorType","OgcFilterOperator","BBOX","OgcFilterWriter","filterSequence","PropertyIsEqualTo","spatial","fieldRestrict","PropertyIsNotEqualTo","PropertyIsLike","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","PropertyIsBetween","During","PropertyIsNull","Intersects","Within","Contains","defineOgcFiltersDefaultOptions","ogcFiltersOptions","fieldNameGeometry","srcType","ogcFiltersDefaultValue","editable","geometryName","advancedOgcFilters","pushButtons","checkboxes","radioButtons","buildFilter","proj","ourBboxFilter","enableBbox","filterAssembly","olfilter","getCode","checkIgoFiltersProperties","bundleFilter","wfsOptions","srsName","featureNS","featurePrefix","outputFormat","query","olFormatWFS","writeGetFeature","XMLSerializer","serializeToString","filterObject","logicalArray","createFilter","operator","logical","filterOptions","wfsPropertyName","propertyName","wfsPattern","pattern","wfsMatchCase","matchCase","wfsWildCard","wildCard","wfsSingleChar","singleChar","wfsEscapeChar","escapeChar","wfsLowerBoundary","lowerBoundary","wfsUpperBoundary","upperBoundary","wfsGeometryName","wfsExtent","wfsWktGeometry","wkt_geometry","wfsSrsName","wfsBegin","parseFilterOptionDate","begin","minDate","wfsEnd","end","maxDate","wfsExpression","expression","geometry","olWKT","readGeometry","dataProjection","featureProjection","And","Or","Not","defineInterfaceFilterSequence","level","addInterfaceFilter","computeAllowedOperators","defaultOperatorsType","allowedOperators","fieldsHasSpatialOperator","includeContains","effectiveOperators","srcField","allowedOperatorsType","Spatial","BasicAndSpatial","operators","Basic","Time","igoOgcFilterObject","parentLogical","filterid","sliderOptions","igoSpatialSelector","igoSNRC","filterArray","addFilterProperties","rebuiltIgoOgcFilterObjectFromSequence","sequence","nextElement","lastProcessedFilter","lastParentLogical","uiFilter","computeIgoSelector","computedSelectors","selector","bundles","bundle","selectorType","selectorGroup","handleOgcFiltersAppliedValue","ogcFilters","filterQueryStringSelector","filterQueryStringAdvancedFilters","pushConditions","formatGroupAndFilter","checkboxConditions","selectorsCorr","verifyMultipleEnableds","radioConditions","selectConditions","filterQueryString","formatProcessedOgcFilter","enableds","list","selectorBundle","g","bundleCondition","selectorsType","ogcselector","enabledSelector","processedFilter","layersOrTypenames","appliedFilter","layerOrTypenames","defaultValue","isValid","defaultEpsg","defaultMaxFeatures","defaultFieldNameGeometry","gmlRegex","buildUrl","randomParam","paramsWFS","queryStringValues","formatWFSQueryString","igoFilters","ogcFilterWriter","filterOrBox","filterOrPush","xmlFilter","baseUrl","download","dynamicUrl","dataSourceOptions","epsg","forceDefaultOutputFormat","versionWfs200","urlWfs","effectiveCount","effectiveStartIndex","epsgCode","paramMaxFeatures","cnt","maxFeatures","srs","valueReference","sourceFields","fieldsNames","sourcefield","separator","getFeature","getpropertyvalue","wfsDataSourceOptions","getFormatFromOptions","gmlFormat","olFormatGML2","olFormatGML32","olFormatGML3","olFormatOSMXML","System","InsertSourceInsertDBEnum","VectorLayer","geoNetworkService","browsable","exportable","initialOpacityValue","initialVisibleValue","initialMinResValue","initialMaxResValue","so","preload","bypassVisible","bypassResolution","flash","bind","idbInfo","storeToIdb","firstLoad","maintainFeaturesInIdb","once","trackFeature","enableTrackFeature","vector","OlVectorLayer","vectorSource","failure","customWFSLoader","setLoader","idbLoader","customIDBLoader","_g","maintainOptionsInIdb","removeLayerFromIDB","zip","deleteByKey","igoStyleObject","olStyleToBasicIgoStyle","layerOlStyle","getStyle","fill","getFill","getColor","stroke","getStroke","width","circle","layerData","layerId","detailedContextUri","contextUri","queryable","insertEvent","dsFeatures","getFeatures","geojsonObject","writeFeatures","getProjection","User","listenerKey","vectorContext","getVectorContext","frameState","flashGeom","getGeometry","elapsed","time","elapsedRatio","duration","easeOut","newColor","asArray","getStyleFunction","style2","styleClone","getType","getRadius","setRadius","setColor","setWidth","getWidth","setText","setStyle","drawGeometry","unByKey","render","setExtent","stopAnimation","trackFeatureListenerId","centerMapOnFeature","feat","getFeatureById","getView","setCenter","getCoordinates","getId","disableTrackFeature","wfsProj","olProjection","currentExtent","alteredUrl","nbOfFeature","threshold","idAssociatedCall","mostRecentIdCallOGCFilter","removeLoadedExtent","onerror","responseText","features","getFormat","readFeatures","addFeatures","projection","delay","concatMap","content","DOMParser","parseFromString","readProjection","responseXML","layerID","VectorTileLayer","vectorTile","olLayerVectorTile","vectorTileSource","onLoad","FEATURE","FeatureMotion","OSMDataSource","olSourceOSM","XYZDataSource","olSourceXYZ","WFSDataSource","wfsService","checkWfsParams","sf","getSourceFieldsFromWFS","setOgcFilters","OlLoadingStrategy","triggerEvent","notify","WFSService","DataService","defineFieldAndValuefromWFS","getfeatureSourceField","wfsGetFeature","nb","d","fieldList","fieldListWoGeom","fieldListWoGeomStr","olFormats","effectiveOlFormats","gmlDataSourceOptions","sourceFieldsToRetrieveValues","allowGml","firstFeature","getKeys","getGeometryName","processingArray","chunkSize","results","mfeatures","loopFeatures","built_properties_value","kv","getProperties","boundedBy","fieldType","featureProperties","GML2","QueryFormat","QueryFormatMimeType","QueryHtmlTarget","IFRAME","WMSDataSource","sourceParams","DPI","MAP_RESOLUTION","FORMAT_OPTIONS","refreshIntervalSec","wfsCheckup","buildDynamicDownloadUrlFromParamsWFS","sourceField","initOgcFilters","calendarModeYear","FILTER","updateParams","timeFilterable","timeFilter","setTimeFilter","mapLabel","BLANK","igoRefresh","asWFSDataSourceOptions","olSourceImageWMS","ratio","timeFilter$","projParam","contentDependent","contentDependentLegend","VERSION","currentStyle","createDefaultTileGrid","projectionExtent","getExtent","resolutions","matrixIds","z","olTileGridWMTS","getTopLeft","WMTSDataSource","tileGrid","olSourceWMTS","CartoDataSource","crossOrigin","olSourceCarto","htmlString","types","oneType","cartocss","colors","layer_name","ArcGISRestDataSource","esrijsonFormat","olFormatEsriJSON","attributions","overlaps","encodeURIComponent","customParams","legendInfo","legendElement","htmlImgSrc","contentType","imageData","uniqueValueInfos","symbol","createSVG","strokeWidth","outlineColor","outline","ImageArcGISRestDataSource","renderingRule","ImageArcGISRest","TileArcGISRestDataSource","olSourceTileArcGISRest","TileDebugDataSource","baseOptions","TileGrid","TileDebug","WebSocketDataSource","createWebSocket","ws","WebSocket","onmessage","onMessage","onclose","onClose","onopen","onOpen","featureAdded","readFeature","featureToRemove","removeFeature","addFeature","MVTDataSource","mvtFormat","olFormatMVT","OlFeature","olSourceVectorTile","EsriStyleGenerator","_converters","esriPMS","_convertEsriPMS","esriSFS","_convertEsriSFS","esriSLS","_convertEsriSLS","esriSMS","_convertEsriSMS","esriTS","_convertEsriTS","_renderers","uniqueValue","_renderUniqueValue","simple","_renderSimple","classBreaks","_renderClassBreaks","point","units","mpu","rotation","_transformAngle","angle","olStyle","_transformColor","font","weight","family","textBaseline","verticalAlignment","textAlign","horizontalAlignment","offsetX","_convertPointToPixel","xoffset","offsetY","yoffset","_convertOutline","lineDash","ol3Rad","PI","points","radius2","_convertLabelingInfo","labelingInfo","mapUnits","styles","ii","labelExpression","maxScale","minScale","_getResolutionForScale","getText","defaultSymbol","defaultStyle","classBreakInfos","classBreakInfo","classMinValue","minValue","classMaxValue","field1","infos","me","generateStyle","layerInfo","drawingInfo","styleFunctions","drawingInfoStyle","labelingInfoStyleFunctions","DATE","TimeFilterType","TimeFilterStyle","CALENDAR","MapService","getMap","TypeCapabilities","CapabilitiesService","mapService","WMSCapabilities","WMTSCapabilities","esriJSON","EsriJSON","getWMSOptions","getCapabilities","capabilities","parseWMSOptions","getWMTSOptions","parseWMTSOptions","getCartoOptions","jsonp","mapId","cartoOptions","parseCartoOptions","getArcgisOptions","serviceCapabilities","arcgisOptions","parseArcgisOptions","getImageArcgisOptions","legendUrl","parseTileOrImageArcgisOptions","getTileArcgisOptions","HttpParams","fromObject","_i","parsers","read","findDataSourceInCapabilities","Capability","DataURL","Abstract","keywordList","KeywordList","getTimeFilter","Style","isExtentInGeographic","EX_GeographicBoundingBox","queryFormatMimeTypePriority","GEOJSON","GEOJSON2","GML3","HTML","mimeType","Request","GetFeatureInfo","Format","keyEnum","_layerOptionsFromSource","Title","MaxScaleDenominator","MinScaleDenominator","OnlineResource","stepDate","Contents","Identifier","optionsFromCapabilities","ouputOptions","layer_definition","olAttribution","copyrightText","timeExtent","timeInfo","setTime","toUTCString","DATETIME","serviceDescription","displayField","layerName","layerArray","Name","dimension","Dimension","minMaxDim","stylesAvailable","OptionsService","ProjectionService","registerProjection","utmZone","mtmZone","lon0","proj4","olproj4","DataSourceService","capabilitiesService","optionsService","wfsDataSourceService","projectionService","createAsyncDataSource","context","createOSMDataSource","createFeatureDataSource","createWFSDataSource","wmsContext","createWMSDataSource","createWMTSDataSource","createXYZDataSource","createTileDebugDataSource","createCartoDataSource","createArcGISRestDataSource","createArcGISRestImageDataSource","createWebSocketDataSource","createMVTDataSource","createTileArcGISRestDataSource","createClusterDataSource","datasources$","observables","optionsFromApi","optionsMerged","getArcgisRestOptions","featureToOl","projectionOut","olFeature","OlGeoJSON","setId","mapTitle","getEntityRevision","featureFromOl","projectionIn","olLayer","exclude","excludeOffline","idColumn","olFormat","startsWith","writeGeometryObject","excludeAttribute","excludeAttributeOffline","getRevision","olFeatures","olextent","featureExtent","olExtent","olFeatureExtent","olFeatureProjection","olGeometry","computeOlFeatureExtent","height","featuresAreOutOfView","featuresExtent","edgeRatio","edgesRatio","viewExtent","scaleExtent","motion","areaRatio","computeOlFeaturesExtent","Zoom","zoomToExtent","Move","moveToExtent","featuresAreTooDeepInView","mapExtent","mapExtentArea","featuresExtentArea","getZoom","hideOlFeature","bindLayer","addLayer","FeatureStore","searchDocument","_searchDocument","setLayerFeatures","viewScale","checkLayer","setLayerOlFeatures","setStoreOlFeatures","clearLayer","olFeaturesMap","olFeaturesToRemove","newOlFeature","olFeaturesToAddIds","computeOlFeaturesDiff","removeOlFeaturesFromLayer","addOlFeaturesToLayer","moveToOlFeatures","setLayerExtent","FeatureStoreInMapExtentStrategy","states$$","watchStore","empty$$","skipWhile","updateEntitiesInExtent","unwatchStore","unwatchAll","stores$$","state$","inMapExtent","entitiesInMapExtent","entitiesWithNoGeom","FeatureStoreInMapResolutionStrategy","updateEntitiesInResolution","mapResolution","inMapResolution","FeatureStoreLoadingStrategy","setMotion","subscription","onFeaturesChange","selectMotion","getFeatureId","FeatureStoreLoadingLayerStrategy","onSourceChanges","flatMap","cluster","OlDragSelectInteraction","OlDragBoxInteraction","FeatureStoreSelectionStrategy","_overlayStore","createOverlayStore","overlayStore","unselectAll","deactivateSelection","unlistenToMapClick","removeDragBoxInteraction","addOverlayLayer","listenToMapClick","dragBox","addDragBoxInteraction","watchAll","removeOverlayLayer","stores$","mapClickListener","onMapClick","getFeaturesAtPixel","pixel","hitTolerance","layerFilter","onSelectFromMap","olDragSelectInteraction","olInteractions","getInteractions","getArray","olInteraction","addInteraction","olDragSelectInteractionEndKey","onDragBoxEnd","removeInteraction","mapBrowserEvent","getFeaturesInExtent","overlayFeaturesKeys","featuresKeys","doMotion","groupedFeatures","groupFeaturesByStore","unselectAllFeaturesFromStore","selectFeaturesFromStore","overlayLayer","createOverlayLayer","removeLayer","FeatureStoreSearchIndexStrategy","initStoreSearchIndex","Document","tokenize","onEntitiesChanges","percentDistinctValueRatio","featuresProperties","fp","igoSearchID","toIndex","columnsToNotIndex","contentToIndex","searchIndex","sf2","columnsToIndex","distinctValues","propertiesToIndex","markerColor","markerOutlineColor","svgIconColor","svgOutlineColor","newOutlineColor","anchor","overflow","StyleService","createStyle","createOverlayMarkerStyle","parsedStyle","parseStyle","labelMinResolution","labelMaxResolution","labelMinResolutionFromScale","labelMaxResolutionFromScale","attribute","getLabel","styleOptions","olCls","getOlCls","_key","olKey","getOlKey","createStyleByAttribute","guessTypeFeature","labelStyle","baseStyle","val","createClusterStyle","clusterParam","layerStyle","clusterRanges","minRadius","maxRadius","showRange","dynamicRadius","clusterRadius","radiusMin","image_","radiusCalc","labelMatch","labelToGet","matchAll","createOverlayLayerStyle","createOverlayDefaultStyle","markerStyle","createBufferStyle","strokeRGBA","fillRGBA","bufferRadius","customStyle","fillColor","strokeColor","fillWithOpacity","strokeWithOpacity","Overlay","overlayDataSource","setFeatures","removeOlFeature","addOlFeatures","addOlFeature","removeFeatures","LayerWatcher","unwatchLayer","setPropertyChange","TIMEFILTER","OGCFILTERS","VISIBLE","MINRESOLUTION","MAXRESOLUTION","propertyChange$","watchLayer","evt","layer$$","MapViewAction","MapController","observerKeys","getOlMap","olMap","setOlMap","MapViewController","maxZoomOnExtent","states","stateIndex","stateHistory","olView","setPadding","top","right","bottom","left","onMoveEnd","extent$$","extent$","monitorRotation","rotation$","getRotation","getOlProjection","getCenter","center","calculateExtent","getSize","getScale","getScaleFromResolution","unit","getUnits","zoomIn","zoomTo","zoomOut","zoom","cancelAnimations","easing","oleasing","resetRotation","hasPreviousState","hasNextState","previousState","setStateIndex","nextState","clearStateHistory","setInitialState","fromCenter","toCenter","distCenter","sqrt","fromExtent","fromSize","xSize","maxZoom","fit","isFinished","setState","state1","state2","tolerance","trunc","viewStatesAreEqual","GeolocationOverlayType","Position","MapGeolocationController","storageService","subscriptions$$","_buffer","buffer","_accuracyThreshold","accuracyThreshold","_followPosition","followPosition","geolocationOverlay","bufferStyle","bufferStroke","bufferFill","showBufferRadius","arrowStyle","displacement","arrowRotation","rotateWithView","handleFeatureCreation","position$","olGeolocation","geolocation","tracking","getTracking","setTracking","tracking$","followPosition$","deleteGeolocationFeatures","deleteFeatureByType","PositionDirection","Accuracy","Buffer","onPositionChange","trackingOptions","enableHighAccuracy","maximumAge","timeout","emissionIntervalSeconds$","interval","updateArrowFeatureOrientation","position4326","lastPosition","coordinates","dateTime","arrowFeature","getFeatureByType","isMoving","distanceBetweenPoints","accuracy","theta","atan2","coord1","coord2","olSphere","addOnChangedListener","listener","deleteChangedListener","updateGeolocationOptions","geolocate","alwaysTracking","storedTracking","storedFollowPosition","geolocateProperties","altitude","altitudeAccuracy","heading","timestamp","handleViewFromFeatures","featureById","positionGeometry","Point","accuracyGeometry","fromCircle","OlCircle","positionFeature","positionFeatureArrow","accuracyFeature","positionFeatureExists","positionFeatureArrowExists","accuracyFeatureExists","positionFeatureStyle","accuracyFeatureStyle","setGeometry","bufferFeature","bufferFeatureExists","bufferGeometry","areOutOfView","getLinkedLayersOptions","linkedLayers","linkId","getRootParentByProperty","layerToUse","parentLayer","hasParentLayer","getDirectParentLayerByProperty","hasLinkWithProperty","layerLLOptions","links","layerHasLinkWithProperty","currentLinkId","parents","pl","linkedIds","getDirectChildLayersByProperty","link","lid","getIgoLayerByLinkId","getAllChildLayersByProperty","knownChildLayers","childLayers","cl","syncedDelete","getAllChildLayersByDeletion","getDirectChildLayersByDeletion","rootLayersByProperty","plbp","layersId","IgoMap","attribution","defaultOptions","layerWatcher","layers$","scaleLine","olControlScaleLine","interactions","altShiftDragRotate","doubleClickZoom","keyboard","mouseWheelZoom","shiftDragZoom","dragPan","pinchRotate","pinchZoom","setView","queryResultsOverlay","searchResultsOverlay","geolocationController","mapViewOptions","initLayerSyncFromRootParentLayers","skipWhile$1","pc","handleLayerPropertyChange","propertyChange","initiatorIgoLayer","isLayerProperty","isDatasourceProperty","rootParentByProperty","clbp","resolutionPropertyHasChanged","initiatorIgoLayerSourceType","initiatorIgoLayerOgcFilterableDataSourceOptions","getUid","lLayerType","appliedOgcFilter","getParams","appliedTimeFilter","TIME","updateView","currentView","viewOptions","constrainResolution","maxLayerZoomExtent","updateControls","getControls","removeControl","changeBaseLayer","bl","getBaseLayers","setMinZoom","minZoom","setMaxZoom","getLayerById","getLayerByAlias","getLayerByOlUId","olUId","getLayerByOlLayer","addLayers","offsetZIndex","offsetBaseLayerZIndex","addedLayers","doAddLayer","setLayers","removeLayers","newLayers","layersToRemove","handleLinkedLayersDeletion","linkedLayer","linkedIndex","doRemoveLayer","srcLayer","rootParentByDeletion","getDirectParentLayerByDeletion","layerHasLinkDeletion","hasLinkWithSyncedDelete","getRootParentByDeletion","clbd","removeAllLayers","raiseLayer","getLayerIndex","moveLayer","raiseLayers","lowerLayer","lowerLayers","reverseLayers","layerTo","zIndexFrom","existingLayer","maxZIndex","sortLayersByZIndex","layer1","layer2","MapBrowserComponent","_view","_controls","activityId","PointerPositionDirective","pointerPositionDelay","listenToMapPointerMove","unlistenToMapPointerMove","pointerMoveListener","onPointerEvent","dragging","lastTimeoutRequest","lonlat","coordinate","pointerPositionCoord","featureRandomStyleFunction","featureRandomStyle","olStyles","backgroundFill","backgroundStroke","imgSize","HoverFeatureDirective","styleService","selectionMVT","hoverFeatureId","igoHoverFeatureDelay","igoHoverFeatureEnabled","mouseout","subscribeToPointerStore","layers$$","tryBindStoreLayer","hoverFeatureMarkerStyle","selectionLayer","renderMode","declutter","mvtStyleOptions","createHoverStyle","localHoverStyle","hasLabelStyle","unsubscribeToPointerStore","unlistenToMapSingleClick","store$$","pointerHoverFeatureStore","resultsUnderPointerPosition","addFeatureOverlay","onMapEvent","singleClickMapListener","onMapSingleClickEvent","topMostOlLayer","maximumZindex","getPixelFromCoordinate","forEachFeatureAtPixel","mapFeature","layerOL","igoLayer","ol_uid","canProcessHover","myLayerVector","localOlFeature","handleRenderFeature","setLayerStyleFromOptions","featuresToLoad","myLabelOlFeature","setProperties","labelGeom","olgeom","myLayerVectorTile","setSource","mvtFeatures","localFeature","RenderFeature","hoverEntity","hoverSummary","getHoverSummary","summary","geom","getOrientedFlatCoordinates","coords","flatCoords","idx","ZoomButtonComponent","getMinZoom","getMaxZoom","onGeolocationClick","GeolocateButtonComponent","_map","ngAfterContentInit","tracking$$","HomeExtentButtonComponent","computeHomeExtent","homeExtentButtonExtent","extentOverride","homeExtentButtonCenter","centerOverride","homeExtentButtonZoom","zoomOverride","onToggleClick","WakeLockButtonComponent","noSleep","NoSleep","ie","edge","chrome","firefox","opera","safari","disableWakeLock","addEventListener","enableWakeLock","toggleWakeLock","collapseOrExpand","BaseLayersSwitcherComponent","_baseLayers","expand","showButton","useStaticIcon","arrayLayers","baseLayers","mapZoom","blHidden","GeoDBService","ngxIndexedDBService","compression","dbName","_newData","regionID","insertSource","compress","subject","geoDBData","object$","getByID","dbObject","currentRegionID","collisions","collisionsMap","customUpdate","deleteRequest","isDeleted","getRegionCountByID","getRegionByID","datas","IDBKey","IDBKeyRange","only","getAllByIndex","deleteByRegionID","dbRequest","openCursor","keyRange","lowerBound","mode","DBMode","openCursorByIndex","resetCounters","resetCollisionsMap","revertCollisions","getByKey","newData","GeoNetworkService","networkService","networkOnline","simpleGetOptions","getOnline","getOffline","isOnline","LayerDBService","layerDBData","getAll","LayerService","dataSourceService","createLayer","createTileLayer","createVectorLayer","createImageLayer","_layerOptions","createVectorTileLayer","createAsyncLayer","handleLegacyStyles","serviceStyle","clusterBaseStyle","layerOptionsOl","applyMapboxStyle","legacyStyleOptions","legacyOption","mapboxStyle","getStuff","sprite","getAbsoluteUrl","res2","stylefunction","createAsyncIdbLayers","layersOptions","idbl","MiniBaseMapComponent","layerService","basemap","_display","_baseLayer","handleBaseLayerChanged","handleMainMapViewChange","mainMapView","mainMapViewProperties","setResolution","setRotation","baselayer","handleLinkedBaseLayer","currentLinks","linkedId","layerToApply","linkedLayerOptions","RotationButtonComponent","azimuthRounded","rotationRounded","currentStyle$","radians","deg","bearingToAzimuth","rotated$","InfoSectionComponent","infoContent","CatalogItemType","TypeCatalog","Catalog","catalogService","WMSCatalog","collectCatalogItems","loadCatalogWMSLayerItems","WMTSCatalog","loadCatalogWMTSLayerItems","BaselayersCatalog","baselayers","loadCatalogBaseLayerItems","ArcGISRestCatalog","loadCatalogArcGISRestItems","TileOrImageArcGISRestCatalog","typeCatalog","CompositeCatalog","composite","loadCatalogCompositeLayerItems","CatalogFactory","QueryService","queryEnabled","previousMessageIds","queryLayer","apply","getQueryUrl","HTMLGML2","urlGml","mergeMap","gmlRes","mergedGML","mergeGML","imposedGeom","imposedProperties","extractData","urlGmls","checkScaleAndResolution","requestDataForHTMLGML2","checkScale","checkResolution","olmline","pts","ptsArray","firstFeatureType","olmpoly","nbFeatures","bbox","getQueryParams","bboxExtent","titleContent","queryTileField","olmpts","returnGeometry","queryTitleContent","featureGeometryCoordinates","featureGeometryType","appendLineString","appendPolygon","convexHull","cross","lower","upper","imposedGeometry","queryDataSource","allowedFieldsAndAlias","getAllowedFieldsAndAlias","extractGML3Data","extractGeoJSONData","ESRIJSON","extractEsriJSONData","TEXT","extractTextData","extractHtmlData","extractGML2Data","geomToAdd","createGeometryFromUrlClick","wmsDatasource","FEATURE_COUNT","featureCount","defaultFeatureCount","getQueryTitle","sourceTitle","searchParams","bboxRaw","clickx","clicky","clickx1","clicky1","wktPoly","wmsParser","featureToResult","parser","htmlTarget","crs","bodyTagStart","bodyTagEnd","lastIndexOf","striptags","queryString","pairs","featureOL","featureGeometry","GEOMETRIE","shape","SHAPE","SHAPE_S","SHAPE_L","SHAPE_P","the_geom","geom32198","datasource","forceGML2","queryUrls","getCustomQueryUrl","WMSGetFeatureInfoOptions","INFO_FORMAT","getMimeInfoFormat","QUERY_LAYERS","getFeatureInfoUrl","cartoDatasource","sql","queryPrecision","tileArcGISRestDatasource","deltaX","deltaY","clickBuffer","mime","getLabelMatch","layerIsQueryable","olLayerFeatureIsQueryable","layerFeatureIsQueryable","queryLayerFeatures","QueryDirective","queryService","queries$$","queryFeatures","queryFeaturesHitTolerance","waitForAllQueries","cancelOngoingQueries","queries$","doQueryFeatures","queryLayers","query$","clickedFeatures","values_","queryFormatAsWms","newFeature","nom","id_","_icon","renderFeatureFromOl","olRenderFeature","geometryType","ends","getEnds","OlPolygon","getFlatCoordinates","OlPoint","OlLineString","queryFeaturesCondition","dragExtent","forEachFeatureIntersectingExtent","olDragSelectInteractionOnQuery","SearchSource","storageOptions","getDefaultOptions","settings","setting","setParamFromSetting","showInSettings","featureStoresWithIndex","storesWithIndex","_featureStoresWithIndex","setWorkspaces","workspaces","fw","datasets","saveInStorage","confValue","displayOrder","getHashtagsValid","term","settingsName","hashtags","searchSourceSetting","getSettingsValues","hashtagsValid","hashtag","hashtagKey","QuerySearchSource","GoogleLinks","encodeURI","OsmLinks","CatalogService","loadCatalogs","contextConfig","catalogConfig","apiUrl","catalogsFromConfig","catalogsFromApi$","catalogs","_response","EMPTY","loadCatalogItems","newCatalog","createInstanceCatalog","getCatalogBaseLayersOptions","externalProvider","Group","getCatalogCapabilities","Service","finalLayers","flattenWmsCapabilities","groupSeparator","capabilitiesCapabilityLayer","includeRecursiveItems","modifiedParent","modifiedLayer","ff","getWMTSItems","getArcGISRESTItems","compositeCatalog","catalogsFromInstance","sortDirection","request1$","request2$","flatDeepLayer","arr","groupImpose","pushImposeGroup","outGroupImpose","address","flatLayer","obs","request3$","recursiveGroupByLayerAddress","keyFn","outItem","indicesMatchTitle","indicesMatchNewMetadataUrl","bInd","nPosition","newMetadataUrl","groupByGroupId","groupId","ind","ix","computeForcedProperties","layerNameFromCatalog","forcedProperties","returnProperty","metadataUrl","metadataAbstract","metadataAbstractAll","metadataUrlAll","forcedPropertiesForAllLayers","forcedProperty","prepareCatalogItemLayer","idParent","layersQueryFormat","configuredQueryFormat","retrieveLayerInfoFormat","showLegend","baseSourceOptions","setCrossOriginAnonymous","propertiesToForce","baseAbstract","layerPrepare","prepareCatalogItemGroup","itemListIn","regexes","idGroup","groupItem","testLayerRegexes","layerItem","itemsPrepare","loopLevel","findCatalogInfoFormat","ServiceIdentification","matrixSet","requestEncoding","regex","currentLayerInfoFormat","baseInfoFormat","configuredInfoFormat","specific","onLayerAddedChange","CatalogBrowserComponent","catalogAllowLegend","toggleCollapsedGroup","currentItems","isGroup","isLayer","addLayerToMap","removeLayerFromMap","onGroupAddedChange","addGroupToMap","removeGroupFromMap","addLayersToMap","removeLayersFromMap","profils","security","layersAddedByClick$","currLayer","sortCatalogItemsByTitle","returnItem","titleA","titleB","toggleLegendItem","style_r18","onChangeStyle","onLoadImage","LayerLegendComponent","updateLegendOnResolutionChange","imagesHeight","lastlLegend","listStyles","STYLES","onViewControllerStateChange","legendItems$","getLegendGraphic","obsLegGraph","leg","imgGraphValue","transfertToggleLegendItem","newLegends","outLegends","lastLegends","computeItemTitle","layerLegend","localLayerOptions","wmsDataSourceOptions","updateLegend","legendItems","sA","sa","elemRef","renderedLegends","renderedLegend","CatalogBrowserLayerComponent","mouseInsideAdd","isPreview$$","isPreview$","addedLayerIsPreview","isVisible","computeTitleTooltip","layerTooltip","layerMetadata","ABSTRACT","CUSTOM","onMouseEvent","askForLegend","layerLegendShown$","igoLayer$","addedChange","haveGroup","isNaN","inRange$","oLayer","isVisible$","getBadgeIcon","computeTooltip","CatalogBrowserGroupComponent","toggleCollapsed","evaluateAdded","evaluateDisabled","onToggleCollapsed","layerAddedChange","tryToggleGroup","onLayerPreview","preview$","onTitleClick","LayerListToolService","sortAlpha","onlyVisible","onlyInRange","keywordInitialized","sortedAlphaInitialized","onlyVisibleInitialized","onlyInRangeInitialized","check","toggleVisibility","toggleLayerTool","LayerItemComponent","_selectAll","toggleLegendOnVisibilityChange","expandLegendIfVisible","orderable","lowerDisabled","raiseDisabled","queryBadge","activeLayer","_activeLayer","selectionMode","layerTool$","selectAll","layerCheck","eyeTooltip","inResolutionRange$","toggleLegend","updateQueryBadge","onResolutionChange","tooltipText","network$$","showLegend$","toggleLegendOnClick","inResolutionRange","queryBadgeHidden$","checkbox","always","LayerListControlsEnum","LayerListSelectVisibleEnum","ALL_VISIBLE","LayerListDisplacement","Raise","zoomLayerExtents","changeOpacity","zoomLayersExtents","LayerListComponent","thresholdToFilterAndSort","hideSelectedLayers","layersChecked","layersAreAllVisible","ogcButton","timeButton","floatLabel","layerFilterAndSortOptions","excludeBaseLayers","expandLegendOfVisibleLayers","_keyword","_onlyVisible","_sortedAlpha","toggleOpacity","_layers","removeProblemLayerInList","activeLayer$","keyword","badgeOpacity","getUpperLayer","isUpperBaselayer","getLowerLayer","isLowerBaselayer","raiseDisabledSelection","raisableLayers","selectAllCheck","lowerDisabledSelection","lowerableLayers","checkOpacity","layersCheckedOpacity","layerListDisplacement","change$$","debounce","timer","showToolbar$","computeShowToolbar","computeLayers","appliedFilterAndSort","selectAllCheck$$","selectAllCheck$","checks","layerTool","lay","activeLayerExtentIsValid","showButtonZoomToExtent","layerExtent","activeLayersExtentAreValid","layersExtent","clearKeyword","moveActiveLayer","actiontype","fromUi","sortedLayersToMove","ZINDEX","layersToMove","Lower","base","mapIndex","currentLayer","previousLayer","raisableLayer","layersToRaise","checkItems","getElementsByClassName","itemFocused","targetToScroll","nextLayer","lowerableLayer","layersToLower","layersOut","filterLayers","sortLayersByTitle","sortLayersByZindex","onKeywordChange","onAppliedFilterAndSortChange","showToolbar","never","keepLayerIds","layerKeywords","kw","localKeyword","dataSourceType","keywordRegex","keywordInList","removable","layerItemChangeDetection$","isLayerRemovable","isAllLayersRemovable","statusSelectedLayersCheck","statusSelectedLayers","NULL","findTrue","findFalse","MIXED","ALL_HIDDEN","layersCheck","eventMapIndex","toggleSelectionMode","elemSource","layersList","clearTerm","LayerListToolComponent","onlyVisible$","sortAlpha$","term$","term$$","onlyVisible$$","sortAlpha$$","toggleSortAlpha","toggleOnlyVisible","LayerListBindingDirective","layersOrResolutionChange$$","shownLayers","setLayersVisibilityStatus","layersVisibility$$","visibles","allLayersAreVisible","toggleShowAllLegends","LayerLegendListComponent","showAllLegend","allowShowAllLegends","showAllLegendsValue","computeShownLayers","hasVisibleOrInRangeLayers$","hasVisibleAndNotInRangeLayers$","layersInUi$","allLegendsShown","toggleTrackFeature","TrackFeatureButtonComponent","LayerLegendItemComponent","IgoLayerModule","MatDividerModule","MatSlideToggleModule","MatSliderModule","ColorPickerModule","IgoCatalogBrowserModule","type_r9","ctx_r5","ctx_r6","AddCatalogDialogComponent","defaultAddedCatalogType","predefinedCatalogs","addedCatalog","typeCapabilities","addedCatalogType$$","updateValueAndValidity","computePredefinedCatalogList","storeViewAll$$","emailAddress","changeUrlOrTitle","patchValue","predefinedCatalogsList$","addCatalog","addCatalogDialog","CatalogLibaryComponent","addCatalogAllowed","addedCatalogs","getCatalogs","onCatalogSelect","catalogSelectChange","unsubscribeAddingCatalog","addingCatalog$$","predefinedCatalog","mapName","ServiceType","catalogToAdd","newCatalogs","onCatalogRemove","removeCatalogFromLibrary","CatalogLibaryItemComponent","catalogRemove","IgoCatalogLibraryModule","IgoCatalogModule","FilterableDataSourcePipe","arg","isTimeFilterable","isOgcFilterable","TimeFilterService","filterByDate","newdateform","newdateformStart","newdateformEnd","dates","reformatDateTime","filterByYear","year","years","getFullYear","month","getMonth","day","getUTCDate","hour","getUTCHours","minute","getUTCMinutes","OGCFilterService","filterByOgc","filterString","setOgcWFSFiltersOptions","wfsDatasource","interfaceOgcFilters","setOgcWMSFiltersOptions","filtered","SpatialFilterType","Predefined","SpatialFilterItemType","Address","SpatialFilterService","AdmRegion","Arrond","CircFed","CircProv","DirReg","MRC","Mun","RegTour","bornes","hydro","routes","getKeyByValue","loadFilterList","urlFilterList","featureCollection","loadThematicsList","loadFilterItem","itemType","thematic","urlItem","bufferInput","simplified","loc","loadItemById","featureType","featureCode","loadBufferGeometry","filterType","bufferOutput","DownloadService","DSOptions","currentProj","outputFormatDownload","baseurl","openDownload","DownloadButtonComponent","downloadService","IgoDownloadModule","openSecureUrl","ctx_r8","FeatureDetailsComponent","sanitizer","ready","unsubscribe$","_source","_feature","selectFeature","urlSanitizer","isHtmlDisplay","htmlDisplayEvent","htmlSanitizer","docOrImage","fileUrl","isEmbeddedLink","div","getAttribute","isDoc","getEmbeddedLinkText","filterFeatureProperties","offlineButtonState","forcedOffline$","Route","GeometryType","LabelType","Coordinates","CoordinatesUnit","DecimalDegree","FontType","Arial","createDrawInteractionStyle","createDrawHoleInteractionStyle","getMousePositionFromOlGeometryEvent","olEvent","DrawControl","olDrawingLayer","drawingLayer","createOlInnerOverlayLayer","olGeometryType","olInteractionStyle","interactionStyle","radiusVal","predefinedRadius$","radiusValData","radiusCercle","olDrawingLayerSource","activateModifyAndSelect","clearOlInnerOverlaySource","removeOlInnerOverlayLayer","removeOlInteractions","addOlInnerOverlayLayer","addOlInteractions","setOlInteractionStyle","setGeometryType","getGeometryType","drawingLayerSource","drawingLayerStyle","olDrawInteraction","freehand$","OlDraw","maxPoints","freehand","ispredefinedRadius$","stopClick","freehandCondition","onDrawStartKey","onDrawStart","onDrawEndKey","onDrawEnd","onDrawAbortKey","abort$","olModifyInteraction","OlModify","olSelectInteraction","OlSelect","doubleClick","onSelect","unsubscribeKeyDown","onDrawKey","start$","olGeometryEvent","mousePosition","changes$","subscribeKeyDown","radiusDrawEnd$","modify$","end$","select$","keyDown$$","removeLastPoint","finishDrawing","abortDrawing","Length","MeasureType","MeasureLengthUnit","Meters","Kilometers","Miles","Feet","SquareMeters","MeasureAreaUnit","SquareKilometers","SquareMiles","SquareFeet","Hectares","Acres","metersToKilometers","metersToFeet","metersToMiles","squareMetersToSquareKilometers","squareMetersToSquareMiles","squareMetersToSquareFeet","squareMetersToHectares","squareMetersToAcres","conversion","formatMeasure","measure","parts","toLocaleString","minimumFractionDigits","maximumFractionDigits","unitAbbr","MeasureLengthUnitAbbreviation","MeasureAreaUnitAbbreviation","createMeasureInteractionStyle","getLength","getArea","measureOlGeometryLength","area","measureOlGeometryArea","lengths","coordinatesLength","olSegment","updateOlGeometryMidpoints","olMidpoints","olMidpointPoint","getOlGeometryMidpoints","midpointsLength","midpointCoordinate","getCoordinateAt","olMidpoint","setCoordinates","expectedNumber","clearOlMidpointTooltip","olTooltip","removeOverlay","getTooltipsOfOlGeometry","olTooltips","getOlTooltipsAtMidpoints","olCenterTooltip","getOlTooltipAtCenter","olCenter","createOlTooltipAtPoint","olPoint","srcGeomType","OlOverlay","stopEvent","setPosition","createInteractionStyle","DegreesMinutesSeconds","onLabelTypeChange","onChangeCoordinateUnit","onChangeLengthUnit","onChangeAreaUnit","cancelDrawing","confirm","DrawPopupComponent","confirmFlag","Custom","labelType","arrayBuiltInType","currentLabel","labelLength","longitudeLatitude","Circle","longitude","latitude","longlatDD","coordinatesInDD","point4326","currentCoordinates","LineString","lengthInMeters","currentLength","Polygon","areaInMetersSquare","currentArea","circularPolygon","coordinatesMeasureUnit","lengthMeasureUnit","Area","areaMeasureUnit","buildArrayType","input","labelFlag","measureUnit","polygonCheck","lengthUnit","metersToUnit","areaUnit","squareMetersToUnit","coordinatesUnit","DDtoDMS","selectOptions","noLabelButton","customOrPredefined","optionAvailable","currentOption","allLengthUnits","getLengthUnitEnum","allAreaUnits","allCoordinatesUnits","getAreaUnitEnum","lengthLabelT","getLabelLength","getProperLengthLabel","DrawShorcutsComponent","DrawStyleService","labelsAreShown","fontSize","getFillColor","setFillColor","getStrokeColor","setStrokeColor","getStrokeWidth","getLabelsAreShown","toggleLabelsAreShown","setIcon","getIcon","getFontSize","setFontSize","getFontStyle","fontStyle","setFontStyle","getOffsetX","setOffsetX","getOffsetY","setOffsetY","createIndividualElementStyle","fontSizeAndStyle","labelsAreOffset","flatCoordinates","cos","StyleModalDrawingComponent","drawStyleService","buildForm","linestringOnly","buildStyleData","styleModalData","drawingStyle","allFontStyles","getFeatureFontSize","getFeatureFontStyle","getFeatureFillColor","getFeatureStrokeColor","getFeatureOffsetX","getFeatureOffsetY","DrawLayerPopupComponent","labelString","DrawIconService","getIconsList","getIcons","icons","getPath","onToggleFreehandMode","onMeasureUnitChange","deleteDrawings","onIconChange","openStyleModalDialog","DrawComponent","drawIconService","draw","editMode","editLabelDrawing","_stores","_drawControls","layerCounterID","draw$","drawControlIsDisabled","drawControlIsActive","freehandMode","UntypedFormControl","Subscription","isCreatingNewLayer","drawControls","activeDrawingLayer","_activeDrawingLayer","measureUnits","activeStore","activeDrawControl","dc","deactivateDrawControl","allLayers","selectedFeatures$","onLayerChange","createDrawControl","toggleDrawControl","drawControlsEvent","layersIDEvent","radiusFormControlChange$$","radiusFormControl","changeRadius","activeDrawingLayerSource","newTitle","isNewLayer","autoFocus","onFontChange","onColorChange","onOffsetLabelChange","openDrawDialog","isDrawEnd","updateLabelOfOlGeometry","updateLabelType","updateMeasureUnit","updateFontSizeAndStyle","updateFillAndStrokeColor","updateOffset","onSelectDraw","updateHeightTable","drawingLayerFeature","addFeatureToStore","clearLabelsOfOlGeometry","onModifyDraw","longLat","radiusLabel","olGeometryLength","lengthLabel","circleArea","areaLabel","olGeometryArea","replaceFeatureInStore","labelTypeAndUnit","olGeometryCoordinates","entityCoordinates","rad","center4326","lon4326","lat4326","featureId","extent4326","getDistance","setupLayer","currGeometryType","onToggleLabels","activeLayerChange","selectionChange","olGeometryFeature","openShorcutsDialog","selectedFeature","elementStyle","onToggleDrawControl","toggleIsChecked","isCircle","numberId","tryAddLoadingStrategy","tryAddSelectionStrategy","many","isAnIcon","onGeometryTypeChange","_label","fontStyle_","fillColor_","strokeColor_","offsetX_","offsetY_","typeOfLabel","labelType_","measureUnit_","numberOfDrawings","tableTemplate","updateActiveLayer","activateDrawControl","drawEnd$$","drawSelect$$","isPoint","isLineString","isPolygon","radiusMeters","pointStyle","selectedMeasureUnit","dependencies","IgoDrawModule","MatButtonToggleModule","BrowserModule","BrowserAnimationsModule","MatRadioModule","IgoFeatureDetailsModule","IgoFeatureFormModule","IgoFeatureModule","ModifyControl","olModifyInteractionIsActive","olTranslateInteractionIsActive","olDrawInteractionIsActive","removedOlInteractions","modify","olOverlayLayer","olLinearRingsLayer","createOlLinearRingsLayer","olOverlaySource","olLinearRingsSource","removeOlModifyInteraction","removeOlTranslateInteraction","removeOlDrawInteraction","addOlDrawInteraction","addOlTranslateInteraction","activateTranslateInteraction","addOlModifyInteraction","activateModifyInteraction","setOlGeometry","addOlLinearRingsLayer","removeOlLinearRingsLayer","clearOlLinearRingsSource","drawStyle","deactivateModifyInteraction","onModifyStartKey","onModifyStart","onModifyEndKey","onModifyEnd","onModifyKey","subscribeToKeyDown","unsubscribeToKeyDown","olTranslateInteraction","OlTranslate","deactivateTranslateInteraction","onTranslateStartKey","onTranslateStart","onTranslateEndKey","onTranslateEnd","onTranslateKey","olOuterGeometry","getOlGeometry","intersectsCoordinate","subscribeToDrawKeyDown","drawKeyDown$$","unsubscribeToDrawKeyDown","subscribeToDrawKeyUp","activateDrawInteraction","drawKeyUp$$","unsubscribeToDrawKeyUp","deactivateDrawInteraction","linearRingCoordinates","getLinearRing","addLinearRingToOlGeometry","_linearRingCoordinates","updateLinearRingOfOlGeometry","olPolygon","olLinearRing","appendLinearRing","addLinearRingToOlPolygon","OlLinearRing","newCoordinates","getLinearRings","LAYER","MeasurerDialogComponent","measureAreaUnit","measureLengthUnit","onNoClick","onToggleDisplayLines","onToggleDisplayDistance","onToggleDisplayAreas","onLengthUnitChange","onAreaUnitChange","onCalculateClick","onDeleteClick","MeasurerComponent","activeLengthUnit","activeAreaUnit","measureType","measureUnitsAuto","displayDistance","displayLines","displayAreas","showTooltips","minSegmentLength","activeMeasureType","setActiveMeasureType","_activeMeasureType","createDrawLineControl","createDrawPolygonControl","createModifyControl","updateTooltipsOfOlSource","checkDistanceAreaToggle","deactivateModifyControl","freezeStore","onMeasureTypeChange","onToggleMeasureUnitsAuto","onDisplayDistance","onDisplayLines","onDisplayAreas","table","activeOlGeometry","updateTooltipsOfOlGeometry","sum","perimeter","openDialog","olDrawSource","onModifyClick","modifyControl","_olFeature","activateModifyControl","clearTooltipsOfOlGeometry","onFeatureAddedKey","updateMeasureOfOlGeometry","onFeatureRemovedKey","selectedFeatures$$","objectsExists","objectExist","hasArea$","hasLine$","drawLineControl","OlStyle","drawPolygonControl","drawControl","drawStart$$","drawChanges$$","onDrawChanges","clearMeasures","clearTooltipsOfOlSource","finalizeMeasureOfOlGeometry","measureOlGeometry","measure$","modifyStart$$","modifyEnd$$","modifyChanges$$","onModifyChanges","_measure","olMidpointsTooltips","updateOlTooltipsAtMidpoints","typeGeom","updateOlTooltip","updateOlTooltipAtCenter","updateOlGeometryCenter","centerCoordinate","showTooltipsOfOlGeometry","shouldShowTooltip","addOverlay","forEachFeature","showTooltipsOfOlSource","_unit","_type","computeTooltipInnerHTML","MeasureFormatPipe","GeometryFormFieldInputComponent","createMeasureTooltip","drawGuide","_drawControlIsActive","controlOptions","_geometryType","deactivateControl","freehandDrawIsActive","toggleControl","_freehandDrawIsActive","predefinedRadius","_predefinedRadius","_drawStyle","olGuideStyle","getGuideStyleFromDrawStyle","defaultDrawStyleRadius","overlayStyle","_overlayStyle","addGeoJSONToOverlay","olModify","features_","addOlOverlayLayer","registerOnChange","fn","registerOnTouched","onTouched","writeValue","updateDrawStyleWithDrawGuide","activeControl","activateControl","olGeometryEnds$$","onOlGeometryEnds","olGeometryChanges$$","onOlGeometryChanges","removeMeasureTooltip","updateMeasureTooltip","circleToPoint","olGeoJSON","lastIndex","lastLength","olLastMidpoint","innerHtml","guideStyle","IgoGeometryFormFieldModule","IgoGeometryModule","TimeFilterButtonComponent","timeFilterCollapse","handleDateChange","year_r21","handleYearChange","startYear_r27","endYear_r28","ctx_r34","toggleFilterState","playYear","resetFilter","ctx_r2","playFilter","ctx_r3","TimeFilterFormComponent","listYears","startListYears","endListYears","playIcon","resetIcon","YEAR","valueArray","startDate","endDate","isRange","SLIDER","getStepDefinition","timeInterval","getTimezoneOffset","is","startYear","initStartYear","endYear","initEndYear","checkFilterValue","yearChange","storeCurrentFilterValue","timeFromWms","newStartListYears","newEndListYears","setupDateOutput","applyTypeChange","handleListYearChange","handleListYearStartChange","dateToNumber","newDate","setSliderThumbLabel","thumbLabel","findThumbLabel","mySlider","childNodes","textContent","stopFilter","that","newMinDateNumber","maxDateNumber","handleSliderDateChange","handleSliderTooltip","handleSliderYearChange","handleSliderValue","getRoundedDate","toDateString","toTimeString","setSeconds","setHours","setMinutes","getDay","selectedHour","getHours","selectedMinute","getMinutes","getRangeMinDate","getRangeMaxDate","atMinute","coeff","asMilliseconds","MatSlider","toggleFiltersCollapsed","TimeFilterItemComponent","timeFilterService","filtersCollapsed","TimeFilterListComponent","WktService","wktToFeature","wkt","wktProj","featureProj","extentToWkt","epsgTO","extentProj","roundCoordinateArray","wktLine","wktMultiPoints","coordinateArray","roundArray","snrcToWkt","snrc","ew","sn","snrc250kIndex","snrc50kIndex","snrc1m","snrc250k","snrc50k","ar1m","part1m","part250k","part50k","partEW","partSN","unit1mEW","unit1mSN","unit250kEW","unit250kSN","unit50kEW","unit50kSN","index250kEW","index250kSN","index50kEW","index50kSN","increment250kEW","increment250kSN","increment50kEW","increment50kSN","unitPerTypeEW","unitPerTypeSN","ul","lr","ur","ll","clearSelectedField","updateFieldsList","changeField","changeSpatialSelector","clearProperty","updateValuesList","changeProperty","changeSNRC","changeMapExtentGeometry","OgcFilterFormComponent","wktService","ogcFilterOperator","defaultStepMillisecond","_snrc","allOgcFilterOperators","ogcFilterOperators$","igoSpatialSelectors","currentFilter","activeFilters","fields$","sFields","excludeFromOgcFilters","sfs","selectedField$","currentFilterIsSpatial","filteredFields$","_filterFields","pos","filteredValues$","_filterValues","isClearable","detectedProperty","detectProperty","refreshFilters","deleteFilter","changeLogical","changeOperator","currentFilterIsSpatial$","changeCaseSensitive","refreshFilter","changeNumericProperty","changeSNRCGeometry","isSpatial","isTemporalOperator","OgcFilterableFormComponent","refreshFunc","addFilterToSequence","changeOgcFilterType","OgcFilterableItemComponent","ogcFilterService","hasActiveSpatialFilter","filtersAreEditable","hasSelector","lastRunOgcFilter","lastLevel","firstFieldName","includedFields","datasourceOptions","firstOperatorName","defaultLogicalParent","force","af","rebuildFilter","ogcDataSource","ogcLayer","isAdvancedOgcFilters","addFilterDisabled","changeOgcFiltersAdvancedOgcFilters","OgcFilterableListComponent","OgcFilterButtonComponent","ogcFilterCollapse","currentPushButtonGroup","gr","cntPushButtons","cb","button","currentCheckboxGroup","cntCheckboxes","currentRadioButtonsGroup","cntRadioButtons","radio","currentSelectGroup","cntSelect","currentAutocompleteGroup","cntAutocomplete","filterActiveValue","OGCFilterTimeService","stepMillisecond","stepIsYearDuration","months","weeks","days","hours","stepIsMonthDuration","stepIsWeekDuration","week","stepIsDayDuration","stepIsHourDuration","stepIsMinuteDuration","addStep","toDate","subtractStep","subtract","bundle_r14","bundle_r26","emptyRadioButtons","bundle_r46","emptySelect","toggleAllSelection","selectOptionClick","bundle_r69","emptyAutocomplete","autocompleteOptionClick","bundle_r99","ctx_r113","OgcFilterSelectionComponent","domService","checkboxesIndex","radioButtonsIndex","baseIndex","selectAllSelected","filteredOgcAutocomplete","_currentFilter","ogcFiltersSelectors","ogcSelector","_j","_h","_m","_l","_k","_q","_p","_o","_u","_s","_r","_x","_w","_v","_0","_z","_y","_3","_2","_1","_6","_5","_4","currentPushButtonsGroup","pushButtonsGroup","currentCheckboxesGroup","checkboxesGroup","radioButtonsGroup","selectGroup","autocompleteGroup","selectEnabled","selectEnabled$","applyFiltersTimeout","compSelect","applyFilters","selectEnableds","selectEnableds$","autocompleteEnabled","autocompleteEnabled$","selectMulti","getPushButtonsGroups","getCheckboxesGroups","getRadioButtonsGroups","getSelectGroups","getAutocompleteGroups","getSelectEnabled","getSelectDomValues","getAutocompleteEnabled","getAutocompleteDomValues","onPushButtonsChangeGroup","onCheckboxesChangeGroup","onRadioButtonsChangeGroup","onSelectChangeGroup","onAutocompleteChangeGroup","getToolTip","toolTip","domSelectors","domValues","domSelector","filterDOM","domOptions","newBundle","sel","comp","getButtonColor","pushButton","bundleIsVertical","vertical","currentOgcSelection","markAsUntouched","deselect","newStatus","isUserInput","displayFn","currentGroups","currentGroup","isMoreResults","selectorsLength","displayMoreResults","isLessResults","displayLessResults","decls","SpatialFilterTypeComponent","spatialType","_store","selectedTypeIndex","activeDrawType","onTypeChange","onDrawTypeChange","eventQueryType","selectedQueryType","zoneChange","zoneWithBufferChange","bufferChange","SpatialFilterListComponent","spatialFilterService","queryType","_queryType","_zone","zoneWithBuffer","bufferFormControl","formValueChanges$$","bufferValueChanges$$","selectedZone","featureGeom","onZoneChange","measureUnitChange","onDrawControlChange","onfreehandControlChange","onItemTypeChange","ctx_r37","clearSearch","clearDrawZone","toggleVisibleList","entityChange","SpatialFilterItemComponent","Thematics","NestedTreeControl","node","childrens","thematics","MatTreeNestedDataSource","selectedThematics","geometryTypeField","drawGuideField","drawGuidePlaceholder","listIsVisible","geometryTypes","drawGuide$","drawStyle$","PointStyle","PolyStyle","overlayStyle$","thematicLength","_thematicLength","limits","child","value$","value$$","drawZone","drawZoneEvent","radiusChanges$$","bufferChanges$$","bufferEvent","selectedRecordStrategy","selectionStrategy","detach","selectedItemType","itemTypeChange","isPredefined","hasChild","treeControl","isExpanded","collapse","numSelected","numNodes","hasChildrenSelected","bool","selectedThematicsName","thematicChange","childrensToggle","onToggleChange","nodeSelected","freehandControl","toggleSearchButton","radiusEvent","toggleSearch","openWorkspace","createTableTemplate","clearButton","clearButtonEvent","clearSearchEvent","disableSearchButton","disabledClearSearch","formValue","typeColumn","nameColumn","modeChange","changePropertyByPass","hour_r27","minute_r31","hour_r39","minute_r43","monthSelected","OgcFilterTimeComponent","ogcFilterTimeService","_defaultMin","_defaultMax","_defaultDisplayFormat","_defaultSliderModeEnabled","sliderMode","calendarTypeYear","stepMilliseconds","beginValue","_beginValue","endValue","_endValue","sliderInterval","displayFormat","parseFilter","handleMin","handleMax","onlyYearBegin","getUTCFullYear","onlyYearEnd","isCalendarYearMode","setFilterStateDisable","updateHoursMinutesArray","updateValues","dateFilter","filterBeginFunction","filterEndFunction","intervalInt","_now","endOf","getDateFromStringWithoutTime","changeTemporalProperty","valueTmp","getDateTime","dateStringFromYearNotime","calendarType","restrictedToStep","toISOString","handleDate","yearOnlyInputChange","datePicker","yearSelected","calendarView","dateValue","monthDiff","dateValuePlus1","monthDiffPlus1","asYears","asMonths","weekDiff","weekDiffPlus1","asWeeks","dayDiff","_mod","asDays","hourDiff","asHours","valuetmp","valuetmp2","beginHourFormControl","beginMinuteFormControl","endHourFormControl","endMinuteFormControl","handleMinuteIncrement","handleHourIncrement","fullBeginHoursArray","checkEndValue","beginHours","fullEndHoursArray","endHours","fullBeginMinutesArray","beginMinutes","fullEndMinutesArray","endMinutes","beginTmp","endTmp","restrictToStep","filterStateDisable","stringDate","dateItems","minDefaultDate","maxDefaultDate","minDefaultISOString","maxDefaultISOString","filterOriginConfig","toLocaleDateString","OgcFilterTimeSliderComponent","sliderValue","calculatedStep","_defaultSliderInterval","sliderDisplayWith","beginMillisecond","maxMillisecond","calculateStep","handleSliderInput","dateTmp","toAdd","slider","_emitInputEvent","_increment","matSliderChange","dateBeginTmp","dateEndTmp","startOf","IgoFilterModule","MAT_DATE_LOCALE","MatTabsModule","MatTreeModule","MatOptionModule","MatNativeDateModule","MatDatetimepickerModule","MatNativeDatetimeModule","ExportError","ExportInvalidFileError","setPrototypeOf","ExportNothingToExportError","EncodingFormat","ExportService","aggregateInComment","ogreUrl","gpxAggregateInComment","export","encoding","exportOlFeatures","generateFeature","exportAsync","excludePrefix","ExportFormat","GPX","generateAggregatedFeature","comment","nothingToExport","ogreFormats","noOgreFallbacks","exportToFile","exportWithOgre","downloadContent","fileName","uri","setAttribute","downloadFromUri","encodingType","featuresText","UTF8","acceptCharset","enctype","LATIN1","featuresJson","encodedProperties","encode","geojsonField","outputNameField","outputName","ogreFormat","outputFormatField","submit","GML","KML","Shapefile","CSVcomma","CSVsemicolon","padTo2Digits","padStart","handleFileImportSuccess","file","confirmDialogService","styleListService","handleNothingToImportError","computeLayerTitleFromFile","first$1","dformat","getDate","addLayerAndFeaturesStyledToMap","imposedSourceOptions","imposedLayerOptions","distance","getStyleList","randomStyle","searchIndexEnabled","addLayerAndFeaturesToMap","handleInvalidFileImportError","handleUnreadbleFileImportError","handleSizeFileImportError","sizeMb","handleOgreServerImportError","getFileExtension","ImportError","ImportInvalidFileError","ImportUnreadableFileError","ImportNothingToImportError","ImportSizeError","ImportSRSError","ImportOgreServerError","ImportService","importConfig","clientSideFileSizeMax","clientSideFileSizeMaxMb","formats","allowedExtensions","formatExtensionAssociation","import","importAsync","getFileImporter","extension","zipMimeTypes","allowedZipMimeTypes","allowedMimeTypes","importFile","importFileWithOgre","importer","parseFeaturesFromFile","readAsText","FormData","append","parseFeaturesFromGeoJSON","errMsg","msg","GeoJSON","writeFeatureObject","StyleListService","styleList","baseStyleList","styleListResponse","projection_r6","inLayersIdToExportSelectionOnly","layer_r29","handleExportFormSubmit","ImportExportComponent","importService","exportService","forceNaming","controlFormat","popupChecked","selectFirstProj","_projectionsLimitations","selectedMode","loadConfig","computeProjections","importHtmlClarifications","exportHtmlClarifications","projectionsLimitations","inputProj","importForm","popupAllowed","exportableLayers$","configFileSizeMb","fileSizeMb","exportOptions$$","exportOptions$","exportOptions","computeFormats","formLayer$$","handlePopup","handlePreviousLayerSpecs","selectedLayers","formats$","loading$","previousSpecs","previousLayerSpecs$","formats$$","encodings$$","encodings$","encodings","exportableLayers$$","projections$","translateKey","projectionsConstraints","computeProjectionsConstraints","projFromConfig","nad83","wgs84","webMercator","utm","mtm","minZone","maxZone","configProjection","getWorkspaceByLayerId","wksFromLayerId","getLayerTitleById","layerHasSelectedFeatures","wksFromLayer","onlySelected","layersWithSelection","onlySelectedClick","exportOptionsChange","specs","importFiles","files","espgCodeRegex","onFileImportSuccess","onFileImportError","preCheck","p2","closed","onPopupBlockedError","geomTypesCSV","featuresCSV","filename","layerIndex","combineLayers","dSOptions","wks","featureInMapExtent","geomTypes","featureGeomType","currentGeomType","geomType","circular","gpxFeatureCnt","previousFeature","currentFeature","titleEmptyRows","createTitleEmptyRows","onFileExportError","onFileExportSuccess","titleRow","headerRow","emptyRow","previousFeatureKeys","firstKeyPrevious","currentFeatureKeys","firstKeyCurrent","previousKey","firstKeyAll","sameKeys","unset","importExportOptions","allowToStoreLayer","importWithStyle","handleFileImportError","handleSRSImportError","extraMessage","handleNothingToExportError","handleFileExportError","loadEncodings","encodingDefaultValue","appliedformats","formatsType","onlyUrl","onlyVector","vectorAndUrl","customList","validateListFormat","allowedFormats","configImportExportFormats","validatedListFormat","commonFormats","layersWithCustomFormats","previousCustomListFormats","finalFormats","modeChanged","selectMode","handleFileExportSuccess","onImportExportChange","IgoImportExportModule","IgoMapModule","MeasurerItemComponent","_auto","auto","toggleAutoUnit","measure$$","computeBestMeasureUnit","computeBestAreaUnit","converted","possibleUnits","computeBestLengthUnit","IgoMeasurerModule","IgoMeasureModule","OverlayAction","OverlayService","features$","OverlayDirective","overlayService","features$$","handleFeatures","IgoOverlayModule","jsPDFAPI","setGeoArea","pdfExt","geoExt","minx","maxx","maxy","miny","bounds","bbox_obj","internal","newAdditionalObject","bounds_obj","proj_obj","objId","title_obj","bbox_id","write","PrintOutputFormat","PrintPaperFormat","PrintOrientation","PrintResolution","PrintSaveImageFormat","PrintLegendPosition","PrintService","titleFont","titleFontStyle","subtitleFont","subtitleFontStyle","commentFont","commentFontStyle","commentFontSize","print","paperFormat","jsGeoPdfPlugin","jsPDF","doc","dimensions","margins","titleSizes","subtitleSizes","subtitle","A1","A0","fontSizeInPt","getTextPdfObjectSizeAndMarg","TEXTPDFFONT","addTextInPdfDoc","marginLeft","showProjection","showScale","addProjScale","addComment","addMap","addScale","handleMeasureLayer","addGeoRef","imgSizeAdded","legendPosition","addLegendSamePage","addLegend","saveDoc","docHeight","getHeight","pdf_extents","pdf_units2points","canvasOverlayHTMLMeasures","mapOverlayMeasuresHTML","getOverlayContainer","html2canvas","addCanvas","getLayersLegendHtml","map$1","legends","legendUrls","getLayersLegends","images$","getDataImage","dataImage","htmlImg","dataImages","getLayersLegendImage","doZipFile","canvas","useCORS","generateCanvaFileToZip","saveCanvasImageAsFile","pageWidth","setFont","textMarginLeft","textDimensions","getTextDimensions","w","h","commentMarginLeft","commentMarginBottom","textToAdd","textFont","textFontStyle","textFontSize","textMarginTop","isComment","splitTextToSize","heightPixels","textProjScale","imageSize","pourcentageReduction","imgData","addPage","toDataURL","addImage","marginsLegend","mapSize","canvasOverlayHTML","mapOverlayHTML","getOverlayContainerStopEvent","OverlayHTMLButtons","OverlayHTMLButtonsarr","OverlayHTMLButton","olCollapsed","allowTaint","addCopyrightToImage","getContext","drawImage","defineNbFileToProcess","nbFileToProcess","ms","getImageSizeToFitPdf","rect","widthPixels","canvases","getViewport","mapStatus$$","mapStatus","renderMap","downloadMapImage","oldCanvas","newCanvas","newContext","positionHCanvas","commentWidth","measureText","positionHProjScale","commentNbLine","positionHComment","fillStyle","fillRect","fillText","projectionScaleText","CommentLengthToCut","positionLastBlank","commentCurrentLine","positionFirstCutChar","addLegendToImage","fileNameWithExt","tfwFileNameWithExt","tiwContent","getWorldFileInformation","addFileToZip","saveAs","saveFileProcessing","renderSync","canvasLegend","canvasHeight","canvasWidth","legendHeight","legendWidth","legendX","legendY","strokeRect","updateSize","save","returnPromise","pageHeight","canHeight","canWidth","heightRatio","widthRatio","maxRatio","currentResolution","nameWithExt","blobFormat","toBlob","zipFile","JSZip","msSaveBlob","msToBlob","getZipFile","generateAsync","PrintFormComponent","outputFormats","paperFormats","orientations","imageFormats","legendPositions","isPrintService","maxLength","imageFormat","imageFormatField","Jpeg","onlySelf","Pdf","paperFormatField","Letter","orientationField","landscape","resolutionField","legendPositionField","none","titleField","subtitleField","commentField","showProjectionField","showScaleField","showLegendField","doZipFileField","handleFormSubmit","toggleImageSaveProp","clearValidators","changeCommentLength","A2","A3","A4","A5","PrintComponent","printService","_outputFormat","_paperFormat","_orientation","_imageFormat","_legendPosition","_resolution","IgoPrintModule","querySearchSourceFactory","IgoQueryModule","DirectionsSource","DirectionsSourceService","directionsSourceServiceFactory","DirectionsFormat","SourceDirectionsType","ProposalType","Coord","DirectionType","Stop","DirectionRelativePositionType","Start","updateStoreSorting","stopsStore","totalLength","relativePosition","Intermediate","End","addStopToStore","stops","positions","stop","maxPosition","insertPosition","stopToUpdate","computeRelativePosition","vertexStyle","stopStyle","routeStyle","formatDistance","formatDuration","formatInstruction","modifier","stepPosition","exit","lastStep","directive","cssClass","translatedDirection","bearing","translateBearing","translatedModifier","translateModifier","aggregatedDirection","coma","cntSuffix","instruction","clearStop","removeStop","onStopEnter","onStopLeave","stop_r1","setStopText","chooseProposal","DirectionsInputsComponent","invalidKeys","onMapClickEventKeys","stopIsDragged","coordRoundedDecimals","unlistenMapSingleClick","stopWithHover","getOptionText","geomCoord","pointOnFeature","validateTerm","keyIsValid","getNgClass","getPlaceholder","extra","computeStopsPosition","stopsToComputePosition","removeStopFromStore","drop","moveStops","previousIndex","currentIndex","fromIndex","moveItemInArray","onInputFocus","stopInputHasFocus","listenMapSingleClick","stopsFeatureStore","roundedCoord","olObservable","DirectionsService","directionsSourceService","directionsOptions","routeSource","sourceCanSearch","sourceCanReverseSearch","reverseSearch","sourceCanReverseSearchAsSummary","str1","str2","computeTermSimilarity","caseSensitive","termFrom","termTo","totalDiff","findDiff","delta","SearchSourceService","getSources","getEnabledSources","enableSourcesByType","SearchService","searchSourceService","termIsValid","getEnabledOnly","searchType","asPointerSummary","reverseSourceFonction","reverseSearchCoordsFormat","reverseSearchSources","resetStops","zoomRoute","copyDirectionsToClipboard","copyLinkToClipboard","DirectionsButtonsComponent","activeRoute","routesFeatureStore","clearStops","addStop","zoomToActiveRoute$","directionsBody","directionsToText","indent","activeRouteDirective","wayPointList","wayPointsCnt","stopText","localCnt","formatStep","maneuver","bearing_after","routingOptions","directionsKey","stopsCoordinates","directionsUrl","pathname","showSegment","onStepsListBlur","DirectionsResultsComponent","activeFeatureWithDirection","directions","activeDirection","changeRoute","stepFeatureStore","showRouteSegmentGeometry","vertexId","lastPoint","geojsonGeom","previousVertex","Vertex","DirectionsComponent","directionsService","searchService","routesQueries$$","focusOnStop","isTranslating","previousStops","searchs$$","initEntityStores","loadingStrategy","directionsStyle","initStopsFeatureStore","initRoutesFeatureStore","initStepFeatureStore","initOlInteraction","storeEmpty$$","storeChange$$","u","zoomRoute$$","freezeStores","selectStopInteraction","translateStop","selectedRoute","monitorEmptyEntityStore","monitorEntityStoreChange","monitorActiveRouteZoom","routeExtent","executeStopTranslation","olCondition","selectCoordinates","addedStop","onStopInputHasFocusChange","translatedStopId","translationCoordinates","translatedStop","storeInitialized$","handleStopDiff","handleStopsFeature","getRoutes","cancelSearch","simplifiedStops","stopIdToProcess","changedStop","researches","isCoord","requests$","searchProposals","sp","Text","storedSource","addStopOverlay","stopFeature","isOverview","stopsWithCoordinates","roundedCoordinates","routeResponse","overview","alternatives","continue_straight","previousRoute","routeFeatureStore","addDirectionToRoutesFeatureStore","addStopToStopsFeatureStore","stopColor","previousStop","stopFeatureStore","stopOpacity","IgoDirectionsModule","DragDropModule","searchSourceServiceFactory","IChercheSearchResultFormatter","formatResult","IgoHttpParameterCodec","encodeKey","encodeValue","decodeKey","decodeValue","IChercheSearchSource","formatter","hashtagsLieuxToKeep","getAllowedTypes","title$","ecmax","computeRequestParams","extractResults","typeSetting","typesMatched","computeOptionsParam","q","computeTerm","xMin","yMin","xMax","yMax","encoder","dataToResult","computeProperties","dataType","titleHtml","highlight","title2","title3","score","nextPage","propertiesBlacklist","googleLinksProperties","GoogleMaps","googleMaps","googleMapsNom","getGoogleMapsCoordLink","getGoogleMapsNameLink","municipalite","GoogleStreetView","getGoogleStreetViewLink","routing","keep","IChercheReverseSearchSource","getSubtitle","computeExtent","subtitleHtml","pointerSummaryTitle","defaultIChercheSearchResultFormatterFactory","ichercheReverseSearchSourceFactory","CoordinatesSearchResultFormatter","CoordinatesReverseSearchSource","reverseSearchCoordsFormatEnabled","dataDMS","rawCoord3857","convertedLonLat","igo2CoordFormat","utmZoneFromLonLat","utmName","rawCoordUtm","mtmZoneFromLonLat","long","mtmName","rawCoordMtm","rawCoord","numericEpsgCode","lonLatConversion","roundedCoordString","roundedCoordStringDMS","circleGeometry","polygonGeometry","writer","writeGeometry","OpenStreetMap","getOpenStreetMapLink","defaultCoordinatesSearchResultFormatterFactory","CoordinatesReverseSearchSourceFactory","_projectionService","ILayerSearchResultFormatter","allowedKey","dataR","ILayerSearchSource","computeSearchRequestParams","computeLayerOptions","groupTitle","extractQueryParamsFromSourceUrl","formatOpt","urls","urlOpt","ilayerSearchResultFormatterFactory","ilayerSearchSourceFactory","SEARCH_TYPES","SearchSelectorComponent","searchTypes","setSearchType","searchType$","searchType$$","onSetSearchType","onSearchTypeChange","getSearchTypeTitle","searchTypeChange","IgoSearchSelectorModule","checkUncheckAllSources","checkUncheckAll","setting_r13","changePointerReverseSearch","SearchSettingsComponent","hasPointerReverseSearchSource","searchSourcesAllEnabled","now","displayBlock","pointerSummaryEnabled","searchResultsGeometryEnabled","pointerSummaryStatus","hasReverseSearchSourcesForPointerSummary","getSearchSources","textSearchSources","computeSourcesCheckAllBehavior","settingsValueCheckedCheckbox","settingValue","searchSourceChange","computeSettingCheckAllBehavior","allEnabled","enabledSourcesCnt","disabledSourcesCnt","settingsValueCheckedRadioButton","onCheckSearchSource","storage","getAvailableValues","getAvailableHashtagsValues","changeSearchResultsGeometry","searchResultsGeometryStatus","reverseSearchCoordsFormatStatus","IgoSearchSettingsModule","onClearButtonClick","SearchBarComponent","showSearchButton","_reverseSearchCoordsFormatEnabled","appearance","termSplitter","minLength","searchSelector","searchSettings","setTerm","stream$$","stream$","onSetTerm","handlePlaceholder","configValue","onKeyup","clearFeature","onSearchSettingsChange","doSearch","searchSettingsChange","reverseCoordEvent","slug","searchTermChange","ss","placeholder$","rawTerm","terms","researches$$","research","onResearchCompleted","newResults","IgoSearchBarModule","onZoomHandler","SearchResultsItemComponent","withZoomButton","getEntityTitleHtml","titleHtmlProperty","tooltipHtml","hideBtn","showBtn","group_r4","resultFocus","resultUnfocus","Grouped","SearchResultMode","SearchResultsComponent","showResultsCount","searchResultMode","pageIterator","tabsMode","_term","results$","_results$","liftResults","settingsChange$$","settingsChange$","computeGroupTitle","onResultSelect","resultSelect","groupResults","sortByOrder","r1","r2","grouped","sourceResults","stategy","moreResults","layer_r2","SaveFeatureDialogComponent","filteredLayers$","addFeatureToLayer","SearchResultAddButtonComponent","layersSubcriptions","saveSearchResultInLayer","mediaService$$","currEvent","Stroke","Fill","take$1","searchLayer","IgoSearchResultsModule","SearchPointerSummaryDirective","reverseSearch$$","searchPointerSummaryFeatureId","igoSearchPointerSummaryDelay","igoSearchPointerSummaryEnabled","pointerPositionSummaryMarkerStyle","ngAfterContentChecked","unsubscribeReverseSearch","pointerSearchStore","entitiesToPointerOverlay","computeSummaryClosestFeature","closestResultByType","summarizedClosestType","processedSummarizedClosestType","typeIndex","addPointerOverlay","onSearchCoordinate","_results","onSearch","pointerSummary","IgoSearchModule","OgcFilterComponent","OgcFilterWidget","ogcFilterWidgetFactory","IgoOgcFilterModule","getCommonVectorSelectedStyle","markerOpacity","fillOpacity","strokeOpacity","getCommonVectorStyle","isOlFeature","markerColorAsArray","markerColorRGB","WfsWorkspace","getLayerWksOptionTabQuery","queryOptions","tabQuery","getLayerWksOptionMapQuery","mapQueryOnOpenTab","getInResolutionRange","WfsWorkspaceService","zoomAuto","createWorkspace","srcId","workspaceId","createFeatureStore","inMapExtentStrategy","inMapResolutionStrategy","confQueryOverlayStyle","createFilterInMapExtentOrResolutionStrategy","relations","columnsFromFeatures","col","relationsColumn","relation","ws$","class_icon","WmsWorkspaceService","wmsLinkId","wfsLinkId","linkProperties","hasOgcFilters","clonedLinks","wksLayerOption","workspaceLayer","ConfirmationPopupComponent","cancelAction","confirmedAction","EditionWorkspace","editionWorkspaceService","edit","deleteFeature","deleteUrl","columnName","primary","editFeature","editionOpt","getDomainValues","original_properties","original_geometry","idkey","editFeaturefilterClauseFunc","adding$","newFeaturefilterClauseFunc","addWithDraw","featureOl","createModifyInteraction","olCollection","Collection","modifyStyle","EditionWorkspaceService","wksConfig","rendererType","modifyButton","deleteButton","saveFeature","cancelEdit","cellClass","validateFeature","sanitizeParameter","addUrl","addHeaders","modifyProtocol","modifyUrl","protocole","modifyHeaders","modifyFeature","hasGeometry","projDest","geomDatabaseProj","wktFormat","geoJsonFormat","refreshMap","rowsInMapExtentCheckCondition$","removeZ","relationLayers","relationLayers$","fromSave","wfsOlLayer","wmsOlLayer","_t","FeatureWorkspace","FeatureWorkspaceService","searchStrategy","WorkspaceSelectorDirective","wfsWorkspaceService","wmsWorkspaceService","featureWorkspaceService","workspaceStore","onLayersChange","changeWorkspace","adding","rowsInMapExtentCheckCondition","editableLayers","layerIsEditable","editableLayersIds","workspacesToAdd","getOrCreateWorkspace","workspacesToRemove","wmsWks","IgoWorkspaceUpdatorModule","IgoConfirmationPopupModule","IgoGeoWorkspaceModule","STYLELIST_OPTIONS","provideStyleListOptions","IgoStyleListModule","styleListFactory","IgoStyleModule","StopsStore","StopsFeatureStore","RoutesFeatureStore","StepFeatureStore","OsrmDirectionsSource","_name","directionsParams","getRouteParams","extractRoutesData","formatRoute","waypoints","geometries","roadNetworkRoute","stepsUI","legs","sourceType","weight_name","CadastreSearchSource","endsWith","numero","lot","computeGeometry","NoLot","cadastreSearchSourceFactory","NominatimSearchSource","place_id","display_name","osm_type","boundingbox","computeTermTags","tag","computeTermSettings","nominatimSearchSourceFactory","StoredQueriesSearchSource","storedQueriesOptions","defaultResultTitle","storedquery_id","splitPrefix","outputformat","srsname","resultTitle","multipleFieldsQuery","storedqueriesParams","resultArray","extractWFSData","idxEnd","resultTotLenght","patternGml3","geojson","wfsfeatures","splittedTerm","remainingTerm","splitterRegex","wfsversion","StoredQueriesReverseSearchSource","longField","latField","longLatParams","doc_type","storedqueriesSearchSourceFactory","storedqueriesReverseSearchSourceFactory","WorkspaceSearchSource","limitValue","fswi","termToUse","gettedIndex","sortedResultToProcess","resultsCnt","subtitleHtml2","workspaceSearchSourceFactory","mapExtentStrategyActiveToolTip","noElementSelected","AppSimpleMapRoutingModule","AppSimpleMapComponent","onPointerMove","pointerCoord","AppSimpleMapModule","AppLayerRoutingModule","AppLayerComponent","AppLayerModule","AppLegendRoutingModule","AppLegendComponent","AppLegendModule","AppOverlayRoutingModule","AppOverlayComponent","AppOverlayModule","AppGeometryRoutingModule","AppGeometryComponent","olstyle","AppGeometryModule","AppFeatureRoutingModule","AppFeatureComponent","AppFeatureModule","AppHoverRoutingModule","AppHoverComponent","AppHoverModule","AppMeasureRoutingModule","AppMeasureComponent","AppMeasureModule","AppDrawRoutingModule","AppDrawComponent","AppDrawModule","AppQueryRoutingModule","AppQueryComponent","feature1","olLineString","feature2","feature3","handleQueryResults","AppQueryModule","AppCatalogRoutingModule","AppCatalogComponent","catalogStore","onCatalogSelectChange","catalogItemStore","AppCatalogModule","TypePermission","ContextService","contexts$","ours","importedContext","mapViewFromRoute","basePath","contextListFile","defaultContextUri","readParamsFromRoute","handleContextsChange","loadContexts","_defaultContextUri","permissions","getById","getDetails","getDefault","defaultContextId$","getContextByUri","getProfilByUser","setDefault","defaultContextId","hideContext","showContext","imported","contexts","contextCreated","permission","contextCloned","addToolAssociation","contextId","toolId","deleteToolAssociation","getPermissions","addPermissionAssociation","profil","typePermission","deletePermissionAssociation","permissionId","getLocalContexts","getLocalContext","urlBase","resBase","resMerge","l2","t2","err2","loadDefaultContext","loadFct","direct","_context","addContextToList","setContext","loadContext","contextParam","context$","handleContextMessage","currentContext","keepCurrentView","loadEditedContext","setEditedContext","editedContext$","getContextFromMap","global","getContextFromLayers","extraFeatures","currentLayers","layerFound","contextLayer","olVectorSource","Cluster","cleanedOlFeatures","catalogLayer","contextToLoad","getContextLayers","mapLayers","permissionError","titleContext","keepCurrentContext","editedContext","findContext","toolsChanged$","editedFound","contextSimplifie","public","found","IgoContextImportExportModule","MapContextDirective","contextService","context$$","handleContextChange","viewContext","controlsContext","scaleLineOption","minWidth","LayerContextDirective","contextLayers","removeLayersOnContextChange","queryParams$$","layersAndIndex$","handleAddLayers","addImportedFeaturesStyledToMap","addImportedFeaturesToMap","computeLayerVisibilityFromUrl","currentLayerid","contextParams","visibleOnLayersParams","visibleOffLayersParams","visiblelayers","invisiblelayers","ContextListControlsEnum","BookmarkDialogComponent","favoriteClick","managePermissions","ContextItemComponent","showFavorite","canShare","favorite","clearFilter","manageTools","ContextListComponent","contextsInitial","shared","showHidden","thresholdToFilter","_contexts","selectedContext","_selectedContext","_defaultContextId","sortedAlpha","filterContextsList","createContext","sortContextsList","updateContexts","publics","showFilter","showContextFilter","contextsList","toggleSort","getPermission","userSelection","indeterminate","childs","parentPermission","childrenPermission","filterPermissionsChanged","ContextListBindingDirective","onEdit","onSave","contextFromMap","msgSuccess","onFavorite","onManageTools","onManagePermissions","onDelete","onClone","onCreate","showHiddenContexts","onShowContext","onHideContext","contexts$$","defaultContextId$$","storedContextUri","selectedContext$$","authenticate","users","profilsAcc","cur","PoiService","IgoContextMapButtonModule","IgoContextManagerModule","ImportExportType","ImportExportMode","ImportExportState","importExportType$","selectedMode$","setImportExportType","setMode","setsExportOptions","ToolState","importExportState","toolToActivateFromOptions","toolToActivate","openSidenav$","MapState","_legendToolShowAll","StorageState","igoStorageService","FeatureActionsService","storageState","toolState","storageChange$$","loadActions","selectOnlyCheckCondition$","buildActions","zoomAuto$","storageChange","handleZoomAuto","filterStrategy","maximize$","WfsActionsService","ogcFilterWidget","EditionActionsService","WorkspaceState","featureActionsService","wfsActionsService","editionActionsService","workspacePanelExpanded","actionMaximize$$","initWorkspaces","workspaceSelection","workspace$","workspaceSelection$","maximized","setWorkspaceIsMaximized","activeWorkspace$$","activeWorkspaceWidget$$","activeWorkspaceWidget$","rowsInMapExtentCheckCondition$$","rowsInMapExtent","selectOnlyCheckCondition$$","selectOnly","workspaceMaximize$","setActiveWorkspaceById","wksFromId","setActiveWorkspaceByTitle","wksFromTitle","teardownWorkspaces","SearchState","workspaceState","mapState","searchLayerStores","searchOverlayStyle","searchOverlayStyleSelection","searchOverlayStyleFocus","searchResultsGeometryEnabled$","createCustomFilterTermStrategy","wksSource","searchableWks","monitorLayerDeletion","activateCustomFilterTermStrategy","deactivateCustomFilterTermStrategy","enableSearch","searchDisabled$","disableSearch","setSearchTerm","searchTerm","searchTerm$","setSearchSettingsChange","searchSettingsChange$","setSelectedResult","selectedResult$","setSearchResultsGeometryStatus","IgoAppSearchBarModule","IgoAppSearchResultsToolModule","IgoAppSearchModule","AppSearchRoutingModule","AppSearchComponent","searchState","osmLayer","igoReverseSearchCoordsFormatEnabled","searchStore","onPointerSummaryStatusChange","onSearchTermChange","onReverseCoordsFormatStatusChange","onResultFocus","tryAddFeatureToMap","searchCoordinate","openGoogleMaps","openGoogleStreetView","removeFeatureFromMap","onContextMenuOpen","mapPosition","getCoordinateFromPixel","contextmenuPoint","mapBrowser","getBoundingClientRect","scrollY","scrollX","ElementRef","AppSearchModule","ichercheSearchSourceFactory","AppPrintRoutingModule","AppPrintComponent","AppPrintModule","AppImportExportRoutingModule","AppImportExportComponent","AppImportExport","AppDirectionsRoutingModule","AppDirectionsComponent","AppDirectionsModule","osrmDirectionsSourcesFactory","AppTimeFilterRoutingModule","AppTimeFilterComponent","AppTimeFilterModule","AppOgcFilterRoutingModule","AppOgcFilterComponent","AppOgcFilterModule","AppSpatialFilterRoutingModule","AppSpatialFilterComponent","olFormatGeoJSON","getOutputType","getOutputQueryType","spatialListStore","getOutputToggleSearch","loadThematics","getOutputClearSearch","clearMap","activeLayers","iterator","zeroResults","tryAddFeaturesToMap","featuresPoint","featuresLinePoly","idPoint","idLinePoly","tryAddPointToMap","tryAddLayerToMap","zoomToFeatureExtent","_internal","featuresOl","createSvgIcon","pushLayer","xmlSerializer","AppSpatialFilterModule","AppWorkspaceRoutingModule","AppWorkspaceComponent","selectedWorkspace$","workspacePaginator","AppWorkspaceModule","AppContextRoutingModule","AppContextComponent","AppContextModule","HttpClientJsonpModule","redirectTo","pathMatch","AppRoutingModule","useHash","AppComponent","changeDetectorRef","mobileQuery","matchMedia","_mobileQueryListener","themeClass","detectOldBrowser","removeEventListener","defaultTooltipOptions","showDelay","hideDelay","touchendHideDelay","disableTooltipInteractivity","AppModule","bootstrap","appInitializerFactory","ApplicationRef","MAT_TOOLTIP_DEFAULT_OPTIONS","MatSidenavModule","MatToolbarModule","HammerModule","applicationRef","isStable","setTranslation","enableProdMode","__NgCli_bootstrap_1","bootstrapModule","webpackContext","module"],"sourceRoot":"webpack:///","sources":["./packages/utils/src/lib/base64.ts","./packages/utils/src/lib/user-agent.ts","./packages/utils/src/lib/clipboard.ts","./packages/utils/src/lib/string-utils.ts","./packages/utils/src/lib/change.interface.ts","./packages/utils/src/lib/change.ts","./packages/utils/src/lib/object-utils.ts","./packages/utils/src/lib/number-utils.ts","./packages/utils/src/lib/strenum.ts","./packages/utils/src/lib/uuid.ts","./packages/utils/src/lib/watcher.ts","./packages/core/src/lib/activity/activity.service.ts","./packages/core/src/lib/activity/activity.interceptor.ts","./packages/core/src/lib/activity/activity.module.ts","./packages/core/src/lib/config/version.ts","./packages/core/src/lib/config/config.service.ts","./packages/core/src/lib/config/config.provider.ts","./packages/core/src/lib/config/config.module.ts","./packages/core/src/lib/language/shared/language.loader.ts","./packages/core/src/lib/language/shared/language.provider.ts","./packages/core/src/lib/language/shared/missing-translation.guard.ts","./packages/core/src/lib/language/language.module.ts","./packages/core/src/lib/message/message.module.ts","./packages/core/src/lib/message/shared/message.enum.ts","./packages/core/src/lib/language/shared/language.service.ts","./packages/core/src/lib/message/shared/message.service.ts","./packages/core/src/lib/request/error.interceptor.ts","./packages/core/src/lib/request/error.module.ts","./packages/core/src/lib/core.module.ts","./packages/core/src/lib/route/route.service.ts","./packages/core/src/lib/media/media.enum.ts","./packages/core/src/lib/media/media.service.ts","./packages/core/src/lib/storage/storage.interface.ts","./packages/core/src/lib/storage/storage.service.ts","./packages/core/src/lib/compression/compression.service.ts","./packages/core/src/lib/network/network.service.ts","./packages/common/src/lib/entity/shared/entity.enums.ts","./packages/common/src/lib/entity/shared/entity.utils.ts","./packages/common/src/lib/entity/shared/state.ts","./packages/common/src/lib/entity/shared/view.ts","./packages/common/src/lib/entity/shared/store.ts","./packages/common/src/lib/entity/shared/watcher.ts","./packages/common/src/lib/entity/shared/strategies/strategy.ts","./packages/common/src/lib/entity/shared/strategies/filter-custom-function.ts","./packages/common/src/lib/entity/shared/strategies/filter-selection.ts","./packages/common/src/lib/entity/entity-selector/entity-selector.component.html","./packages/common/src/lib/entity/entity-selector/entity-selector.component.ts","./packages/common/src/lib/stop-propagation/stop-propagation.directive.ts","./packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.ts","./packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.html","./packages/common/src/lib/image/image-error.directive.ts","./packages/common/src/lib/entity/entity-table/entity-table-row.directive.ts","./packages/common/src/lib/custom-html/custom-html.pipe.ts","./packages/common/src/lib/image/secure-image.pipe.ts","./packages/common/src/lib/entity/entity-table/entity-table.component.html","./packages/common/src/lib/entity/entity-table/entity-table.component.ts","./packages/common/src/lib/action/shared/action.enums.ts","./packages/common/src/lib/action/actionbar/actionbar-item.component.html","./packages/common/src/lib/action/actionbar/actionbar-item.component.ts","./packages/common/src/lib/action/actionbar/actionbar.component.html","./packages/common/src/lib/action/actionbar/actionbar.component.ts","./packages/common/src/lib/action/actionbar/actionbar.module.ts","./packages/common/src/lib/action/action.module.ts","./packages/common/src/lib/badge-icon/badge-icon.directive.ts","./packages/common/src/lib/badge-icon/badge-icon.module.ts","./packages/common/src/lib/clickout/clickout.directive.ts","./packages/common/src/lib/clickout/clickout.module.ts","./packages/common/src/lib/collapsible/collapse.directive.ts","./packages/common/src/lib/collapsible/collapsible.component.ts","./packages/common/src/lib/collapsible/collapsible.component.html","./packages/common/src/lib/collapsible/collapsible.module.ts","./packages/common/src/lib/confirm-dialog/confirm-dialog.component.ts","./packages/common/src/lib/confirm-dialog/confirm-dialog.component.html","./packages/common/src/lib/confirm-dialog/confirm-dialog.service.ts","./packages/common/src/lib/confirm-dialog/confirm-dialog.module.ts","./packages/common/src/lib/context-menu/context-menu.directive.ts","./packages/common/src/lib/context-menu/long-press.directive.ts","./packages/common/src/lib/context-menu/context-menu.module.ts","./packages/common/src/lib/custom-html/custom-html.component.ts","./packages/common/src/lib/custom-html/custom-html.component.html","./packages/common/src/lib/custom-html/custom-html.module.ts","./packages/common/src/lib/dom/dom.service.ts","./packages/common/src/lib/dom/dom.module.ts","./packages/common/src/lib/drag-drop/drag-drop.module.ts","./packages/common/src/lib/dynamic-component/shared/dynamic-component.ts","./packages/common/src/lib/dynamic-component/shared/dynamic-component.service.ts","./packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.ts","./packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.html","./packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.module.ts","./packages/common/src/lib/dynamic-component/dynamic-component.module.ts","./packages/common/src/lib/flexible/flexible.module.ts","./packages/common/src/lib/form/form/form.component.ts","./packages/common/src/lib/form/shared/form.utils.ts","./packages/common/src/lib/form/form/form.component.html","./packages/common/src/lib/form/form/form.module.ts","./packages/common/src/lib/form/shared/form.service.ts","./packages/common/src/lib/form/shared/form-field.service.ts","./packages/common/src/lib/form/form-field/form-field.component.html","./packages/common/src/lib/form/form-field/form-field.component.ts","./packages/common/src/lib/form/form-field/form-field.module.ts","./packages/common/src/lib/form/form-group/form-group.component.html","./packages/common/src/lib/form/form-group/form-group.component.ts","./packages/common/src/lib/form/form-group/form-group.module.ts","./packages/common/src/lib/form/form.module.ts","./packages/common/src/lib/entity/entity-selector/entity-selector.module.ts","./packages/common/src/lib/stop-propagation/stop-propagation.module.ts","./packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.module.ts","./packages/common/src/lib/image/image.module.ts","./packages/common/src/lib/entity/entity-table/entity-table.module.ts","./packages/common/src/lib/entity/entity.module.ts","./packages/common/src/lib/interactive-tour/interactive-tour.loader.ts","./packages/common/src/lib/interactive-tour/interactive-tour.service.ts","./packages/common/src/lib/tool/shared/toolbox.ts","./packages/common/src/lib/tool/shared/tool.service.ts","./packages/common/src/lib/interactive-tour/interactive-tour.component.html","./packages/common/src/lib/interactive-tour/interactive-tour.component.ts","./packages/common/src/lib/interactive-tour/interactive-tour.module.ts","./packages/common/src/lib/keyvalue/keyvalue.pipe.ts","./packages/common/src/lib/keyvalue/keyvalue.module.ts","./packages/common/src/lib/list/list-item.directive.ts","./packages/common/src/lib/list/list.component.ts","./packages/common/src/lib/list/list.component.html","./packages/common/src/lib/list/list.module.ts","./packages/common/src/lib/panel/panel.component.html","./packages/common/src/lib/panel/panel.component.ts","./packages/common/src/lib/panel/panel.module.ts","./packages/common/src/lib/spinner/spinner.component.ts","./packages/common/src/lib/spinner/spinner.component.html","./packages/common/src/lib/spinner/spinner-activity.directive.ts","./packages/common/src/lib/spinner/spinner.module.ts","./packages/common/src/lib/table/table-datasource.ts","./packages/common/src/lib/table/table-action-color.enum.ts","./packages/common/src/lib/table/table.component.html","./packages/common/src/lib/table/table.component.ts","./packages/common/src/lib/table/table.module.ts","./packages/common/src/lib/action/shared/store.ts","./packages/common/src/lib/tool/shared/toolbox.enums.ts","./packages/common/src/lib/tool/toolbox/toolbox.animation.ts","./packages/common/src/lib/tool/toolbox/toolbox.component.html","./packages/common/src/lib/tool/toolbox/toolbox.component.ts","./packages/common/src/lib/tool/toolbox/toolbox.module.ts","./packages/common/src/lib/tool/tool.module.ts","./packages/common/src/lib/widget/widget-outlet/widget-outlet.component.html","./packages/common/src/lib/widget/widget-outlet/widget-outlet.component.ts","./packages/common/src/lib/widget/widget-outlet/widget-outlet.module.ts","./packages/common/src/lib/widget/shared/widget.service.ts","./packages/common/src/lib/widget/widget.module.ts","./packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.ts","./packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.html","./packages/common/src/lib/workspace/workspace-selector/workspace-selector.module.ts","./packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.html","./packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.ts","./packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.module.ts","./packages/common/src/lib/workspace/workspace.module.ts","./packages/common/src/lib/table/table-database.ts","./packages/common/src/lib/tool/shared/tool-component.ts","./packages/common/src/lib/workspace/shared/store.ts","./packages/common/src/lib/workspace/shared/workspace.ts","./demo/src/app/core/home/home-routing.module.ts","./demo/src/app/core/home/home.component.ts","./demo/src/app/core/home/home.component.html","./demo/src/app/core/home/home.module.ts","./demo/src/app/core/activity/activity-routing.module.ts","./demo/src/app/core/activity/activity.component.ts","./demo/src/app/core/activity/activity.component.html","./demo/src/app/core/activity/activity.module.ts","./demo/src/environments/environment.prod.ts","./demo/src/app/core/config/config-routing.module.ts","./demo/src/app/core/config/config.component.ts","./demo/src/app/core/config/config.component.html","./demo/src/app/core/config/config.module.ts","./demo/src/app/core/language/language-routing.module.ts","./demo/src/app/core/language/language.component.ts","./demo/src/app/core/language/language.component.html","./demo/src/app/core/language/language.module.ts","./demo/src/app/core/media/media-routing.module.ts","./demo/src/app/core/media/media.component.ts","./demo/src/app/core/media/media.component.html","./demo/src/app/core/media/media.module.ts","./demo/src/app/core/message/message-routing.module.ts","./demo/src/app/core/message/message.component.ts","./demo/src/app/core/message/message.component.html","./demo/src/app/core/message/message.module.ts","./demo/src/app/core/request/request-routing.module.ts","./demo/src/app/core/request/request.component.ts","./demo/src/app/core/request/request.component.html","./demo/src/app/core/request/request.module.ts","./demo/src/app/common/action/action.component.html","./demo/src/app/common/action/action-routing.module.ts","./demo/src/app/common/action/action.component.ts","./demo/src/app/common/action/action.module.ts","./demo/src/app/common/dynamic-component/dynamic-component.component.ts","./demo/src/app/common/dynamic-component/dynamic-component-routing.module.ts","./demo/src/app/common/dynamic-component/dynamic-component.component.html","./demo/src/app/common/dynamic-component/dynamic-component.module.ts","./demo/src/app/common/entity-table/entity-table-routing.module.ts","./demo/src/app/common/entity-table/entity-table.component.ts","./demo/src/app/common/entity-table/entity-table.component.html","./demo/src/app/common/entity-table/entity-table.module.ts","./demo/src/app/common/entity-selector/entity-selector.component.html","./demo/src/app/common/entity-selector/entity-selector-routing.module.ts","./demo/src/app/common/entity-selector/entity-selector.component.ts","./demo/src/app/common/entity-selector/entity-selector.module.ts","./demo/src/app/common/form/form.component.html","./demo/src/app/common/form/form-routing.module.ts","./demo/src/app/common/form/form.component.ts","./demo/src/app/common/form/form.module.ts","./demo/src/app/common/table/table-routing.module.ts","./demo/src/app/common/table/table.component.ts","./demo/src/app/common/table/table.component.html","./demo/src/app/common/table/table.module.ts","./demo/src/app/common/tool/tool.component.html","./demo/src/app/common/tool/tool.component.ts","./demo/src/app/common/tool/tool-routing.module.ts","./demo/src/app/common/tool/tool.module.ts","./demo/src/app/common/widget/widget.component.ts","./demo/src/app/common/widget/widget-routing.module.ts","./demo/src/app/common/widget/widget.component.html","./demo/src/app/common/widget/widget.module.ts","./packages/auth/src/lib/shared/token.service.ts","./packages/auth/src/lib/shared/auth.service.ts","./packages/auth/src/lib/auth-form/auth-google.component.ts","./packages/auth/src/lib/auth-form/auth-google.component.html","./packages/auth/src/lib/auth-form/auth-intern.component.html","./packages/auth/src/lib/auth-form/auth-intern.component.ts","./packages/auth/src/lib/auth-form/auth-facebook.component.ts","./packages/auth/src/lib/auth-form/auth-facebook.component.html","./packages/auth/src/lib/auth-form/auth-microsoft.component.ts","./packages/auth/src/lib/auth-form/auth-microsoft.component.html","./packages/auth/src/lib/shared/auth-msalServiceb2c.service..ts","./packages/auth/src/lib/shared/auth-msalBroadcastServiceb2c.service.ts","./packages/auth/src/lib/auth-form/auth-microsoftb2c.component.ts","./packages/auth/src/lib/auth-form/auth-microsoftb2c.component.html","./packages/auth/src/lib/auth-form/auth-form.component.html","./packages/auth/src/lib/auth-form/auth-form.component.ts","./packages/auth/src/lib/shared/auth.interceptor.ts","./packages/auth/src/lib/shared/auth-microsoft.provider.ts","./packages/auth/src/lib/shared/storage.service.ts","./packages/auth/src/lib/auth.module.ts","./demo/src/app/auth/auth-form/auth-form-routing.module.ts","./demo/src/app/auth/auth-form/auth-form.component.ts","./demo/src/app/auth/auth-form/auth-form.component.html","./demo/src/app/auth/auth-form/auth-form.module.ts","./packages/geo/src/lib/metadata/shared/metadata.service.ts","./packages/geo/src/lib/metadata/metadata-button/metadata-button.component.html","./packages/geo/src/lib/metadata/metadata-button/metadata-abstract.component.html","./packages/geo/src/lib/metadata/metadata-button/metadata-button.component.ts","./packages/geo/src/lib/metadata/metadata.module.ts","./packages/geo/src/lib/map/shared/map.utils.ts","./packages/geo/src/lib/layer/shared/layers/layer.ts","./packages/geo/src/lib/layer/shared/layers/layer.interface.ts","./packages/geo/src/lib/layer/utils/image-watcher.ts","./packages/geo/src/lib/layer/utils/layer.utils.ts","./packages/geo/src/lib/layer/utils/tile-watcher.ts","./packages/geo/src/lib/utils/id-generator.ts","./packages/geo/src/lib/datasource/shared/datasources/datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/feature-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/cluster-datasource.ts","./packages/geo/src/lib/layer/utils/vector-watcher.ts","./packages/geo/src/lib/layer/shared/layers/image-layer.ts","./packages/geo/src/lib/layer/shared/layers/tile-layer.ts","./packages/geo/src/lib/filter/shared/ogc-filter.enum.ts","./packages/geo/src/lib/filter/shared/ogc-filter.ts","./packages/geo/src/lib/datasource/shared/datasources/wms-wfs.utils.ts","./packages/geo/src/lib/offline/geoDB/geoDB.enums.ts","./packages/geo/src/lib/layer/shared/layers/vector-layer.ts","./packages/geo/src/lib/style/shared/vector/conversion.utils.ts","./packages/geo/src/lib/layer/shared/layers/vectortile-layer.ts","./packages/geo/src/lib/feature/shared/feature.enums.ts","./packages/geo/src/lib/datasource/shared/datasources/osm-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/xyz-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/wfs-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/wfs.service.ts","./packages/geo/src/lib/datasource/shared/datasources/data.service.ts","./packages/geo/src/lib/query/shared/query.enums.ts","./packages/geo/src/lib/datasource/shared/datasources/wms-datasource.ts","./packages/geo/src/lib/datasource/utils/tilegrid.ts","./packages/geo/src/lib/datasource/shared/datasources/wmts-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/carto-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/arcgisrest-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/imagearcgisrest-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/tilearcgisrest-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/tiledebug-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/websocket-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/mvt-datasource.ts","./packages/geo/src/lib/style/shared/datasource/esri-style-generator.ts","./packages/geo/src/lib/filter/shared/time-filter.enum.ts","./packages/geo/src/lib/map/shared/map.service.ts","./packages/geo/src/lib/datasource/shared/capabilities.service.ts","./packages/geo/src/lib/datasource/shared/options/options.service.ts","./packages/geo/src/lib/map/shared/projection.service.ts","./packages/geo/src/lib/datasource/shared/datasource.service.ts","./packages/geo/src/lib/feature/shared/feature.utils.ts","./packages/geo/src/lib/feature/shared/store.ts","./packages/geo/src/lib/feature/shared/strategies/in-map-extent.ts","./packages/geo/src/lib/feature/shared/strategies/in-map-resolution.ts","./packages/geo/src/lib/feature/shared/strategies/loading.ts","./packages/geo/src/lib/feature/shared/strategies/loading-layer.ts","./packages/geo/src/lib/feature/shared/strategies/selection.ts","./packages/geo/src/lib/feature/shared/strategies/search.ts","./packages/geo/src/lib/feature/shared/strategies.utils.ts","./packages/geo/src/lib/style/shared/overlay/overlay-marker-style.utils.ts","./packages/geo/src/lib/style/style-service/style.service.ts","./packages/geo/src/lib/style/shared/overlay/overlay-style.utils.ts","./packages/geo/src/lib/overlay/shared/overlay.ts","./packages/geo/src/lib/overlay/shared/overlay.utils.ts","./packages/geo/src/lib/map/utils/layer-watcher.ts","./packages/geo/src/lib/map/shared/map.enums.ts","./packages/geo/src/lib/map/shared/controllers/controller.ts","./packages/geo/src/lib/map/shared/controllers/view.ts","./packages/geo/src/lib/map/shared/controllers/geolocation.ts","./packages/geo/src/lib/map/shared/linkedLayers.utils.ts","./packages/geo/src/lib/map/shared/map.ts","./packages/geo/src/lib/map/map-browser/map-browser.component.ts","./packages/geo/src/lib/map/map-browser/map-browser.component.html","./packages/geo/src/lib/map/shared/map-pointer-position.directive.ts","./packages/geo/src/lib/style/shared/feature/feature-style.ts","./packages/geo/src/lib/map/shared/hover-feature.directive.ts","./packages/geo/src/lib/map/zoom-button/zoom-button.component.ts","./packages/geo/src/lib/map/zoom-button/zoom-button.component.html","./packages/geo/src/lib/map/geolocate-button/geolocate-button.component.html","./packages/geo/src/lib/map/geolocate-button/geolocate-button.component.ts","./packages/geo/src/lib/map/home-extent-button/home-extent-button.component.ts","./packages/geo/src/lib/map/home-extent-button/home-extent-button.component.html","./packages/geo/src/lib/map/wake-lock-button/wake-lock-button.component.ts","./packages/geo/src/lib/map/wake-lock-button/wake-lock-button.component.html","./packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.html","./packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.ts","./packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.animation.ts","./packages/geo/src/lib/offline/geoDB/geoDB.service.ts","./packages/geo/src/lib/offline/shared/geo-network.service.ts","./packages/geo/src/lib/offline/layerDB/layerDB.service.ts","./packages/geo/src/lib/layer/shared/layer.service.ts","./packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.html","./packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.ts","./packages/geo/src/lib/map/rotation-button/rotation-button.component.html","./packages/geo/src/lib/map/rotation-button/rotation-button.component.ts","./packages/geo/src/lib/map/info-section/info-section.component.html","./packages/geo/src/lib/map/info-section/info-section.component.ts","./packages/geo/src/lib/catalog/shared/catalog.enum.ts","./packages/geo/src/lib/catalog/shared/catalog.abstract.ts","./packages/geo/src/lib/query/shared/query.service.ts","./packages/geo/src/lib/query/shared/query.utils.ts","./packages/geo/src/lib/query/shared/query.directive.ts","./packages/geo/src/lib/search/shared/sources/source.ts","./packages/geo/src/lib/query/shared/query-search-source.ts","./packages/geo/src/lib/utils/googleLinks.ts","./packages/geo/src/lib/utils/osmLinks.ts","./packages/geo/src/lib/catalog/shared/catalog.service.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.html","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.ts","./packages/geo/src/lib/layer/layer-legend/layer-legend.component.html","./packages/geo/src/lib/layer/layer-legend/layer-legend.component.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.html","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.html","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.ts","./packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.service.ts","./packages/geo/src/lib/layer/layer-item/layer-item.component.html","./packages/geo/src/lib/layer/layer-item/layer-item.component.ts","./packages/geo/src/lib/layer/layer-list/layer-list.enum.ts","./packages/geo/src/lib/layer/layer-list/layer-list.component.html","./packages/geo/src/lib/layer/layer-list/layer-list.component.ts","./packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.html","./packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.ts","./packages/geo/src/lib/layer/layer-list/layer-list-binding.directive.ts","./packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.html","./packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.ts","./packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.html","./packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.ts","./packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.ts","./packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.html","./packages/geo/src/lib/layer/layer.module.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser.module.ts","./packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.html","./packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.ts","./packages/geo/src/lib/catalog/catalog-library/catalog-library.component.html","./packages/geo/src/lib/catalog/catalog-library/catalog-library.component.ts","./packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.html","./packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.ts","./packages/geo/src/lib/catalog/catalog-library/catalog-library.module.ts","./packages/geo/src/lib/catalog/catalog.module.ts","./packages/geo/src/lib/filter/shared/filterable-datasource.pipe.ts","./packages/geo/src/lib/filter/shared/time-filter.service.ts","./packages/geo/src/lib/filter/shared/ogc-filter.service.ts","./packages/geo/src/lib/filter/shared/spatial-filter.enum.ts","./packages/geo/src/lib/filter/shared/spatial-filter.service.ts","./packages/geo/src/lib/download/shared/download.service.ts","./packages/geo/src/lib/download/download-button/download-button.component.html","./packages/geo/src/lib/download/download-button/download-button.component.ts","./packages/geo/src/lib/download/download.module.ts","./packages/geo/src/lib/feature/feature-details/feature-details.component.html","./packages/geo/src/lib/feature/feature-details/feature-details.component.ts","./packages/geo/src/lib/draw/shared/draw.enum.ts","./packages/geo/src/lib/style/shared/font.enum.ts","./packages/geo/src/lib/geometry/shared/geometry.utils.ts","./packages/geo/src/lib/geometry/shared/geometry.errors.ts","./packages/geo/src/lib/geometry/shared/controls/draw.ts","./packages/geo/src/lib/measure/shared/measure.enum.ts","./packages/geo/src/lib/measure/shared/measure.utils.ts","./packages/geo/src/lib/draw/shared/draw.utils.ts","./packages/geo/src/lib/draw/draw/draw-popup.component.html","./packages/geo/src/lib/draw/draw/draw-popup.component.ts","./packages/geo/src/lib/draw/draw/draw-shorcuts.component.ts","./packages/geo/src/lib/draw/draw/draw-shorcuts.component.html","./packages/geo/src/lib/style/style-service/draw-style.service.ts","./packages/geo/src/lib/style/style-modal/drawing/style-modal-drawing.component.html","./packages/geo/src/lib/style/style-modal/drawing/style-modal-drawing.component.ts","./packages/geo/src/lib/draw/draw/draw-layer-popup.component.ts","./packages/geo/src/lib/draw/draw/draw-layer-popup.component.html","./packages/geo/src/lib/draw/shared/draw-icon.service.ts","./packages/geo/src/lib/draw/draw/draw.component.html","./packages/geo/src/lib/draw/draw/draw.component.ts","./packages/geo/src/lib/draw/draw/draw.module.ts","./packages/geo/src/lib/feature/feature-details/feature-details.module.ts","./packages/geo/src/lib/feature/feature-form/feature-form.module.ts","./packages/geo/src/lib/feature/feature.module.ts","./packages/geo/src/lib/geometry/shared/controls/modify.ts","./packages/geo/src/lib/layer/shared/layer.enums.ts","./packages/geo/src/lib/measure/measurer/measurer-dialog.component.html","./packages/geo/src/lib/measure/measurer/measurer-dialog.component.ts","./packages/geo/src/lib/measure/measurer/measurer.component.html","./packages/geo/src/lib/measure/measurer/measurer.component.ts","./packages/geo/src/lib/measure/measurer/measure-format.pipe.ts","./packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.ts","./packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.html","./packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field.module.ts","./packages/geo/src/lib/geometry/geometry.module.ts","./packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.html","./packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.ts","./packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.html","./packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.ts","./packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.html","./packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.ts","./packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.html","./packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.ts","./packages/geo/src/lib/wkt/shared/wkt.service.ts","./packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.html","./packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.ts","./packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.html","./packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.ts","./packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.html","./packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.ts","./packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.html","./packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.ts","./packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.html","./packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.ts","./packages/geo/src/lib/filter/shared/ogc-filter-time.service.ts","./packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.html","./packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.ts","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.html","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.ts","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.html","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.ts","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.html","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.ts","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.html","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.ts","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.ts","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.html","./packages/geo/src/lib/filter/filter.module.ts","./packages/geo/src/lib/import-export/shared/export.errors.ts","./packages/geo/src/lib/import-export/shared/export.type.ts","./packages/geo/src/lib/import-export/shared/export.service.ts","./packages/utils/src/lib/file.ts","./packages/geo/src/lib/import-export/shared/import.utils.ts","./packages/geo/src/lib/import-export/shared/import.errors.ts","./packages/geo/src/lib/import-export/shared/import.service.ts","./packages/geo/src/lib/style/style-list/style-list.service.ts","./packages/geo/src/lib/import-export/import-export/import-export.component.html","./packages/geo/src/lib/import-export/import-export/import-export.component.ts","./packages/geo/src/lib/map/shared/projection.utils.ts","./packages/geo/src/lib/import-export/shared/export.utils.ts","./packages/geo/src/lib/import-export/import-export.module.ts","./packages/geo/src/lib/map/map.module.ts","./packages/geo/src/lib/measure/measurer/measurer-item.component.html","./packages/geo/src/lib/measure/measurer/measurer-item.component.ts","./packages/geo/src/lib/measure/measurer/measurer.module.ts","./packages/geo/src/lib/measure/measure.module.ts","./packages/geo/src/lib/overlay/shared/overlay.enum.ts","./packages/geo/src/lib/overlay/shared/overlay.service.ts","./packages/geo/src/lib/overlay/shared/overlay.directive.ts","./packages/geo/src/lib/overlay/overlay.module.ts","./packages/geo/src/lib/print/shared/geopdf.ts","./packages/geo/src/lib/print/shared/print.type.ts","./packages/geo/src/lib/print/shared/print.service.ts","./packages/geo/src/lib/layer/utils/outputLegend.ts","./packages/geo/src/lib/print/print-form/print-form.component.html","./packages/geo/src/lib/print/print-form/print-form.component.ts","./packages/geo/src/lib/print/print/print.component.ts","./packages/geo/src/lib/print/print/print.component.html","./packages/geo/src/lib/print/print.module.ts","./packages/geo/src/lib/query/shared/query-search-source.providers.ts","./packages/geo/src/lib/query/query.module.ts","./packages/geo/src/lib/directions/directions-sources/directions-source.ts","./packages/geo/src/lib/directions/shared/directions-source.service.ts","./packages/geo/src/lib/directions/shared/directions.enum.ts","./packages/geo/src/lib/directions/shared/directions.utils.ts","./packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.html","./packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.ts","./packages/geo/src/lib/directions/shared/directions.service.ts","./packages/geo/src/lib/search/shared/search.utils.ts","./packages/geo/src/lib/search/shared/search-source.service.ts","./packages/geo/src/lib/search/shared/search.service.ts","./packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.html","./packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.ts","./packages/geo/src/lib/directions/directions-results/directions-results.component.html","./packages/geo/src/lib/directions/directions-results/directions-results.component.ts","./packages/geo/src/lib/directions/directions.component.ts","./packages/geo/src/lib/directions/directions.component.html","./packages/geo/src/lib/directions/directions.module.ts","./packages/geo/src/lib/search/shared/search-source-service.providers.ts","./packages/geo/src/lib/search/shared/sources/icherche.ts","./packages/geo/src/lib/search/shared/sources/icherche.providers.ts","./packages/geo/src/lib/search/shared/sources/coordinates.ts","./packages/geo/src/lib/search/shared/sources/coordinates.providers.ts","./packages/geo/src/lib/search/shared/sources/ilayer.ts","./packages/geo/src/lib/search/shared/sources/ilayer.providers.ts","./packages/geo/src/lib/search/shared/search.enums.ts","./packages/geo/src/lib/search/search-selector/search-selector.component.html","./packages/geo/src/lib/search/search-selector/search-selector.component.ts","./packages/geo/src/lib/search/search-selector/search-selector.module.ts","./packages/geo/src/lib/search/search-settings/search-settings.component.html","./packages/geo/src/lib/search/search-settings/search-settings.component.ts","./packages/geo/src/lib/search/search-settings/search-settings.module.ts","./packages/geo/src/lib/search/search-bar/search-bar.component.html","./packages/geo/src/lib/search/search-bar/search-bar.component.ts","./packages/geo/src/lib/search/search-bar/search-bar.module.ts","./packages/geo/src/lib/search/search-results/search-results-item.component.html","./packages/geo/src/lib/search/search-results/search-results-item.component.ts","./packages/geo/src/lib/search/search-results/search-results.component.html","./packages/geo/src/lib/search/search-results/search-results.component.ts","./packages/geo/src/lib/search/search-results/save-feature-dialog.component.html","./packages/geo/src/lib/search/search-results/save-feature-dialog.component.ts","./packages/geo/src/lib/search/search-results/search-results-add-button.component.html","./packages/geo/src/lib/search/search-results/search-results-add-button.component.ts","./packages/geo/src/lib/search/search-results/search-results.module.ts","./packages/geo/src/lib/search/shared/search-pointer-summary.directive.ts","./packages/geo/src/lib/search/search.module.ts","./packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.ts","./packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.html","./packages/geo/src/lib/workspace/widgets/widgets.ts","./packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.module.ts","./packages/geo/src/lib/style/shared/vector/commonVectorStyle.ts","./packages/geo/src/lib/workspace/shared/wfs-workspace.ts","./packages/geo/src/lib/workspace/shared/wfs-workspace.service.ts","./packages/geo/src/lib/workspace/shared/wms-workspace.service.ts","./packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.ts","./packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.html","./packages/geo/src/lib/workspace/shared/edition-workspace.ts","./packages/geo/src/lib/workspace/shared/edition-workspace.service.ts","./packages/geo/src/lib/workspace/shared/feature-workspace.ts","./packages/geo/src/lib/workspace/shared/feature-workspace.service.ts","./packages/geo/src/lib/workspace/workspace-selector/workspace-selector.directive.ts","./packages/geo/src/lib/workspace/workspace-selector/workspace-selector.module.ts","./packages/geo/src/lib/workspace/workspace-updator/workspace-updator.module.ts","./packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.module.ts","./packages/geo/src/lib/workspace/workspace.module.ts","./packages/geo/src/lib/style/style-list/style-list.provider.ts","./packages/geo/src/lib/style/style-list/style-list.module.ts","./packages/geo/src/lib/style/style.module.ts","./packages/geo/src/lib/directions/shared/store.ts","./packages/geo/src/lib/directions/directions-sources/osrm-directions-source.ts","./packages/geo/src/lib/directions/directions-sources/directions-source.provider.ts","./packages/geo/src/lib/search/shared/sources/cadastre.ts","./packages/geo/src/lib/search/shared/sources/cadastre.providers.ts","./packages/geo/src/lib/search/shared/sources/nominatim.ts","./packages/geo/src/lib/search/shared/sources/nominatim.providers.ts","./packages/geo/src/lib/search/shared/sources/storedqueries.ts","./packages/geo/src/lib/search/shared/sources/storedqueries.providers.ts","./packages/geo/src/lib/search/shared/sources/workspace.ts","./packages/geo/src/lib/search/shared/sources/workspace.providers.ts","./packages/geo/src/lib/workspace/shared/workspace.utils.ts","./demo/src/app/geo/simple-map/simple-map.component.html","./demo/src/app/geo/simple-map/simple-map-routing.module.ts","./demo/src/app/geo/simple-map/simple-map.component.ts","./demo/src/app/geo/simple-map/simple-map.module.ts","./demo/src/app/geo/layer/layer.component.html","./demo/src/app/geo/layer/layer-routing.module.ts","./demo/src/app/geo/layer/layer.component.ts","./demo/src/app/geo/layer/layer.module.ts","./demo/src/app/geo/legend/legend-routing.module.ts","./demo/src/app/geo/legend/legend.component.ts","./demo/src/app/geo/legend/legend.component.html","./demo/src/app/geo/legend/legend.module.ts","./demo/src/app/geo/overlay/overlay-routing.module.ts","./demo/src/app/geo/overlay/overlay.component.ts","./demo/src/app/geo/overlay/overlay.component.html","./demo/src/app/geo/overlay/overlay.module.ts","./demo/src/app/geo/geometry/geometry.component.html","./demo/src/app/geo/geometry/geometry-routing.module.ts","./demo/src/app/geo/geometry/geometry.component.ts","./demo/src/app/geo/geometry/geometry.module.ts","./demo/src/app/geo/feature/feature-routing.module.ts","./demo/src/app/geo/feature/feature.component.ts","./demo/src/app/geo/feature/feature.component.html","./demo/src/app/geo/feature/feature.module.ts","./demo/src/app/geo/hover/hover-routing.module.ts","./demo/src/app/geo/hover/hover.component.ts","./demo/src/app/geo/hover/hover.component.html","./demo/src/app/geo/hover/hover.module.ts","./demo/src/app/geo/measure/measure-routing.module.ts","./demo/src/app/geo/measure/measure.component.ts","./demo/src/app/geo/measure/measure.component.html","./demo/src/app/geo/measure/measure.module.ts","./demo/src/app/geo/draw/draw-routing.module.ts","./demo/src/app/geo/draw/draw.component.ts","./demo/src/app/geo/draw/draw.component.html","./demo/src/app/geo/draw/draw.module.ts","./demo/src/app/geo/query/query.component.html","./demo/src/app/geo/query/query-routing.module.ts","./demo/src/app/geo/query/query.component.ts","./demo/src/app/geo/query/query.module.ts","./demo/src/app/geo/catalog/catalog-routing.module.ts","./demo/src/app/geo/catalog/catalog.component.ts","./demo/src/app/geo/catalog/catalog.component.html","./demo/src/app/geo/catalog/catalog.module.ts","./packages/context/src/lib/context-import-export/shared/context-export.errors.ts","./packages/context/src/lib/context-import-export/shared/context-import.errors.ts","./packages/context/src/lib/context-manager/shared/context.enum.ts","./packages/context/src/lib/context-manager/shared/context.service.ts","./packages/context/src/lib/context-import-export/context-import-export.module.ts","./packages/context/src/lib/context-manager/shared/map-context.directive.ts","./packages/context/src/lib/context-manager/shared/layer-context.directive.ts","./packages/context/src/lib/context-import-export/shared/context-import.utils.ts","./packages/context/src/lib/context-manager/context-list/context-list.enum.ts","./packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.ts","./packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.html","./packages/context/src/lib/context-manager/context-item/context-item.component.html","./packages/context/src/lib/context-manager/context-item/context-item.component.ts","./packages/context/src/lib/context-manager/context-list/context-list.component.html","./packages/context/src/lib/context-manager/context-list/context-list.component.ts","./packages/context/src/lib/context-manager/context-list/context-list-binding.directive.ts","./packages/context/src/lib/context-map-button/poi-button/shared/poi.service.ts","./packages/context/src/lib/context-map-button/context-map-button.module.ts","./packages/context/src/lib/context-manager/context-manager.module.ts","./packages/integration/src/lib/import-export/import-export.state.ts","./packages/integration/src/lib/tool/tool.state.ts","./packages/integration/src/lib/map/map.state.ts","./packages/integration/src/lib/workspace/shared/workspace.utils.ts","./packages/integration/src/lib/storage/storage.state.ts","./packages/integration/src/lib/workspace/shared/feature-actions.service.ts","./packages/integration/src/lib/workspace/shared/wfs-actions.service.ts","./packages/integration/src/lib/workspace/shared/edition-actions.service.ts","./packages/integration/src/lib/workspace/workspace.state.ts","./packages/integration/src/lib/search/search.state.ts","./packages/integration/src/lib/search/search-bar/search-bar.module.ts","./packages/integration/src/lib/search/search-results-tool/search-results-tool.module.ts","./packages/integration/src/lib/search/search.module.ts","./demo/src/app/geo/search/search.component.html","./demo/src/app/geo/search/search-routing.module.ts","./demo/src/app/geo/search/search.component.ts","./demo/src/app/geo/search/search.module.ts","./demo/src/app/geo/print/print-routing.module.ts","./demo/src/app/geo/print/print.component.ts","./demo/src/app/geo/print/print.component.html","./demo/src/app/geo/print/print.module.ts","./demo/src/app/geo/import-export/import-export-routing.module.ts","./demo/src/app/geo/import-export/import-export.component.ts","./demo/src/app/geo/import-export/import-export.component.html","./demo/src/app/geo/import-export/import-export.module.ts","./demo/src/app/geo/directions/directions-routing.module.ts","./demo/src/app/geo/directions/directions.component.ts","./demo/src/app/geo/directions/directions.component.html","./demo/src/app/geo/directions/directions.module.ts","./demo/src/app/geo/time-filter/time-filter-routing.module.ts","./demo/src/app/geo/time-filter/time-filter.component.ts","./demo/src/app/geo/time-filter/time-filter.component.html","./demo/src/app/geo/time-filter/time-filter.module.ts","./demo/src/app/geo/ogc-filter/ogc-filter-routing.module.ts","./demo/src/app/geo/ogc-filter/ogc-filter.component.ts","./demo/src/app/geo/ogc-filter/ogc-filter.component.html","./demo/src/app/geo/ogc-filter/ogc-filter.module.ts","./demo/src/app/geo/spatial-filter/spatial-filter.component.html","./demo/src/app/geo/spatial-filter/spatial-filter-routing.module.ts","./demo/src/app/geo/spatial-filter/spatial-filter.component.ts","./demo/src/app/geo/spatial-filter/spatial-filter.module.ts","./demo/src/app/geo/workspace/workspace.component.html","./demo/src/app/geo/workspace/workspace-routing.module.ts","./demo/src/app/geo/workspace/workspace.component.ts","./demo/src/app/geo/workspace/workspace.module.ts","./demo/src/app/context/context/context.component.html","./demo/src/app/context/context/context-routing.module.ts","./demo/src/app/context/context/context.component.ts","./demo/src/app/context/context/context.module.ts","./demo/src/app/app-routing.module.ts","./demo/src/app/app.component.ts","./demo/src/app/app.component.html","./demo/src/app/app.module.ts","./demo/src/main.ts","./node_modules/moment/locale/ sync ^\\.\\/.*$"],"sourcesContent":["/* eslint-disable */\r\n\r\nconst ALPHA =\r\n  'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\r\n\r\nexport class Base64 {\r\n  private static PADCHAR: string = '=';\r\n  private static ALPHA: string = ALPHA;\r\n\r\n  private static getByte(s: string, i: number): number {\r\n    const x = s.charCodeAt(i);\r\n    return x;\r\n  }\r\n\r\n  private static getByte64(s: string, i: number): number {\r\n    const idx = this.ALPHA.indexOf(s.charAt(i));\r\n    return idx;\r\n  }\r\n\r\n  public static decode(s: string): string {\r\n    let pads = 0,\r\n      i,\r\n      b10,\r\n      imax = s.length,\r\n      x = [];\r\n\r\n    s = String(s);\r\n\r\n    if (imax === 0) {\r\n      return s;\r\n    }\r\n\r\n    if (s.charAt(imax - 1) === this.PADCHAR) {\r\n      pads = 1;\r\n      if (s.charAt(imax - 2) === this.PADCHAR) {\r\n        pads = 2;\r\n      }\r\n      imax -= 4;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 4) {\r\n      b10 =\r\n        (this.getByte64(s, i) << 18) |\r\n        (this.getByte64(s, i + 1) << 12) |\r\n        (this.getByte64(s, i + 2) << 6) |\r\n        this.getByte64(s, i + 3);\r\n      x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255, b10 & 255));\r\n    }\r\n\r\n    switch (pads) {\r\n      case 1:\r\n        b10 =\r\n          (this.getByte64(s, i) << 18) |\r\n          (this.getByte64(s, i + 1) << 12) |\r\n          (this.getByte64(s, i + 2) << 6);\r\n        x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255));\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte64(s, i) << 18) | (this.getByte64(s, i + 1) << 12);\r\n        x.push(String.fromCharCode(b10 >> 16));\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n\r\n  public static encode(s: string): string {\r\n    s = String(s);\r\n\r\n    let i,\r\n      b10,\r\n      x = [],\r\n      imax = s.length - s.length % 3;\r\n\r\n    if (s.length === 0) {\r\n      return s;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 3) {\r\n      b10 =\r\n        (this.getByte(s, i) << 16) |\r\n        (this.getByte(s, i + 1) << 8) |\r\n        this.getByte(s, i + 2);\r\n      x.push(this.ALPHA.charAt(b10 >> 18));\r\n      x.push(this.ALPHA.charAt((b10 >> 12) & 63));\r\n      x.push(this.ALPHA.charAt((b10 >> 6) & 63));\r\n      x.push(this.ALPHA.charAt(b10 & 63));\r\n    }\r\n\r\n    switch (s.length - imax) {\r\n      case 1:\r\n        b10 = this.getByte(s, i) << 16;\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.PADCHAR +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte(s, i) << 16) | (this.getByte(s, i + 1) << 8);\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.ALPHA.charAt((b10 >> 6) & 63) +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n}\r\n","import * as Bowser from 'bowser';\r\n\r\nexport interface UserAgent extends Bowser.Parser.Parser {\r\n  compareVersion: (version: string) => boolean;\r\n}\r\n\r\nexport const userAgent = Bowser.getParser(\r\n  window.navigator.userAgent\r\n) as UserAgent;\r\n","import { userAgent } from './user-agent';\r\n\r\nexport class Clipboard {\r\n  static copy(element: HTMLTextAreaElement | string): boolean {\r\n    let successful = false;\r\n    if (typeof element === 'string') {\r\n      const textArea = Clipboard.createTextArea(element);\r\n      Clipboard.selectText(textArea);\r\n      successful = Clipboard.copyTextToClipboard();\r\n      Clipboard.destroyTextArea(textArea);\r\n    } else {\r\n      Clipboard.selectText(element);\r\n      successful = Clipboard.copyTextToClipboard();\r\n    }\r\n    return successful;\r\n  }\r\n\r\n  private static createTextArea(text: string): HTMLTextAreaElement {\r\n    const textArea = document.createElement('textArea') as HTMLTextAreaElement;\r\n    textArea.value = text;\r\n    document.body.appendChild(textArea);\r\n    return textArea;\r\n  }\r\n\r\n  private static destroyTextArea(textArea) {\r\n    document.body.removeChild(textArea);\r\n  }\r\n\r\n  private static selectText(textArea) {\r\n    if (userAgent.getOSName() === 'iOS') {\r\n      const oldContentEditable = textArea.contentEditable;\r\n      const oldReadOnly = textArea.readOnly;\r\n      const range = document.createRange();\r\n      const selection = window.getSelection();\r\n\r\n      textArea.contenteditable = true;\r\n      textArea.readonly = false;\r\n      range.selectNodeContents(textArea);\r\n      selection.removeAllRanges();\r\n      selection.addRange(range);\r\n      textArea.setSelectionRange(0, 999999);\r\n      textArea.contentEditable = oldContentEditable;\r\n      textArea.readOnly = oldReadOnly;\r\n    } else {\r\n      textArea.select();\r\n    }\r\n  }\r\n\r\n  private static copyTextToClipboard(): boolean {\r\n    if (!(userAgent.getOSName() === 'iOS' && userAgent.compareVersion('<10'))) {\r\n      return document.execCommand('copy');\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","export class StringUtils {\r\n  static diff(s1: string, s2: string, p = 4): string {\r\n    if (!s1 && !s2) {\r\n      return '';\r\n    }\r\n    if (!s1) {\r\n      return '<span class=\"inserted\">' + s2 + '</span>';\r\n    }\r\n    if (!s2) {\r\n      return '<span class=\"deleted\">' + s1 + '</span>';\r\n    }\r\n    s1 = s1.toString();\r\n    s2 = s2.toString();\r\n    const changeData = StringUtils.getChanges(s1, s2, '', p);\r\n    const nextS = s2.slice(\r\n      changeData.mtc.length + changeData.ins.length + changeData.sbs.length\r\n    ); // remaining part of \"s\"\r\n    const nextThis = s1.slice(\r\n      changeData.mtc.length + changeData.del.length + changeData.sbs.length\r\n    ); // remaining part of \"this\"\r\n    let result = ''; // the glorious result\r\n    if (changeData.del.length > 0) {\r\n      changeData.del = '<span class=\"deleted\">' + changeData.del + '</span>';\r\n    }\r\n    if (changeData.ins.length > 0) {\r\n      changeData.ins = '<span class=\"inserted\">' + changeData.ins + '</span>';\r\n    }\r\n    result = changeData.mtc + changeData.del + changeData.ins + changeData.sbs;\r\n    result +=\r\n      nextThis !== '' || nextS !== ''\r\n        ? StringUtils.diff(nextThis, nextS, p)\r\n        : '';\r\n    return result;\r\n  }\r\n\r\n  private static getMatchingSubstring(s, l, m) {\r\n    // returns the first matching substring in-between the two strings\r\n    let i = 0;\r\n    let match = false;\r\n    const slen = s.length;\r\n    const o = { fis: slen, mtc: m, sbs: '' }; // temporary object used to construct the cd (change data) object\r\n\r\n    while (i < slen) {\r\n      l[i] === s[i]\r\n        ? match\r\n          ? (o.sbs += s[i]) // o.sbs holds the matching substring itsef\r\n          : ((match = true), (o.fis = i), (o.sbs = s[i]))\r\n        : match\r\n          ? (i = slen) // stop after the first found substring\r\n          : (i = i);\r\n      ++i;\r\n    }\r\n    return o;\r\n  }\r\n\r\n  private static getChanges(s1, s2, m, p) {\r\n    const isThisLonger = s1.length >= s1.length ? true : false;\r\n    let [longer, shorter] = isThisLonger ? [s1, s2] : [s2, s1]; // assignment of longer and shorter by es6 destructuring\r\n    let bi = 0; // base index designating the index of first mismacthing character in both strings\r\n\r\n    while (shorter[bi] === longer[bi] && bi < shorter.length) {\r\n      ++bi;\r\n    } // make bi the index of first mismatching character\r\n    longer = longer.split('').slice(bi); // as the longer string will be rotated it is converted into array\r\n    shorter = shorter.slice(bi); // shorter and longer now starts from the first mismatching character\r\n\r\n    const len = longer.length; // length of the longer string\r\n    let cd: any = {\r\n      fis: shorter.length, // the index of matching string in the shorter string\r\n      fil: len, // the index of matching string in the longer string\r\n      sbs: '', // the matching substring itself\r\n      mtc: m + s2.slice(0, bi)\r\n    }; // if exists mtc holds the matching string at the front\r\n    let sub: any = { sbs: '' }; // returned substring per 1 character rotation of the longer string\r\n\r\n    if (shorter !== '') {\r\n      for (let rc = 0; rc < len && sub.sbs.length < p; rc++) {\r\n        // rc -> rotate count, p -> precision factor\r\n        sub = StringUtils.getMatchingSubstring(\r\n          shorter,\r\n          StringUtils.rotateArray(longer, rc),\r\n          cd.mtc\r\n        ); // rotate longer string 1 char and get substring\r\n        sub.fil =\r\n          rc < len - sub.fis\r\n            ? sub.fis + rc // mismatch is longer than the mismatch in short\r\n            : sub.fis - len + rc; // mismatch is shorter than the mismatch in short\r\n        if (sub.sbs.length > cd.sbs.length) {\r\n          cd = sub; // only keep the one with the longest substring.\r\n        }\r\n      }\r\n    }\r\n    // insert the mismatching delete subsrt and insert substr to the cd object and attach the previous substring\r\n    [cd.del, cd.ins] = isThisLonger\r\n      ? [longer.slice(0, cd.fil).join(''), shorter.slice(0, cd.fis)]\r\n      : [shorter.slice(0, cd.fis), longer.slice(0, cd.fil).join('')];\r\n    return cd.del.indexOf(' ') === -1 ||\r\n      cd.ins.indexOf(' ') === -1 ||\r\n      cd.del === '' ||\r\n      cd.ins === '' ||\r\n      cd.sbs === ''\r\n      ? cd\r\n      : StringUtils.getChanges(cd.del, cd.ins, cd.mtc, p);\r\n  }\r\n\r\n  private static rotateArray(array, n) {\r\n    const len = array.length;\r\n    const res = new Array(array.length);\r\n    if (n % len === 0) {\r\n      return array.slice();\r\n    } else {\r\n      for (let i = 0; i < len; i++) {\r\n        res[i] = array[(i + (len + (n % len))) % len];\r\n      }\r\n    }\r\n    return res;\r\n  }\r\n}\r\n","export enum ChangeType {\r\n  ADDED = 'added',\r\n  DELETED = 'deleted',\r\n  MODIFIED = 'modified'\r\n}\r\n\r\nexport interface Change {\r\n  type: ChangeType;\r\n  keysChanged?: {\r\n    key: string;\r\n    newValue: any;\r\n    oldValue: any;\r\n  }[];\r\n}\r\n\r\nexport interface GroupingChanges {\r\n  added: ChangeItem[];\r\n  deleted: ChangeItem[];\r\n  modified: ChangeItem[];\r\n}\r\n\r\nexport interface ChangeItem {\r\n  change: Change;\r\n  value: any;\r\n  oldValue?: any;\r\n  newValue?: any;\r\n}\r\n","import { StringUtils } from './string-utils';\r\nimport { GroupingChanges, ChangeType } from './change.interface';\r\n\r\nexport class ChangeUtils {\r\n  static findChanges(\r\n    obj1: any[],\r\n    obj2: any[],\r\n    ignoreKeys: string[] = []\r\n  ): GroupingChanges {\r\n    const items: GroupingChanges = {\r\n      added: [],\r\n      deleted: [],\r\n      modified: []\r\n    };\r\n\r\n    if (!obj1 || !obj2) {\r\n      return items;\r\n    }\r\n\r\n    const obj1Clone: any = [...obj1];\r\n    const obj2Clone: any = [...obj2];\r\n\r\n    for (const fromItem of obj1Clone) {\r\n      const index = obj2Clone.findIndex(s => s.id === fromItem.id);\r\n\r\n      if (index === -1) {\r\n        items.deleted.push({\r\n          change: { type: ChangeType.DELETED },\r\n          value: fromItem\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const toItem = obj2Clone.splice(index, 1)[0];\r\n      const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n      const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n      const keysChanged = ChangeUtils.compareObject(\r\n        fromItemClone,\r\n        toItemClone,\r\n        undefined,\r\n        ignoreKeys\r\n      );\r\n\r\n      if (keysChanged.length) {\r\n        items.modified.push({\r\n          change: {\r\n            type: ChangeType.MODIFIED,\r\n            keysChanged\r\n          },\r\n          value: fromItemClone,\r\n          oldValue: fromItem,\r\n          newValue: toItem\r\n        });\r\n      }\r\n    }\r\n\r\n    items.added = obj2Clone.map(itemAdded => {\r\n      return {\r\n        change: { type: ChangeType.ADDED },\r\n        value: itemAdded\r\n      };\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  private static compareObject(fromItem, toItem, baseKey?, ignoreKeys = []) {\r\n    const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n    const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n    const keys: any = new Set([\r\n      ...Object.keys(fromItem),\r\n      ...Object.keys(toItem)\r\n    ]);\r\n    let keysChanged = [];\r\n    keys.forEach(key => {\r\n      const keyString = baseKey ? `${baseKey}.${key}` : key;\r\n      if (ignoreKeys.indexOf(keyString) !== -1) {\r\n        return;\r\n      }\r\n\r\n      if (Array.isArray(fromItem[key])) {\r\n        fromItem[key] = fromItem[key].join(',<br>');\r\n      }\r\n      if (Array.isArray(toItem[key])) {\r\n        toItem[key] = toItem[key].join(',<br>');\r\n      }\r\n\r\n      if (\r\n        typeof fromItem[key] === 'object' &&\r\n        typeof toItem[key] === 'object' &&\r\n        fromItem[key] !== null &&\r\n        toItem[key] !== null\r\n      ) {\r\n        keysChanged = keysChanged.concat(\r\n          this.compareObject(fromItem[key], toItem[key], keyString)\r\n        );\r\n      } else {\r\n        if (fromItem[key] !== toItem[key]) {\r\n          keysChanged.push({\r\n            key: keyString,\r\n            oldValue: fromItemClone[key],\r\n            newValue: toItemClone[key]\r\n          });\r\n          fromItem[key] = StringUtils.diff(fromItem[key], toItem[key]);\r\n        }\r\n      }\r\n    });\r\n\r\n    return keysChanged;\r\n  }\r\n}\r\n","export class ObjectUtils {\r\n  static resolve(obj: object, key: string): any {\r\n    const keysArray = key\r\n      .replace(/\\[/g, '.')\r\n      .replace(/\\]/g, '')\r\n      .split('.');\r\n    let current = obj;\r\n    while (keysArray.length) {\r\n      if (typeof current !== 'object') {\r\n        return undefined;\r\n      }\r\n      current = current[keysArray.shift()];\r\n    }\r\n\r\n    return current;\r\n  }\r\n\r\n  static isObject(item: object) {\r\n    return (\r\n      item &&\r\n      typeof item === 'object' &&\r\n      !Array.isArray(item) &&\r\n      item !== null &&\r\n      !(item instanceof Date)\r\n    );\r\n  }\r\n\r\n  static mergeDeep(\r\n    target: object,\r\n    source: object,\r\n    ignoreUndefined = false\r\n  ): any {\r\n    const output = Object.assign({}, target);\r\n    if (ObjectUtils.isObject(target) && ObjectUtils.isObject(source)) {\r\n      Object.keys(source)\r\n        .filter(key => !ignoreUndefined || source[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(source[key])) {\r\n            if (!(key in target)) {\r\n              Object.assign(output, { [key]: source[key] });\r\n            } else {\r\n              output[key] = ObjectUtils.mergeDeep(\r\n                target[key],\r\n                source[key],\r\n                ignoreUndefined\r\n              );\r\n            }\r\n          } else {\r\n            Object.assign(output, { [key]: source[key] });\r\n          }\r\n        });\r\n    }\r\n    return output;\r\n  }\r\n\r\n  static copyDeep(src): any {\r\n    const target = Array.isArray(src) ? [] : {};\r\n    for (const prop in src) {\r\n      if (src.hasOwnProperty(prop)) {\r\n        const value = src[prop];\r\n        if (value && typeof value === 'object') {\r\n          target[prop] = this.copyDeep(value);\r\n        } else {\r\n          target[prop] = value;\r\n        }\r\n      }\r\n    }\r\n    return target;\r\n  }\r\n\r\n  static removeDuplicateCaseInsensitive(obj: object) {\r\n    const summaryCapitalizeObject = {};\r\n    const capitalizeObject = {};\r\n    const upperCaseCount = [];\r\n\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        const upperCaseProperty = property.toUpperCase();\r\n        if (!summaryCapitalizeObject.hasOwnProperty(upperCaseProperty)) {\r\n          summaryCapitalizeObject[upperCaseProperty] = [\r\n            { [property]: obj[property] }\r\n          ];\r\n        } else {\r\n          summaryCapitalizeObject[upperCaseProperty].push({\r\n            [property]: obj[property]\r\n          });\r\n        }\r\n        // counting the number of uppercase lettersMna\r\n        upperCaseCount.push({\r\n          key: property,\r\n          count: property.replace(/[^A-Z]/g, '').length\r\n        });\r\n      }\r\n    }\r\n    for (const capitalizedProperty in summaryCapitalizeObject) {\r\n      if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n        if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n          const capitalizedPropertyObject =\r\n            summaryCapitalizeObject[capitalizedProperty];\r\n          if (capitalizedPropertyObject.length === 1) {\r\n            // for single params (no duplicates)\r\n            const singlePossibility = capitalizedPropertyObject[0];\r\n            capitalizeObject[capitalizedProperty] =\r\n              singlePossibility[Object.keys(singlePossibility)[0]];\r\n          } else if (capitalizedPropertyObject.length > 1) {\r\n            // defining the closest to lowercase property\r\n            const paramClosestToLowercase = upperCaseCount\r\n              .filter(\r\n                f => f.key.toLowerCase() === capitalizedProperty.toLowerCase()\r\n              )\r\n              .reduce((prev, current) => {\r\n                return prev.y < current.y ? prev : current;\r\n              });\r\n            capitalizeObject[paramClosestToLowercase.key.toUpperCase()] =\r\n              obj[paramClosestToLowercase.key];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        delete obj[property];\r\n      }\r\n    }\r\n\r\n    for (const property in capitalizeObject) {\r\n      if (capitalizeObject.hasOwnProperty(property)) {\r\n        obj[property] = capitalizeObject[property];\r\n      }\r\n    }\r\n  }\r\n\r\n  static removeUndefined(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeUndefined(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeUndefined(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static removeNull(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== null)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeNull(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeNull(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static naturalCompare(a, b, direction = 'asc', nullsFirst?: boolean) {\r\n    if (direction === 'desc') {\r\n      b = [a, (a = b)][0];\r\n    }\r\n\r\n    // nullsFirst = undefined : end if direction = 'asc', first if direction = 'desc'\r\n    // nullsFirst = true : always first\r\n    // nullsFirst = false : always end\r\n    if (\r\n      a === null ||\r\n      a === '' ||\r\n      a === undefined ||\r\n      b === null ||\r\n      b === '' ||\r\n      b === undefined\r\n    ) {\r\n      const nullScore =\r\n        a === b\r\n          ? 0\r\n          : a === undefined\r\n          ? 3\r\n          : b === undefined\r\n          ? -3\r\n          : a === null\r\n          ? 2\r\n          : b === null\r\n          ? -2\r\n          : a === ''\r\n          ? 1\r\n          : -1;\r\n      if (direction === 'desc') {\r\n        return nullsFirst !== false ? nullScore : nullScore * -1;\r\n      }\r\n      return nullsFirst === true ? nullScore * -1 : nullScore;\r\n    }\r\n\r\n    const ax = [];\r\n    const bx = [];\r\n    a = '' + a;\r\n    b = '' + b;\r\n\r\n    a.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      ax.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    b.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      bx.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    while (ax.length && bx.length) {\r\n      const an = ax.shift();\r\n      const bn = bx.shift();\r\n      const nn = an[0] - bn[0] || an[1].localeCompare(bn[1]);\r\n      if (nn) {\r\n        return nn;\r\n      }\r\n    }\r\n\r\n    return ax.length - bx.length;\r\n  }\r\n\r\n  /**\r\n   * Return true if two object are equivalent.\r\n   * Objects are considered equivalent if they have the same properties and\r\n   * if all of their properties (first-level only) share the same value.\r\n   * @param obj1 First object\r\n   * @param obj2 Second object\r\n   * @returns Whether two objects arer equivalent\r\n   */\r\n  static objectsAreEquivalent(obj1: object, obj2: object): boolean {\r\n    if (obj1 === obj2) {\r\n      return true;\r\n    }\r\n\r\n    const obj1Props = Object.getOwnPropertyNames(obj1);\r\n    const obj2Props = Object.getOwnPropertyNames(obj2);\r\n    if (obj1Props.length !== obj2Props.length) {\r\n      return false;\r\n    }\r\n\r\n    for (const prop of obj1Props) {\r\n      if (obj1[prop] !== obj2[prop]) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Return a new object with an array of keys removed\r\n   * @param obj Source object\r\n   * @param keys Keys to remove\r\n   * @returns A new object\r\n   */\r\n  static removeKeys(obj: object, keys: string[]): object {\r\n    const newObj = Object.keys(obj)\r\n      .filter(key => keys.indexOf(key) < 0)\r\n      .reduce((_obj, key) => {\r\n        _obj[key] = obj[key];\r\n        return _obj;\r\n      }, {});\r\n\r\n    return newObj;\r\n  }\r\n}\r\n","export class NumberUtils {\r\n    static roundToNDecimal(num: number, decimal: number = 3): number {\r\n        const roundFactor = Math.pow(10, decimal);\r\n        return Math.round((num) * roundFactor) / roundFactor;\r\n    }\r\n}\r\n","/** Utility function to create a K:V from a list of strings */\r\nexport function strEnum<T extends string>(o: Array<T>): { [K in T]: K } {\r\n  return o.reduce((res, key) => {\r\n    res[key] = key;\r\n    return res;\r\n  }, Object.create(null));\r\n}\r\n","export function S4() {\r\n  // eslint-disable-next-line no-bitwise\r\n  return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);\r\n}\r\n\r\nexport function uuid() {\r\n  const id = `${S4()}${S4()}-${S4()}-${S4()}-${S4()}-${S4()}${S4()}${S4()}`;\r\n  return id.toLowerCase();\r\n}\r\n","import { Subject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nexport enum SubjectStatus {\r\n  Error = 0,\r\n  Done = 1,\r\n  Working = 2,\r\n  Waiting = 3\r\n}\r\n\r\nexport abstract class Watcher {\r\n  public status$ = new Subject<SubjectStatus>();\r\n  protected status$$: Subscription;\r\n\r\n  get status(): SubjectStatus {\r\n    return this._status;\r\n  }\r\n  set status(value: SubjectStatus) {\r\n    this._status = value;\r\n    this.status$.next(value);\r\n  }\r\n  private _status: SubjectStatus;\r\n\r\n  protected abstract watch();\r\n\r\n  protected abstract unwatch();\r\n\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  subscribe(callback: Function, scope?: any) {\r\n    this.watch();\r\n\r\n    this.status$$ = this.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((status: SubjectStatus) => {\r\n        this.handleStatusChange(status);\r\n        callback.call(scope, this);\r\n      });\r\n  }\r\n\r\n  unsubscribe() {\r\n    this.unwatch();\r\n    if (this.status$$ !== undefined) {\r\n      this.status$$.unsubscribe();\r\n      this.status$$ = undefined;\r\n    }\r\n    this.status = SubjectStatus.Waiting;\r\n  }\r\n\r\n  protected handleStatusChange(status: SubjectStatus) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ActivityService {\r\n  public counter$ = new BehaviorSubject<number>(0);\r\n\r\n  private ids: string[] = [];\r\n\r\n  constructor() {}\r\n\r\n  register(): string {\r\n    const id = uuid();\r\n    this.ids.push(id);\r\n    this.counter$.next(this.ids.length);\r\n\r\n    return id;\r\n  }\r\n\r\n  unregister(id: string) {\r\n    const index = this.ids.indexOf(id);\r\n    if (index === -1) {\r\n      return;\r\n    }\r\n    this.ids.splice(index, 1);\r\n\r\n    this.counter$.next(this.ids.length);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpEvent,\r\n  HttpHandler,\r\n  HttpInterceptor,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { finalize } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from './activity.service';\r\n\r\n@Injectable()\r\nexport class ActivityInterceptor implements HttpInterceptor {\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const activity = req.headers.get('activityInterceptor');\r\n    if (activity) {\r\n      const actReq = req.clone({\r\n        headers: req.headers.delete('activityInterceptor')\r\n      });\r\n      if (activity === 'false') {\r\n        return next.handle(actReq);\r\n      }\r\n    }\r\n\r\n    const id = this.activityService.register();\r\n\r\n    return next.handle(req).pipe(\r\n      finalize(() => {\r\n        this.activityService.unregister(id);\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ActivityInterceptor } from './activity.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoActivityModule {\r\n  static forRoot(): ModuleWithProviders<IgoActivityModule> {\r\n    return {\r\n      ngModule: IgoActivityModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ActivityInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export interface Version {\r\n  lib: string;\r\n  releaseDate: number;\r\n}\r\n\r\nexport const version: Version = {\r\n  lib: '1.15.4',\r\n  releaseDate: 1688557109892\r\n};\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigOptions } from './config.interface';\r\nimport { version } from './version';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ConfigService {\r\n  private config: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in config file\r\n   */\r\n  public getConfig(key: string): any {\r\n    return ObjectUtils.resolve(this.config, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all config's variables\r\n   */\r\n  public load(options: ConfigOptions) {\r\n    const baseConfig = options.default || {};\r\n    if (!options.path) {\r\n      this.config = baseConfig;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`Configuration file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((configResponse: object) => {\r\n          this.config = ObjectUtils.mergeDeep(\r\n            ObjectUtils.mergeDeep({ version }, baseConfig),\r\n            configResponse\r\n          );\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { ConfigService } from './config.service';\r\nimport { ConfigOptions } from './config.interface';\r\n\r\nexport let CONFIG_OPTIONS = new InjectionToken<ConfigOptions>('configOptions');\r\n\r\nexport function provideConfigOptions(options: ConfigOptions) {\r\n  return {\r\n    provide: CONFIG_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function configFactory(\r\n  configService: ConfigService,\r\n  options: ConfigOptions\r\n) {\r\n  return () => configService.load(options);\r\n}\r\n\r\nexport function provideConfigLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: configFactory,\r\n    multi: true,\r\n    deps: [ConfigService, CONFIG_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideConfigOptions, provideConfigLoader } from './config.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoConfigModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfigModule> {\r\n    return {\r\n      ngModule: IgoConfigModule,\r\n      providers: [provideConfigOptions({}), provideConfigLoader()]\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { forkJoin, map } from 'rxjs';\r\n\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\nexport class LanguageLoader implements TranslateLoader {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private prefix?: string | string[],\r\n    private suffix: string = '.json',\r\n    private config?: ConfigService\r\n  ) {}\r\n\r\n  public getTranslation(lang: string): any {\r\n    const igoLocale$ = this.http.get(`locale/libs_locale/${lang}.json`);\r\n\r\n    if (this.config && !this.prefix) {\r\n      const prefix = this.config.getConfig('language.prefix');\r\n      this.prefix = !prefix || Array.isArray(prefix) ? prefix : [prefix];\r\n    }\r\n\r\n    if (!this.prefix || this.prefix.length === 0) {\r\n      return igoLocale$;\r\n    }\r\n\r\n    const appLocale$ = (this.prefix as string[]).map((prefix) =>\r\n      this.http.get(`${prefix}${lang}${this.suffix}`)\r\n    );\r\n\r\n    const locale$ = forkJoin([igoLocale$, ...appLocale$]);\r\n\r\n    return locale$.pipe(\r\n      map((translations) => {\r\n        return translations.reduce(\r\n          (acc, current) => ObjectUtils.mergeDeep(acc, current),\r\n          {}\r\n        );\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\nimport { LanguageLoader } from './language.loader';\r\n\r\nexport function defaultLanguageLoader(\r\n  http: HttpClient,\r\n  config?: ConfigService\r\n) {\r\n  return new LanguageLoader(http, undefined, undefined, config);\r\n}\r\n\r\nexport function provideLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient]\r\n  };\r\n}\r\n\r\nexport function provideDefaultLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import {\r\n  MissingTranslationHandler,\r\n  MissingTranslationHandlerParams\r\n} from '@ngx-translate/core';\r\n\r\nexport class IgoMissingTranslationHandler implements MissingTranslationHandler {\r\n  handle(params: MissingTranslationHandlerParams) {\r\n    if (!params.translateService.langs.length) {\r\n      const error =\r\n        'Translations are not yet loaded. \\\r\n         Check that the LanguageService is injected.';\r\n      throw new Error(error);\r\n    }\r\n\r\n    if (params.key.substr(0, 4) === 'igo.') {\r\n      throw new Error(`The Key \"${params.key}\" is missing in locale file.`);\r\n    } else {\r\n      return params.key;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport {\r\n  TranslateModule,\r\n  MissingTranslationHandler\r\n} from '@ngx-translate/core';\r\n\r\nimport { provideDefaultLanguageLoader } from './shared/language.provider';\r\nimport { IgoMissingTranslationHandler } from './shared/missing-translation.guard';\r\n\r\n@NgModule({\r\n  imports: [\r\n    TranslateModule.forRoot({\r\n      missingTranslationHandler: {\r\n        provide: MissingTranslationHandler,\r\n        useClass: IgoMissingTranslationHandler\r\n      }\r\n    })\r\n  ],\r\n  declarations: [],\r\n  exports: [TranslateModule]\r\n})\r\nexport class IgoLanguageModule {\r\n  static forRoot(): ModuleWithProviders<IgoLanguageModule> {\r\n    return {\r\n      ngModule: IgoLanguageModule,\r\n      providers: [provideDefaultLanguageLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { GlobalConfig, ToastrModule } from 'ngx-toastr';\r\n\r\n@NgModule({\r\n  imports: [CommonModule,\r\n    ToastrModule.forRoot({\r\n      positionClass: 'toast-bottom-right',\r\n      timeOut: 10000,\r\n      extendedTimeOut: 10000,\r\n      messageClass: 'toast-message mat-typography',\r\n      closeButton: true,\r\n      progressBar: true,\r\n      enableHtml: true,\r\n      tapToDismiss: true,\r\n      maxOpened: 4,\r\n      preventDuplicates: true,\r\n      resetTimeoutOnDuplicate: true,\r\n      countDuplicates: false,\r\n      includeTitleDuplicates: true\r\n    } as GlobalConfig)],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoMessageModule {\r\n  static forRoot(): ModuleWithProviders<IgoMessageModule> {\r\n    return {\r\n      ngModule: IgoMessageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","export enum MessageType {\r\n  ERROR = 'error',\r\n  ALERT = 'warning', // todo delete (transition to ngx-toastr)\r\n  WARNING = 'warning',\r\n  INFO = 'info',\r\n  SUCCESS = 'success',\r\n  SHOW = 'show'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { BehaviorSubject, combineLatest } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LanguageService {\r\n  private language: string = this.translate.getBrowserLang();\r\n  readonly language$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  constructor(public translate: TranslateService) {\r\n    const lang = this.getLanguage();\r\n    this.translate.setDefaultLang(lang);\r\n    this.language$.next(lang);\r\n  }\r\n\r\n  public getLanguage(): string {\r\n    return this.language.match(/en|fr/) ? this.language : 'en';\r\n  }\r\n\r\n  public setLanguage(language: string) {\r\n    this.language = language.match(/en|fr/) ? language : 'en';\r\n    combineLatest([this.translate.use(this.language), this.translate.reloadLang(this.language)]).subscribe(() => {\r\n      this.language$.next(this.language);\r\n    });\r\n  }\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpErrorResponse } from '@angular/common/http';\r\nimport { BehaviorSubject, forkJoin } from 'rxjs';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\nimport { Message, MessageOptions } from './message.interface';\r\nimport { ActiveToast, IndividualConfig, ToastrService } from 'ngx-toastr';\r\nimport { MessageType } from './message.enum';\r\nimport { LanguageService } from '../../language/shared/language.service';\r\nimport { debounceTime, first } from 'rxjs/operators';\r\n\r\ninterface ActiveMessageTranslation {\r\n  id: number;\r\n  titleKey: string;\r\n  textKey: string;\r\n  textInterpolateParams?: Object\r\n  titleInterpolateParams?: Object\r\n}\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MessageService {\r\n  public messages$ = new BehaviorSubject<Message[]>([]);\r\n  private options: MessageOptions;\r\n  private activeMessageTranslations: ActiveMessageTranslation[] = [];\r\n\r\n  constructor(\r\n    @Inject(Injector) private injector: Injector,\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService\r\n  ) {\r\n    this.options = this.configService.getConfig('message') || {};\r\n    this.languageService.language$.pipe(debounceTime(500)).subscribe(r => {\r\n      if (this.toastr.toasts.length === 0) {\r\n        this.activeMessageTranslations = [];\r\n      }\r\n      this.toastr.toasts.map(toast => {\r\n        const activeMessageTranslation = this.activeMessageTranslations.find(amt => amt.id === toast.toastId);\r\n        if (activeMessageTranslation) {\r\n          const translatedTextInterpolateParams = {...activeMessageTranslation.textInterpolateParams};\r\n          const translatedTitleInterpolateParams = {...activeMessageTranslation.titleInterpolateParams};\r\n\r\n          if (activeMessageTranslation.textInterpolateParams) {\r\n            Object.keys(activeMessageTranslation.textInterpolateParams).map(k => {\r\n              if (k) {\r\n                translatedTextInterpolateParams[k] =\r\n                  this.languageService.translate.instant(activeMessageTranslation.textInterpolateParams[k]);\r\n              }\r\n            });\r\n          }\r\n          if (activeMessageTranslation.titleInterpolateParams) {\r\n            Object.keys(activeMessageTranslation.titleInterpolateParams).map(k => {\r\n              if (k) {\r\n                translatedTitleInterpolateParams[k] =\r\n                  this.languageService.translate.instant(activeMessageTranslation.titleInterpolateParams[k]);\r\n              }\r\n\r\n            });\r\n          }\r\n\r\n\r\n          forkJoin([\r\n          this.languageService.translate.get(activeMessageTranslation.textKey, translatedTextInterpolateParams),\r\n          this.languageService.translate.get(activeMessageTranslation.titleKey, translatedTitleInterpolateParams)\r\n        ]).pipe(first()).subscribe((res: [string, string]) => {\r\n          toast.toastRef.componentInstance.message = res[0];\r\n          toast.toastRef.componentInstance.title = res[1];\r\n        });\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private get toastr(): ToastrService {\r\n    return this.injector.get(ToastrService);\r\n  }\r\n\r\n  showError(httpError: HttpErrorResponse) {\r\n    httpError.error.caught = true;\r\n    return this.error(httpError.error.message, httpError.error.title);\r\n  }\r\n\r\n  message(message: Message) {\r\n    const messageType = message.type;\r\n    this.toastr.toastrConfig.iconClasses[messageType] = `toast-${messageType}`;\r\n\r\n    this.messages$.next(this.messages$.value.concat([message]));\r\n\r\n    message.options = message.options || {} as MessageOptions;\r\n    const currentDate = new Date();\r\n\r\n    message.options.from = message.options.from ? message.options.from : new Date('1 jan 1900');\r\n    message.options.to = message.options.to ? message.options.to : new Date('1 jan 3000');\r\n    if (typeof message.options.from === 'string') {\r\n      message.options.from = new Date(Date.parse(message.options.from.replace(/-/g, ' ')));\r\n    }\r\n    if (typeof message.options.to === 'string') {\r\n      message.options.to = new Date(Date.parse(message.options.to.replace(/-/g, ' ')));\r\n    }\r\n    if (currentDate > message.options.from && currentDate < message.options.to) {\r\n      if (message.showIcon === false) {\r\n        this.toastr.toastrConfig.iconClasses[messageType] = `toast-${messageType} toast-no-icon`;\r\n      }\r\n      message = this.handleTemplate(message);\r\n\r\n      if (message.text) {\r\n        let messageShown: ActiveToast<any>;\r\n        switch (message.type) {\r\n          case MessageType.SUCCESS:\r\n            messageShown = this.success(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.ERROR:\r\n            messageShown = this.error(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.INFO:\r\n            messageShown = this.info(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.SHOW:\r\n            messageShown = this.show(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.ALERT:\r\n          case MessageType.WARNING:\r\n            messageShown = this.alert(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          default:\r\n            messageShown = this.info(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n        }\r\n        message.options.id = messageShown.toastId;\r\n      }\r\n    }\r\n  }\r\n\r\n  success(\r\n    text: string,\r\n    title: string = 'igo.core.message.success',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('success', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  error(\r\n    text: string,\r\n    title: string = 'igo.core.message.error',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('error', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  info(\r\n    text: string,\r\n    title: string = 'igo.core.message.info',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('info', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  alert(\r\n    text: string,\r\n    title: string = 'igo.core.message.alert',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('alert', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  show(\r\n    text: string,\r\n    title: string = 'igo.core.message.info',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('show', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  private handleNgxToastr(\r\n    type: 'alert' | 'info' | 'error' | 'success' | 'show',\r\n    text: string,\r\n    title: string,\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n\r\n    const translatedTextInterpolateParams = {...textInterpolateParams};\r\n    const translatedTitlenterpolateParams = {...titleInterpolateParams};\r\n\r\n    if (textInterpolateParams) {\r\n      Object.keys(textInterpolateParams).map(k => {\r\n        if (textInterpolateParams[k]) {\r\n          translatedTextInterpolateParams[k] =\r\n            this.languageService.translate.instant(textInterpolateParams[k]);\r\n        }\r\n      });\r\n    }\r\n    if (titleInterpolateParams) {\r\n      Object.keys(titleInterpolateParams).map(k => {\r\n        if (k) {\r\n          translatedTitlenterpolateParams[k] =\r\n            this.languageService.translate.instant(titleInterpolateParams[k]);\r\n        }\r\n      });\r\n    }\r\n\r\n\r\n    const message = this.languageService.translate.instant(text, translatedTextInterpolateParams);\r\n    const translatedTitle = this.languageService.translate.instant(title, translatedTitlenterpolateParams);\r\n\r\n    let activeToast;\r\n    switch (type) {\r\n      case 'success':\r\n        activeToast = this.toastr.success(message, translatedTitle, options);\r\n        break;\r\n      case 'error':\r\n        activeToast = this.toastr.error(message, translatedTitle, options);\r\n        break;\r\n      case 'show':\r\n      case 'info':\r\n        activeToast = this.toastr.info(message, translatedTitle, options);\r\n        break;\r\n      case 'alert':\r\n        activeToast = this.toastr.warning(message, translatedTitle, options);\r\n        break;\r\n    }\r\n    this.activeMessageTranslations.push({\r\n      id: activeToast.toastId,\r\n      titleKey: title,\r\n      textKey: text,\r\n      textInterpolateParams,\r\n      titleInterpolateParams });\r\n    return activeToast;\r\n\r\n  }\r\n\r\n  remove(id?: number) {\r\n    this.toastr.remove(id);\r\n  }\r\n\r\n  removeAllAreNotError() {\r\n    for (const mess of this.messages$.value) {\r\n      if (mess.type !== MessageType.ERROR) {\r\n        this.remove(mess.options.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleTemplate(message: Message): Message {\r\n    if (!this.options.template || message.html) {\r\n      return message;\r\n    }\r\n\r\n    let html = this.options.template;\r\n    html = html.replace('${text}', message.text);\r\n    html = html.replace('${title}', message.title);\r\n\r\n    message.html = undefined;\r\n    message.text = html;\r\n    message.title = undefined;\r\n    return message;\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport {\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest,\r\n  HttpEvent,\r\n  HttpErrorResponse\r\n} from '@angular/common/http';\r\n\r\nimport { Observable, throwError } from 'rxjs';\r\nimport { catchError, finalize } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ErrorInterceptor implements HttpInterceptor {\r\n  constructor(\r\n    private injector: Injector\r\n  ) {}\r\n\r\n  intercept(\r\n    originalReq: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const interceptError = originalReq.headers.get('interceptError');\r\n    const req = originalReq.clone({\r\n      headers: originalReq.headers.delete('interceptError')\r\n    });\r\n    if (interceptError === 'false') {\r\n      return next.handle(req);\r\n    }\r\n    const errorContainer = { httpError: undefined };\r\n    return next.handle(req).pipe(\r\n      catchError(error => this.handleError(error, errorContainer)),\r\n      finalize(() => {\r\n        this.handleCaughtError(errorContainer);\r\n        this.handleUncaughtError(errorContainer);\r\n      })\r\n    );\r\n  }\r\n\r\n  private handleError(\r\n    httpError: HttpErrorResponse,\r\n    errorContainer: { httpError: HttpErrorResponse }\r\n  ) {\r\n    if (httpError instanceof HttpErrorResponse) {\r\n      const errorObj = httpError.error === 'object' ? httpError.error : {};\r\n      errorObj.message = httpError.error?.message || httpError.statusText;\r\n      errorObj.caught = false;\r\n\r\n      httpError = new HttpErrorResponse({\r\n        error: errorObj,\r\n        headers: httpError.headers,\r\n        status: httpError.status,\r\n        statusText: httpError.statusText,\r\n        url: httpError.url\r\n      });\r\n    }\r\n\r\n    errorContainer.httpError = httpError;\r\n    return throwError(httpError);\r\n  }\r\n\r\n  private handleCaughtError(errorContainer: { httpError: HttpErrorResponse }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && httpError.error.toDisplay) {\r\n      httpError.error.caught = true;\r\n      const messageService = this.injector.get(MessageService);\r\n       messageService.error(httpError.error.message, httpError.error.title);\r\n    }\r\n  }\r\n\r\n  private handleUncaughtError(errorContainer: {\r\n    httpError: HttpErrorResponse;\r\n  }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && !httpError.error.caught) {\r\n      const messageService = this.injector.get(MessageService);\r\n      httpError.error.caught = true;\r\n      messageService.error('igo.core.errors.uncaught.message', 'igo.core.errors.uncaught.title');\r\n    }\r\n  }\r\n}\r\n","import {\r\n  NgModule,\r\n  ModuleWithProviders,\r\n  Optional,\r\n  SkipSelf\r\n} from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ErrorInterceptor } from './error.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoErrorModule {\r\n  static forRoot(): ModuleWithProviders<IgoErrorModule> {\r\n    return {\r\n      ngModule: IgoErrorModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ErrorInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  constructor(@Optional() @SkipSelf() parentModule: IgoErrorModule) {\r\n    if (parentModule) {\r\n      throw new Error(\r\n        'IgoErrorModule is already loaded. Import it in the AppModule only'\r\n      );\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { DomSanitizer } from '@angular/platform-browser';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\nimport { IgoActivityModule } from './activity/activity.module';\r\nimport { IgoConfigModule } from './config/config.module';\r\nimport { IgoLanguageModule } from './language/language.module';\r\nimport { IgoMessageModule } from './message/message.module';\r\nimport { IgoErrorModule } from './request/error.module';\r\nimport { DBConfig, NgxIndexedDBModule } from 'ngx-indexed-db';\r\n\r\nconst dbConfig: DBConfig = {\r\n  name: 'igo2DB',\r\n  version: 2,\r\n  objectStoresMeta: [{\r\n    store: 'geoData',\r\n    storeConfig: { keyPath: 'url', autoIncrement: false },\r\n    storeSchema: [\r\n      { name: 'regionID', keypath: 'regionID', options: { unique: false }}\r\n    ]\r\n  },\r\n  {\r\n    store: 'layerData',\r\n    storeConfig: { keyPath: 'layerId', autoIncrement: false },\r\n    storeSchema: [\r\n      { name: 'layerOptions', keypath: 'layerOptions', options: { unique: false }},\r\n      { name: 'sourceOptions', keypath: 'sourceOptions', options: { unique: false }}\r\n    ]\r\n  }]\r\n};\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    HttpClientModule,\r\n    IgoActivityModule.forRoot(),\r\n    IgoConfigModule.forRoot(),\r\n    IgoErrorModule.forRoot(),\r\n    IgoLanguageModule.forRoot(),\r\n    IgoMessageModule.forRoot(),\r\n    NgxIndexedDBModule.forRoot(dbConfig)\r\n  ],\r\n  declarations: [],\r\n  exports: [\r\n    IgoActivityModule,\r\n    IgoConfigModule,\r\n    IgoErrorModule,\r\n    IgoLanguageModule,\r\n    IgoMessageModule\r\n  ]\r\n})\r\nexport class IgoCoreModule {\r\n  static forRoot(): ModuleWithProviders<IgoCoreModule> {\r\n    return {\r\n      ngModule: IgoCoreModule,\r\n      providers: []\r\n    };\r\n  }\r\n\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n","import { Injectable, Inject, InjectionToken, Optional } from '@angular/core';\r\nimport { ActivatedRoute, Params, Router } from '@angular/router';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { RouteServiceOptions } from './route.interface';\r\n\r\nexport let ROUTE_SERVICE_OPTIONS = new InjectionToken<RouteServiceOptions>(\r\n  'routeServiceOptions'\r\n);\r\n\r\nexport function provideRouteServiceOptions(options: RouteServiceOptions) {\r\n  return {\r\n    provide: ROUTE_SERVICE_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class RouteService {\r\n  public options: RouteServiceOptions;\r\n\r\n  constructor(\r\n    private router: Router,\r\n    public route: ActivatedRoute,\r\n    @Inject(ROUTE_SERVICE_OPTIONS)\r\n    @Optional()\r\n    options: RouteServiceOptions\r\n  ) {\r\n    const defaultOptions = {\r\n      centerKey: 'center',\r\n      zoomKey: 'zoom',\r\n      projectionKey: 'projection',\r\n      contextKey: 'context',\r\n      searchKey: 'search',\r\n      visibleOnLayersKey: 'visiblelayers',\r\n      visibleOffLayersKey: 'invisiblelayers',\r\n      directionsCoordKey: 'routing',\r\n      directionsOptionsKey: 'routingOptions',\r\n      toolKey: 'tool',\r\n      wmsUrlKey: 'wmsUrl',\r\n      wmsLayersKey:  'wmsLayers',\r\n      wmtsUrlKey: 'wmtsUrl',\r\n      wmtsLayersKey:  'wmtsLayers',\r\n      arcgisUrlKey: 'arcgisUrl',\r\n      arcgisLayersKey:  'arcgisLayers',\r\n      iarcgisUrlKey: 'iarcgisUrl',\r\n      iarcgisLayersKey:  'iarcgisLayers',\r\n      tarcgisUrlKey: 'tarcgisUrl',\r\n      tarcgisLayersKey:  'tarcgisLayers',\r\n      vectorKey: 'vector'\r\n    };\r\n    this.options = Object.assign({}, defaultOptions, options);\r\n  }\r\n\r\n  get queryParams(): Observable<Params> {\r\n    let url = decodeURIComponent(location.search);\r\n    if (url.includes('¢er=')) {\r\n      url = url.replace('¢er', '&center');\r\n      const queryParams: any = url\r\n      .slice(1)\r\n      .split('&')\r\n      .map(p => p.split('='))\r\n      .reduce((obj, pair) => {\r\n        const [key, value] = pair.map(decodeURIComponent);\r\n        obj[key] = value;\r\n        return obj;\r\n      }, {});\r\n      this.router.navigate([], { queryParams });\r\n    }\r\n    return this.route.queryParams;\r\n  }\r\n}\r\n","export enum Media {\r\n  Mobile = 'mobile',\r\n  Tablet = 'tablet',\r\n  Desktop = 'desktop'\r\n}\r\n\r\nexport enum MediaOrientation {\r\n  Portrait = 'portrait',\r\n  Landscape = 'landscape'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Breakpoints, BreakpointObserver } from '@angular/cdk/layout';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Media, MediaOrientation } from './media.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MediaService {\r\n  public media$ = new BehaviorSubject<Media>(undefined);\r\n  public orientation$ = new BehaviorSubject<MediaOrientation>(undefined);\r\n\r\n  constructor(breakpointObserver: BreakpointObserver) {\r\n    breakpointObserver\r\n      .observe([Breakpoints.HandsetLandscape])\r\n      .subscribe(res => {\r\n        if (res.matches) {\r\n          this.media$.next(Media.Mobile);\r\n          this.orientation$.next(MediaOrientation.Landscape);\r\n        }\r\n      });\r\n\r\n    breakpointObserver.observe([Breakpoints.HandsetPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Mobile);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n  }\r\n\r\n  getMedia(): Media {\r\n    return this.media$.value;\r\n  }\r\n\r\n  getOrientation(): MediaOrientation {\r\n    return this.orientation$.value;\r\n  }\r\n\r\n  isTouchScreen(): boolean {\r\n    return 'ontouchstart' in document.documentElement ? true : false;\r\n  }\r\n\r\n  isMobile(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'mobile';\r\n  }\r\n\r\n  isDesktop(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'desktop';\r\n  }\r\n}\r\n","export enum StorageScope {\r\n  SESSION = 'Session',\r\n  LOCAL = 'Local'\r\n}\r\n\r\nexport interface StorageOptions {\r\n  key: string;\r\n}\r\n\r\nexport interface StorageServiceEvent {\r\n  key?: string;\r\n  scope: StorageScope;\r\n  event: StorageServiceEventEnum;\r\n  previousValue?: any;\r\n  currentValue?: any;\r\n}\r\n\r\nexport enum StorageServiceEventEnum {\r\n  ADDED = 'Added',\r\n  MODIFIED = 'Modified',\r\n  REMOVED = 'Removed',\r\n  CLEARED = 'Cleared'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '../config/config.service';\r\nimport { StorageScope, StorageOptions, StorageServiceEvent, StorageServiceEventEnum } from './storage.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageService {\r\n  protected options: StorageOptions;\r\n\r\n  public storageChange$: BehaviorSubject<StorageServiceEvent> = new BehaviorSubject(undefined);\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.options = this.config.getConfig('storage') || { key: 'igo' };\r\n  }\r\n  /**\r\n   * Use to get the data found in storage file\r\n   */\r\n  get(key: string, scope?: StorageScope): string | object | boolean | number {\r\n    let value: any;\r\n\r\n    if (!scope || scope === StorageScope.SESSION) {\r\n      value = sessionStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (scope === StorageScope.LOCAL || (!value && !scope)) {\r\n      value = localStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (value) {\r\n      try {\r\n        value = JSON.parse(value);\r\n      } catch {\r\n        value = value;\r\n      }\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.setItem(\r\n        `${this.options.key}.${key}`,\r\n        JSON.stringify(value)\r\n      );\r\n    } else {\r\n      localStorage.setItem(`${this.options.key}.${key}`, JSON.stringify(value));\r\n    }\r\n    const currentValue = this.get(key, scope);\r\n\r\n    if (currentValue !== previousValue) {\r\n      this.storageChange$.next({\r\n        key, scope,\r\n        event: previousValue !== undefined ? StorageServiceEventEnum.MODIFIED : StorageServiceEventEnum.ADDED,\r\n        previousValue,\r\n        currentValue\r\n      });\r\n    }\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.removeItem(`${this.options.key}.${key}`);\r\n    } else {\r\n      localStorage.removeItem(`${this.options.key}.${key}`);\r\n    }\r\n    this.storageChange$.next({key, scope, event: StorageServiceEventEnum.REMOVED, previousValue });\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.clear();\r\n    } else {\r\n      localStorage.clear();\r\n    }\r\n    this.storageChange$.next({scope, event: StorageServiceEventEnum.CLEARED });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable, Observer } from 'rxjs';\r\nimport { CompressedData } from './compressedData.interface';\r\n\r\nfunction getNumber(v: number, endposition: number, length: number) {\r\n  /* tslint:disable:no-bitwise*/\r\n  const mask = ((1 << length) - 1);\r\n  return (v >> endposition) & mask;\r\n  /* tslint:enable:no-bitwise*/\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CompressionService {\r\n  private base64Index = new Map<string, number>();\r\n  private indexBase64 = new Map<number, string>();\r\n\r\n  constructor() {\r\n    this.generateBase64Index();\r\n  }\r\n\r\n  private generateBase64Index() {\r\n    // https://fr.wikipedia.org/wiki/Base64\r\n    // A-Z => [0, 25]\r\n    for (let i = 0; i < 26; i++) {\r\n      this.base64Index.set(String.fromCharCode('A'.charCodeAt(0) + i), i);\r\n      this.indexBase64.set(i, String.fromCharCode('A'.charCodeAt(0) + i));\r\n    }\r\n    // a-z => [26, 51]\r\n    for (let i = 0; i < 26; i++) {\r\n      this.base64Index.set(String.fromCharCode('a'.charCodeAt(0) + i), i + 26);\r\n      this.indexBase64.set(i + 26, String.fromCharCode('a'.charCodeAt(0) + i));\r\n    }\r\n    // 0-9 => [52, 61]\r\n    for (let i = 0; i < 10; i++) {\r\n      this.base64Index.set(String.fromCharCode('0'.charCodeAt(0) + i), i + 52);\r\n      this.indexBase64.set(i + 52, String.fromCharCode('0'.charCodeAt(0) + i));\r\n    }\r\n    // + / => [62, 63]\r\n    this.base64Index.set('+', 62);\r\n    this.base64Index.set('/', 63);\r\n    this.indexBase64.set(62, '+');\r\n    this.indexBase64.set(63, '/');\r\n  }\r\n\r\n  compressBlob(blob: Blob): Observable<CompressedData> {\r\n    if (!blob) {\r\n      return;\r\n    }\r\n\r\n    const observable = new Observable((observer: Observer<CompressedData>) => {\r\n      const reader = new FileReader();\r\n      reader.readAsDataURL(blob);\r\n      reader.onload = () => {\r\n        const base64 = reader.result.valueOf() as string;\r\n        const text64 = base64.substr(base64.indexOf(',') + 1);\r\n        const compressed = this.compressStringBase64(text64);\r\n        const compressedData: CompressedData = { length: text64.length,\r\n                                                 type: blob.type,\r\n                                                 object: compressed };\r\n        observer.next(compressedData);\r\n      };\r\n    });\r\n    return observable;\r\n  }\r\n\r\n  decompressBlob(compressedData: CompressedData): Blob {\r\n    /* tslint:disable:no-bitwise*/\r\n    const object = compressedData.object;\r\n    const length = compressedData.length;\r\n    const decompressed: string = this.decompressStringBase64(object, length);\r\n    const byteCharacters = atob(decompressed);\r\n    const byteNumbers = new Array(byteCharacters.length);\r\n    for (let i = 0; i < byteCharacters.length; i++) {\r\n        byteNumbers[i] = byteCharacters.charCodeAt(i);\r\n    }\r\n    const byteArray = new Uint8Array(byteNumbers);\r\n    const blob = new Blob([byteArray], {type: compressedData.type});\r\n    /* tslint:enable:no-bitwise*/\r\n    return blob;\r\n  }\r\n\r\n  private compressStringBase64(s: string): string {\r\n    /* tslint:disable:no-bitwise*/\r\n    let out = '';\r\n    let bits = 16;\r\n    let chr = 0;\r\n    let rem = 0;\r\n    for (const c of s) {\r\n      const value = this.base64Index.get(c);\r\n      if (bits > 6) {\r\n        bits -= 6;\r\n        chr += value << bits;\r\n      } else {\r\n        rem = 6 - bits;\r\n        chr += value >> rem;\r\n        out += String.fromCharCode(chr);\r\n        chr = (value) << (16 - rem);\r\n        bits = 16 - rem;\r\n      }\r\n    }\r\n    if (s.length % 8 !== 0) {\r\n      out += String.fromCharCode(chr);\r\n    }\r\n    /* tslint:enable:no-bitwise*/\r\n    return String.fromCharCode(9731) + out;\r\n  }\r\n\r\n  private decompressStringBase64(c: string, length: number): string {\r\n     /* tslint:disable:no-bitwise*/\r\n    if (!c) {\r\n      return;\r\n    }\r\n\r\n    if (c.charCodeAt(0) !== 9731) {\r\n      return c;\r\n    }\r\n\r\n    let chr = 0;\r\n    let rem = 0;\r\n    let bits = 16;\r\n    let out = '';\r\n    let j = 1;\r\n    let value = c.charCodeAt(j);\r\n    for (let i = 0; i < length; i++) {\r\n      if (bits > 6) {\r\n        bits -= 6;\r\n        chr = getNumber(value, bits, 6);\r\n        out += this.indexBase64.get(chr);\r\n      } else {\r\n        rem = 6 - bits;\r\n        chr = getNumber(value, 0, bits) << rem;\r\n        value = c.charCodeAt(++j);\r\n        chr += getNumber(value, 16 - rem, rem);\r\n        out += this.indexBase64.get(chr);\r\n        bits = 16 - rem;\r\n      }\r\n    }\r\n    return out;\r\n    /* tslint:enable:no-bitwise*/\r\n  }\r\n}\r\n","import { Injectable, EventEmitter, OnDestroy, Injector } from '@angular/core';\r\nimport { Observable, Subscription, fromEvent } from 'rxjs';\r\nimport { debounceTime, startWith } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\nimport { ConnectionState } from './network.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class NetworkService implements OnDestroy {\r\n  private stateChangeEventEmitter = new EventEmitter<ConnectionState>();\r\n  private onlineSubscription: Subscription;\r\n  private offlineSubscription: Subscription;\r\n  private previousMessageId;\r\n\r\n  private state: ConnectionState = {\r\n    connection: window.navigator.onLine\r\n  };\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private injector: Injector\r\n  ) {\r\n      this.checkNetworkState();\r\n  }\r\n\r\n  private checkNetworkState() {\r\n    this.onlineSubscription = fromEvent(window, 'online').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const messageObj = this.messageService.info(\r\n        'igo.core.network.online.message',\r\n        'igo.core.network.online.title');\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = true;\r\n      this.emitEvent();\r\n    });\r\n\r\n    this.offlineSubscription = fromEvent(window, 'offline').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const messageObj = this.messageService.info(\r\n        'igo.core.network.offline.message',\r\n        'igo.core.network.offline.title');\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = false;\r\n      this.emitEvent();\r\n    });\r\n  }\r\n\r\n  private emitEvent() {\r\n    this.stateChangeEventEmitter.emit(this.state);\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    try {\r\n      this.offlineSubscription.unsubscribe();\r\n      this.onlineSubscription.unsubscribe();\r\n    } catch (e) {}\r\n  }\r\n\r\n  currentState(reportState = true): Observable<ConnectionState> {\r\n    return reportState\r\n      ? this.stateChangeEventEmitter.pipe(\r\n          debounceTime(300),\r\n          startWith(this.state)\r\n        )\r\n      : this.stateChangeEventEmitter.pipe(debounceTime(300));\r\n  }\r\n}\r\n","export enum EntityOperationType {\r\n  Insert = 'Insert',\r\n  Update = 'Update',\r\n  Delete = 'Delete'\r\n}\r\n\r\nexport enum EntityTableColumnRenderer {\r\n  Default = 'Default',\r\n  HTML = 'HTML',\r\n  UnsanitizedHTML = 'UnsanitizedHTML',\r\n  Editable = 'Editable',\r\n  Icon = 'Icon',\r\n  ButtonGroup = 'ButtonGroup'\r\n}\r\n\r\nexport enum EntityTableScrollBehavior {\r\n  Auto = 'auto',\r\n  Instant = 'instant',\r\n  Smooth = 'smooth'\r\n}\r\n\r\nexport enum EntityTableSelectionState {\r\n  None = 'None',\r\n  All = 'All',\r\n  Some = 'Some'\r\n}\r\n","import { t } from 'typy';\r\n\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\n/**\r\n * Get an entity's named property. Nested properties are supported\r\n * with the dotted notation. (i.e 'author.name')\r\n *\r\n * Note: this method is a 'best attempt' at getting an entity's property.\r\n * It fits the most common cases but you might need to explicitely define\r\n * a property getter when using an EntityStore, for example.\r\n * @param entity Entity\r\n * @param property Property name\r\n * @returns Property value\r\n */\r\nexport function getEntityProperty(entity: object, property: string): any {\r\n  return t(entity, property).safeObject;\r\n}\r\n\r\n/**\r\n * Get an entity's id. An entity's id can be one of:\r\n * 'entity.meta.id', 'entity.meta.idProperty' or 'entity.id'.\r\n *\r\n * Note: See the note in the 'getEntityProperty' documentation.\r\n * @param entity Entity\r\n * @returns Entity id\r\n */\r\nexport function getEntityId(entity: object): EntityKey {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.id ? meta.id : getEntityProperty(entity, meta.idProperty || 'id');\r\n}\r\n\r\n/**\r\n * Get an entity's title. An entity's title can be one of:\r\n * 'entity.meta.title', 'entity.meta.titleProperty' or 'entity.title'.\r\n * @param entity Entity\r\n * @returns Entity title\r\n */\r\nexport function getEntityTitle(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.title ? meta.title : getEntityProperty(entity, meta.titleProperty || 'title');\r\n}\r\n\r\n/**\r\n * Get an entity's HTML title. An entity's HTML title can be one of:\r\n * 'entity.meta.titleHtml', 'entity.meta.titleHtmlProperty' or 'entity.titleHtml'.\r\n * @param entity Entity\r\n * @returns Entity HTML title\r\n */\r\nexport function getEntityTitleHtml(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.titleHtml ? meta.titleHtml : getEntityProperty(entity, meta.titleHtmlProperty || 'titleHtml');\r\n}\r\n\r\n/**\r\n * Get an entity's icon. An entity's icon can be one of:\r\n * 'entity.meta.icon', 'entity.meta.iconProperty' or 'entity.icon'.\r\n * @param entity Entity\r\n * @returns Entity icon\r\n */\r\nexport function getEntityIcon(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.icon ? meta.icon : getEntityProperty(entity, meta.iconProperty || 'icon');\r\n}\r\n\r\n/**\r\n * Get an entity's revision.\r\n * @param entity Entity\r\n * @returns Entity revision\r\n */\r\nexport function getEntityRevision(entity: object): number {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.revision || 0;\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\n\r\nimport { EntityKey, EntityState, EntityStateManagerOptions } from './entity.interfaces';\r\nimport { getEntityId } from './entity.utils';\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to track a store's entities state\r\n */\r\nexport class EntityStateManager<E extends object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * State index\r\n   */\r\n  readonly index = new Map<EntityKey, S>();\r\n\r\n  /**\r\n   * Change emitter\r\n   */\r\n  readonly change$ = new ReplaySubject<void>(1);\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  private store: EntityStore<object> | undefined;\r\n\r\n  constructor(options: EntityStateManagerOptions = {}) {\r\n    this.store = options.store ? options.store : undefined;\r\n    this.getKey = options.getKey\r\n      ? options.getKey\r\n      : (this.store ? this.store.getKey : getEntityId);\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear state\r\n   */\r\n  clear() {\r\n    if (this.index.size > 0) {\r\n      this.index.clear();\r\n      this.next();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity's state\r\n   * @param entity Entity\r\n   * @returns State\r\n   */\r\n  get(entity: E): S {\r\n    return (this.index.get(this.getKey(entity)) || {}) as S;\r\n  }\r\n\r\n  /**\r\n   * Set an entity's state\r\n   * @param entity Entity\r\n   * @param state State\r\n   */\r\n  set(entity: E, state: S) {\r\n    this.setMany([entity], state);\r\n  }\r\n\r\n  /**\r\n   * Set many entitie's state\r\n   * @param entitie Entities\r\n   * @param state State\r\n   */\r\n  setMany(entities: E[], state: S) {\r\n    entities.forEach((entity: E) => {\r\n      this.index.set(this.getKey(entity), Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Set state of all entities that already have a state. This is not\r\n   * the same as setting the state of all the store's entities.\r\n   * @param state State\r\n   */\r\n  setAll(state: S) {\r\n    Array.from(this.index.keys()).forEach((key: EntityKey) => {\r\n      this.index.set(key, Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update an entity's state\r\n   * @param entity Entity\r\n   * @param changes State changes\r\n   */\r\n  update(entity: E, changes: Partial<S>, exclusive = false) {\r\n    this.updateMany([entity], changes, exclusive);\r\n  }\r\n\r\n  /**\r\n   * Update many entitie's state\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  updateMany(entities: E[], changes: Partial<S>, exclusive = false) {\r\n    if (exclusive === true) {\r\n      return this.updateManyExclusive(entities, changes);\r\n    }\r\n\r\n    entities.forEach((entity: E) => {\r\n      const state = Object.assign({}, this.get(entity), changes);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Reversee an entity's state\r\n   * @param entity Entity\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverse(entity: E, keys: string[]) {\r\n    this.reverseMany([entity], keys);\r\n  }\r\n\r\n  /**\r\n   * Reverse many entitie's state\r\n   * @param entitie Entities\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverseMany(entities: E[], keys: string[]) {\r\n    entities.forEach((entity: E) => {\r\n      const currentState = this.get(entity);\r\n      const changes = keys.reduce((acc: {[key: string]: boolean}, key: string) => {\r\n        acc[key] = currentState[key] || false;\r\n        return acc;\r\n      }, {}) as Partial<S>;\r\n      const reversedChanges = this.reverseChanges(changes);\r\n      const state = Object.assign({}, currentState, reversedChanges);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update state of all entities that already have a state. This is not\r\n   * the same as updating the state of all the store's entities.\r\n   * @param changes State\r\n   */\r\n  updateAll(changes: Partial<S>) {\r\n    const allKeys = this.getAllKeys();\r\n    Array.from(allKeys).forEach((key: EntityKey) => {\r\n      const state = Object.assign({}, this.index.get(key), changes);\r\n      this.index.set(key, state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * When some state changes are flagged as 'exclusive', reverse\r\n   * the state of all other entities. Changes are reversable when\r\n   * they are boolean.\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  private updateManyExclusive(entities: E[], changes: Partial<S>) {\r\n    const reverseChanges = this.reverseChanges(changes);\r\n\r\n    const keys = entities.map((entity: E) => this.getKey(entity));\r\n    const allKeys = new Set(keys.concat(Array.from(this.getAllKeys())));\r\n    allKeys.forEach((key: EntityKey) => {\r\n      const state = this.index.get(key) || {} as S;\r\n\r\n      if (keys.indexOf(key) >= 0) {\r\n        this.index.set(key, Object.assign({}, state, changes));\r\n      } else {\r\n        // Update only if the reverse changes would modify\r\n        // a key already present in the current state\r\n        const shouldUpdate = Object.keys(reverseChanges).some((changeKey: string) => {\r\n          return state[changeKey] !== undefined &&\r\n            state[changeKey] !== reverseChanges[changeKey];\r\n        });\r\n        if (shouldUpdate === true) {\r\n          this.index.set(key, Object.assign({}, state, reverseChanges));\r\n        }\r\n      }\r\n    });\r\n\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Compute a 'reversed' version of some state changes.\r\n   * Changes are reversable when they are boolean.\r\n   * @param changes State changes\r\n   * @returns Reversed state changes\r\n   */\r\n  private reverseChanges(changes: Partial<S>): Partial<S> {\r\n    return Object.entries(changes).reduce((reverseChanges: Partial<S>, bunch: [string, any]) => {\r\n      const [changeKey, value] = bunch;\r\n      if (typeof value === typeof true) {\r\n        (reverseChanges as object)[changeKey] = !value;\r\n      }\r\n      return reverseChanges;\r\n    }, {});\r\n  }\r\n\r\n  /**\r\n   * Return all the keys in that state and in the store it's bound to, if any.\r\n   * @returns Set of keys\r\n   */\r\n  private getAllKeys(): Set<EntityKey> {\r\n    const storeKeys = this.store ? Array.from(this.store.index.keys()) : [];\r\n    return new Set(Array.from(this.index.keys()).concat(storeKeys));\r\n  }\r\n\r\n  /**\r\n   * Emit 'change' event\r\n   */\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject, Observable, Subscription, combineLatest } from 'rxjs';\r\nimport { debounceTime, map, skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils, uuid } from '@igo2/utils';\r\nimport {\r\n  EntityKey,\r\n  EntityFilterClause,\r\n  EntitySortClause,\r\n  EntityJoinClause\r\n} from './entity.interfaces';\r\n\r\n/**\r\n * An entity view streams entities from an observable source. These entities\r\n * can be filtered or sorted without affecting the source. A view can also\r\n * combine data from multiple sources, joined together.\r\n */\r\nexport class EntityView<E extends object, V extends object = E> {\r\n\r\n  /**\r\n   * Observable stream of values\r\n   */\r\n  readonly values$ = new BehaviorSubject<V[]>([]);\r\n\r\n  /**\r\n   * Subscription to the source (and joined sources) values\r\n   */\r\n  private values$$: Subscription;\r\n\r\n  /**\r\n   * Whether this view has been lifted\r\n   */\r\n  private lifted = false;\r\n\r\n  /**\r\n   * Join clauses\r\n   */\r\n  private joins: EntityJoinClause[] = [];\r\n\r\n  /**\r\n   * Observable of a filter clause\r\n   */\r\n  private filter$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Observable of filter clauses\r\n   */\r\n  private filters$: BehaviorSubject<EntityFilterClause[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Filters index\r\n   */\r\n  private filterIndex: Map<string, EntityFilterClause> = new Map();\r\n\r\n  /**\r\n   * Observable of a sort clause\r\n   */\r\n  private sort$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Method for indexing\r\n   */\r\n  get getKey(): (V) => EntityKey { return this.getKey$.value; }\r\n  private getKey$: BehaviorSubject<(V) => EntityKey> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, V> { return this._index; }\r\n  private _index: Map<EntityKey, V>;\r\n\r\n  constructor(private source$: BehaviorSubject<E[]>) {}\r\n\r\n  /**\r\n   * Get a value from the view by key\r\n   * @param key Key\r\n   * @returns Value\r\n   */\r\n  get(key: EntityKey): V {\r\n    if (this._index === undefined) {\r\n      throw new Error('This view has no index, therefore, this method is unavailable.');\r\n    }\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all the values\r\n   * @returns Array of values\r\n   */\r\n  all(): V[] {\r\n    return this.values$.value;\r\n  }\r\n\r\n  /**\r\n   * Observe all the values\r\n   * @returns Observable of values\r\n   */\r\n  all$(): BehaviorSubject<V[]> {\r\n    return this.values$;\r\n  }\r\n\r\n  /**\r\n   * Get the first value that respects a criteria\r\n   * @returns A value\r\n   */\r\n  firstBy(clause: EntityFilterClause<V>): V {\r\n    return this.values$.value.find(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe the first value that respects a criteria\r\n   * @returns Observable of a value\r\n   */\r\n  firstBy$(clause: EntityFilterClause<V>): Observable<V> {\r\n    return this.values$.pipe(map((values: V[]) => values.find(clause)));\r\n  }\r\n\r\n  /**\r\n   * Get all the values that respect a criteria\r\n   * @returns Array of values\r\n   */\r\n  manyBy(clause: EntityFilterClause<V>): V[] {\r\n    return this.values$.value.filter(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe all the values that respect a criteria\r\n   * @returns Observable of values\r\n   */\r\n  manyBy$(clause: EntityFilterClause<V>): Observable<V[]> {\r\n    return this.values$.pipe(map((values: V[]) => values.filter(clause)));\r\n  }\r\n\r\n  /**\r\n   * Clear the filter and sort and unsubscribe from the source\r\n   */\r\n  clear() {\r\n    this.filter(undefined);\r\n    this.sort(undefined);\r\n  }\r\n\r\n  destroy() {\r\n    if (this.values$$ !== undefined) {\r\n      this.values$$.unsubscribe();\r\n    }\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Create an index\r\n   * @param getKey Method to get a value's id\r\n   * @returns The view\r\n   */\r\n  createIndex(getKey: (E) => EntityKey): EntityView<E, V> {\r\n    this._index = new Map();\r\n    this.getKey$.next(getKey);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Join another source to the stream (chainable)\r\n   * @param clause Join clause\r\n   * @returns The view\r\n   */\r\n  join(clause: EntityJoinClause): EntityView<E, V> {\r\n    if (this.lifted === true) {\r\n      throw new Error('This view has already been lifted, therefore, no join is allowed.');\r\n    }\r\n    this.joins.push(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Filter values (chainable)\r\n   * @param clause Filter clause\r\n   * @returns The view\r\n   */\r\n  filter(clause: EntityFilterClause<V>): EntityView<E, V> {\r\n    this.filter$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * @param clause Filter clause\r\n   * @returns The filter id\r\n   */\r\n  addFilter(clause: EntityFilterClause<V>): string {\r\n    const id = uuid();\r\n    this.filterIndex.set(id, clause);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Remove a filter by id\r\n   * @param clause Filter clause\r\n   */\r\n  removeFilter(id: string) {\r\n    this.filterIndex.delete(id);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n  }\r\n\r\n  /**\r\n   * Sort values (chainable)\r\n   * @param clauseSort clause\r\n   * @returns The view\r\n   */\r\n  sort(clause: EntitySortClause<V>): EntityView<E, V> {\r\n    this.sort$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Create the final observable\r\n   * @returns Observable\r\n   */\r\n  lift() {\r\n    this.lifted = true;\r\n    const source$ = this.joins.length > 0 ? this.liftJoinedSource() : this.liftSource();\r\n    const observables$ = [\r\n      source$,\r\n      this.filters$,\r\n      this.filter$,\r\n      this.sort$,\r\n      this.getKey$\r\n    ];\r\n\r\n    this.values$$ = combineLatest(observables$)\r\n      .pipe(skip(1), debounceTime(5))\r\n      .subscribe((bunch: any[]) => {\r\n        const [_values, filters, filter, sort, getKey] = bunch;\r\n        const values = this.processValues(_values, filters, filter, sort);\r\n        const generateIndex = getKey !== undefined;\r\n        this.setValues(values, generateIndex);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when no joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftSource(): Observable<V[]> {\r\n    return this.source$ as any as Observable<V[]>;\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftJoinedSource(): Observable<V[]> {\r\n    const sources$ = [this.source$, combineLatest(\r\n      this.joins.map((join: EntityJoinClause) => join.source)\r\n    )];\r\n\r\n    return combineLatest(sources$)\r\n      .pipe(\r\n        map((bunch: [E[], any[]]) => {\r\n          const [entities, joinData] = bunch;\r\n          return entities.reduce((values: V[], entity: E) => {\r\n            const value = this.computeJoinedValue(entity, joinData);\r\n            if (value !== undefined) {\r\n              values.push(value);\r\n            }\r\n            return values;\r\n          }, []);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Apply joins to a source's entity and return the final value\r\n   * @returns Final value\r\n   */\r\n  private computeJoinedValue(entity: E, joinData: any[]): V | undefined {\r\n    let value = entity as Partial<V>;\r\n    let joinIndex = 0;\r\n    while (value !== undefined && joinIndex < this.joins.length) {\r\n      value = this.joins[joinIndex].reduce(value, joinData[joinIndex]);\r\n      joinIndex += 1;\r\n    }\r\n    return value as V;\r\n  }\r\n\r\n  /**\r\n   * Filter and sort values before streaming them\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @param filter Filter clause\r\n   * @param sort Sort clause\r\n   * @returns Filtered and sorted values\r\n   */\r\n  private processValues(\r\n    values: V[], filters: EntityFilterClause[], filter: EntityFilterClause, sort: EntitySortClause\r\n  ): V[] {\r\n    values = values.slice(0);\r\n    values = this.filterValues(values, filters.concat([filter]));\r\n    values = this.sortValues(values, sort);\r\n    return values;\r\n  }\r\n\r\n  /**\r\n   * Filter values\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @returns Filtered values\r\n   */\r\n  private filterValues(values: V[], clauses: EntityFilterClause[]): V[] {\r\n    if (clauses.length === 0) { return values; }\r\n\r\n    return values\r\n      .filter((value: V) => {\r\n        return clauses\r\n          .filter((clause: EntityFilterClause) => clause !== undefined)\r\n          .every((clause: EntityFilterClause) => clause(value));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Sort values\r\n   * @param values Values\r\n   * @param sort Sort clause\r\n   * @returns Sorted values\r\n   */\r\n  private sortValues(values: V[], clause: EntitySortClause): V[] {\r\n    if (clause === undefined) { return values; }\r\n    return values.sort((v1: V, v2: V) => {\r\n      return ObjectUtils.naturalCompare(\r\n        clause.valueAccessor(v1),\r\n        clause.valueAccessor(v2),\r\n        clause.direction,\r\n        clause.nullsFirst\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set value and optionally generate an index\r\n   * @param values Values\r\n   * @param generateIndex boolean\r\n   */\r\n  private setValues(values: V[], generateIndex: boolean) {\r\n    if (generateIndex === true) {\r\n      this._index = this.generateIndex(values);\r\n    }\r\n\r\n    this.values$.next(values);\r\n\r\n    const count = values.length;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the values\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(values: V[]): Map<EntityKey, V> {\r\n    const entries = values.map((value: V) => [this.getKey(value), value]);\r\n    return new Map(entries as [EntityKey, V][]);\r\n  }\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStateManager } from './state';\r\nimport { EntityView } from './view';\r\nimport { EntityKey, EntityState, EntityRecord, EntityStoreOptions } from './entity.interfaces';\r\nimport { getEntityId, getEntityProperty } from './entity.utils';\r\nimport { EntityStoreStrategy } from './strategies/strategy';\r\n\r\n/**\r\n * An entity store class holds any number of entities\r\n * as well as their state. It can be observed, filtered and sorted and\r\n * provides methods to insert, update or delete entities.\r\n */\r\nexport class EntityStore<E extends object = object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * Observable of the raw entities\r\n   */\r\n  readonly entities$ = new BehaviorSubject<E[]>([]);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Entity store state\r\n   */\r\n  readonly state: EntityStateManager<E, S>;\r\n\r\n  /**\r\n   * View of all the entities\r\n   */\r\n  readonly view: EntityView<E>;\r\n\r\n  /**\r\n   * View of all the entities and their state\r\n   */\r\n  readonly stateView: EntityView<E, EntityRecord<E, S>>;\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  /**\r\n   * Method to get an entity's named property\r\n   */\r\n  readonly getProperty: (E, prop: string) => any;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, E> { return this._index; }\r\n  private _index: Map<EntityKey, E>;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get pristine(): boolean { return this._pristine; }\r\n  private _pristine: boolean = true;\r\n\r\n  /**\r\n   * Strategies\r\n   */\r\n  private strategies: EntityStoreStrategy[] = [];\r\n\r\n  constructor(entities: E[], options: EntityStoreOptions = {}) {\r\n    this.getKey = options.getKey ? options.getKey : getEntityId;\r\n    this.getProperty = options.getProperty ? options.getProperty : getEntityProperty;\r\n\r\n    this.state = this.createStateManager();\r\n    this.view = this.createDataView();\r\n    this.stateView = this.createStateView();\r\n\r\n    this.view.lift();\r\n    this.stateView.lift();\r\n\r\n    if (entities.length > 0) {\r\n      this.load(entities);\r\n    } else {\r\n      this._index = this.generateIndex(entities);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity from the store by key\r\n   * @param key Key\r\n   * @returns Entity\r\n   */\r\n  get(key: EntityKey): E {\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all entities in the store\r\n   * @returns Array of entities\r\n   */\r\n  all(): E[] {\r\n    return this.entities$.value;\r\n  }\r\n\r\n  /**\r\n   * Set this store's entities\r\n   * @param entities Entities\r\n   */\r\n  load(entities: E[], pristine: boolean = true) {\r\n    this._index = this.generateIndex(entities);\r\n    this._pristine = pristine;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities but keep the state and views intact.\r\n   * Views won't return any data but future data will be subject to the\r\n   * current views filter and sort\r\n   */\r\n  softClear() {\r\n    if (this.index && this.index.size > 0) {\r\n      this.index.clear();\r\n      this._pristine = true;\r\n      this.next();\r\n    } else if (this.index) {\r\n      this.updateCount();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities, state and views\r\n   */\r\n  clear() {\r\n    this.stateView.clear();\r\n    this.view.clear();\r\n    this.state.clear();\r\n    this.softClear();\r\n  }\r\n\r\n  destroy() {\r\n    this.stateView.destroy();\r\n    this.view.destroy();\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  insert(entity: E) {\r\n    this.insertMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  insertMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update or insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  update(entity: E) {\r\n    this.updateMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Update or insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  updateMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Delete an entity from the store\r\n   * @param entity Entity\r\n   */\r\n  delete(entity: E) {\r\n    this.deleteMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Delete many entities from the store\r\n   * @param entities Entities\r\n   */\r\n  deleteMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.delete(this.getKey(entity)));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Add a strategy to this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  addStrategy(strategy: EntityStoreStrategy, activate: boolean = false): EntityStore {\r\n    const existingStrategy = this.strategies.find((_strategy: EntityStoreStrategy) => {\r\n      return strategy.constructor === _strategy.constructor;\r\n    });\r\n    if (existingStrategy !== undefined) {\r\n      throw new Error('A strategy of this type already exists on that EntityStore.');\r\n    }\r\n\r\n    this.strategies.push(strategy);\r\n    strategy.bindStore(this);\r\n\r\n    if (activate === true) {\r\n      strategy.activate();\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove a strategy from this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  removeStrategy(strategy: EntityStoreStrategy): EntityStore {\r\n    const index = this.strategies.indexOf(strategy);\r\n    if (index >= 0) {\r\n      this.strategies.splice(index, 1);\r\n      strategy.unbindStore(this);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Return strategies of a given type\r\n   * @param type Entity store strategy class\r\n   * @returns Strategies\r\n   */\r\n  getStrategyOfType(type: typeof EntityStoreStrategy): EntityStoreStrategy {\r\n    return this.strategies.find((strategy: EntityStoreStrategy) => {\r\n      return strategy instanceof type;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  activateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  deactivateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the entities\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(entities: E[]): Map<EntityKey, E> {\r\n    const entries = entities.map((entity: E) => [this.getKey(entity), entity]);\r\n    return new Map(entries as [EntityKey, E][]);\r\n  }\r\n\r\n  /**\r\n   * Push the index's entities into the entities$ observable\r\n   */\r\n  private next() {\r\n    this.entities$.next(Array.from(this.index.values()));\r\n    this.updateCount();\r\n  }\r\n\r\n  /**\r\n   * Update the store's count and empty\r\n   */\r\n  private updateCount() {\r\n    const count = this.index.size;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Create the entity state manager\r\n   * @returns EntityStateManager\r\n   */\r\n  private createStateManager() {\r\n    return new EntityStateManager<E, S>({store: this});\r\n  }\r\n\r\n  /**\r\n   * Create the data view\r\n   * @returns EntityView<E>\r\n   */\r\n  private createDataView() {\r\n    return new EntityView<E>(this.entities$);\r\n  }\r\n\r\n  /**\r\n   * Create the state view\r\n   * @returns EntityView<EntityRecord<E>>\r\n   */\r\n  private createStateView() {\r\n    return new EntityView<E, EntityRecord<E, S>>(this.view.all$())\r\n      .join({\r\n        source: this.state.change$,\r\n        reduce: (entity: E): EntityRecord<E, S> => {\r\n          const key = this.getKey(entity);\r\n          const state = this.state.get(entity);\r\n          const currentRecord = this.stateView.get(key);\r\n\r\n          if (\r\n            currentRecord !== undefined &&\r\n            currentRecord.entity === entity &&\r\n            this.statesAreTheSame(currentRecord.state, state)\r\n          ) {\r\n            return currentRecord;\r\n          }\r\n\r\n          const revision = currentRecord ? currentRecord.revision + 1 : 1;\r\n          const ref = `${key}-${revision}`;\r\n          return {entity, state, revision, ref};\r\n        }\r\n      })\r\n      .createIndex((record: EntityRecord<E, S>) => this.getKey(record.entity));\r\n  }\r\n\r\n  private statesAreTheSame(currentState: S, newState: S): boolean {\r\n    if (currentState === newState) {\r\n      return true;\r\n    }\r\n\r\n    const currentStateIsEmpty = Object.keys(currentState).length === 0;\r\n    const newStateIsEmpty = Object.keys(newState).length === 0;\r\n    return currentStateIsEmpty && newStateIsEmpty;\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to synchronize a component's changes\r\n * detection with an EntityStore changes. For example, it is frequent\r\n * to have a component subscribe to a store's selected entity and, at the same time,\r\n * this component provides a way to select an entity with, let's say, a click.\r\n *\r\n * This class automatically handles those case and triggers the compoent's\r\n * change detection when needed.\r\n *\r\n * Note: If the component observes the store's stateView, a workspace is\r\n * probably not required because the stateView catches any changes to the\r\n * entities and their state.\r\n */\r\nexport class EntityStoreWatcher<E extends object> {\r\n\r\n  /**\r\n   * Component change detector\r\n   */\r\n  private cdRef: ChangeDetectorRef;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  private store: EntityStore<E>;\r\n\r\n  /**\r\n   * Component inner state\r\n   */\r\n  private innerStateIndex = new Map<EntityKey, {[key: string]: any}>();\r\n\r\n  /**\r\n   * Subscription to the store's entities\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the store's state\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  constructor(store?: EntityStore<E>, cdRef?: ChangeDetectorRef) {\r\n    this.setChangeDetector(cdRef);\r\n    this.setStore(store);\r\n  }\r\n\r\n  destroy() {\r\n    this.setChangeDetector(undefined);\r\n    this.setStore(undefined);\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a store and start watching for changes\r\n   * @param store Entity store\r\n   */\r\n  setStore(store?: EntityStore<E>) {\r\n    if (store === undefined) {\r\n      this.teardownObservers();\r\n      this.innerStateIndex.clear();\r\n      this.store = undefined;\r\n      return;\r\n    }\r\n\r\n    this.setStore(undefined);\r\n    this.store = store;\r\n    this.setupObservers();\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a component's change detector\r\n   * @param cdRef Change detector\r\n   */\r\n  setChangeDetector(cdRef?: ChangeDetectorRef) {\r\n    this.cdRef = cdRef;\r\n  }\r\n\r\n  /**\r\n   * Set up observers on a store's entities and their state\r\n   * @param store Entity store\r\n   */\r\n  private setupObservers() {\r\n    this.teardownObservers();\r\n\r\n    this.entities$$ = this.store.entities$\r\n      .subscribe((entities: E[]) => this.onEntitiesChange(entities));\r\n\r\n    this.state$$ = this.store.state.change$\r\n      .pipe(skip(1))\r\n      .subscribe(() => this.onStateChange());\r\n  }\r\n\r\n  /**\r\n   * Teardown store observers\r\n   */\r\n  private teardownObservers() {\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n    this.entities$$ = undefined;\r\n    this.state$$ = undefined;\r\n  }\r\n\r\n  /**\r\n   * When the entities change, always trigger the changes detection\r\n   */\r\n  private onEntitiesChange(entities: E[]) {\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * When the entities state change, trigger the change detection\r\n   * only if the component has not handled these changes yet. For example,\r\n   * the component might have initiated thoses changes itself.\r\n   */\r\n  private onStateChange() {\r\n    let changesDetected = false;\r\n    const storeIndex = this.store.state.index;\r\n    const innerIndex = this.innerStateIndex;\r\n\r\n    if (storeIndex.size !== innerIndex.size) {\r\n      changesDetected = this.detectChanges();\r\n    }\r\n\r\n    const storeKeys = Array.from(storeIndex.keys());\r\n    for (const key of storeKeys) {\r\n      const storeValue = storeIndex.get(key);\r\n      const innerValue = innerIndex.get(key);\r\n      if (changesDetected === false) {\r\n        if (innerValue === undefined) {\r\n          changesDetected = this.detectChanges();\r\n        } else if (!ObjectUtils.objectsAreEquivalent(storeValue, innerValue)) {\r\n          changesDetected = this.detectChanges();\r\n        }\r\n      }\r\n\r\n      this.innerStateIndex.set(key, Object.assign({}, storeValue));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger the change detection of the workspace is bound to a change detector\r\n   */\r\n  private detectChanges() {\r\n    if (this.cdRef !== undefined) {\r\n      this.cdRef.detectChanges();\r\n    }\r\n    return true;\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStoreStrategyOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\n\r\n/**\r\n * Entity store strategies. They can do pretty much anything during a store's\r\n * lifetime. For example, they may act as triggers when something happens.\r\n * Sharing a strategy is a good idea when multiple strategies would have\r\n * on cancelling effect on each other.\r\n *\r\n * At creation, strategy is inactive and needs to be manually activated.\r\n */\r\nexport class EntityStoreStrategy {\r\n\r\n  /**\r\n   * Feature store\r\n   * @internal\r\n   */\r\n  protected stores: EntityStore[] = [];\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  constructor(protected options: EntityStoreStrategyOptions = {}) {\r\n    this.options = options;\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.doDeactivate();\r\n    }\r\n    this.active$.next(true);\r\n    this.doActivate();\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.doDeactivate();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    if (this.stores.indexOf(store) < 0) {\r\n      this.stores.push(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from store\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    const index = this.stores.indexOf(store);\r\n    if (index >= 0) {\r\n      this.stores.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Do the stataegy activation\r\n   * @internal\r\n   */\r\n  protected doActivate() {}\r\n\r\n  /**\r\n   * Do the strategy deactivation\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {}\r\n\r\n}\r\n","import { EntityStoreStrategyFuncOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterCustomFuncStrategy extends EntityStoreStrategy {\r\n\r\n  constructor(protected options: EntityStoreStrategyFuncOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    this.filters.set(store, store.stateView.addFilter(this.options.filterClauseFunc));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","import { EntityRecord } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterSelectionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    if (this.filters.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const filter = (record: EntityRecord<object>) => {\r\n      return record.state.selected === true;\r\n    };\r\n    this.filters.set(store, store.stateView.addFilter(filter));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","<mat-form-field class=\"igo-entity-selector\">\r\n  <mat-select\r\n    [disabled]=\"disabled\"\r\n    [value]=\"selected$ | async\"\r\n    [multiple]=\"multi\"\r\n    [placeholder]=\"placeholder\"\r\n    (selectionChange)=\"onSelectionChange($event)\">\r\n    <mat-option *ngIf=\"emptyText !== undefined && multi === false\" [value]=\"emptyValue\">{{emptyText}}</mat-option>\r\n    <mat-option *ngIf=\"multi === true\" [value]=\"multiSelectValue\">{{multiText$ | async}}</mat-option>\r\n    <ng-template ngFor let-record [ngForOf]=\"store.stateView.all$() | async\">\r\n      <mat-option [value]=\"record.entity\">\r\n        {{titleAccessor(record.entity)}}\r\n      </mat-option>\r\n    </ng-template>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { EntityRecord } from '../shared/entity.interfaces';\r\nimport { EntityStore } from '../shared/store';\r\nimport { EntityStoreWatcher } from '../shared/watcher';\r\nimport { getEntityTitle } from '../shared/entity.utils';\r\n\r\n@Component({\r\n  selector: 'igo-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * The selected entity\r\n   * @internal\r\n   */\r\n  readonly selected$ = new BehaviorSubject<object>(undefined);\r\n\r\n  /**\r\n   * The current multi select option text\r\n   * @internal\r\n   */\r\n  readonly multiText$ = new BehaviorSubject<string>(undefined);\r\n\r\n  readonly multiSelectValue = {id: 'IGO_MULTI_SELECT'};\r\n\r\n  readonly emptyValue = {id: 'IGO_EMPTY_SELECT'};\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private selected$$: Subscription;\r\n\r\n  /**\r\n   * Store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<object>;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Title accessor\r\n   */\r\n  @Input() titleAccessor: (object) => string = getEntityTitle;\r\n\r\n  /**\r\n   * Text to display when nothing is selected\r\n   */\r\n  @Input() emptyText: string = undefined;\r\n\r\n  /**\r\n   * Wheter selecting many entities is allowed\r\n   */\r\n  @Input() multi: boolean = false;\r\n\r\n  /**\r\n   * Text to display for the select all option\r\n   */\r\n  @Input() multiAllText: string = 'All';\r\n\r\n  /**\r\n   * Text to display for the select none option\r\n   */\r\n  @Input() multiNoneText: string = 'None';\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Wheter the selector is disabled or not\r\n   */\r\n  @Input() disabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the selection changes\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: object | object[];\r\n  }>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Create a store watcher and subscribe to the selected entity\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.selected$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const entities = records.map((record: EntityRecord<object>) => record.entity);\r\n        this.onSelectFromStore(entities);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the selected entity and destroy the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.selected$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On selection change, update the store's state and emit an event\r\n   * @internal\r\n   */\r\n  onSelectionChange(event: {value: object | undefined}) {\r\n    const values = event.value instanceof Array ? event.value : [event.value];\r\n\r\n    const multiSelect = values.find((_value: object) => _value === this.multiSelectValue);\r\n    let entities = values.filter((_value: object) => _value !== this.multiSelectValue);\r\n    if (multiSelect !== undefined) {\r\n      if (entities.length === this.store.count) {\r\n        entities = [];\r\n      } else if (entities.length < this.store.count) {\r\n        entities = this.store.all();\r\n      }\r\n    }\r\n\r\n    entities = entities.filter((entity: object) => entity !== this.emptyValue);\r\n    if (entities.length === 0) {\r\n      this.store.state.updateAll({selected: false});\r\n    } else {\r\n      this.store.state.updateMany(entities, {selected: true}, true);\r\n    }\r\n\r\n    const value = this.multi ? entities : event.value;\r\n    this.selectedChange.emit({selected: true, value});\r\n  }\r\n\r\n  private onSelectFromStore(entities: object[]) {\r\n    if (this.multi === true) {\r\n      this.selected$.next(entities);\r\n    } else {\r\n      const entity = entities.length > 0 ? entities[0] : undefined;\r\n      this.selected$.next(entity);\r\n    }\r\n\r\n    this.updateMultiToggleWithEntities(entities);\r\n  }\r\n\r\n  private updateMultiToggleWithEntities(entities: object[]) {\r\n    if (entities.length === this.store.count && this.multiText$.value !== this.multiNoneText) {\r\n      this.multiText$.next(this.multiNoneText);\r\n    } else if (entities.length < this.store.count && this.multiText$.value !== this.multiAllText) {\r\n      this.multiText$.next(this.multiAllText);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Directive, HostListener } from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoStopPropagation]'\r\n})\r\nexport class StopPropagationDirective {\r\n  @HostListener('click', ['$event'])\r\n  public onClick(event: any): void {\r\n    event.stopPropagation();\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport {\r\n  EntityStore\r\n} from '../shared';\r\nimport { MatPaginator, PageEvent } from '@angular/material/paginator';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityTablePaginatorOptions } from './entity-table-paginator.interface';\r\n\r\n@Component({\r\n  selector: 'igo-entity-table-paginator',\r\n  templateUrl: './entity-table-paginator.component.html',\r\n  styleUrls: ['./entity-table-paginator.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntityTablePaginatorComponent implements OnChanges, OnDestroy {\r\n\r\n  public disabled: boolean = false;\r\n  public hidePageSize: boolean = false;\r\n  public pageIndex: number = 0;\r\n  public pageSize: number = 50;\r\n  public pageSizeOptions: number[] = [5, 10, 20, 50, 100, 200];\r\n  public showFirstLastButtons: boolean = true;\r\n  private count$$: Subscription;\r\n  private entitySortChange$$: Subscription;\r\n  private paginationLabelTranslation$$: Subscription[] = [];\r\n\r\n  @Input() entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when the paginator changes the page size or page index.\r\n   */\r\n  @Output() page: EventEmitter<PageEvent>;\r\n\r\n  public length: number = 0;\r\n\r\n  /**\r\n   * Paginator emitted.\r\n   */\r\n  @Output() paginatorChange: EventEmitter<MatPaginator> = new EventEmitter<MatPaginator>();\r\n\r\n  constructor(private languageService: LanguageService, private mediaService: MediaService) {}\r\n\r\n  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;\r\n\r\n  ngOnChanges() {\r\n    this.unsubscribeAll();\r\n    this.count$$ = this.store.stateView.count$.subscribe((count) => {\r\n      this.length = count;\r\n      this.emitPaginator();\r\n    });\r\n    this.entitySortChange$$ = this.entitySortChange$.subscribe(() => {\r\n      if (this.paginator) {\r\n        this.paginator.firstPage();\r\n      }\r\n    });\r\n    this.initPaginatorOptions();\r\n    this.translateLabels();\r\n  }\r\n\r\n  initPaginatorOptions() {\r\n    this.disabled = this.paginatorOptions?.disabled || this.disabled;\r\n    this.pageIndex = this.paginatorOptions?.pageIndex || this.pageIndex;\r\n    this.pageSize = this.paginatorOptions?.pageSize || this.pageSize;\r\n    this.pageSizeOptions = this.paginatorOptions?.pageSizeOptions || this.pageSizeOptions;\r\n    if (this.mediaService.isMobile()) {\r\n      this.showFirstLastButtons = false;\r\n      this.hidePageSize = true;\r\n    } else {\r\n      this.showFirstLastButtons = this.paginatorOptions?.showFirstLastButtons || this.showFirstLastButtons;\r\n      this.hidePageSize = this.paginatorOptions?.hidePageSize || this.hidePageSize;\r\n    }\r\n  }\r\n\r\n  translateLabels() {\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.firstPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.firstPageLabel = label;\r\n      }));\r\n\r\n    this.paginator._intl.getRangeLabel = this.rangeLabel;\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.itemsPerPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.itemsPerPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.lastPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.lastPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.nextPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.nextPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.previousPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.previousPageLabel = label;\r\n      }));\r\n  }\r\n\r\n  rangeLabel = (page: number, pageSize: number, length: number) => {\r\n    const of: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.of').subscribe((label: string) => {\r\n        of.next(label);\r\n      }));\r\n    if (length === 0 || pageSize === 0) { return `0 ${of.value} ${length}`; }\r\n    length = Math.max(length, 0);\r\n    const startIndex = page * pageSize;\r\n    const endIndex = startIndex < length ?\r\n        Math.min(startIndex + pageSize, length) :\r\n        startIndex + pageSize;\r\n    return `${startIndex + 1} - ${endIndex} ${of.value} ${length}`;\r\n  };\r\n\r\n  private unsubscribeAll() {\r\n    this.paginationLabelTranslation$$.map(sub => sub.unsubscribe());\r\n    if (this.count$$) { this.count$$.unsubscribe(); }\r\n    if (this.entitySortChange$$) { this.entitySortChange$$.unsubscribe(); }\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  emitPaginator() {\r\n    this.paginatorChange.emit(this.paginator);\r\n  }\r\n}\r\n","<mat-paginator \r\n  [disabled]=\"disabled\"\r\n  [hidePageSize]=\"hidePageSize\"\r\n  [length]=\"length\"\r\n  [pageIndex]=\"pageIndex\"\r\n  [pageSize]=\"pageSize\"\r\n  [pageSizeOptions]=\"pageSizeOptions\"\r\n  [showFirstLastButtons]=\"showFirstLastButtons\"\r\n  (page)=\"emitPaginator()\">\r\n</mat-paginator>\r\n","import {\r\n  Directive,\r\n  HostListener,\r\n  Input,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoImageError]'\r\n})\r\nexport class ImageErrorDirective {\r\n\r\n  @Input() errorImageUrl: string = './assets/igo2/common/images/na.png';\r\n  @Input() hideError: boolean = false;\r\n\r\n  constructor(private el: ElementRef) {}\r\n\r\n  @HostListener(\"error\", ['$event'])\r\n  public onError(event: any): void {\r\n    if (this.hideError) {\r\n      this.el.nativeElement.style.display = \"none\";\r\n    } else {\r\n      event.target.src = this.errorImageUrl;\r\n    }\r\n\r\n  }\r\n\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  ElementRef,\r\n  Renderer2,\r\n  EventEmitter,\r\n  Output,\r\n  HostListener\r\n} from '@angular/core';\r\n\r\nimport scrollIntoView from 'scroll-into-view-if-needed';\r\n\r\nimport { EntityTableScrollBehavior } from '../shared/entity.enums';\r\n\r\n/**\r\n * Directive that handles an entity table row click and selection.\r\n */\r\n@Directive({\r\n  selector: '[igoEntityTableRow]'\r\n})\r\nexport class EntityTableRowDirective {\r\n\r\n  /**\r\n   * Class added to a selected row\r\n   */\r\n  static selectedCls = 'igo-entity-table-row-selected';\r\n\r\n  /**\r\n   * Class added to a highlighted row\r\n   */\r\n  static highlightedCls = 'igo-entity-table-row-highlighted';\r\n\r\n  /**\r\n   * Whether a row supports selection\r\n   */\r\n  @Input() selection = false;\r\n\r\n  /**\r\n   * Whether clicking a row should select it (if selection is true)\r\n   */\r\n  @Input() selectOnClick: boolean = true;\r\n\r\n  /**\r\n   * Whether the selected row should be highlighted\r\n   */\r\n  @Input() highlightSelection: boolean = true;\r\n\r\n  /**\r\n   * Whether a row is selected\r\n   */\r\n  @Input()\r\n  set selected(value: boolean) {\r\n    if (this.selection === false) { return; }\r\n    if (value === this._selected) { return; }\r\n\r\n    this.toggleSelected(value);\r\n    this.scroll();\r\n  }\r\n  get selected(): boolean {\r\n    return this._selected;\r\n  }\r\n  private _selected = false;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Event emitted when a row is selected\r\n   */\r\n  @Output() select = new EventEmitter<EntityTableRowDirective>();\r\n\r\n  /**\r\n   * When a row is clicked, select it if it's supported\r\n   * @ignore\r\n   */\r\n  @HostListener('click')\r\n  onClick() {\r\n    if (this.selection === false || this.selectOnClick === false) {\r\n      return;\r\n    }\r\n\r\n    this.toggleSelected(true);\r\n    this.select.emit(this);\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  /**\r\n   * Select a row and add or remove the selected class from it\r\n   * @param selected Whether the row should be selected\r\n   */\r\n  private toggleSelected(selected: boolean) {\r\n    this._selected = selected;\r\n    if (selected === true) {\r\n      this.addCls(EntityTableRowDirective.selectedCls);\r\n      if (this.highlightSelection === true) {\r\n        this.addCls(EntityTableRowDirective.highlightedCls);\r\n      }\r\n    } else {\r\n      this.removeCls(EntityTableRowDirective.selectedCls);\r\n      this.removeCls(EntityTableRowDirective.highlightedCls);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scroll to the selected row\r\n   */\r\n  private scroll() {\r\n    if (this._selected === true) {\r\n      scrollIntoView(this.el.nativeElement, {\r\n        scrollMode: 'if-needed',\r\n        behavior: 'smooth',\r\n        block: 'end',\r\n        inline: 'nearest'\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the selected CSS class\r\n   */\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  /**\r\n   * Remove the selected CSS class\r\n   */\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { DomSanitizer, SafeHtml } from '@angular/platform-browser';\r\n\r\n@Pipe({ name: 'sanitizeHtml' })\r\nexport class SanitizeHtmlPipe implements PipeTransform {\r\n  constructor(private _sanitizer: DomSanitizer) {\r\n  }\r\n  transform(v: string): SafeHtml {\r\n    return this._sanitizer.bypassSecurityTrustHtml(v);\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\nimport { Observable } from 'rxjs';\r\nimport { catchError, switchMap } from 'rxjs/operators';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Pipe({\r\n  name: 'secureImage'\r\n})\r\nexport class SecureImagePipe implements PipeTransform {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private configService?: ConfigService) {}\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  transform(url: string): Observable<string> {\r\n    const headers = new HttpHeaders({\r\n      'Content-Type': 'text/plain',\r\n      activityInterceptor: 'false',\r\n      interceptError: 'false'\r\n    });\r\n\r\n    const regexDepot = new RegExp(this.configService?.getConfig('depot.url') + '.*?(?=\"|$)');\r\n    if (regexDepot.test(url)) {\r\n      url = url.match(regexDepot)[0];\r\n    }\r\n\r\n    return this.http\r\n      .get(url, {\r\n        headers,\r\n        responseType: 'blob'\r\n      })\r\n      .pipe(\r\n        catchError((err) => {\r\n          err.error.caught = true;\r\n          err.error.toDisplay = false;\r\n          throw err;\r\n        }),\r\n        switchMap((blob) => {\r\n          return new Observable((observer) => {\r\n            const reader = new FileReader();\r\n            reader.readAsDataURL(blob);\r\n            reader.onloadend = () => {\r\n              observer.next(reader.result);\r\n              observer.complete();\r\n            };\r\n          });\r\n        })\r\n      ) as Observable<string>;\r\n  }\r\n}\r\n","<div class=\"table-container\" [ngStyle]=\"{'height': tableHeight}\">\r\n  <table mat-table matSort [ngClass]=\"getTableClass()\" [dataSource]=\"dataSource\" [trackBy]=\"getTrackByFunction()\" (matSortChange)=\"onSort($event)\">\r\n      <ng-container matColumnDef=\"selectionCheckbox\" class=\"mat-cell-checkbox\">\r\n          <th mat-header-cell *matHeaderCellDef>\r\n              <ng-container *ngIf=\"selectMany\">\r\n                  <ng-container *ngIf=\"selectionState$ | async as selectionState\">\r\n                      <mat-checkbox (change)=\"onToggleRows($event.checked)\" [checked]=\"selectionState === entityTableSelectionState.All\"\r\n                      [indeterminate]=\"selectionState === entityTableSelectionState.Some\">\r\n                      </mat-checkbox>\r\n                  </ng-container>\r\n              </ng-container>\r\n          </th>\r\n          <td mat-cell *matCellDef=\"let record\">\r\n              <mat-checkbox (mousedown)=\"$event.shiftKey ? $event.preventDefault() : null\" (click)=\"$event.shiftKey ?\r\n              onShiftToggleRow(!rowIsSelected(record), record, $event) : $event.stopPropagation()\" (change)=\"onToggleRow($event.checked,record)\"\r\n              [checked]=\"rowIsSelected(record)\">\r\n              </mat-checkbox>\r\n          </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]=\"column.name\" *ngFor=\"let column of template.columns\">\r\n          <ng-container *ngIf=\"columnIsSortable(column)\">\r\n              <th mat-header-cell *matHeaderCellDef mat-sort-header [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                  {{column.title}}\r\n              </th>\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"!columnIsSortable(column)\">\r\n              <th mat-header-cell *matHeaderCellDef [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                  {{column.title}}\r\n              </th>\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"getColumnRenderer(column) as columnRenderer\">\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Default\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlDefault\" [ngClass]=\"getCellClass(record, column)\">\r\n                          {{getValue(record, column)}}\r\n                      </td>\r\n                      <ng-template #isAnUrlDefault>\r\n                          <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                              <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                  <img igoImageError *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                  <ng-template #notImg><span>{{\r\n                    'igo.common.entity-table.targetHtmlUrl' | translate }}\r\n                  </span></ng-template>\r\n                              </a>\r\n                          </td>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.HTML\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                      [innerHTML]=\"getValue(record, column)\">\r\n                      </td>\r\n                      <ng-template #isAnUrlHTML>\r\n                          <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                              <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                  <img igoImageError *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                  <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' |\r\n                    translate }} </span></ng-template>\r\n                              </a>\r\n                          </td>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.UnsanitizedHTML\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text edition\" [formGroup]=\"formGroup\" *ngIf=\"isEdition(record);else isUnsanitizedHTML\"\r\n                      [ngClass]=\"getCellClass(record, column)\">\r\n                          <div class=\"date-picker\" *ngIf=\"column.type === 'date'\">\r\n                              <mat-datepicker-toggle matSuffix [for]=\"picker\"></mat-datepicker-toggle>\r\n                              <input matInput [matDatepicker]=\"picker\" [formControlName]=\"column.name\" value=\"{{getValue(record, column)}}\"\r\n                              (dateChange)=\"onDateChange(column.name, record, $event)\">\r\n                              <mat-datepicker #picker></mat-datepicker>\r\n                          </div>\r\n                          <input matInput type=\"time\" *ngIf=\"column.type === 'time'\" [formControlName]=\"column.name\" step=\"900\" (focus)=\"column.onFocus($event)\"\r\n                          (keypress)=\"column.onChange($event)\" (blur)=\"column.onBlur($event)\">\r\n                          <input matInput type=\"number\" class=\"class_number_edition\" *ngIf=\"column.type === 'number'\" [formControlName]=\"column.name\" step=\"{{column.step}}\"\r\n                          value=\"{{getValue(record,column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                          readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                          min=\"{{getValidationAttributeValue(column, 'minValue')}}\" max=\"{{getValidationAttributeValue(column, 'maxValue')}}\">\r\n                          <input matInput type=\"text\" *ngIf=\"!column.type || column.type ==='string'\" [formControlName]=\"column.name\"\r\n                          value=\"{{getValue(record, column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                          readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\">\r\n                          <mat-checkbox *ngIf=\"column.type === 'boolean'\" [formControlName]=\"column.name\" [checked]=\"getValue(record,column)\"\r\n                          (change)=\"onBooleanValueChange(column.name, record,$event)\"></mat-checkbox>\r\n                          <mat-select *ngIf=\"column.type === 'list'\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                          [formControlName]=\"column.name\" [multiple]=\"column.multiple\" (selectionChange)=\"onSelectValueChange(column.name, record, $event)\"\r\n                          [value]=\"getValue(record, column)\">\r\n                              <mat-option *ngFor=\"let option of column.domainValues\" [value]=\"option.id\" [disabled]=\"option.disabled\">\r\n                                  {{ option.value }}\r\n                              </mat-option>\r\n                          </mat-select>\r\n                          <input matInput type=\"text\" [formControlName]=\"column.name\" *ngIf=\"column.type === 'autocomplete'\" [matAutocomplete]=\"auto\"\r\n                            required=\"{{getValidationAttributeValue(column, 'mandatory')}}\" value=\"{{getValue(record, column)}}\"\r\n                            readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\">\r\n                                <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onAutocompleteValueChange(column, record, $event)\"\r\n                                panelWidth=\"430px\">\r\n                                    <mat-option *ngFor=\"let option of filteredOptions[column.name] | async\"\r\n                                        [value]=\"option.id\">\r\n                                        {{ option.value }}\r\n                                    </mat-option>\r\n                                </mat-autocomplete>\r\n                      </td>\r\n                      <ng-template #isUnsanitizedHTML>\r\n                          <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlUnsanitizedHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                          [innerHTML]=\"getValue(record, column) | sanitizeHtml\">\r\n                          </td>\r\n                          <ng-template #isAnUrlUnsanitizedHTML>\r\n                              <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                                  <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                      <img igoImageError *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                      <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' | translate }} </span></ng-template>\r\n                                  </a>\r\n                              </td>\r\n                          </ng-template>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Icon\">\r\n                  <td mat-cell *matCellDef=\"let record\" class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                      <mat-icon *ngIf=\"column.onClick\" svgIcon=\"{{getValue(record, column)|| column.icon}}\" (click)=\"column.onClick($event)\"></mat-icon>\r\n                      <mat-icon *ngIf=\"!column.onClick\" svgIcon=\"{{getValue(record, column)|| column.icon}}\"></mat-icon>\r\n                  </td>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.ButtonGroup\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                          <span *ngFor=\"let button of getValue(record, column)\">\r\n                              <ng-container *ngIf=\"isEdition(record) === button.editMode || button.editMode === undefined\">\r\n                                  <button *ngIf=\"button.style === 'mat-icon-button'\" igoStopPropagation mat-icon-button\r\n                                      [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                      <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                  </button>\r\n                                  <button *ngIf=\"button.style !== 'mat-icon-button'\" igoStopPropagation mat-mini-fab\r\n                                      [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                      <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                  </button>\r\n                              </ng-container>\r\n                          </span>\r\n                      </td>\r\n                  </ng-container>\r\n              </ng-container>\r\n          </ng-container>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef=\"headers; sticky: fixedHeader\" [ngClass]=\"getHeaderClass()\">\r\n      </tr>\r\n      <tr mat-row igoEntityTableRow *matRowDef=\"let record; columns: headers;\" [scrollBehavior]=\"scrollBehavior\" [ngClass]=\"getRowClass(record)\" [selection]=\"selection\" [selected]=\"rowIsSelected(record)\" (select)=\"onRowSelect(record)\" (click)=\"onRowClick(record)\">\r\n      </tr>\r\n  </table>\r\n  <igo-entity-table-paginator *ngIf=\"withPaginator\" [store]=\"store\" [paginatorOptions]=\"paginatorOptions\" [entitySortChange$]=\"entitySortChange$\" (paginatorChange)=\"paginatorChange($event)\">\r\n  </igo-entity-table-paginator>\r\n</div>","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ElementRef,\r\n  Optional,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Observable, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  EntityKey,\r\n  EntityRecord,\r\n  EntityState,\r\n  EntityStore,\r\n  EntityTableTemplate,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer,\r\n  EntityTableSelectionState,\r\n  EntityTableScrollBehavior\r\n} from '../shared';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { MatTableDataSource } from '@angular/material/table';\r\nimport { EntityTablePaginatorOptions } from '../entity-table-paginator/entity-table-paginator.interface';\r\nimport { MatFormFieldControl } from '@angular/material/form-field';\r\nimport { UntypedFormBuilder, NgControl, NgForm, FormControlName, UntypedFormGroup } from '@angular/forms';\r\nimport { FocusMonitor } from '@angular/cdk/a11y';\r\nimport { DateAdapter, ErrorStateMatcher } from '@angular/material/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { default as moment } from 'moment';\r\n\r\n@Component({\r\n  selector: 'igo-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  providers: [{ provide: MatFormFieldControl, useExisting: EntityTableComponent }]\r\n})\r\nexport class EntityTableComponent implements OnInit, OnChanges, OnDestroy {\r\n\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public formGroup: UntypedFormGroup = new UntypedFormGroup({});\r\n\r\n  public filteredOptions = {};\r\n\r\n  /**\r\n   * Reference to the column renderer types\r\n   * @internal\r\n   */\r\n  entityTableColumnRenderer = EntityTableColumnRenderer;\r\n\r\n  /**\r\n   * Reference to the selection's state\r\n   * @internal\r\n   */\r\n  entityTableSelectionState = EntityTableSelectionState;\r\n\r\n  /**\r\n   * Observable of the selection,s state\r\n   * @internal\r\n   */\r\n  readonly selectionState$: BehaviorSubject<EntityTableSelectionState> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the store's selection\r\n   */\r\n  private selection$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the dataSource\r\n   */\r\n  private dataSource$$: Subscription;\r\n\r\n  /**\r\n   * The last record checked. Useful for selecting\r\n   * multiple records by holding the shift key and checking\r\n   * checkboxes.\r\n   */\r\n  private lastRecordCheckedKey: EntityKey;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Table paginator\r\n   */\r\n  @Input() set paginator(value: MatPaginator) {\r\n    this._paginator = value;\r\n    this.dataSource.paginator = value;\r\n  }\r\n\r\n  get paginator(): MatPaginator {\r\n    return this._paginator;\r\n  }\r\n  private _paginator: MatPaginator;\r\n\r\n  /**\r\n   * Table template\r\n   */\r\n  @Input() template: EntityTableTemplate;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Whether nulls should be first when sorting\r\n   */\r\n  @Input()\r\n  sortNullsFirst: boolean = false;\r\n\r\n  /**\r\n   * Show the table paginator or not. False by default.\r\n   */\r\n  @Input()\r\n  withPaginator: boolean = false;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is clicked\r\n   */\r\n  @Output() entityClick = new EventEmitter<object>();\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is selected\r\n   */\r\n  @Output() entitySelectChange = new EventEmitter<{\r\n    added: object[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the table sort is changed.\r\n   */\r\n  @Output() entitySortChange: EventEmitter<{column: EntityTableColumn, direction: string}> = new EventEmitter(undefined);\r\n\r\n  /**\r\n   * Table headers\r\n   * @internal\r\n   */\r\n  get headers(): string[] {\r\n    let columns = this.template.columns\r\n      .filter((column: EntityTableColumn) => column.visible !== false)\r\n      .map((column: EntityTableColumn) => column.name);\r\n\r\n    if (this.selectionCheckbox === true) {\r\n      columns = ['selectionCheckbox'].concat(columns);\r\n    }\r\n\r\n    return columns;\r\n  }\r\n\r\n  /**\r\n   * Data source consumable by the underlying material table\r\n   * @internal\r\n   */\r\n  dataSource = new MatTableDataSource<object>();\r\n\r\n  /**\r\n   * Whether selection is supported\r\n   * @internal\r\n   */\r\n  get selection(): boolean { return this.template.selection || false; }\r\n\r\n  /**\r\n   * Whether a selection checkbox should be displayed\r\n   * @internal\r\n   */\r\n  get selectionCheckbox(): boolean { return this.template.selectionCheckbox || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get selectMany(): boolean { return this.template.selectMany || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get fixedHeader(): boolean { return this.template.fixedHeader === undefined ? true : this.template.fixedHeader; }\r\n\r\n  get tableHeight(): string { return this.template.tableHeight ? this.template.tableHeight : 'auto'; }\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n    private formBuilder: UntypedFormBuilder,\r\n    protected _focusMonitor: FocusMonitor,\r\n    protected _elementRef: ElementRef<HTMLElement>,\r\n    @Optional() @Self() public ngControl: NgControl,\r\n    @Optional() protected _parentForm: NgForm,\r\n    @Optional() protected _controlName: FormControlName,\r\n    protected _defaultErrorStateMatcher: ErrorStateMatcher,\r\n    private dateAdapter: DateAdapter<Date>\r\n  ) {\r\n    this.dateAdapter.setLocale('fr-CA');\r\n  }\r\n\r\n  /**\r\n   * Track the selection state to properly display the selection checkboxes\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.handleDatasource();\r\n    this.dataSource.paginator = this.paginator;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      this.handleDatasource();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process text or number value change (edition)\r\n   */\r\n  onValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.target.value;\r\n  }\r\n\r\n  /**\r\n   * Process boolean value change (edition)\r\n   */\r\n  onBooleanValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.checked;\r\n  }\r\n\r\n  /**\r\n   * Process select value change (edition)\r\n   */\r\n  onSelectValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.value;\r\n  }\r\n\r\n  /**\r\n   * Process autocomplete value change (edition)\r\n   */\r\n  onAutocompleteValueChange(column: EntityTableColumn, record: EntityRecord<any>, event) {\r\n    this.formGroup.controls[column.name].setValue(event.option.viewValue);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n    record.entity.properties[key] = event.option.value;\r\n  }\r\n\r\n  /**\r\n   * Process date value change (edition)\r\n   */\r\n  onDateChange(column: string, record: EntityRecord<any>, event) {\r\n    const format = \"YYYY-MM-DD\";\r\n    const value = moment(event.value).format(format);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = value;\r\n  }\r\n\r\n  /**\r\n   * Enable edition mode for one row\r\n   * More than one row can be edited at the same time\r\n   */\r\n  private enableEdit(record: EntityRecord<any>) {\r\n    const item = record.entity.properties || record.entity;\r\n    this.template.columns.forEach(column => {\r\n      column.title = column.validation?.mandatory && !column.title.includes('*') ? column.title + ' *' : column.title;\r\n\r\n      const key = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n      if (column.type === 'boolean') {\r\n        if (!item[key] || item[key] === null) {\r\n          item[key] = false;\r\n        } else if (typeof item[key] === 'string') {\r\n          item[key] = JSON.parse(item[key].toLowerCase());\r\n        }\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      } else if (column.type === 'list') {\r\n        if (column.multiple) {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            [item[key]]\r\n          ));\r\n        } else {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            item[key]\r\n          ));\r\n\r\n          typeof item[key] === 'string' ?\r\n            this.formGroup.controls[column.name].setValue(parseInt(item[key])) :\r\n            this.formGroup.controls[column.name].setValue(item[key]);\r\n        }\r\n      } else if (column.type === 'autocomplete') {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n\r\n        this.filteredOptions[column.name] = new Observable<any[]>();\r\n        this.filteredOptions[column.name] =\r\n          this.formGroup.controls[column.name].valueChanges.pipe(\r\n            map(value => {\r\n              if (value?.length) {\r\n                return column.domainValues?.filter((option) => {\r\n                  const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                  const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                  return featureNameNormalized.includes(filterNormalized);\r\n                });\r\n              }\r\n            })\r\n          );\r\n\r\n        let formControlValue = item[key];\r\n        column.domainValues.forEach(option => {\r\n          if (this.isStringValidNumber(formControlValue)) {\r\n            formControlValue = parseInt(formControlValue);\r\n          }\r\n          if (option.value === formControlValue || option.id === formControlValue) {\r\n            formControlValue = option.value;\r\n          }\r\n        });\r\n\r\n        this.formGroup.controls[column.name].setValue(formControlValue);\r\n        if (this.isEdition(record) && column.linkColumnForce) {\r\n          const entity = record.entity as any;\r\n          this.formGroup.controls[column.name].setValue(\r\n            entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)]\r\n          );\r\n        }\r\n      } else if (column.type === 'date') {\r\n        if (column.visible !== false) {\r\n          if (item[key]) {\r\n            let date = moment(item[key]);\r\n            item[key] = date.utc().format('YYYY-MM-DD');\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              item[key]\r\n            ));\r\n          } else {\r\n            const newKey = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n            record.entity.properties[newKey] = null;\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              null\r\n            ));\r\n          }\r\n        }\r\n      } else {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      }\r\n\r\n      if (this.formGroup.controls[column.name] && this.getValidationAttributeValue(column, 'readonly')) {\r\n        this.formGroup.controls[column.name].disable();\r\n      }\r\n    });\r\n  }\r\n\r\n  private handleDatasource() {\r\n    this.unsubscribeStore();\r\n    this.selection$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const firstSelected = records[0];\r\n        const firstSelectedStateviewPosition = this.store.stateView.all().indexOf(firstSelected);\r\n        const pageMax = this.paginator ? this.paginator.pageSize * (this.paginator.pageIndex + 1) : 0;\r\n        const pageMin = this.paginator ? pageMax - this.paginator.pageSize : 0;\r\n\r\n        if (\r\n          this.paginator &&\r\n          (firstSelectedStateviewPosition < pageMin ||\r\n          firstSelectedStateviewPosition >= pageMax)) {\r\n          const pageToReach = Math.floor(firstSelectedStateviewPosition / this.paginator.pageSize);\r\n          this.dataSource.paginator.pageIndex = pageToReach;\r\n        }\r\n        this.selectionState$.next(this.computeSelectionState(records));\r\n      });\r\n    this.dataSource$$ = this.store.stateView.all$().subscribe((all) => {\r\n      if (all[0]) {\r\n        this.enableEdit(all[0]);\r\n      }\r\n      this.dataSource.data = all;\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Unbind the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unsubscribeStore();\r\n  }\r\n\r\n  private unsubscribeStore() {\r\n    if (this.selection$$) {\r\n      this.selection$$.unsubscribe();\r\n    }\r\n    if (this.dataSource$$) {\r\n      this.dataSource$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trackby function\r\n   * @param record Record\r\n   * @param index Record index\r\n   * @internal\r\n   */\r\n  getTrackByFunction() {\r\n    return (index: number, record: EntityRecord<object, EntityState>) => {\r\n      return record.ref;\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Trigger a refresh of thre table. This can be useful when\r\n   * the data source doesn't emit a new value but for some reason\r\n   * the records need an update.\r\n   * @internal\r\n   */\r\n  refresh() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  /**\r\n   * On sort, sort the store\r\n   * @param event Sort event\r\n   * @internal\r\n   */\r\n  onSort(event: {active: string, direction: string}) {\r\n    const direction = event.direction;\r\n    const column = this.template.columns\r\n      .find((c: EntityTableColumn) => c.name === event.active);\r\n\r\n    if (direction === 'asc' || direction === 'desc') {\r\n      this.store.stateView.sort({\r\n        valueAccessor: (record: EntityRecord<object>) => this.getValue(record, column),\r\n        direction,\r\n        nullsFirst: this.sortNullsFirst\r\n      });\r\n      this.entitySortChange.emit({column, direction});\r\n      this.entitySortChange$.next(true);\r\n    } else {\r\n      this.store.stateView.sort(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is clicked, emit an event\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowClick(record: EntityRecord<object>) {\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n    this.entityClick.emit(record.entity);\r\n  }\r\n\r\n  /**\r\n   * When an entity is selected, select it in the store and emit an event. Even if\r\n   * \"many\" is set to true, this method always select a single, exclusive row. Selecting\r\n   * multiple rows should be achieved by using the checkboxes.\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowSelect(record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    this.store.state.update(entity, {selected: true}, true);\r\n    this.entitySelectChange.emit({added: [entity]});\r\n  }\r\n\r\n  /**\r\n   * Select or unselect all rows at once. On select, emit an event.\r\n   * @param toggle Select or unselect\r\n   * @internal\r\n   */\r\n  onToggleRows(toggle: boolean) {\r\n    if (this.selection === false) { return; }\r\n\r\n    this.store.state.updateAll({selected: toggle});\r\n    if (toggle === true) {\r\n      const entities = this.store.stateView\r\n        .all()\r\n        .map((record: EntityRecord<object>) => record.entity);\r\n      this.entitySelectChange.emit({added: [entities]});\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onToggleRow(toggle: boolean, record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    const exclusive = toggle === true && !this.selectMany;\r\n    this.store.state.update(entity, {selected: toggle}, exclusive);\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: [entity]});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onShiftToggleRow(toggle: boolean, record: EntityRecord<object>, event: MouseEvent) {\r\n    if (this.selection === false) { return; }\r\n\r\n    if (this.selectMany === false || this.lastRecordCheckedKey === undefined) {\r\n      this.onToggleRow(toggle, record);\r\n      return;\r\n    }\r\n\r\n    // This is a workaround mat checkbox wrong behavior\r\n    // when the shift key is held.\r\n    // See https://github.com/angular/components/issues/6232\r\n    const range = window.document.createRange();\r\n    range.selectNode(event.target as HTMLElement);\r\n    window.getSelection().removeAllRanges();\r\n    window.getSelection().addRange(range);\r\n    event.stopImmediatePropagation();\r\n\r\n    const records = this.store.stateView.all();\r\n    const recordIndex = records.indexOf(record);\r\n    const lastRecordChecked = this.store.stateView.get(this.lastRecordCheckedKey);\r\n    const lastRecordIndex = records.indexOf(lastRecordChecked);\r\n    const indexes = [recordIndex, lastRecordIndex];\r\n    const selectRecords = records.slice(Math.min(...indexes), Math.max(...indexes) + 1);\r\n\r\n    const entities = selectRecords.map((_record: EntityRecord<object>) => _record.entity);\r\n    this.store.state.updateMany(entities, {selected: toggle});\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: entities});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * Compute the selection state\r\n   * @returns Whether all, some or no rows are selected\r\n   * @internal\r\n   */\r\n  private computeSelectionState(selectedRecords: EntityRecord<object>[]): EntityTableSelectionState {\r\n    const states = EntityTableSelectionState;\r\n    const selectionCount = selectedRecords.length;\r\n    return selectionCount === 0 ?\r\n      states.None :\r\n      (selectionCount === this.store.stateView.count ? states.All : states.Some);\r\n  }\r\n\r\n  /**\r\n   * Whether a column is sortable\r\n   * @param column Column\r\n   * @returns True if a column is sortable\r\n   * @internal\r\n   */\r\n  columnIsSortable(column: EntityTableColumn): boolean {\r\n    let sortable = column.sort;\r\n    if (sortable === undefined) {\r\n      sortable = this.template.sort === undefined ? false : this.template.sort;\r\n    }\r\n    return sortable;\r\n  }\r\n\r\n  /**\r\n   * Whether a row is should be selected based on the underlying entity state\r\n   * @param record Record\r\n   * @returns True if a row should be selected\r\n   * @internal\r\n   */\r\n  rowIsSelected(record: EntityRecord<object>): boolean {\r\n    const state = record.state;\r\n    return state.selected ? state.selected : false;\r\n  }\r\n\r\n  isImg(value) {\r\n    if (this.isUrl(value)) {\r\n      return (\r\n        ['jpg', 'png', 'gif'].indexOf(value.split('.').pop().toLowerCase()) !== -1\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      return (\r\n        value.slice(0, 8) === 'https://' || value.slice(0, 7) === 'http://'\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's values\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns Any value\r\n   * @internal\r\n   */\r\n  getValue(record: EntityRecord<object>, column: EntityTableColumn): any {\r\n    const entity = record.entity;\r\n    let value;\r\n    if (column.valueAccessor !== undefined) {\r\n      return column.valueAccessor(entity, record);\r\n    }\r\n    if (this.template.valueAccessor !== undefined) {\r\n      return this.template.valueAccessor(entity, column.name, record);\r\n    }\r\n    value = this.store.getProperty(entity, column.name);\r\n\r\n    if (column.type === 'boolean') {\r\n      if (value === undefined || value === null || value === '') {\r\n        value = false;\r\n      } else if (typeof value !== 'boolean' && value !== undefined) {\r\n        if (typeof value === 'number'){\r\n          value = Boolean(value);\r\n        } else {\r\n          value = JSON.parse(value.toLowerCase());\r\n        }\r\n      }\r\n      if (!this.isEdition(record)){\r\n        value = value ? '&#10003;' : ''; // check mark\r\n      }\r\n    } else if (column.type === 'list' && value && column.domainValues) {\r\n      const entity = record.entity as any;\r\n      if (column.multiple) {\r\n        let list_id;\r\n        typeof value === 'string' ? list_id = value.match(/[\\w.-]+/g).map(Number) : list_id = value;\r\n        let list_option = [];\r\n\r\n        column.domainValues.forEach(option => {\r\n          if (list_id.includes(option.id)) {\r\n            if (record.edition) {\r\n              list_option.push(option.id);\r\n            } else {\r\n              list_option.push(option.value);\r\n            }\r\n          }\r\n        });\r\n\r\n        this.isEdition(record) ? value = list_id : value = list_option;\r\n      } else {\r\n        if (!this.isEdition(record) && column.linkColumnForce) {\r\n          value = entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)];\r\n        } else {\r\n          column.domainValues.forEach(option => {\r\n            if (this.isStringValidNumber(value)) {\r\n              value = parseInt(value);\r\n            }\r\n            if (option.value === value || option.id === value) {\r\n              this.isEdition(record) ? value = option.id : value = option.value;\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } else if (column.type === 'autocomplete' && value && column.domainValues) {\r\n      const entity = record.entity as any;\r\n      if (!this.isEdition(record) && column.linkColumnForce) {\r\n        value = entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)];\r\n      } else {\r\n        column.domainValues.forEach(option => {\r\n          if (this.isStringValidNumber(value)) {\r\n            value = parseInt(value);\r\n          }\r\n          if (option.value === value || option.id === value) {\r\n            value = option.value;\r\n          }\r\n        });\r\n      }\r\n    } else if (column.type === 'date') {\r\n      if (this.isEdition(record)) {\r\n        if (value) {\r\n          let date = moment(value);\r\n          value = date.format();\r\n          this.formGroup.controls[column.name].setValue(value);\r\n        }\r\n      } else if (!this.isEdition(record) && value === null) {\r\n        value = \"\";\r\n      }\r\n    }\r\n\r\n    if (value === undefined) {\r\n      value = '';\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's validation values\r\n   * @param column Column\r\n   * @param validationType string\r\n   * @returns Any value (false if no validation or not the one concerned)\r\n   * @internal\r\n   */\r\n  getValidationAttributeValue(column: EntityTableColumn, validationType: string): any {\r\n    if (column.validation !== undefined && column.validation[validationType] !== undefined) {\r\n      return column.validation[validationType];\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public isEdition(record) {\r\n    return record.entity.edition ? true : false;\r\n  }\r\n\r\n  /**\r\n   * Return the type of renderer of a column\r\n   * @param column Column\r\n   * @returns Renderer type\r\n   * @internal\r\n   */\r\n  getColumnRenderer(column: EntityTableColumn): EntityTableColumnRenderer {\r\n    if (column.renderer !== undefined) {\r\n      return column.renderer;\r\n    }\r\n    return EntityTableColumnRenderer.Default;\r\n  }\r\n\r\n  /**\r\n   * Return the table ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getTableClass(): {[key: string]: boolean} {\r\n    return {\r\n      'igo-entity-table-with-selection': this.selection\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Return a header ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getHeaderClass(): {[key: string]: boolean} {\r\n    const func = this.template.headerClassFunc;\r\n    if (func instanceof Function) {\r\n      return func();\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getRowClass(record: EntityRecord<object>): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const func = this.template.rowClassFunc;\r\n    if (func instanceof Function) {\r\n      return func(entity, record);\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getCellClass(record: EntityRecord<object>, column: EntityTableColumn): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const cls = {};\r\n\r\n    const tableFunc = this.template.cellClassFunc;\r\n    if (tableFunc instanceof Function) {\r\n      Object.assign(cls, tableFunc(entity, column, record));\r\n    }\r\n\r\n    const columnFunc = column.cellClassFunc;\r\n    if (columnFunc instanceof Function) {\r\n      Object.assign(cls, columnFunc(entity, record));\r\n    }\r\n\r\n    return cls;\r\n  }\r\n\r\n  /**\r\n   * When a button is clicked\r\n   * @param func Function\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onButtonClick(\r\n    clickFunc: (entity: object, record?: EntityRecord<object>) => void,\r\n    record: EntityRecord<object>\r\n  ) {\r\n    this.enableEdit(record);\r\n    if (typeof clickFunc === 'function') {\r\n      clickFunc(record.entity, record);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve column name without his \"properties\" tag (useful for edition workspace properties)\r\n   */\r\n  public getColumnKeyWithoutPropertiesTag(column: string) {\r\n    if (column.includes('properties.')) {\r\n      return column.split('.')[1];\r\n    }\r\n    return column;\r\n  }\r\n  /**\r\n   * Check if string is a valid number\r\n   * @param value string\r\n   * @returns boolean\r\n   */\r\n  private isStringValidNumber(value: string): boolean {\r\n    return typeof value === 'string' && /^\\d+$/.test(value) && (value.length > 1 && value.charAt(0) !== '0');\r\n  }\r\n}\r\n","export enum ActionbarMode {\r\n  Dock = 'dock',\r\n  Overlay = 'overlay',\r\n  Context = 'context'\r\n}\r\n","<mat-list-item *ngIf=\"!action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\"\r\n  (click)=\"onClick()\">\r\n  <button *ngIf=\"withIcon\"\r\n    mat-list-avatar\r\n    mat-icon-button\r\n    [color]=\"color\"\r\n    [disabled]=\"disabled$ | async\">\r\n    <mat-icon *ngIf=\"withIcon\" svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n  <h4 *ngIf=\"withTitle\" matLine>{{title | translate}}</h4>\r\n</mat-list-item>\r\n\r\n<mat-list-item class=\"item-checkbox\" *ngIf=\"action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\">\r\n  <mat-checkbox *ngIf=\"withTitle\"\r\n      (change)=\"action.handler()\"\r\n      [checked]=\"checkCondition$ | async\">\r\n      {{title | translate}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, isObservable } from 'rxjs';\r\n\r\nimport { Action } from '../shared/action.interfaces';\r\n\r\n /**\r\n  * An action button\r\n  */\r\n@Component({\r\n  selector: 'igo-actionbar-item',\r\n  templateUrl: './actionbar-item.component.html',\r\n  styleUrls: ['./actionbar-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarItemComponent implements OnInit, OnDestroy {\r\n\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly checkCondition$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly tooltip$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly noDisplay$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly ngClass$: BehaviorSubject<{[key: string]: boolean}> = new BehaviorSubject({});\r\n\r\n  private ngClass$$: Subscription;\r\n\r\n  private disabled$$: Subscription;\r\n\r\n  private availability$$: Subscription;\r\n\r\n  private icon$$: Subscription;\r\n\r\n  private checkCondition$$: Subscription;\r\n\r\n  private tooltip$$: Subscription;\r\n\r\n  private noDisplay$$: Subscription;\r\n\r\n  private display$$: Subscription;\r\n\r\n  /**\r\n   * Action\r\n   */\r\n  @Input() action: Action;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Whether the action title is displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether the action icon is displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Whether a tooltip should be shown\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether the action is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) { this.disabled$.next(value); }\r\n  get disabled(): boolean { return this.disabled$.value; }\r\n\r\n  /**\r\n   * Whether the action is display or not\r\n   */\r\n  @Input()\r\n  set noDisplay(value: boolean) { this.noDisplay$.next(value); }\r\n  get noDisplay(): boolean { return this.noDisplay$.value; }\r\n\r\n  /**\r\n   * Event emitted when the action button is clicked\r\n   */\r\n  @Output() trigger: EventEmitter<Action> = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return this.action.title; }\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    const args = this.action.args || [];\r\n\r\n    if (this.action.ngClass !== undefined) {\r\n      this.ngClass$$ = this.action.ngClass(...args)\r\n        .subscribe((ngClass: {[key: string]: boolean}) => this.updateNgClass(ngClass));\r\n    }\r\n\r\n    if (isObservable(this.action.icon)) {\r\n      this.icon$$ = this.action.icon\r\n        .subscribe((icon: string) => this.updateIcon(icon));\r\n    } else {\r\n      this.updateIcon(this.action.icon);\r\n    }\r\n\r\n    if (isObservable(this.action.checkCondition)) {\r\n      this.checkCondition$$ = this.action.checkCondition\r\n        .subscribe((checkCondition: boolean) => this.updateCheckCondition(checkCondition));\r\n    } else {\r\n      this.updateCheckCondition(this.action.checkCondition);\r\n    }\r\n\r\n    if (isObservable(this.action.tooltip)) {\r\n      this.tooltip$$ = this.action.tooltip\r\n        .subscribe((tooltip: string) => this.updateTooltip(tooltip));\r\n    } else {\r\n      this.updateTooltip(this.action.tooltip);\r\n    }\r\n\r\n    if (this.action.availability !== undefined) {\r\n      this.availability$$ = this.action.availability(...args)\r\n        .subscribe((available: boolean) => this.disabled = !available);\r\n    }\r\n\r\n    this.disabled$$ = this.disabled$\r\n      .subscribe((disabled: boolean) => this.updateNgClass({'igo-actionbar-item-disabled': disabled}));\r\n\r\n    if (this.action.display !== undefined) {\r\n      this.display$$ = this.action.display(...args)\r\n        .subscribe((display: boolean) => this.noDisplay = !display);\r\n    }\r\n\r\n    this.noDisplay$$ = this.noDisplay$\r\n      .subscribe((noDisplay: boolean) => this.updateNgClass({'igo-actionbar-item-no-display': noDisplay}));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.ngClass$$ !== undefined) {\r\n      this.ngClass$$.unsubscribe();\r\n      this.ngClass$$ = undefined;\r\n    }\r\n\r\n    if (this.availability$$ !== undefined) {\r\n      this.availability$$.unsubscribe();\r\n      this.availability$$ = undefined;\r\n    }\r\n\r\n    if (this.display$$ !== undefined) {\r\n      this.display$$.unsubscribe();\r\n      this.display$$ = undefined;\r\n    }\r\n\r\n    if (this.checkCondition$$ !== undefined) {\r\n      this.checkCondition$$.unsubscribe();\r\n      this.checkCondition$$ = undefined;\r\n    }\r\n\r\n    if (this.icon$$ !== undefined) {\r\n      this.icon$$.unsubscribe();\r\n      this.icon$$ = undefined;\r\n    }\r\n\r\n    if (this.tooltip$$ !== undefined) {\r\n      this.tooltip$$.unsubscribe();\r\n      this.tooltip$$ = undefined;\r\n    }\r\n\r\n    this.disabled$$.unsubscribe();\r\n    this.noDisplay$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When the action button is clicked, emit the 'trigger' event but don't\r\n   * invoke the action handler. This is handled by the parent component.\r\n   * @internal\r\n   */\r\n  onClick() {\r\n    if (this.disabled === true) {\r\n      return;\r\n    }\r\n    this.trigger.emit(this.action);\r\n  }\r\n\r\n  private updateNgClass(ngClass: {[key: string]: boolean}) {\r\n    this.ngClass$.next(Object.assign({}, this.ngClass$.value, ngClass));\r\n  }\r\n\r\n  private updateTooltip(tooltip: string) {\r\n    this.tooltip$.next(tooltip);\r\n  }\r\n\r\n  private updateCheckCondition(checkCondition: boolean) {\r\n    this.checkCondition$.next(checkCondition);\r\n  }\r\n\r\n  private updateIcon(icon: string) {\r\n    this.icon$.next(icon);\r\n  }\r\n}\r\n","<mat-list *ngIf=\"mode === actionbarMode.Dock\">\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionTop && isDesktop\"\r\n      id=\"topChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollUp' | translate\"\r\n        (click)=\"scrollUp()\">\r\n        <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <igo-actionbar-item\r\n      *ngIf=\"withToggleButton\"\r\n      color=\"accent\"\r\n      [withTitle]=\"false\"\r\n      [withIcon]=\"true\"\r\n      [color]=\"color\"\r\n      [disabled]=\"store.view.empty\"\r\n      [action]=\"toggleCollapseAction\"\r\n      (trigger)=\"onTriggerAction(toggleCollapseAction)\">\r\n    </igo-actionbar-item>\r\n\r\n    <ng-template #buttonContent *ngIf=\"!collapsed\" ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n      <igo-actionbar-item\r\n        color=\"accent\"\r\n        [withTitle]=\"withTitle\"\r\n        [withIcon]=\"withIcon\"\r\n        [withTooltip]=\"withTooltip\"\r\n        [color]=\"color\"\r\n        [disabled]=\"store.state.get(action).disabled\"\r\n        [action]=\"action\"\r\n        (trigger)=\"onTriggerAction(action)\">\r\n      </igo-actionbar-item>\r\n    </ng-template>\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionLow && isDesktop\"\r\n      id=\"lowChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollDown' | translate\"\r\n        (click)=\"scrollDown()\">\r\n        <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n</mat-list>\r\n\r\n<div *ngIf=\"mode === actionbarMode.Overlay\">\r\n  <button class=\"buttonOverlay\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.common.actionbar.icon' | translate\"\r\n    [matMenuTriggerFor]=\"actionbarMenu\"\r\n    [disabled]=\"store.view.empty\"\r\n    [color]=\"iconColor\">\r\n    <mat-icon [svgIcon]=\"icon\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #actionbarMenu=\"matMenu\"\r\n    class=\"igo-compact-menu igo-no-min-width-menu\"\r\n    overlapTrigger=\"true\"\r\n    [xPosition]=\"xPosition\"\r\n    [yPosition]=\"yPosition\"\r\n    [class]=\"overlayClass\">\r\n\r\n    <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n        <igo-actionbar-item\r\n          color=\"accent\"\r\n          [withTitle]=\"withTitle\"\r\n          [withIcon]=\"withIcon\"\r\n          [color]=\"color\"\r\n          [action]=\"action\"\r\n          (trigger)=\"onTriggerAction(action)\">\r\n        </igo-actionbar-item>\r\n      </ng-template>\r\n    </mat-list>\r\n  </mat-menu>\r\n</div>\r\n<mat-card *ngIf=\"mode === actionbarMode.Context\" class=\"context-menu-card mat-elevation-z4\">\r\n  <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n          <igo-actionbar-item\r\n            color=\"accent\"\r\n            [withTitle]=\"withTitle\"\r\n            [withIcon]=\"withIcon\"\r\n            [color]=\"color\"\r\n            [action]=\"action\"\r\n            (trigger)=\"onTriggerAction(action)\">\r\n          </igo-actionbar-item>\r\n        <br/>\r\n      </ng-template>\r\n  </mat-list>\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  Input,\r\n  HostBinding,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '../../entity';\r\nimport { Action } from '../shared/action.interfaces';\r\nimport { ActionbarMode } from '../shared/action.enums';\r\nimport { ActionStore } from '../shared/store';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * A list of action buttons.\r\n * This component can be displayed in one of two way: 'dock' or 'overlay'\r\n */\r\n@Component({\r\n  selector: 'igo-actionbar',\r\n  templateUrl: './actionbar.component.html',\r\n  styleUrls: ['./actionbar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarComponent implements OnDestroy, OnChanges {\r\n\r\n  /**\r\n   * Reference to the ActionbarMode enum for use in the template\r\n   * @internal\r\n   */\r\n  actionbarMode = ActionbarMode;\r\n\r\n  /**\r\n   * Whether the actionbar is collapsed (Dock mode)\r\n   * @internal\r\n   */\r\n  collapsed = false;\r\n\r\n  /**\r\n   * Toggle collapse action (Dock)\r\n   * @internal\r\n   */\r\n  toggleCollapseAction = {\r\n    id: 'actionbar_toggle',\r\n    icon: 'dots-vertical',\r\n    handler: () => {\r\n      this.collapsed = !this.collapsed;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Action store watcher\r\n   * @internal\r\n   */\r\n  private watcher: EntityStoreWatcher<Action>;\r\n\r\n  /**\r\n   * Height Condition for scroll button\r\n   */\r\n  heightCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Position Condition for top scroll button\r\n   */\r\n  positionConditionTop$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Position Condition for low scroll button\r\n   */\r\n  positionConditionLow$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Action store\r\n   */\r\n  @Input() store: ActionStore;\r\n\r\n  /**\r\n   * Actionbar mode\r\n   */\r\n  @Input() mode: ActionbarMode = ActionbarMode.Dock;\r\n\r\n  /**\r\n   * Whether a toggle button should be displayed (Dock mode)\r\n   */\r\n  @Input() withToggleButton = false;\r\n\r\n  /**\r\n   * Whether a the actionbar should display buttons horizontally\r\n   */\r\n  @Input() horizontal = false;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Color of the button if action mode === overlay\r\n   */\r\n  @Input() iconColor = 'default';\r\n\r\n  /**\r\n   * Whether action titles are displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether action tooltips are displayed\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether action titles are displayed (condition for scroll button)\r\n   */\r\n  @Input() scrollActive = true;\r\n\r\n  /**\r\n   * Whether action icons are displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Which icon want to be shown\r\n   */\r\n  @Input() icon = 'dots-horizontal';\r\n\r\n  /**\r\n   * Overlay X position\r\n   */\r\n  @Input() xPosition = 'before';\r\n\r\n  /**\r\n   * Overlay Y position\r\n   */\r\n  @Input() yPosition = 'above';\r\n\r\n  /**\r\n   * Class to add to the actionbar overlay\r\n   */\r\n  @Input()\r\n  set overlayClass(value: string) {\r\n    this._overlayClass = value;\r\n  }\r\n  get overlayClass(): string {\r\n    return [this._overlayClass, 'igo-actionbar-overlay'].join(' ');\r\n  }\r\n  private _overlayClass = '';\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-title')\r\n  get withTitleClass() {\r\n    return this.withTitle;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-icon')\r\n  get withIconClass() {\r\n    return this.withIcon;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.horizontal')\r\n  get horizontalClass() {\r\n    return this.horizontal;\r\n  }\r\n\r\n  get heightCondition(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (this.scrollActive === false) {\r\n      if (el.clientHeight < el.scrollHeight) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get positionConditionTop(): boolean {\r\n    if (this.elRef.nativeElement.scrollTop === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get positionConditionLow(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (el.scrollTop >= (el.scrollHeight - el.clientHeight)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isDesktop(): boolean {\r\n    return this.mediaService.getMedia() === Media.Desktop;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef,\r\n    public mediaService: MediaService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      if (this.watcher !== undefined) {\r\n        this.watcher.destroy();\r\n      }\r\n      this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * Invoke the action handler\r\n   * @internal\r\n   */\r\n  onTriggerAction(action: Action) {\r\n    const args = action.args || [];\r\n    action.handler(...args);\r\n  }\r\n\r\n  scrollDown() {\r\n    this.elRef.nativeElement.scrollBy(0, 52);\r\n  }\r\n\r\n  scrollUp() {\r\n    this.elRef.nativeElement.scrollBy(0, -52);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ActionbarComponent } from './actionbar.component';\r\nimport { ActionbarItemComponent } from './actionbar-item.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatMenuModule,\r\n    MatListModule,\r\n    MatCardModule,\r\n    MatCheckboxModule\r\n  ],\r\n  exports: [ActionbarComponent],\r\n  declarations: [ActionbarComponent, ActionbarItemComponent]\r\n})\r\nexport class IgoActionbarModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionbarModule } from './actionbar/actionbar.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    IgoActionbarModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoActionModule {}\r\n","import { Directive, Input, ElementRef, OnInit } from '@angular/core';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\n\r\n/**\r\n * This directive allow to add an icon inside a matBadge.\r\n * A value must be set into the matBadge directive ex: matBadge=\"icon\".\r\n * The badge content will be overrided by this current directive.\r\n */\r\n@Directive({\r\n  selector: '[igoMatBadgeIcon]'\r\n})\r\nexport class IgoBadgeIconDirective implements OnInit {\r\n  @Input()\r\n  set igoMatBadgeIcon(value: string) {\r\n    this.matIconRegistry.getNamedSvgIcon(value).subscribe((svgObj) => {\r\n      this.svg = svgObj;\r\n      this.updateSvg();\r\n    });\r\n  }\r\n  private svg: SVGElement;\r\n\r\n  @Input()\r\n  set matBadgeHidden(value: boolean) {\r\n    this.hidden = value;\r\n    this.updateHidden();\r\n  }\r\n  private hidden = false;\r\n\r\n  @Input()\r\n  set matBadgeDisabled(value: boolean) {\r\n    this.disabled = value;\r\n    this.updateDisabled();\r\n  }\r\n  private disabled = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInverseColor(value: boolean) {\r\n    this.inverseColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inverseColor = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInheritColor(value: boolean) {\r\n    this.inheritColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inheritColor = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeColor(value: string) {\r\n    this.color = value;\r\n    this.updateColor();\r\n  }\r\n  private color;\r\n\r\n  @Input()\r\n  set igoMatBadgeBackgroundColor(value: string) {\r\n    this.backgroundColor = value;\r\n    this.updateColor();\r\n  }\r\n  private backgroundColor;\r\n\r\n  get badge() {\r\n    return this.el.nativeElement.querySelector('.mat-badge-content');\r\n  }\r\n\r\n  private originalColor: string;\r\n\r\n  constructor(\r\n    private el: ElementRef,\r\n    private matIconRegistry: MatIconRegistry\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.badge.style.alignItems = 'center';\r\n    this.badge.style.justifyContent = 'center';\r\n\r\n    this.updateHidden();\r\n    this.updateColor();\r\n    this.updateSvg();\r\n  }\r\n\r\n  private updateSvg() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.innerHTML = '';\r\n    if (this.svg) {\r\n      this.badge.appendChild(this.svg);\r\n    }\r\n  }\r\n  private updateColor() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n\r\n    if (this.color || this.backgroundColor) {\r\n      this.badge.style.color = this.color ? this.color : '';\r\n      this.badge.style.background = this.backgroundColor ? this.backgroundColor : '';\r\n    } else if (this.inheritColor) {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = 'currentColor';\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = 'currentColor';\r\n      }\r\n    } else if (!this.inheritColor) {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = window\r\n          .getComputedStyle(this.badge, null)\r\n          .getPropertyValue('background-color');\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = '';\r\n      }\r\n    }\r\n    this.originalColor = this.badge.style.color;\r\n    this.updateDisabled();\r\n  }\r\n\r\n  private updateHidden() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.style.display = this.hidden ? 'none' : 'flex';\r\n  }\r\n\r\n  private updateDisabled() {\r\n    if (!this.badge || !this.inverseColor) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      this.originalColor = this.badge.style.color;\r\n      this.badge.style.color = '#b9b9b9';\r\n    } else {\r\n      this.badge.style.color = this.originalColor;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { IgoBadgeIconDirective } from './badge-icon.directive';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\n@NgModule({\r\n  imports: [MatBadgeModule, MatIconModule],\r\n  declarations: [IgoBadgeIconDirective],\r\n  exports: [MatBadgeModule, IgoBadgeIconDirective]\r\n})\r\nexport class IgoMatBadgeIconModule {\r\n  static forRoot(): ModuleWithProviders<IgoMatBadgeIconModule> {\r\n    return {\r\n      ngModule: IgoMatBadgeIconModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Output\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoClickout]'\r\n})\r\nexport class ClickoutDirective {\r\n  @Output() clickout = new EventEmitter<MouseEvent>();\r\n\r\n  @HostListener('document:click', ['$event', '$event.target'])\r\n  handleMouseClick(event: MouseEvent, target: HTMLElement) {\r\n    if (!target) {\r\n      return;\r\n    }\r\n\r\n    if (!this.el.nativeElement.contains(target)) {\r\n      this.clickout.emit(event);\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ClickoutDirective } from './clickout.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ClickoutDirective],\r\n  exports: [ClickoutDirective]\r\n})\r\nexport class IgoClickoutModule {\r\n  static forRoot(): ModuleWithProviders<IgoClickoutModule> {\r\n    return {\r\n      ngModule: IgoClickoutModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  HostListener,\r\n  ElementRef,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoCollapse]'\r\n})\r\nexport class CollapseDirective {\r\n  @Input()\r\n  get target() {\r\n    return this._target;\r\n  }\r\n  set target(value: Element) {\r\n    this._target = value;\r\n  }\r\n  private _target: Element;\r\n\r\n  @Input()\r\n  get collapsed(): boolean {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(collapsed: boolean) {\r\n    collapsed ? this.collapseTarget() : this.expandTarget();\r\n    this._collapsed = collapsed;\r\n    this.toggle.emit(collapsed);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n\r\n  @HostListener('click')\r\n  click() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  private collapseTarget() {\r\n    this.renderer.addClass(this.target, 'igo-collapsed');\r\n    this.renderer.addClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n\r\n  private expandTarget() {\r\n    this.renderer.removeClass(this.target, 'igo-collapsed');\r\n    this.renderer.removeClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n}\r\n","import { Component, Input, Output, EventEmitter } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-collapsible',\r\n  templateUrl: './collapsible.component.html',\r\n  styleUrls: ['./collapsible.component.scss']\r\n})\r\nexport class CollapsibleComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title = '';\r\n\r\n  @Input()\r\n  get collapsed() {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(value: boolean) {\r\n    this._collapsed = value;\r\n    this.toggle.emit(value);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    svgIcon=\"chevron-up\" \r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"content\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"collapsed = $event\">\r\n  </mat-icon>\r\n  <h4 matLine>{{title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #content>\r\n  <ng-content></ng-content>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { CollapseDirective } from './collapse.directive';\r\nimport { CollapsibleComponent } from './collapsible.component';\r\n\r\n@NgModule({\r\n  imports: [MatIconModule, MatListModule],\r\n  declarations: [CollapsibleComponent, CollapseDirective],\r\n  exports: [CollapsibleComponent, CollapseDirective]\r\n})\r\nexport class IgoCollapsibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoCollapsibleModule> {\r\n    return {\r\n      ngModule: IgoCollapsibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-confirm-dialog',\r\n  templateUrl: './confirm-dialog.component.html',\r\n  styleUrls: ['./confirm-dialog.component.scss']\r\n})\r\nexport class ConfirmDialogComponent {\r\n  public confirmMessage: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<ConfirmDialogComponent>) {}\r\n}\r\n","<h2 mat-dialog-title class=\"mat-typography\">{{'igo.common.confirmDialog.title' | translate}}</h2>\r\n<div mat-dialog-content class=\"mat-typography\">{{confirmMessage}}</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\" (click)=\"dialogRef.close(true)\">{{'igo.common.confirmDialog.confirmBtn' | translate}}</button>\r\n  <button mat-button (click)=\"dialogRef.close(false)\">{{'igo.common.confirmDialog.cancelBtn' | translate}}</button>\r\n</div>\r\n","import { Injectable } from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\n\r\n@Injectable()\r\nexport class ConfirmDialogService {\r\n  constructor(private dialog: MatDialog, private languageService: LanguageService) {}\r\n\r\n  public open(message: string): Observable<any> {\r\n    const dialogRef = this.dialog.open(ConfirmDialogComponent, {\r\n      disableClose: false\r\n    });\r\n    dialogRef.componentInstance.confirmMessage = this.languageService.translate.instant(message);\r\n\r\n    return dialogRef.afterClosed();\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\nimport { ConfirmDialogService } from './confirm-dialog.service';\r\n\r\n@NgModule({\r\n  imports: [MatButtonModule, MatDialogModule, IgoLanguageModule],\r\n  declarations: [ConfirmDialogComponent],\r\n  exports: [ConfirmDialogComponent],\r\n  providers: [ConfirmDialogService]\r\n})\r\nexport class IgoConfirmDialogModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfirmDialogModule> {\r\n    return {\r\n      ngModule: IgoConfirmDialogModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Input,\r\n  Output,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { TemplatePortal } from '@angular/cdk/portal';\r\nimport { fromEvent, Subscription } from 'rxjs';\r\nimport { filter, take } from 'rxjs/operators';\r\nimport { Overlay, OverlayRef } from '@angular/cdk/overlay';\r\n\r\n@Directive({\r\n  selector: '[igoContextMenu]'\r\n})\r\nexport class ContextMenuDirective {\r\n  private overlayRef: OverlayRef | null;\r\n  private sub: Subscription;\r\n\r\n  @Input('igoContextMenu') menuContext: TemplateRef<any>;\r\n  @Output() menuPosition = new EventEmitter<{ x: number; y: number }>();\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    public viewContainerRef: ViewContainerRef,\r\n    private elementRef: ElementRef\r\n  ) {}\r\n\r\n  @HostListener('longpress', ['$event'])\r\n  @HostListener('contextmenu', ['$event'])\r\n  public onContextMenu(e: MouseEvent | TouchEvent): void {\r\n    let x;\r\n    let y;\r\n    if (e instanceof TouchEvent) {\r\n      x = e.touches[0].pageX;\r\n      y = e.touches[0].pageY;\r\n    } else if (e instanceof MouseEvent) {\r\n      x = e.x;\r\n      y = e.y;\r\n    }\r\n    if (!x || !y) {\r\n      return;\r\n    }\r\n\r\n    this.close();\r\n    e.preventDefault();\r\n    this.menuPosition.emit({ x, y });\r\n    this.overlayRef = null;\r\n    const positionStrategy = this.overlay\r\n      .position()\r\n      .flexibleConnectedTo({ x, y })\r\n      .withPositions([\r\n        {\r\n          originX: 'end',\r\n          originY: 'bottom',\r\n          overlayX: 'start',\r\n          overlayY: 'top'\r\n        }\r\n      ]);\r\n    this.overlayRef = this.overlay.create({\r\n      positionStrategy,\r\n      scrollStrategy: this.overlay.scrollStrategies.close()\r\n    });\r\n    this.overlayRef.attach(\r\n      new TemplatePortal(this.menuContext, this.viewContainerRef, {\r\n        $implicit: undefined\r\n      })\r\n    );\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'click')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          this.close();\r\n          return (\r\n            !!this.overlayRef &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          );\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'contextmenu')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          if (\r\n            clickTarget &&\r\n            !this.elementRef.nativeElement.contains(clickTarget) &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          ) {\r\n            return true;\r\n          } else {\r\n            event.preventDefault();\r\n          }\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n  }\r\n\r\n  close() {\r\n    if (this.overlayRef) {\r\n      this.overlayRef.dispose();\r\n      this.overlayRef = null;\r\n    }\r\n    if (this.sub) {\r\n      this.sub.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { Directive, HostListener, Output, EventEmitter, Input } from '@angular/core';\r\nimport { userAgent } from '@igo2/utils';\r\n\r\n\r\n/**\r\n * IgoLongPress trigger longpress event after a define duration.\r\n * This directive exist to patch the unavailable contextmenu event on iOS.\r\n * @param touchDuration touch duration in ms, default value is 400ms\r\n * @param iOSOnly define if longpress is triggered only for iOS, default value = true\r\n */\r\n@Directive({\r\n  selector: '[igoLongPress]'\r\n})\r\nexport class LongPressDirective {\r\n  private touchTimeout: any;\r\n  @Input() touchDuration: number = 400;\r\n  @Input() onlyIOS: boolean = true;\r\n  @Output() longpress = new EventEmitter();\r\n\r\n  constructor() { }\r\n\r\n\r\n  @HostListener('touchstart', ['$event'])\r\n  public touchstart(e: TouchEvent) {\r\n    if (e.touches.length > 1) {\r\n      this.touchEnd();\r\n      return;\r\n    }\r\n    this.touchTimeout = setTimeout(() => {\r\n      if (this.onlyIOS) {\r\n        if (userAgent.getOSName() === 'iOS') {\r\n          this.longpress.emit(e);\r\n        }\r\n      } else {\r\n        this.longpress.emit(e);\r\n      }\r\n    }, this.touchDuration);\r\n  }\r\n  @HostListener('touchmove')\r\n  @HostListener('touchcancel')\r\n  @HostListener('touchend')\r\n  public touchend() {\r\n    this.touchEnd();\r\n  }\r\n\r\n\r\n  private touchEnd() {\r\n    clearTimeout(this.touchTimeout);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ContextMenuDirective } from './context-menu.directive';\r\nimport { LongPressDirective } from './long-press.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ContextMenuDirective, LongPressDirective],\r\n  exports: [ContextMenuDirective, LongPressDirective]\r\n})\r\nexport class IgoContextMenuModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMenuModule> {\r\n    return {\r\n      ngModule: IgoContextMenuModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-custom-html',\r\n  templateUrl: './custom-html.component.html',\r\n  styleUrls: ['./custom-html.component.scss']\r\n})\r\nexport class CustomHtmlComponent {\r\n  @Input()\r\n  get html(): string {\r\n    return this._html;\r\n  }\r\n  set html(value: string) {\r\n    this._html = value;\r\n  }\r\n  private _html = '';\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"custom-html\" [innerHTML]=\"html | sanitizeHtml\"></div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { CustomHtmlComponent } from './custom-html.component';\r\nimport { SanitizeHtmlPipe } from './custom-html.pipe';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SanitizeHtmlPipe, CustomHtmlComponent],\r\n  declarations: [SanitizeHtmlPipe, CustomHtmlComponent]\r\n})\r\nexport class IgoCustomHtmlModule {\r\n  static forRoot(): ModuleWithProviders<IgoCustomHtmlModule> {\r\n    return {\r\n      ngModule: IgoCustomHtmlModule\r\n    };\r\n  }\r\n}\r\n","import { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { throwError } from 'rxjs';\r\n\r\nimport { DOMOptions, DOMValue } from './dom.interfaces';\r\nimport { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DOMService {\r\n\r\n  constructor(private http: HttpClient) {}\r\n\r\n  async getDom(dom: DOMOptions): Promise<DOMValue[]> {\r\n    const url = dom.url;\r\n    let result: DOMValue[];\r\n\r\n    await this.http.get<any>(url).pipe(\r\n      map(response => {\r\n        result = response;\r\n        return response;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        return throwError(err);\r\n      })\r\n    ).toPromise();\r\n\r\n    return result;\r\n  }\r\n\r\n}\r\n","import { ModuleWithProviders, NgModule } from '@angular/core';\r\n\r\nimport { DOMService } from './dom.service';\r\n\r\n@NgModule({\r\n  providers: [DOMService]\r\n})\r\nexport class IgoDOMModule {\r\n  static forRoot(): ModuleWithProviders<IgoDOMModule> {\r\n    return {\r\n      ngModule: IgoDOMModule,\r\n      providers: [\r\n        DOMService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { DragAndDropDirective } from './drag-drop.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [DragAndDropDirective],\r\n  exports: [DragAndDropDirective]\r\n})\r\nexport class IgoDrapDropModule {\r\n  static forRoot(): ModuleWithProviders<IgoDrapDropModule> {\r\n    return {\r\n      ngModule: IgoDrapDropModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  ComponentFactory,\r\n  ComponentRef,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\n\r\nimport { Observable, Subscription } from 'rxjs';\r\n\r\n/**\r\n * This class is used in the DynamicComponentOutlet component. It holds\r\n * a reference to a component factory and can render that component\r\n * in a target element on demand. It's also possible to set inputs\r\n * and to subscribe to outputs.\r\n */\r\nexport class DynamicComponent<C> {\r\n\r\n  /**\r\n   * Component reference\r\n   */\r\n  private componentRef: ComponentRef<C>;\r\n\r\n  /**\r\n   * Subscriptions to the component's outputs. Those need\r\n   * to be unsubscribed when the component is destroyed.\r\n   */\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  /**\r\n   * Component target element\r\n   */\r\n  private target: ViewContainerRef;\r\n\r\n  /**\r\n   * Component inputs\r\n   */\r\n  private inputs: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Subscriptions to the component's async inputs\r\n   */\r\n  private inputs$$: {[key: string]: Subscription} = {};\r\n\r\n  /**\r\n   * Subscribers to the component's outputs\r\n   */\r\n  private subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  constructor(private componentFactory: ComponentFactory<C>) {}\r\n\r\n  /**\r\n   * Render the component to a target element.\r\n   * Set it's inputs and subscribe to it's outputs.\r\n   * @param target Target element\r\n   */\r\n  setTarget(target: ViewContainerRef) {\r\n    this.target = target;\r\n    this.componentRef = target.createComponent(this.componentFactory);\r\n    this.updateInputs(this.inputs);\r\n    this.updateSubscribers(this.subscribers);\r\n  }\r\n\r\n  /**\r\n   * Destroy this component. That means, removing from it's target\r\n   * element and unsubscribing to it's outputs.\r\n   */\r\n  destroy() {\r\n    if (this.target !== undefined) {\r\n      this.target.clear();\r\n    }\r\n    if (this.componentRef !== undefined) {\r\n      this.componentRef.destroy();\r\n      this.componentRef = undefined;\r\n    }\r\n    this.unobserveAllInputs();\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  /**\r\n   * Update the component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateInputs(inputs: {[key: string]: any}) {\r\n    this.inputs = inputs;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedInputs = this.componentFactory.inputs;\r\n    allowedInputs.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n\r\n      this.unobserveInput(key);\r\n\r\n      const inputValue = inputs[key];\r\n      if (inputs.hasOwnProperty(key)) {\r\n        if (inputValue instanceof Observable) {\r\n          this.observeInput(key, inputValue);\r\n        } else {\r\n          this.setInputValue(instance, key, inputValue);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (typeof (instance as any).onUpdateInputs === 'function') {\r\n      (instance as any).onUpdateInputs();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set an instance's input value\r\n   * @param instance Component instance\r\n   * @param key Input key\r\n   * @param value Input value\r\n   */\r\n  private setInputValue(instance: C, key: string, value: any) {\r\n    const currentValue = instance[key];\r\n    if (value === currentValue) {\r\n      return;\r\n    }\r\n\r\n    const prototype = Object.getPrototypeOf(instance);\r\n    const descriptor = Object.getOwnPropertyDescriptor(prototype, key);\r\n    if (descriptor !== undefined && descriptor.set !== undefined) {\r\n      descriptor.set.call(instance, value);\r\n    } else {\r\n      instance[key] = value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateSubscribers(subscribers: {[key: string]: (event: any) => void}) {\r\n    this.subscribers = subscribers;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedSubscribers = this.componentFactory.outputs;\r\n    allowedSubscribers.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n      if (subscribers.hasOwnProperty(key)) {\r\n        const emitter = instance[key];\r\n        const subscriber = subscribers[key];\r\n        if (Array.isArray(subscriber)) {\r\n          subscriber.forEach((_subscriber) => {\r\n            this.subscriptions.push(emitter.subscribe(_subscriber));\r\n          });\r\n        } else {\r\n          this.subscriptions.push(emitter.subscribe(subscriber));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an observable input and update the component's input value\r\n   * accordingly\r\n   * @param key Input key\r\n   * @param observable Observable\r\n   */\r\n  private observeInput(key: string, observable: Observable<any>) {\r\n    this.inputs$$[key] = observable.subscribe((value: any) => {\r\n      const instance = this.componentRef.instance;\r\n      this.setInputValue(instance, key, value);\r\n\r\n      if (typeof (instance as any).onUpdateInputs === 'function') {\r\n        (instance as any).onUpdateInputs();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to an observable input\r\n   * @param key Input key\r\n   */\r\n  private unobserveInput(key: string) {\r\n    if (this.inputs$$[key] !== undefined) {\r\n      this.inputs$$[key].unsubscribe();\r\n      this.inputs$$[key] = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unobserveAllInputs() {\r\n    Object.values(this.inputs$$).forEach((s: Subscription | undefined) => {\r\n      if (s !== undefined) {\r\n        s.unsubscribe();\r\n      }\r\n    });\r\n    this.inputs$$ = {};\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unsubscribeAll() {\r\n    this.subscriptions.forEach((s: Subscription) => s.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n}\r\n","import {\r\n  ComponentFactoryResolver,\r\n  Injectable\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from './dynamic-component';\r\n\r\n/**\r\n * Service to creates DynamicComponent instances from base component classes\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DynamicComponentService {\r\n\r\n  constructor(private resolver: ComponentFactoryResolver) {}\r\n\r\n  /**\r\n   * Creates a DynamicComponent instance from a base component class\r\n   * @param componentCls The component class\r\n   * @returns DynamicComponent instance\r\n   */\r\n  create(componentCls: any): DynamicComponent<any> {\r\n    const factory = this.resolver.resolveComponentFactory(componentCls as any);\r\n    return new DynamicComponent<typeof componentCls>(factory);\r\n  }\r\n}\r\n","import {\r\n  Input,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  Component,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ViewContainerRef,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { DynamicComponent } from '../shared/dynamic-component';\r\nimport { DynamicComponentService } from '../shared/dynamic-component.service';\r\n\r\n@Component({\r\n  selector: 'igo-dynamic-outlet',\r\n  templateUrl: 'dynamic-outlet.component.html',\r\n  styleUrls: ['dynamic-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DynamicOutletComponent implements OnChanges, OnDestroy {\r\n  /**\r\n   * The dynamic component base class or the dynamic component itself\r\n   */\r\n  @Input() component: DynamicComponent<any> | any;\r\n\r\n  /**\r\n   * The dynamic component inputs\r\n   */\r\n  @Input() inputs: { [key: string]: any } = {};\r\n\r\n  /**\r\n   * The subscribers to the dynamic component outputs\r\n   */\r\n  @Input() subscribers: { [key: string]: (event: any) => void } = {};\r\n\r\n  /**\r\n   * The dynamic component\r\n   */\r\n  private dynamicComponent: DynamicComponent<any>;\r\n\r\n  /**\r\n   * The view element to render the component to\r\n   * @ignore\r\n   */\r\n  @ViewChild('target', { read: ViewContainerRef, static: true })\r\n  private target: ViewContainerRef;\r\n\r\n  constructor(\r\n    private dynamicComponentService: DynamicComponentService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * If the dynamic component changes, create it.\r\n   * If the inputs or subscribers change, update the current component's\r\n   * inputs or subscribers.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const component = changes.component;\r\n    const inputs = changes.inputs;\r\n    const subscribers = changes.subscribers;\r\n    const eq = ObjectUtils.objectsAreEquivalent;\r\n\r\n    if (!component || !component.currentValue) {\r\n      return;\r\n    }\r\n\r\n    if (component.currentValue !== component.previousValue) {\r\n      this.createComponent(component.currentValue);\r\n    } else {\r\n      const inputsAreEquivalents =\r\n        inputs && eq(inputs.currentValue || {}, inputs.previousValue || {});\r\n      const subscribersAreEquivalents =\r\n        subscribers &&\r\n        eq(subscribers.currentValue || {}, subscribers.previousValue || {});\r\n\r\n      if (inputsAreEquivalents === false) {\r\n        this.updateInputs();\r\n      }\r\n\r\n      if (subscribersAreEquivalents === false) {\r\n        this.updateSubscribers();\r\n      }\r\n    }\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Destroy the dynamic component and all it's subscribers\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.dynamicComponent) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a  DynamicComponent out of the component class and render it.\r\n   * @internal\r\n   */\r\n  private createComponent(component: DynamicComponent<any> | any) {\r\n    if (this.dynamicComponent !== undefined) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n    this.dynamicComponent =\r\n      component instanceof DynamicComponent\r\n        ? component\r\n        : this.dynamicComponentService.create(component);\r\n    this.renderComponent();\r\n  }\r\n\r\n  /**\r\n   * Create and render the dynamic component. Set it's inputs and subscribers\r\n   * @internal\r\n   */\r\n  private renderComponent() {\r\n    this.updateInputs();\r\n    this.updateSubscribers();\r\n    this.dynamicComponent.setTarget(this.target);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateInputs() {\r\n    this.dynamicComponent.updateInputs(this.inputs);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateSubscribers() {\r\n    this.dynamicComponent.updateSubscribers(this.subscribers);\r\n  }\r\n}\r\n","<ng-template #target></ng-template>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { DynamicOutletComponent } from './dynamic-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    DynamicOutletComponent\r\n  ],\r\n  declarations: [\r\n    DynamicOutletComponent\r\n  ]\r\n})\r\nexport class IgoDynamicOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoDynamicOutletModule } from './dynamic-outlet/dynamic-outlet.module';\r\nimport { DynamicComponentService } from './shared/dynamic-component.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    IgoDynamicOutletModule\r\n  ],\r\n  providers: [\r\n    DynamicComponentService\r\n  ]\r\n})\r\nexport class IgoDynamicComponentModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FlexibleComponent } from './flexible.component';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [FlexibleComponent],\r\n  exports: [FlexibleComponent]\r\n})\r\nexport class IgoFlexibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoFlexibleModule> {\r\n    return {\r\n      ngModule: IgoFlexibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ChangeDetectionStrategy,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport { t } from 'typy';\r\n\r\nimport { Form, FormField, FormFieldGroup } from '../shared/form.interfaces';\r\nimport { getAllFormFields } from '../shared/form.utils';\r\n\r\n/**\r\n * A configurable form\r\n */\r\n@Component({\r\n  selector: 'igo-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormComponent implements OnChanges {\r\n\r\n  /**\r\n   * Form\r\n   */\r\n  @Input() form: Form;\r\n\r\n  /**\r\n   * Input data\r\n   */\r\n  @Input() formData: { [key: string]: any};\r\n\r\n  /**\r\n   * Form autocomplete\r\n   */\r\n  @Input() autocomplete: string = 'off';\r\n\r\n  /**\r\n   * Event emitted when the form is submitted\r\n   */\r\n  @Output() submitForm = new EventEmitter<{[key: string]: any}>();\r\n\r\n  @ViewChild('buttons', { static: true }) buttons: ElementRef;\r\n\r\n  get hasButtons(): boolean {\r\n    return this.buttons.nativeElement.children.length !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Is the entity or the template change, recreate the form or repopulate it.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const formData = changes.formData;\r\n    if (formData && formData.currentValue !== formData.previousValue) {\r\n      if (formData.currentValue === undefined) {\r\n        this.clear();\r\n      } else {\r\n        this.setData(formData.currentValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform the form data to a feature and emit an event\r\n   * @param event Form submit event\r\n   * @internal\r\n   */\r\n  onSubmit() {\r\n    this.submitForm.emit(this.getData());\r\n  }\r\n\r\n  getData(): { [key: string]: any} {\r\n    const data = {};\r\n    getAllFormFields(this.form).forEach((field: FormField) => {\r\n      this.updateDataWithFormField(data, field);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  private setData(data: {[key: string]: any}) {\r\n    this.form.fields.forEach((field: FormField) => {\r\n      field.control.setValue(t(data, field.name).safeObject);\r\n    });\r\n\r\n    this.form.groups.forEach((group: FormFieldGroup) => {\r\n      group.fields.forEach((field: FormField) => {\r\n        field.control.setValue(t(data, field.name).safeObject);\r\n      });\r\n    });\r\n  }\r\n\r\n  private updateDataWithFormField(data: { [key: string]: any}, field: FormField) {\r\n    const control = field.control;\r\n    if (!control.disabled) {\r\n      data[field.name] = control.value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear form\r\n   */\r\n  private clear() {\r\n    this.form.control.reset();\r\n  }\r\n\r\n}\r\n","import { AbstractControl } from '@angular/forms';\r\n\r\nimport { Form, FormField, FormFieldGroup } from './form.interfaces';\r\n\r\nexport function formControlIsRequired(control: AbstractControl): boolean {\r\n  if (control.validator) {\r\n    const validator = control.validator({} as AbstractControl);\r\n    if (validator && validator.required) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  if ((control as any).controls) {\r\n    const requiredControl = Object.keys((control as any).controls).find((key: string) => {\r\n      return formControlIsRequired((control as any).controls[key]);\r\n    });\r\n    return requiredControl !== undefined;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function getDefaultErrorMessages(): {[key: string]: string} {\r\n  return {\r\n    required: 'igo.common.form.errors.required'\r\n  };\r\n}\r\n\r\nexport function getControlErrorMessage(control: AbstractControl, messages: {[key: string]: string}): string {\r\n  const errors = control.errors || {};\r\n  const errorKeys = Object.keys(errors);\r\n  const errorMessages = errorKeys\r\n    .map((key: string) => messages[key])\r\n    .filter((message: string) => message !== undefined);\r\n  return errorMessages.length > 0 ? errorMessages[0] : '';\r\n}\r\n\r\nexport function getAllFormFields(form: Form): FormField[] {\r\n  return form.groups.reduce((acc: FormField[], group: FormFieldGroup) => {\r\n    return acc.concat(group.fields);\r\n  }, [].concat(form.fields));\r\n}\r\n\r\nexport function getFormFieldByName(form: Form, name: string): FormField {\r\n  const fields = getAllFormFields(form);\r\n  return fields.find((field: FormField) => {\r\n    return field.name === name;\r\n  });\r\n}\r\n","\r\n<form\r\n  [autocomplete]=\"autocomplete\"\r\n  [formGroup]=\"form.control\"\r\n  (ngSubmit)=\"onSubmit()\">\r\n  <div class=\"igo-form-body\" [ngClass]=\"{'igo-form-body-with-buttons': hasButtons}\">\r\n    <div class=\"igo-form-content\">\r\n      <ng-content></ng-content>\r\n    </div>\r\n    <div #buttons class=\"igo-form-buttons\">\r\n      <ng-content select=\"[formButtons]\"></ng-content>\r\n    </div>\r\n  </div>\r\n</form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { FormComponent } from './form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  exports: [\r\n    FormComponent,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  declarations: [\r\n    FormComponent\r\n  ]\r\n})\r\nexport class IgoFormFormModule {}\r\n","import { Injectable } from '@angular/core';\r\nimport { UntypedFormBuilder, Validators, ValidatorFn } from '@angular/forms';\r\n\r\nimport {\r\n  Form,\r\n  FormField,\r\n  FormFieldConfig,\r\n  FormFieldGroup,\r\n  FormFieldGroupConfig\r\n} from './form.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormService {\r\n\r\n  constructor(private formBuilder: UntypedFormBuilder) {}\r\n\r\n  form(fields: FormField[], groups: FormFieldGroup[]): Form {\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n    groups.forEach((group: FormFieldGroup) => {\r\n      control.addControl(group.name, group.control);\r\n    });\r\n\r\n    return {fields, groups, control};\r\n  }\r\n\r\n  group(config: FormFieldGroupConfig, fields: FormField[]): FormFieldGroup {\r\n    const options = config.options || {};\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({}, config, {fields, control}) as FormFieldGroup;\r\n  }\r\n\r\n  field(config: FormFieldConfig): FormField {\r\n    const options = config.options || {};\r\n    const state = {\r\n      value: '',\r\n      disabled: options.disabled\r\n    };\r\n    const control = this.formBuilder.control(state);\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({type: 'text'}, config, {control}) as FormField;\r\n  }\r\n\r\n  extendFieldConfig(config: FormFieldConfig, partial: Partial<FormFieldConfig>): FormFieldConfig {\r\n    const options = Object.assign({}, config.options || {}, partial.options || {});\r\n    const inputs = Object.assign({}, config.inputs || {}, partial.inputs || {});\r\n    const subscribers = Object.assign({}, config.subscribers || {}, partial.subscribers || {});\r\n    return Object.assign({}, config, {options, inputs, subscribers});\r\n  }\r\n\r\n  private getValidators(validatorOption: string | string[] | ValidatorFn): ValidatorFn | ValidatorFn[] {\r\n    if (Array.isArray(validatorOption)) {\r\n      return validatorOption.map((validatorStr) => {\r\n        return this.getValidator(validatorStr);\r\n      });\r\n    }\r\n\r\n    return this.getValidator(validatorOption);\r\n  }\r\n\r\n  private getValidator(validatorStr: string | ValidatorFn): ValidatorFn {\r\n    if (typeof validatorStr !== 'string') {\r\n      return validatorStr;\r\n    }\r\n\r\n    // regex pattern to extract arguments from string for e.g applying on \"minLength(8)\" would extract 8\r\n    const re = /^([a-zA-Z]{3,15})\\((.{0,20})\\)$/;\r\n    const match = validatorStr.match(re);\r\n\r\n    if (!match) {\r\n      return Validators[validatorStr];\r\n    }\r\n\r\n    const name = match[1];\r\n    const args = match[2];\r\n    return Validators[name](args);\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n/**\r\n * Service where all available form fields are registered.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormFieldService {\r\n\r\n  static fields: {[key: string]: any} = {};\r\n\r\n  static register(type: string, component: any) {\r\n    FormFieldService.fields[type] = component;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return field component by type\r\n   * @param type Field type\r\n   * @returns Field component\r\n   */\r\n  getFieldByType(type: string): any {\r\n    return FormFieldService.fields[type];\r\n  }\r\n\r\n}\r\n","\r\n\r\n<ng-container *ngIf=\"field !== undefined\">\r\n  <igo-dynamic-outlet\r\n    [component]=\"getFieldComponent()\"\r\n    [inputs]=\"getFieldInputs()\"\r\n    [subscribers]=\"getFieldSubscribers()\">\r\n  </igo-dynamic-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { FormField, FormFieldInputs, FormFieldOptions } from '../shared/form.interfaces';\r\nimport { FormFieldService } from '../shared/form-field.service';\r\nimport { getDefaultErrorMessages } from '../shared';\r\n\r\n/**\r\n * This component renders the proper form input based on\r\n * the field configuration it receives.\r\n */\r\n@Component({\r\n  selector: 'igo-form-field',\r\n  templateUrl: './form-field.component.html',\r\n  styleUrls: ['./form-field.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormFieldComponent {\r\n\r\n  /**\r\n   * Field configuration\r\n   */\r\n  @Input() field: FormField;\r\n\r\n  /**\r\n   * Field inputs cache\r\n   */\r\n  private fieldInputs: FormFieldInputs = undefined;\r\n\r\n  /**\r\n   * Field subscribers cache\r\n   */\r\n  private fieldSubscribers: {[key: string]: ({field: FormField, control: FormControl}) => void } = undefined;\r\n\r\n  get fieldOptions(): FormFieldOptions {\r\n    return this.field.options || {};\r\n  }\r\n\r\n  constructor(private formFieldService: FormFieldService) {}\r\n\r\n  getFieldComponent(): any {\r\n    return this.formFieldService.getFieldByType(this.field.type || 'text');\r\n  }\r\n\r\n  getFieldInputs(): FormFieldInputs {\r\n    if (this.fieldInputs !== undefined) {\r\n      return this.fieldInputs;\r\n    }\r\n\r\n    const errors = this.fieldOptions.errors || {};\r\n    this.fieldInputs = Object.assign(\r\n      {\r\n        placeholder: this.field.title,\r\n        disableSwitch: this.fieldOptions.disableSwitch || false\r\n      },\r\n      Object.assign({}, this.field.inputs || {}),\r\n      {\r\n        formControl: this.field.control,\r\n        errors: Object.assign({}, getDefaultErrorMessages(), errors)\r\n      }\r\n    );\r\n    return this.fieldInputs;\r\n  }\r\n\r\n  getFieldSubscribers(): {[key: string]: ({field: FormField, control: FormControl}) => void } {\r\n    if (this.fieldSubscribers !== undefined) {\r\n      return this.fieldSubscribers;\r\n    }\r\n\r\n    this.fieldSubscribers = Object.assign({}, this.field.subscribers || {});\r\n    return this.fieldSubscribers;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoDynamicOutletModule } from '../../dynamic-component/dynamic-outlet/dynamic-outlet.module';\r\n\r\nimport { FormFieldComponent } from './form-field.component';\r\nimport { FormFieldSelectComponent } from './form-field-select.component';\r\nimport { FormFieldTextComponent } from './form-field-text.component';\r\nimport { FormFieldTextareaComponent } from './form-field-textarea.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    IgoLanguageModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ],\r\n  declarations: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ]\r\n})\r\nexport class IgoFormFieldModule {}\r\n","<div\r\n  *ngIf=\"group && group.fields.length > 0\"\r\n  class=\"igo-form-group-fields\">\r\n  <div\r\n    *ngFor=\"let field of group.fields\"\r\n    class=\"igo-form-field-wrapper\"\r\n    [ngClass]=\"getFieldNgClass(field)\">\r\n    <igo-form-field [field]=\"field\"></igo-form-field>\r\n  </div>\r\n</div>\r\n\r\n<div class=\"igo-form-group-extra-content\">\r\n  <ng-content></ng-content>\r\n</div>\r\n\r\n<mat-error *ngIf=\"formControl.errors\">{{getErrorMessage() | translate}}</mat-error>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { UntypedFormGroup } from '@angular/forms';\r\n\r\nimport { getControlErrorMessage } from '../shared/form.utils';\r\nimport { FormField, FormFieldGroup } from '../shared/form.interfaces';\r\n\r\n/**\r\n * A configurable form, optionnally bound to an entity\r\n * (for example in case of un update). Submitting that form\r\n * emits an event with the form data but no other operation is performed.\r\n */\r\n@Component({\r\n  selector: 'igo-form-group',\r\n  templateUrl: './form-group.component.html',\r\n  styleUrls: ['./form-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormGroupComponent {\r\n\r\n  /**\r\n   * Form field group\r\n   */\r\n  @Input() group: FormFieldGroup;\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() errors: {[key: string]: string};\r\n\r\n  /**\r\n   * Form group control\r\n   */\r\n  get formControl(): UntypedFormGroup { return this.group.control; }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldColSpan(field: FormField): number {\r\n    let colSpan = 2;\r\n    const options = field.options || {};\r\n    if (options.cols && options.cols > 0) {\r\n      colSpan = Math.min(options.cols, 2);\r\n    }\r\n\r\n    return colSpan;\r\n  }\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldNgClass(field: FormField): {[key: string]: boolean} {\r\n    const colspan = this.getFieldColSpan(field);\r\n    return {[`igo-form-field-colspan-${colspan}`]: true};\r\n  }\r\n\r\n  /**\r\n   * Get error message\r\n   */\r\n  getErrorMessage(): string {\r\n    const options = this.group.options || {};\r\n    return getControlErrorMessage(this.formControl, options.errors || {});\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFormFieldModule } from '../form-field/form-field.module';\r\nimport { FormGroupComponent } from './form-group.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatFormFieldModule,\r\n    IgoLanguageModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    FormGroupComponent\r\n  ],\r\n  declarations: [\r\n    FormGroupComponent\r\n  ]\r\n})\r\nexport class IgoFormGroupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormFormModule } from './form/form.module';\r\nimport { IgoFormGroupModule } from './form-group/form-group.module';\r\nimport { IgoFormFieldModule } from './form-field/form-field.module';\r\nimport { FormService } from './shared/form.service';\r\nimport { FormFieldService } from './shared/form-field.service';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoFormFormModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    FormService,\r\n    FormFieldService\r\n  ]\r\n})\r\nexport class IgoFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { EntitySelectorComponent } from './entity-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatSelectModule\r\n  ],\r\n  exports: [EntitySelectorComponent],\r\n  declarations: [EntitySelectorComponent]\r\n})\r\nexport class IgoEntitySelectorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { StopDropPropagationDirective } from './stop-drop-propagation.directive';\r\nimport { StopPropagationDirective } from './stop-propagation.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [StopDropPropagationDirective, StopPropagationDirective],\r\n  exports: [StopDropPropagationDirective, StopPropagationDirective]\r\n})\r\nexport class IgoStopPropagationModule {\r\n  static forRoot(): ModuleWithProviders<IgoStopPropagationModule> {\r\n    return {\r\n      ngModule: IgoStopPropagationModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { EntityTablePaginatorComponent } from './entity-table-paginator.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    MatPaginatorModule,\r\n  ],\r\n  exports: [\r\n    EntityTablePaginatorComponent\r\n  ],\r\n  declarations: [\r\n    EntityTablePaginatorComponent,\r\n  ]\r\n})\r\nexport class IgoEntityTablePaginatorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ImageErrorDirective } from './image-error.directive';\r\nimport { SecureImagePipe } from './secure-image.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [SecureImagePipe, ImageErrorDirective],\r\n  exports: [SecureImagePipe, ImageErrorDirective]\r\n})\r\nexport class IgoImageModule {\r\n  static forRoot(): ModuleWithProviders<IgoImageModule> {\r\n    return {\r\n      ngModule: IgoImageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\n\r\nimport { IgoStopPropagationModule } from '../../stop-propagation/stop-propagation.module';\r\nimport { IgoCustomHtmlModule } from '../../custom-html/custom-html.module';\r\nimport { EntityTableRowDirective } from './entity-table-row.directive';\r\nimport { EntityTableComponent } from './entity-table.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\nimport { IgoEntityTablePaginatorModule } from '../entity-table-paginator/entity-table-paginator.module';\r\nimport { IgoImageModule } from '../../image/image.module';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTableModule,\r\n    MatAutocompleteModule,\r\n    MatSortModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatCheckboxModule,\r\n    MatPaginatorModule,\r\n    MatSelectModule,\r\n    IgoStopPropagationModule,\r\n    IgoCustomHtmlModule,\r\n    IgoEntityTablePaginatorModule,\r\n    IgoImageModule,\r\n    IgoLanguageModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatDatepickerModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    EntityTableComponent\r\n  ],\r\n  declarations: [\r\n    EntityTableComponent,\r\n    EntityTableRowDirective\r\n  ]\r\n})\r\nexport class IgoEntityTableModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from './entity-selector/entity-selector.module';\r\nimport { IgoEntityTableModule } from './entity-table/entity-table.module';\r\nimport { IgoEntityTablePaginatorModule } from './entity-table-paginator/entity-table-paginator.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoEntitySelectorModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoEntityModule {}\r\n","import { catchError } from 'rxjs/operators';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Injectable } from '@angular/core';\r\nimport { InteractiveTourOptions } from './interactive-tour.interface';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable()\r\nexport class InteractiveTourLoader {\r\n  private jsonURL: string;\r\n  private allToursOptions;\r\n\r\n  constructor(private http: HttpClient, private configService: ConfigService) {\r\n    this.jsonURL = this.getPathToConfigFile();\r\n  }\r\n\r\n   public loadConfigTour() {\r\n      this.getJSON()\r\n        .subscribe(\r\n          (data) => {\r\n            this.allToursOptions = data;\r\n          },\r\n          (err) => {\r\n            throw new Error(`Problem with Interactive tour configuration file: interactiveTour.json not find. Check if the file and is path is set correctly.`);\r\n          }\r\n        );\r\n   }\r\n\r\n  public getPathToConfigFile(): string {\r\n    return (\r\n      this.configService.getConfig('interactiveTour.pathToConfigFile') ||\r\n      './config/interactiveTour.json'\r\n    );\r\n  }\r\n\r\n  public getJSON(): Observable<any> {\r\n    return this.http.get(this.jsonURL).pipe(\r\n      catchError((e) => {\r\n        e.error.caught = true;\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  public getTourOptionData(toolName): InteractiveTourOptions {\r\n    if (this.allToursOptions === undefined) {\r\n      return undefined;\r\n    }\r\n    let nameInConfigFile = toolName;\r\n    nameInConfigFile = nameInConfigFile.replace(/\\s/g, '');\r\n    return this.allToursOptions[nameInConfigFile];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { ShepherdService } from 'angular-shepherd';\r\n\r\nimport { ConfigService, MediaService, LanguageService } from '@igo2/core';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\nimport {\r\n  InteractiveTourOptions,\r\n  InteractiveTourStep,\r\n  InteractiveTourAction\r\n} from './interactive-tour.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class InteractiveTourService {\r\n  private previousStep: InteractiveTourStep;\r\n  private nextIndex = 1;\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService,\r\n    private interactiveTourLoader: InteractiveTourLoader,\r\n    private shepherdService: ShepherdService\r\n  ) {\r\n    if (this.isAppHaveTour()) {\r\n      this.interactiveTourLoader.loadConfigTour();\r\n    }\r\n  }\r\n\r\n  public isAppHaveTour() {\r\n    const haveTour = this.configService.getConfig('interactiveTour.activateInteractiveTour');\r\n    if (haveTour === undefined) {\r\n      return true;\r\n    } else {\r\n      return haveTour;\r\n    }\r\n  }\r\n\r\n  public isToolHaveTourConfig(toolName: string): boolean {\r\n    const checkTourActiveOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n    if (checkTourActiveOptions === undefined) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  public disabledTourButton(toolName: string): boolean {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    if (stepConfig?.conditions) {\r\n      for (const condition of stepConfig?.conditions) {\r\n        if (document.querySelector(condition) === null) {\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public isMobile(): boolean {\r\n    return this.mediaService.isMobile();\r\n  }\r\n\r\n  public isTourDisplayInMobile(): boolean {\r\n    const showInMobile = this.configService.getConfig(\r\n      'interactiveTour.tourInMobile'\r\n    );\r\n    if (showInMobile === undefined) {\r\n      return true;\r\n    }\r\n    return this.configService.getConfig('interactiveTour.tourInMobile');\r\n  }\r\n\r\n  private getButtons(buttonKind?: 'first' | 'last' | 'noBackButton') {\r\n    if (buttonKind === 'noBackButton') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n    if (buttonKind === 'first') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n\r\n    if (buttonKind === 'last') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.backButton'\r\n          ),\r\n          type: 'back'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        }\r\n      ];\r\n    }\r\n\r\n    return [\r\n      {\r\n        classes: 'shepherd-button-secondary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.backButton'\r\n        ),\r\n        type: 'back'\r\n      },\r\n      {\r\n        classes: 'shepherd-button-primary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.nextButton'\r\n        ),\r\n        type: 'next'\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getAction(actionName: string) {\r\n    const action = {\r\n      click: 'click'\r\n    };\r\n    return action[actionName.toLowerCase()];\r\n  }\r\n\r\n  private addProgress() {\r\n    const self = this as any;\r\n    let nbTry = 0;\r\n    const maxTry = 21;\r\n    const checkExist = setInterval(() => {\r\n      if (self.getCurrentStep()) {\r\n        if (self.getCurrentStep().options.attachTo.element && !document.querySelector(self.getCurrentStep().options.attachTo.element)) {\r\n          self.cancel();\r\n          clearInterval(checkExist);\r\n          return;\r\n        } else {\r\n          const currentStepElement = self.getCurrentStep().getElement();\r\n          if (currentStepElement) {\r\n            const shepherdList = currentStepElement.querySelectorAll('.shepherd-content, .shepherd-text');\r\n            shepherdList.forEach(element => {\r\n              element.classList.add('mat-typography');\r\n            });\r\n          }\r\n          const header = currentStepElement\r\n            ? currentStepElement.querySelector('.shepherd-header')\r\n            : undefined;\r\n\r\n          nbTry++;\r\n          if (header || nbTry > maxTry) {\r\n            clearInterval(checkExist);\r\n          }\r\n\r\n          if (header) {\r\n            const stepsArray = self.steps;\r\n            const progress = document.createElement('span');\r\n            progress.className = 'shepherd-progress';\r\n            progress.innerText = `${\r\n              stepsArray.indexOf(self.getCurrentStep()) + 1\r\n            }/${stepsArray.length}`;\r\n            header.insertBefore(\r\n              progress,\r\n              currentStepElement.querySelector('.shepherd-cancel-icon')\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  private checkNext(index, tour, service) {\r\n    if (tour.getCurrentStep()) {\r\n      if (tour.getCurrentStep().options.attachTo.element && document.querySelector(tour.getCurrentStep().options.attachTo.element)) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      if (index.index === tour.steps.length - 1) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      tour.steps.splice(index.index, 1);\r\n      const nextStep = tour.steps[index.index];\r\n      if (nextStep.options.attachTo.element && !document.querySelector(nextStep.options.attachTo.element)) {\r\n        service.checkNext(index, tour, service);\r\n      } else {\r\n        tour._setupModal();\r\n        tour.show(nextStep.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private executeAction(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    if (!actionConfig) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      actionConfig.condition &&\r\n      ((actionConfig.condition.charAt(0) === '!' &&\r\n        document.querySelector(actionConfig.condition.slice(1))) ||\r\n        (actionConfig.condition.charAt(0) !== '!' &&\r\n          !document.querySelector(actionConfig.condition)))\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const element: HTMLElement = document.querySelector(\r\n      actionConfig.element || step.element\r\n    ) as HTMLElement;\r\n    const action = this.getAction(actionConfig.action);\r\n    if (element && action) {\r\n      element[action]();\r\n    }\r\n  }\r\n\r\n  private executeActionPromise(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    return new Promise<void>((resolve) => {\r\n      this.executeAction(step, actionConfig);\r\n      if (!actionConfig || !actionConfig.waitFor) {\r\n        resolve();\r\n        return;\r\n      }\r\n      let nbTry = 0;\r\n      const maxTry = actionConfig.maxWait ? actionConfig.maxWait / 100 : 20;\r\n      const checkExist = setInterval(() => {\r\n        nbTry++;\r\n        if (nbTry > maxTry || document.querySelector(actionConfig.waitFor)) {\r\n          clearInterval(checkExist);\r\n          resolve();\r\n        }\r\n      }, 100);\r\n    });\r\n  }\r\n\r\n  private getShepherdSteps(stepConfig: InteractiveTourOptions) {\r\n    const shepherdSteps = [];\r\n\r\n    let i = 0;\r\n    for (const step of stepConfig.steps) {\r\n      shepherdSteps.push({\r\n        attachTo: {\r\n          element: step.element,\r\n          on: step.position || stepConfig.position\r\n        },\r\n        popperOptions: {\r\n          modifiers: [{ name: 'offset', options: { offset: [0, 15] } }]\r\n        },\r\n        beforeShowPromise: () => {\r\n          return Promise.all([\r\n            this.executeActionPromise(\r\n              this.previousStep,\r\n              this.previousStep ? this.previousStep.beforeChange : undefined\r\n            ),\r\n            this.executeActionPromise(step, step.beforeShow)\r\n          ]);\r\n        },\r\n        buttons: this.getButtons(\r\n          i === 0\r\n            ? 'first'\r\n            : i + 1 === stepConfig.steps.length\r\n            ? 'last'\r\n            : stepConfig.steps[i].noBackButton\r\n            ? 'noBackButton'\r\n            : undefined\r\n        ),\r\n        classes: step.class,\r\n        highlightClass: step.highlightClass,\r\n        scrollTo: step.scrollToElement || stepConfig.scrollToElement || true,\r\n        canClickTarget: step.disableInteraction\r\n          ? !step.disableInteraction\r\n          : undefined,\r\n        title: this.languageService.translate.instant(\r\n          step.title || stepConfig.title\r\n        ),\r\n        text: [this.languageService.translate.instant(step.text)],\r\n        when: {\r\n          show: () => {\r\n            this.executeAction(step, step.onShow);\r\n          },\r\n          hide: () => {\r\n            this.previousStep = step;\r\n            this.executeAction(step, step.onHide);\r\n          }\r\n        }\r\n      });\r\n      i++;\r\n    }\r\n\r\n    return shepherdSteps;\r\n  }\r\n\r\n  public startTour(toolName: string) {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    this.shepherdService.defaultStepOptions = {\r\n      classes: stepConfig.class,\r\n      highlightClass: stepConfig.highlightClass,\r\n      canClickTarget: stepConfig.disableInteraction\r\n        ? !stepConfig.disableInteraction\r\n        : true,\r\n      cancelIcon: {\r\n        enabled: true\r\n      }\r\n    };\r\n\r\n    const shepherdSteps = this.getShepherdSteps(stepConfig);\r\n\r\n    this.shepherdService.modal = true;\r\n    this.shepherdService.confirmCancel = false;\r\n    this.shepherdService.addSteps(shepherdSteps);\r\n\r\n    this.shepherdService.tourObject.on('show', this.addProgress);\r\n    this.shepherdService.tourObject.on('cancel', (index) => {\r\n      this.checkNext(index, this.shepherdService.tourObject, this);\r\n    });\r\n\r\n    this.shepherdService.start();\r\n  }\r\n}\r\n","import { EntityRecord, EntityStore } from '../../entity';\r\nimport { Tool, ToolboxOptions } from './tool.interface';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service where all available tools and their component are registered.\r\n */\r\nexport class Toolbox {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Ordered list of tool names to display in a toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Active tool history. Useful for activating the previous tool.\r\n   */\r\n  private activeToolHistory: string[] = [];\r\n\r\n  /**\r\n   * Tool store\r\n   */\r\n  private store = new EntityStore<Tool>([], {\r\n    getKey: (tool: Tool) => tool.name\r\n  });\r\n\r\n  get tools$(): BehaviorSubject<Tool[]> {\r\n    return this.store.entities$;\r\n  }\r\n\r\n  constructor(private options: ToolboxOptions = {}) {\r\n    this.setToolbar(options.toolbar);\r\n    this.initStore();\r\n  }\r\n\r\n  /**\r\n   * Destroy the toolbox\r\n   */\r\n  destroy() {\r\n    this.activeTool$$.unsubscribe();\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return this.store.get(name);\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns Array of tools\r\n   */\r\n  getTools(): Tool[] {\r\n    return this.store.all();\r\n  }\r\n\r\n  /**\r\n   * Set tool configurations\r\n   * @param tools Tools\r\n   */\r\n  setTools(tools: Tool[]) {\r\n    this.store.load(tools);\r\n  }\r\n\r\n  /**\r\n   * Get toolbar\r\n   * @returns Toolbar value\r\n   */\r\n  getToolbar(): string[] {\r\n    return this.toolbar$.getValue();\r\n  }\r\n\r\n  /**\r\n   * Set toolbar\r\n   * @param toolbar A list of tool names\r\n   */\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar$.next(toolbar || []);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool (and deactivate other tools)\r\n   * @param name Tool name\r\n   * @param options Tool options\r\n   */\r\n  activateTool(name: string, options: { [key: string]: any } = {}) {\r\n    const tool = this.getTool(name);\r\n    if (tool === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.store.state.update(tool, { active: true, options }, true);\r\n  }\r\n\r\n  /**\r\n   * Activate the previous tool, if any\r\n   */\r\n  activatePreviousTool() {\r\n    if (this.activeToolHistory.length <= 1) {\r\n      this.deactivateTool();\r\n      return;\r\n    }\r\n    const [previous, current] = this.activeToolHistory.splice(-2, 2);\r\n    this.activateTool(previous);\r\n  }\r\n\r\n  /**\r\n   * Activate the tool below, if any\r\n   */\r\n  /* activateBelowTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index + 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const below = arrayTools[index + 1];\r\n      this.activateTool(below);\r\n    } else {\r\n      this.deactivateTool();\r\n      const below = arrayTools[0];\r\n      this.activateTool(below);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Activate the tool above, if any\r\n   */\r\n  /* activateAboveTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index - 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const above = arrayTools[index - 1];\r\n      this.activateTool(above);\r\n    } else {\r\n      this.deactivateTool();\r\n      const above = arrayTools[arrayTools.length - 1];\r\n      this.activateTool(above);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Deactivate the active tool\r\n   */\r\n  deactivateTool() {\r\n    this.clearActiveToolHistory();\r\n    this.store.state.updateAll({ active: false });\r\n  }\r\n\r\n  /**\r\n   * Initialize the tool store and start observing the active tool\r\n   */\r\n  private initStore() {\r\n    this.store = new EntityStore<Tool>([], {\r\n      getKey: (entity: Tool) => entity.name\r\n    });\r\n\r\n    this.activeTool$$ = this.store.stateView\r\n      .firstBy$((record: EntityRecord<Tool>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Tool>) => {\r\n        if (record === undefined) {\r\n          this.setActiveTool(undefined);\r\n          return;\r\n        }\r\n\r\n        const tool = record.entity;\r\n        const options = Object.assign(\r\n          {},\r\n          tool.options || {},\r\n          record.state.options || {}\r\n        );\r\n        this.setActiveTool(Object.assign({}, tool, { options }));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Set the active tool and update the tool history\r\n   * @param tool Tool\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    this.activeTool$.next(tool);\r\n    if (tool === undefined) {\r\n      this.clearActiveToolHistory();\r\n    } else {\r\n      this.activeToolHistory = this.activeToolHistory\r\n        .filter((name: string) => name !== tool.name)\r\n        .concat([tool.name]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the tool history\r\n   */\r\n  private clearActiveToolHistory() {\r\n    this.activeToolHistory = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Tool } from './tool.interface';\r\nimport { Toolbox } from './toolbox';\r\n\r\n/**\r\n * Service where runtime tool configurations are registered\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolService {\r\n  static tools: { [key: string]: Tool } = {};\r\n\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  public toolbox: Toolbox = new Toolbox();\r\n\r\n  static register(tool: Tool) {\r\n    ToolService.tools[tool.name] = tool;\r\n  }\r\n\r\n  constructor() {\r\n    this.toolbox.setTools(this.getTools());\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return ToolService.tools[name];\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns tTols\r\n   */\r\n  getTools(): Tool[] {\r\n    return Object.values(ToolService.tools);\r\n  }\r\n}\r\n","<button *ngIf=\"showTourButton\"\r\n  (click) = \"startInteractiveTour()\"\r\n  [ngClass]=\"getClass()\"\r\n  mat-raised-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [disabled]=disabledTourButton>\r\n  <span class=\"interactive-tour-button-title\">{{'igo.common.interactiveTour.buttonTitle' | translate}} {{(discoverTitleInLocale$ | async) | translate}}</span>\r\n  <mat-icon\r\n    svgIcon=\"presentation-play\"\r\n    [matTooltip]=\"disabledTourButton ?\r\n    ('igo.common.interactiveTour.disaledTooltipTourToolButton' | translate) :\r\n    ('igo.common.interactiveTour.tooltipTourToolButton' | translate)\">\r\n  </mat-icon>\r\n</button>\r\n","import { Component, ViewEncapsulation, Input } from '@angular/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { ToolService } from '../tool/shared/tool.service';\r\nimport { Observable, of } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-interactive-tour',\r\n  templateUrl: './interactive-tour.component.html',\r\n  styleUrls: ['./interactive-tour.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class InteractiveTourComponent {\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  @Input() tourToStart: string = '';\r\n  @Input() styleButton: string;\r\n  @Input() discoverTitleInLocale$: Observable<string> = of('IGO');\r\n\r\n  getClass() {\r\n    return {\r\n      'tour-button-tool-icon': this.styleButton === 'icon',\r\n      'tour-button-tool': this.styleButton === 'raised'\r\n    };\r\n  }\r\n\r\n  get toolbox() {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  getTourToStart() {\r\n    if (this.tourToStart) {\r\n      return this.tourToStart;\r\n    } else {\r\n      return this.activeToolName;\r\n    }\r\n  }\r\n\r\n  get activeToolName() {\r\n    if (this.toolbox) {\r\n      if (this.isActiveTool) {\r\n        return this.toolbox.activeTool$.getValue().name;\r\n      } else {\r\n        return 'global';\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isActiveTool(): boolean {\r\n    if (this.toolbox) {\r\n      return this.toolbox.activeTool$.getValue() !== undefined;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isToolHaveTour(): boolean {\r\n    if (this.activeToolName === 'about' && !this.tourToStart) {\r\n      return false;\r\n    }\r\n    return this.interactiveTourService.isToolHaveTourConfig(\r\n      this.getTourToStart()\r\n    );\r\n  }\r\n\r\n  get showTourButton(): boolean {\r\n    // 2 conditions to show: have Tour on tool in Config file and if we are in mobile displayInMobile= true\r\n    let haveTour: boolean;\r\n    haveTour = this.isToolHaveTour;\r\n    if (haveTour === false) {\r\n      return false;\r\n    }\r\n\r\n    let inMobileAndShow: boolean;\r\n    if (this.interactiveTourService.isMobile()) {\r\n      inMobileAndShow = this.isTourDisplayInMobile;\r\n      if (inMobileAndShow === false) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isTourDisplayInMobile(): boolean {\r\n    return this.interactiveTourService.isTourDisplayInMobile();\r\n  }\r\n\r\n  get disabledTourButton(): boolean {\r\n    return this.interactiveTourService.disabledTourButton(this.activeToolName);\r\n  }\r\n\r\n  constructor(\r\n    private interactiveTourService: InteractiveTourService,\r\n    private toolService: ToolService\r\n  ) {}\r\n\r\n  startInteractiveTour() {\r\n    const tour = this.getTourToStart();\r\n    if (tour) {\r\n      this.interactiveTourService.startTour(tour);\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { InteractiveTourComponent } from './interactive-tour.component';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\n\r\n@NgModule({\r\n  declarations: [InteractiveTourComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  providers: [InteractiveTourService, InteractiveTourLoader],\r\n  exports: [InteractiveTourComponent]\r\n})\r\nexport class IgoInteractiveTourModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\n@Pipe({\r\n  name: 'keyvalue'\r\n})\r\nexport class KeyValuePipe implements PipeTransform {\r\n  transform(value: any, args?: any): any {\r\n    const keyValues = [];\r\n    Object.getOwnPropertyNames(value).forEach((key: string) =>\r\n      keyValues.push({ key, value: value[key] })\r\n    );\r\n\r\n    return keyValues;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { KeyValuePipe } from './keyvalue.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [KeyValuePipe],\r\n  exports: [KeyValuePipe]\r\n})\r\nexport class IgoKeyValueModule {\r\n  static forRoot(): ModuleWithProviders<IgoKeyValueModule> {\r\n    return {\r\n      ngModule: IgoKeyValueModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  ElementRef,\r\n  Renderer2,\r\n  HostListener,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoListItem]'\r\n})\r\nexport class ListItemDirective {\r\n\r\n  static focusedCls = 'igo-list-item-focused';\r\n  static selectedCls = 'igo-list-item-selected';\r\n  static disabledCls = 'igo-list-item-disabled';\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  @Input()\r\n  get focused() {\r\n    return this._focused;\r\n  }\r\n  set focused(value: boolean) {\r\n    if (value === this._focused) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeFocus.emit(this) : this.beforeUnfocus.emit(this);\r\n\r\n    this._focused = value;\r\n    if (this.selected !== true) {\r\n      this.toggleFocusedClass();\r\n    }\r\n\r\n    value ? this.focus.emit(this) : this.unfocus.emit(this);\r\n  }\r\n  private _focused = false;\r\n\r\n  @Input()\r\n  get selected() {\r\n    return this._selected;\r\n  }\r\n  set selected(value: boolean) {\r\n    if (value === this._selected) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeSelect.emit(this) : this.beforeUnselect.emit(this);\r\n\r\n    this._selected = value;\r\n    this._focused = value;\r\n    this.toggleSelectedClass();\r\n\r\n    value ? this.select.emit(this) : this.unselect.emit(this);\r\n  }\r\n  private _selected = false;\r\n\r\n  @Input()\r\n  get disabled() {\r\n    return this._disabled;\r\n  }\r\n  set disabled(value: boolean) {\r\n    if (value === this._disabled) {\r\n      return;\r\n    }\r\n\r\n    if (value === true) {\r\n      this.selected = false;\r\n    }\r\n\r\n    value ? this.beforeDisable.emit(this) : this.beforeEnable.emit(this);\r\n\r\n    this._disabled = value;\r\n    this.toggleDisabledClass();\r\n\r\n    value ? this.disable.emit(this) : this.enable.emit(this);\r\n  }\r\n  private _disabled = false;\r\n\r\n  @Output() beforeSelect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeFocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnselect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeDisable = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeEnable = new EventEmitter<ListItemDirective>();\r\n  @Output() focus = new EventEmitter<ListItemDirective>();\r\n  @Output() unfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() select = new EventEmitter<ListItemDirective>();\r\n  @Output() unselect = new EventEmitter<ListItemDirective>();\r\n  @Output() disable = new EventEmitter<ListItemDirective>();\r\n  @Output() enable = new EventEmitter<ListItemDirective>();\r\n\r\n  @HostListener('click')\r\n  onClick() {\r\n    this.selected = true;\r\n  }\r\n\r\n  constructor(public renderer: Renderer2, public el: ElementRef) {}\r\n\r\n  getOffsetTop(): number {\r\n    const padding = 5;\r\n\r\n    return this.el.nativeElement.offsetTop - padding;\r\n  }\r\n\r\n  private toggleFocusedClass() {\r\n    if (this.focused) {\r\n      this.addCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    }\r\n  }\r\n\r\n  private toggleSelectedClass() {\r\n    if (this.selected) {\r\n      this.addCls(ListItemDirective.selectedCls);\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.selectedCls);\r\n    }\r\n  }\r\n\r\n  private toggleDisabledClass() {\r\n    if (this.disabled) {\r\n      this.addCls(ListItemDirective.disabledCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.disabledCls);\r\n    }\r\n  }\r\n\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  AfterViewInit,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ContentChildren,\r\n  HostListener,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\n\r\n@Component({\r\n  selector: 'igo-list',\r\n  templateUrl: './list.component.html',\r\n  styleUrls: ['./list.component.scss']\r\n})\r\nexport class ListComponent implements AfterViewInit, OnInit, OnDestroy {\r\n  @Input()\r\n  get navigation() {\r\n    return this._navigation;\r\n  }\r\n  set navigation(value: boolean) {\r\n    this._navigation = value;\r\n  }\r\n  private _navigation = true;\r\n\r\n  @Input()\r\n  get selection() {\r\n    return this._selection;\r\n  }\r\n  set selection(value: boolean) {\r\n    this._selection = value;\r\n  }\r\n  private _selection = true;\r\n\r\n  get selectedItem() {\r\n    return this._selectedItem;\r\n  }\r\n  set selectedItem(value: ListItemDirective) {\r\n    this.focusedItem = value;\r\n    this._selectedItem = value;\r\n  }\r\n  private _selectedItem: ListItemDirective;\r\n\r\n  get focusedItem() {\r\n    return this._focusedItem;\r\n  }\r\n  set focusedItem(value: ListItemDirective) {\r\n    this._focusedItem = value;\r\n  }\r\n  private _focusedItem: ListItemDirective;\r\n\r\n  private navigationEnabled: boolean;\r\n  private listItems$$: Subscription;\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  @ContentChildren(ListItemDirective, { descendants: true })\r\n  listItems: QueryList<ListItemDirective>;\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  @HostListener('document:enter', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    // It would be nice to be able to unsubscribe to the event\r\n    // completely but until ES7 this won't be possible because\r\n    // document events are not observables\r\n    if (this.navigationEnabled) {\r\n      if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n        event.preventDefault();\r\n        this.navigate(event.key);\r\n      } else if (event.key === 'Enter') {\r\n        this.select(this.focusedItem);\r\n      }\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n\r\n  ngOnInit() {\r\n    this.enableNavigation();\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.listItems.length) {\r\n      this.init();\r\n    }\r\n\r\n    this.listItems$$ = this.listItems.changes.subscribe(\r\n      (items: ListItemDirective[]) => this.init()\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.listItems$$.unsubscribe();\r\n  }\r\n\r\n  focus(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unfocus();\r\n\r\n    // We need to make this check because dynamic\r\n    // lists such as in the search results list may fail\r\n    if (item !== undefined) {\r\n      item.focused = true;\r\n    }\r\n  }\r\n\r\n  unfocus() {\r\n    if (this.focusedItem !== undefined) {\r\n      this.focusedItem.focused = false;\r\n    }\r\n\r\n    this.focusedItem = undefined;\r\n  }\r\n\r\n  focusNext() {\r\n    const items = this.listItems.toArray();\r\n    let item;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n    if (index === undefined) {\r\n      index = -1;\r\n    }\r\n\r\n    while (disabled && index < items.length - 1) {\r\n      index += 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index + 1]) {\r\n      igoList.scrollTop = igoList.scrollHeight - igoList.clientHeight;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      igoList.scrollTop =\r\n        item.el.nativeElement.offsetTop +\r\n        item.el.nativeElement.children[0].offsetHeight -\r\n        igoList.clientHeight;\r\n    }\r\n  }\r\n\r\n  focusPrevious() {\r\n    const items = this.listItems.toArray();\r\n    let item: ListItemDirective;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n\r\n    while (disabled && index > 0) {\r\n      index -= 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index - 1]) {\r\n      igoList.scrollTop = 0;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      const padding = 3;\r\n      igoList.scrollTop = item.el.nativeElement.offsetTop - padding;\r\n    }\r\n  }\r\n\r\n  select(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unselect();\r\n\r\n    if (item !== undefined) {\r\n      item.selected = true;\r\n    }\r\n  }\r\n\r\n  unselect() {\r\n    this.unfocus();\r\n\r\n    if (this.selectedItem !== undefined) {\r\n      this.selectedItem.selected = false;\r\n    }\r\n\r\n    this.selectedItem = undefined;\r\n  }\r\n\r\n  enableNavigation() {\r\n    if (this.navigation) {\r\n      this.navigationEnabled = true;\r\n    }\r\n  }\r\n\r\n  disableNavigation() {\r\n    this.navigationEnabled = false;\r\n  }\r\n\r\n  scrollToItem(item: ListItemDirective) {\r\n    this.el.nativeElement.scrollTop = item.getOffsetTop();\r\n  }\r\n\r\n  isScrolledIntoView(elem) {\r\n    const docViewTop =\r\n      this.el.nativeElement.scrollTop + this.el.nativeElement.offsetTop;\r\n    const docViewBottom = docViewTop + this.el.nativeElement.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.children[0].offsetHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  private init() {\r\n    this.subscribe();\r\n\r\n    this.selectedItem = this.findSelectedItem();\r\n    this.focusedItem = this.findFocusedItem();\r\n\r\n    this.enableNavigation();\r\n  }\r\n\r\n  private subscribe() {\r\n    this.unsubscribe();\r\n\r\n    this.listItems.toArray().forEach(item => {\r\n      this.subscriptions.push(\r\n        item.beforeSelect.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.select.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.beforeFocus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeFocus(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.focus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemFocus(item2)\r\n        )\r\n      );\r\n    }, this);\r\n  }\r\n\r\n  private unsubscribe() {\r\n    this.subscriptions.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n  private handleItemBeforeFocus(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unfocus();\r\n    }\r\n  }\r\n\r\n  private handleItemFocus(item: ListItemDirective) {\r\n    this.focusedItem = item;\r\n  }\r\n\r\n  private handleItemBeforeSelect(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unselect();\r\n    }\r\n  }\r\n\r\n  private handleItemSelect(item: ListItemDirective) {\r\n    this.selectedItem = item;\r\n  }\r\n\r\n  private findSelectedItem() {\r\n    return this.listItems.toArray().find(item => item.selected);\r\n  }\r\n\r\n  private findFocusedItem() {\r\n    return this.listItems.toArray().find(item => item.focused);\r\n  }\r\n\r\n  private getFocusedIndex() {\r\n    return this.listItems\r\n      .toArray()\r\n      .findIndex(item => item === this.focusedItem);\r\n  }\r\n\r\n  private navigate(key: string) {\r\n    switch (key) {\r\n      case 'ArrowUp':\r\n        this.focusPrevious();\r\n        break;\r\n      case 'ArrowDown':\r\n        this.focusNext();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n}\r\n","<mat-list\r\n  igoClickout\r\n  [ngClass]=\"{'selectable': selection}\"\r\n  (clickout)=\"disableNavigation()\"\r\n  (click)=\"enableNavigation()\">\r\n  <ng-content></ng-content>\r\n</mat-list>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { IgoClickoutModule } from '../clickout/clickout.module';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\nimport { ListComponent } from './list.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatIconModule, MatListModule, IgoClickoutModule],\r\n  declarations: [ListItemDirective, ListComponent],\r\n  exports: [ListItemDirective, ListComponent]\r\n})\r\nexport class IgoListModule {\r\n  static forRoot(): ModuleWithProviders<IgoListModule> {\r\n    return {\r\n      ngModule: IgoListModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","<div *ngIf=\"withHeader\" class=\"igo-panel-header mat-typography\" title=\"\" [ngClass]=\"{'igo-cursor-pointer': cursorPointer === true}\">\r\n  <h3>\r\n    <ng-content select=\"[panelLeftButton]\"></ng-content>\r\n    <div class=\"igo-panel-title\">\r\n      {{ title }}\r\n      <ng-content select=\"[panelHeader]\"></ng-content>\r\n    </div>\r\n    <ng-content select=\"[panelRightButton]\"></ng-content>\r\n  </h3>\r\n</div>\r\n<div class=\"igo-panel-content\" title=\"\">\r\n  <ng-content></ng-content>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  HostBinding\r\n} from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-panel',\r\n  templateUrl: './panel.component.html',\r\n  styleUrls: ['./panel.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class PanelComponent {\r\n  @Input() title: string;\r\n\r\n  @Input()\r\n  @HostBinding('class.igo-panel-with-header')\r\n  get withHeader(): boolean {\r\n    return this._withHeader;\r\n  }\r\n  set withHeader(value: boolean) {\r\n    this._withHeader = value;\r\n  }\r\n  private _withHeader = true;\r\n\r\n  @Input() cursorPointer: boolean = false;\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { PanelComponent } from './panel.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  exports: [PanelComponent],\r\n  declarations: [PanelComponent]\r\n})\r\nexport class IgoPanelModule {}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-spinner',\r\n  templateUrl: './spinner.component.html',\r\n  styleUrls: ['./spinner.component.scss']\r\n})\r\nexport class SpinnerComponent {\r\n\r\n  public shown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  set shown(value: boolean) { this.shown$.next(value); }\r\n  get shown(): boolean { return this.shown$.value; }\r\n\r\n  constructor() {}\r\n\r\n  show() {\r\n    this.shown = true;\r\n  }\r\n\r\n  hide() {\r\n    this.shown = false;\r\n  }\r\n}\r\n","<div\r\n  [ngClass]=\"{'igo-spinner-container': true, 'igo-spinner-shown': (shown$ | async)}\">\r\n  <div class=\"igo-spinner-background\"></div>\r\n  <mat-progress-spinner diameter=\"40\" mode=\"indeterminate\"></mat-progress-spinner>\r\n</div>\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n/**\r\n * A directive to bind a SpinnerComponent to the activity service.\r\n * The activity service tracks any HTTP request and this directive\r\n * will display the spinner it's attached to when the activity counter\r\n * is greater than 0.\r\n */\r\n@Directive({\r\n  selector: '[igoSpinnerActivity]'\r\n})\r\nexport class SpinnerActivityDirective implements OnInit, OnDestroy {\r\n  /**\r\n   * Subscription to the activity service counter\r\n   */\r\n  private counter$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() private spinner: SpinnerComponent,\r\n    private activityService: ActivityService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the activity service counter and display the spinner\r\n   * when it's is greater than 0.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.counter$$ = this.activityService.counter$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((count: number) => {\r\n        count > 0 ? this.spinner.show() : this.spinner.hide();\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubcribe to the activity service counter.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.counter$$.unsubscribe();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\r\n\r\nimport { SpinnerActivityDirective } from './spinner-activity.directive';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatProgressSpinnerModule],\r\n  declarations: [SpinnerActivityDirective, SpinnerComponent],\r\n  exports: [SpinnerActivityDirective, SpinnerComponent]\r\n})\r\nexport class IgoSpinnerModule {}\r\n","import { DataSource } from '@angular/cdk/table';\r\nimport { MatSort } from '@angular/material/sort';\r\n\r\nimport { Observable, BehaviorSubject, merge } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableDatabase, TableModel } from './index';\r\n\r\nexport class TableDataSource extends DataSource<any> {\r\n  get filter(): string {\r\n    return this._filterChange.value;\r\n  }\r\n  set filter(filter: string) {\r\n    this._filterChange.next(filter);\r\n  }\r\n  private _filterChange = new BehaviorSubject('');\r\n\r\n  constructor(\r\n    private _database: TableDatabase,\r\n    private _model: TableModel,\r\n    private _sort: MatSort\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  // Connect function called by the table to retrieve one stream containing\r\n  // the data to render.\r\n  connect(): Observable<any[]> {\r\n    if (!this._database) {\r\n      return merge([]);\r\n    }\r\n    const displayDataChanges = [\r\n      this._database.dataChange,\r\n      this._filterChange,\r\n      this._sort.sortChange\r\n    ];\r\n\r\n    return merge(...displayDataChanges).pipe(\r\n      map(() => {\r\n        return this.getFilteredData(this._database.data);\r\n      }),\r\n      map(data => {\r\n        return this.getSortedData(data);\r\n      })\r\n    );\r\n  }\r\n\r\n  disconnect() {}\r\n\r\n  getFilteredData(data): any[] {\r\n    if (!this.filter) {\r\n      return data;\r\n    }\r\n    return data.slice().filter((item: any) => {\r\n      const searchStr: string = this._model.columns\r\n        .filter(c => c.filterable)\r\n        .map(c => ObjectUtils.resolve(item, c.name))\r\n        .join(' ')\r\n        .toLowerCase();\r\n\r\n      return searchStr.indexOf(this.filter.toLowerCase()) !== -1;\r\n    });\r\n  }\r\n\r\n  getSortedData(data): any[] {\r\n    if (!this._sort.active || this._sort.direction === '') {\r\n      return data;\r\n    }\r\n\r\n    return data.sort((a, b) => {\r\n      const propertyA: number | string = ObjectUtils.resolve(\r\n        a,\r\n        this._sort.active\r\n      );\r\n      const propertyB: number | string = ObjectUtils.resolve(\r\n        b,\r\n        this._sort.active\r\n      );\r\n\r\n      return ObjectUtils.naturalCompare(\r\n        propertyB,\r\n        propertyA,\r\n        this._sort.direction\r\n      );\r\n    });\r\n  }\r\n}\r\n","export enum TableActionColor {\r\n  primary,\r\n  accent,\r\n  warn\r\n}\r\n","<div class='table-box'>\r\n  <div class='table-header' *ngIf=\"hasFilterInput\">\r\n    <mat-form-field floatPlaceholder='never'>\r\n      <input matInput #filter [placeholder]=\"'igo.common.table.filter' | translate\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class='table-container'>\r\n    <table mat-table #table [dataSource]='dataSource' matSort>\r\n\r\n      <!-- Checkbox Column -->\r\n      <ng-container matColumnDef=\"selectionCheckbox\">\r\n        <th mat-header-cell *matHeaderCellDef>\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"selection.hasValue() && isAllSelected()\"\r\n                        [indeterminate]=\"selection.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </th>\r\n        <td mat-cell *matCellDef=\"let row\">\r\n          <mat-checkbox (click)=\"$event.stopPropagation()\"\r\n                        (change)=\"$event ? selection.toggle(row) : null\"\r\n                        [checked]=\"selection.isSelected(row)\">\r\n          </mat-checkbox>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]='column.name' *ngFor='let column of model.columns'>\r\n        <ng-container *ngIf='column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef mat-sort-header> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf='!column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf=\"!column.html; else cellHTML\">\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\">\r\n            {{getValue(row, column.name)}}\r\n          </td>\r\n        </ng-container>\r\n\r\n        <ng-template #cellHTML>\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\"\r\n            [innerHTML]=\"getValue(row, column.name)\">\r\n          </td>\r\n        </ng-template>\r\n      </ng-container>\r\n\r\n      <!-- Action Column -->\r\n      <ng-container matColumnDef='action'>\r\n        <th mat-header-cell *matHeaderCellDef></th>\r\n        <td mat-cell *matCellDef='let row'>\r\n          <button *ngFor='let action of model.actions'\r\n          mat-mini-fab\r\n          [color]='getActionColor(action.color)'\r\n          (click)='handleClickAction($event, action, row)'>\r\n            <mat-icon svgIcon=\"{{action.icon}}\"></mat-icon>\r\n          </button>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef='displayedColumns;'></tr>\r\n      <tr mat-row\r\n        *matRowDef='let row; columns: displayedColumns;'\r\n        [ngClass]=\"model.rowClassFunc ? model.rowClassFunc(row) : {}\"\r\n        (click)=\"selection.toggle(row)\">\r\n      </tr>\r\n\r\n    </table>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ElementRef,\r\n  ViewChild,\r\n  Input,\r\n  Output,\r\n  OnChanges,\r\n  OnInit,\r\n  AfterViewInit,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { MatSort } from '@angular/material/sort';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\n\r\nimport { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { fromEvent } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableModel } from './table-model.interface';\r\nimport { TableDatabase } from './table-database';\r\nimport { TableDataSource } from './table-datasource';\r\nimport { TableActionColor } from './table-action-color.enum';\r\n\r\n@Component({\r\n  selector: 'igo-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class TableComponent implements OnChanges, OnInit, AfterViewInit {\r\n  @Input()\r\n  get database(): TableDatabase {\r\n    return this._database;\r\n  }\r\n  set database(value: TableDatabase) {\r\n    this._database = value;\r\n  }\r\n  private _database: TableDatabase;\r\n\r\n  @Input()\r\n  get model(): TableModel {\r\n    return this._model;\r\n  }\r\n  set model(value: TableModel) {\r\n    this._model = value;\r\n  }\r\n  private _model: TableModel;\r\n\r\n  @Input()\r\n  get hasFilterInput(): boolean {\r\n    return this._hasFIlterInput;\r\n  }\r\n  set hasFilterInput(value: boolean) {\r\n    this._hasFIlterInput = value;\r\n  }\r\n  private _hasFIlterInput = true;\r\n\r\n  public displayedColumns;\r\n  public dataSource: TableDataSource | null;\r\n  public selection = new SelectionModel<any>(true, []);\r\n\r\n  @Output()\r\n  select = new EventEmitter<{\r\n    added: any[];\r\n    removed: any[];\r\n    source: SelectionModel<any>;\r\n  }>();\r\n\r\n  @ViewChild('filter') filter: ElementRef;\r\n  @ViewChild(MatSort, { static: true }) sort: MatSort;\r\n\r\n  ngOnInit() {\r\n    this.dataSource = new TableDataSource(this.database, this.model, this.sort);\r\n\r\n    if (this.model) {\r\n      this.displayedColumns = this.model.columns\r\n        .filter(c => c.displayed !== false)\r\n        .map(c => c.name);\r\n\r\n      if (this.model.selectionCheckbox) {\r\n        this.displayedColumns.unshift('selectionCheckbox');\r\n      }\r\n      if (this.model.actions && this.model.actions.length) {\r\n        this.displayedColumns.push('action');\r\n      }\r\n    }\r\n\r\n    this.selection.changed.subscribe(e => this.select.emit(e));\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.filter) {\r\n      fromEvent(this.filter.nativeElement, 'keyup')\r\n        .pipe(\r\n          debounceTime(150),\r\n          distinctUntilChanged()\r\n        )\r\n        .subscribe(() => {\r\n          if (!this.dataSource) {\r\n            return;\r\n          }\r\n          this.dataSource.filter = this.filter.nativeElement.value;\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnChanges(change) {\r\n    if (change.database) {\r\n      this.dataSource = new TableDataSource(\r\n        this.database,\r\n        this.model,\r\n        this.sort\r\n      );\r\n      this.selection.clear();\r\n    }\r\n  }\r\n\r\n  getActionColor(colorId: number): string {\r\n    return TableActionColor[colorId];\r\n  }\r\n\r\n  getValue(row, key) {\r\n    return ObjectUtils.resolve(row, key);\r\n  }\r\n\r\n  /** Whether the number of selected elements matches the total number of rows. */\r\n  isAllSelected() {\r\n    const numSelected = this.selection.selected.length;\r\n    const numRows = this.database.data.length;\r\n    return numSelected === numRows;\r\n  }\r\n\r\n  /** Selects all rows if they are not all selected; otherwise clear selection. */\r\n  masterToggle() {\r\n    this.isAllSelected()\r\n      ? this.selection.clear()\r\n      : this.database.data.forEach(row => this.selection.select(row));\r\n  }\r\n\r\n  handleClickAction(event, action, row) {\r\n    event.stopPropagation();\r\n    action.click(row);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { CdkTableModule } from '@angular/cdk/table';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { TableComponent } from './table.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    CdkTableModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTableModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSortModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  declarations: [TableComponent],\r\n  exports: [TableComponent]\r\n})\r\nexport class IgoTableModule {\r\n  static forRoot(): ModuleWithProviders<IgoTableModule> {\r\n    return {\r\n      ngModule: IgoTableModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Action } from './action.interfaces';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * actions.\r\n */\r\nexport class ActionStore extends EntityStore<Action> {\r\n\r\n}\r\n","export enum ToolboxColor {\r\n  White = 'white',\r\n  Grey = 'grey',\r\n  Primary = 'primary'\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function toolSlideInOut(\r\n  speed = '300ms',\r\n  type = 'ease-in-out'\r\n): AnimationTriggerMetadata {\r\n  return trigger('toolSlideInOut', [\r\n    state(\r\n      'enter',\r\n      style({\r\n        transform: 'translate3d(0, 0, 0)'\r\n      })\r\n    ),\r\n    transition('void => enter', animate(speed + ' ' + type))\r\n  ]);\r\n}\r\n","<igo-actionbar\r\n  *ngIf=\"(toolbar$ | async).length > 0\"\r\n  [store]=\"actionStore\"\r\n  [withIcon]=\"true\"\r\n  [withTitle]=\"toolbarWithTitle$ | async\"\r\n  [withTooltip]=\"(toolbarWithTitle$ | async) === false\"\r\n  [scrollActive]=\"toolbarWithTitle$ | async\"\r\n  [horizontal]=\"false\">\r\n</igo-actionbar>\r\n\r\n<div\r\n  *ngIf=\"activeTool$ | async as tool\"\r\n  class=\"igo-tool-container\"\r\n  [ngClass]=\"{'igo-tool-container-with-toolbar': !actionStore.empty, 'igo-tool-container-with-animation': animate}\"\r\n  [@toolSlideInOut]=\"animation$ | async\"\r\n  (@toolSlideInOut.start)=\"onAnimationStart()\"\r\n  (@toolSlideInOut.done)=\"onAnimationComplete()\">\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"tool.component\"\r\n    [inputs]=\"getToolInputs(tool)\">\r\n  </igo-dynamic-outlet>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  HostBinding,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Action, ActionStore } from '../../action';\r\nimport { Tool } from '../shared/tool.interface';\r\nimport { ToolboxColor } from '../shared/toolbox.enums';\r\nimport { Toolbox } from '../shared/toolbox';\r\nimport { toolSlideInOut } from './toolbox.animation';\r\n\r\n@Component({\r\n  selector: 'igo-toolbox',\r\n  templateUrl: 'toolbox.component.html',\r\n  styleUrls: ['toolbox.component.scss'],\r\n  animations: [toolSlideInOut()],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ToolboxComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store of actions that toggle tools\r\n   */\r\n  actionStore: ActionStore = new ActionStore([]);\r\n\r\n  /**\r\n   * Observable of he anmation state\r\n   */\r\n  animation$: BehaviorSubject<string> = new BehaviorSubject('none');\r\n\r\n  /**\r\n   * Observable of the toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Whether the Toolbar should display actions' titles\r\n   */\r\n  toolbarWithTitle$: Observable<boolean> = this.activeTool$.pipe(\r\n    map((tool: Tool | undefined) => tool === undefined)\r\n  );\r\n\r\n  /**\r\n   * Subscription to the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the toolbar\r\n   */\r\n  private toolbar$$: Subscription;\r\n\r\n  /**\r\n   * Observable of the ongoing animation. This is useful when\r\n   * multiple animations are triggered at once i.e. when the user clicks\r\n   * too fast on different actions\r\n   */\r\n  private animating$ = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Subscription to the ongoing animation\r\n   */\r\n  private animating$$: Subscription;\r\n\r\n  /**\r\n   * Toolbox\r\n   */\r\n  @Input() toolbox: Toolbox;\r\n\r\n  /**\r\n   * Whether the toolbox should animate the first tool entering\r\n   */\r\n  @Input() animate: boolean = false;\r\n\r\n  /**\r\n   * Color of Toolbox\r\n   */\r\n  @Input() color: ToolboxColor = ToolboxColor.White;\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-grey')\r\n  get classColorGrey() {\r\n    return this.color === ToolboxColor.Grey;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-primary')\r\n  get classColorPrimary() {\r\n    return this.color === ToolboxColor.Primary;\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar and subscribe to the active tool\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.toolbar$$ = this.toolbox.toolbar$.subscribe((toolbar: string[]) =>\r\n      this.onToolbarChange(toolbar)\r\n    );\r\n    this.activeTool$$ = this.toolbox.activeTool$.subscribe((tool: Tool) =>\r\n      this.onActiveToolChange(tool)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the active tool and destroy the action store\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toolbar$$.unsubscribe();\r\n    this.activeTool$$.unsubscribe();\r\n    this.actionStore.destroy();\r\n  }\r\n\r\n  /**\r\n   * Track the starting animation\r\n   * @internal\r\n   */\r\n  onAnimationStart() {\r\n    this.animating$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Untrack the completed animation\r\n   * @internal\r\n   */\r\n  onAnimationComplete() {\r\n    this.animating$.next(false);\r\n  }\r\n\r\n  /**\r\n   * Return a tool's inputs\r\n   * @param tool Tool\r\n   * @returns Tool inputs\r\n   * @internal\r\n   */\r\n  getToolInputs(tool: Tool): { [key: string]: any } {\r\n    return tool.options || {};\r\n  }\r\n\r\n  /**\r\n   * Initialize an action store\r\n   * @param toolbar Toolbar\r\n   */\r\n  private onToolbarChange(toolbar: string[]) {\r\n    this.setToolbar(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool and trigger an animation or not\r\n   * @param tool Tool to activate\r\n   */\r\n  private onActiveToolChange(tool: Tool) {\r\n    if (!this.animate) {\r\n      this.setActiveTool(tool);\r\n      return;\r\n    }\r\n    this.onAnimate(() => this.setActiveTool(tool));\r\n  }\r\n\r\n  /**\r\n   * Set the active tool\r\n   * @param tool Tool to activate\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    if (tool === undefined) {\r\n      this.actionStore.state.updateAll({ active: false });\r\n    } else {\r\n      const action = this.actionStore.get(tool.name);\r\n      if (action !== undefined) {\r\n        this.actionStore.state.update(action, { active: true }, true);\r\n      }\r\n    }\r\n\r\n    this.activeTool$.next(tool);\r\n    if (this.animate) {\r\n      this.animation$.next('enter');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar\r\n   */\r\n  private setToolbar(toolbar: string[]) {\r\n    const actions = toolbar.reduce((acc: Action[], toolName: string) => {\r\n      const tool = this.toolbox.getTool(toolName);\r\n      if (tool === undefined) {\r\n        return acc;\r\n      }\r\n\r\n      acc.push({\r\n        id: tool.name,\r\n        title: tool.title,\r\n        icon: tool.icon,\r\n        // iconImage: tool.iconImage,\r\n        tooltip: tool.tooltip,\r\n        args: [tool, this.toolbox],\r\n        handler: (_tool: Tool, _toolbox: Toolbox) => {\r\n          _toolbox.activateTool(_tool.name);\r\n        },\r\n        ngClass: (_tool: Tool, _toolbox: Toolbox) => {\r\n          return this.toolbox.activeTool$.pipe(\r\n            map((activeTool: Tool) => {\r\n              let toolActivated = false;\r\n              if (activeTool !== undefined && _tool.name === activeTool.name) {\r\n                toolActivated = true;\r\n              }\r\n\r\n              let childrenToolActivated = false;\r\n              if (\r\n                activeTool !== undefined &&\r\n                _tool.name === activeTool.parent\r\n              ) {\r\n                childrenToolActivated = true;\r\n              }\r\n\r\n              return {\r\n                'tool-activated': toolActivated,\r\n                'children-tool-activated': childrenToolActivated\r\n              };\r\n            })\r\n          );\r\n        }\r\n      });\r\n      return acc;\r\n    }, []);\r\n    this.actionStore.load(actions);\r\n    this.toolbar$.next(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Observe the ongoing animation and ignore any incoming animation\r\n   * while one is still ongoing.\r\n   * @param callback Callback to execute when the animation completes\r\n   */\r\n  private onAnimate(callback: () => void) {\r\n    this.unAnimate();\r\n    this.animating$$ = this.animating$.subscribe((animation: boolean) => {\r\n      if (!animation) {\r\n        callback.call(this);\r\n        this.unAnimate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop observing an animation when it's complete\r\n   */\r\n  private unAnimate() {\r\n    if (this.animating$$) {\r\n      this.animating$$.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionModule } from '../../action/action.module';\r\nimport {\r\n    IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { ToolboxComponent } from './toolbox.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    ToolboxComponent\r\n  ],\r\n  declarations: [\r\n    ToolboxComponent\r\n  ]\r\n})\r\nexport class IgoToolboxModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { ToolService } from './shared/tool.service';\r\nimport { IgoToolboxModule } from './toolbox/toolbox.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoToolboxModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoToolModule {\r\n  static forRoot(): ModuleWithProviders<IgoToolModule> {\r\n    return {\r\n      ngModule: IgoToolModule,\r\n      providers: [\r\n        ToolService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","<igo-dynamic-outlet\r\n  *ngIf=\"widget\"\r\n  [component]=\"widget\"\r\n  [inputs]=\"inputs\"\r\n  [subscribers]=\"getEffectiveSubscribers()\">\r\n</igo-dynamic-outlet>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from '../../dynamic-component';\r\n\r\nimport { WidgetComponent } from '../shared/widget.interfaces';\r\n\r\n/**\r\n * This component dynamically renders a widget. It also subscribes\r\n * to the widget's 'cancel' and 'complete' events and destroys it\r\n * when any of those event is emitted.\r\n */\r\n@Component({\r\n  selector: 'igo-widget-outlet',\r\n  templateUrl: './widget-outlet.component.html',\r\n  styleUrls: ['./widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WidgetOutletComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Widget subscribers to 'cancel' and 'complete'\r\n   * @internal\r\n   */\r\n  private baseSubscribers = {\r\n    cancel: (event: any) => this.onCancel(event),\r\n    complete: (event: any) => this.onComplete(event)\r\n  };\r\n\r\n  /**\r\n   * Widget\r\n   */\r\n  @Input() widget: DynamicComponent<WidgetComponent>;\r\n\r\n  /**\r\n   * Widget inputs\r\n   */\r\n  @Input() inputs: {[key: string]: any};\r\n\r\n  /**\r\n   * Widget subscribers\r\n   */\r\n  @Input() subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'complete'\r\n   */\r\n  @Output() complete = new EventEmitter<any>();\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'cancel'\r\n   */\r\n  @Output() cancel = new EventEmitter<any>();\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Destroy the current widget and all it's inner subscriptions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Get the effective subscribers. That means a combination of the base\r\n   * subscribers and any subscriber given as input.\r\n   * @returns Combined subscribers\r\n   * @internal\r\n   */\r\n  getEffectiveSubscribers(): {[key: string]: (event: any) => void} {\r\n    const subscribers = Object.assign({}, this.subscribers);\r\n\r\n    // Base subscribers\r\n    Object.keys(this.baseSubscribers).forEach((key: string) => {\r\n      const subscriber = subscribers[key];\r\n      const baseSubscriber = this.baseSubscribers[key];\r\n      if (subscriber !== undefined) {\r\n        subscribers[key] = (event: any) => {\r\n          subscriber(event);\r\n          baseSubscriber(event);\r\n        };\r\n      } else {\r\n        subscribers[key] = baseSubscriber;\r\n      }\r\n    });\r\n\r\n    return subscribers;\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'cancel', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onCancel(event: any) {\r\n    this.cancel.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'complete', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onComplete(event: any) {\r\n    this.complete.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Destroy the current widget\r\n   */\r\n  private destroyWidget() {\r\n    if (this.widget !== undefined) {\r\n      this.widget.destroy();\r\n    }\r\n    this.widget = undefined;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { WidgetOutletComponent } from './widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    WidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWidgetOutletModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { DynamicComponentService } from '../../dynamic-component/shared/dynamic-component.service';\r\n\r\nimport { Widget } from './widget';\r\nimport { WidgetComponent } from './widget.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WidgetService {\r\n\r\n  constructor(private dynamicComponentService: DynamicComponentService) {}\r\n\r\n  create(widgetCls: any): Widget {\r\n    return this.dynamicComponentService.create(widgetCls as WidgetComponent);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from './widget-outlet/widget-outlet.module';\r\nimport { WidgetService } from './shared/widget.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    IgoWidgetOutletModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    WidgetService\r\n  ]\r\n})\r\nexport class IgoWidgetModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle } from '../../entity';\r\nimport { Workspace } from '../shared/workspace';\r\nimport { WorkspaceStore } from '../shared/store';\r\n\r\n/**\r\n * Drop list that activates the selected workspace emit an event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-selector',\r\n  templateUrl: './workspace-selector.component.html',\r\n  styleUrls: ['./workspace-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceSelectorComponent {\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  /**\r\n   * Wheither the selector must be disabled or not.\r\n   */\r\n  @Input() disabled: boolean;\r\n\r\n  /**\r\n   * Event emitted when an workspace is selected or unselected\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: Workspace;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  getWorkspaceTitle(workspace: Workspace): string {\r\n    return getEntityTitle(workspace);\r\n  }\r\n\r\n  /**\r\n   * When an workspace is manually selected, select it into the\r\n   * store and emit an event.\r\n   * @internal\r\n   * @param event The selection change event\r\n   */\r\n  onSelectedChange(event: {value: Workspace}) {\r\n    const workspace = event.value;\r\n    this.store.activateWorkspace(workspace);\r\n    this.selectedChange.emit({selected: true, value: workspace});\r\n  }\r\n\r\n}\r\n","<igo-entity-selector\r\n  [store]=\"store\"\r\n  [multi]=\"false\"\r\n  [titleAccessor]=\"getWorkspaceTitle\"\r\n  [disabled]=\"disabled\"\r\n  (selectedChange)=\"onSelectedChange($event)\">\r\n</igo-entity-selector>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from '../../entity/entity-selector/entity-selector.module';\r\nimport { WorkspaceSelectorComponent } from './workspace-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [\r\n    WorkspaceSelectorComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","<ng-container *ngIf=\"widget$ | async as widget\">\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"widgetInputs$ | async\"\r\n    [subscribers]=\"widgetSubscribers$ | async\"\r\n    (cancel)=\"onWidgetCancel(widget)\"\r\n    (complete)=\"onWidgetComplete(widget)\">\r\n  </igo-widget-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Widget } from '../../widget';\r\nimport { Workspace } from '../shared/workspace';\r\n\r\n/**\r\n * This component dynamically render an Workspace's active widget.\r\n * It also deactivate that widget whenever the widget's component\r\n * emit the 'cancel' or 'complete' event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-widget-outlet',\r\n  templateUrl: './workspace-widget-outlet.component.html',\r\n  styleUrls: ['./workspace-widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceWidgetOutletComponent {\r\n\r\n  /**\r\n   * Workspace\r\n   */\r\n  @Input() workspace: Workspace;\r\n\r\n  /**\r\n   * Event emitted when a widget is deactivate which happens\r\n   * when the widget's component emits the 'cancel' or 'complete' event.\r\n   */\r\n  @Output() deactivateWidget = new EventEmitter<Widget>();\r\n\r\n  /**\r\n   * Observable of the workspace's active widget\r\n   * @internal\r\n   */\r\n  get widget$(): BehaviorSubject<Widget> { return this.workspace.widget$; }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetInputs$(): BehaviorSubject<{[key: string]: any}> {\r\n    return this.workspace.widgetInputs$;\r\n  }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetSubscribers$(): BehaviorSubject<{[key: string]: (event: any) => void}> {\r\n    return this.workspace.widgetSubscribers$;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetCancel(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetComplete(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from '../../widget/widget-outlet/widget-outlet.module';\r\n\r\nimport { WorkspaceWidgetOutletComponent } from './workspace-widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    WorkspaceWidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceWidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceWidgetOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceWidgetOutletModule } from './workspace-widget-outlet/workspace-widget-outlet.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceWidgetOutletModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoWorkspaceModule {}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nexport class TableDatabase {\r\n  /** Stream that emits whenever the data has been modified. */\r\n  dataChange: BehaviorSubject<any[]> = new BehaviorSubject<any[]>([]);\r\n  get data(): any[] {\r\n    return this.dataChange.value;\r\n  }\r\n\r\n  constructor(data?) {\r\n    if (data) {\r\n      this.dataChange.next(data);\r\n    }\r\n  }\r\n\r\n  set(data) {\r\n    this.dataChange.next(data);\r\n  }\r\n\r\n  add(item) {\r\n    const copiedData = this.data.slice();\r\n    copiedData.push(item);\r\n    this.set(copiedData);\r\n  }\r\n\r\n  remove(item) {\r\n    const copiedData = this.data.slice();\r\n    const index = copiedData.indexOf(item);\r\n    copiedData.splice(index, 1);\r\n    this.set(copiedData);\r\n  }\r\n}\r\n","import { Tool } from './tool.interface';\r\nimport { ToolService } from './tool.service';\r\n\r\nexport function ToolComponent(tool: Partial<Tool>): (cls: any) => any {\r\n  return (compType: any) => {\r\n    ToolService.register(Object.assign({}, tool, {\r\n      component: compType\r\n    } as Tool));\r\n  };\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Workspace } from './workspace';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * workspaces.\r\n */\r\nexport class WorkspaceStore extends EntityStore<Workspace> {\r\n\r\n  activeWorkspace$: BehaviorSubject<Workspace> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Activate the an workspace workspace and deactivate the one currently active\r\n   * @param workspace Workspace\r\n   */\r\n  activateWorkspace(workspace: Workspace) {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n    }\r\n\r\n    this.deactivateWorkspace();\r\n    if (workspace !== undefined) {\r\n      this.state.update(workspace, {active: true, selected: true}, true);\r\n      this.activeWorkspace$.next(workspace);\r\n      workspace.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate the current workspace\r\n   * @param workspace Workspace\r\n   */\r\n  deactivateWorkspace() {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n      this.activeWorkspace$.next(undefined);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Subscription, BehaviorSubject, Subject } from 'rxjs';\r\n\r\nimport { ActionStore } from '../../action';\r\nimport { Widget } from '../../widget';\r\nimport { EntityStore } from '../../entity';\r\n\r\nimport { WorkspaceOptions } from './workspace.interfaces';\r\n\r\n/**\r\n * This class is responsible of managing the relations between\r\n * entities and the actions that consume them. It also defines an\r\n * entity table template that may be used by an entity table component.\r\n */\r\nexport class Workspace<E extends object = object> {\r\n\r\n  /**\r\n   * Observable of the selected widget\r\n   */\r\n  readonly widget$ = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the selected widget's inputs\r\n   */\r\n  readonly widgetInputs$ = new BehaviorSubject<{[key: string]: any}>({});\r\n\r\n  /**\r\n   * Observable of the selected widget's subscribers\r\n   */\r\n  readonly widgetSubscribers$ = new BehaviorSubject<{[key: string]: (event: any) => void}>({});\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * State change that trigger an update of the actions availability\r\n   */\r\n  private change: Subject<void> = new Subject();\r\n\r\n  /**\r\n   * Subscription to state changes\r\n   */\r\n  private change$: Subscription;\r\n\r\n  /**\r\n   * Workspace id\r\n   */\r\n  get id(): string { return this.options.id; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get title(): string { return this.options.title; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get meta(): {[key: string]: any} { return this.options.meta || {}; }\r\n\r\n  /**\r\n   * Entities store\r\n   */\r\n  get entityStore(): EntityStore<E> { return this.options.entityStore as EntityStore<E>; }\r\n\r\n  /**\r\n   * Actions store (some actions activate a widget)\r\n   */\r\n  get actionStore(): ActionStore { return this.options.actionStore; }\r\n\r\n  /**\r\n   * Selected widget\r\n   */\r\n  get widget(): Widget { return this.widget$.value; }\r\n\r\n  /**\r\n   * Whether a widget is selected\r\n   */\r\n  get hasWidget(): boolean { return this.widget !== undefined; }\r\n\r\n  constructor(protected options: WorkspaceOptions) {}\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Activate the workspace. By doing that, the workspace will observe\r\n   * the selected entity (from the store) and update the actions availability.\r\n   * For example, some actions require an entity to be selected.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.deactivate();\r\n    }\r\n    this.active$.next(true);\r\n\r\n    if (this.entityStore !== undefined) {\r\n      this.entities$$ = this.entityStore.stateView.all$()\r\n        .subscribe(() => this.onStateChange());\r\n    }\r\n\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the workspace. Unsubcribe to the selected entity.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.deactivateWidget();\r\n\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.change$ !== undefined) {\r\n      this.change$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a widget. In itself, activating a widget doesn't render it but,\r\n   * if an WorkspaceWidgetOutlet component is bound to this workspace, the widget will\r\n   * show up.\r\n   * @param widget Widget\r\n   * @param inputs Inputs the widget will receive\r\n   */\r\n  activateWidget(\r\n    widget: Widget,\r\n    inputs: {[key: string]: any} = {},\r\n    subscribers: {[key: string]: (event: any) => void} = {}\r\n  ) {\r\n    this.widget$.next(widget);\r\n    this.widgetInputs$.next(inputs);\r\n    this.widgetSubscribers$.next(subscribers);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate a widget.\r\n   */\r\n  deactivateWidget() {\r\n    this.widget$.next(undefined);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * When the state changes, update the actions availability.\r\n   */\r\n  private onStateChange() {\r\n    this.change.next();\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppHomeComponent } from './home.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'home',\r\n    component: AppHomeComponent\r\n  }\r\n];\r\n\r\nexport const AppHomeRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { InteractiveTourService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-home',\r\n  templateUrl: './home.component.html',\r\n  styleUrls: ['./home.component.scss']\r\n})\r\nexport class AppHomeComponent {\r\n  constructor(private interactiveTourService: InteractiveTourService) {}\r\n\r\n  startTour() {\r\n    this.interactiveTourService.startTour('global');\r\n  }\r\n}\r\n","<div style=\"text-align:center\">\r\n  <h1 id=\"igo-title\">\r\n    Welcome to IGO\r\n  </h1>\r\n  <img  class=\"igo-logo\" width=\"180\" src=\"assets/igo2/core/logo.png\">\r\n</div>\r\n\r\n<p>\r\n  <igo-interactive-tour\r\n    tourToStart = \"global\"\r\n    menuIsOpen = true\r\n    styleButton = \"raised\">\r\n  </igo-interactive-tour>\r\n</p>\r\n\r\n<p>\r\n  IGO2 library contains many components and services that may benefit any web application. <br>\r\n  IGO2 library is open source project using Angular, Angular Material and OpenLayers.\r\n</p>\r\n\r\n<h3>IGO2 library is divided into several elements: </h3>\r\n<ul>\r\n  <li><b>@igo2/utils</b> : Basic utilies without dependency (ex: base64, clipboard, uuid)</li>\r\n  <li><b>@igo2/core</b> : Element affecting the core of the application (ex: config, language, message, media, request)</li>\r\n  <li><b>@igo2/common</b> : Library containing reusable components (ex: clickout, drag-drop, list, panel, spinner, table)</li>\r\n  <li><b>@igo2/auth</b> : Library grouping the authentication and security module</li>\r\n  <li><b>@igo2/geo</b> : Library containing the geomatic components. Depends on Openlayers.</li>\r\n  <li><b>@igo2/context</b> : Library of components uniting @igo2/geo and @igo2/auth</li>\r\n  <li><b>@igo2/integration</b> : Library integrate basic components</li>\r\n</ul>\r\n\r\n<h2>Here are some links to help you start: </h2>\r\n<ul>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://github.com/infra-geo-ouverte/igo2-lib/blob/master/README.md#user-installation\">Installation</a></h2>\r\n  </li>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://angular.io/docs\">Angular Documentation</a></h2>\r\n  </li>\r\n</ul>\r\n\r\n*** Modules in <code>@igo2/core</code> must be imported only once\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { AppHomeComponent } from './home.component';\r\nimport { AppHomeRoutingModule } from './home-routing.module';\r\nimport { IgoInteractiveTourModule } from '@igo2/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHomeComponent],\r\n  imports: [\r\n    AppHomeRoutingModule,\r\n    IgoInteractiveTourModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule\r\n  ],\r\n  exports: [AppHomeComponent]\r\n})\r\nexport class AppHomeModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'activity',\r\n    component: AppActivityComponent\r\n  }\r\n];\r\n\r\nexport const AppActivityRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-activity',\r\n  templateUrl: './activity.component.html',\r\n  styleUrls: ['./activity.component.scss']\r\n})\r\nexport class AppActivityComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  register() {\r\n    this.idsActivity.push(this.activityService.register());\r\n  }\r\n\r\n  unregister() {\r\n    this.activityService.unregister(this.idsActivity.pop());\r\n  }\r\n\r\n  get counter() {\r\n    return this.activityService.counter$.value;\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Activity</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register activities in service. Use to display a loading icon</p>\r\n\r\n    <li>Import <code>IgoActivityModule</code> only if you want register http calls</li>\r\n    <li>Import <code>IgoActivityModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/activity\"> code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"register()\">Register</button>\r\n    <button mat-raised-button (click)=\"unregister()\">Unregister</button>\r\n  </mat-card-actions>\r\n  <p>Counter: {{counter}}</p>\r\n\r\n  <igo-spinner igoSpinnerActivity></igo-spinner>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActivityModule } from '@igo2/core';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\nimport { AppActivityRoutingModule } from './activity-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActivityComponent],\r\n  imports: [\r\n    AppActivityRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoActivityModule.forRoot(), // Only if you want register http calls\r\n    IgoSpinnerModule\r\n  ],\r\n  exports: [AppActivityComponent]\r\n})\r\nexport class AppActivityModule {}\r\n","interface Environment {\r\n  production: boolean;\r\n  igo: any;\r\n}\r\n\r\nexport const environment: Environment = {\r\n  production: true,\r\n  igo: {\r\n    projections: [\r\n      {\r\n        code: 'EPSG:32198',\r\n        alias: 'Quebec Lambert',\r\n        def:\r\n          '+proj=lcc +lat_1=60 +lat_2=46 +lat_0=44 +lon_0=-68.5 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs',\r\n        extent: [-886251.0296, 180252.9126, 897177.3418, 2106143.8139]\r\n      }\r\n    ],\r\n    auth: {\r\n      intern: {\r\n        enabled: true\r\n      },\r\n      allowAnonymous: true\r\n    },\r\n    interactiveTour: {\r\n      tourInMobile: true\r\n    },\r\n    importExport: {\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ogre'\r\n    },\r\n    language: {\r\n      prefix: './locale/'\r\n    },\r\n    catalog: {\r\n      sources: [\r\n        {\r\n          id: 'Gououvert',\r\n          title: 'Gouvouvert',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi'\r\n        },\r\n        {\r\n          id: 'DefiningInfoFormat',\r\n          title: 'Defining info_format',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          queryFormat: {\r\n            html: '*',\r\n            'application/json': [\r\n              'stations_meteoroutieres',\r\n              'histo_stations_meteoroutieres'\r\n            ]\r\n          },\r\n          queryHtmlTarget: 'iframe',\r\n          count: 30\r\n        },\r\n        {\r\n          id: 'catalogwithregex',\r\n          title: 'Filtered catalog by regex',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          regFilters: ['zpegt']\r\n        },\r\n        {\r\n          id: 'catalogwithtooltipcontrol',\r\n          title: 'Controling tooltip format',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          tooltipType: 'abstract' // or title\r\n        }\r\n      ]\r\n    },\r\n    searchSources: {\r\n      storedqueriesreverse: { enabled: false},\r\n      nominatim: {\r\n        enabled: false\r\n      },\r\n      icherche: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n        order: 2,\r\n        enabled: true,\r\n        params: {\r\n          limit: '8'\r\n        }\r\n      },\r\n      coordinatesreverse: {\r\n        showInPointerSummary: true\r\n      },\r\n      icherchereverse: {\r\n        showInPointerSummary: true,\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n        order: 3,\r\n        enabled: true\r\n      },\r\n      ilayer: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n        order: 4,\r\n        enabled: true,\r\n        params: {\r\n          limit: '5'\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppConfigComponent } from './config.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'config',\r\n    component: AppConfigComponent\r\n  }\r\n];\r\n\r\nexport const AppConfigRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { ConfigService, LanguageOptions } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-config',\r\n  templateUrl: './config.component.html',\r\n  styleUrls: ['./config.component.scss']\r\n})\r\nexport class AppConfigComponent {\r\n  public configLanguage: LanguageOptions;\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.configLanguage = this.configService.getConfig('language');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>config</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Load config in your angular application</p>\r\n\r\n    <li>Import <code>IgoConfigModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/config\"> code of this example</a> <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Config language: {{configLanguage | json }}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppConfigComponent } from './config.component';\r\nimport { AppConfigRoutingModule } from './config-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppConfigComponent],\r\n  imports: [\r\n    AppConfigRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoConfigModule.forRoot()\r\n  ],\r\n  exports: [AppConfigComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppConfigModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'language',\r\n    component: AppLanguageComponent\r\n  }\r\n];\r\n\r\nexport const AppLanguageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-language',\r\n  templateUrl: './language.component.html',\r\n  styleUrls: ['./language.component.scss']\r\n})\r\nexport class AppLanguageComponent {\r\n  public app = {\r\n    title: 'IGO'\r\n  };\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  changeLanguage(language: string) {\r\n    this.languageService.setLanguage(language);\r\n    console.log(this.languageService);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>language</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Translate your angular application</p>\r\n\r\n    <li>Import <code>IgoLanguageModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/language\">code of this example</a><br>\r\n    See language section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/locale\">locale files</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"changeLanguage('en')\">English</button>\r\n    <button mat-raised-button (click)=\"changeLanguage('fr')\">Français</button>\r\n  </mat-card-actions>\r\n\r\n  <p>{{'welcome' | translate: app}}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\nimport { AppLanguageRoutingModule } from './language-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLanguageComponent],\r\n  imports: [\r\n    AppLanguageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule.forRoot()\r\n  ],\r\n  exports: [AppLanguageComponent]\r\n})\r\nexport class AppLanguageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMediaComponent } from './media.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'media',\r\n    component: AppMediaComponent\r\n  }\r\n];\r\n\r\nexport const AppMediaRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-media',\r\n  templateUrl: './media.component.html',\r\n  styleUrls: ['./media.component.scss']\r\n})\r\nexport class AppMediaComponent {\r\n  constructor(private mediaService: MediaService) {}\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get orientation() {\r\n    return this.mediaService.getOrientation();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Media</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Detect type of media (mobile, tablet, desktop)</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/media\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Current media: {{media}}</p>\r\n  <p>Current orientation: {{orientation}}</p>\r\n  <p>Device mode:  {{isTouchScreen ? 'Touch device' : 'Not a touch device '}}</p>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { AppMediaComponent } from './media.component';\r\nimport { AppMediaRoutingModule } from './media-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMediaComponent],\r\n  imports: [AppMediaRoutingModule, MatCardModule],\r\n  exports: [AppMediaComponent]\r\n})\r\nexport class AppMediaModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMessageComponent } from './message.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'message',\r\n    component: AppMessageComponent\r\n  }\r\n];\r\n\r\nexport const AppMessageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MessageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-message',\r\n  templateUrl: './message.component.html',\r\n  styleUrls: ['./message.component.scss']\r\n})\r\nexport class AppMessageComponent {\r\n  constructor(private messageService: MessageService) {}\r\n\r\n  success() {\r\n    this.messageService.success('Congratulations', 'Success');\r\n  }\r\n\r\n  info() {\r\n    this.messageService.info('Welcome to IGO', 'Info');\r\n  }\r\n\r\n  alert() {\r\n    this.messageService.alert('Warning', 'Alert');\r\n  }\r\n  error() {\r\n    this.messageService.error('There is a bug', 'Error');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Message</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Show message to user.</p>\r\n\r\n    <li>Import <code>IgoMessageModule</code> only once</li>\r\n    <li>Dependencies: BrowserAnimationsModule </li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/message\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"success()\">Success message</button>\r\n    <button mat-raised-button color='primary' (click)=\"info()\">Info message</button>\r\n    <button mat-raised-button color='accent' (click)=\"alert()\">Alert message</button>\r\n    <button mat-raised-button color='warn' (click)=\"error()\">Error message</button>\r\n  </mat-card-actions>\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppMessageComponent } from './message.component';\r\nimport { AppMessageRoutingModule } from './message-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMessageComponent],\r\n  imports: [\r\n    AppMessageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule.forRoot()\r\n  ],\r\n  exports: [AppMessageComponent]\r\n})\r\nexport class AppMessageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppRequestComponent } from './request.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'request',\r\n    component: AppRequestComponent\r\n  }\r\n];\r\n\r\nexport const AppRequestRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-request',\r\n  templateUrl: './request.component.html',\r\n  styleUrls: ['./request.component.scss']\r\n})\r\nexport class AppRequestComponent {\r\n  constructor(\r\n    private http: HttpClient,\r\n    public languageService: LanguageService\r\n  ) {}\r\n\r\n  callHttp() {\r\n    const url = 'https://geoegl.msp.gouv.qc.ca/apis/icherche/info';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n\r\n  callHttpError() {\r\n    const url = '404';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Request</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register http calls in console</p>\r\n\r\n    <li>Import <code>IgoLoggingModule</code> only if you want register http calls in console</li>\r\n    <li>Import <code>IgoErrorModule</code> only if you want register errors from http call in console</li>\r\n    <li>Import modules only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/request\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"callHttp()\">Log</button>\r\n    <button mat-raised-button (click)=\"callHttpError()\">Error</button>\r\n  </mat-card-actions>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoErrorModule, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppRequestComponent } from './request.component';\r\nimport { AppRequestRoutingModule } from './request-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppRequestComponent],\r\n  imports: [\r\n    AppRequestRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    HttpClientModule,\r\n    IgoLanguageModule.forRoot(),\r\n    IgoErrorModule.forRoot() // Only if you want register errors from http call in console\r\n    // IgoLoggingModule.forRoot() // Only if you want register http calls in console\r\n  ],\r\n  exports: [AppRequestComponent]\r\n})\r\nexport class AppRequestModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/action\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n</mat-card>\r\n<p></p>\r\n\r\n<mat-card [igoContextMenu]= actionbarMenu>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action context-menu</mat-card-title>\r\n  <div></div>\r\n</mat-card>\r\n\r\n\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppActionComponent } from './action.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'action',\r\n    component: AppActionComponent\r\n  }\r\n];\r\n\r\nexport const AppActionRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  Media,\r\n  MediaOrientation,\r\n  MediaService,\r\n  LanguageService\r\n} from '@igo2/core';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\n\r\n@Component({\r\n  selector: 'app-action',\r\n  templateUrl: './action.component.html',\r\n  styleUrls: ['./action.component.scss']\r\n})\r\nexport class AppActionComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  private added$ = new BehaviorSubject(false);\r\n\r\n  get actionbarMode(): ActionbarMode {\r\n    const media = this.mediaService.media$.value;\r\n    const orientation = this.mediaService.orientation$.value;\r\n    if (media === Media.Desktop && orientation === MediaOrientation.Landscape) {\r\n      return ActionbarMode.Dock;\r\n    }\r\n    return ActionbarMode.Overlay;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'add',\r\n        title: 'Add',\r\n        icon: 'plus',\r\n        tooltip: 'Add Tooltip',\r\n        handler: () => {\r\n          alert('Add!');\r\n          this.added$.next(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'edit',\r\n        title: 'Edit',\r\n        icon: 'pencil',\r\n        tooltip: 'Edit Tooltip',\r\n        args: ['1'],\r\n        handler: (item: string) => {\r\n          alert(`Edit item ${item}!`);\r\n        },\r\n        availability: () => this.added$\r\n      },\r\n      {\r\n        id: 'delete',\r\n        title: 'Delete',\r\n        tooltip: 'Delete Tooltip',\r\n        icon: 'delete',\r\n        handler: () => {\r\n          alert('Delete!');\r\n          this.added$.next(false);\r\n        },\r\n        availability: () => this.added$\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActionModule, IgoContextMenuModule } from '@igo2/common';\r\n\r\nimport { AppActionComponent } from './action.component';\r\nimport { AppActionRoutingModule } from './action-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActionComponent],\r\n  imports: [\r\n    AppActionRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoActionModule,\r\n    IgoContextMenuModule\r\n  ],\r\n  exports: [AppActionComponent]\r\n})\r\nexport class AppActionModule {}\r\n","import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { OnUpdateInputs } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-component',\r\n  template: '<p>Hello, my name is {{name}}.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-explanation-component',\r\n  template: '<p>I am a dynamic component, rendered into an IgoDynamicOutlet.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppExplanationComponent implements OnUpdateInputs {\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-dynamic-component',\r\n  templateUrl: './dynamic-component.component.html',\r\n  styleUrls: ['./dynamic-component.component.scss']\r\n})\r\nexport class AppDynamicComponentComponent {\r\n\r\n  component: any = AppSalutationComponent;\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  toggleComponent() {\r\n    this.component = this.component === AppSalutationComponent ?\r\n      AppExplanationComponent :\r\n      AppSalutationComponent;\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDynamicComponentComponent } from './dynamic-component.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'dynamic-component',\r\n    component: AppDynamicComponentComponent\r\n  }\r\n];\r\n\r\nexport const AppDynamicComponentRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Dynamic Component</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/dynamic-component\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"component\"\r\n    [inputs]=\"inputs\">\r\n  </igo-dynamic-outlet>\r\n\r\n  <button mat-flat-button color=\"primary\" (click)=\"toggleComponent()\">Toggle Component</button>\r\n</mat-card>\r\n\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoDynamicComponentModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationComponent,\r\n  AppExplanationComponent,\r\n  AppDynamicComponentComponent\r\n} from './dynamic-component.component';\r\nimport { AppDynamicComponentRoutingModule } from './dynamic-component-routing.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        AppSalutationComponent,\r\n        AppDynamicComponentComponent,\r\n        AppExplanationComponent\r\n    ],\r\n    imports: [\r\n        AppDynamicComponentRoutingModule,\r\n        MatButtonModule,\r\n        MatCardModule,\r\n        IgoDynamicComponentModule\r\n    ],\r\n    exports: [AppDynamicComponentComponent]\r\n})\r\nexport class AppDynamicComponentModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-table',\r\n    component: AppEntityTableComponent\r\n  }\r\n];\r\n\r\nexport const AppEntityTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  EntityStore,\r\n  EntityTableButton,\r\n  getEntityProperty,\r\n  EntityTableColumnRenderer,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss']\r\n})\r\nexport class AppEntityTableComponent implements OnInit, OnDestroy {\r\n  public store = new EntityStore([]);\r\n  public paginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public paginatorOptions: EntityTablePaginatorOptions = {pageSize: 10};\r\n\r\n  public template = {\r\n    selection: true,\r\n    selectionCheckbox: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    valueAccessor: (entity: object, name: string) => {\r\n      return getEntityProperty(entity, name);\r\n    },\r\n    columns: [\r\n      {\r\n        name: 'selected',\r\n        title: 'Selected',\r\n        valueAccessor: (entity: object) => {\r\n          return this.store.state.get(entity).selected\r\n            ? 'radiobox-marked'\r\n            : 'radiobox-blank';\r\n        },\r\n        renderer: EntityTableColumnRenderer.Icon\r\n      },\r\n      {\r\n        name: 'id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        renderer: EntityTableColumnRenderer.HTML\r\n      },\r\n      {\r\n        name: 'url',\r\n        title: 'Hyperlink'\r\n      },\r\n      {\r\n        name: 'image',\r\n        title: 'Image'\r\n      },\r\n      {\r\n        name: 'action',\r\n        title: '',\r\n        valueAccessor: (entity: object) => {\r\n          return [{\r\n            icon: 'home',\r\n            color: 'warn',\r\n            click: (row) => { console.log(row); }\r\n          }] as EntityTableButton[];\r\n        },\r\n        renderer: EntityTableColumnRenderer.ButtonGroup\r\n      }\r\n    ]\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    const ids = [2, 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];\r\n\r\n    const entities = ids.map(id => {\r\n      if (id === 3) {\r\n        return { id , name: `Name ${id}`, description: `<b>Description ${id}</b>`, url: 'https://igouverte.org', image: 'https://www.igouverte.org/assets/img/NONEXISTINGIMAGE.png'};\r\n      }\r\n      return { id , name: `Name ${id}`, description: `<b>Description ${id}</b>`, url: 'https://igouverte.org', image: 'https://www.igouverte.org/assets/img/Igo_logoavec.png'};\r\n    });\r\n    this.store.load(entities);\r\n  }\r\n\r\n  entitySortChange() {\r\n    this.entitySortChange$.next(true);\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-table\">code of this example</a>\r\n  </mat-card-content>\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [withPaginator]=\"true\"\r\n    [paginatorOptions]=\"paginatorOptions\"\r\n    [template]=\"template\"\r\n    (entitySortChange)=\"entitySortChange()\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntityTableModule, IgoEntityTablePaginatorModule } from '@igo2/common';\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\nimport { AppEntityTableRoutingModule } from './entity-table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntityTableComponent],\r\n  imports: [\r\n    AppEntityTableRoutingModule,\r\n    MatCardModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  exports: [AppEntityTableComponent]\r\n})\r\nexport class AppEntityTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Selector</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-selector\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-entity-selector\r\n    [store]=\"store\"\r\n    [titleAccessor]=\"getTitle\"\r\n    [emptyText]=\"''\"\r\n    [placeholder]=\"'Select an entity'\"\r\n    (selectedChange)=\"onSelectedChange($event)\">\r\n  </igo-entity-selector>\r\n\r\n  <div *ngIf=\"selected$ | async as selected\">\r\n    <p>ID: {{selected.id}}</p>\r\n    <p>Name: {{selected.name}}</p>\r\n    <p>Description: <span [innerHtml]=\"selected.description\"></span></p>\r\n  </div>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-selector',\r\n    component: AppEntitySelectorComponent\r\n  }\r\n];\r\n\r\nexport const AppEntitySelectorRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\ninterface DemoEntity {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'app-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss']\r\n})\r\nexport class AppEntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  public store = new EntityStore([]);\r\n\r\n  public selected$ = new BehaviorSubject<DemoEntity>(undefined);\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {id: '2', name: 'Name 2', description: '<b>Description 2</b>'},\r\n      {id: '1', name: 'Name 1', description: '<b>Description 1</b>'},\r\n      {id: '3', name: 'Name 3', description: '<b>Description 3</b>'}\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  getTitle(entity: DemoEntity): string {\r\n    return entity.name;\r\n  }\r\n\r\n  onSelectedChange(event: {selected: boolean; entity: DemoEntity}) {\r\n    this.selected$.next(event.entity);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntitySelectorModule } from '@igo2/common';\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\nimport { AppEntitySelectorRoutingModule } from './entity-selector-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntitySelectorComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppEntitySelectorRoutingModule,\r\n    MatCardModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [AppEntitySelectorComponent]\r\n})\r\nexport class AppEntitySelectorModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFormComponent } from './form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'form',\r\n    component: AppFormComponent\r\n  }\r\n];\r\n\r\nexport const AppFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss']\r\n})\r\nexport class AppFormComponent implements OnInit, OnDestroy {\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private formService: FormService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        options:  {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options:  {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'status',\r\n        title: 'Status',\r\n        type: 'select',\r\n        options:  {\r\n          cols: 2\r\n        },\r\n        inputs: {\r\n          choices: [\r\n            {value: 1, title: 'Single'},\r\n            {value: 2, title: 'Married'}\r\n          ]\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      id: 1,\r\n      name: 'Bob',\r\n      status: 2\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { AppFormComponent } from './form.component';\r\nimport { AppFormRoutingModule } from './form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFormComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppFormRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [AppFormComponent]\r\n})\r\nexport class AppFormModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTableComponent } from './table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'table',\r\n    component: AppTableComponent\r\n  }\r\n];\r\n\r\nexport const AppTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { TableDatabase, TableActionColor } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class AppTableComponent implements OnInit {\r\n  public database: TableDatabase;\r\n\r\n  public model = {\r\n    columns: [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        sortable: false,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        sortable: true,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        sortable: true,\r\n        filterable: true\r\n      }\r\n    ],\r\n    actions: [\r\n      {\r\n        icon: 'file-document',\r\n        color: TableActionColor.primary,\r\n        click: row => this.showName(row.name)\r\n      }\r\n    ],\r\n    selectionCheckbox: true\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.database = new TableDatabase([\r\n      { id: '2', name: 'Name 2', description: 'Hello 2' },\r\n      { id: '1', name: 'Name 1', description: 'Bonjour 1' },\r\n      { id: '3', name: 'Name 3', description: 'Hola 3' }\r\n    ]);\r\n  }\r\n\r\n  showName(name) {\r\n    alert(name);\r\n  }\r\n\r\n  handleSelect(rows) {\r\n    console.log(rows);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/table\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-table\r\n    [database]=\"database\"\r\n    [model]=\"model\"\r\n    [hasFilterInput]=\"true\"\r\n    (select)=\"handleSelect($event)\">\r\n  </igo-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoTableModule } from '@igo2/common';\r\n\r\nimport { AppTableComponent } from './table.component';\r\nimport { AppTableRoutingModule } from './table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTableComponent],\r\n  imports: [\r\n    AppTableRoutingModule,\r\n    MatCardModule,\r\n    IgoTableModule\r\n  ],\r\n  exports: [AppTableComponent]\r\n})\r\nexport class AppTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Tool</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/tool\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-panel [title]=\"panelTitle\">\r\n    <button\r\n      mat-icon-button\r\n      panelLeftButton\r\n      (click)=\"toolbox.activatePreviousTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"arrow-back\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      panelRightButton\r\n      (click)=\"toolbox.deactivateTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"menu\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-toolbox [toolbox]=\"toolbox\" [animate]=\"true\"></igo-toolbox>\r\n  </igo-panel>\r\n\r\n  <button\r\n    mat-flat-button\r\n    type=\"button\"\r\n    color=\"primary\"\r\n    (click)=\"activateSalutationTool()\">\r\n    Activate Salutation Tool\r\n  </button>\r\n\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  OnUpdateInputs,\r\n  Tool,\r\n  Toolbox,\r\n  ToolComponent,\r\n  ToolService\r\n} from '@igo2/common';\r\n\r\n@ToolComponent({\r\n  name: 'demo-salutation',\r\n  title: 'Salutation',\r\n  icon: 'account',\r\n  options: {name: 'Jack'}\r\n})\r\n@Component({\r\n  selector: 'app-salutation-tool',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationToolComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@ToolComponent({\r\n  name: 'demo-about',\r\n  title: 'About',\r\n  icon: 'information'\r\n})\r\n@Component({\r\n  selector: 'app-about-tool',\r\n  template: `\r\n    <p>I'm a tool inside a toolbox.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppAboutToolComponent {}\r\n\r\n@Component({\r\n  selector: 'app-tool',\r\n  templateUrl: './tool.component.html',\r\n  styleUrls: ['./tool.component.scss']\r\n})\r\nexport class AppToolComponent implements OnInit, OnDestroy {\r\n\r\n  toolbox = new Toolbox();\r\n\r\n  get activeTool$(): BehaviorSubject<Tool> {\r\n    return this.toolbox.activeTool$;\r\n  }\r\n\r\n  get panelTitle(): string {\r\n    return this.activeTool$.value ? this.activeTool$.value.title : 'Toolbox';\r\n  }\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.toolbox.setToolbar(['demo-salutation', 'demo-about']);\r\n    this.toolbox.setTools(this.toolService.getTools());\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.toolbox.destroy();\r\n  }\r\n\r\n  activateSalutationTool() {\r\n    this.toolbox.activateTool('demo-salutation', {name: 'Bob'});\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppToolComponent } from './tool.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'tool',\r\n    component: AppToolComponent\r\n  }\r\n];\r\n\r\nexport const AppToolRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoPanelModule, IgoToolModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppToolComponent,\r\n  AppSalutationToolComponent,\r\n  AppAboutToolComponent\r\n} from './tool.component';\r\nimport { AppToolRoutingModule } from './tool-routing.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        AppToolComponent,\r\n        AppSalutationToolComponent,\r\n        AppAboutToolComponent\r\n    ],\r\n    imports: [\r\n        CommonModule,\r\n        AppToolRoutingModule,\r\n        MatButtonModule,\r\n        MatIconModule,\r\n        MatCardModule,\r\n        IgoLanguageModule,\r\n        IgoPanelModule,\r\n        IgoToolModule.forRoot()\r\n    ],\r\n    exports: [AppToolComponent]\r\n})\r\nexport class AppToolModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent, OnUpdateInputs, WidgetComponent, WidgetService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-widget',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n    <button mat-flat-button (click)=\"complete.emit(name)\">Nice to meet you</button>\r\n    <button mat-flat-button (click)=\"cancel.emit(name)\">Dismiss</button>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationWidgetComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() name: string;\r\n\r\n  @Output() complete = new EventEmitter<string>();\r\n\r\n  @Output() cancel = new EventEmitter<string>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-widget',\r\n  templateUrl: './widget.component.html',\r\n  styleUrls: ['./widget.component.scss']\r\n})\r\nexport class AppWidgetComponent {\r\n\r\n  widget: DynamicComponent<WidgetComponent> = this.widgetService.create(AppSalutationWidgetComponent);\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  constructor(private widgetService: WidgetService) {}\r\n\r\n  onWidgetComplete(name: string) {\r\n    alert(`${name} emitted event 'complete' then got automatically destroyed.`);\r\n  }\r\n\r\n  onWidgetCancel() {\r\n    alert(`Widget emitted event 'cancel' then got automatically destroyed.`);\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWidgetComponent } from './widget.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'widget',\r\n    component: AppWidgetComponent\r\n  }\r\n];\r\n\r\nexport const AppWidgetRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Widget</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/widget\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"inputs\"\r\n    (complete)=\"onWidgetComplete($event)\"\r\n    (cancel)=\"onWidgetCancel()\">\r\n  </igo-widget-outlet>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationWidgetComponent,\r\n  AppWidgetComponent\r\n} from './widget.component';\r\nimport { AppWidgetRoutingModule } from './widget-routing.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        AppSalutationWidgetComponent,\r\n        AppWidgetComponent\r\n    ],\r\n    imports: [\r\n        AppWidgetRoutingModule,\r\n        MatButtonModule,\r\n        MatCardModule,\r\n        IgoWidgetModule\r\n    ],\r\n    exports: [AppWidgetComponent]\r\n})\r\nexport class AppWidgetModule {}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport jwtDecode from 'jwt-decode';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class TokenService {\r\n  private options: AuthOptions;\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  set(token: string) {\r\n    localStorage.setItem(this.tokenKey, token);\r\n  }\r\n\r\n  remove() {\r\n    localStorage.removeItem(this.tokenKey);\r\n  }\r\n\r\n  get(): string {\r\n    return localStorage.getItem(this.tokenKey);\r\n  }\r\n\r\n  decode() {\r\n    const token = this.get();\r\n    if (!token) {\r\n      return;\r\n    }\r\n    return jwtDecode(token);\r\n  }\r\n\r\n  isExpired() {\r\n    const jwt = this.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n    if (jwt && currentTime < jwt.exp) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private get tokenKey() {\r\n    const config = this.injector.get<ConfigService>(ConfigService);\r\n    this.options = config.getConfig('auth') || {};\r\n    return this.options.tokenKey;\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\nimport { Router } from '@angular/router';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { tap, catchError } from 'rxjs/operators';\r\nimport { globalCacheBusterNotifier } from 'ts-cacheable';\r\n\r\nimport { ConfigService, LanguageService, MessageService } from '@igo2/core';\r\nimport { Base64 } from '@igo2/utils';\r\n\r\nimport { User, IInfosUser } from './auth.interface';\r\nimport { TokenService } from './token.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  public authenticate$ = new BehaviorSubject<boolean>(undefined);\r\n  public logged$ = new BehaviorSubject<boolean>(undefined);\r\n  public redirectUrl: string;\r\n  public languageForce = false;\r\n  private anonymous = false;\r\n\r\n  get hasAuthService() {\r\n    return this.config.getConfig('auth.url') !== undefined;\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private tokenService: TokenService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.authenticate$.next(this.authenticated);\r\n    this.authenticate$.subscribe((authenticated) => {\r\n      this.logged$.next(authenticated);\r\n      globalCacheBusterNotifier.next();\r\n    });\r\n  }\r\n\r\n  login(username: string, password: string): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      username,\r\n      password: this.encodePassword(password)\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginWithToken(token: string, type: string, infosUser?: IInfosUser): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      token,\r\n      typeConnection: type,\r\n      infosUser\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginAnonymous(): Observable<boolean> {\r\n    this.anonymous = true;\r\n    this.logged$.next(true);\r\n    return of(true);\r\n  }\r\n\r\n  refresh(): Observable<void> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/refresh`, {}).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  logout(): Observable<boolean> {\r\n    this.anonymous = false;\r\n    this.tokenService.remove();\r\n    this.authenticate$.next(false);\r\n    return of(true);\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return !this.tokenService.isExpired();\r\n  }\r\n\r\n  getToken(): string {\r\n    return this.tokenService.get();\r\n  }\r\n\r\n  decodeToken() {\r\n    if (this.isAuthenticated()) {\r\n      return this.tokenService.decode();\r\n    }\r\n    return false;\r\n  }\r\n\r\n  goToRedirectUrl() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n    const redirectUrl = this.redirectUrl || this.router.url;\r\n\r\n    const options = this.config.getConfig('auth') || {};\r\n    if (redirectUrl === options.loginRoute) {\r\n      const homeRoute = options.homeRoute || '/';\r\n      this.router.navigateByUrl(homeRoute);\r\n    } else if (redirectUrl) {\r\n      this.router.navigateByUrl(redirectUrl);\r\n    }\r\n  }\r\n\r\n  getUserInfo(): Observable<User> {\r\n    const url = this.config.getConfig('auth.url') + '/info';\r\n    return this.http.get<User>(url);\r\n  }\r\n\r\n  getProfils(): Observable<{ profils: string[] }> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.get<{ profils: string[] }>(`${url}/profils`);\r\n  }\r\n\r\n  updateUser(user: User): Observable<User> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.patch<User>(url, user);\r\n  }\r\n\r\n  private encodePassword(password: string) {\r\n    return Base64.encode(password);\r\n  }\r\n\r\n  // authenticated or anonymous\r\n  get logged(): boolean {\r\n    return this.authenticated || this.isAnonymous;\r\n  }\r\n\r\n  get isAnonymous(): boolean {\r\n    return this.anonymous;\r\n  }\r\n\r\n  get authenticated(): boolean {\r\n    return this.isAuthenticated();\r\n  }\r\n\r\n  get isAdmin(): boolean {\r\n    const token = this.decodeToken();\r\n    if (token && token.user && token.user.isAdmin) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private loginCall(body, headers) {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/login`, body, { headers }).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n        const tokenDecoded = this.decodeToken();\r\n        if (tokenDecoded && tokenDecoded.user) {\r\n          if (tokenDecoded.user.locale && !this.languageForce) {\r\n            this.languageService.setLanguage(tokenDecoded.user.locale);\r\n          }\r\n          if (tokenDecoded.user.isExpired) {\r\n              this.messageService.alert('igo.auth.error.Password expired');\r\n          }\r\n        }\r\n        this.authenticate$.next(true);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { AuthGoogleOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-google',\r\n  templateUrl: './auth-google.component.html',\r\n  styleUrls: ['./auth-google.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthGoogleComponent {\r\n  private options: AuthGoogleOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.google') || {};\r\n\r\n    if (this.options.apiKey && this.options.clientId) {\r\n      this.loadSDKGoogle();\r\n      this.loadPlatform();\r\n    } else {\r\n      console.warn('Google authentification needs \"apiKey\" and \"clientId\" options');\r\n    }\r\n  }\r\n\r\n  public handleSignInClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signIn();\r\n  }\r\n\r\n  public handleSignOutClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signOut();\r\n  }\r\n\r\n  private handleClientLoad() {\r\n    (window as any).gapi.load('client:auth2', () => this.initClient());\r\n  }\r\n\r\n  private initClient() {\r\n    (window as any).gapi.client\r\n      .init({\r\n        apiKey: this.options.apiKey,\r\n        clientId: this.options.clientId,\r\n        discoveryDocs: [\r\n          'https://people.googleapis.com/$discovery/rest?version=v1'\r\n        ],\r\n        scope: 'profile'\r\n      })\r\n      .then(() => {\r\n        this.handleSignOutClick();\r\n        this.updateTextButton();\r\n        (window as any).gapi.auth2.getAuthInstance().isSignedIn.listen(rep => {\r\n          this.updateSigninStatus(rep);\r\n        });\r\n      });\r\n  }\r\n\r\n  private updateSigninStatus(isSignedIn) {\r\n    this.updateTextButton();\r\n    if (isSignedIn) {\r\n      this.loginGoogle((window as any).gapi.client.getToken().access_token);\r\n    }\r\n  }\r\n\r\n  private updateTextButton() {\r\n    const btn = document.querySelector('span[id^=\"not_signed_\"]');\r\n    if (btn && this.languageService.getLanguage() !== 'en') {\r\n      if (btn.innerHTML === 'Sign in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.login');\r\n      } else if (btn.innerHTML === 'Signed in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.logged');\r\n      }\r\n    }\r\n  }\r\n\r\n  private loginGoogle(token) {\r\n    this.authService.loginWithToken(token, 'google').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKGoogle() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-jssdk';\r\n    js.src = 'https://apis.google.com/js/api.js';\r\n    js.onload = () => {\r\n      this.handleClientLoad();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n\r\n  private loadPlatform() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-platform';\r\n    js.src = 'https://apis.google.com/js/platform.js';\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div class=\"g-signin2 google-login-button\" data-height=\"40\" data-width=\"265\" data-longtitle=\"true\">\r\n","<form [formGroup]=\"form\" role=\"form\" (ngSubmit)=\"loginUser(form.value)\">\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required placeholder=\"{{'igo.auth.user' | translate}}\" formControlName=\"username\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required type=\"password\" placeholder=\"{{'igo.auth.password' | translate}}\" formControlName=\"password\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button mat-raised-button type=\"submit\">{{'igo.auth.login' | translate}}</button>\r\n  <button *ngIf=\"allowAnonymous\" mat-raised-button class=\"anonymous\" type=\"button\" [disabled]=\"loading\" (click)=\"loginAnonymous()\">\r\n    {{'igo.auth.accessAnonymous' | translate }}\r\n  </button>\r\n  <div *ngIf=\"error\">\r\n    <br/>\r\n    <font size=\"3\" color=\"red\">{{error}}</font>\r\n  </div>\r\n</form>\r\n\r\n<!--\r\nThis part was removed from the below line to fix Angular issue 30616 : [disabled]=\"!form.valid || loading\r\n  <button mat-raised-button type=\"submit\" [disabled]=\"!form.valid || loading\">{{'igo.auth.login' | translate}}</button>*/\r\n-->\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Validators, UntypedFormGroup, UntypedFormBuilder } from '@angular/forms';\r\n\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-auth-intern',\r\n  templateUrl: './auth-intern.component.html',\r\n  styleUrls: ['./auth-intern.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthInternComponent {\r\n  @Input()\r\n  get allowAnonymous(): boolean {\r\n    return this._allowAnonymous;\r\n  }\r\n  set allowAnonymous(value: boolean) {\r\n    this._allowAnonymous = value;\r\n  }\r\n  private _allowAnonymous = true;\r\n\r\n  public error = '';\r\n  public form: UntypedFormGroup;\r\n  public loading = false;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private languageService: LanguageService,\r\n    fb: UntypedFormBuilder\r\n  ) {\r\n    this.form = fb.group({\r\n      username: ['', Validators.required],\r\n      password: ['', Validators.required]\r\n    });\r\n  }\r\n\r\n  loginUser(values: any) {\r\n    this.loading = true;\r\n    this.auth.login(values.username, values.password).subscribe(\r\n      () => {\r\n        this.login.emit(true);\r\n        this.loading = false;\r\n      },\r\n      (error: any) => {\r\n        try {\r\n          this.languageService.translate\r\n            .get('igo.auth.error.' + error.error.message)\r\n            .subscribe(errorMsg => (this.error = errorMsg));\r\n        } catch (e) {\r\n          this.error = error.error.message;\r\n        }\r\n        this.loading = false;\r\n      }\r\n    );\r\n    return false;\r\n  }\r\n\r\n  loginAnonymous() {\r\n    this.auth.loginAnonymous().subscribe(() => {\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthFacebookOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-facebook',\r\n  templateUrl: './auth-facebook.component.html',\r\n  styleUrls: ['./auth-facebook.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthFacebookComponent {\r\n  private options: AuthFacebookOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.facebook') || {};\r\n\r\n    if (this.options.appId) {\r\n      this.loadSDKFacebook();\r\n    } else {\r\n      console.warn('Facebook authentification needs \"appId\" option');\r\n    }\r\n  }\r\n\r\n  private subscribeEvents() {\r\n    (window as any).FB.Event.subscribe('auth.statusChange', rep => {\r\n      this.statusChangeCallback(rep);\r\n    });\r\n  }\r\n\r\n  private statusChangeCallback(response) {\r\n    if (response.status === 'connected') {\r\n      const accessToken = response.authResponse.accessToken;\r\n      this.loginFacebook(accessToken);\r\n    }\r\n  }\r\n\r\n  private loginFacebook(token) {\r\n    this.authService.loginWithToken(token, 'facebook').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKFacebook() {\r\n    if (document.getElementById('facebook-jssdk')) {\r\n      return;\r\n    }\r\n\r\n    const urlSDK =\r\n      'https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v2.9';\r\n\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'facebook-jssdk';\r\n    js.src = `${urlSDK}&appId=${this.options.appId}`;\r\n    js.onload = () => {\r\n      this.subscribeEvents();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div scope=\"public_profile,email\"\r\n     class=\"fb-login-button\" data-max-rows=\"1\" data-size=\"large\"\r\n     data-button-type=\"login_with\" data-show-faces=\"false\"\r\n     data-auto-logout-link=\"false\" data-use-continue-as=\"false\">\r\n</div>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\nimport { MsalBroadcastService, MsalService, MSAL_GUARD_CONFIG} from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoft',\r\n  templateUrl: './auth-microsoft.component.html',\r\n  styleUrls: ['./auth-microsoft.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftComponent {\r\n  private options: AuthMicrosoftOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastService;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalService,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n    this.options = this.config.getConfig('auth.microsoft') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastService(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoft() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const tokenAccess = response.accessToken;\r\n        const tokenId = response.idToken;\r\n        this.authService.loginWithToken(tokenAccess, 'microsoft', { tokenId } ).subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        console.log(error);\r\n      }).catch(error => {\r\n        console.log('Silent token fails');\r\n      });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'add')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoft()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoft.login' | translate}}\r\n</button>\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { Location } from '@angular/common';\r\nimport {\r\n    IPublicClientApplication,\r\n    EndSessionRequest,\r\n    EndSessionPopupRequest,\r\n    AuthenticationResult,\r\n    RedirectRequest,\r\n    SilentRequest,\r\n    PopupRequest,\r\n    SsoSilentRequest,\r\n    Logger,\r\n    WrapperSKU\r\n} from '@azure/msal-browser';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { Observable, from } from 'rxjs';\r\nimport { IMsalService } from '@azure/msal-angular';\r\n\r\n@Injectable()\r\nexport class MsalServiceb2c implements IMsalService {\r\n    private redirectHash: string;\r\n    private logger: Logger;\r\n    private name = '@azure/msal-angular';\r\n    private version = '2.0.0-beta.2';\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) public instance: IPublicClientApplication,\r\n        private location: Location\r\n    ) {\r\n        const hash = this.location.path(true).split('#').pop();\r\n        if (hash) {\r\n            this.redirectHash = `#${hash}`;\r\n        }\r\n        this.instance.initializeWrapperLibrary(WrapperSKU.Angular, this.version);\r\n    }\r\n\r\n    initialize(): Observable<void> {\r\n        return from(this.instance.initialize());\r\n    }\r\n\r\n    acquireTokenPopup(request: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenPopup(request));\r\n    }\r\n    acquireTokenRedirect(request: RedirectRequest): Observable<void> {\r\n        return from(this.instance.acquireTokenRedirect(request));\r\n    }\r\n    acquireTokenSilent(silentRequest: SilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenSilent(silentRequest));\r\n    }\r\n    handleRedirectObservable(hash?: string): Observable<AuthenticationResult> {\r\n        return from(this.instance.handleRedirectPromise(hash || this.redirectHash));\r\n    }\r\n    loginPopup(request?: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.loginPopup(request));\r\n    }\r\n    loginRedirect(request?: RedirectRequest): Observable<void> {\r\n        return from(this.instance.loginRedirect(request));\r\n    }\r\n    logout(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logout(logoutRequest));\r\n    }\r\n    logoutRedirect(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logoutRedirect(logoutRequest));\r\n    }\r\n    logoutPopup(logoutRequest?: EndSessionPopupRequest): Observable<void> {\r\n        return from(this.instance.logoutPopup(logoutRequest));\r\n    }\r\n    ssoSilent(request: SsoSilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.ssoSilent(request));\r\n    }\r\n    /**\r\n     * Gets logger for msal-angular.\r\n     * If no logger set, returns logger instance created with same options as msal-browser\r\n     */\r\n    getLogger(): Logger {\r\n        if (!this.logger) {\r\n            this.logger = this.instance.getLogger().clone(this.name, this.version);\r\n        }\r\n        return this.logger;\r\n    }\r\n    // Create a logger instance for msal-angular with the same options as msal-browser\r\n    setLogger(logger: Logger): void {\r\n        this.logger = logger.clone(this.name, this.version);\r\n        this.instance.setLogger(logger);\r\n    }\r\n\r\n}\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { BehaviorSubject, Observable, Subject } from 'rxjs';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { EventMessage, EventMessageUtils, IPublicClientApplication, InteractionStatus } from '@azure/msal-browser';\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\n@Injectable()\r\nexport class MsalBroadcastServiceb2c {\r\n    private _msalSubject: Subject<EventMessage>;\r\n    public msalSubject$: Observable<EventMessage>;\r\n    private _inProgress: BehaviorSubject<InteractionStatus>;\r\n    public inProgress$: Observable<InteractionStatus>;\r\n\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) private msalInstance: IPublicClientApplication,\r\n        private authService: MsalServiceb2c\r\n    ) {\r\n        this._msalSubject = new Subject<EventMessage>();\r\n        this.msalSubject$ = this._msalSubject.asObservable();\r\n\r\n        // InProgress as BehaviorSubject so most recent inProgress state will be available upon subscription\r\n        this._inProgress = new BehaviorSubject<InteractionStatus>(InteractionStatus.Startup);\r\n        this.inProgress$ = this._inProgress.asObservable();\r\n\r\n        this.msalInstance.addEventCallback((message: EventMessage) => {\r\n            this._msalSubject.next(message);\r\n            const status = EventMessageUtils.getInteractionStatusFromEvent(message);\r\n            if (status !== null) {\r\n                this.authService.getLogger().verbose(`BroadcastService - ${message.eventType} results in setting inProgress to ${status}`);\r\n                this._inProgress.next(status);\r\n            }\r\n        });\r\n    }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\n\r\nimport { MSAL_GUARD_CONFIG } from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftb2cOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\nimport { MsalBroadcastServiceb2c } from '../shared/auth-msalBroadcastServiceb2c.service';\r\nimport { MsalServiceb2c } from '../shared/auth-msalServiceb2c.service.';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoftb2c',\r\n  templateUrl: './auth-microsoftb2c.component.html',\r\n  styleUrls: ['./auth-microsoftb2c.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftb2cComponent {\r\n  private options: AuthMicrosoftb2cOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastServiceb2c;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalServiceb2c,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n\r\n    this.options = this.config.getConfig('auth.microsoftb2c') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options.browserAuthOptions,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastServiceb2c(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.browserAuthOptions.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoftb2c() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const token = response.idToken;\r\n        this.authService.loginWithToken(token, 'microsoftb2c').subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        }).catch(error => {\r\n          console.log('Silent token fails');\r\n        });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'b2c')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoftb2c()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoftb2c.login' | translate}}\r\n</button>\r\n","<div *ngIf=\"visible\">\r\n  <div *ngIf=\"!auth.logged && backgroundDisable\" class=\"backgroundDisable\"></div>\r\n\r\n  <div *ngIf=\"!auth.logged && showLoginDiv\" class=\"login center-block\">\r\n    <h1>{{'igo.auth.connection' | translate}}</h1>\r\n\r\n    <igo-auth-google\r\n      *ngIf=\"options.google && options.google.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-google>\r\n    <igo-auth-microsoft\r\n      *ngIf=\"options.microsoft && options.microsoft.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoft>\r\n    <igo-auth-microsoftb2c\r\n      *ngIf=\"options.microsoftb2c && options.microsoftb2c.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoftb2c>\r\n    <igo-auth-facebook\r\n      *ngIf=\"options.facebook && options.facebook.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-facebook>\r\n    <igo-auth-intern\r\n      *ngIf=\"!options.intern || options.intern.enabled !== false\"\r\n      [allowAnonymous]=\"options.allowAnonymous\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-intern>\r\n  </div>\r\n\r\n  <div *ngIf=\"auth.logged && showAlreadyConnectedDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.welcome' | translate: user}}</p>\r\n    <button mat-raised-button type=\"button\" (click)=\"logout()\">{{'igo.auth.signOut' | translate}}</button>\r\n  </div>\r\n\r\n  <div *ngIf=\"showLogoutDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.deconnection' | translate}}</p>\r\n    <button *ngIf=\"options.homeRoute\" mat-raised-button type=\"button\" (click)=\"home()\">{{'igo.auth.home' | translate}}</button>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  Input,\r\n  Optional,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Router, NavigationStart } from '@angular/router';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthFormComponent implements OnInit {\r\n  @Input()\r\n  get backgroundDisable(): boolean {\r\n    if (this.isLogoutRoute || this.isLogoutRoute) {\r\n      return false;\r\n    }\r\n    return this._backgroundDisable;\r\n  }\r\n  set backgroundDisable(value: boolean) {\r\n    this._backgroundDisable = value.toString() === 'true';\r\n  }\r\n  private _backgroundDisable = true;\r\n\r\n  @Input()\r\n  get hasAlreadyConnectedDiv(): boolean {\r\n    return this._hasAlreadyConnectedDiv;\r\n  }\r\n  set hasAlreadyConnectedDiv(value: boolean) {\r\n    this._hasAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _hasAlreadyConnectedDiv = true;\r\n\r\n  @Input()\r\n  get hasLogoutDiv(): boolean {\r\n    return this._hasLogoutDiv;\r\n  }\r\n  set hasLogoutDiv(value: boolean) {\r\n    this._hasLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _hasLogoutDiv = true;\r\n\r\n  @Input()\r\n  get showAlreadyConnectedDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasAlreadyConnectedDiv;\r\n    }\r\n    return this._showAlreadyConnectedDiv;\r\n  }\r\n  set showAlreadyConnectedDiv(value: boolean) {\r\n    this._showAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _showAlreadyConnectedDiv = false;\r\n\r\n  @Input()\r\n  get showLogoutDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasLogoutDiv;\r\n    }\r\n    return this._showLogoutDiv;\r\n  }\r\n  set showLogoutDiv(value: boolean) {\r\n    this._showLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _showLogoutDiv = false;\r\n\r\n  get showLoginDiv(): boolean {\r\n    if (!this.isLogoutRoute) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  public options: AuthOptions;\r\n  public user;\r\n\r\n  public visible = true;\r\n\r\n  private isLoginRoute: boolean;\r\n  private isLogoutRoute: boolean;\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private config: ConfigService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.options = this.config.getConfig('auth') || {};\r\n    this.visible = Object.getOwnPropertyNames(this.options).length !== 0;\r\n  }\r\n\r\n  public ngOnInit() {\r\n    this.analyzeRoute();\r\n    this.getName();\r\n  }\r\n\r\n  public onLogin() {\r\n    this.auth.goToRedirectUrl();\r\n    this.getName();\r\n    this.login.emit(true);\r\n  }\r\n\r\n  public logout() {\r\n    this.auth.logout().subscribe(() => {\r\n      this.user = undefined;\r\n      if (this.router) {\r\n        if (this.options.logoutRoute) {\r\n          this.router.navigate([this.options.logoutRoute]);\r\n        } else if (this.options.homeRoute) {\r\n          this.router.navigate([this.options.homeRoute]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public home() {\r\n    if (this.router && this.options.homeRoute) {\r\n      this.router.navigate([this.options.homeRoute]);\r\n    }\r\n  }\r\n\r\n  private getName() {\r\n    const tokenDecoded = this.auth.decodeToken();\r\n    if (tokenDecoded) {\r\n      this.user = {\r\n        name: tokenDecoded.user.firstName || tokenDecoded.user.sourceId\r\n      };\r\n    }\r\n  }\r\n\r\n  private analyzeRoute() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n\r\n    this.router.events\r\n      .pipe(filter((event) => event instanceof NavigationStart))\r\n      .subscribe((changeEvent: any) => {\r\n        if (changeEvent.url) {\r\n          const currentRoute = changeEvent.url;\r\n          const logoutRoute = this.options.logoutRoute;\r\n          const loginRoute = this.options.loginRoute;\r\n\r\n          this.isLogoutRoute = currentRoute === logoutRoute;\r\n          this.isLoginRoute = currentRoute === loginRoute;\r\n\r\n          if (this.isLogoutRoute) {\r\n            this.auth.logout();\r\n          }\r\n        }\r\n      });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport {\r\n  HttpEvent,\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { TokenService } from './token.service';\r\nimport { AuthByKeyOptions, WithCredentialsOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthInterceptor implements HttpInterceptor {\r\n  private refreshInProgress = false;\r\n\r\n  private get trustHosts() {\r\n    const trustHosts = this.config.getConfig('auth.trustHosts') || [];\r\n    trustHosts.push(window.location.hostname);\r\n    return trustHosts;\r\n  }\r\n\r\n  private get hostsWithCredentials(): WithCredentialsOptions[] {\r\n    return this.config.getConfig('auth.hostsWithCredentials') || [];\r\n  }\r\n\r\n  private get hostsWithAuthByKey(): AuthByKeyOptions[] {\r\n    return this.config.getConfig('auth.hostsByKey') || [];\r\n  }\r\n\r\n  constructor(\r\n    private config: ConfigService,\r\n    private tokenService: TokenService,\r\n    private http: HttpClient\r\n  ) {}\r\n\r\n  intercept(\r\n    originalReq: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const withCredentials = this.handleHostsWithCredentials(originalReq.url);\r\n    let req = originalReq.clone();\r\n    const hostWithKey = this.handleHostsAuthByKey(originalReq.url);\r\n    if (hostWithKey) {\r\n      req = req.clone({\r\n        params: req.params.set(hostWithKey.key, hostWithKey.value)\r\n      });\r\n    }\r\n    if (withCredentials) {\r\n      req = originalReq.clone({\r\n        withCredentials\r\n      });\r\n      return next.handle(req);\r\n    }\r\n    this.refreshToken();\r\n    const token = this.tokenService.get();\r\n    const element = document.createElement('a');\r\n    element.href = req.url;\r\n    if (element.host === '') {\r\n      element.href = element.href; // FIX IE11, DO NOT REMOVE\r\n    }\r\n\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return next.handle(req);\r\n    }\r\n\r\n    const authHeader = `Bearer ${token}`;\r\n    let authReq = req.clone({\r\n      headers: req.headers.set('Authorization', authHeader)\r\n    });\r\n\r\n    const tokenDecoded: any = this.tokenService.decode();\r\n    if (\r\n      authReq.params.get('_i') === 'true' &&\r\n      tokenDecoded &&\r\n      tokenDecoded.user &&\r\n      tokenDecoded.user.sourceId\r\n    ) {\r\n      const hashUser = Md5.hashStr(tokenDecoded.user.sourceId) as string;\r\n      authReq = authReq.clone({\r\n        params: authReq.params.set('_i', hashUser)\r\n      });\r\n    } else if (authReq.params.get('_i') === 'true') {\r\n      authReq = authReq.clone({\r\n        params: authReq.params.delete('_i')\r\n      });\r\n    }\r\n\r\n    return next.handle(authReq);\r\n  }\r\n\r\n  interceptXhr(xhr, url: string): boolean {\r\n    const withCredentials = this.handleHostsWithCredentials(url);\r\n    if (withCredentials) {\r\n       xhr.withCredentials = withCredentials;\r\n       return true;\r\n    }\r\n\r\n    this.refreshToken();\r\n    const element = document.createElement('a');\r\n    element.href = url;\r\n\r\n    const token = this.tokenService.get();\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return false;\r\n    }\r\n    xhr.setRequestHeader('Authorization', 'Bearer ' + token);\r\n    return true;\r\n  }\r\n\r\n  alterUrlWithKeyAuth(url: string): string {\r\n    const hostWithKey = this.handleHostsAuthByKey(url);\r\n    let interceptedUrl = url;\r\n    if (hostWithKey) {\r\n      const urlDecomposed = interceptedUrl.split(/[?&]/);\r\n      let urlWithKeyAdded = urlDecomposed.shift();\r\n      const paramsToKeep = urlDecomposed.filter(p => p.length !== 0);\r\n      paramsToKeep.push(`${hostWithKey.key}=${hostWithKey.value}`);\r\n      if (paramsToKeep.length) {\r\n        urlWithKeyAdded += '?' + paramsToKeep.join('&');\r\n      }\r\n      return urlWithKeyAdded;\r\n    }\r\n    return;\r\n  }\r\n\r\n  private handleHostsWithCredentials(reqUrl: string) {\r\n    let withCredentials = false;\r\n    for (const hostWithCredentials of this.hostsWithCredentials) {\r\n      const domainRegex = new RegExp(hostWithCredentials.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        withCredentials = hostWithCredentials.withCredentials !== undefined ? hostWithCredentials.withCredentials : undefined;\r\n        break;\r\n      }\r\n    }\r\n    return withCredentials;\r\n  }\r\n\r\n  private handleHostsAuthByKey(reqUrl: string): {key: string, value: string} {\r\n    let hostWithKey;\r\n    for (const hostWithAuthByKey of this.hostsWithAuthByKey) {\r\n      const domainRegex = new RegExp(hostWithAuthByKey.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        var replace = `${hostWithAuthByKey.keyProperty}=${hostWithAuthByKey.keyValue}`;\r\n        var keyAdded = new RegExp(replace,\"gm\");\r\n        if (!keyAdded.test(reqUrl)) {\r\n          hostWithKey = {key : hostWithAuthByKey.keyProperty, value: hostWithAuthByKey.keyValue};\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return hostWithKey;\r\n  }\r\n\r\n  refreshToken() {\r\n    const jwt = this.tokenService.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n\r\n    if (\r\n      !this.refreshInProgress &&\r\n      jwt &&\r\n      currentTime < jwt.exp &&\r\n      currentTime > jwt.exp - 1800\r\n    ) {\r\n      this.refreshInProgress = true;\r\n\r\n      const url = this.config.getConfig('auth.url');\r\n      return this.http.post(`${url}/refresh`, {}).subscribe(\r\n        (data: any) => {\r\n          this.tokenService.set(data.token);\r\n          this.refreshInProgress = false;\r\n        },\r\n        err => {\r\n          err.error.caught = true;\r\n          return err;\r\n        }\r\n      );\r\n    }\r\n  }\r\n}\r\n","import {\r\n  MSAL_GUARD_CONFIG,\r\n  MSAL_INSTANCE,\r\n  MsalService,\r\n} from '@azure/msal-angular';\r\n\r\nimport {\r\n  PublicClientApplication,\r\n  InteractionType\r\n} from '@azure/msal-browser';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { BrowserAuthOptions } from '@azure/msal-browser';\r\n\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from './auth.interface';\r\n\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\nexport function MSALConfigFactory(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALConfigFactoryb2c(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALAngularConfigFactory(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: AuthMicrosoftOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: ['user.read'],\r\n      loginHint: 'todo',\r\n    },\r\n    type: 'add'\r\n  };\r\n}\r\n\r\nexport function MSALAngularConfigFactoryb2c(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: [msConf.clientId]\r\n    },\r\n    type: 'b2c'\r\n  };\r\n}\r\n\r\nexport function provideAuthMicrosoft(type?: string) {\r\n  if (type === 'b2c') {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactoryb2c,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactoryb2c,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalServiceb2c\r\n    ];\r\n  } else {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactory,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactory,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalService\r\n    ];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { StorageService, StorageScope, ConfigService } from '@igo2/core';\r\nimport { AuthService } from './auth.service';\r\nimport { TokenService } from './token.service';\r\nimport { AuthStorageOptions } from './storage.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthStorageService extends StorageService {\r\n  protected options: AuthStorageOptions;\r\n\r\n  constructor(\r\n    config: ConfigService,\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private tokenService: TokenService\r\n  ) {\r\n    super(config);\r\n\r\n    this.authService.authenticate$.subscribe(isAuthenticated => {\r\n      if (isAuthenticated && this.options.url) {\r\n        this.http\r\n          .get(this.options.url)\r\n          .subscribe((userIgo: { preference: object }) => {\r\n            if (userIgo && userIgo.preference) {\r\n              for (const key of Object.keys(userIgo.preference)) {\r\n                const value = userIgo.preference[key];\r\n                super.set(key, value);\r\n              }\r\n            }\r\n          });\r\n      }\r\n    });\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = value;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.set(key, value, scope);\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = undefined;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.remove(key, scope);\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http.patch(this.options.url, { preference: {}}, {\r\n        params: {\r\n          mergePreference: 'false'\r\n        }\r\n      }).subscribe();\r\n    }\r\n\r\n    let token: string;\r\n    if (scope === StorageScope.LOCAL) {\r\n      token = this.tokenService.get();\r\n    }\r\n\r\n    super.clear(scope);\r\n\r\n    if (token) {\r\n      this.tokenService.set(token);\r\n    }\r\n\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http\r\n        .get(this.options.url)\r\n        .subscribe((userIgo: { preference: object }) => {\r\n          if (userIgo && userIgo.preference) {\r\n            for (const key of Object.keys(userIgo.preference)) {\r\n              const value = userIgo.preference[key];\r\n              super.set(key, value);\r\n            }\r\n          }\r\n        });\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MsalModule } from '@azure/msal-angular';\r\n\r\nimport { StorageService, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AuthStorageService } from './shared/storage.service';\r\nimport { ProtectedDirective } from './shared/protected.directive';\r\nimport { AuthInterceptor } from './shared/auth.interceptor';\r\nimport { provideAuthMicrosoft } from './shared/auth-microsoft.provider';\r\n\r\nimport { AuthInternComponent } from './auth-form/auth-intern.component';\r\nimport { AuthFormComponent } from './auth-form/auth-form.component';\r\nimport { AuthGoogleComponent } from './auth-form/auth-google.component';\r\nimport { AuthFacebookComponent } from './auth-form/auth-facebook.component';\r\nimport { AuthMicrosoftComponent } from './auth-form/auth-microsoft.component';\r\nimport { AuthMicrosoftb2cComponent } from './auth-form/auth-microsoftb2c.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    MsalModule\r\n  ],\r\n  declarations: [\r\n    AuthFormComponent,\r\n    AuthGoogleComponent,\r\n    AuthInternComponent,\r\n    AuthFacebookComponent,\r\n    AuthMicrosoftComponent,\r\n    AuthMicrosoftb2cComponent,\r\n    ProtectedDirective\r\n  ],\r\n  exports: [AuthFormComponent, ProtectedDirective]\r\n})\r\nexport class IgoAuthModule {\r\n  static forRoot(): ModuleWithProviders<IgoAuthModule> {\r\n    return {\r\n      ngModule: IgoAuthModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: AuthInterceptor,\r\n          multi: true\r\n        },\r\n        {\r\n          provide: StorageService,\r\n          useClass: AuthStorageService\r\n        },\r\n        ...provideAuthMicrosoft('add'),\r\n        ...provideAuthMicrosoft('b2c')\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'auth-form',\r\n    component: AppAuthFormComponent\r\n  }\r\n];\r\n\r\nexport const AppAuthFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss']\r\n})\r\nexport class AppAuthFormComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Auth</mat-card-subtitle>\r\n  <mat-card-title>Authentification</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/auth/auth-form\">code of this example</a><br>\r\n    See auth section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n  </mat-card-content>\r\n</mat-card>\r\n\r\n<igo-auth-form></igo-auth-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\nimport { AppAuthFormRoutingModule } from './auth-form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppAuthFormComponent],\r\n  imports: [AppAuthFormRoutingModule, MatCardModule, IgoAuthModule.forRoot()],\r\n  exports: [AppAuthFormComponent]\r\n})\r\nexport class AppAuthFormModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { MetadataOptions } from './metadata.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MetadataService {\r\n  constructor() {}\r\n\r\n  open(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      window.open(metadata.url, '_blank');\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"(options && options.metadata && options.metadata.url) || (options && options.metadata && options.metadata.abstract)\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.metadata.show' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openMetadata(options.metadata)\">\r\n  <mat-icon svgIcon=\"information-outline\"></mat-icon>\r\n</button>\r\n","<h2 mat-dialog-title>{{ data.layerTitle }}</h2>\r\n<button class=\"close-button\" mat-button mat-dialog-close>X</button>\r\n<mat-dialog-content *ngIf=\"data.type !== 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3>{{ data.abstract }}</h3>\r\n</mat-dialog-content>\r\n<mat-dialog-content *ngIf=\"data.type === 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3 [innerHTML]=\"data.abstract\"></h3>\r\n</mat-dialog-content>\r\n","import { Component, Input, ChangeDetectionStrategy, Inject, ViewEncapsulation } from '@angular/core';\r\nimport { MatDialog, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../shared/metadata.interface';\r\nimport { MetadataService } from '../shared/metadata.service';\r\n\r\n@Component({\r\n  selector: 'igo-metadata-button',\r\n  templateUrl: './metadata-button.component.html',\r\n  styleUrls: ['./metadata-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MetadataButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(\r\n    private metadataService: MetadataService,\r\n    private dialog: MatDialog) {}\r\n\r\n  openMetadata(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      if (!metadata.url && metadata.abstract) {\r\n        this.dialog.open(MetadataAbstractComponent, {\r\n          data: {\r\n            layerTitle: this.layer.title,\r\n            abstract: metadata.abstract,\r\n            type: metadata.type\r\n          }\r\n        });\r\n      } else if (metadata.url) {\r\n        this.metadataService.open(metadata);\r\n      }\r\n    } else if (!metadata.extern && metadata.abstract) {\r\n      this.dialog.open(MetadataAbstractComponent, {\r\n        data: {\r\n          layerTitle: this.layer.title,\r\n          abstract: metadata.abstract,\r\n          type: metadata.type\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  get options(): MetadataLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-metadata-abstract',\r\n  templateUrl: './metadata-abstract.component.html',\r\n  styleUrls: ['./metadata-abstract.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class MetadataAbstractComponent {\r\n  constructor(@Inject(MAT_DIALOG_DATA) public data: MetadataOptions) {}\r\n}\r\n","import { MatDialogModule } from '@angular/material/dialog';\r\nimport { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { MetadataButtonComponent, MetadataAbstractComponent } from './metadata-button/metadata-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent],\r\n  declarations: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent]\r\n})\r\nexport class IgoMetadataModule {\r\n  static forRoot(): ModuleWithProviders<IgoMetadataModule> {\r\n    return {\r\n      ngModule: IgoMetadataModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import * as olproj from 'ol/proj';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { MAC } from 'ol/has';\r\n\r\nimport { NumberUtils } from '@igo2/utils';\r\n\r\nimport { MapViewState } from './map.interface';\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * This method extracts a coordinate tuple from a string.\r\n * @param str Any string\r\n * @param mapProjection string Map Projection\r\n * @param opts.forceNA boolean Force North America Zone\r\n * @returns object:\r\n *             lonLat: Coordinate,\r\n *             message: Message of error,\r\n *             radius: radius of the confience of coordinate,\r\n *             conf: confidence of the coordinate}\r\n */\r\nexport function stringToLonLat(\r\n  str: string,\r\n  mapProjection: string,\r\n  opts: { forceNA?: boolean } = {}\r\n): {\r\n  lonLat: [number, number] | undefined;\r\n  message: string;\r\n  radius: number | undefined;\r\n  conf: number | undefined;\r\n} {\r\n  let lonLat: [number, number];\r\n  let coordStr: string;\r\n  let negativeLon: string;\r\n  let degreesLon: string;\r\n  let minutesLon: string;\r\n  let secondsLon: string;\r\n  let directionLon: string;\r\n  let decimalLon: string;\r\n  let negativeLat: string;\r\n  let degreesLat: string;\r\n  let minutesLat: string;\r\n  let secondsLat: string;\r\n  let directionLat: string;\r\n  let decimalLat: string;\r\n  let zone: string;\r\n  let radius: string;\r\n  let conf: string;\r\n  let lon: any;\r\n  let lat: any;\r\n\r\n  const projectionPattern = '(\\\\s*;\\\\s*[\\\\d]{4,6})';\r\n  const toProjection = '4326';\r\n  let projectionStr: string;\r\n  const projectionRegex = new RegExp(projectionPattern, 'g');\r\n\r\n  const lonlatCoord = '([-+])?([\\\\d]{1,3})([,.](\\\\d+))?';\r\n  const lonLatPattern = `${lonlatCoord}[\\\\s,]+${lonlatCoord}`;\r\n  const lonLatRegex = new RegExp(`^${lonLatPattern}$`, 'g');\r\n\r\n  const dmsCoord =\r\n    '([0-9]{1,2})[:|°]?\\\\s*([0-9]{1,2})?[:|\\'|′|’]?\\\\s*([0-9]{1,2}(?:.[0-9]+){0,1})?\\\\s*[\"|″|”]?\\\\s*';\r\n  const dmsCoordPattern = `${dmsCoord}([N|S|E|W|O]),?\\\\s*${dmsCoord}([N|S|E|W|O])`;\r\n  const dmsRegex = new RegExp(`^${dmsCoordPattern}$`, 'gi');\r\n\r\n  const patternUtm =\r\n    '(UTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const utmRegex = new RegExp(`^${patternUtm}`, 'gi');\r\n\r\n  const patternMtm =\r\n    '(MTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const mtmRegex = new RegExp(`^${patternMtm}`, 'gi');\r\n\r\n  const ddCoord = '([-+])?(\\\\d{1,3})[,.](\\\\d+)';\r\n  const patternDd = `${ddCoord}\\\\s*[,]?\\\\s*${ddCoord}`;\r\n  const ddRegex = new RegExp(`^${patternDd}`, 'g');\r\n\r\n  const dmdCoord =\r\n    '([-+])?(\\\\d{1,3})[\\\\s,.]{1}(\\\\d{1,2})[\\\\s,.]{1}(\\\\d{1,2})[.,]?(\\\\d{1,5})?';\r\n  const patternDmd = `${dmdCoord}\\\\s*[,.]?\\\\s*${dmdCoord}`;\r\n  const dmdRegex = new RegExp(`^${patternDmd}`, 'g');\r\n\r\n /* eslint-disable max-len */\r\n  const patternBELL =\r\n    'LAT\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,2})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*LONG\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,3})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*UNC\\\\s*[\\\\s:]?\\\\s*(\\\\d+)\\\\s*CONF\\\\s*[\\\\s:]?\\\\s*(\\\\d{1,3})';\r\n  const bellRegex = new RegExp(`^${patternBELL}?`, 'gi');\r\n\r\n  const mmCoord = '([-+]?\\\\d+)[,.]?(\\\\d+)?';\r\n  const mmPattern = `${mmCoord}[\\\\s,]+${mmCoord}`;\r\n  const mmRegex = new RegExp(`^${mmPattern}$`, 'g');\r\n\r\n  let isXYCoords = false;\r\n\r\n  str = str.toLocaleUpperCase().trim();\r\n\r\n  // Extract projection\r\n  if (projectionRegex.test(str)) {\r\n    [coordStr, projectionStr] = str.split(';').map(s => s.trim());\r\n  } else {\r\n    coordStr = str;\r\n  }\r\n  if (lonLatRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      lon,\r\n      ,\r\n      decimalLon,\r\n      negativeLat,\r\n      lat,\r\n      ,\r\n      decimalLat\r\n    ] = coordStr.match(lonLatPattern);\r\n\r\n    lon = parseFloat((negativeLon ? negativeLon : '') + lon + '.' + decimalLon);\r\n    lat = parseFloat((negativeLat ? negativeLat : '') + lat + '.' + decimalLat);\r\n  } else if (dmsRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      directionLon,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      directionLat\r\n    ] = coordStr.match(dmsCoordPattern);\r\n\r\n    if (directionLon === 'S' || directionLon === 'N') {\r\n      degreesLon = [degreesLat, (degreesLat = degreesLon)][0];\r\n      minutesLon = [minutesLat, (minutesLat = minutesLon)][0];\r\n      secondsLon = [secondsLat, (secondsLat = secondsLon)][0];\r\n      directionLon = [directionLat, (directionLat = directionLon)][0];\r\n    }\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat(degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat(degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (utmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternUtm);\r\n    const epsgUtm = Number(zone) < 10 ? `EPSG:3260${zone}` : `EPSG:326${zone}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgUtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (mtmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternMtm);\r\n    const epsgMtm =\r\n      Number(zone) < 10 ? `EPSG:3218${zone}` : `EPSG:321${80 + Number(zone)}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgMtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (dmdRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDmd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (ddRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (bellRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      ,\r\n      directionLat,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      ,\r\n      directionLon,\r\n      radius,\r\n      conf\r\n    ] = coordStr.match(patternBELL);\r\n\r\n    // Set default value for North America\r\n    if (!directionLon) {\r\n      directionLon = 'W';\r\n    }\r\n\r\n    // Check if real minutes or decimals\r\n    if (minutesLon && minutesLon.length > 2) {\r\n      lon = parseFloat(\r\n        (negativeLon ? negativeLon : '') + degreesLon + '.' + minutesLon\r\n      );\r\n    } else {\r\n      lon = convertDMSToDD(\r\n        parseFloat(degreesLon),\r\n        parseFloat(minutesLon),\r\n        parseFloat(secondsLon),\r\n        directionLon\r\n      );\r\n    }\r\n\r\n    if (minutesLat && minutesLat.length > 2) {\r\n      lat = parseFloat(\r\n        (negativeLat ? negativeLat : '') + degreesLat + '.' + minutesLat\r\n      );\r\n    } else {\r\n      lat = convertDMSToDD(\r\n        parseFloat(degreesLat),\r\n        parseFloat(minutesLat),\r\n        parseFloat(secondsLat),\r\n        directionLat\r\n      );\r\n    }\r\n  } else if (mmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, lon, decimalLon, lat, decimalLat] = coordStr.match(mmPattern);\r\n\r\n    if (decimalLon) {\r\n      lon = parseFloat(lon + '.' + decimalLon);\r\n    }\r\n\r\n    if (decimalLat) {\r\n      lat = parseFloat(lat + '.' + decimalLat);\r\n    }\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: '',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n\r\n  if (opts.forceNA && !isXYCoords) {\r\n    // Set a negative coordinate for North America zone\r\n    if (lon > 0 && lat > 0) {\r\n      if (lon > lat) {\r\n        lon = -lon;\r\n      } else {\r\n        lat = -lat;\r\n      }\r\n    }\r\n\r\n    // Reverse coordinate to respect lonLat convention\r\n    if (lon > lat) {\r\n      lon = [lat, (lat = lon)][0];\r\n    }\r\n  }\r\n\r\n  lonLat = [Number(lon), Number(lat)] as [number, number];\r\n\r\n  // Reproject the coordinate if projection parameter have been set and coord is not 4326\r\n  if (\r\n    (projectionStr !== undefined && projectionStr !== toProjection) ||\r\n    (lonLat[0] > 180 || lonLat[0] < -180) ||\r\n    (lonLat[1] > 90 || lonLat[1] < -90)\r\n  ) {\r\n    const source = projectionStr ? 'EPSG:' + projectionStr : mapProjection;\r\n    const dest = 'EPSG:' + toProjection;\r\n\r\n    try {\r\n      lonLat = olproj.transform(lonLat, source, dest) as [number, number];\r\n    } catch (e) {\r\n      return {\r\n        lonLat: undefined,\r\n        message: 'Projection ' + source + ' not supported',\r\n        radius: undefined,\r\n        conf: undefined\r\n      };\r\n    }\r\n  }\r\n  if (Math.abs(lonLat[0]) <= 180 && Math.abs(lonLat[1]) <= 90) {\r\n    return {\r\n      lonLat,\r\n      message: '',\r\n      radius: radius ? parseInt(radius, 10) : undefined,\r\n      conf: conf ? parseInt(conf, 10) : undefined\r\n    };\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: 'Coordinate out of Longitude/Latitude bounds',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Convert degrees minutes seconds to dd\r\n * @param degrees Degrees\r\n * @param minutes Minutes\r\n * @param seconds Seconds\r\n * @param direction Direction\r\n */\r\nfunction convertDMSToDD(\r\n  degrees: number,\r\n  minutes: number,\r\n  seconds: number,\r\n  direction: string\r\n) {\r\n  minutes = minutes || 0;\r\n  seconds = seconds || 0;\r\n\r\n  const neg = degrees < 0;\r\n  let dd = Math.abs(degrees) + minutes / 60 + seconds / 3600;\r\n\r\n  if (neg || direction === 'S' || direction === 'W') {\r\n    dd = -dd;\r\n  } // Don't do anything for N or E\r\n  return dd;\r\n}\r\n\r\n/**\r\n * Convert dd to degrees minutes seconds\r\n * @param lonLatDD longitude and latitude in dd\r\n * @param decimal number of decimals for seconds\r\n * @returns longitude and latitude in dms\r\n */\r\nexport function convertDDToDMS(\r\n  lonLatDD: [number, number], decimal: number = 3\r\n): string[] {\r\n  const lonLatDMS = [];\r\n\r\n  lonLatDD.forEach(dd => {\r\n    const degrees = dd < 0 ? Math.ceil(dd) : Math.floor(dd);\r\n    const int = dd < 0 ? (degrees - dd) * 60 : (dd - degrees) * 60;\r\n    const minutes = Math.floor(int);\r\n    const seconds = ((int - minutes) * 60).toFixed(decimal);\r\n\r\n    lonLatDMS.push(`${degrees}° ${minutes}' ${seconds}\"`);\r\n  });\r\n  return lonLatDMS;\r\n}\r\n\r\n/**\r\n * Return true of two view states are equal.\r\n * @param state1 View state\r\n * @param state2 View state\r\n * @returns True if the view states are equal\r\n */\r\nexport function viewStatesAreEqual(\r\n  state1: MapViewState,\r\n  state2: MapViewState\r\n): boolean {\r\n  if (state1 === undefined || state2 === undefined) {\r\n    return false;\r\n  }\r\n\r\n  const tolerance = 1 / 10000;\r\n  return (\r\n    state1.zoom === state2.zoom &&\r\n    Math.trunc(state1.center[0] / tolerance) ===\r\n      Math.trunc(state2.center[0] / tolerance) &&\r\n    Math.trunc(state1.center[1] / tolerance) ===\r\n      Math.trunc(state2.center[1] / tolerance)\r\n  );\r\n}\r\n\r\n/**\r\n * Format the scale to a human readable text\r\n * @param Scale of the map\r\n * @returns Human readable scale text\r\n */\r\nexport function formatScale(scale) {\r\n  scale = Math.round(scale);\r\n  if (scale < 10000) {\r\n    return scale + '';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  if (scale < 1000) {\r\n    return scale + 'K';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  return scale + 'M';\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param scale Scale denom\r\n * @param dpi DPI\r\n * @returns Resolution\r\n */\r\nexport function getResolutionFromScale(\r\n  scale: number,\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return scale / (inchesPerMeter * dpi);\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param Scale denom\r\n * @returns Resolution\r\n */\r\nexport function getScaleFromResolution(\r\n  resolution: number,\r\n  unit: string = 'm',\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return resolution * olproj.METERS_PER_UNIT[unit] * inchesPerMeter * dpi;\r\n}\r\n\r\n/**\r\n * Returns true if the CTRL key is pushed during an Ol MapBrowserPointerEvent\r\n * @param event OL MapBrowserPointerEvent\r\n * @returns Whether the CTRL key is pushed\r\n */\r\nexport function ctrlKeyDown(event: MapBrowserPointerEvent<any>): boolean {\r\n  const originalEvent = event.originalEvent;\r\n  return (\r\n    !originalEvent.altKey &&\r\n    (MAC ? originalEvent.metaKey : originalEvent.ctrlKey) &&\r\n    !originalEvent.shiftKey\r\n  );\r\n}\r\n\r\nexport function roundCoordTo(coord: [number, number], decimal: number = 3): [number, number] {\r\n  return [\r\n    NumberUtils.roundToNDecimal(coord[0], decimal),\r\n    NumberUtils.roundToNDecimal(coord[1], decimal)] as [number, number];\r\n}\r\n\r\nexport function roundCoordToString(coord: [number, number], decimal: number = 3): [string, string]{\r\n    return roundCoordTo(coord, decimal).map(r => r.toString()) as [string, string];\r\n}\r\n\r\n/**\r\n * Returns an array of converted coordinates.\r\n * Conversion is done for every configured projections\r\n * and for the current UTM zone and MTM zone.\r\n * @param lonLat [number, number] array of the coordinate to transform.\r\n * @param projections  Projection[] Array of destination projection.\r\n * @param reverseCoords To reverse coords from latLon to lonLat (search option)\r\n * @returns Returns an array of converted coordinates.\r\n */\r\nexport function lonLatConversion(\r\n  lonLat: [number, number],\r\n  projections: Projection[]\r\n): {\r\n  code: string;\r\n  alias: string;\r\n  coord: [number, number];\r\n  igo2CoordFormat: string;\r\n}[] {\r\n  const rawCoord3857 = olproj.transform(lonLat, 'EPSG:4326', 'EPSG:3857') as [number, number];\r\n  const convertedLonLat = [\r\n    {\r\n      code: 'EPSG:3857',\r\n      alias: 'Web Mercator',\r\n      coord: rawCoord3857,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord3857).join(', ')} ; 3857`\r\n    }\r\n  ];\r\n\r\n  // detect the current utm zone.\r\n  const utmZone = utmZoneFromLonLat(lonLat);\r\n  const epsgUtm = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n  const utmName = `UTM-${utmZone}`;\r\n  const rawCoordUtm = olproj.transform(lonLat, 'EPSG:4326', epsgUtm) as [number, number];\r\n  convertedLonLat.push({\r\n    code: epsgUtm,\r\n    alias: 'UTM',\r\n    coord: rawCoordUtm,\r\n    igo2CoordFormat: `${utmName} ${roundCoordTo(rawCoordUtm).join(', ')}`\r\n  });\r\n\r\n  // detect the current mtm zone.\r\n  const mtmZone = mtmZoneFromLonLat(lonLat);\r\n  if (mtmZone) {\r\n    const epsgMtm =\r\n      mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n    const mtmName = `MTM-${mtmZone}`;\r\n    const rawCoordMtm = olproj.transform(lonLat, 'EPSG:4326', epsgMtm) as [number, number];\r\n    convertedLonLat.push({\r\n      code: epsgMtm,\r\n      alias: 'MTM',\r\n      coord: rawCoordMtm,\r\n      igo2CoordFormat: `${mtmName} ${roundCoordTo(rawCoordMtm).join(', ')}`\r\n    });\r\n  }\r\n\r\n  projections.forEach(projection => {\r\n    const rawCoord = olproj.transform(lonLat, 'EPSG:4326', projection.code) as [number, number];\r\n    const numericEpsgCode = projection.code.split(':')[1];\r\n    convertedLonLat.push({\r\n      code: projection.code,\r\n      alias: projection.alias || projection.code,\r\n      coord: rawCoord,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord).join(', ')} ; ${numericEpsgCode}`\r\n    });\r\n  });\r\n\r\n  return convertedLonLat;\r\n}\r\n\r\n/**\r\n * Detect the current utm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the UTM zone.\r\n * @returns number The UTM zone.\r\n */\r\nexport function utmZoneFromLonLat(lonLat: [number, number]) {\r\n  return Math.ceil((lonLat[0] + 180) / 6);\r\n}\r\n\r\n/**\r\n * Detect the current mtm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the MTM zone.\r\n * @returns number The MTM zone. Undefined if outside of the mtm application zone.\r\n */\r\nexport function mtmZoneFromLonLat(lonLat: [number, number]) {\r\n  const long = lonLat[0];\r\n  let mtmZone;\r\n  if (long < -51 && long > -54) {\r\n    mtmZone = 1;\r\n  }\r\n  if (long < -54 && long > -57) {\r\n    mtmZone = 2;\r\n  }\r\n  if (long < -57 && long > -60) {\r\n    mtmZone = 3;\r\n  }\r\n  if (long < -60 && long > -63) {\r\n    mtmZone = 4;\r\n  }\r\n  if (long < -63 && long > -66) {\r\n    mtmZone = 5;\r\n  }\r\n  if (long < -66 && long > -69) {\r\n    mtmZone = 6;\r\n  }\r\n  if (long < -69 && long > -72) {\r\n    mtmZone = 7;\r\n  }\r\n  if (long < -72 && long > -75) {\r\n    mtmZone = 8;\r\n  }\r\n  if (long < -75 && long > -78) {\r\n    mtmZone = 9;\r\n  }\r\n  if (long < -78 && long > -81) {\r\n    mtmZone = 10;\r\n  }\r\n  return mtmZone;\r\n}\r\n","import {\r\n  BehaviorSubject,\r\n  Observable,\r\n  Subject,\r\n  Subscription,\r\n  combineLatest\r\n} from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { DataSource, Legend } from '../../../datasource';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\n\r\nimport { LayerOptions } from './layer.interface';\r\nimport { Message, MessageService } from '@igo2/core';\r\nimport { GeoDBService } from '../../../offline/geoDB/geoDB.service';\r\nimport { LayerDBService } from '../../../offline/layerDB/layerDB.service';\r\n\r\nexport abstract class Layer {\r\n  public collapsed: boolean;\r\n  public dataSource: DataSource;\r\n  public legend: Legend[];\r\n  public legendCollapsed: boolean = true;\r\n  public firstLoadComponent: boolean = true;\r\n  public map: IgoMap;\r\n  public ol: olLayer<olSource>;\r\n  public olLoadingProblem: boolean = false;\r\n  public status$: Subject<SubjectStatus>;\r\n  public hasBeenVisible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n  private hasBeenVisible$$: Subscription;\r\n  private resolution$$: Subscription;\r\n\r\n  /**\r\n   * Define if a layer is generated by code OR defined by layer/context user layer.\r\n   * Useful for filtering layers list in mapOffline.directive or in the sharemap...\r\n   * return false by default.\r\n   */\r\n  get isIgoInternalLayer(): boolean {\r\n    return this.options.isIgoInternalLayer || false;\r\n  }\r\n\r\n  get id(): string {\r\n    return this.options.id || this.dataSource.id;\r\n  }\r\n\r\n  get alias(): string {\r\n    return this.options.alias;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  set title(title: string) {\r\n    this.options.title = title;\r\n  }\r\n\r\n  get zIndex(): number {\r\n    return this.ol.getZIndex();\r\n  }\r\n\r\n  set zIndex(zIndex: number) {\r\n    this.ol.setZIndex(zIndex);\r\n  }\r\n\r\n  get baseLayer(): boolean {\r\n    return this.options.baseLayer;\r\n  }\r\n\r\n  set baseLayer(baseLayer: boolean) {\r\n    this.options.baseLayer = baseLayer;\r\n  }\r\n\r\n  get opacity(): number {\r\n    return this.ol.get('opacity');\r\n  }\r\n\r\n  set opacity(opacity: number) {\r\n    this.ol.setOpacity(opacity);\r\n  }\r\n\r\n  set isInResolutionsRange(value: boolean) {\r\n    this.isInResolutionsRange$.next(value);\r\n  }\r\n  get isInResolutionsRange(): boolean {\r\n    return this.isInResolutionsRange$.value;\r\n  }\r\n  readonly isInResolutionsRange$: BehaviorSubject<\r\n    boolean\r\n  > = new BehaviorSubject(false);\r\n\r\n  set maxResolution(value: number) {\r\n    this.ol.setMaxResolution(value === 0 ? 0 : value || Infinity);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get maxResolution(): number {\r\n    return this.ol.getMaxResolution();\r\n  }\r\n\r\n  set minResolution(value: number) {\r\n    this.ol.setMinResolution(value || 0);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get minResolution(): number {\r\n    return this.ol.getMinResolution();\r\n  }\r\n\r\n  set visible(value: boolean) {\r\n    this.ol.setVisible(value);\r\n    this.visible$.next(value);\r\n    if (!this.hasBeenVisible$.value && value){\r\n      this.hasBeenVisible$.next(value);\r\n    }\r\n    if (this.options?.messages && value) {\r\n      this.options?.messages\r\n        .filter(m => m.options?.showOnEachLayerVisibility)\r\n        .map(message =>\r\n          this.showMessage(message)\r\n        );\r\n    }\r\n  }\r\n  get visible(): boolean {\r\n    return this.visible$.value;\r\n  }\r\n  readonly visible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  get displayed(): boolean {\r\n    return this.visible && this.isInResolutionsRange;\r\n  }\r\n  readonly displayed$: Observable<boolean> = combineLatest([\r\n    this.isInResolutionsRange$,\r\n    this.visible$\r\n  ]).pipe(map((bunch: [boolean, boolean]) => bunch[0] && bunch[1]));\r\n\r\n  get showInLayerList(): boolean {\r\n    return this.options.showInLayerList !== false;\r\n  }\r\n\r\n\r\n  constructor(\r\n    public options: LayerOptions,\r\n    protected messageService?: MessageService,\r\n    protected authInterceptor?: AuthInterceptor,\r\n    protected geoDBService?: GeoDBService,\r\n    public layerDBService?: LayerDBService\r\n  ) {\r\n    this.dataSource = options.source;\r\n\r\n    this.ol = this.createOlLayer();\r\n    if (options.zIndex !== undefined) {\r\n      this.zIndex = options.zIndex;\r\n    }\r\n\r\n    if (options.baseLayer && options.visible === undefined) {\r\n      options.visible = false;\r\n    }\r\n\r\n    this.maxResolution = options.maxResolution || getResolutionFromScale(Number(options.maxScaleDenom));\r\n    this.minResolution = options.minResolution || getResolutionFromScale(Number(options.minScaleDenom));\r\n\r\n    this.visible = options.visible === undefined ? true : options.visible;\r\n    this.opacity = options.opacity === undefined ? 1 : options.opacity;\r\n\r\n    if (\r\n      options.legendOptions &&\r\n      (options.legendOptions.url || options.legendOptions.html)\r\n    ) {\r\n      this.legend = this.dataSource.setLegend(options.legendOptions);\r\n    }\r\n\r\n    this.legendCollapsed = options.legendOptions\r\n      ? options.legendOptions.collapsed\r\n        ? options.legendOptions.collapsed\r\n        : true\r\n      : true;\r\n\r\n    this.ol.set('_layer', this, true);\r\n  }\r\n\r\n  protected abstract createOlLayer(): olLayer<olSource>;\r\n\r\n  setMap(igoMap: IgoMap | undefined) {\r\n    this.map = igoMap;\r\n\r\n    this.unobserveResolution();\r\n    if (igoMap !== undefined) {\r\n      this.observeResolution();\r\n      this.hasBeenVisible$$ = this.hasBeenVisible$.subscribe(() => {\r\n        if (this.options.messages && this.visible) {\r\n          this.options.messages.map(message => {\r\n            this.showMessage(message);\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private showMessage(message: Message) {\r\n    if (!this.messageService) {\r\n      return;\r\n    }\r\n    message.title = message.title;\r\n    message.text = message.text;\r\n    this.messageService.message(message as Message);\r\n  }\r\n\r\n  private observeResolution() {\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(() =>\r\n      this.updateInResolutionsRange()\r\n    );\r\n  }\r\n\r\n  private unobserveResolution() {\r\n    if (this.resolution$$ !== undefined) {\r\n      this.resolution$$.unsubscribe();\r\n      this.resolution$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private updateInResolutionsRange() {\r\n    if (this.map !== undefined) {\r\n      const resolution = this.map.viewController.getResolution();\r\n      const minResolution = this.minResolution;\r\n      const maxResolution = this.maxResolution === undefined ? Infinity : this.maxResolution;\r\n      this.isInResolutionsRange = resolution >= minResolution && resolution <= maxResolution;\r\n    } else {\r\n      this.isInResolutionsRange = false;\r\n    }\r\n  }\r\n}\r\n","import olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\nimport { Message } from '@igo2/core';\r\n\r\nimport { DataSource } from '../../../datasource/shared/datasources/datasource';\r\nimport { AnyDataSourceOptions } from '../../../datasource/shared/datasources/any-datasource.interface';\r\nimport { MapExtent, MapViewOptions } from '../../../map/shared/map.interface';\r\n\r\nexport interface LayerOptions {\r\n  isIgoInternalLayer?: boolean; // useful when mapOffline directive set the resolution of the layers.\r\n  source?: DataSource;\r\n  sourceOptions?: AnyDataSourceOptions;\r\n  title?: string;\r\n  id?: string;\r\n  alias?: string;\r\n  security?: LayerSecurityOptions;\r\n  baseLayer?: boolean;\r\n  opacity?: number;\r\n  visible?: boolean;\r\n  extent?: MapExtent;\r\n  zIndex?: number;\r\n  messages?: Message[];\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  minScaleDenom?: number;\r\n  maxScaleDenom?: number;\r\n  showInLayerList?: boolean;\r\n  removable?: boolean;\r\n  workspace?: GeoWorkspaceOptions;\r\n  legendOptions?: LegendOptions;\r\n  ol?: olLayer<olSource>;\r\n  tooltip?: TooltipContent;\r\n  _internal?: { [key: string]: string };\r\n  active?: boolean;\r\n  check?: boolean;\r\n  linkedLayers?: LayersLink;\r\n  showButtonZoomToExtent?: boolean;\r\n}\r\n\r\nexport interface LayerSecurityOptions {\r\n  profils?: string[]\r\n}\r\n\r\nexport interface GeoWorkspaceOptions {\r\n  srcId?: string;\r\n  workspaceId?: string;\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  enabled?: boolean;\r\n  queryOptions?: GeoWorkspaceQueryOptions;\r\n  pageSize?: number;\r\n  pageSizeOptions?: number[];\r\n  searchIndexEnabled?: boolean;\r\n}\r\n\r\nexport interface GeoWorkspaceQueryOptions {\r\n  mapQueryOnOpenTab?: boolean;\r\n  tabQuery?: boolean;\r\n}\r\n\r\nexport interface LayersLink {\r\n  linkId: string;\r\n  links?: LayersLinkProperties[];\r\n}\r\nexport interface LayersLinkProperties {\r\n  linkedIds: string[];\r\n  syncedDelete: boolean;\r\n  properties: LinkedProperties[];\r\n}\r\n\r\nexport enum LinkedProperties {\r\n  OPACITY = 'opacity',\r\n  VISIBLE = 'visible',\r\n  OGCFILTERS = 'ogcFilters',\r\n  MINRESOLUTION = 'minResolution',\r\n  MAXRESOLUTION = 'maxResolution',\r\n  ZINDEX = 'zIndex',\r\n  TIMEFILTER = 'timeFilter'\r\n}\r\n\r\nexport interface GroupLayers {\r\n  title: string;\r\n  layers?: LayerOptions;\r\n  collapsed?: boolean;\r\n}\r\n\r\nexport interface TooltipContent {\r\n  type?: TooltipType;\r\n  text?: string;\r\n}\r\nexport enum TooltipType {\r\n  TITLE = 'title',\r\n  ABSTRACT = 'abstract',\r\n  CUSTOM = 'custom'\r\n}\r\n\r\nexport interface LegendOptions {\r\n  collapsed?: boolean;\r\n  display?: boolean;\r\n  url?: string;\r\n  html?: string;\r\n  stylesAvailable?: ItemStyleOptions[];\r\n}\r\n\r\nexport interface LegendMapViewOptions extends MapViewOptions{\r\n  scale?: number;\r\n  size?: [number, number];\r\n}\r\n\r\nexport interface ItemStyleOptions {\r\n  name: string;\r\n  title?: string;\r\n}\r\n\r\nexport interface OutputLayerLegend {\r\n  title: string;\r\n  url: string;\r\n  display: boolean;\r\n  isInResolutionsRange: boolean;\r\n}\r\n","import olSourceImage from 'ol/source/Image';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { MessageService } from '@igo2/core';\r\nimport { ImageLayer } from '../shared/layers/image-layer';\r\n\r\n\r\nexport class ImageWatcher extends Watcher {\r\n  protected id: string;\r\n  protected loaded = 0;\r\n  protected loading = 0;\r\n\r\n  private source: olSourceImage;\r\n\r\n  private messageService: MessageService;\r\n\r\n  constructor(layer: ImageLayer, messageService: MessageService) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n    this.messageService = messageService;\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    if (!event.image.__watchers__) {\r\n      event.image.__watchers__ = [];\r\n    }\r\n    event.image.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.image.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.image.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleLoadError(event) {\r\n\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n    this.messageService.error(\r\n      'igo.geo.dataSource.unavailable',\r\n      'igo.geo.dataSource.unavailableTitle',\r\n      undefined,\r\n      { value: event.target.params_.LAYERS });\r\n    this.loaded = -1;\r\n    this.loading = 0;\r\n    this.status = SubjectStatus.Error;\r\n\r\n  }\r\n}\r\n","import { AnyLayerOptions } from \"../shared/layers/any-layer.interface\";\r\nimport { VectorTileLayerOptions } from \"../shared/layers/vectortile-layer.interface\";\r\n\r\n\r\nexport function computeMVTOptionsOnHover(layerOptions: AnyLayerOptions) {\r\n  const vectorTileLayerOptions = layerOptions as VectorTileLayerOptions;\r\n  if (\r\n    vectorTileLayerOptions.sourceOptions?.type === 'mvt' &&\r\n    (vectorTileLayerOptions.igoStyle?.styleByAttribute?.hoverStyle || vectorTileLayerOptions.igoStyle?.hoverStyle)) {\r\n    const fc = vectorTileLayerOptions.sourceOptions.featureClass;\r\n    vectorTileLayerOptions.sourceOptions.featureClass = fc ? fc : 'feature';\r\n  }\r\n  return layerOptions;\r\n}\r\n","import olSourceTile from 'ol/source/Tile';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { TileLayer } from '../shared/layers/tile-layer';\r\nimport { VectorTileLayer } from '../shared/layers/vectortile-layer';\r\n\r\nexport class TileWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private source: olSourceTile;\r\n\r\n  constructor(layer: TileLayer | VectorTileLayer) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    // This is to avoid increasing\r\n    // the number of loaded tiles if a tile was loading\r\n    // before subscribing to this watcher\r\n    if (!event.tile.__watchers__) {\r\n      event.tile.__watchers__ = [];\r\n    }\r\n    event.tile.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.tile.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.tile.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.tile.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { ArcGISRestDataSourceOptions } from './../datasource/shared/datasources/arcgisrest-datasource.interface';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { AnyDataSourceOptions } from '../datasource/shared/datasources/any-datasource.interface';\r\nimport { DataSourceOptions } from '../datasource/shared/datasources/datasource.interface';\r\nimport { WMSDataSourceOptions } from '../datasource/shared/datasources/wms-datasource.interface';\r\nimport { WMTSDataSourceOptions } from '../datasource/shared/datasources/wmts-datasource.interface';\r\nimport { WFSDataSourceOptions } from '../datasource';\r\n\r\n/**\r\n * Generate a id from it's datasource options.\r\n * @param options Data source options\r\n * @returns A id\r\n */\r\nexport function generateIdFromSourceOptions(options: DataSourceOptions): string {\r\n  const generators = {\r\n    wms: generateWMSIdFromSourceOptions,\r\n    wmts: generateWMTSIdFromSourceOptions,\r\n    xyz: generateXYZIdFromSourceOptions,\r\n    feature: generateFeatureIdFromSourceOptions,\r\n    wfs: generateWfsIdFromSourceOptions,\r\n    arcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    imagearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    tilearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    osm: (_options: AnyDataSourceOptions) => 'OSM',\r\n    tiledebug: (_options: AnyDataSourceOptions) => 'tiledebug'\r\n  };\r\n  const generator = generators[options.type] || generateId;\r\n  return generator(options);\r\n}\r\n\r\n/**\r\n * Generate a id from WMS data source options\r\n * @param options WMS data source options\r\n * @returns A md5 hash of the the url and layers\r\n */\r\nexport function generateWMSIdFromSourceOptions(options: WMSDataSourceOptions) {\r\n  const layers = options.params.LAYERS;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wms' + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from WMTS data source options\r\n * @param options WMTS data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWMTSIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const layer = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wmts' + url + layer;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from XYZ data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateXYZIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'xyz' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateFeatureIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  if (!options.url) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'feature' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWfsIdFromSourceOptions(options: WFSDataSourceOptions) {\r\n  if (!options.url || !options.params) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wfs' + url + options.params.featureTypes;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n/**\r\n * Generate a id from ArcGIS Rest data source options\r\n * @param options ArcGIS Rest data source options\r\n * @returns A md5 hash of the url and layers\r\n */\r\nexport function generateArcgisRestIdFromSourceOptions(options: ArcGISRestDataSourceOptions) {\r\n  const layers = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = (options.type || 'arcgis') + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a unique id\r\n * @returns A uuid\r\n */\r\nexport function generateId(_options: AnyDataSourceOptions) {\r\n  return uuid();\r\n}\r\n\r\nexport function standardizeUrl(url: string): string {\r\n  const absUrl = url.charAt(0) === '/' ? window.location.origin + url : url;\r\n  const urlDecomposed = absUrl.split(/[?&]/);\r\n  let urlStandardized = urlDecomposed.shift();\r\n  const paramsToKeep = urlDecomposed.filter(p => p.length !== 0 && p.charAt(0) !== '_');\r\n  if (paramsToKeep.length) {\r\n    urlStandardized += '?' + paramsToKeep.join('&');\r\n  }\r\n  return urlStandardized;\r\n}\r\n","import olSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  DataSourceOptions,\r\n  Legend\r\n} from './datasource.interface';\r\n\r\nimport { DataService } from './data.service';\r\nimport { generateIdFromSourceOptions } from '../../../utils/id-generator';\r\nimport { LegendMapViewOptions, LegendOptions } from '../../../layer/shared/layers/layer.interface';\r\n\r\nexport abstract class DataSource {\r\n\r\n  public id: string;\r\n  public ol: olSource | olVectorSource<OlGeometry> | olClusterSource ;\r\n  private legend: Legend[];\r\n\r\n  constructor(\r\n    public options: DataSourceOptions = {},\r\n    protected dataService?: DataService\r\n  ) {\r\n    this.options = options;\r\n    this.id = this.options.id || this.generateId();\r\n    this.ol = this.createOlSource();\r\n  }\r\n\r\n  protected abstract createOlSource(): olSource;\r\n\r\n  protected generateId(): string {\r\n    return generateIdFromSourceOptions(this.options);\r\n  }\r\n\r\n  public getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    return this.legend ? this.legend : [];\r\n  }\r\n\r\n  public setLegend(options: LegendOptions): Legend[] {\r\n    if (options.url) {\r\n      this.legend = [{ url: options.url} ];\r\n    } else if (options.html) {\r\n      this.legend = [{ html: options.html} ];\r\n    } else {\r\n      this.legend = [];\r\n    }\r\n\r\n    return this.legend;\r\n  }\r\n\r\n  protected abstract onUnwatch();\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as olformat from 'ol/format';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { FeatureDataSourceOptions } from './feature-datasource.interface';\r\n\r\nexport class FeatureDataSource extends DataSource {\r\n  public options: FeatureDataSourceOptions;\r\n  public ol: olSourceVector<OlGeometry>;\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const sourceOptions = {\r\n      format: this.getSourceFormatFromOptions(this.options)\r\n    };\r\n\r\n    return new olSourceVector(Object.assign(sourceOptions, this.options));\r\n  }\r\n\r\n  protected getSourceFormatFromOptions(options: FeatureDataSourceOptions) {\r\n    if (options.format) {\r\n      return options.format;\r\n    }\r\n    let olFormatCls;\r\n    const formatType = options.formatType;\r\n    if (!formatType) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    } else {\r\n      olFormatCls = olformat[formatType];\r\n      if (olFormatCls === undefined) {\r\n        throw new Error('Invalid vector source format ${formatType}.');\r\n      }\r\n    }\r\n\r\n    const formatOptions = options.formatOptions;\r\n    let format;\r\n    if (formatOptions) {\r\n      format = new olFormatCls(formatOptions);\r\n    } else {\r\n      format = new olFormatCls();\r\n    }\r\n\r\n    return format;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n}\r\n","import olSourceCluster from 'ol/source/Cluster';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { ClusterDataSourceOptions } from './cluster-datasource.interface';\r\n\r\nexport class ClusterDataSource extends FeatureDataSource {\r\n  public options: ClusterDataSourceOptions;\r\n  public ol: olSourceCluster;\r\n\r\n  protected createOlSource(): olSourceCluster {\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    this.options.source = super.createOlSource();\r\n    return new olSourceCluster(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    return uuid();\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { VectorLayer } from '../shared/layers/vector-layer';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\n\r\nexport class VectorWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private layer: VectorLayer;\r\n\r\n  constructor(layer: VectorLayer) {\r\n    super();\r\n    this.layer = layer;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n\r\n    if (olSource.getUrl()) {\r\n      olSource.on(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.on(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.on(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n\r\n  }\r\n\r\n  protected unwatch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n    if (olSource.getUrl()) {\r\n      olSource.un(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.un(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.un(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event: any) {\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import olLayerImage from 'ol/layer/Image';\r\nimport olSourceImage from 'ol/source/Image';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nimport { ImageWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { WMSDataSource } from '../../../datasource/shared/datasources/wms-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { ImageLayerOptions } from './image-layer.interface';\r\nimport { ImageArcGISRestDataSource } from '../../../datasource/shared/datasources/imagearcgisrest-datasource';\r\nimport { MessageService } from '@igo2/core';\r\n\r\nexport class ImageLayer extends Layer {\r\n  public dataSource: WMSDataSource | ImageArcGISRestDataSource;\r\n  public options: ImageLayerOptions;\r\n  public ol: olLayerImage<olSourceImage>;\r\n\r\n  private watcher: ImageWatcher;\r\n\r\n  constructor(\r\n    options: ImageLayerOptions,\r\n    public messageService: MessageService,\r\n    public authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new ImageWatcher(this, this.messageService);\r\n    this.status$ = this.watcher.status$;\r\n    this.status$.subscribe(valStatus => {\r\n      if (valStatus === 0) {\r\n        this.olLoadingProblem = true;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected createOlLayer(): olLayerImage<olSourceImage> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceImage\r\n    });\r\n\r\n    const image = new olLayerImage(olOptions);\r\n    if (this.authInterceptor) {\r\n      (image.getSource() as any).setImageLoadFunction((tile, src) => {\r\n        this.customLoader(tile, src, this.authInterceptor, this.messageService);\r\n      });\r\n    }\r\n\r\n    return image;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  private customLoader(tile, src: string, interceptor: AuthInterceptor, messageService: MessageService) {\r\n    const xhr = new XMLHttpRequest();\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(src);\r\n    let url = src;\r\n    if (alteredUrlWithKeyAuth) {\r\n      url = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', url);\r\n    const intercepted = interceptor.interceptXhr(xhr, url);\r\n    if (!intercepted) {\r\n      xhr.abort();\r\n      tile.getImage().src = url;\r\n      return;\r\n    }\r\n\r\n    xhr.responseType = 'arraybuffer';\r\n\r\n    xhr.onload = function() {\r\n      const arrayBufferView = new Uint8Array((this as any).response);\r\n      const responseString = new TextDecoder().decode(arrayBufferView);\r\n      if (responseString.includes('ServiceExceptionReport')) {\r\n        messageService.error('igo.geo.dataSource.optionsApiUnavailable','igo.geo.dataSource.unavailableTitle');\r\n      }\r\n      const blob = new Blob([arrayBufferView], { type: 'image/png' });\r\n      const urlCreator = window.URL;\r\n      const imageUrl = urlCreator.createObjectURL(blob);\r\n      tile.getImage().src = imageUrl;\r\n    };\r\n    xhr.send();\r\n  }\r\n}\r\n","import olLayerTile from 'ol/layer/Tile';\r\nimport olSourceTile from 'ol/source/Tile';\r\nimport Tile from 'ol/Tile';\r\n\r\nimport { TileWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { OSMDataSource } from '../../../datasource/shared/datasources/osm-datasource';\r\nimport { WMTSDataSource } from '../../../datasource/shared/datasources/wmts-datasource';\r\nimport { XYZDataSource } from '../../../datasource/shared/datasources/xyz-datasource';\r\nimport { CartoDataSource } from '../../../datasource/shared/datasources/carto-datasource';\r\nimport { TileArcGISRestDataSource } from '../../../datasource/shared/datasources/tilearcgisrest-datasource';\r\nimport { TileDebugDataSource } from '../../../datasource/shared/datasources/tiledebug-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { TileLayerOptions } from './tile-layer.interface';\r\n\r\nimport { MessageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nexport class TileLayer extends Layer {\r\n  public dataSource:\r\n    | OSMDataSource\r\n    | WMTSDataSource\r\n    | XYZDataSource\r\n    | TileDebugDataSource\r\n    | CartoDataSource\r\n    | TileArcGISRestDataSource;\r\n  public options: TileLayerOptions;\r\n  public ol: olLayerTile<olSourceTile>;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: TileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService);\r\n\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerTile<olSourceTile> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol\r\n    });\r\n    const tileLayer = new olLayerTile(olOptions);\r\n    const tileSource = tileLayer.getSource();\r\n    tileSource.setTileLoadFunction((tile: Tile, url: string) => {\r\n      this.customLoader(tile, url, this.authInterceptor);\r\n    });\r\n\r\n    return tileLayer;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for tile layer.\r\n   * @internal\r\n   * @param tile the current tile\r\n   * @param url the url string or function to retrieve the data\r\n   */\r\n  customLoader(tile, url: string, interceptor: AuthInterceptor ) {\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    tile.getImage().src = modifiedUrl;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","export enum OgcFilterOperatorType {\r\n    BasicNumericOperator = 'basicnumericoperator',\r\n    Basic = 'basic',\r\n    BasicAndSpatial = 'basicandspatial',\r\n    Spatial = 'spatial',\r\n    All = 'all',\r\n    Time = 'time'\r\n}\r\n\r\nexport enum OgcFilterOperator {\r\n    BBOX = 'BBox',\r\n    PropertyIsBetween = 'PropertyIsBetween',\r\n    Contains = 'Contains',\r\n    During = 'During',\r\n    PropertyIsEqualTo = 'PropertyIsEqualTo',\r\n    PropertyIsGreaterThan = 'PropertyIsGreaterThan',\r\n    PropertyIsGreaterThanOrEqualTo = 'PropertyIsGreaterThanOrEqualTo',\r\n    Intersects = 'Intersects',\r\n    PropertyIsNull = 'PropertyIsNull',\r\n    PropertyIsLessThan = 'PropertyIsLessThan',\r\n    PropertyIsLessThanOrEqualTo = 'PropertyIsLessThanOrEqualTo',\r\n    PropertyIsLike = 'PropertyIsLike',\r\n    PropertyIsNotEqualTo = 'PropertyIsNotEqualTo',\r\n    Within = 'Within',\r\n    And = 'And',\r\n    Or = 'Or',\r\n    Not = 'Not'\r\n}\r\n","import * as olfilter from 'ol/format/filter';\r\nimport olFormatWKT from 'ol/format/WKT';\r\nimport olFormatWFS, { WriteGetFeatureOptions } from 'ol/format/WFS';\r\nimport olGeometry from 'ol/geom/Geometry';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\n\r\nimport {\r\n  OgcFilter,\r\n  IgoOgcFilterObject,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcInterfaceFilterOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFiltersOptions,\r\n  IgoOgcSelector,\r\n  SelectorGroup,\r\n  OgcSelectorBundle\r\n} from './ogc-filter.interface';\r\nimport { OgcFilterOperatorType, OgcFilterOperator } from './ogc-filter.enum';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { default as moment } from 'moment';\r\nexport class OgcFilterWriter {\r\n  private filterSequence: OgcInterfaceFilterOptions[] = [];\r\n  public operators = {\r\n    [OgcFilterOperator.PropertyIsEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsNotEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsLike as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['string']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsBetween as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.During as string]: { spatial: false, fieldRestrict: [] },\r\n    [OgcFilterOperator.PropertyIsNull as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Intersects as string]: {\r\n      spatial: true,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Within as string]: { spatial: true, fieldRestrict: [] },\r\n    [OgcFilterOperator.Contains as string]: { spatial: true, fieldRestrict: [] }\r\n  };\r\n\r\n  defineOgcFiltersDefaultOptions(\r\n    ogcFiltersOptions: OgcFiltersOptions,\r\n    fieldNameGeometry: string,\r\n    srcType?: string\r\n  ): OgcFiltersOptions {\r\n    let ogcFiltersDefaultValue = true; // default values for wfs.\r\n    if (srcType && srcType === 'wms') {\r\n      ogcFiltersDefaultValue = false;\r\n    }\r\n\r\n    ogcFiltersOptions = ogcFiltersOptions || {};\r\n    ogcFiltersOptions.enabled =\r\n      ogcFiltersOptions.enabled === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.enabled;\r\n    ogcFiltersOptions.editable =\r\n      ogcFiltersOptions.editable === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.editable;\r\n    ogcFiltersOptions.geometryName = fieldNameGeometry;\r\n\r\n    ogcFiltersOptions.advancedOgcFilters = true;\r\n    if (ogcFiltersOptions.enabled && (ogcFiltersOptions.pushButtons || ogcFiltersOptions.checkboxes\r\n      || ogcFiltersOptions.radioButtons || ogcFiltersOptions.select || ogcFiltersOptions.autocomplete)) {\r\n      ogcFiltersOptions.advancedOgcFilters = false;\r\n    }\r\n    return ogcFiltersOptions;\r\n  }\r\n\r\n  public buildFilter(\r\n    filters?: IgoOgcFilterObject,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection,\r\n    fieldNameGeometry?: string,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): string {\r\n    let ourBboxFilter;\r\n    let enableBbox: boolean;\r\n    if (/intersects|contains|within/gi.test(JSON.stringify(filters))) {\r\n      enableBbox = false;\r\n    } else {\r\n      enableBbox = true;\r\n    }\r\n    if (filters) {\r\n      fieldNameGeometry =\r\n        (filters as any).geometryName !== undefined\r\n          ? (filters as any).geometryName\r\n          : fieldNameGeometry;\r\n    }\r\n    if (extent && filters) {\r\n      ourBboxFilter = olfilter.bbox(fieldNameGeometry, extent, proj.getCode());\r\n    }\r\n    let filterAssembly: OgcFilter;\r\n    if (filters) {\r\n      filters = this.checkIgoFiltersProperties(\r\n        filters,\r\n        fieldNameGeometry,\r\n        proj\r\n      );\r\n      if (extent && enableBbox) {\r\n        filterAssembly = olfilter.and(\r\n          ourBboxFilter,\r\n          this.bundleFilter(filters, options)\r\n        );\r\n      } else {\r\n        filterAssembly = this.bundleFilter(filters, options);\r\n      }\r\n    } else {\r\n      return 'bbox=' + extent.join(',') + ',' + proj.getCode();\r\n    }\r\n\r\n    const wfsOptions: WriteGetFeatureOptions = {\r\n      srsName: '',\r\n      featureNS: '',\r\n      featurePrefix: '',\r\n      featureTypes: ['featureTypes'],\r\n      filter: filterAssembly,\r\n      outputFormat: '',\r\n      geometryName: fieldNameGeometry\r\n    };\r\n\r\n    const query = new olFormatWFS().writeGetFeature(wfsOptions);\r\n    const str = new XMLSerializer().serializeToString(query);\r\n    const regexp1 = /typenames *=|typename *=\\\"featureTypes\\\" *>/gi;\r\n    const regexp2 = /<\\/Query><\\/GetFeature>/gi;\r\n\r\n    return 'filter=' + str.split(regexp1)[1].split(regexp2)[0];\r\n  }\r\n\r\n  private bundleFilter(\r\n    filterObject: any,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ) {\r\n    if (filterObject instanceof Array) {\r\n      const logicalArray = [];\r\n      filterObject.forEach((element) => {\r\n        logicalArray.push(this.bundleFilter(element, options));\r\n      });\r\n      return logicalArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return this.createFilter(\r\n          {\r\n            operator: filterObject.logical,\r\n            logicalArray: this.bundleFilter(filterObject.filters, options)\r\n          },\r\n          options\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.createFilter(\r\n          filterObject as AnyBaseOgcFilterOptions,\r\n          options\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private createFilter(\r\n    filterOptions,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): OgcFilter {\r\n    const operator = filterOptions.operator;\r\n    const logicalArray = filterOptions.logicalArray;\r\n\r\n    const wfsPropertyName = filterOptions.propertyName;\r\n    const wfsPattern = filterOptions.pattern;\r\n    const wfsMatchCase = filterOptions.matchCase\r\n      ? filterOptions.matchCase\r\n      : true;\r\n    const wfsWildCard = filterOptions.wildCard ? filterOptions.wildCard : '*';\r\n    const wfsSingleChar = filterOptions.singleChar\r\n      ? filterOptions.singleChar\r\n      : '.';\r\n    const wfsEscapeChar = filterOptions.escapeChar\r\n      ? filterOptions.escapeChar\r\n      : '!';\r\n\r\n    const wfsLowerBoundary = filterOptions.lowerBoundary;\r\n    const wfsUpperBoundary = filterOptions.upperBoundary;\r\n\r\n    const wfsGeometryName = filterOptions.geometryName;\r\n    const wfsExtent = filterOptions.extent;\r\n    const wfsWktGeometry = filterOptions.wkt_geometry;\r\n    const wfsSrsName = filterOptions.srsName\r\n      ? filterOptions.srsName\r\n      : 'EPSG:3857';\r\n\r\n    const wfsBegin = this.parseFilterOptionDate(\r\n      filterOptions.begin,\r\n      options ? options.minDate : undefined\r\n    );\r\n    const wfsEnd = this.parseFilterOptionDate(\r\n      filterOptions.end,\r\n      options ? options.maxDate : undefined\r\n    );\r\n\r\n    const wfsExpression = filterOptions.expression;\r\n\r\n    let geometry: olGeometry;\r\n    if (wfsWktGeometry) {\r\n      const wkt = new olFormatWKT();\r\n      geometry = wkt.readGeometry(wfsWktGeometry, {\r\n        dataProjection: wfsSrsName,\r\n        featureProjection: wfsSrsName || 'EPSG:3857'\r\n      });\r\n    }\r\n\r\n    switch (operator.toLowerCase()) {\r\n      case OgcFilterOperator.BBOX.toLowerCase():\r\n        return olfilter.bbox(wfsGeometryName, wfsExtent, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsBetween.toLowerCase():\r\n        return olfilter.between(\r\n          wfsPropertyName,\r\n          wfsLowerBoundary || 1e40*-1,\r\n          wfsUpperBoundary || 1e40\r\n        );\r\n      case OgcFilterOperator.Contains.toLowerCase():\r\n        return olfilter.contains(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.During.toLowerCase():\r\n        return olfilter.during(wfsPropertyName, wfsBegin, wfsEnd);\r\n      case OgcFilterOperator.PropertyIsEqualTo.toLowerCase():\r\n        return olfilter.equalTo(wfsPropertyName, wfsExpression, wfsMatchCase);\r\n      case OgcFilterOperator.PropertyIsGreaterThan.toLowerCase():\r\n        return olfilter.greaterThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo.toLowerCase():\r\n        return olfilter.greaterThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.Intersects.toLowerCase():\r\n        return olfilter.intersects(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsNull.toLowerCase():\r\n        return olfilter.isNull(wfsPropertyName);\r\n      case OgcFilterOperator.PropertyIsLessThan.toLowerCase():\r\n        return olfilter.lessThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo.toLowerCase():\r\n        return olfilter.lessThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLike.toLowerCase():\r\n        return olfilter.like(\r\n          wfsPropertyName,\r\n          wfsPattern ? wfsPattern.replace(/[()_]/gi, wfsSingleChar): wfsWildCard,\r\n          wfsWildCard,\r\n          wfsSingleChar,\r\n          wfsEscapeChar,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.PropertyIsNotEqualTo.toLowerCase():\r\n        return olfilter.notEqualTo(\r\n          wfsPropertyName,\r\n          wfsExpression,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.Within.toLowerCase():\r\n        return olfilter.within(wfsGeometryName, geometry, wfsSrsName);\r\n      // LOGICAL\r\n      case OgcFilterOperator.And.toLowerCase():\r\n        return olfilter.and.apply(null, logicalArray);\r\n      case OgcFilterOperator.Or.toLowerCase():\r\n        return olfilter.or.apply(null, logicalArray);\r\n      case OgcFilterOperator.Not.toLowerCase():\r\n        return olfilter.not.apply(null, logicalArray);\r\n\r\n      default:\r\n        return undefined;\r\n    }\r\n  }\r\n\r\n  public defineInterfaceFilterSequence(\r\n    filterObject: any,\r\n    geometryName,\r\n    logical = '',\r\n    level = -1\r\n  ): OgcInterfaceFilterOptions[] {\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            element,\r\n            geometryName,\r\n            logical,\r\n            level\r\n          )\r\n        );\r\n      });\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        level = level + 1;\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            filterObject.filters,\r\n            geometryName,\r\n            filterObject.logical,\r\n            level\r\n          )\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        this.filterSequence.push(\r\n          this.addInterfaceFilter(filterObject, geometryName, level, logical)\r\n        );\r\n      }\r\n    }\r\n    return this.filterSequence;\r\n  }\r\n\r\n  public computeAllowedOperators(\r\n    fields?: SourceFieldsOptionsParams[],\r\n    propertyName?: string,\r\n    defaultOperatorsType?: OgcFilterOperatorType\r\n  ) {\r\n    let effectiveOperators: {} = {};\r\n    let allowedOperators;\r\n    let fieldsHasSpatialOperator: boolean;\r\n    let includeContains: boolean;\r\n\r\n    if (fields && propertyName) {\r\n      const srcField = fields.find((field) => field.name === propertyName);\r\n      allowedOperators =\r\n        srcField && srcField.allowedOperatorsType\r\n          ? srcField.allowedOperatorsType\r\n          : defaultOperatorsType;\r\n    }\r\n\r\n    if (fields) {\r\n      fields.map((field) => {\r\n        if (!field.allowedOperatorsType) {\r\n          return;\r\n        }\r\n        const allowedOperatorsType = field.allowedOperatorsType.toLowerCase();\r\n        if (\r\n          allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.Spatial.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.BasicAndSpatial.toLowerCase()\r\n        ) {\r\n          fieldsHasSpatialOperator = true;\r\n          if (\r\n            allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase()\r\n          ) {\r\n            includeContains = true;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    allowedOperators = allowedOperators\r\n      ? allowedOperators\r\n      : OgcFilterOperatorType.BasicAndSpatial;\r\n\r\n    switch (allowedOperators.toLowerCase()) {\r\n      case OgcFilterOperatorType.All:\r\n        effectiveOperators = this.operators;\r\n        break;\r\n      case OgcFilterOperatorType.Spatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicAndSpatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Basic:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Time:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.During]: { spatial: false, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicNumericOperator:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          }\r\n        };\r\n        break;\r\n      default:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n    }\r\n\r\n    if (fieldsHasSpatialOperator) {\r\n      (effectiveOperators as any).Intersects = {\r\n        spatial: true,\r\n        fieldRestrict: []\r\n      };\r\n      (effectiveOperators as any).Within = { spatial: true, fieldRestrict: [] };\r\n      if (includeContains) {\r\n        (effectiveOperators as any).Contains = {\r\n          spatial: true,\r\n          fieldRestrict: []\r\n        };\r\n      }\r\n    }\r\n\r\n    return effectiveOperators;\r\n  }\r\n\r\n  public addInterfaceFilter(\r\n    igoOgcFilterObject?,\r\n    geometryName?,\r\n    level = 0,\r\n    parentLogical = 'Or'\r\n  ): OgcInterfaceFilterOptions {\r\n    if (!igoOgcFilterObject) {\r\n      igoOgcFilterObject = { operator: 'PropertyIsEqualTo' };\r\n    }\r\n    const f = {\r\n      propertyName: '',\r\n      operator: '',\r\n      active: '',\r\n      filterid: uuid(),\r\n      step: '',\r\n      begin: '',\r\n      end: '',\r\n      sliderOptions: {},\r\n      lowerBoundary: '',\r\n      upperBoundary: '',\r\n      expression: '',\r\n      pattern: '',\r\n      wildCard: '*',\r\n      singleChar: '.',\r\n      escapeChar: '!',\r\n      matchCase: true,\r\n      igoSpatialSelector: '',\r\n      igoSNRC: '',\r\n      geometryName: '',\r\n      geometry: '',\r\n      wkt_geometry: '',\r\n      extent: '',\r\n      srsName: '',\r\n      parentLogical: '',\r\n      level: 0\r\n    };\r\n\r\n    return Object.assign(\r\n      f,\r\n      {\r\n        parentLogical,\r\n        level,\r\n        geometryName\r\n      },\r\n      igoOgcFilterObject\r\n    );\r\n  }\r\n\r\n  public checkIgoFiltersProperties(\r\n    filterObject: any,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterArray = [];\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        filterArray.push(\r\n          this.checkIgoFiltersProperties(\r\n            element,\r\n            fieldNameGeometry,\r\n            proj,\r\n            active\r\n          )\r\n        );\r\n      });\r\n      return filterArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return Object.assign(\r\n          {},\r\n          {\r\n            logical: filterObject.logical,\r\n            filters: this.checkIgoFiltersProperties(\r\n              filterObject.filters,\r\n              fieldNameGeometry,\r\n              proj,\r\n              active\r\n            )\r\n          }\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.addFilterProperties(\r\n          filterObject as OgcInterfaceFilterOptions,\r\n          fieldNameGeometry,\r\n          proj,\r\n          active\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private addFilterProperties(\r\n    igoOgcFilterObject: OgcInterfaceFilterOptions,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterid = igoOgcFilterObject.hasOwnProperty('filterid')\r\n      ? igoOgcFilterObject.filterid\r\n      : uuid();\r\n    const status = igoOgcFilterObject.hasOwnProperty('active')\r\n      ? igoOgcFilterObject.active\r\n      : active;\r\n\r\n    const srsName = igoOgcFilterObject.hasOwnProperty('srsName')\r\n      ? igoOgcFilterObject.srsName\r\n      : proj\r\n      ? proj.getCode()\r\n      : 'EPSG:3857';\r\n\r\n    return Object.assign(\r\n      {},\r\n      {\r\n        filterid,\r\n        active: status,\r\n        igoSpatialSelector: 'fixedExtent',\r\n        srsName\r\n      },\r\n      igoOgcFilterObject,\r\n      { geometryName: fieldNameGeometry }\r\n    );\r\n  }\r\n\r\n  public rebuiltIgoOgcFilterObjectFromSequence(\r\n    sequence: OgcInterfaceFilterOptions[]\r\n  ): IgoOgcFilterObject {\r\n    if (sequence instanceof Array) {\r\n      if (sequence.length >= 1) {\r\n        let lastParentLogical = sequence[0].parentLogical;\r\n        let nextElement: any;\r\n        let logicalArray = [];\r\n        let lastProcessedFilter;\r\n        sequence.forEach((uiFilter) => {\r\n          const element = Object.assign({}, uiFilter);\r\n          const index = sequence.indexOf(uiFilter);\r\n          if (index >= 0 && index < sequence.length - 1) {\r\n            nextElement = sequence[index + 1];\r\n          } else {\r\n            nextElement = element;\r\n          }\r\n          delete element.active;\r\n          delete element.filterid;\r\n          delete element.parentLogical;\r\n          logicalArray.push(element);\r\n\r\n          if (sequence.length === 1) {\r\n            lastProcessedFilter = element;\r\n          } else if (lastParentLogical !== nextElement.parentLogical) {\r\n            if (logicalArray.length === 1) {\r\n              console.log(\r\n                'You must set at ' +\r\n                  'least two operator in a logical (' +\r\n                  lastParentLogical +\r\n                  ')'\r\n              );\r\n            } else {\r\n              lastProcessedFilter = Object.assign(\r\n                {},\r\n                { logical: lastParentLogical, filters: logicalArray }\r\n              );\r\n              logicalArray = [lastProcessedFilter];\r\n              lastParentLogical = nextElement.parentLogical;\r\n            }\r\n          }\r\n        });\r\n        return lastProcessedFilter;\r\n      } else {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  private computeIgoSelector(selectors: IgoOgcSelector): IgoOgcSelector {\r\n    if (\r\n      selectors.groups.every((group) => group.computedSelectors !== undefined)\r\n    ) {\r\n      return selectors;\r\n    }\r\n    let selector: IgoOgcSelector;\r\n    if (selectors.groups && selectors.bundles) {\r\n      if (!selectors.bundles.every((bundle) => bundle.id !== undefined)) {\r\n        throw new Error(\r\n          'You must set an id for each of your bundles'\r\n        );\r\n      }\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups.forEach((group) => {\r\n        group.title = group.title ? group.title : group.name;\r\n        group.enabled = group.enabled ? group.enabled : false;\r\n        group.computedSelectors = ObjectUtils.copyDeep(\r\n          selector.bundles.filter((b) => group.ids.includes(b.id))\r\n        );\r\n      });\r\n    } else if (!selectors.groups && selectors.bundles) {\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups = [\r\n        {\r\n          title: 'group1',\r\n          name: 'group1',\r\n          computedSelectors: ObjectUtils.copyDeep(selector.bundles)\r\n        } as SelectorGroup\r\n      ];\r\n    } else {\r\n      selector = {\r\n        bundles: selectors as any,\r\n        groups: [\r\n          {\r\n            title: 'group1',\r\n            name: 'group1',\r\n            computedSelectors: ObjectUtils.copyDeep(\r\n              selectors\r\n            ) as OgcSelectorBundle[]\r\n          } as SelectorGroup\r\n        ],\r\n        selectorType: selector.selectorType\r\n      };\r\n    }\r\n    if (!selector.groups.find((selectorGroup) => selectorGroup.enabled)) {\r\n      selector.groups[0].enabled = true;\r\n    }\r\n    return selector;\r\n  }\r\n\r\n  public handleOgcFiltersAppliedValue(\r\n    options: OgcFilterableDataSourceOptions,\r\n    fieldNameGeometry: string,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection\r\n  ): string {\r\n    const ogcFilters = options.ogcFilters;\r\n    if (!ogcFilters) {\r\n      return;\r\n    }\r\n    const conditions = [];\r\n    let filterQueryStringSelector = '';\r\n    let filterQueryStringAdvancedFilters = '';\r\n    if (ogcFilters.enabled && (ogcFilters.pushButtons || ogcFilters.checkboxes || ogcFilters.radioButtons || ogcFilters.select\r\n      || ogcFilters.autocomplete)) {\r\n      let selectors;\r\n      if (ogcFilters.pushButtons) {\r\n        selectors = ogcFilters.pushButtons;\r\n        const pushConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of pushConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.checkboxes) {\r\n        selectors = ogcFilters.checkboxes;\r\n        const checkboxConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of checkboxConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.radioButtons) {\r\n        selectors = ogcFilters.radioButtons;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const radioConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of radioConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.select) {\r\n        selectors = ogcFilters.select;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.autocomplete) {\r\n        selectors = ogcFilters.autocomplete;\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n\r\n      if (conditions.length >= 1) {\r\n        filterQueryStringSelector = this.buildFilter(\r\n          conditions.length === 1\r\n            ? conditions[0]\r\n            : { logical: 'And', filters: conditions },\r\n          extent,\r\n          proj,\r\n          ogcFilters.geometryName\r\n        );\r\n      }\r\n    }\r\n    if (ogcFilters.enabled && ogcFilters.filters) {\r\n      ogcFilters.geometryName = ogcFilters.geometryName || fieldNameGeometry;\r\n      const igoFilters = ogcFilters.filters;\r\n      filterQueryStringAdvancedFilters = this.buildFilter(\r\n        igoFilters,\r\n        extent,\r\n        proj,\r\n        ogcFilters.geometryName,\r\n        options\r\n      );\r\n    }\r\n\r\n    let filterQueryString = ogcFilters.advancedOgcFilters\r\n      ? filterQueryStringAdvancedFilters\r\n      : filterQueryStringSelector;\r\n    if (options.type === 'wms') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.LAYERS\r\n      );\r\n    }\r\n    if (options.type === 'wfs') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.featureTypes\r\n      );\r\n    }\r\n\r\n    return filterQueryString;\r\n  }\r\n\r\n  public verifyMultipleEnableds(selectors) {\r\n    selectors.bundles.forEach(bundle => {\r\n      if (!bundle.multiple && bundle.selectors) {\r\n        const enableds = bundle.selectors.reduce((list, filter, index) => (filter.enabled) === true ? list.concat(index) : list, []);\r\n        if (enableds.length > 1) {\r\n          enableds.splice(0, 1);\r\n          enableds.forEach(index => {\r\n            bundle.selectors[index].enabled = false;\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return selectors;\r\n  }\r\n\r\n  public formatGroupAndFilter(ogcFilters: OgcFiltersOptions, selectors) {\r\n    selectors = this.computeIgoSelector(\r\n      selectors\r\n    );\r\n    const selectorBundle = selectors.groups.find(\r\n      (g) => g.enabled\r\n    ).computedSelectors;\r\n    const conditions = [];\r\n    selectorBundle.map((bundle) => {\r\n      const bundleCondition = [];\r\n      const selectorsType = bundle.selectors as any;\r\n      if (!selectorsType) {\r\n        return;\r\n      }\r\n      selectorsType\r\n        .filter((ogcselector) => ogcselector.enabled === true)\r\n        .forEach((enabledSelector) => bundleCondition.push(enabledSelector.filters));\r\n      if (bundleCondition.length === 1) {\r\n        conditions.push(bundleCondition[0]);\r\n      } else if (bundleCondition.length > 1) {\r\n        conditions.push({\r\n          logical: bundle.logical,\r\n          filters: bundleCondition\r\n        });\r\n      }\r\n    });\r\n\r\n    if (selectors.selectorType === 'pushButton') {\r\n      ogcFilters.pushButtons = selectors;\r\n    } else if (selectors.selectorType === 'checkbox') {\r\n      ogcFilters.checkboxes = selectors;\r\n    } else if (selectors.selectorType === 'radioButton') {\r\n      ogcFilters.radioButtons = selectors;\r\n    } else if (selectors.selectorType === 'select') {\r\n      ogcFilters.select = selectors;\r\n    } else if (selectors.selectorType === 'autocomplete') {\r\n      ogcFilters.autocomplete = selectors;\r\n    }\r\n    return conditions;\r\n  }\r\n\r\n  public formatProcessedOgcFilter(\r\n    processedFilter: string,\r\n    layersOrTypenames: string\r\n  ): string {\r\n\r\n    if (!processedFilter) {return undefined;};\r\n    let appliedFilter = '';\r\n    if (processedFilter.length === 0 && layersOrTypenames.indexOf(',') === -1) {\r\n      appliedFilter = processedFilter;\r\n    } else {\r\n      layersOrTypenames.split(',').forEach((layerOrTypenames) => {\r\n        appliedFilter = `${appliedFilter}(${processedFilter.replace(\r\n          'filter=',\r\n          ''\r\n        )})`;\r\n      });\r\n    }\r\n    appliedFilter = appliedFilter.replace(/\\(\\)/g, '');\r\n    const filterValue =\r\n      appliedFilter.length > 0\r\n        ? appliedFilter.replace('filter=', '')\r\n        : undefined;\r\n    return filterValue;\r\n  }\r\n\r\n  public parseFilterOptionDate(value: string, defaultValue?: string): string {\r\n    if (!value) {\r\n      return defaultValue;\r\n    } else if (value === 'today') {\r\n      return undefined;\r\n    } else if (moment(value).isValid()) {\r\n      return value;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n}\r\n","import { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\n\r\nimport * as OlFormat from 'ol/format';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatGML32 from 'ol/format/GML32';\r\nimport olFormatOSMXML from 'ol/format/OSMXML';\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nexport const defaultEpsg = 'EPSG:3857';\r\nexport const defaultMaxFeatures = 5000;\r\nexport const defaultWfsVersion = '2.0.0';\r\nexport const defaultFieldNameGeometry = 'geometry';\r\nexport const gmlRegex = new RegExp(/(.*)?gml(.*)?/gi);\r\nexport const jsonRegex = new RegExp(/(.*)?json(.*)?/gi);\r\n\r\n\r\n/**\r\n * This method build the WFS URL based on the layer property.\r\n * @param options  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param extent  An extent like array [number, number, number, number]\r\n * @param proj  olProjection\r\n * @param ogcFilters  OgcFiltersOptions\r\n * @returns A string representing the datasource options, based on filter and views\r\n */\r\nexport function buildUrl(\r\n  options: WFSDataSourceOptions,\r\n  extent,\r\n  proj: olProjection,\r\n  ogcFilters: OgcFiltersOptions,\r\n  randomParam?: boolean): string {\r\n  const paramsWFS = options.paramsWFS;\r\n  const queryStringValues = formatWFSQueryString(options, undefined, options.paramsWFS.srsName);\r\n  let igoFilters;\r\n  if (ogcFilters && ogcFilters.enabled) {\r\n    igoFilters = ogcFilters.filters;\r\n  }\r\n  const ogcFilterWriter = new OgcFilterWriter();\r\n  const filterOrBox = ogcFilterWriter.buildFilter(igoFilters, extent, proj, ogcFilters.geometryName, options);\r\n  let filterOrPush = ogcFilterWriter.handleOgcFiltersAppliedValue(options, ogcFilters.geometryName, extent, proj);\r\n\r\n  let prefix = 'filter';\r\n  if (!filterOrPush) {\r\n    prefix = 'bbox';\r\n    filterOrPush = extent.join(',') + ',' + proj.getCode();\r\n  }\r\n\r\n  paramsWFS.xmlFilter = ogcFilters.advancedOgcFilters ? filterOrBox : `${prefix}=${filterOrPush}`;\r\n  let baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n  const patternFilter = /(filter|bbox)=.*/gi;\r\n  baseUrl = patternFilter.test(paramsWFS.xmlFilter) ? `${baseUrl}&${paramsWFS.xmlFilter}` : baseUrl;\r\n  options.download = Object.assign({}, options.download, { dynamicUrl: baseUrl });\r\n  if (randomParam) {\r\n    baseUrl += `$&_t${new Date().getTime()}`;\r\n  }\r\n  return baseUrl.replace(/&&/g, '&');\r\n}\r\n\r\n\r\n/**\r\n * This method build/standardize WFS call query params based on the layer property.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param count  Number: Used to control the number of feature. Used to bypass whe wfs datasource options interface (maxFeatures)\r\n * @param epsg  String: Used to control the EPSG code (es: 'EPSG3857'). Used to bypass whe wfs datasource options interface (srsName)\r\n * @param properties  String: Used to control the queried fields  (WFS service).\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function formatWFSQueryString(\r\n  dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n  count?: number,\r\n  epsg?: string,\r\n  properties?: string,\r\n  startIndex: number = 0,\r\n  forceDefaultOutputFormat: boolean = false\r\n): { name: string; value: string }[] {\r\n  const versionWfs200 = '2.0.0'; // not the same usage as defaultWfsVersion.\r\n  const url = dataSourceOptions.urlWfs;\r\n  const paramsWFS = dataSourceOptions.paramsWFS;\r\n  const effectiveCount = count || defaultMaxFeatures;\r\n  const effectiveStartIndex = paramsWFS.version === versionWfs200 ? `startIndex=${startIndex}` : '';\r\n  const epsgCode = epsg || defaultEpsg;\r\n  let outputFormat = paramsWFS.outputFormat\r\n    ? `outputFormat=${paramsWFS.outputFormat}`\r\n    : '';\r\n  let version = paramsWFS.version\r\n    ? `version=${paramsWFS.version}`\r\n    : `version=${defaultWfsVersion}`;\r\n  const paramTypename =\r\n    paramsWFS.version === versionWfs200 ? 'typenames' : 'typename';\r\n  const featureTypes = `${paramTypename}=${paramsWFS.featureTypes}`;\r\n  const paramMaxFeatures =\r\n    paramsWFS.version === versionWfs200 ? 'count' : 'maxFeatures';\r\n  let cnt = count\r\n    ? `${paramMaxFeatures}=${effectiveCount}`\r\n    : paramsWFS.maxFeatures\r\n    ? `${paramMaxFeatures}=${paramsWFS.maxFeatures}`\r\n    : `${paramMaxFeatures}=${effectiveCount}`;\r\n  if (forceDefaultOutputFormat) {\r\n      outputFormat = '';\r\n      version = 'version=1.1.0';\r\n      cnt = cnt.replace('count', 'maxFeatures');\r\n    }\r\n\r\n  const srs = epsg\r\n    ? `srsname=${epsgCode}`\r\n    : paramsWFS.srsName\r\n    ? 'srsname=' + paramsWFS.srsName\r\n    : `srsname=${epsgCode}`;\r\n\r\n  let propertyName = '';\r\n  let valueReference = '';\r\n  if (properties) {\r\n    propertyName = `propertyName=${properties}`;\r\n    valueReference = `valueReference=${properties}`;\r\n  }\r\n  const sourceFields = dataSourceOptions.sourceFields;\r\n  if (!propertyName && sourceFields && sourceFields.length > 0) {\r\n    const fieldsNames = [];\r\n    dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n      fieldsNames.push(sourcefield.name);\r\n    });\r\n    propertyName = `propertyName=${fieldsNames.join(',')},${\r\n      paramsWFS.fieldNameGeometry\r\n    }`;\r\n  }\r\n\r\n  const separator = url.indexOf('?') === -1 ? '?' : '&';\r\n  const getCapabilities = `${url}${separator}service=WFS&request=GetCapabilities&${version}`;\r\n  let getFeature = `${url}${separator}service=WFS&request=GetFeature&${version}&${featureTypes}&`;\r\n  getFeature += `${outputFormat}&${srs}&${cnt}&${propertyName}&${effectiveStartIndex}`;\r\n\r\n  let getpropertyvalue = `${url}?service=WFS&request=GetPropertyValue&version=${versionWfs200}&${featureTypes}&`;\r\n  getpropertyvalue += `&${cnt}&${valueReference}`;\r\n\r\n  return [\r\n    { name: 'outputformat', value: outputFormat },\r\n    { name: 'version', value: version },\r\n    { name: 'typename', value: featureTypes },\r\n    { name: 'count', value: cnt },\r\n    { name: 'srsname', value: srs },\r\n    { name: 'propertyname', value: propertyName },\r\n    { name: 'valuereference', value: valueReference },\r\n    { name: 'getcapabilities', value: getCapabilities.replace(/&&/g, '&') },\r\n    { name: 'getfeature', value: getFeature.replace(/&&/g, '&') },\r\n    { name: 'getpropertyvalue', value: getpropertyvalue.replace(/&&/g, '&') }\r\n  ];\r\n}\r\n\r\n/**\r\n * Validate/Modify layer's wfs options based on :\r\n * 1- an Openlayers's issue with GML provided from WFS. Refer to\r\n * https://github.com/openlayers/openlayers/pull/6400\r\n * 2- Set default values for optionals parameters.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function checkWfsParams(wfsDataSourceOptions, srcType?: string) {\r\n  if (srcType && srcType === 'wfs') {\r\n    // reassignation of params to paramsWFS and url to urlWFS to have a common interface with wms-wfs datasources\r\n    wfsDataSourceOptions.paramsWFS = wfsDataSourceOptions.params;\r\n  }\r\n\r\n  const paramsWFS = wfsDataSourceOptions.paramsWFS;\r\n  wfsDataSourceOptions.urlWfs =\r\n    wfsDataSourceOptions.urlWfs || wfsDataSourceOptions.url;\r\n\r\n  paramsWFS.version = paramsWFS.version || defaultWfsVersion;\r\n  paramsWFS.fieldNameGeometry =\r\n    paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n  paramsWFS.maxFeatures = paramsWFS.maxFeatures || defaultMaxFeatures;\r\n\r\n  let outputFormat;\r\n  if (paramsWFS.outputFormat) {\r\n    outputFormat = paramsWFS.outputFormat;\r\n  }\r\n\r\n  if (gmlRegex.test(outputFormat) || !outputFormat) {\r\n    paramsWFS.version = '1.1.0';\r\n  }\r\n  return Object.assign({}, wfsDataSourceOptions);\r\n}\r\n\r\nexport function getFormatFromOptions(\r\n  options: WFSDataSourceOptions | WMSDataSourceOptions\r\n) {\r\n  const wfsOptions = options as WFSDataSourceOptions;\r\n\r\n  let olFormatCls;\r\n  const outputFormat = wfsOptions.paramsWFS.outputFormat\r\n    ? wfsOptions.paramsWFS.outputFormat\r\n    : undefined;\r\n\r\n  if (!outputFormat) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  if (OlFormat[outputFormat]) {\r\n    olFormatCls = OlFormat[outputFormat];\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gml2')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ... { gmlFormat: olFormatGML2 }});\r\n  } else if (outputFormat.toLowerCase().match('gml32')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ... { gmlFormat: olFormatGML32 }});\r\n  } else if (outputFormat.toLowerCase().match('gml3')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ... { gmlFormat: olFormatGML3 }});\r\n  } else if (outputFormat.toLowerCase().match('topojson')) {\r\n    olFormatCls = OlFormat.TopoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('geojson')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('esrijson')) {\r\n    olFormatCls = OlFormat.EsriJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('json')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gpx')) {\r\n    olFormatCls = OlFormat.GPX;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('WKT')) {\r\n    olFormatCls = OlFormat.WKT;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('osmxml')) {\r\n    olFormatCls = olFormatOSMXML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('kml')) {\r\n    olFormatCls = OlFormat.KML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  return new olFormatCls();\r\n}\r\n","export enum InsertSourceInsertDBEnum {\r\n    System = 'system',\r\n    User = 'user'\r\n  }\r\n","import olLayerVector from 'ol/layer/Vector';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { easeOut } from 'ol/easing';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\nimport { getVectorContext } from 'ol/render';\r\nimport olFeature from 'ol/Feature';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olformat from 'ol/format';\r\n\r\nimport { FeatureDataSource } from '../../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSource } from '../../../datasource/shared/datasources/wfs-datasource';\r\nimport { ArcGISRestDataSource } from '../../../datasource/shared/datasources/arcgisrest-datasource';\r\nimport { WebSocketDataSource } from '../../../datasource/shared/datasources/websocket-datasource';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\nimport { VectorWatcher } from '../../utils';\r\nimport { IgoMap, MapExtent, getResolutionFromScale } from '../../../map';\r\nimport { Layer } from './layer';\r\nimport { VectorLayerOptions } from './vector-layer.interface';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { MessageService } from '@igo2/core';\r\nimport { WFSDataSourceOptions } from '../../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { buildUrl, defaultMaxFeatures } from '../../../datasource/shared/datasources/wms-wfs.utils';\r\nimport { OgcFilterableDataSourceOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { GeoNetworkService, SimpleGetOptions } from '../../../offline/shared/geo-network.service';\r\nimport { catchError, concatMap, debounceTime, delay, first } from 'rxjs/operators';\r\nimport { GeoDBService } from '../../../offline/geoDB/geoDB.service';\r\nimport { fromEvent, of, zip } from 'rxjs';\r\nimport { InsertSourceInsertDBEnum } from '../../../offline/geoDB/geoDB.enums';\r\nimport { LayerDBService } from '../../../offline/layerDB/layerDB.service';\r\nimport { LayerDBData } from '../../../offline';\r\nimport BaseEvent from 'ol/events/Event';\r\nimport { olStyleToBasicIgoStyle } from '../../../style/shared/vector/conversion.utils';\r\nimport { FeatureDataSourceOptions } from '../../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nexport class VectorLayer extends Layer {\r\n  public dataSource:\r\n    | FeatureDataSource\r\n    | WFSDataSource\r\n    | ArcGISRestDataSource\r\n    | WebSocketDataSource\r\n    | ClusterDataSource;\r\n  public options: VectorLayerOptions;\r\n  public ol: olLayerVector<olSourceVector<OlGeometry>>;\r\n  private watcher: VectorWatcher;\r\n  private trackFeatureListenerId;\r\n\r\n  get browsable(): boolean {\r\n    return this.options.browsable !== false;\r\n  }\r\n\r\n  get exportable(): boolean {\r\n    return this.options.exportable !== false;\r\n  }\r\n\r\n  constructor(\r\n    options: VectorLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor,\r\n    private geoNetworkService?: GeoNetworkService,\r\n    public geoDBService?: GeoDBService,\r\n    public layerDBService?: LayerDBService\r\n  ) {\r\n    super(options, messageService, authInterceptor, geoDBService, layerDBService);\r\n    this.watcher = new VectorWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVector<olSourceVector<OlGeometry>> {\r\n    const initialOpacityValue = this.options.opacity || 1;\r\n    const initialVisibleValue = this.options.visible !== false;\r\n    const initialMinResValue = this.options.minResolution || getResolutionFromScale(Number(this.options.minScaleDenom));\r\n    const initialMaxResValue = this.options.maxResolution || getResolutionFromScale(Number(this.options.maxScaleDenom));\r\n    const so = this.options.sourceOptions as FeatureDataSourceOptions;\r\n    if (this.dataSource instanceof FeatureDataSource) {\r\n      if (so?.preload?.bypassResolution || so?.preload?.bypassVisible) {\r\n        this.options.opacity = 0;\r\n        if (so.preload.bypassResolution && (this.options.minResolution || this.options.maxResolution)) {\r\n          this.options.minResolution = 0;\r\n          this.options.maxResolution = Infinity;\r\n        }\r\n        if (so.preload.bypassVisible && !initialVisibleValue) {\r\n          this.options.visible = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVector<OlGeometry>\r\n    });\r\n\r\n    if (this.options.animation) {\r\n      this.dataSource.ol.on(\r\n        'addfeature',\r\n        function(e) {\r\n          this.flash(e.feature);\r\n        }.bind(this)\r\n      );\r\n    }\r\n    if (this.options.idbInfo?.storeToIdb && this.geoDBService) {\r\n      if (this.options.idbInfo.firstLoad){\r\n        this.maintainFeaturesInIdb();\r\n      }\r\n      this.dataSource.ol.once('featuresloadend', () => {\r\n        this.dataSource.ol.on('addfeature', () => this.maintainFeaturesInIdb());\r\n        this.dataSource.ol.on('changefeature', () => this.maintainFeaturesInIdb());\r\n        this.dataSource.ol.on('clear', () => this.maintainFeaturesInIdb());\r\n        this.dataSource.ol.on('removefeature', () => this.maintainFeaturesInIdb());\r\n      });\r\n    }\r\n\r\n    if (\r\n      this.dataSource instanceof FeatureDataSource &&\r\n      (so?.preload?.bypassResolution || so?.preload?.bypassVisible)) {\r\n      this.dataSource.ol.once('featuresloadend', () => {\r\n        if (initialOpacityValue) {\r\n          this.opacity = initialOpacityValue;\r\n        }\r\n        if (so.preload.bypassResolution) {\r\n          this.minResolution = initialMinResValue;\r\n          this.maxResolution = initialMaxResValue;\r\n        }\r\n        if (so.preload.bypassVisible) {\r\n          this.visible = initialVisibleValue;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (this.options.trackFeature) {\r\n      this.enableTrackFeature(this.options.trackFeature);\r\n    }\r\n\r\n    const vector = new olLayerVector(olOptions);\r\n    const vectorSource = vector.getSource() as olSourceVector<OlGeometry>;\r\n    const url = vectorSource.getUrl();\r\n    if (url) {\r\n      let loader;\r\n      const wfsOptions = olOptions.sourceOptions as WFSDataSourceOptions;\r\n      if (wfsOptions?.type === 'wfs' && (wfsOptions.params || wfsOptions.paramsWFS)) {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customWFSLoader(\r\n            vectorSource,\r\n            wfsOptions,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      } else {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customLoader(\r\n            vectorSource,\r\n            url,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      }\r\n      if (loader) {\r\n        vectorSource.setLoader(loader);\r\n      }\r\n    } else if (this.options.idbInfo?.storeToIdb && this.geoDBService) {\r\n      const idbLoader = (extent, resolution, proj, success, failure) => {\r\n        this.customIDBLoader(\r\n          vectorSource,\r\n          olOptions.id,\r\n          extent,\r\n          proj,\r\n          success,\r\n          failure\r\n        );\r\n      };\r\n      if (idbLoader) {\r\n        vectorSource.setLoader(idbLoader);\r\n      }\r\n    }\r\n\r\n    if (this.options.idbInfo?.storeToIdb && this.geoDBService) {\r\n      vector.once('sourceready', () => {\r\n        if (this.options.idbInfo.firstLoad){\r\n          this.maintainOptionsInIdb();\r\n        }\r\n        fromEvent<BaseEvent>(vector, 'change').pipe(debounceTime(750)).subscribe(() => this.maintainOptionsInIdb());\r\n        vector.on('change:zIndex', () => this.maintainOptionsInIdb());\r\n      });\r\n    }\r\n    return vector;\r\n  }\r\n\r\n  removeLayerFromIDB() {\r\n    if (this.geoDBService && this.layerDBService) {\r\n      zip(this.geoDBService.deleteByKey(this.id),\r\n        this.layerDBService.deleteByKey(this.id)).subscribe();\r\n    }\r\n  }\r\n\r\n  private maintainOptionsInIdb() {\r\n    this.options.igoStyle.igoStyleObject = olStyleToBasicIgoStyle(this.ol);\r\n    const layerData: LayerDBData = ObjectUtils.removeUndefined({\r\n      layerId: this.id,\r\n      detailedContextUri: this.options.idbInfo.contextUri,\r\n      sourceOptions: {\r\n        id: this.id,\r\n        type: 'vector',\r\n        queryable: true\r\n      },\r\n      layerOptions: {\r\n        workspace: this.options.workspace,\r\n        zIndex: this.ol ? this.zIndex: 1000000,\r\n        id: this.id,\r\n        isIgoInternalLayer: this.isIgoInternalLayer,\r\n        title: this.title,\r\n        igoStyle: this.options.igoStyle,\r\n        idbInfo: Object.assign({}, this.options.idbInfo, { firstLoad: false })\r\n      },\r\n      insertEvent: `${this.title}-${this.id}-${new Date()}`\r\n    });\r\n    this.layerDBService.update(layerData);\r\n  }\r\n\r\n  private maintainFeaturesInIdb() {\r\n    const dsFeatures = this.dataSource.ol.getFeatures();\r\n    const geojsonObject = JSON.parse(new olformat.GeoJSON().writeFeatures(dsFeatures, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: this.dataSource.ol.getProjection() || 'EPSG:3857'\r\n    }));\r\n    this.geoDBService.update(this.id, this.id, geojsonObject, InsertSourceInsertDBEnum.User, `${this.title}-${this.id}-${new Date()}`);\r\n  }\r\n\r\n  protected flash(feature) {\r\n    const start = new Date().getTime();\r\n    const listenerKey = this.ol.on('postrender', animate.bind(this));\r\n\r\n    function animate(event) {\r\n      const vectorContext = getVectorContext(event);\r\n      const frameState = event.frameState;\r\n      const flashGeom = feature.getGeometry().clone();\r\n      const elapsed = frameState.time - start;\r\n      const elapsedRatio = elapsed / this.options.animation.duration;\r\n      const opacity = easeOut(1 - elapsedRatio);\r\n      const newColor = ColorAsArray(this.options.animation.color || 'red');\r\n      newColor[3] = opacity;\r\n      let style = this.ol\r\n        .getStyleFunction()\r\n        .call(this, feature)\r\n        .find((style2) => {\r\n          return style2.getImage();\r\n        });\r\n      if (!style) {\r\n        style = this.ol.getStyleFunction().call(this, feature)[0];\r\n      }\r\n      const styleClone = style.clone();\r\n\r\n      switch (feature.getGeometry().getType()) {\r\n        case 'Point':\r\n          if(styleClone.getImage() !== null &&\r\n            typeof styleClone.getImage().getRadius === 'function'){\r\n            const radius =\r\n            easeOut(elapsedRatio) * (styleClone.getImage().getRadius() * 3);\r\n            styleClone.getImage().setRadius(radius);\r\n            styleClone.getImage().setOpacity(opacity);\r\n          }\r\n\r\n          break;\r\n        case 'LineString':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getStroke().setColor(newColor);\r\n            styleClone\r\n              .getImage()\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) *\r\n                  (styleClone.getImage().getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          if (styleClone.getStroke()) {\r\n            styleClone.getStroke().setColor(newColor);\r\n            styleClone\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) * (styleClone.getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          break;\r\n        case 'Polygon':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getFill().setColor(newColor);\r\n          }\r\n          if (styleClone.getFill()) {\r\n            styleClone.getFill().setColor(newColor);\r\n          }\r\n          break;\r\n      }\r\n\r\n      styleClone.setText('');\r\n      vectorContext.setStyle(styleClone);\r\n      vectorContext.drawGeometry(flashGeom);\r\n\r\n      if (elapsed > this.options.animation.duration) {\r\n        unByKey(listenerKey);\r\n        // remove last geometry\r\n        // there is a little flash before feature disappear, better solution ?\r\n        this.map.ol.render();\r\n        return;\r\n      }\r\n      // tell OpenLayers to continue postcompose animation\r\n      this.map.ol.render();\r\n    }\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  public setExtent(extent: MapExtent): void {\r\n    this.options.extent = extent;\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.dataSource.onUnwatch();\r\n    this.stopAnimation();\r\n  }\r\n\r\n  public stopAnimation() {\r\n    this.dataSource.ol.un(\r\n      'addfeature',\r\n      function(e) {\r\n        if (this.visible) {\r\n          this.flash(e.feature);\r\n        }\r\n      }.bind(this)\r\n    );\r\n  }\r\n\r\n  public enableTrackFeature(id: string | number) {\r\n    this.trackFeatureListenerId = this.dataSource.ol.on(\r\n      'addfeature',\r\n      this.trackFeature.bind(this, id)\r\n    );\r\n  }\r\n  public centerMapOnFeature(id: string | number) {\r\n    const feat = this.dataSource.ol.getFeatureById(id);\r\n    if (feat) {\r\n      this.map.ol.getView().setCenter((feat.getGeometry() as any).getCoordinates());\r\n    }\r\n  }\r\n\r\n  public trackFeature(id, feat) {\r\n    if (feat.feature.getId() === id && this.visible) {\r\n      this.centerMapOnFeature(id);\r\n    }\r\n  }\r\n\r\n  public disableTrackFeature(id?: string | number) {\r\n    unByKey(this.trackFeatureListenerId);\r\n  }\r\n\r\n  /**\r\n   * Custom loader for a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param options olOptions from source\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param proj the projection to retrieve the data\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   * @param randomParam random parameter to ensure cache is not causing problems in retrieving new data\r\n   */\r\n  public customWFSLoader(\r\n    vectorSource,\r\n    options,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    proj,\r\n    success,\r\n    failure,\r\n    randomParam?: boolean\r\n  ) {\r\n    {\r\n      const paramsWFS = options.paramsWFS;\r\n      const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n      const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n      paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n      const url = buildUrl(\r\n        options,\r\n        currentExtent,\r\n        wfsProj,\r\n        (options as OgcFilterableDataSourceOptions).ogcFilters,\r\n        randomParam);\r\n      let startIndex = 0;\r\n      if (paramsWFS.version === '2.0.0' && paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n        const nbOfFeature = 1000;\r\n        while (startIndex < paramsWFS.maxFeatures) {\r\n          let alteredUrl = url.replace('count=' + paramsWFS.maxFeatures, 'count=' + nbOfFeature);\r\n          alteredUrl = alteredUrl.replace('startIndex=0', '0');\r\n          alteredUrl += '&startIndex=' + startIndex;\r\n          alteredUrl.replace(/&&/g, '&');\r\n          this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, alteredUrl, nbOfFeature, success, failure);\r\n          startIndex += nbOfFeature;\r\n        }\r\n      } else {\r\n        this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, url, paramsWFS.maxFeatures, success, failure);\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Custom loader to get feature from a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param dataProjection the projection of the retrieved data\r\n   * @param featureProjection the projection of the created features\r\n   * @param url the url string to retrieve the data\r\n   * @param threshold the threshold to manage \"more features\" (TODO)\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   */\r\n  private getFeatures(\r\n    vectorSource: olSourceVector<OlGeometry>,\r\n    interceptor,\r\n    extent,\r\n    dataProjection,\r\n    featureProjection,\r\n    url: string,\r\n    threshold: number,\r\n    success, failure) {\r\n\r\n    const idAssociatedCall = (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter;\r\n    const xhr = new XMLHttpRequest();\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', modifiedUrl);\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      if (xhr.status === 200 && xhr.responseText.length > 0) {\r\n        const features =\r\n          vectorSource\r\n            .getFormat()\r\n            .readFeatures(xhr.responseText, { dataProjection, featureProjection }) as olFeature<OlGeometry>[];\r\n        // TODO Manage \"More feature\"\r\n        /*if (features.length === 0 || features.length < threshold ) {\r\n          console.log('No more data to download at this resolution');\r\n        }*/\r\n        // Avoids retrieving an older call that took longer to be process\r\n        if (idAssociatedCall === (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter)\r\n        {\r\n            vectorSource.addFeatures(features);\r\n            success(features);\r\n        }\r\n        else {\r\n            success([]);\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector layer.\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param url the url string or function to retrieve the data\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param projection the projection to retrieve the data\r\n   */\r\n  private customLoader(\r\n    vectorSource,\r\n    url,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    projection,\r\n    success,\r\n    failure\r\n  ) {\r\n    const xhr = new XMLHttpRequest();\r\n    let modifiedUrl = url;\r\n    if (typeof url !== 'function') {\r\n      const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n      if (alteredUrlWithKeyAuth) {\r\n        modifiedUrl = alteredUrlWithKeyAuth;\r\n      }\r\n    } else {\r\n      modifiedUrl = url(extent, resolution, projection);\r\n    }\r\n\r\n    if (this.geoNetworkService && typeof url !== 'function') {\r\n      const format = vectorSource.getFormat();\r\n      const type = format.getType();\r\n\r\n      let responseType = type;\r\n      const onError = () => {\r\n        vectorSource.removeLoadedExtent(extent);\r\n        failure();\r\n      };\r\n\r\n      const options: SimpleGetOptions = { responseType };\r\n      this.geoNetworkService.geoDBService.get(url).pipe(delay(750)).pipe(concatMap(r =>\r\n        r ? of(r) : this.geoNetworkService.get(modifiedUrl, options)\r\n          .pipe(\r\n            first(),\r\n            catchError((res) => {\r\n              onError();\r\n              throw res;\r\n            })\r\n          )\r\n      ))\r\n      .subscribe((content) => {\r\n          if (content) {\r\n            const format = vectorSource.getFormat();\r\n            const type = format.getType();\r\n            let source;\r\n            if (type === 'json' || type === 'text') {\r\n              source = content;\r\n            } else if (type === 'xml') {\r\n              source = content;\r\n              if (!source) {\r\n                source = new DOMParser().parseFromString(\r\n                  content,\r\n                  'application/xml'\r\n                );\r\n              }\r\n            } else if (type === 'arraybuffer') {\r\n              source = content;\r\n            }\r\n            if (source) {\r\n              const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n              vectorSource.addFeatures(features, format.readProjection(source));\r\n              success(features);\r\n            } else {\r\n              onError();\r\n            }\r\n          }\r\n        });\r\n\r\n    } else {\r\n    xhr.open( 'GET', modifiedUrl);\r\n    const format = vectorSource.getFormat();\r\n    if (format.getType() === 'arraybuffer') {\r\n      xhr.responseType = 'arraybuffer';\r\n    }\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      // status will be 0 for file:// urls\r\n      if (!xhr.status || (xhr.status >= 200 && xhr.status < 300)) {\r\n        const type = format.getType();\r\n        let source;\r\n        if (type === 'json' || type === 'text') {\r\n          source = xhr.responseText;\r\n        } else if (type === 'xml') {\r\n          source = xhr.responseXML;\r\n          if (!source) {\r\n            source = new DOMParser().parseFromString(\r\n              xhr.responseText,\r\n              'application/xml'\r\n            );\r\n          }\r\n        } else if (type === 'arraybuffer') {\r\n          source = xhr.response;\r\n        }\r\n        if (source) {\r\n          const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n          vectorSource.addFeatures(features, format.readProjection(source));\r\n          success(features);\r\n        } else {\r\n          onError();\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n  }\r\n\r\n\r\n  /**\r\n   * Custom loader for vector layer.\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param layerID the url string or function to retrieve the data\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param projection the projection to retrieve the data\r\n   */\r\n  private customIDBLoader(\r\n    vectorSource,\r\n    layerID,\r\n    extent,\r\n    projection,\r\n    success,\r\n    failure\r\n  ) {\r\n\r\n\r\n    if (this.geoNetworkService) {\r\n      const onError = () => {\r\n        vectorSource.removeLoadedExtent(extent);\r\n        failure();\r\n      };\r\n      this.geoNetworkService.geoDBService.get(layerID)\r\n      .subscribe((content) => {\r\n          if (content) {\r\n            const format = vectorSource.getFormat();\r\n            const type = format.getType();\r\n            let source;\r\n            if (type === 'json' || type === 'text') {\r\n              source = content;\r\n            } else if (type === 'xml') {\r\n              source = content;\r\n              if (!source) {\r\n                source = new DOMParser().parseFromString(\r\n                  content,\r\n                  'application/xml'\r\n                );\r\n              }\r\n            } else if (type === 'arraybuffer') {\r\n              source = content;\r\n            }\r\n            if (source) {\r\n              const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n              vectorSource.addFeatures(features, format.readProjection(source));\r\n              success(features);\r\n            } else {\r\n              onError();\r\n            }\r\n          }\r\n        });\r\n\r\n    }\r\n  }\r\n\r\n}\r\n","import olLayerVector from 'ol/layer/Vector';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nexport function olStyleToBasicIgoStyle(layer: olLayerVector<olSourceVector<OlGeometry>>) {\r\n    const layerOlStyle = layer.getStyle();\r\n    if (typeof layerOlStyle === 'function' || layerOlStyle instanceof Array) {\r\n      return;\r\n    }\r\n\r\n    const rStyle = {\r\n      fill: {\r\n        color: layerOlStyle.getFill().getColor()\r\n      },\r\n      stroke: {\r\n        color: layerOlStyle.getStroke().getColor(),\r\n        width: 2\r\n      },\r\n      circle: {\r\n        fill: {\r\n          color: (layerOlStyle.getImage() as any).getFill().getColor()\r\n        },\r\n        stroke: {\r\n          color: (layerOlStyle.getImage() as any).getStroke().getColor(),\r\n          width: 2\r\n        },\r\n        radius: 5,\r\n      }\r\n    };\r\n    return rStyle;\r\n  }\r\n","import olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\n\r\nimport { MVTDataSource } from '../../../datasource/shared/datasources/mvt-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { VectorTileLayerOptions } from './vectortile-layer.interface';\r\nimport { TileWatcher } from '../../utils';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { IgoMap } from '../../../map';\r\nimport { MessageService } from '@igo2/core';\r\nimport VectorTile from 'ol/VectorTile';\r\n\r\nexport class VectorTileLayer extends Layer {\r\n  public dataSource: MVTDataSource;\r\n  public options: VectorTileLayerOptions;\r\n  public ol: olLayerVectorTile;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: VectorTileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVectorTile {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVectorTile\r\n    });\r\n\r\n    const vectorTile = new olLayerVectorTile(olOptions);\r\n    const vectorTileSource = vectorTile.getSource() as olSourceVectorTile;\r\n\r\n    vectorTileSource.setTileLoadFunction((tile: VectorTile, url: string) => {\r\n      const loader = this.customLoader(url, tile.getFormat(), this.authInterceptor, tile.onLoad.bind(tile));\r\n      if (loader) {\r\n        tile.setLoader(loader);\r\n      }\r\n    }\r\n    );\r\n\r\n    return vectorTile;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector tile layer. Modified from the loadFeaturesXhr function in ol\\featureloader.js\r\n   * @internal\r\n   * @param url the url string or function to retrieve the data\r\n   * @param format the format of the tile\r\n   * @param interceptor the interceptor of the data\r\n   * @param success On success event action to trigger\r\n   * @param failure On failure event action to trigger TODO\r\n   */\r\n  customLoader(url, format, interceptor, success, failure?) {\r\n    return ((extent, resolution, projection) => {\r\n      const xhr = new XMLHttpRequest();\r\n      let modifiedUrl = url;\r\n      if (typeof url !== 'function') {\r\n        const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n        if (alteredUrlWithKeyAuth) {\r\n          modifiedUrl = alteredUrlWithKeyAuth;\r\n        }\r\n      } else {\r\n        modifiedUrl = url(extent, resolution, projection);\r\n      }\r\n      xhr.open( 'GET', modifiedUrl);\r\n      if (interceptor) {\r\n        interceptor.interceptXhr(xhr, modifiedUrl);\r\n      }\r\n\r\n      if (format.getType() === 'arraybuffer') {\r\n        xhr.responseType = 'arraybuffer';\r\n      }\r\n      xhr.onload = (event) => {\r\n        if (!xhr.status || xhr.status >= 200 && xhr.status < 300) {\r\n          const type = format.getType();\r\n          let source;\r\n          if (type === 'json' || type === 'text') {\r\n            source = xhr.responseText;\r\n          }\r\n          else if (type === 'xml') {\r\n            source = xhr.responseXML;\r\n            if (!source) {\r\n              source = new DOMParser().parseFromString(xhr.responseText, 'application/xml');\r\n            }\r\n          }\r\n          else if (type === 'arraybuffer') {\r\n            source = xhr.response;\r\n          }\r\n          if (source) {\r\n            success.call(this, format.readFeatures(source, {\r\n              extent,\r\n              featureProjection: projection\r\n            }), format.readProjection(source));\r\n          }\r\n          else {\r\n            // TODO\r\n            failure.call(this);\r\n          }\r\n        } else {\r\n          // TODO\r\n          failure.call(this);\r\n        }\r\n      };\r\n      xhr.onerror = () => {\r\n        // TODO\r\n        failure.call(this);\r\n      };\r\n      xhr.send();\r\n    });\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","export const FEATURE = 'Feature';\r\n\r\nexport enum FeatureMotion {\r\n  None,\r\n  Move,\r\n  Zoom,\r\n  Default\r\n}\r\n","import olSourceOSM from 'ol/source/OSM';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { OSMDataSourceOptions } from './osm-datasource.interface';\r\n\r\nexport class OSMDataSource extends DataSource {\r\n  public options: OSMDataSourceOptions;\r\n  public ol: olSourceOSM;\r\n\r\n  protected createOlSource(): olSourceOSM {\r\n    if (!this.options.url) {\r\n      this.options.url = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';\r\n    }\r\n    return new olSourceOSM(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceXYZ from 'ol/source/XYZ';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { XYZDataSourceOptions } from './xyz-datasource.interface';\r\n\r\nexport class XYZDataSource extends DataSource {\r\n  public options: XYZDataSourceOptions;\r\n  public ol: olSourceXYZ;\r\n\r\n  protected createOlSource(): olSourceXYZ {\r\n    return new olSourceXYZ(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as OlLoadingStrategy from 'ol/loadingstrategy';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport {\r\n  defaultFieldNameGeometry,\r\n  checkWfsParams,\r\n  getFormatFromOptions,\r\n  buildUrl\r\n} from './wms-wfs.utils';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nexport class WFSDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public mostRecentIdCallOGCFilter: number = 0;\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  constructor(\r\n    public options: WFSDataSourceOptions,\r\n    protected wfsService: WFSService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(checkWfsParams(options, 'wfs'));\r\n\r\n    const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    const fieldNameGeometry = this.options.paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters =\r\n      ogcFilterWriter.defineOgcFiltersDefaultOptions(ogcFilters, fieldNameGeometry);\r\n    if (\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.enabled &&\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0\r\n    ) {\r\n      this.wfsService.getSourceFieldsFromWFS(this.options);\r\n    }\r\n\r\n    if (ogcFilters?.pushButtons){\r\n      ogcFilters.pushButtons.selectorType = 'pushButton';\r\n    }\r\n    if (ogcFilters?.checkboxes){\r\n      ogcFilters.checkboxes.selectorType = 'checkbox';\r\n    }\r\n    if (ogcFilters?.radioButtons){\r\n      ogcFilters.radioButtons.selectorType = 'radioButton';\r\n    }\r\n    if (ogcFilters?.select){\r\n      ogcFilters.select.selectorType = 'select';\r\n    }\r\n    if (ogcFilters?.autocomplete){\r\n      ogcFilters.autocomplete.selectorType = 'autocomplete';\r\n    }\r\n\r\n    this.setOgcFilters((this.options as OgcFilterableDataSourceOptions).ogcFilters, true);\r\n  }\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const vectorSource = new olSourceVector({\r\n      format: getFormatFromOptions(this.options),\r\n      url: (extent, resolution, proj: olProjection) => {\r\n        const paramsWFS = this.options.paramsWFS;\r\n        const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n        const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n        const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n        paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n        return buildUrl(this.options, currentExtent, wfsProj, ogcFilters);\r\n      },\r\n      strategy: OlLoadingStrategy.bbox\r\n    });\r\n    return vectorSource;\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    this.mostRecentIdCallOGCFilter += 1;\r\n    if (triggerEvent) {\r\n      this.ol.notify('ogcFilters', this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  public onUnwatch() { }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { combineLatest, Observable, of } from 'rxjs';\r\nimport olFeature from 'ol/Feature';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { DataService } from './data.service';\r\nimport { formatWFSQueryString,\r\n          gmlRegex,\r\n          defaultEpsg,\r\n          defaultMaxFeatures,\r\n          getFormatFromOptions} from './wms-wfs.utils';\r\nimport { concatMap } from 'rxjs/operators';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WFSService extends DataService {\r\n  constructor(private http: HttpClient) {\r\n    super();\r\n  }\r\n\r\n  getData() {\r\n    console.log('This is defining a data service.');\r\n    return 'This is defining a data service.';\r\n  }\r\n\r\n  public getSourceFieldsFromWFS(dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions) {\r\n    if (!dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0 ) {\r\n      dataSourceOptions.sourceFields = [];\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields = getfeatureSourceField;\r\n      });\r\n\r\n    } else {\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n          if (sourcefield.alias === undefined) {\r\n            sourcefield.alias = sourcefield.name; // to allow only a list of sourcefield with names\r\n          }\r\n          if (sourcefield.values === undefined || sourcefield.values.length === 0) {\r\n            sourcefield.values = getfeatureSourceField.find(sf => sf.name === sourcefield.name).values;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  private wfsGetFeature(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n    nb: number = defaultMaxFeatures,\r\n    epsgCode: string = defaultEpsg,\r\n    propertyName?: string,\r\n    startIndex: number = 0,\r\n    forceDefaultOutputFormat: boolean = false\r\n  ): Observable<any> {\r\n    const queryStringValues = formatWFSQueryString(dataSourceOptions, nb, epsgCode, propertyName, startIndex, forceDefaultOutputFormat );\r\n    const baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n    const outputFormat = dataSourceOptions.paramsWFS.outputFormat;\r\n    if (forceDefaultOutputFormat || gmlRegex.test(outputFormat) || !outputFormat) {\r\n      return this.http.get(baseUrl, { responseType: 'text' });\r\n    } else {\r\n      return this.http.get(baseUrl);\r\n    }\r\n  }\r\n\r\n  defineFieldAndValuefromWFS(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions\r\n  ): Observable<any> {\r\n    return new Observable(d => {\r\n      const sourceFields = [];\r\n      let fieldList;\r\n      let fieldListWoGeom;\r\n      let fieldListWoGeomStr;\r\n      let olFormats;\r\n      let effectiveOlFormats;\r\n\r\n      olFormats = getFormatFromOptions(dataSourceOptions);\r\n      const gmlDataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions = JSON.parse(\r\n        JSON.stringify(dataSourceOptions)\r\n      );\r\n      delete gmlDataSourceOptions.paramsWFS.outputFormat;\r\n      delete (gmlDataSourceOptions as WFSDataSourceOptions).formatOptions;\r\n\r\n      effectiveOlFormats = getFormatFromOptions(gmlDataSourceOptions);\r\n      let sourceFieldsToRetrieveValues = dataSourceOptions.sourceFields?.filter(f => !f.values).map(f => f.name);\r\n\r\n      // Validate if the service manage no outputformat (wfs 1.0.0 and GML is the default return)\r\n      this.wfsGetFeature(dataSourceOptions, 1, undefined, undefined, 0, true).pipe(\r\n        concatMap(res => String(res).toLowerCase().includes('exception') ? of(false) : of(true)),\r\n        concatMap(allowGml => {\r\n          // If the service return GML (return no exception)\r\n          return this.wfsGetFeature(dataSourceOptions, 1).pipe(\r\n            concatMap(firstFeature => {\r\n              const features = olFormats.readFeatures(firstFeature);\r\n              fieldList = features[0].getKeys();\r\n              if (dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0) {\r\n                sourceFieldsToRetrieveValues = fieldList;\r\n              }\r\n              fieldListWoGeom = fieldList.filter(\r\n                field =>\r\n                  sourceFieldsToRetrieveValues.includes(field) &&\r\n                  field !== features[0].getGeometryName() &&\r\n                  !field.match(/boundedby/gi)\r\n              );\r\n              fieldListWoGeomStr = fieldListWoGeom.join(',');\r\n              const processingArray = [];\r\n              let startIndex = 0;\r\n              // If the service do not allow gml return, dice the call in multiple\r\n              // calls by increment of chunkSize with the original outputFormat\r\n              if (\r\n                !allowGml && dataSourceOptions.paramsWFS.version === '2.0.0' &&\r\n                dataSourceOptions.paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n                const chunkSize = 1000;\r\n                while (startIndex < dataSourceOptions.paramsWFS.maxFeatures) {\r\n                  processingArray.push(this.wfsGetFeature(\r\n                    dataSourceOptions,\r\n                    chunkSize,\r\n                    dataSourceOptions.paramsWFS.srsName,\r\n                    fieldListWoGeomStr,\r\n                    startIndex\r\n                  ));\r\n                  startIndex += chunkSize;\r\n                }\r\n                effectiveOlFormats = olFormats;\r\n              } else {\r\n                processingArray.push(this.wfsGetFeature(\r\n                  dataSourceOptions,\r\n                  dataSourceOptions.paramsWFS.maxFeatures || defaultMaxFeatures,\r\n                  dataSourceOptions.paramsWFS.srsName,\r\n                  fieldListWoGeomStr,\r\n                  0, true\r\n                ));\r\n              }\r\n              return combineLatest(processingArray);\r\n            })\r\n          );\r\n        })).subscribe((results) => {\r\n          let mfeatures: olFeature<OlGeometry>[] = [];\r\n          results.map((result) => {\r\n            const loopFeatures = effectiveOlFormats.readFeatures(result);\r\n            mfeatures = mfeatures.concat(loopFeatures);\r\n          });\r\n          this.built_properties_value(mfeatures).forEach(element => {\r\n            sourceFields.push(element);\r\n          });\r\n          d.next(sourceFields);\r\n          d.complete();\r\n        });\r\n    });\r\n  }\r\n\r\n  private built_properties_value(features: olFeature<OlGeometry>[]): string[] {\r\n    if (features.length === 0) {\r\n      return [];\r\n    }\r\n    const kv = Object.assign({}, features[0].getProperties());\r\n    delete kv[features[0].getGeometryName()];\r\n    delete kv.boundedBy;\r\n    const sourceFields = [];\r\n    for (const property in kv) {\r\n      if (kv.hasOwnProperty(property)) {\r\n        const fieldType =\r\n          typeof features[0].get(property) === 'object'\r\n            ? undefined\r\n            : typeof features[0].get(property);\r\n        sourceFields.push({\r\n          name: property,\r\n          alias: property,\r\n          type: fieldType,\r\n          values: [kv[property]]\r\n        });\r\n      }\r\n    }\r\n    features.every((element) => {\r\n      const featureProperties = element.getProperties();\r\n      for (const key in featureProperties) {\r\n        if (featureProperties.hasOwnProperty(key) && key in kv) {\r\n          sourceFields.filter(f => f.name === key).forEach(v => {\r\n            if (v.values.indexOf(featureProperties[key]) === -1) {\r\n              v.values.push(featureProperties[key]);\r\n            }\r\n          });\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n    return sourceFields;\r\n  }\r\n}\r\n","export abstract class DataService {\r\n    abstract getData(): string;\r\n}\r\n","export enum QueryFormat {\r\n  GML2 = 'gml2',\r\n  GML3 = 'gml3',\r\n  JSON = 'json',\r\n  GEOJSON = 'geojson',\r\n  GEOJSON2 = 'geojson2',\r\n  ESRIJSON = 'esrijson',\r\n  TEXT = 'text',\r\n  HTML = 'html',\r\n  HTMLGML2 = 'htmlgml2'\r\n}\r\n\r\nexport enum QueryFormatMimeType {\r\n  GML2 = 'application/vnd.ogc.gml',\r\n  GML3 = 'application/vnd.ogc.gml/3.1.1',\r\n  JSON = 'application/json',\r\n  GEOJSON = 'application/geojson',\r\n  GEOJSON2 = 'geojson',\r\n  ESRIJSON = 'application/json',\r\n  TEXT = 'text/plain',\r\n  HTML = 'text/html',\r\n  HTMLGML2 = 'text/html'\r\n}\r\n\r\nexport enum QueryHtmlTarget {\r\n  IFRAME = 'iframe',\r\n  BLANK = '_blank'\r\n}\r\n","import olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions, OgcFilterDuringOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nimport {\r\n  formatWFSQueryString,\r\n  checkWfsParams,\r\n  defaultFieldNameGeometry\r\n} from './wms-wfs.utils';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LegendMapViewOptions } from '../../../layer/shared/layers/layer.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { TimeFilterableDataSourceOptions, TimeFilterOptions } from '../../../filter/shared/time-filter.interface';\r\n\r\nexport class WMSDataSource extends DataSource {\r\n  public ol: olSourceImageWMS;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  set timeFilter(value: TimeFilterOptions ) {\r\n    (this.options as TimeFilterableDataSourceOptions).timeFilter = value;\r\n  }\r\n  get timeFilter(): TimeFilterOptions {\r\n    return (this.options as TimeFilterableDataSourceOptions).timeFilter;\r\n  }\r\n  readonly timeFilter$: BehaviorSubject<TimeFilterOptions> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    public options: WMSDataSourceOptions,\r\n    protected wfsService: WFSService\r\n  ) {\r\n    super(options);\r\n    const sourceParams: any = options.params;\r\n\r\n    const dpi = sourceParams.DPI || 96;\r\n    sourceParams.DPI = dpi;\r\n    sourceParams.MAP_RESOLUTION = dpi;\r\n    sourceParams.FORMAT_OPTIONS = 'dpi:' + dpi;\r\n\r\n    if (options.refreshIntervalSec && options.refreshIntervalSec > 0) {\r\n      setInterval(() => {\r\n        this.refresh();\r\n      }, options.refreshIntervalSec * 1000); // Convert seconds to MS\r\n    }\r\n\r\n    let fieldNameGeometry = defaultFieldNameGeometry;\r\n\r\n    // ####   START if paramsWFS\r\n    if (options.paramsWFS) {\r\n      const wfsCheckup = checkWfsParams(options, 'wms');\r\n      ObjectUtils.mergeDeep(options.paramsWFS, wfsCheckup.paramsWFS);\r\n\r\n      fieldNameGeometry =\r\n        options.paramsWFS.fieldNameGeometry || fieldNameGeometry;\r\n\r\n      options.download = Object.assign({}, options.download, {\r\n        dynamicUrl: this.buildDynamicDownloadUrlFromParamsWFS(options)\r\n      });\r\n    } //  ####   END  if paramsWFS\r\n\r\n    if (!options.sourceFields || options.sourceFields.length === 0) {\r\n      options.sourceFields = [];\r\n    } else {\r\n      options.sourceFields.forEach(sourceField => {\r\n        sourceField.alias = sourceField.alias\r\n          ? sourceField.alias\r\n          : sourceField.name;\r\n        // to allow only a list of sourcefield with names\r\n      });\r\n    }\r\n    const initOgcFilters = (options as OgcFilterableDataSourceOptions)\r\n      .ogcFilters;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (!initOgcFilters) {\r\n      (options as OgcFilterableDataSourceOptions).ogcFilters = ogcFilterWriter.defineOgcFiltersDefaultOptions(\r\n        initOgcFilters,\r\n        fieldNameGeometry,\r\n        'wms'\r\n      );\r\n    } else {\r\n      initOgcFilters.advancedOgcFilters = (initOgcFilters.pushButtons || initOgcFilters.checkboxes\r\n        || initOgcFilters.radioButtons || initOgcFilters.select || initOgcFilters.autocomplete)\r\n        ? false\r\n        : true;\r\n      if (initOgcFilters.advancedOgcFilters && initOgcFilters.filters) {\r\n          const filterDuring = initOgcFilters.filters as OgcFilterDuringOptions;\r\n          if(filterDuring.calendarModeYear) {\r\n            initOgcFilters.advancedOgcFilters = false;\r\n          }\r\n      }\r\n      if (initOgcFilters.pushButtons){\r\n        initOgcFilters.pushButtons.selectorType = 'pushButton';\r\n      }\r\n      if (initOgcFilters.checkboxes){\r\n        initOgcFilters.checkboxes.selectorType = 'checkbox';\r\n      }\r\n      if (initOgcFilters.radioButtons){\r\n        initOgcFilters.radioButtons.selectorType = 'radioButton';\r\n      }\r\n      if (initOgcFilters.select){\r\n        initOgcFilters.select.selectorType = 'select';\r\n      }\r\n      if (initOgcFilters.autocomplete){\r\n        initOgcFilters.autocomplete.selectorType = 'autocomplete';\r\n      }\r\n    }\r\n\r\n    if (\r\n      sourceParams.LAYERS.split(',').length > 1 &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled\r\n    ) {\r\n      console.log('*******************************');\r\n      console.log(\r\n        'BE CAREFULL, YOUR WMS LAYERS (' +\r\n          sourceParams.LAYERS +\r\n          ') MUST SHARE THE SAME FIELDS TO ALLOW ogcFilters TO WORK !! '\r\n      );\r\n      console.log('*******************************');\r\n    }\r\n\r\n    if (\r\n      options.paramsWFS &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled &&\r\n      initOgcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0) {\r\n      this.wfsService.getSourceFieldsFromWFS(options);\r\n    }\r\n\r\n    const filterQueryString = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n      options,\r\n      fieldNameGeometry\r\n    );\r\n    sourceParams.FILTER = filterQueryString;\r\n    this.ol.updateParams({'FILTER': sourceParams.FILTER});\r\n    this.setOgcFilters(initOgcFilters, true);\r\n\r\n    const timeFilterableDataSourceOptions = (options as TimeFilterableDataSourceOptions);\r\n    if (\r\n      timeFilterableDataSourceOptions?.timeFilterable &&\r\n      timeFilterableDataSourceOptions?.timeFilter) {\r\n      this.setTimeFilter(timeFilterableDataSourceOptions.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  refresh() {\r\n    this.ol.updateParams({ igoRefresh: Math.random() });\r\n  }\r\n\r\n  private buildDynamicDownloadUrlFromParamsWFS(asWFSDataSourceOptions) {\r\n    const queryStringValues = formatWFSQueryString(asWFSDataSourceOptions);\r\n    const downloadUrl = queryStringValues.find(f => f.name === 'getfeature')\r\n      .value;\r\n    return downloadUrl;\r\n  }\r\n\r\n  protected createOlSource(): olSourceImageWMS {\r\n    return new olSourceImageWMS(Object.assign({ratio: 1}, this.options));\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    if (triggerEvent) {\r\n      this.ol.notify('ogcFilters', this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  setTimeFilter(timeFilter: TimeFilterOptions, triggerEvent: boolean = false) {\r\n    this.timeFilter = timeFilter;\r\n    if (triggerEvent) {\r\n      this.timeFilter$.next(this.timeFilter);\r\n      this.ol.notify('timeFilter', this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    let legend = super.getLegend();\r\n    if (legend.length > 0 && (style === undefined && !view?.scale)) {\r\n      return legend;\r\n    }\r\n\r\n    let contentDependent = false;\r\n    let projParam;\r\n\r\n    if (view?.size && view?.extent && view?.projection && this.options.contentDependentLegend) {\r\n      projParam = this.params.VERSION === '1.3.0' || this.params.VERSION === undefined ? 'CRS' : 'SRS';\r\n      contentDependent = true;\r\n    }\r\n\r\n    const sourceParams = this.params;\r\n\r\n    let layers = [];\r\n    if (sourceParams.LAYERS !== undefined) {\r\n      layers = sourceParams.LAYERS.split(',');\r\n    }\r\n\r\n    const baseUrl = this.options.url.replace(/\\?$/, '');\r\n    const params = [\r\n      'REQUEST=GetLegendGraphic',\r\n      'SERVICE=WMS',\r\n      'FORMAT=image/png',\r\n      'SLD_VERSION=1.1.0',\r\n      `VERSION=${sourceParams.VERSION || '1.3.0'}`\r\n    ];\r\n    if (style !== undefined) {\r\n      params.push(`STYLE=${style}`);\r\n    }\r\n    if (view?.scale !== undefined) {\r\n      params.push(`SCALE=${view.scale}`);\r\n    }\r\n    if (contentDependent) {\r\n      params.push(`WIDTH=${view.size[0]}`);\r\n      params.push(`HEIGHT=${view.size[1]}`);\r\n      params.push(`BBOX=${view.extent.join(',')}`);\r\n      params.push(`${projParam}=${view.projection}`);\r\n    }\r\n\r\n    legend = layers.map((layer: string) => {\r\n      const separator = baseUrl.match(/\\?/) ? '&' : '?';\r\n      return {\r\n        url: `${baseUrl}${separator}${params.join('&')}&LAYER=${layer}`,\r\n        title: layers.length > 1 ? layer : undefined,\r\n        currentStyle: style === undefined ? undefined : style as string\r\n      };\r\n    });\r\n\r\n    return legend;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olTileGridWMTS from 'ol/tilegrid/WMTS';\r\nimport * as olproj from 'ol/proj';\r\nimport {\r\n  getTopLeft as extentGetTopLeft,\r\n  getWidth as extentGetWidth\r\n} from 'ol/extent.js';\r\n\r\nexport function createDefaultTileGrid(epsg?: string): olTileGridWMTS {\r\n  const projection = epsg ? olproj.get(epsg) : olproj.get('EPSG:3857');\r\n  const projectionExtent = projection.getExtent();\r\n  const size = extentGetWidth(projectionExtent) / 256;\r\n  const resolutions = new Array(20);\r\n  const matrixIds = new Array(20);\r\n  for (let z = 0; z < 20; ++z) {\r\n    resolutions[z] = size / Math.pow(2, z);\r\n    matrixIds[z] = z;\r\n  }\r\n\r\n  return new olTileGridWMTS({\r\n    origin: extentGetTopLeft(projectionExtent),\r\n    resolutions,\r\n    matrixIds\r\n  });\r\n}\r\n","import { Options } from 'ol/source/WMTS';\r\nimport olSourceWMTS from 'ol/source/WMTS';\r\n\r\nimport { createDefaultTileGrid } from '../../utils/tilegrid';\r\nimport { DataSource } from './datasource';\r\nimport { WMTSDataSourceOptions } from './wmts-datasource.interface';\r\n\r\nexport class WMTSDataSource extends DataSource {\r\n  public options: WMTSDataSourceOptions;\r\n  public ol: olSourceWMTS;\r\n\r\n  constructor(options: WMTSDataSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  protected createOlSource(): olSourceWMTS {\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        tileGrid: createDefaultTileGrid(this.options.projection as string)\r\n      },\r\n      this.options\r\n    ) as Options;\r\n\r\n    return new olSourceWMTS(sourceOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceCarto from 'ol/source/CartoDB';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { CartoDataSourceOptions } from './carto-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class CartoDataSource extends DataSource {\r\n  public ol: olSourceCarto;\r\n  public options: CartoDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceCarto {\r\n    const crossOrigin = this.options.crossOrigin\r\n      ? this.options.crossOrigin\r\n      : 'anonymous';\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        crossOrigin\r\n      },\r\n      this.options\r\n    );\r\n    return new olSourceCarto(sourceOptions);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legend = super.getLegend();\r\n    if (legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    let htmlString = '<table>';\r\n    if (this.options.config.layers[0].legend !== null) {\r\n      this.options.config.layers[0].legend.items.forEach(f => {\r\n        if (f.visible === true) {\r\n          htmlString +=\r\n            '<tr><td>' +\r\n            '<p><font size=\"5\" color=\"' +\r\n            f.value +\r\n            '\"> &#9679</font></p></td>' +\r\n            '<td>' +\r\n            f.name +\r\n            '</td></tr>';\r\n        }\r\n      });\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    } else {\r\n      // Try to build the legend from the cartocss options\r\n      const layerOptions = this.options.config.layers[0].options;\r\n      // All available cartocss style options\r\n      const types = [\r\n        'polygon-fill:',\r\n        'marker-fill:',\r\n        'shield-fill:',\r\n        'building-fill:',\r\n        'line-color:'\r\n      ];\r\n      for (const oneType of types) {\r\n        if (layerOptions.cartocss.includes(oneType)) {\r\n          const type = layerOptions.cartocss.split(oneType).pop();\r\n          const color = type.substr(0, type.indexOf(';'));\r\n          if (color.includes('ramp')) {\r\n            const colors = color.split(', (')[1].split(',');\r\n            const data = color.split(', (')[2].split(',');\r\n            for (let j = 0; j < colors.length; j++) {\r\n              colors[j] = colors[j].replace(/(\"|\\))/g, '');\r\n              data[j] = data[j].replace(/(\"|\\))/g, '');\r\n              if (data[j].replace(/\\s+/g, '') === '=') {\r\n                data[j] = 'Autres';\r\n              }\r\n              htmlString +=\r\n                '<tr><td>' +\r\n                '<p><font size=\"5\" color=\"' +\r\n                colors[j] +\r\n                '\"> &#9679</font></p></td>' +\r\n                '<td>' +\r\n                data[j] +\r\n                '</td></tr>';\r\n            }\r\n            break;\r\n          } else {\r\n            const title = layerOptions.layer_name\r\n              ? layerOptions.layer_name\r\n              : '';\r\n            htmlString +=\r\n              '<tr><td>' +\r\n              '<p><font size=\"5\" color=\"' +\r\n              color +\r\n              '\"> &#9679</font></p>' +\r\n              '</td><td>' +\r\n              title +\r\n              '</td></tr>';\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    }\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport * as olloadingstrategy from 'ol/loadingstrategy';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestDataSourceOptions } from './arcgisrest-datasource.interface';\r\n\r\nexport class ArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public options: ArcGISRestDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const esrijsonFormat = new olFormatEsriJSON();\r\n    return new olSourceVector({\r\n      attributions: this.options.params.attributions,\r\n      overlaps: false,\r\n      format: esrijsonFormat,\r\n      url: function(extent, resolution, proj) {\r\n        const baseUrl = this.options.url + '/' + this.options.layer + '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        if (this.options.params.time) {\r\n          const time = `time=${this.options.params.time}`;\r\n          params.push(time);\r\n        }\r\n        if (this.options.params.customParams) {\r\n          this.options.params.customParams.forEach(element => {\r\n            params.push(element);\r\n          });\r\n        }\r\n        return `${baseUrl}?${params.join('&')}`;\r\n      }.bind(this),\r\n      strategy: olloadingstrategy.bbox\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n    let src: string;\r\n    let label: string;\r\n    let svg: string;\r\n\r\n    if (legendInfo.legend) {\r\n      for (const legendElement of legendInfo.legend) {\r\n        src = this.htmlImgSrc(legendElement.contentType, legendElement.imageData);\r\n        label = legendElement.label ? legendElement.label.replace('<Null>', 'Null') : '';\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      }\r\n    } else if (legendInfo.type === \"uniqueValue\") {\r\n      for (const legendElement of legendInfo.uniqueValueInfos) {\r\n        label = legendElement.label.replace('<Null>', 'Null');\r\n        if (legendElement.symbol.type === 'esriPMS') {\r\n          src = this.htmlImgSrc(legendElement.symbol.contentType, legendElement.symbol.imageData);\r\n          htmlString +=\r\n            `<tr><td align='left'><img src=\"` +\r\n            src +\r\n            `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n            label +\r\n            '</td></tr>';\r\n        } else if (legendElement.symbol.type !== 'esriPMS') {\r\n          svg = this.createSVG(legendElement.symbol);\r\n          htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n        }\r\n      }\r\n    } else if (legendInfo.type === \"simple\") {\r\n      label = legendInfo.label ? legendInfo.label.replace('<Null>', 'Null') : '';\r\n      if (legendInfo.symbol.type === 'esriPMS') {\r\n        src = this.htmlImgSrc(legendInfo.symbol.contentType, legendInfo.symbol.imageData);\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      } else if (legendInfo.symbol.type !== 'esriPMS') {\r\n        svg = this.createSVG(legendInfo.symbol);\r\n        htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n      }\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  htmlImgSrc(contentType: string, imageData: string): string {\r\n    return `data:${contentType};base64,${imageData}`;\r\n  }\r\n\r\n  createSVG(symbol): string {\r\n    let svg: string = '';\r\n\r\n    const color: Array<number> = symbol.color ? symbol.color : [0, 0, 0, 0];\r\n\r\n    if (symbol.type === 'esriSLS') {\r\n      const width: number = symbol.width ? symbol.width : 0;\r\n\r\n      const stroke: string = `stroke:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n      const strokeWidth: string = `stroke-width:` + width;\r\n\r\n      if (symbol.style === 'esriSLSSolid') {\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\"/></svg>`;\r\n      } else if (symbol.style === 'esriSLSDash') {\r\n        const strokeDashArray: string = `stroke-dasharray=\"5,5\"`;\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\" `+ strokeDashArray + `/></svg>`;\r\n      }\r\n    } else if (symbol.style === 'esriSMSCircle' || symbol.style === 'esriSFSSolid') {\r\n      const outlineColor = symbol.outline.color;\r\n      const outlineWidth = symbol.outline.width;\r\n      const size = symbol.size;\r\n\r\n      const stroke = `stroke:rgba(` + outlineColor[0] + ',' + outlineColor[1] + ',' + outlineColor[2] + ',' + outlineColor[3] + ')';\r\n      const strokeWidth = `stroke-width:` + outlineWidth;\r\n      const fill = `fill:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n\r\n      if (symbol.style === 'esriSMSCircle') {\r\n        svg = `<svg height=\"30\" width=\"30\"><circle cx=\"15\" cy=\"15\" r=\"` + size/2 + `\" style=\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      } else {\r\n        svg = `<svg height=\"30\" width=\"30\"><rect x=\"5\" y=\"5\" width=\"20\" height=\"20\" style =\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      }\r\n    }\r\n    return svg;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import ImageArcGISRest from 'ol/source/ImageArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestImageDataSourceOptions } from './imagearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nexport class ImageArcGISRestDataSource extends DataSource {\r\n  public ol: ImageArcGISRest;\r\n  public options: ArcGISRestImageDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): ImageArcGISRest {\r\n    const params = this.options.layer === undefined ? this.options.params : Object.assign(\r\n      {LAYERS: `show:${this.options.layer}`},\r\n      this.options.params\r\n    );\r\n\r\n    if (typeof params.renderingRule === 'object') {\r\n      params.renderingRule = JSON.stringify(params.renderingRule);\r\n    }\r\n\r\n    return new ImageArcGISRest({\r\n      ratio: 1,\r\n      params,\r\n      url: this.options.url\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceTileArcGISRest from 'ol/source/TileArcGISRest';\r\nimport { Options } from 'ol/source/TileArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { TileArcGISRestDataSourceOptions } from './tilearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class TileArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceTileArcGISRest;\r\n  public options: TileArcGISRestDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceTileArcGISRest {\r\n    return new olSourceTileArcGISRest(this.options as Options);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import TileDebug from 'ol/source/TileDebug';\r\nimport TileGrid from 'ol/tilegrid/TileGrid';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { TileDebugDataSourceOptions } from './tiledebug-datasource.interface';\r\n\r\nexport class TileDebugDataSource extends DataSource {\r\n  public options: TileDebugDataSourceOptions;\r\n  public ol: TileDebug;\r\n\r\n  protected createOlSource(): TileDebug {\r\n    const baseOptions = JSON.parse(JSON.stringify(this.options)); // to avoid to alter the original options\r\n    if (this.options.tileGrid) {\r\n      delete baseOptions.tileGrid;\r\n      baseOptions.tileGrid = new TileGrid(this.options.tileGrid);\r\n    }\r\n    return new TileDebug(baseOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { WebSocketDataSourceOptions } from './websocket-datasource.interface';\r\n\r\nexport class WebSocketDataSource extends FeatureDataSource {\r\n  public ws: WebSocket;\r\n  public options: WebSocketDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    this.createWebSocket();\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    return super.createOlSource();\r\n  }\r\n\r\n  private createWebSocket() {\r\n    this.ws = new WebSocket(this.options.url);\r\n    this.ws.onmessage = this.onMessage.bind(this);\r\n\r\n    if (this.options.onclose) {\r\n      this.ws.onclose = this.onClose.bind(this);\r\n    }\r\n\r\n    if (this.options.onerror) {\r\n      this.ws.onerror = this.onError.bind(this);\r\n    }\r\n\r\n    if (this.options.onopen) {\r\n      this.ws.onopen = this.onOpen.bind(this);\r\n    }\r\n  }\r\n\r\n  onMessage(event) {\r\n    const featureAdded = this.options.format.readFeature(event.data) as olFeature<OlGeometry>;\r\n\r\n    switch (this.options.onmessage) {\r\n      case 'update':\r\n        // ol don't add if same ID\r\n        const featureToRemove = this.ol.getFeatureById(featureAdded.getId());\r\n        if (featureToRemove) {\r\n          this.ol.removeFeature(featureToRemove);\r\n        }\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'delete':\r\n        this.ol.clear(true);\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'add':\r\n      default:\r\n        this.ol.addFeature(featureAdded);\r\n    }\r\n  }\r\n\r\n  onClose(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onError(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onOpen(event) {\r\n    // thrown message to user ?\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.ws.close();\r\n  }\r\n}\r\n","import { Md5 } from 'ts-md5';\r\nimport feature from 'ol/Feature';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\nimport olFormatMVT from 'ol/format/MVT';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { MVTDataSourceOptions } from './mvt-datasource.interface';\r\n\r\nexport class MVTDataSource extends DataSource {\r\n  public options: MVTDataSourceOptions;\r\n  public ol: olSourceVectorTile;\r\n\r\n  protected createOlSource(): olSourceVectorTile {\r\n    let mvtFormat;\r\n    if (this.options.featureClass === 'feature') {\r\n      mvtFormat = new olFormatMVT({featureClass: feature});\r\n    } else {\r\n      mvtFormat = new olFormatMVT();\r\n    }\r\n    this.options.format = mvtFormat;\r\n    return new olSourceVectorTile(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    if (!this.options.url) {\r\n        return uuid();\r\n    }\r\n    const chain = 'mvt' + this.options.url;\r\n    return Md5.hashStr(chain) as string;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport class EsriStyleGenerator {\r\n  public _converters: any;\r\n  public _renderers: any;\r\n\r\n  constructor() {\r\n    this._converters = {};\r\n    this._converters.esriPMS = EsriStyleGenerator._convertEsriPMS;\r\n    this._converters.esriSFS = EsriStyleGenerator._convertEsriSFS;\r\n    this._converters.esriSLS = EsriStyleGenerator._convertEsriSLS;\r\n    this._converters.esriSMS = EsriStyleGenerator._convertEsriSMS;\r\n    this._converters.esriTS = EsriStyleGenerator._convertEsriTS;\r\n    this._renderers = {};\r\n    this._renderers.uniqueValue = this._renderUniqueValue;\r\n    this._renderers.simple = this._renderSimple;\r\n    this._renderers.classBreaks = this._renderClassBreaks;\r\n  }\r\n  static _convertPointToPixel(point) {\r\n    return point / 0.75;\r\n  }\r\n  static _transformColor(color): [number, number, number, number] {\r\n    // alpha channel is different, runs from 0-255 but in ol3 from 0-1\r\n    return [color[0], color[1], color[2], color[3] / 255];\r\n  }\r\n\r\n  static _getResolutionForScale(scale, units) {\r\n    const dpi = 96;\r\n    const mpu = olproj.METERS_PER_UNIT[units];\r\n    const inchesPerMeter = 39.3701;\r\n    return parseFloat(scale) / (mpu * inchesPerMeter * dpi);\r\n  }\r\n\r\n  /* convert an Esri Text Symbol */\r\n  static _convertEsriTS(symbol) {\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    const text = symbol.text !== undefined ? symbol.text : undefined;\r\n    return new olstyle.Style({\r\n      text: new olstyle.Text({\r\n        fill: new olstyle.Fill({\r\n          color: EsriStyleGenerator._transformColor(symbol.color)\r\n        }),\r\n        font:\r\n          symbol.font.style +\r\n          ' ' +\r\n          symbol.font.weight +\r\n          ' ' +\r\n          symbol.font.size +\r\n          ' px ' +\r\n          symbol.font.family,\r\n        textBaseline: symbol.verticalAlignment,\r\n        textAlign: symbol.horizontalAlignment,\r\n        offsetX: EsriStyleGenerator._convertPointToPixel(symbol.xoffset),\r\n        offsetY: EsriStyleGenerator._convertPointToPixel(symbol.yoffset),\r\n        rotation,\r\n        text\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Picture Marker Symbol */\r\n  static _convertEsriPMS(symbol) {\r\n    const src = 'data:' + symbol.contentType + ';base64, ' + symbol.imageData;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src,\r\n        rotation\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Simple Fill Symbol */\r\n  static _convertEsriSFS(symbol) {\r\n    // there is no support in openlayers currently for fill patterns, so style is not interpreted\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    return new olstyle.Style({\r\n      fill,\r\n      stroke\r\n    });\r\n  }\r\n  static _convertOutline(outline) {\r\n    let lineDash;\r\n    const color = EsriStyleGenerator._transformColor(outline.color);\r\n    if (outline.style === 'esriSLSDash') {\r\n      lineDash = [5];\r\n    } else if (outline.style === 'esriSLSDashDot') {\r\n      lineDash = [5, 5, 1, 2];\r\n    } else if (outline.style === 'esriSLSDashDotDot') {\r\n      lineDash = [5, 5, 1, 2, 1, 2];\r\n    } else if (outline.style === 'esriSLSDot') {\r\n      lineDash = [1, 2];\r\n    } else if (outline.style === 'esriSLSNull') {\r\n      // line not visible, make color fully transparent\r\n      color[3] = 0;\r\n    }\r\n    return new olstyle.Stroke({\r\n      color,\r\n      lineDash,\r\n      width: EsriStyleGenerator._convertPointToPixel(outline.width)\r\n    });\r\n  }\r\n  /* convert an Esri Simple Line Symbol */\r\n  static _convertEsriSLS(symbol) {\r\n    return new olstyle.Style({\r\n      stroke: EsriStyleGenerator._convertOutline(symbol)\r\n    });\r\n  }\r\n  static _transformAngle(angle) {\r\n    if (angle === 0 || angle === undefined) {\r\n      return undefined;\r\n    }\r\n    const normalRad = (angle * Math.PI) / 180;\r\n    const ol3Rad = -normalRad + Math.PI / 2;\r\n    if (ol3Rad < 0) {\r\n      return 2 * Math.PI + ol3Rad;\r\n    } else {\r\n      return ol3Rad;\r\n    }\r\n  }\r\n  /* convert an Esri Simple Marker Symbol */\r\n  static _convertEsriSMS(symbol) {\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    const radius = EsriStyleGenerator._convertPointToPixel(symbol.size) / 2;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    if (symbol.style === 'esriSMSCircle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.Circle({\r\n          radius,\r\n          fill,\r\n          stroke\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSCross') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSDiamond') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSSquare') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSX') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSTriangle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 3,\r\n          radius,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    }\r\n  }\r\n\r\n  _convertLabelingInfo(labelingInfo, mapUnits) {\r\n    const styles = [];\r\n    for (let i = 0, ii = labelingInfo.length; i < ii; ++i) {\r\n      const labelExpression = labelingInfo[i].labelExpression;\r\n      // only limited support for label expressions\r\n      const field = labelExpression.substr(\r\n        labelExpression.indexOf('[') + 1,\r\n        labelExpression.indexOf(']') - 1\r\n      );\r\n      const symbol = labelingInfo[i].symbol;\r\n      const maxScale = labelingInfo[i].maxScale;\r\n      const minScale = labelingInfo[i].minScale;\r\n      let minResolution = null;\r\n      if (maxScale !== 0) {\r\n        minResolution = EsriStyleGenerator._getResolutionForScale(\r\n          maxScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      let maxResolution = null;\r\n      if (minScale !== 0) {\r\n        maxResolution = EsriStyleGenerator._getResolutionForScale(\r\n          minScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      styles.push(\r\n        (() => {\r\n          return function(feature, resolution) {\r\n            let visible = true;\r\n            if (this.minResolution !== null && this.maxResolution !== null) {\r\n              visible =\r\n                resolution < this.maxResolution &&\r\n                resolution >= this.minResolution;\r\n            } else if (this.minResolution !== null) {\r\n              visible = resolution >= this.minResolution;\r\n            } else if (this.maxResolution !== null) {\r\n              visible = resolution < this.maxResolution;\r\n            }\r\n            if (visible) {\r\n              const value = feature.get(this.field);\r\n              this.style.getText().setText(value);\r\n              return [this.style];\r\n            }\r\n          };\r\n        })().bind({\r\n          minResolution,\r\n          maxResolution,\r\n          field,\r\n          style\r\n        })\r\n      );\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  _renderSimple(renderer) {\r\n    const style = this._converters[renderer.symbol.type].call(\r\n      this,\r\n      renderer.symbol\r\n    );\r\n    return (() => {\r\n      return () => {\r\n        return [style];\r\n      };\r\n    })();\r\n  }\r\n  _renderClassBreaks(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    const defaultStyle = this._converters[defaultSymbol.type].call(\r\n      this,\r\n      defaultSymbol\r\n    );\r\n    const field = renderer.field;\r\n    const classes = [];\r\n    for (let i = 0, ii = renderer.classBreakInfos.length; i < ii; ++i) {\r\n      const classBreakInfo = renderer.classBreakInfos[i];\r\n      let min;\r\n      if (\r\n        classBreakInfo.classMinValue === null ||\r\n        classBreakInfo.classMinValue === undefined\r\n      ) {\r\n        if (i === 0) {\r\n          min = renderer.minValue;\r\n        } else {\r\n          min = renderer.classBreakInfos[i - 1].classMaxValue;\r\n        }\r\n      } else {\r\n        min = classBreakInfo.classMinValue;\r\n      }\r\n      const max = classBreakInfo.classMaxValue;\r\n      const symbol = classBreakInfo.symbol;\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      classes.push({ min, max, style });\r\n    }\r\n    return (() => {\r\n      return (feature) => {\r\n        const value = feature.get(field);\r\n        for (let i = 0, ii = classes.length; i < ii; ++i) {\r\n          let condition;\r\n          if (i === 0) {\r\n            condition = value >= classes[i].min && value <= classes[i].max;\r\n          } else {\r\n            condition = value > classes[i].min && value <= classes[i].max;\r\n          }\r\n          if (condition) {\r\n            return [classes[i].style];\r\n          }\r\n        }\r\n        return [defaultStyle];\r\n      };\r\n    })();\r\n  }\r\n  _renderUniqueValue(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    let defaultStyle = [];\r\n    if (defaultSymbol) {\r\n      defaultStyle = [\r\n        this._converters[defaultSymbol.type].call(this, defaultSymbol)\r\n      ];\r\n    }\r\n    const field = renderer.field1;\r\n    const infos = renderer.uniqueValueInfos;\r\n    const me = this;\r\n    return (() => {\r\n      const hash = {};\r\n      for (let i = 0, ii = infos.length; i < ii; ++i) {\r\n        const info = infos[i];\r\n        const symbol = info.symbol;\r\n        hash[info.value] = [me._converters[symbol.type].call(me, symbol)];\r\n      }\r\n\r\n      return (feature) => {\r\n        const style = hash[feature.get(field)];\r\n        return style ? style : defaultStyle;\r\n      };\r\n    })();\r\n  }\r\n  generateStyle(layerInfo, mapUnits) {\r\n    const drawingInfo = layerInfo.drawingInfo;\r\n    let styleFunctions = [];\r\n    const drawingInfoStyle = this._renderers[drawingInfo.renderer.type].call(\r\n      this,\r\n      drawingInfo.renderer\r\n    );\r\n    if (drawingInfoStyle !== undefined) {\r\n      styleFunctions.push(drawingInfoStyle);\r\n    }\r\n    if (layerInfo.labelingInfo) {\r\n      const labelingInfoStyleFunctions = this._convertLabelingInfo(\r\n        layerInfo.labelingInfo,\r\n        mapUnits\r\n      );\r\n      styleFunctions = styleFunctions.concat(labelingInfoStyleFunctions);\r\n    }\r\n    if (styleFunctions.length === 1) {\r\n      return styleFunctions[0];\r\n    } else {\r\n      return (() => {\r\n        return (feature, resolution) => {\r\n          let styles = [];\r\n          for (let i = 0, ii = styleFunctions.length; i < ii; ++i) {\r\n            const result = styleFunctions[i].call(null, feature, resolution);\r\n            if (result) {\r\n              styles = styles.concat(result);\r\n            }\r\n          }\r\n          return styles;\r\n        };\r\n      })();\r\n    }\r\n  }\r\n}\r\n","export enum TimeFilterType {\r\n    DATE = 'date',\r\n    TIME = 'time',\r\n    DATETIME = 'datetime',\r\n    YEAR = 'year',\r\n}\r\n\r\nexport enum TimeFilterStyle {\r\n    CALENDAR = 'calendar',\r\n    SLIDER = 'slider',\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { IgoMap } from './map';\r\n\r\n/**\r\n * MapService\r\n *\r\n * This service tracks the IgoMap instance, if any.\r\n * Currently, only one map instance is supported\r\n * but support for multiple maps may be added in the future.\r\n * This will impact other services such as the OverlayService\r\n * because these maps won't be sharing overlayed features.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MapService {\r\n  private map: IgoMap;\r\n\r\n  constructor() {}\r\n\r\n  getMap(): IgoMap {\r\n    return this.map;\r\n  }\r\n\r\n  setMap(map: IgoMap) {\r\n    this.map = map;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpClient,\r\n  HttpParams\r\n} from '@angular/common/http';\r\nimport { Observable, forkJoin, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { WMSCapabilities, WMTSCapabilities, EsriJSON } from 'ol/format';\r\nimport { optionsFromCapabilities } from 'ol/source/WMTS.js';\r\nimport olAttribution from 'ol/control/Attribution';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\nimport { EsriStyleGenerator } from '../../style/shared/datasource/esri-style-generator';\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType\r\n} from '../../query/shared/query.enums';\r\n\r\nimport {\r\n  WMTSDataSourceOptions,\r\n  WMSDataSourceOptions,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions,\r\n  ArcGISRestImageDataSourceOptions\r\n} from './datasources';\r\nimport {\r\n  LegendOptions,\r\n  ItemStyleOptions\r\n} from '../../layer/shared/layers/layer.interface';\r\nimport {\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '../../filter/shared/time-filter.enum';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport enum TypeCapabilities {\r\n  wms = 'wms',\r\n  wmts = 'wmts',\r\n  arcgisrest = 'esriJSON',\r\n  imagearcgisrest = 'esriJSON',\r\n  tilearcgisrest = 'esriJSON'\r\n}\r\n\r\nexport type TypeCapabilitiesStrings = keyof typeof TypeCapabilities;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CapabilitiesService {\r\n  private parsers = {\r\n    wms: new WMSCapabilities(),\r\n    wmts: new WMTSCapabilities(),\r\n    esriJSON: new EsriJSON()\r\n  };\r\n\r\n  constructor(private http: HttpClient, private mapService: MapService) {}\r\n\r\n  getWMSOptions(\r\n    baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = (baseOptions.params as any).VERSION;\r\n\r\n    return this.getCapabilities('wms', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n  }\r\n\r\n  getWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = baseOptions.version;\r\n\r\n    const options = this.getCapabilities('wmts', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMTSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n    return options;\r\n  }\r\n\r\n  getCartoOptions(\r\n    baseOptions: CartoDataSourceOptions\r\n  ): Observable<CartoDataSourceOptions> {\r\n    const baseUrl =\r\n      'https://' +\r\n      baseOptions.account +\r\n      '.carto.com/api/v2/viz/' +\r\n      baseOptions.mapId +\r\n      '/viz.json';\r\n\r\n    return this.http\r\n      .jsonp(baseUrl, 'callback')\r\n      .pipe(\r\n        map((cartoOptions: any) =>\r\n          this.parseCartoOptions(baseOptions, cartoOptions)\r\n        )\r\n      );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const serviceCapabilities = this.getCapabilities('arcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    return forkJoin([arcgisOptions, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseArcgisOptions(baseOptions, res[0], res[1]);\r\n      })\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getImageArcgisOptions(\r\n    baseOptions: ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('imagearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Image Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2]);\r\n      })\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getTileArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('tilearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legendInfo = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Tile Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legendInfo, serviceCapabilities]).pipe(\r\n      map((res: any) =>\r\n        this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2])\r\n      )\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getCapabilities(\r\n    service: TypeCapabilitiesStrings,\r\n    baseUrl: string,\r\n    version?: string\r\n  ): Observable<any> {\r\n    const params = new HttpParams({\r\n      fromObject: {\r\n        request: 'GetCapabilities',\r\n        service: service.toUpperCase(),\r\n        version: version || '1.3.0',\r\n        _i: 'true'\r\n      }\r\n    });\r\n\r\n    let request;\r\n    if (TypeCapabilities[service] === 'esriJSON') {\r\n      request = this.http.get(baseUrl + '?f=json');\r\n    } else {\r\n      request = this.http.get(baseUrl, {\r\n        params,\r\n        responseType: 'text'\r\n      });\r\n    }\r\n\r\n    return request.pipe(\r\n      map((res) => {\r\n        if (TypeCapabilities[service] === 'esriJSON') {\r\n          return res as object;\r\n        }\r\n        if (\r\n          String(res).toLowerCase().includes('serviceexception') &&\r\n          String(res).toLowerCase().includes('access denied')\r\n        ) {\r\n          throw {\r\n            error: {\r\n              message: 'Service error getCapabilities: Access is denied'\r\n            }\r\n          };\r\n        } else {\r\n          return this.parsers[service].read(res);\r\n        }\r\n      }),\r\n      catchError((e) => {\r\n        if (typeof e.error !== 'undefined') {\r\n          e.error.caught = true;\r\n        }\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  private parseWMSOptions(\r\n    baseOptions: WMSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMSDataSourceOptions {\r\n    const layers = (baseOptions.params as any).LAYERS;\r\n    const layer = this.findDataSourceInCapabilities(\r\n      capabilities.Capability.Layer,\r\n      layers\r\n    );\r\n\r\n    if (!layer) {\r\n      throw {\r\n        error: {\r\n          message: 'Layer not found'\r\n        }\r\n      };\r\n    }\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const abstract = layer.Abstract ? layer.Abstract : undefined;\r\n    const keywordList = layer.KeywordList ? layer.KeywordList : undefined;\r\n    let queryable = layer.queryable;\r\n    const timeFilter = this.getTimeFilter(layer);\r\n    const timeFilterable = timeFilter && Object.keys(timeFilter).length > 0;\r\n    const legendOptions = layer.Style ? this.getStyle(layer.Style) : undefined;\r\n    let isExtentInGeographic = true;\r\n    if (layer.EX_GeographicBoundingBox) {\r\n      layer.EX_GeographicBoundingBox.forEach((coord, index) => {\r\n        if (index < 2 && (coord > 180 || coord < -180)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n        if (index >= 2 && (coord > 90 || coord < -90)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n      });\r\n    } else {\r\n      isExtentInGeographic = false;\r\n    }\r\n\r\n    const extent = isExtentInGeographic ?\r\n        olproj.transformExtent(layer.EX_GeographicBoundingBox, 'EPSG:4326', this.mapService.getMap().projection) :\r\n        undefined;\r\n\r\n    let queryFormat: QueryFormat;\r\n    const queryFormatMimeTypePriority = [\r\n      QueryFormatMimeType.GEOJSON,\r\n      QueryFormatMimeType.GEOJSON2,\r\n      QueryFormatMimeType.GML3,\r\n      QueryFormatMimeType.GML2,\r\n      QueryFormatMimeType.JSON,\r\n      QueryFormatMimeType.HTML\r\n    ];\r\n\r\n    for (const mimeType of queryFormatMimeTypePriority) {\r\n      if (\r\n        capabilities.Capability.Request.GetFeatureInfo.Format.indexOf(\r\n          mimeType\r\n        ) !== -1\r\n      ) {\r\n        const keyEnum = Object.keys(QueryFormatMimeType).find(\r\n          (key) => QueryFormatMimeType[key] === mimeType\r\n        );\r\n        queryFormat = QueryFormat[keyEnum];\r\n        break;\r\n      }\r\n    }\r\n    if (!queryFormat) {\r\n      queryable = false;\r\n    }\r\n\r\n    const options: WMSDataSourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title,\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        extent,\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined,\r\n          abstract,\r\n          keywordList\r\n        },\r\n        legendOptions\r\n      },\r\n      queryable,\r\n      queryFormat,\r\n      timeFilter: timeFilterable ? timeFilter : undefined,\r\n      timeFilterable: timeFilterable ? true : undefined,\r\n      minDate: timeFilterable ? timeFilter.min : undefined,\r\n      maxDate: timeFilterable ? timeFilter.max : undefined,\r\n      stepDate: timeFilterable ? timeFilter.step : undefined\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMTSDataSourceOptions {\r\n    // Put Title source in _layerOptionsFromSource. (For source & catalog in _layerOptionsFromSource, if not already on config)\r\n    const layer = capabilities.Contents.Layer.find(\r\n      (el) => el.Identifier === baseOptions.layer\r\n    );\r\n\r\n    const options = optionsFromCapabilities(capabilities, baseOptions);\r\n\r\n    const ouputOptions = Object.assign(options, baseOptions);\r\n    const sourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title\r\n      }\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(sourceOptions, ouputOptions);\r\n  }\r\n\r\n  private parseCartoOptions(\r\n    baseOptions: CartoDataSourceOptions,\r\n    cartoOptions: any\r\n  ): CartoDataSourceOptions {\r\n    const layers = [];\r\n    const params = cartoOptions.layers[1].options.layer_definition;\r\n    params.layers.forEach((element) => {\r\n      layers.push({\r\n        type: element.type.toLowerCase(),\r\n        options: element.options,\r\n        legend: element.legend\r\n      });\r\n    });\r\n    const options = ObjectUtils.removeUndefined({\r\n      config: {\r\n        version: params.version,\r\n        layers\r\n      }\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions,\r\n    arcgisOptions: any,\r\n    serviceCapabilities: any,\r\n  ): ArcGISRestDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    let legendInfo: any;\r\n\r\n    if (arcgisOptions.drawingInfo?.renderer) {\r\n      legendInfo = arcgisOptions.drawingInfo.renderer;\r\n    } else {\r\n      legendInfo = undefined;\r\n    }\r\n\r\n    let style;\r\n    if (arcgisOptions.drawingInfo) {\r\n      const styleGenerator = new EsriStyleGenerator();\r\n      const units = arcgisOptions.units === 'esriMeters' ? 'm' : 'degrees';\r\n      style = styleGenerator.generateStyle(arcgisOptions, units);\r\n    }\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        style,\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseTileOrImageArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any,\r\n    serviceCapabilities: any\r\n  ): TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    const legendInfo = legend.layers ? legend.layers.find(x => x.layerName === title) : undefined;\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private findDataSourceInCapabilities(layerArray, name): any {\r\n    if (Array.isArray(layerArray)) {\r\n      let layer;\r\n      layerArray.find((value) => {\r\n        layer = this.findDataSourceInCapabilities(value, name);\r\n        return layer !== undefined;\r\n      }, this);\r\n\r\n      return layer;\r\n    } else if (layerArray.Layer) {\r\n      return this.findDataSourceInCapabilities(layerArray.Layer, name);\r\n    } else {\r\n      if (layerArray.Name && layerArray.Name === name) {\r\n        return layerArray;\r\n      }\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  getTimeFilter(layer) {\r\n    let dimension;\r\n\r\n    if (layer.Dimension) {\r\n      const timeFilter: any = {};\r\n      dimension = layer.Dimension[0];\r\n\r\n      if (dimension.values) {\r\n        const minMaxDim = dimension.values.split('/');\r\n        timeFilter.min = minMaxDim[0] !== undefined ? minMaxDim[0] : undefined;\r\n        timeFilter.max = minMaxDim[1] !== undefined ? minMaxDim[1] : undefined;\r\n        timeFilter.step = minMaxDim[2] !== undefined ? minMaxDim[2] : undefined;\r\n      }\r\n\r\n      if (dimension.default) {\r\n        timeFilter.value = dimension.default;\r\n      }\r\n      return timeFilter;\r\n    }\r\n  }\r\n\r\n  getStyle(Style): LegendOptions {\r\n    const styleOptions: ItemStyleOptions[] = Style.map((style) => {\r\n      return {\r\n        name: style.Name,\r\n        title: style.Title\r\n      };\r\n    })\r\n      // Handle repeat the style \"default\" in output  (MapServer or OpenLayer)\r\n      .filter(\r\n        (item, index, self) =>\r\n          self.findIndex((i: ItemStyleOptions) => i.name === item.name) ===\r\n          index\r\n      );\r\n\r\n    const legendOptions: LegendOptions = {\r\n      stylesAvailable: styleOptions\r\n    } as LegendOptions;\r\n\r\n    return legendOptions;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport {\r\n  ArcGISRestDataSourceOptions,\r\n  ArcGISRestImageDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions,\r\n  WMSDataSourceOptions\r\n} from '../datasources';\r\n\r\nexport abstract class OptionsService {\r\n  abstract getWMSOptions(\r\n    _baseOptions: WMSDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<WMSDataSourceOptions>;\r\n  abstract getArcgisRestOptions(\r\n    _baseOptions: ArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions>;\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport proj4 from 'proj4';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * When injected, this service automatically registers and\r\n * projection defined in the application config. A custom projection\r\n * needs to be registered to be usable by OL.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ProjectionService {\r\n\r\n  constructor(private config: ConfigService) {\r\n    const projections = this.config.getConfig('projections') || [];\r\n    projections.forEach((projection: Projection) => {\r\n      projection.alias = projection.alias ? projection.alias : projection.code;\r\n      this.registerProjection(projection);\r\n    });\r\n\r\n    // register all utm zones\r\n    for (let utmZone = 1; utmZone < 61; utmZone++) {\r\n      const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n      const def = `+proj=utm +zone=${utmZone} +datum=WGS84 +units=m +no_defs`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n\r\n    // register all mtm zones\r\n    for (let mtmZone = 1; mtmZone < 11; mtmZone++) {\r\n      const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n      let lon0;\r\n      if (Number(mtmZone) <= 2) {\r\n        lon0 = -50 - Number(mtmZone) * 3;\r\n      } else if (Number(mtmZone) >= 12) {\r\n        lon0 = -81 - (Number(mtmZone) - 12) * 3;\r\n      } else {\r\n        lon0 = -49.5 - Number(mtmZone) * 3;\r\n      }\r\n      const def = `+proj=tmerc +lat_0=0 +lon_0=${lon0} +k=0.9999 +x_0=304800 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs\"`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define a proj4 projection and register it in OL\r\n   * @param projection Projection\r\n   */\r\n  registerProjection(projection: Projection) {\r\n    proj4.defs(projection.code, projection.def);\r\n    olproj4.register(proj4);\r\n    if (projection.extent) {\r\n      olproj.get(projection.code).setExtent(projection.extent);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { forkJoin, of, Observable, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { CapabilitiesService } from './capabilities.service';\r\nimport { OptionsService } from './options/options.service';\r\nimport { WFSService } from './datasources/wfs.service';\r\nimport {\r\n  DataSource,\r\n  OSMDataSource,\r\n  OSMDataSourceOptions,\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  XYZDataSource,\r\n  XYZDataSourceOptions,\r\n  TileDebugDataSource,\r\n  TileDebugDataSourceOptions,\r\n  WFSDataSource,\r\n  WFSDataSourceOptions,\r\n  WMTSDataSource,\r\n  WMTSDataSourceOptions,\r\n  WMSDataSource,\r\n  WMSDataSourceOptions,\r\n  CartoDataSource,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSource,\r\n  ArcGISRestDataSourceOptions,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestImageDataSourceOptions,\r\n  TileArcGISRestDataSource,\r\n  TileArcGISRestDataSourceOptions,\r\n  WebSocketDataSource,\r\n  AnyDataSourceOptions,\r\n  MVTDataSource,\r\n  MVTDataSourceOptions,\r\n  ClusterDataSource,\r\n  ClusterDataSourceOptions\r\n} from './datasources';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ProjectionService } from '../../map/shared/projection.service';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DataSourceService {\r\n  public datasources$ = new BehaviorSubject<DataSource[]>([]);\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    @Optional() private optionsService: OptionsService,\r\n    private wfsDataSourceService: WFSService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private projectionService: ProjectionService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {}\r\n\r\n  createAsyncDataSource(context: AnyDataSourceOptions, detailedContextUri?: string): Observable<DataSource> {\r\n    if (!context.type) {\r\n      console.error(context);\r\n      throw new Error('Datasource needs a type');\r\n    }\r\n    let dataSource;\r\n    switch (context.type.toLowerCase()) {\r\n      case 'osm':\r\n        dataSource = this.createOSMDataSource(context as OSMDataSourceOptions);\r\n        break;\r\n      case 'vector':\r\n        dataSource = this.createFeatureDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'wfs':\r\n        dataSource = this.createWFSDataSource(context as WFSDataSourceOptions);\r\n        break;\r\n      case 'wms':\r\n        const wmsContext = context as WMSDataSourceOptions;\r\n        ObjectUtils.removeDuplicateCaseInsensitive(wmsContext.params);\r\n        dataSource = this.createWMSDataSource(wmsContext, detailedContextUri);\r\n        break;\r\n      case 'wmts':\r\n        dataSource = this.createWMTSDataSource(\r\n          context as WMTSDataSourceOptions\r\n        );\r\n        break;\r\n      case 'xyz':\r\n        dataSource = this.createXYZDataSource(context as XYZDataSourceOptions);\r\n        break;\r\n      case 'tiledebug':\r\n        dataSource = this.createTileDebugDataSource(context as TileDebugDataSource);\r\n        break;\r\n      case 'carto':\r\n        dataSource = this.createCartoDataSource(\r\n          context as CartoDataSourceOptions\r\n        );\r\n        break;\r\n      case 'arcgisrest':\r\n        dataSource = this.createArcGISRestDataSource(\r\n          context as ArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'imagearcgisrest':\r\n        dataSource = this.createArcGISRestImageDataSource(\r\n          context as ArcGISRestImageDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'websocket':\r\n        dataSource = this.createWebSocketDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'mvt':\r\n        dataSource = this.createMVTDataSource(context as MVTDataSourceOptions);\r\n        break;\r\n      case 'tilearcgisrest':\r\n        dataSource = this.createTileArcGISRestDataSource(\r\n          context as TileArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'cluster':\r\n        dataSource = this.createClusterDataSource(\r\n          context as ClusterDataSourceOptions\r\n        );\r\n        break;\r\n      default:\r\n        console.error(context);\r\n        throw new Error('Invalid datasource type');\r\n    }\r\n\r\n    this.datasources$.next(this.datasources$.value.concat([dataSource]));\r\n\r\n    return dataSource;\r\n  }\r\n\r\n  private createOSMDataSource(\r\n    context: OSMDataSourceOptions\r\n  ): Observable<OSMDataSource> {\r\n    return new Observable(d => d.next(new OSMDataSource(context)));\r\n  }\r\n\r\n  private createFeatureDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<FeatureDataSource> {\r\n    return new Observable(d => d.next(new FeatureDataSource(context)));\r\n  }\r\n\r\n  private createWebSocketDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<WebSocketDataSource> {\r\n    return new Observable(d => d.next(new WebSocketDataSource(context)));\r\n  }\r\n\r\n  private createWFSDataSource(\r\n    context: WFSDataSourceOptions\r\n  ): Observable<WFSDataSource> {\r\n    return new Observable(d =>\r\n      d.next(new WFSDataSource(context, this.wfsDataSourceService, this.authInterceptor))\r\n    );\r\n  }\r\n\r\n  private createWMSDataSource(context: WMSDataSourceOptions, detailedContextUri?: string): Observable<any> {\r\n    const observables = [];\r\n    if (context.optionsFromCapabilities && window.navigator.onLine) {\r\n      observables.push(\r\n        this.capabilitiesService.getWMSOptions(context).pipe(\r\n          catchError(e => {\r\n            this.messageService.error(\r\n              'igo.geo.dataSource.unavailable',\r\n              'igo.geo.dataSource.unavailableTitle',\r\n              undefined,\r\n              { value: context.params.LAYERS });\r\n            throw e;\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    if (this.optionsService && context.optionsFromApi && window.navigator.onLine) {\r\n      observables.push(\r\n        this.optionsService.getWMSOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    observables.push(of(context));\r\n\r\n    return forkJoin(observables).pipe(\r\n      map((options: WMSDataSourceOptions[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new WMSDataSource(optionsMerged, this.wfsDataSourceService);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createWMTSDataSource(\r\n    context: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSource> {\r\n    if (context.optionsFromCapabilities && window.navigator.onLine) {\r\n      return this.capabilitiesService.getWMTSOptions(context).pipe(\r\n        map((options: WMTSDataSourceOptions) => {\r\n          return options ? new WMTSDataSource(options) : undefined;\r\n        }),\r\n        catchError(() => {\r\n          this.messageService.error(\r\n            'igo.geo.dataSource.unavailable',\r\n            'igo.geo.dataSource.unavailableTitle',\r\n            undefined,\r\n            { value: context.layer });\r\n          return of(undefined);\r\n        })\r\n      );\r\n    }\r\n\r\n    return new Observable(d => d.next(new WMTSDataSource(context)));\r\n  }\r\n\r\n  private createXYZDataSource(\r\n    context: XYZDataSourceOptions\r\n  ): Observable<XYZDataSource> {\r\n    return new Observable(d => d.next(new XYZDataSource(context)));\r\n  }\r\n\r\n  private createTileDebugDataSource(\r\n    context: TileDebugDataSourceOptions\r\n  ): Observable<TileDebugDataSource> {\r\n    return new Observable(d => d.next(new TileDebugDataSource(context)));\r\n  }\r\n\r\n  private createCartoDataSource(\r\n    context: CartoDataSourceOptions\r\n  ): Observable<CartoDataSource> {\r\n    if (context.mapId) {\r\n      return this.capabilitiesService\r\n        .getCartoOptions(context)\r\n        .pipe(\r\n          map((options: CartoDataSourceOptions) => new CartoDataSource(options))\r\n        );\r\n    }\r\n    return new Observable(d => d.next(new CartoDataSource(context)));\r\n  }\r\n\r\n  private createArcGISRestDataSource(\r\n    context: ArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestDataSource> {\r\n    const observables = [];\r\n    if (window.navigator.onLine) {\r\n      observables.push(this.capabilitiesService.getArcgisOptions(context).pipe(\r\n        catchError(e => {\r\n          this.messageService.error(\r\n            'igo.geo.dataSource.unavailable',\r\n            'igo.geo.dataSource.unavailableTitle',\r\n            undefined,\r\n            { value: context.layer });\r\n          throw e;\r\n        })\r\n      ));\r\n    }\r\n    if (this.optionsService && context.optionsFromApi && window.navigator.onLine) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createArcGISRestImageDataSource(\r\n    context: ArcGISRestImageDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestImageDataSourceOptions> {\r\n    const observables = [];\r\n\r\n    if (window.navigator.onLine) {\r\n      observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n        catchError(e => {\r\n          this.messageService.error(\r\n            'igo.geo.dataSource.unavailable',\r\n            'igo.geo.dataSource.unavailableTitle',\r\n            undefined,\r\n            { value: context.params.LAYERS });\r\n          throw e;\r\n        })\r\n      ));\r\n    }\r\n    if (this.optionsService && context.optionsFromApi && window.navigator.onLine) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ImageArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ImageArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createTileArcGISRestDataSource(\r\n    context: TileArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<TileArcGISRestDataSource> {\r\n    const observables = [];\r\n    if (window.navigator.onLine) {\r\n      observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n        catchError(e => {\r\n          this.messageService.error(\r\n            'igo.geo.dataSource.unavailable',\r\n            'igo.geo.dataSource.unavailableTitle',\r\n            undefined,\r\n            { value: context.params.LAYERS });\r\n          throw e;\r\n        })\r\n      ));\r\n    }\r\n    if (this.optionsService && context.optionsFromApi && window.navigator.onLine) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: TileArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new TileArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createMVTDataSource(\r\n    context: MVTDataSourceOptions\r\n  ): Observable<MVTDataSource> {\r\n    return new Observable(d => d.next(new MVTDataSource(context)));\r\n  }\r\n\r\n  private createClusterDataSource(\r\n    context: ClusterDataSourceOptions\r\n  ): Observable<ClusterDataSource> {\r\n    return new Observable(d => d.next(new ClusterDataSource(context)));\r\n  }\r\n}\r\n","import * as olextent from 'ol/extent';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { GeometryLayout } from 'ol/geom/Geometry';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport {\r\n  EntityKey,\r\n  getEntityId,\r\n  getEntityTitle,\r\n  getEntityRevision,\r\n  getEntityIcon,\r\n  getEntityProperty\r\n} from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { FEATURE, FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureGeometry } from './feature.interfaces';\r\nimport { FeatureStore } from './store';\r\n\r\n/**\r\n * Create an Openlayers feature object out of a feature definition.\r\n * The output object has a reference to the feature id.\r\n * @param feature Feature definition\r\n * @param projectionOut Feature object projection\r\n * @returns OpenLayers feature object\r\n */\r\nexport function featureToOl(\r\n  feature: Feature,\r\n  projectionOut: string,\r\n  getId?: (Feature) => EntityKey\r\n): OlFeature<OlGeometry> {\r\n  getId = getId ? getId : getEntityId;\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const olFeature = olFormat.readFeature(feature, {\r\n    dataProjection: feature.projection,\r\n    featureProjection: projectionOut\r\n  });\r\n\r\n  olFeature.setId(getId(feature));\r\n\r\n  const title = getEntityTitle(feature);\r\n  if (title !== undefined) {\r\n    olFeature.set('_title', title, true);\r\n  }\r\n\r\n  if (feature.extent !== undefined) {\r\n    olFeature.set('_extent', feature.extent, true);\r\n  }\r\n\r\n  if (feature.projection !== undefined) {\r\n    olFeature.set('_projection', feature.projection, true);\r\n  }\r\n\r\n  const mapTitle = getEntityProperty(feature, 'meta.mapTitle');\r\n  if (mapTitle !== undefined) {\r\n    olFeature.set('_mapTitle', mapTitle, true);\r\n  }\r\n\r\n  olFeature.set('_entityRevision', getEntityRevision(feature), true);\r\n\r\n  const icon = getEntityIcon(feature);\r\n  if (icon !== undefined) {\r\n    olFeature.set('_icon', icon, true);\r\n  }\r\n\r\n  if (feature.meta && feature.meta.style) {\r\n    olFeature.set('_style', feature.meta.style, true);\r\n  }\r\n\r\n  if (feature.sourceId) {\r\n    olFeature.set('_sourceId', feature.sourceId, true);\r\n  }\r\n\r\n  return olFeature;\r\n}\r\n\r\nexport function renderFeatureFromOl(\r\n  olRenderFeature: OlRenderFeature,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let geom;\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    if (olLayer.get('sourceOptions')) {\r\n      exclude = olLayer.get('sourceOptions').excludeAttribute;\r\n      excludeOffline = olLayer.get('sourceOptions').excludeAttributeOffline;\r\n    }\r\n  } else {\r\n    title = olRenderFeature.get('_title');\r\n  }\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const properties = olRenderFeature.getProperties();\r\n  const geometryType = olRenderFeature.getType();\r\n\r\n  if (geometryType === 'Polygon') {\r\n    const ends = olRenderFeature.getEnds() as number[];\r\n    geom = new OlPolygon(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      'XY' as GeometryLayout,\r\n      ends\r\n    );\r\n  } else if (geometryType === 'Point') {\r\n    geom = new OlPoint(olRenderFeature.getFlatCoordinates(), 'XY' as GeometryLayout);\r\n  } else if (geometryType === 'LineString') {\r\n    geom = new OlLineString(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      'XY' as GeometryLayout,\r\n    );\r\n  }\r\n\r\n  const geometry = olFormat.writeGeometryObject(geom, {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  const id = olRenderFeature.getId() ? olRenderFeature.getId() : uuid();\r\n  const mapTitle = olRenderFeature.get('_mapTitle');\r\n  const extent = olproj.transformExtent(olRenderFeature.getExtent(), projectionIn, projectionOut) as [number, number, number, number];\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent,\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olRenderFeature\r\n  };\r\n}\r\n/**\r\n * Create a feature object out of an OL feature\r\n * The output object has a reference to the feature id.\r\n * @param olFeature OL Feature\r\n * @param projectionIn OL feature projection\r\n * @param olLayer OL Layer\r\n * @param projectionOut Feature projection\r\n * @returns Feature\r\n */\r\nexport function featureFromOl(\r\n  olFeature: OlFeature<OlGeometry>,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n  let idColumn; // for arcgisrest and tilearcgisrest source\r\n  const olFormat = new OlFormatGeoJSON();\r\n\r\n  const keys = olFeature.getKeys().filter((key: string) => {\r\n    return !key.startsWith('_') && key !== 'geometry';\r\n  });\r\n  const properties = keys.reduce((acc: object, key: string) => {\r\n    acc[key] = olFeature.get(key);\r\n    return acc;\r\n  }, {});\r\n\r\n  const geometry = olFormat.writeGeometryObject(olFeature.getGeometry(), {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    const sourceOptions = olLayer.get('sourceOptions');\r\n    if (sourceOptions) {\r\n      exclude = sourceOptions.excludeAttribute;\r\n      excludeOffline = sourceOptions.excludeAttributeOffline;\r\n      idColumn =\r\n        sourceOptions.idColumn ||\r\n        ((sourceOptions.type === 'arcgisrest' || sourceOptions.type === 'tilearcgisrest') ? 'OBJECTID' : undefined );\r\n    }\r\n  } else {\r\n    title = olFeature.get('_title');\r\n  }\r\n  const mapTitle = olFeature.get('_mapTitle');\r\n  const id = olFeature.getId() ? olFeature.getId() : olFeature.get(idColumn) ? olFeature.get(idColumn) : uuid();\r\n  const newFeature = olFeature.get('_newFeature');\r\n\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent: olFeature.get('_extent'),\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      revision: olFeature.getRevision(),\r\n      style: olFeature.get('_style'),\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olFeature\r\n  };\r\n}\r\n\r\n/**\r\n * Compute an OL feature extent in it's map projection\r\n * @param map Map\r\n * @param olFeature OL feature\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeatureExtent(\r\n  map: IgoMap,\r\n  olFeature: OlFeature<OlGeometry>\r\n): [number, number, number, number] {\r\n  let olExtent = olextent.createEmpty();\r\n\r\n  const olFeatureExtent = olFeature.get('_extent');\r\n  const olFeatureProjection = olFeature.get('_projection');\r\n  if (olFeatureExtent !== undefined && olFeatureProjection !== undefined) {\r\n    olExtent = olproj.transformExtent(\r\n      olFeatureExtent,\r\n      olFeatureProjection,\r\n      map.projection\r\n    );\r\n  } else {\r\n    const olGeometry = olFeature.getGeometry();\r\n    if (olGeometry !== null) {\r\n      olExtent = olGeometry.getExtent();\r\n    }\r\n  }\r\n\r\n  return olExtent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Compute a multiple OL features extent in their map projection\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeaturesExtent(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[]\r\n): [number, number, number, number] {\r\n  const extent = olextent.createEmpty();\r\n\r\n  olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const featureExtent = computeOlFeatureExtent(map, olFeature);\r\n    olextent.extend(extent, featureExtent);\r\n  });\r\n\r\n  return extent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Scale an extent.\r\n * @param extent Extent\r\n * @param Scaling factors for top, right, bottom and left directions, in that order\r\n * @returns Scaled extent\r\n */\r\nexport function scaleExtent(\r\n  extent: [number, number, number, number],\r\n  scale: [number, number, number, number]\r\n): [number, number, number, number] {\r\n  const [width, height] = olextent.getSize(extent);\r\n  return [\r\n    scale[3] ? extent[0] - width * scale[3] : extent[0],\r\n    scale[2] ? extent[1] - height * scale[2] : extent[1],\r\n    scale[1] ? extent[2] + width * scale[1] : extent[2],\r\n    scale[0] ? extent[3] + height * scale[0] : extent[3]\r\n  ];\r\n}\r\n\r\n/**\r\n * Return true if features are out of view.\r\n * If features are too close to the edge, they are considered out of view.\r\n * By default, we define the edge as 5% (0.05) of the extent size.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @param edgeRatio Number or Number[] Single value OR an array =>\r\n *  [top,right,bottom,left] directions, in that order\r\n * @returns Return true if features are out of view\r\n */\r\nexport function featuresAreOutOfView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number],\r\n  edgeRatio: number | number[] = 0.05\r\n) {\r\n  const edgesRatio = Array.isArray(edgeRatio) ? edgeRatio :[edgeRatio,edgeRatio,edgeRatio,edgeRatio];\r\n  const mapExtent = map.viewController.getExtent();\r\n  const scale = [-1, -1, -1, -1].map((x,i) => x * edgesRatio[i]);\r\n  const viewExtent = scaleExtent(mapExtent, scale as [\r\n    number,\r\n    number,\r\n    number,\r\n    number\r\n  ]);\r\n\r\n  return !olextent.containsExtent(viewExtent, featuresExtent);\r\n}\r\n\r\n/**\r\n * Return true if features are too deep into the view. This results\r\n * in features being too small.\r\n * Features are considered too small if their extent occupies less than\r\n * 1% of the map extent.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @param areaRatio The features extent to view extent acceptable ratio\r\n * @returns Return true if features are too deep in the view\r\n */\r\nexport function featuresAreTooDeepInView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  // An area ratio of 0.004 means that the feature extent's width and height\r\n  // should be about 1/16 of the map extent's width and height\r\n  areaRatio = areaRatio ? areaRatio : 0.004;\r\n  const mapExtent = map.viewController.getExtent();\r\n  const mapExtentArea = olextent.getArea(mapExtent);\r\n  const featuresExtentArea = olextent.getArea(featuresExtent);\r\n\r\n  if (featuresExtentArea === 0 && map.viewController.getZoom() > 13) {\r\n    // In case it's a point\r\n    return false;\r\n  }\r\n\r\n  return featuresExtentArea / mapExtentArea < areaRatio;\r\n}\r\n\r\n/**\r\n * Fit view to include the features extent.\r\n * By default, this method will let the features occupy about 50% of the viewport.\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @param motion To motion to the new map view\r\n * @param scale If this is defined, the original view will be scaled\r\n *  by that factor before any logic is applied.\r\n */\r\nexport function moveToOlFeatures(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  motion: FeatureMotion = FeatureMotion.Default,\r\n  scale?: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  const featuresExtent = computeOlFeaturesExtent(map, olFeatures);\r\n  let viewExtent = featuresExtent;\r\n  if (scale !== undefined) {\r\n    viewExtent = scaleExtent(viewExtent, scale);\r\n  }\r\n\r\n  if (motion === FeatureMotion.Zoom) {\r\n    map.viewController.zoomToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Move) {\r\n    map.viewController.moveToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Default) {\r\n    if (\r\n      featuresAreOutOfView(map, featuresExtent) ||\r\n      featuresAreTooDeepInView(map, featuresExtent, areaRatio)\r\n    ) {\r\n      map.viewController.zoomToExtent(viewExtent);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hide an OL feature\r\n * @param olFeature OL feature\r\n */\r\nexport function hideOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n  olFeature.setStyle(new olstyle.Style({}));\r\n}\r\n\r\n/**\r\n * Try to bind a layer to a store if none is bound already.\r\n * The layer will also be added to the store's map.\r\n * If no layer is given to that function, a basic one will be created.\r\n * @param store The store to bind the layer\r\n * @param layer An optional VectorLayer\r\n */\r\nexport function tryBindStoreLayer(store: FeatureStore, layer?: VectorLayer) {\r\n  if (store.layer !== undefined) {\r\n    if (store.layer.map === undefined) {\r\n      store.map.addLayer(store.layer);\r\n    }\r\n    return;\r\n  }\r\n\r\n  layer = layer\r\n    ? layer\r\n    : new VectorLayer({\r\n        source: new FeatureDataSource()\r\n      });\r\n  store.bindLayer(layer);\r\n  if (store.layer.map === undefined) {\r\n    store.map.addLayer(store.layer);\r\n  }\r\n}\r\n\r\n/**\r\n * Compute a diff between a source array of Ol features and a target array\r\n * @param source Source array of OL features\r\n * @param starget Target array of OL features\r\n * @returns Features to add and remove\r\n */\r\nexport function computeOlFeaturesDiff(\r\n  source: OlFeature<OlGeometry>[],\r\n  target: OlFeature<OlGeometry>[]\r\n): {\r\n  add: OlFeature<OlGeometry>[];\r\n  remove: OlFeature<OlGeometry>[];\r\n} {\r\n  const olFeaturesMap = new Map();\r\n  target.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    olFeaturesMap.set(olFeature.getId(), olFeature);\r\n  });\r\n\r\n  const olFeaturesToRemove = [];\r\n  source.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const newOlFeature = olFeaturesMap.get(olFeature.getId());\r\n    if (newOlFeature === undefined) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else if (\r\n      newOlFeature.get('_entityRevision') !== olFeature.get('_entityRevision')\r\n    ) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else {\r\n      olFeaturesMap.delete(newOlFeature.getId());\r\n    }\r\n  });\r\n\r\n  const olFeaturesToAddIds = Array.from(olFeaturesMap.keys());\r\n  const olFeaturesToAdd = target.filter((olFeature: OlFeature<OlGeometry>) => {\r\n    return olFeaturesToAddIds.indexOf(olFeature.getId()) >= 0;\r\n  });\r\n\r\n  return {\r\n    add: olFeaturesToAdd,\r\n    remove: olFeaturesToRemove\r\n  };\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olextent from 'ol/extent';\r\n\r\nimport { Document } from 'flexsearch';\r\n\r\nimport {\r\n  getEntityId,\r\n  EntityKey,\r\n  EntityStore\r\n} from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap, MapExtent } from '../../map';\r\n\r\nimport { FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureStoreOptions } from './feature.interfaces';\r\nimport { computeOlFeaturesDiff, featureFromOl, featureToOl, moveToOlFeatures, computeOlFeaturesExtent } from './feature.utils';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * features and the map layer to display them on. Synchronization\r\n * between the store and the layer is handled by strategies.\r\n */\r\nexport class FeatureStore<T extends Feature = Feature> extends EntityStore<T> {\r\n\r\n  /**\r\n   * Vector layer to display the features on\r\n   */\r\n  layer: VectorLayer;\r\n\r\n  /**\r\n   * The map the layer is bound to\r\n   */\r\n  readonly map: IgoMap;\r\n\r\n  /**\r\n   * The layer's data source\r\n   */\r\n  get source(): FeatureDataSource {\r\n    return this.layer ? this.layer.dataSource as FeatureDataSource : undefined;\r\n  }\r\n\r\n  /**\r\n   * The searchable index of loaded feature. Computed if strategy is provided\r\n   */\r\n  set searchDocument(v: Document<T>) {\r\n    this._searchDocument = v;\r\n  }\r\n\r\n  get searchDocument(): Document<T> {\r\n    return this._searchDocument;\r\n  }\r\n  private _searchDocument: Document<T>;\r\n\r\n\r\n  constructor(entities: T[], options: FeatureStoreOptions) {\r\n    super(entities, options);\r\n    this.map = options.map;\r\n  }\r\n\r\n  /**\r\n   * Bind this store to a vector layer\r\n   * @param layer Vector layer\r\n   * @returns Feature store\r\n   */\r\n  bindLayer(layer: VectorLayer): FeatureStore {\r\n    this.layer = layer;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible. Strategies\r\n   * make extensive use of that method.\r\n   * @param features Features\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  setLayerFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number,\r\n    getId?: (Feature) => EntityKey\r\n  ) {\r\n    getId = getId ? getId : getEntityId;\r\n    this.checkLayer();\r\n\r\n    const olFeatures = features\r\n      .map((feature: Feature) => featureToOl(feature, this.map.projection, getId));\r\n    this.setLayerOlFeatures(olFeatures, motion, viewScale, areaRatio);\r\n  }\r\n\r\n  /**\r\n   * Set the store's features from an array of OL features.\r\n   * @param olFeatures Ol features\r\n   */\r\n  setStoreOlFeatures(olFeatures: OlFeature<OlGeometry>[]) {\r\n    this.checkLayer();\r\n\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n      return featureFromOl(olFeature, this.layer.map.projection);\r\n    });\r\n    this.load(features as T[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all features from the layer\r\n   */\r\n  clearLayer() {\r\n    this.checkLayer();\r\n    this.source.ol.clear();\r\n  }\r\n\r\n  /**\r\n   * Check wether a layer is bound or not and throw an error if not.\r\n   */\r\n  private checkLayer() {\r\n    if (this.layer === undefined) {\r\n      throw new Error('This FeatureStore is not bound to a layer.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible.\r\n   * @param features Openlayers feature objects\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  public setLayerOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number\r\n  ) {\r\n    const olSource = this.layer.ol.getSource();\r\n    const diff = computeOlFeaturesDiff(olSource.getFeatures(), olFeatures);\r\n    if (diff.remove.length > 0) {\r\n      this.removeOlFeaturesFromLayer(diff.remove);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      this.addOlFeaturesToLayer(diff.add);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      // If features are added, do a motion toward the newly added features\r\n      moveToOlFeatures(this.map, diff.add, motion, viewScale, areaRatio);\r\n    } else if (diff.remove.length > 0) {\r\n      // Else, do a motion toward all the features\r\n      moveToOlFeatures(this.map, olFeatures, motion, viewScale, areaRatio);\r\n    }\r\n  }\r\n\r\n  setLayerExtent(): void {\r\n    let features = this.entities$.getValue();\r\n    let extent = olextent.createEmpty() as MapExtent;\r\n    let olFeatures = [];\r\n\r\n    features.forEach((feature) => {\r\n      olFeatures.push(featureToOl(feature, this.map.projection));\r\n    });\r\n    const featuresExtent = computeOlFeaturesExtent(this.map, olFeatures);\r\n    olextent.extend(extent, featuresExtent);\r\n    this.layer.setExtent(extent);\r\n  }\r\n  /**\r\n   * Add features to the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private addOlFeaturesToLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n    });\r\n    this.source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private removeOlFeaturesFromLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      this.source.ol.removeFeature(olFeature);\r\n    });\r\n  }\r\n\r\n}\r\n","import * as olextent from 'ol/extent';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapExtentStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\nimport { skipWhile } from 'rxjs/operators';\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is moved.\r\n * The features's state inside the map are tagged inMapExtent = true;\r\n */\r\nexport class FeatureStoreInMapExtentStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private states$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapExtentStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .pipe(skipWhile((empty) => !empty))\r\n      .subscribe(() => this.updateEntitiesInExtent(store));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInExtent(store);\r\n    this.states$$.push(store.layer.map.viewController.state$.subscribe(() => {\r\n      this.updateEntitiesInExtent(store);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInExtent(store) {\r\n    if (store?.layer?.map?.viewController) {\r\n      store.state.updateAll({ inMapExtent: false });\r\n      const mapExtent = store.layer.map.viewController.getExtent();\r\n      let entitiesInMapExtent = [];\r\n      let entitiesWithNoGeom = [];\r\n      for (const entity of store.entities$.value) {\r\n        if (entity.ol) {\r\n          if (olextent.intersects(entity.ol.getGeometry().getExtent(), mapExtent)) {\r\n            entitiesInMapExtent.push(entity);\r\n          }\r\n        } else {\r\n          entitiesWithNoGeom.push(entity);\r\n        }\r\n      }\r\n      if (entitiesInMapExtent.length > 0) {\r\n        store.state.updateMany(entitiesInMapExtent, { inMapExtent: true }, false);\r\n      }\r\n      if (entitiesWithNoGeom.length > 0) {\r\n        store.state.updateMany(entitiesWithNoGeom, { inMapExtent: true }, false);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.states$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapResolutionStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\n\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is scrolled.\r\n * The features's state inside the map's resolution are tagged inMapResolution = true;\r\n */\r\nexport class FeatureStoreInMapResolutionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private resolution$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapResolutionStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .subscribe(() => this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution()));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution());\r\n    this.resolution$$.push(store.layer.map.viewController.resolution$.subscribe((res) => {\r\n      this.updateEntitiesInResolution(store, res);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInResolution(store, mapResolution: number) {\r\n    if (mapResolution > store.layer.minResolution && mapResolution < store.layer.maxResolution) {\r\n      store.state.updateAll({ inMapResolution: true });\r\n    } else {\r\n      store.state.updateAll({ inMapResolution: false });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.resolution$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureMotion } from '../feature.enums';\r\nimport { Feature, FeatureStoreLoadingStrategyOptions } from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\n\r\n/**\r\n * This strategy loads a store's features into it's layer counterpart.\r\n * The store -> layer binding is a one-way binding. That means any entity\r\n * added to the store will be added to the layer but the opposite is false.\r\n *\r\n * Important: This strategy observes filtered entities, not raw entities. This\r\n * is not configurable yet.\r\n */\r\nexport class FeatureStoreLoadingStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's features\r\n   */\r\n  private stores$$ = new Map<FeatureStore, Subscription>();\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  constructor(protected options: FeatureStoreLoadingStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on load\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for entities changes in a store.\r\n   * Important: Never observe a store's sorted entities. It makes no sense\r\n   * to display sorted entities (instead of unsorted) on a layer and it\r\n   * would potentially result in a lot of useless computation.\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const subscription = store.view.all$()\r\n      .subscribe((features: Feature[]) => this.onFeaturesChange(features, store));\r\n    this.stores$$.set(store, subscription);\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in a store.\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const subscription = this.stores$$.get(store);\r\n    if (subscription !== undefined) {\r\n      subscription.unsubscribe();\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, Subscription]) => {\r\n      entries[1].unsubscribe();\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features into a layer or clear the layer if the array of features is empty.\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onFeaturesChange(features: Feature[], store: FeatureStore) {\r\n    if (features.length === 0) {\r\n      store.clearLayer();\r\n    } else {\r\n      store.setLayerFeatures(\r\n        features,\r\n        this.selectMotion(store),\r\n        this.options.viewScale,\r\n        this.options.areaRatio,\r\n        this.options.getFeatureId\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Selects the best motion\r\n   * @param store A FeatureStore to apply the motion\r\n   * @returns The motion selected\r\n   */\r\n  private selectMotion(store: FeatureStore) {\r\n    if (this.motion !== undefined) { return this.motion; }\r\n\r\n    if (store.pristine === true) {\r\n      // If features have just been loaded into the store, move/zoom on them\r\n      return FeatureMotion.Default;\r\n    } else if (store.count > store.view.count) {\r\n      // If features have been filtered, move/zoom on the remaining ones\r\n      return FeatureMotion.Default;\r\n    } else {\r\n      // On insert, update or delete, do nothing\r\n      return FeatureMotion.None;\r\n    }\r\n  }\r\n}\r\n","import OlEvent from 'ol/events/Event';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreLoadingLayerStrategyOptions } from '../feature.interfaces';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\n/**\r\n * This strategy loads a layer's features into it's store counterpart.\r\n * The layer -> store binding is a one-way binding. That means any OL feature\r\n * added to the layer will be added to the store but the opposite is false.\r\n *\r\n * Important: In it's current state, this strategy is to meant to be combined\r\n * with a standard Loading strategy and it would probably cause recursion issues.\r\n */\r\nexport class FeatureStoreLoadingLayerStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n\r\n  constructor(protected options: FeatureStoreLoadingLayerStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.onSourceChanges(store);\r\n    const olSource = store.layer.ol.getSource();\r\n    olSource.on('change', (event: OlEvent) => {\r\n      this.onSourceChanges(store);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, string]) => {\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features from an OL source into a  store or clear the store if the source is empty\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onSourceChanges(store: FeatureStore) {\r\n    let olFeatures = store.layer.ol.getSource().getFeatures();\r\n\r\n    if (store.layer.dataSource instanceof ClusterDataSource) {\r\n      olFeatures = (olFeatures as any).flatMap((cluster: any) =>\r\n        cluster.get('features')\r\n      );\r\n    }\r\n    if (olFeatures.length === 0) {\r\n      store.clear();\r\n    } else {\r\n      store.setStoreOlFeatures(olFeatures);\r\n    }\r\n  }\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlDragBoxInteraction, { DragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { DragBoxEvent as OlDragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { EventsKey } from 'ol/events';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subscription, combineLatest } from 'rxjs';\r\nimport { map, debounceTime, skip } from 'rxjs/operators';\r\n\r\nimport { EntityKey, EntityRecord, EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../../datasource';\r\nimport { VectorLayer } from '../../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { ctrlKeyDown } from '../../../map/shared/map.utils';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureStoreSelectionStrategyOptions\r\n} from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureMotion } from '../feature.enums';\r\n\r\nexport class OlDragSelectInteraction extends OlDragBoxInteraction {\r\n  constructor(options) {\r\n    super(options);\r\n  }\r\n}\r\n\r\n/**\r\n * This strategy synchronizes a store and a layer selected entities.\r\n * The store <-> layer binding is a two-way binding.\r\n *\r\n * In many cases, a single strategy bound to multiple stores\r\n * will yield better results that multiple strategies with each their\r\n * own store. In the latter scenario, a click on overlapping features\r\n * would trigger the strategy of each layer and they would cancel\r\n * each other as well as move the map view around needlessly.\r\n */\r\nexport class FeatureStoreSelectionStrategy extends EntityStoreStrategy {\r\n  /**\r\n   * Listener to the map click event that allows selecting a feature\r\n   * by clicking on the map\r\n   */\r\n  private mapClickListener;\r\n\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Subscription to all stores selected entities\r\n   */\r\n  private stores$$: Subscription;\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  /**\r\n   * The map the layers belong to\r\n   */\r\n  get map(): IgoMap {\r\n    return this.options.map;\r\n  }\r\n\r\n  /**\r\n   * A feature store that'll contain the selected features. It has it's own\r\n   * layer, shared by all the stores this staretgy is bound to.\r\n   */\r\n  get overlayStore(): FeatureStore {\r\n    return this._overlayStore;\r\n  }\r\n  private _overlayStore: FeatureStore;\r\n\r\n  constructor(protected options: FeatureStoreSelectionStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n    this._overlayStore = this.createOverlayStore();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on select\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Unselect all entities, from all stores\r\n   */\r\n  unselectAll() {\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      store.state.updateAll({ selected: false });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.overlayStore.clear();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the selection without removing the selection\r\n   * overlay.\r\n   */\r\n  deactivateSelection() {\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer, setup the map click lsitener and\r\n   * start watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.addOverlayLayer();\r\n    this.listenToMapClick();\r\n    if (this.options.dragBox === true) {\r\n      this.addDragBoxInteraction();\r\n    }\r\n    this.watchAll();\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer, remove the map click lsitener and\r\n   * stop watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.deactivateSelection();\r\n    this.removeOverlayLayer();\r\n  }\r\n\r\n  /**\r\n   * Create a single observable of all the stores. With a single observable,\r\n   * features can be added all at once to the overlay layer and a single\r\n   * motion can be performed. Multiple observable would have\r\n   * a cancelling effect on each other.\r\n   */\r\n  private watchAll() {\r\n    this.unwatchAll();\r\n\r\n    const stores$ = this.stores.map((store: FeatureStore) => {\r\n      return store.stateView\r\n        .manyBy$((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          map((records: EntityRecord<Feature>[]) =>\r\n            records.map((record) => record.entity)\r\n          )\r\n        );\r\n    });\r\n    this.stores$$ = combineLatest(stores$)\r\n      .pipe(\r\n        debounceTime(5),\r\n        skip(1), // Skip intial selection\r\n        map((features: Array<Feature[]>) =>\r\n          features.reduce((a, b) => a.concat(b))\r\n        )\r\n      )\r\n      .subscribe((features: Feature[]) => this.onSelectFromStore(features));\r\n  }\r\n\r\n  /**\r\n   * Stop watching for selection in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    if (this.stores$$ !== undefined) {\r\n      this.stores$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a 'singleclick' listener to the map that'll allow selecting\r\n   * features by clicking on the map. The selection will be performed\r\n   * only on the layers bound to this strategy.\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => {\r\n        this.onMapClick(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove the map click listener\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n  }\r\n\r\n  /**\r\n   * On map click, select feature at pixel\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onMapClick(event: MapBrowserPointerEvent<any>) {\r\n    const exclusive = !ctrlKeyDown(event);\r\n    const reverse = !exclusive;\r\n    const olFeatures = event.map.getFeaturesAtPixel(event.pixel, {\r\n      hitTolerance: this.options.hitTolerance || 0,\r\n      layerFilter: olLayer => {\r\n        const storeOlLayer = this.stores.find((store: FeatureStore) => {\r\n          return store.layer?.ol === olLayer;\r\n        });\r\n        return storeOlLayer !== undefined;\r\n      }\r\n    }) as OlFeature<OlGeometry>[];\r\n    this.onSelectFromMap(olFeatures, exclusive, reverse);\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteraction;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteraction = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteraction === undefined) {\r\n      olDragSelectInteraction = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteraction);\r\n      this.olDragSelectInteraction = olDragSelectInteraction;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteraction.on(\r\n      'boxend',\r\n      (event: DragBoxEvent) => this.onDragBoxEnd(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * On dragbox end, select features in drag box\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onDragBoxEnd(event: OlDragBoxEvent) {\r\n    const exclusive = !ctrlKeyDown(event.mapBrowserEvent);\r\n    const target = event.target as any;\r\n    const extent = target.getGeometry().getExtent();\r\n    const olFeatures = this.stores.reduce(\r\n      (acc: OlFeature<OlGeometry>[], store: FeatureStore) => {\r\n        const olSource = store.layer.ol.getSource();\r\n        acc.push(...olSource.getFeaturesInExtent(extent));\r\n        return acc;\r\n      },\r\n      []\r\n    );\r\n    this.onSelectFromMap(olFeatures, exclusive, false);\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the store, add\r\n   * them to this startegy's overlay layer (select on map)\r\n   * @param features Store features\r\n   */\r\n  private onSelectFromStore(features: Feature[]) {\r\n    const motion = this.motion;\r\n    const olOverlayFeatures = this.overlayStore.layer.ol\r\n      .getSource()\r\n      .getFeatures();\r\n    const overlayFeaturesKeys = olOverlayFeatures.map((olFeature: OlFeature<OlGeometry>) =>\r\n      olFeature.getId()\r\n    );\r\n    const featuresKeys = features.map(this.overlayStore.getKey);\r\n\r\n    let doMotion;\r\n    if (features.length === 0) {\r\n      doMotion = false;\r\n    } else {\r\n      doMotion =\r\n        overlayFeaturesKeys.length !== featuresKeys.length ||\r\n        !overlayFeaturesKeys.every(\r\n          (key: EntityKey) => featuresKeys.indexOf(key) >= 0\r\n        );\r\n    }\r\n\r\n    this.overlayStore.setLayerFeatures(\r\n      features,\r\n      doMotion ? motion : FeatureMotion.None,\r\n      this.options.viewScale,\r\n      this.options.areaRatio,\r\n      this.options.getFeatureId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the map, also select them\r\n   * in their store.\r\n   * @param olFeatures OL feature objects\r\n   */\r\n  private onSelectFromMap(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    const groupedFeatures = this.groupFeaturesByStore(olFeatures);\r\n\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      const features = groupedFeatures.get(store);\r\n      if (features === undefined && exclusive === true) {\r\n        this.unselectAllFeaturesFromStore(store);\r\n      } else if (features === undefined && exclusive === false) {\r\n        // Do nothing\r\n      } else {\r\n        this.selectFeaturesFromStore(store, features, exclusive, reverse);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Select features in store\r\n   * @param store: Feature store\r\n   * @param features Features\r\n   */\r\n  private selectFeaturesFromStore(\r\n    store: FeatureStore,\r\n    features: Feature[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    if (reverse === true) {\r\n      store.state.reverseMany(features, ['selected']);\r\n    } else {\r\n      store.state.updateMany(features, { selected: true }, exclusive);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unselect all features from store\r\n   * @param store: Feature store\r\n   */\r\n  private unselectAllFeaturesFromStore(store: FeatureStore) {\r\n    store.state.updateAll({ selected: false });\r\n  }\r\n\r\n  /**\r\n   * This method returns a store -> features mapping from a list\r\n   * of OL selected features. OL features keep a reference to the store\r\n   * they are from.\r\n   * @param olFeatures: OL feature objects\r\n   * @returns Store -> features mapping\r\n   */\r\n  private groupFeaturesByStore(\r\n    olFeatures: OlFeature<OlGeometry>[]\r\n  ): Map<FeatureStore, Feature[]> {\r\n    const groupedFeatures = new Map<FeatureStore, Feature[]>();\r\n    if (olFeatures === null || olFeatures === undefined) {\r\n      return groupedFeatures;\r\n    }\r\n\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      const store = olFeature.get('_featureStore');\r\n      if (store === undefined) {\r\n        return;\r\n      }\r\n\r\n      let features = groupedFeatures.get(store);\r\n      if (features === undefined) {\r\n        features = [];\r\n        groupedFeatures.set(store, features);\r\n      }\r\n\r\n      const feature = store.get(olFeature.getId());\r\n      if (feature !== undefined) {\r\n        features.push(feature);\r\n      }\r\n    });\r\n\r\n    return groupedFeatures;\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay store\r\n   */\r\n  private createOverlayStore(): FeatureStore {\r\n    const overlayLayer = this.options.layer\r\n      ? this.options.layer\r\n      : this.createOverlayLayer();\r\n    return new FeatureStore([], { map: this.map }).bindLayer(overlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay layer\r\n   */\r\n  private createOverlayLayer(): VectorLayer {\r\n    return new VectorLayer({\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      style: undefined,\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay store's layer to the map to display the selected\r\n   * features.\r\n   */\r\n  private addOverlayLayer() {\r\n    if (this.overlayStore.layer.map === undefined) {\r\n      this.map.addLayer(this.overlayStore.layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer from the map\r\n   */\r\n  private removeOverlayLayer() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.map.removeLayer(this.overlayStore.layer);\r\n  }\r\n}\r\n","import { Document, DocumentOptions } from 'flexsearch';\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreSearchIndexStrategyOptions } from '../feature.interfaces';\r\nimport { skipWhile } from 'rxjs/operators';\r\n\r\n/**\r\n *\r\n * This strategy loads a layer's features's properties into a searchable index.\r\n */\r\nexport class FeatureStoreSearchIndexStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n\r\n  constructor(protected options: FeatureStoreSearchIndexStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  private initStoreSearchIndex(store) {\r\n    store.searchDocument = new Document({ tokenize: \"full\" });\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's entities changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n    this.initStoreSearchIndex(store);\r\n\r\n    store.entities$\r\n      .pipe(skipWhile((e) => !e.length))\r\n      .subscribe(() => this.onEntitiesChanges(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's entities changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      store.searchDocument = undefined;\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, string]) => {\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Maintain searcahble index for every loaded entities\r\n   * @param store Feature store\r\n   */\r\n  private onEntitiesChanges(store: FeatureStore) {\r\n    const ratio = this.options.percentDistinctValueRatio || 2;\r\n    const featuresProperties = [];\r\n    store.index.forEach((value, key) => {\r\n      const fp = value.properties;\r\n      fp.igoSearchID = key;\r\n      featuresProperties.push(fp);\r\n    });\r\n    const toIndex = [];\r\n    let columnsToNotIndex = [];\r\n    let contentToIndex = [];\r\n    if (this.options.sourceFields) {\r\n      columnsToNotIndex = this.options.sourceFields.filter(sf => !sf.searchIndex?.enabled);\r\n      contentToIndex = this.options.sourceFields.filter(sf => sf.searchIndex?.enabled).map(sf2 => {\r\n        return Object.assign({}, {field: sf2.name, tokenize: \"full\"}, sf2.searchIndex);\r\n      });\r\n    } else {\r\n      if (featuresProperties.length) {\r\n        // THIS METHOD COMPUTE COLUMN DISTINCT VALUE TO FILTER WHICH COLUMN TO INDEX BASED ON A RATIO or discard float columns\r\n        const columns = Object.keys(featuresProperties[0]);\r\n        const columnsToIndex = [];\r\n        columnsToNotIndex = columns.map((column) => {\r\n          const distinctValues = [...new Set(featuresProperties.map(item => item[column]))];\r\n          // identify column to not index based on a ratio distinctValues/nb of features OR discart exclusive float column (ex: lat, long)\r\n          if (\r\n            (distinctValues.length / featuresProperties.length) * 100 <= ratio ||\r\n            distinctValues.every(n => Number(n) === n && n % 1 !== 0)) {\r\n            columnsToNotIndex.push(column);\r\n          } else {\r\n            columnsToIndex.push(column);\r\n          }\r\n        }).filter(f => f);\r\n        const keysToIndex = columnsToIndex.filter(f => f !== 'igoSearchID');\r\n        contentToIndex = keysToIndex.map(key => { return { field: key, tokenize: \"full\" }; });\r\n      }\r\n    }\r\n    store.index.forEach((value, key) => {\r\n      const propertiesToIndex = JSON.parse(JSON.stringify(value.properties));\r\n      columnsToNotIndex.map(c => delete propertiesToIndex[c]);\r\n      if (Object.keys(propertiesToIndex).length) {\r\n        toIndex.push(propertiesToIndex);\r\n      }\r\n    });\r\n\r\n    if (toIndex.length === 0) {\r\n      this.initStoreSearchIndex(store);\r\n    } else {\r\n\r\n\r\n      store.searchDocument = new Document({\r\n        document: {\r\n          id: 'igoSearchID',\r\n          index: contentToIndex\r\n        } as DocumentOptions<any>\r\n      });\r\n      toIndex.map(i => {\r\n        store.searchDocument.add(i.igoSearchID, i);\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { FeatureStore } from './store';\r\nimport { FeatureStoreSelectionStrategy } from './strategies/selection';\r\nimport { FeatureStoreLoadingStrategy } from './strategies/loading';\r\n\r\n/**\r\n * Try to add a loading strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the loading strategy\r\n * @param strategy An optional loading strategy\r\n */\r\nexport function tryAddLoadingStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreLoadingStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreLoadingStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    return;\r\n  }\r\n\r\n  strategy = strategy ? strategy : new FeatureStoreLoadingStrategy({});\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n\r\n/**\r\n * Try to add a selection strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the selection strategy\r\n * @param [strategy] An optional selection strategy\r\n */\r\nexport function tryAddSelectionStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreSelectionStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreSelectionStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n    return;\r\n  }\r\n  strategy = strategy\r\n    ? strategy\r\n    : new FeatureStoreSelectionStrategy({\r\n        map: store.map\r\n      });\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\n/**\r\n * Create a marker style for points\r\n * @returns Style\r\n */\r\nexport function createOverlayMarkerStyle({\r\n  text,\r\n  opacity = 1,\r\n  markerColor = [0, 161, 222],\r\n  markerOutlineColor = [255, 255, 255]\r\n}: {\r\n  text?: string;\r\n  opacity?: number;\r\n  markerColor?: string | number[];\r\n  markerOutlineColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  let iconColor;\r\n  let svgIconColor;\r\n  let svgOutlineColor;\r\n  let svg;\r\n\r\n  const newColor = ColorAsArray(markerColor).slice(0);\r\n  const newOutlineColor = ColorAsArray(markerOutlineColor).slice(0);\r\n\r\n  if (newColor.length === 4 && (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n    opacity = newColor[3];\r\n  }\r\n\r\n  svgIconColor = `\"rgba(${newColor[0]},${newColor[1]},${newColor[2]},${opacity})\"`;\r\n  iconColor = markerColor;\r\n\r\n  svgOutlineColor = `\"rgb(${newOutlineColor[0]},${newOutlineColor[1]},${newOutlineColor[2]})\"`;\r\n\r\n  svg =\r\n    'data:image/svg+xml;utf8,<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" height=\"36\" width=\"36\" viewBox=\"0 0 36 36\">' +\r\n    '<path fill=' +\r\n    svgIconColor +\r\n    ' stroke=' +\r\n    svgOutlineColor +\r\n    ` stroke-width=\"2\" d=\"M 17.692635,32.565644 C 15.71852,30.330584 13.290925,27.058065 11.6766,24.455732 9.3398623,20.688851 7.8905694,17.205334 7.6297492,14.728733 7.5616025,14.081649 7.5739557,12.528552 7.6513363,12.014724 8.1013861,9.0262716 9.8047068,6.3655569 12.310675,4.7364878 c 1.113691,-0.7239832 2.508083,-1.2834131 3.776687,-1.5152052 0.242945,-0.044389 0.451656,-0.09393 0.463804,-0.1100911 0.01215,-0.016161 0.638282,-0.025502 1.391411,-0.02076 1.088235,0.00685 1.450932,0.024316 1.766871,0.085071 2.650763,0.5097353 4.947142,1.8701891 6.498786,3.8501033 0.628018,0.8013587 1.297046,2.0200608 1.640967,2.9891872 0.191065,0.538399 0.427644,1.447408 0.477391,1.834287 0.0164,0.127546 0.0434,0.231902 0.06,0.231902 0.0166,0 0.03122,0.626135 0.03249,1.391411 0.0013,0.765276 -0.011,1.391411 -0.02726,1.391411 -0.01626,0 -0.05449,0.154049 -0.08495,0.342331 -0.08815,0.544879 -0.387235,1.721449 -0.604837,2.379406 -1.209421,3.656888 -4.014463,8.349762 -7.849521,13.132357 -0.790496,0.985807 -1.795217,2.167992 -1.842543,2.167992 -0.01896,0 -0.161766,-0.144111 -0.317336,-0.320246 z m 1.066937,-15.36525 c 0.133519,-0.02121 0.248766,-0.05657 0.256105,-0.07859 0.0073,-0.02202 0.04918,-0.03066 0.09298,-0.0192 0.0438,0.01145 0.107628,-0.0072 0.141834,-0.04137 0.03421,-0.03421 0.08456,-0.05474 0.111888,-0.04563 0.02733,0.0091 0.07703,-0.01077 0.110429,-0.04417 0.03341,-0.03341 0.08416,-0.05293 0.112796,-0.04338 0.02863,0.0095 0.08974,-0.01867 0.135802,-0.06271 0.04606,-0.04403 0.111902,-0.08625 0.146319,-0.09381 0.204084,-0.04483 0.762371,-0.519108 1.079463,-0.917027 0.26749,-0.335672 0.570987,-0.878795 0.529019,-0.946701 -0.01496,-0.0242 -0.0067,-0.044 0.01835,-0.044 0.05645,0 0.196809,-0.467982 0.158801,-0.529481 -0.01521,-0.02461 -0.0043,-0.04475 0.02427,-0.04475 0.03157,0 0.04365,-0.04329 0.03082,-0.11043 -0.01161,-0.06074 -0.0066,-0.110429 0.01124,-0.110429 0.01779,0 0.03235,-0.258405 0.03235,-0.574233 0,-0.315829 -0.01545,-0.574234 -0.03434,-0.574234 -0.01889,0 -0.02437,-0.03811 -0.01219,-0.08469 0.04412,-0.168712 -0.336329,-1.152668 -0.481536,-1.245401 -0.02327,-0.01486 -0.04022,-0.03992 -0.03765,-0.05568 0.01222,-0.07498 -0.156557,-0.318365 -0.406379,-0.586027 -0.295921,-0.317054 -0.773059,-0.690104 -0.83427,-0.652274 -0.0206,0.01273 -0.03745,0.0024 -0.03745,-0.02289 0,-0.06107 -0.433076,-0.2789369 -0.487546,-0.245273 -0.02338,0.01445 -0.04251,0.0068 -0.04251,-0.01695 0,-0.056281 -0.393995,-0.1865457 -0.613804,-0.2029397 -0.0943,-0.00703 -0.188579,-0.023183 -0.209503,-0.035888 -0.02092,-0.012705 -0.276571,-0.023337 -0.568105,-0.023627 -0.534044,-5.301e-4 -1.12638,0.091025 -1.12638,0.1741017 0,0.023781 -0.01713,0.032648 -0.03808,0.019705 -0.05054,-0.031232 -0.403641,0.1088602 -0.403641,0.1601422 0,0.02204 -0.01988,0.02779 -0.04417,0.01278 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01988,0.0371 -0.04417,0.02209 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01915,0.03755 -0.04256,0.02308 -0.02341,-0.01447 -0.08138,0.01252 -0.128834,0.05997 -0.04745,0.04745 -0.0974,0.07515 -0.111001,0.06155 -0.0136,-0.0136 -0.03722,0.0078 -0.05248,0.0476 -0.01526,0.03978 -0.0411,0.06408 -0.0574,0.054 -0.03277,-0.02025 -0.462299,0.323995 -0.491977,0.394291 -0.01026,0.02429 -0.07454,0.0912 -0.142856,0.148686 -0.248033,0.208705 -0.730279,0.974169 -0.672565,1.067553 0.0145,0.02346 0.0059,0.04266 -0.01914,0.04266 -0.05907,0 -0.241471,0.599428 -0.208527,0.685278 0.01385,0.0361 0.0044,0.06564 -0.02098,0.06564 -0.02539,0 -0.04169,0.0646 -0.03622,0.143558 0.0055,0.07896 -0.0042,0.213129 -0.02144,0.29816 -0.04741,0.233576 0.0511,1.055502 0.167516,1.397721 0.126048,0.370516 0.310099,0.740163 0.426484,0.856548 0.04776,0.04776 0.07554,0.08684 0.06174,0.08684 -0.0138,0 0.01516,0.05653 0.06436,0.125632 0.131301,0.184396 0.499365,0.587266 0.518785,0.567846 0.0092,-0.0092 0.09821,0.06081 0.197812,0.155562 0.09961,0.09475 0.190589,0.162786 0.202187,0.151188 0.0116,-0.0116 0.05991,0.01774 0.107361,0.06519 0.04745,0.04745 0.105426,0.07444 0.128834,0.05997 0.02341,-0.01447 0.04256,-0.0057 0.04256,0.01958 0,0.06106 0.344664,0.23496 0.399061,0.201341 0.02346,-0.0145 0.04266,-0.0059 0.04266,0.01914 0,0.05907 0.599429,0.241471 0.685279,0.208527 0.0361,-0.01385 0.06564,-0.0065 0.06564,0.01645 0,0.05196 1.079115,0.04833 1.413314,-0.0048 z\"></path>` +\r\n    '</svg>';\r\n\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: svg,\r\n      opacity,\r\n      anchor: [0.5, 0.92]\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olStyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nimport { createOverlayMarkerStyle } from '../shared/overlay/overlay-marker-style.utils';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\nimport { StyleByAttribute } from '../shared/vector/vector-style.interface';\r\nimport { ClusterParam } from '../../layer/shared/clusterParam';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleService {\r\n  public style: olStyle.Style;\r\n\r\n  /**\r\n   * Create a style based on a object as\r\n   * style: {\r\n   *       \"stroke\": {\r\n   *         \"color\": \"blue\",\r\n   *         \"lineDash\": [10, 5]\r\n   *       },\r\n   *       \"text\": {\r\n   *         \"minScaleDenom\": 50000,\r\n   *         \"maxScaleDenom\": 200000,\r\n   *         \"minResolution\": 100,\r\n   *         \"maxResolution\": 400,\r\n   *         \"attribute\": \"THE COLUMN NAME TO RETRIEVE THE LABEL VALUE\",\r\n   *         \"text\": \"MY HARCODED TEXT\",\r\n   *         \"stroke\": {\r\n   *           \"color\": \"blue\",\r\n   *           \"width\": 0.75\r\n   *         },\r\n   *         \"fill\": {\r\n   *           \"color\": \"black\"\r\n   *         },\r\n   *         \"font\": \"20px sans-serif\",\r\n   *         \"overflow\": true,\r\n   *         \"offsetX\": 10,\r\n   *         \"offsetY\": 20,\r\n   *         \"padding\": [2.5, 2.5, 2.5, 2.5]\r\n   *       },\r\n   *       \"width\": 5\r\n   *     }\r\n   *\r\n   * @param options\r\n   * @param feature feature to apply style on\r\n   * @param resolution current map resolution, to control label resolution range\r\n   * @returns\r\n   */\r\n  createStyle(options: { [key: string]: any }, feature?: RenderFeature | OlFeature<OlGeometry>, resolution?: number) {\r\n\r\n    if (!options) {\r\n      return createOverlayMarkerStyle();\r\n    }\r\n    if (typeof options === 'function' || options instanceof olStyle.Style) {\r\n      return options;\r\n    }\r\n    const parsedStyle = this.parseStyle('style', options);\r\n    if (parsedStyle.getText()) {\r\n      let labelMinResolution = 0;\r\n      let labelMaxResolution = Infinity;\r\n      if (options.text) {\r\n        const labelMinResolutionFromScale =\r\n          options.text?.minScaleDenom ? getResolutionFromScale(Number(options.text.minScaleDenom)) : undefined;\r\n        const labelMaxResolutionFromScale =\r\n          options.text?.maxScaleDenom ? getResolutionFromScale(Number(options.text.maxScaleDenom)) : undefined;\r\n        const minResolution = options.text?.minResolution ? options.text.minResolution : 0;\r\n        const maxResolution = options.text?.maxResolution ? options.text.maxResolution : Infinity;\r\n\r\n        labelMinResolution = labelMinResolutionFromScale || minResolution;\r\n        labelMaxResolution = labelMaxResolutionFromScale || maxResolution;\r\n      }\r\n      if (feature && resolution >= labelMinResolution && resolution <= labelMaxResolution) {\r\n        if (feature && options.text.attribute) {\r\n          parsedStyle.getText().setText(this.getLabel(feature, options.text.attribute));\r\n        }\r\n      } else {\r\n        parsedStyle.setText();\r\n      }\r\n    }\r\n    return parsedStyle;\r\n  }\r\n\r\n  public parseStyle(key: string, value: any) {\r\n    const styleOptions = {};\r\n    const olCls = this.getOlCls(key);\r\n\r\n    if (olCls && value instanceof Object) {\r\n      Object.keys(value).forEach(_key => {\r\n        const olKey = this.getOlKey(_key);\r\n        styleOptions[olKey] = this.parseStyle(_key, value[_key]);\r\n      });\r\n      return new olCls(styleOptions);\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  private getOlKey(key: any) {\r\n    let olKey;\r\n    switch (key.toLowerCase()) {\r\n      case 'circle':\r\n      case 'regularshape':\r\n      case 'icon':\r\n        olKey = 'image';\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return olKey || key;\r\n  }\r\n\r\n  private getOlCls(key: any) {\r\n    let olCls = olStyle[key.charAt(0).toUpperCase() + key.slice(1)];\r\n    if (key === 'regularshape') {\r\n      olCls = olStyle.RegularShape;\r\n    }\r\n    if (key === 'backgroundFill') {\r\n      olCls = olStyle.Fill;\r\n    }\r\n    if (key === 'backgroundStroke') {\r\n      olCls = olStyle.Stroke;\r\n    }\r\n\r\n    return olCls;\r\n  }\r\n\r\n  createStyleByAttribute(feature: RenderFeature | OlFeature<OlGeometry>, styleByAttribute: StyleByAttribute, resolution: number) {\r\n\r\n    let style;\r\n    const type = styleByAttribute.type ? styleByAttribute.type : this.guessTypeFeature(feature);\r\n    const attribute = styleByAttribute.attribute;\r\n    const data = styleByAttribute.data;\r\n    const stroke = styleByAttribute.stroke;\r\n    const width = styleByAttribute.width;\r\n    const fill = styleByAttribute.fill;\r\n    const anchor = styleByAttribute.anchor;\r\n    const radius = styleByAttribute.radius;\r\n    const icon = styleByAttribute.icon;\r\n    const scale = styleByAttribute.scale;\r\n    const size = data ? data.length : 0;\r\n    const label = styleByAttribute.label ? styleByAttribute.label.attribute : undefined;\r\n    const labelMinResolutionFromScale =\r\n      styleByAttribute.label?.minScaleDenom ? getResolutionFromScale(Number(styleByAttribute.label.minScaleDenom)) : undefined;\r\n    const labelMaxResolutionFromScale =\r\n      styleByAttribute.label?.maxScaleDenom ? getResolutionFromScale(Number(styleByAttribute.label.maxScaleDenom)) : undefined;\r\n    const minResolution = styleByAttribute.label?.minResolution ? styleByAttribute.label.minResolution : 0;\r\n    const maxResolution = styleByAttribute.label?.maxResolution ? styleByAttribute.label.maxResolution : Infinity;\r\n\r\n    const labelMinResolution = labelMinResolutionFromScale || minResolution;\r\n    const labelMaxResolution = labelMaxResolutionFromScale || maxResolution;\r\n\r\n    let labelStyle = styleByAttribute.label?.style ? this.parseStyle('text', styleByAttribute.label.style) : undefined;\r\n    if (!labelStyle && label) {\r\n        labelStyle = new olStyle.Text();\r\n    }\r\n    const baseStyle = styleByAttribute.baseStyle;\r\n\r\n    if (labelStyle) {\r\n      if (resolution >= labelMinResolution && resolution <= labelMaxResolution) {\r\n        labelStyle.setText(this.getLabel(feature, label));\r\n      } else {\r\n        labelStyle.setText('');\r\n      }\r\n    }\r\n\r\n    if (type === 'circle') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n          typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          if (icon) {\r\n            style = [\r\n              new olStyle.Style({\r\n                image: new olStyle.Icon({\r\n                  color: fill ? fill[i] : undefined,\r\n                  src: icon[i],\r\n                  scale: scale ? scale[i] : 1,\r\n                  anchor: anchor ? anchor[i] : [0.5, 0.5]\r\n                }),\r\n                text: labelStyle instanceof olStyle.Text ? labelStyle : undefined\r\n              })\r\n            ];\r\n            return style;\r\n          }\r\n          style = [\r\n            new olStyle.Style({\r\n              image: new olStyle.Circle({\r\n                radius: radius ? radius[i] : 4,\r\n                stroke: new olStyle.Stroke({\r\n                  color: stroke ? stroke[i] : 'black',\r\n                  width: width ? width[i] : 1\r\n                }),\r\n                fill: new olStyle.Fill({\r\n                  color: fill ? fill[i] : 'black'\r\n                })\r\n              }),\r\n              text: labelStyle instanceof olStyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (!(feature as OlFeature<OlGeometry>).getStyle()) {\r\n        if (baseStyle) {\r\n          style = this.createStyle(baseStyle, feature, resolution);\r\n          if (labelStyle) {\r\n            style.setText(labelStyle);\r\n          }\r\n          return style;\r\n        }\r\n        style = [\r\n          new olStyle.Style({\r\n            image: new olStyle.Circle({\r\n              radius: 4,\r\n              stroke: new olStyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olStyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n        return style;\r\n      }\r\n    } else if (type === 'regular') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n        typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          style = [\r\n            new olStyle.Style({\r\n              stroke: new olStyle.Stroke({\r\n                color: stroke ? stroke[i] : 'black',\r\n                width: width ? width[i] : 1\r\n              }),\r\n              fill: new olStyle.Fill({\r\n                color: fill ? fill[i] : 'rgba(255,255,255,0.4)'\r\n              }),\r\n              text: labelStyle instanceof olStyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (feature instanceof OlFeature) {\r\n        if (!feature.getStyle()) {\r\n          if (baseStyle) {\r\n            style = this.createStyle(baseStyle, feature, resolution);\r\n            if (labelStyle) {\r\n              style.setText(labelStyle);\r\n            }\r\n            return style;\r\n          }\r\n          style = [\r\n            new olStyle.Style({\r\n              stroke: new olStyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olStyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  createClusterStyle(feature: RenderFeature | OlFeature<OlGeometry>, resolution: number, clusterParam: ClusterParam = {}, layerStyle) {\r\n    let style;\r\n    const size = feature.get('features').length;\r\n    if (size !== 1) {\r\n      if (clusterParam.clusterRanges) {\r\n        for (const r of clusterParam.clusterRanges) {\r\n          if (\r\n            (!r.minRadius || r.minRadius <= size) &&\r\n            (!r.maxRadius || r.maxRadius >= size)\r\n          ) {\r\n            style = this.createStyle(r.style) as olStyle.Circle;\r\n\r\n            if (r.showRange) {\r\n              const text = new olStyle.Text({\r\n                text: size.toString(),\r\n                fill: new olStyle.Fill({\r\n                  color: '#fff'\r\n                })\r\n              });\r\n              style.setText(text);\r\n            }\r\n\r\n            if (r.dynamicRadius) {\r\n              let clusterRadius: number;\r\n              const radiusMin = style.getRadius();\r\n              clusterRadius = 5 * Math.log(size);\r\n              if (clusterRadius < radiusMin) {\r\n                clusterRadius = radiusMin;\r\n              }\r\n              style.image_.setRadius(clusterRadius);\r\n            }\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!style) {\r\n        let clusterRadius: number;\r\n        if (clusterParam.radiusCalc) {\r\n          clusterRadius = clusterParam.radiusCalc(size);\r\n        } else {\r\n          const radiusMin = 6;\r\n          clusterRadius = 5 * Math.log(size);\r\n          if (clusterRadius < radiusMin) {\r\n            clusterRadius = radiusMin;\r\n          }\r\n        }\r\n\r\n        style = [\r\n          new olStyle.Style({\r\n            image: new olStyle.Circle({\r\n              radius: clusterRadius,\r\n              stroke: new olStyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olStyle.Fill({\r\n                color: 'rgba(24, 134, 45, 0.5)'\r\n              })\r\n            }),\r\n            text: new olStyle.Text({\r\n              text: size.toString(),\r\n              fill: new olStyle.Fill({\r\n                color: '#fff'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n      }\r\n    } else {\r\n      style = this.createStyle(layerStyle, feature, resolution);\r\n    }\r\n    return style;\r\n  }\r\n\r\n  getLabel(feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    if (!label) {\r\n      return;\r\n    }\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.get(v[1]));\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.get(labelMatch) || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  private guessTypeFeature(feature) {\r\n    switch (feature.getGeometry().getType()) {\r\n      case 'Point':\r\n      case 'MultiPoint':\r\n      case 'Circle':\r\n        return 'circle';\r\n      default:\r\n        return 'regular';\r\n    }\r\n  }\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\nimport { StyleService } from '../../../style/style-service/style.service';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { createOverlayMarkerStyle } from './overlay-marker-style.utils';\r\n\r\n\r\n/**\r\n * Create an overlay style with markers for points and a basic stroke/fill\r\n * combination for lines and polygons\r\n * @returns Style function\r\n */\r\nexport function createOverlayLayerStyle(): (olFeature: OlFeature<OlGeometry>, resolution: number) => olstyle.Style {\r\n  const defaultStyle = createOverlayDefaultStyle();\r\n  const markerStyle = createOverlayMarkerStyle();\r\n\r\n  let style;\r\n\r\n  return (olFeature: OlFeature<OlGeometry>, resolution) => {\r\n    if (olFeature.getId() === 'bufferFeature') {\r\n      style = createBufferStyle(\r\n        olFeature.get('bufferStroke'),\r\n        2,\r\n        olFeature.get('bufferFill'),\r\n        olFeature.get('bufferText')\r\n      );\r\n      return style;\r\n    } else {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle, olFeature, resolution);\r\n      }\r\n      const geometryType = olFeature.getGeometry().getType();\r\n      style = geometryType === 'Point' ? markerStyle : defaultStyle;\r\n      style.getText().setText(olFeature.get('_mapTitle'));\r\n      return style;\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create a basic style for lines and polygons\r\n * @returns Style\r\n */\r\nexport function createOverlayDefaultStyle({\r\n  text,\r\n  strokeWidth = 2,\r\n  fillColor = [0, 161, 222, 0.3],\r\n  strokeColor = [0, 161, 222, 0.9],\r\n}: {\r\n  text?: string;\r\n  strokeWidth?: number;\r\n  fillColor?: string | number[];\r\n  strokeColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n  const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeWithOpacity\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillWithOpacity\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n\r\nfunction createBufferStyle(\r\n  strokeRGBA: [number, number, number, number] = [0, 161, 222, 1],\r\n  strokeWidth: number = 2,\r\n  fillRGBA: [number, number, number, number] = [0, 161, 222, 0.15],\r\n  bufferRadius?\r\n): olstyle.Style {\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeRGBA\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillRGBA\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      font: '12px Calibri,sans-serif',\r\n      text: bufferRadius,\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature/shared';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\nimport { createOverlayLayer } from './overlay.utils';\r\n\r\n/**\r\n * This class is simply a shortcut for adding features to a map.\r\n * It does nothing more than a standard layer but it's shipped with\r\n * a defautl style based on the geometry type of the features it contains.\r\n * @todo Enhance that by using a FeatureStore and strategies.\r\n */\r\nexport class Overlay {\r\n  /**\r\n   * The map to add the layer to\r\n   */\r\n  private map: IgoMap;\r\n\r\n  /**\r\n   * Overlay layer\r\n   */\r\n  private layer: VectorLayer;\r\n\r\n  /**\r\n   * Overlay layer's data source\r\n   */\r\n  get dataSource(): FeatureDataSource {\r\n    return this.layer.dataSource as FeatureDataSource;\r\n  }\r\n\r\n  constructor(map?: IgoMap) {\r\n    this.layer = createOverlayLayer();\r\n    this.setMap(map);\r\n  }\r\n\r\n  /**\r\n   * Bind this to a map and add the overlay layer to that map\r\n   * @param map Map\r\n   */\r\n  setMap(map: IgoMap) {\r\n    if (map === undefined) {\r\n      if (this.map !== undefined) {\r\n        this.map.ol.removeLayer(this.layer.ol);\r\n      }\r\n    } else {\r\n      map.ol.addLayer(this.layer.ol);\r\n    }\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Set the overlay features and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   * @param sourceId Optional: Remove features of certain sourceId (ex: 'Map' for query features)\r\n   */\r\n  setFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    sourceId?: string\r\n  ) {\r\n    if (sourceId) {\r\n      for (const olFeature of this.dataSource.ol.getFeatures()) {\r\n        if (olFeature.get('_sourceId') === sourceId) {\r\n          this.removeOlFeature(olFeature);\r\n        }\r\n      }\r\n    } else {\r\n      this.clear();\r\n    }\r\n    this.addFeatures(features, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the  overlay and, optionally, move to it\r\n   * @param feature Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeature(feature: Feature, motion: FeatureMotion = FeatureMotion.Default) {\r\n    this.addFeatures([feature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add features to the  overlay and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    const olFeatures = [];\r\n    features.forEach((feature: Feature) => {\r\n      const olFeature = featureToOl(feature, this.map.projection);\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry === null) {\r\n        return;\r\n      }\r\n      olFeatures.push(olFeature);\r\n    });\r\n\r\n    this.addOlFeatures(olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a OpenLayers feature to the  overlay and, optionally, move to it\r\n   * @param olFeature OpenLayers Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeature(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.addOlFeatures([olFeature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add OpenLayers features to the overlay and, optionally, move to them\r\n   * @param olFeatures OpenLayers Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.dataSource.ol.addFeatures(olFeatures);\r\n    moveToOlFeatures(this.map, olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Remove a feature from the overlay\r\n   * @param feature Feature\r\n   */\r\n  removeFeature(feature: Feature) {\r\n    this.removeFeatures([feature]);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the overlay\r\n   * @param features Features\r\n   */\r\n  removeFeatures(features: Feature[]) {\r\n    features.forEach((feature: Feature) => {\r\n      if (feature.meta) {\r\n        if (this.dataSource.ol.getFeatureById(feature.meta.id)) {\r\n          this.removeOlFeature(this.dataSource.ol.getFeatureById(feature.meta.id));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove an OpenLayers feature from the overlay\r\n   * @param olFeature OpenLayers Feature\r\n   */\r\n  removeOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n    this.dataSource.ol.removeFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.dataSource.ol.clear();\r\n  }\r\n}\r\n","\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { createOverlayLayerStyle } from '../../style/shared/overlay/overlay-style.utils';\r\n\r\n\r\n/**\r\n * Create an overlay layer and it's source\r\n * @returns Overlay layer\r\n */\r\nexport function createOverlayLayer(): VectorLayer {\r\n  const overlayDataSource = new FeatureDataSource();\r\n  return new VectorLayer({\r\n    title: 'Overlay',\r\n    zIndex: 300,\r\n    source: overlayDataSource,\r\n    style: createOverlayLayerStyle()\r\n  });\r\n}\r\n","import { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { Layer, LinkedProperties } from '../../layer/shared/layers';\r\nimport { ObjectEvent } from 'ol/Object';\r\n\r\nexport class LayerWatcher extends Watcher {\r\n  public propertyChange$: BehaviorSubject<{event:ObjectEvent, layer: Layer}> = new BehaviorSubject(undefined);\r\n  private loaded = 0;\r\n  private loading = 0;\r\n  private layers: Layer[] = [];\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  watch() {}\r\n\r\n  unwatch() {\r\n    this.layers.forEach(layer => this.unwatchLayer(layer), this);\r\n  }\r\n\r\n  setPropertyChange(change: ObjectEvent, layer: Layer) {\r\n\r\n    if (![\r\n      LinkedProperties.TIMEFILTER,\r\n      LinkedProperties.OGCFILTERS,\r\n      LinkedProperties.VISIBLE,\r\n      LinkedProperties.OPACITY,\r\n      LinkedProperties.MINRESOLUTION,\r\n      LinkedProperties.MAXRESOLUTION]\r\n      .includes(change.key as any)) {\r\n      return;\r\n  }\r\n  this.propertyChange$.next({event: change, layer});\r\n  }\r\n\r\n  watchLayer(layer: Layer) {\r\n    if (layer.status$ === undefined) {\r\n      return;\r\n    }\r\n    layer.ol.on('propertychange', evt => this.setPropertyChange(evt, layer));\r\n    layer.dataSource.ol.on('propertychange', evt => this.setPropertyChange(evt, layer));\r\n\r\n\r\n    this.layers.push(layer);\r\n\r\n    const layer$$ = layer.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe(status => {\r\n        if (status === SubjectStatus.Error) {\r\n          this.loading = 0;\r\n          this.loaded = -1;\r\n        }\r\n        if (status === SubjectStatus.Working) {\r\n          this.loading += 1;\r\n        } else if (status === SubjectStatus.Done) {\r\n          this.loaded += 1;\r\n        }\r\n\r\n        if (this.loaded >= this.loading) {\r\n          this.loading = this.loaded = 0;\r\n          this.status = SubjectStatus.Done;\r\n        } else if (this.loading > 0) {\r\n          this.status = SubjectStatus.Working;\r\n        }\r\n      });\r\n\r\n    this.subscriptions.push(layer$$);\r\n  }\r\n\r\n  unwatchLayer(layer: Layer) {\r\n    layer.ol.un('propertychange', evt => this.setPropertyChange(evt,layer));\r\n    layer.dataSource.ol.un('propertychange', evt => this.setPropertyChange(evt, layer));\r\n    layer.status$.next(SubjectStatus.Done);\r\n    const index = this.layers.indexOf(layer);\r\n    if (index >= 0) {\r\n      const status = (layer as any).watcher.status;\r\n      if (\r\n        [SubjectStatus.Working, SubjectStatus.Waiting].indexOf(status) !== -1\r\n      ) {\r\n        this.loaded += 1;\r\n      }\r\n      this.subscriptions[index].unsubscribe();\r\n      this.subscriptions.splice(index, 1);\r\n      this.layers.splice(index, 1);\r\n      (layer as any).watcher.unwatch();\r\n    }\r\n  }\r\n}\r\n","export enum MapViewAction {\r\n  Move,\r\n  Zoom\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * Base map controller\r\n */\r\nexport class MapController {\r\n\r\n  /**\r\n   * OL Map\r\n   */\r\n  protected olMap: OlMap;\r\n\r\n  /**\r\n   * Array of observer keys\r\n   */\r\n  protected observerKeys: EventsKey[] = [];\r\n\r\n  /**\r\n   * Return the OL map this controller is bound to\r\n   * @returns OL Map\r\n   */\r\n  getOlMap(): OlMap {\r\n    return this.olMap;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap !== undefined && this.getOlMap() !== undefined) {\r\n      throw new Error('This controller is already bound to a map.');\r\n    }\r\n\r\n    if (olMap === undefined) {\r\n      this.teardownObservers();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    this.observerKeys.forEach((key: EventsKey) => unByKey(key));\r\n    this.observerKeys = [];\r\n  }\r\n\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlMapEvent from 'ol/MapEvent';\r\n\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport * as oleasing from 'ol/easing';\r\nimport * as olproj from 'ol/proj';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport OlView from 'ol/View';\r\n\r\nimport { MapViewAction } from '../map.enums';\r\nimport { MapExtent, MapViewState } from '../map.interface';\r\nimport { getScaleFromResolution, viewStatesAreEqual } from '../map.utils';\r\nimport { MapController } from './controller';\r\nimport { EventsKey } from 'ol/events';\r\nimport { ObjectEvent } from 'ol/Object';\r\n\r\nexport interface MapViewControllerOptions {\r\n  stateHistory: boolean;\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapViewController extends MapController {\r\n  /**\r\n   * Observable of the current rotation in radians\r\n   */\r\n   readonly rotation$ = new BehaviorSubject<number>(0);\r\n\r\n  /**\r\n   * Observable of the current resolution\r\n   */\r\n  resolution$ = new BehaviorSubject<number>(undefined);\r\n\r\n  /**\r\n   * Observable of the current state\r\n   */\r\n  state$ = new BehaviorSubject<MapViewState>(undefined);\r\n\r\n  /**\r\n   * View Padding\r\n   * Values in the array are top, right, bottom and left padding.\r\n   */\r\n  padding = [0, 0, 0, 0];\r\n\r\n  /**\r\n   * Max zoom after set extent\r\n   */\r\n  maxZoomOnExtent = 19;\r\n\r\n  /**\r\n   * Max extent possible when zooming\r\n   */\r\n  maxLayerZoomExtent: MapExtent;\r\n\r\n  /**\r\n   * Extent stream\r\n   */\r\n  private extent$ = new Subject<{ extent: MapExtent; action: MapViewAction }>();\r\n\r\n  /**\r\n   * Subscription to the movement stream\r\n   */\r\n  private extent$$: Subscription;\r\n\r\n  /**\r\n   * History of states\r\n   */\r\n  private states: MapViewState[] = [];\r\n\r\n  /**\r\n   * Current state index\r\n   */\r\n  private stateIndex: number = 0;\r\n\r\n  /**\r\n   * Whether the view controller should keep the view's state history\r\n   */\r\n  get stateHistory(): boolean {\r\n    return this.options ? this.options.stateHistory === true : false;\r\n  }\r\n\r\n  /**\r\n   * OL View\r\n   */\r\n  get olView(): OlView {\r\n    return this.olMap.getView();\r\n  }\r\n\r\n  constructor(private options?: MapViewControllerOptions) {\r\n    super();\r\n  }\r\n\r\n  setPadding(padding: { top?: number, bottom?: number, left?: number, right?: number }) {\r\n    // Values in the array are top, right, bottom and left padding.\r\n    if (padding.top || padding.top === 0) {\r\n      this.padding[0] = padding.top;\r\n    }\r\n    if (padding.right || padding.right === 0) {\r\n      this.padding[1] = padding.right;\r\n    }\r\n    if (padding.bottom || padding.bottom === 0) {\r\n      this.padding[2] = padding.bottom;\r\n    }\r\n    if (padding.left || padding.left === 0) {\r\n      this.padding[3] = padding.left;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  /**\r\n   * Observe move moveend and subscribe to the extent stream\r\n   */\r\n  setupObservers() {\r\n    if (this.stateHistory === true) {\r\n      this.observerKeys.push(\r\n        this.olMap.on('moveend', (event: OlMapEvent) => this.onMoveEnd(event)) as EventsKey\r\n      );\r\n    }\r\n\r\n    this.extent$$ = this.extent$\r\n      .pipe(debounceTime(25))\r\n      .subscribe((value: { extent: MapExtent; action: MapViewAction }) => {\r\n        this.setExtent(value.extent, value.action);\r\n      });\r\n  }\r\n\r\n  monitorRotation() {\r\n    this.observerKeys.push(\r\n      this.olMap.getView().on('change:rotation', (evt: ObjectEvent) => {\r\n        this.rotation$.next(evt.target.getRotation());\r\n      }) as EventsKey\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    super.teardownObservers();\r\n    if (this.extent$$ !== undefined) {\r\n      this.extent$$.unsubscribe();\r\n      this.extent$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the view's OL projection\r\n   * @returns OL projection\r\n   */\r\n  getOlProjection(): OlProjection {\r\n    return this.olView.getProjection();\r\n  }\r\n\r\n  /**\r\n   * Get the current map view center\r\n   * @param projection Output projection\r\n   * @returns Center\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    let center = this.olView.getCenter() as [number, number];\r\n    if (projection && center) {\r\n      center = olproj.transform(center, this.getOlProjection(), projection) as [number, number];\r\n    }\r\n    return center;\r\n  }\r\n\r\n  /**\r\n   * Get the current view extent\r\n   * @param projection Output projection\r\n   * @returns Extent\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    let extent = this.olView.calculateExtent(this.olMap.getSize());\r\n    if (projection && extent) {\r\n      extent = olproj.transformExtent(\r\n        extent,\r\n        this.getOlProjection(),\r\n        projection\r\n      );\r\n    }\r\n    return extent as [number, number, number, number];\r\n  }\r\n\r\n  /**\r\n   * Get the current scale\r\n   * @param dpi Dot per inches\r\n   * @returns View scale\r\n   */\r\n  getScale(dpi = 96) {\r\n    return getScaleFromResolution(\r\n      this.getResolution(),\r\n      this.getOlProjection().getUnits(),\r\n      dpi\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the current resolution\r\n   * @returns Projection denominator\r\n   */\r\n  getResolution(): number {\r\n    return this.olView.getResolution();\r\n  }\r\n\r\n  /**\r\n   * Get the current zoom level\r\n   * @returns Zoom level\r\n   */\r\n  getZoom(): number {\r\n    return Math.round(this.olView.getZoom());\r\n  }\r\n\r\n  /**\r\n   * Zoom in\r\n   */\r\n  zoomIn() {\r\n    this.zoomTo(this.olView.getZoom() + 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom out\r\n   */\r\n  zoomOut() {\r\n    this.zoomTo(this.olView.getZoom() - 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom to specific zoom level\r\n   * @param zoom Zoom level\r\n   */\r\n  zoomTo(zoom: number) {\r\n    this.olView.cancelAnimations();\r\n    this.olView.animate({\r\n      zoom,\r\n      duration: 250,\r\n      easing: oleasing.easeOut\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Move to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to move to\r\n   */\r\n  moveToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Move });\r\n  }\r\n\r\n  /**\r\n   * Zoom to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to zoom to\r\n   */\r\n  zoomToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Zoom });\r\n  }\r\n\r\n  /**\r\n   * Return the current view rotation\r\n   * @returns Rotation angle in radians\r\n   */\r\n  getRotation(): number {\r\n    return this.olView.getRotation();\r\n  }\r\n\r\n  /**\r\n   * Reset the view rotation to 0\r\n   */\r\n  resetRotation() {\r\n    this.olView.animate({ rotation: 0 });\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a previous state\r\n   * @returns True if the view has a previous state\r\n   */\r\n  hasPreviousState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a next state\r\n   * @returns True if the view has a next state\r\n   */\r\n  hasNextState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Restore the previous view state\r\n   */\r\n  previousState() {\r\n    if (this.hasPreviousState()) {\r\n      this.setStateIndex(this.stateIndex - 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restore the next view state\r\n   */\r\n  nextState() {\r\n    if (this.hasNextState()) {\r\n      this.setStateIndex(this.stateIndex + 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the state history\r\n   */\r\n  clearStateHistory() {\r\n    this.states = [];\r\n    this.stateIndex = 0;\r\n  }\r\n\r\n  /**\r\n   * Update the the view to it's intial state\r\n   */\r\n  setInitialState() {\r\n    if (this.states.length > 0) {\r\n      this.setStateIndex(0);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Move to the extent retrieved from the stream\r\n   * @param extent Extent\r\n   * @param action Either zoom or move\r\n   * @param animation With or without animation to the target extent.\r\n   */\r\n  private setExtent(\r\n    extent: MapExtent,\r\n    action: MapViewAction,\r\n    animation: boolean = true\r\n  ) {\r\n    const olView = this.olView;\r\n    olView.cancelAnimations();\r\n    const duration = animation ? 500 : 0;\r\n    const zoom = olView.getZoom();\r\n\r\n    const fromCenter = olView.getCenter();\r\n    const toCenter = [\r\n      extent[0] + (extent[2] - extent[0]) / 2,\r\n      extent[1] + (extent[3] - extent[1]) / 2\r\n    ];\r\n    const distCenter = Math.sqrt(\r\n      Math.pow(fromCenter[0] - toCenter[0], 2) +\r\n        Math.pow(fromCenter[1] - toCenter[1], 2)\r\n    );\r\n    const fromExtent = olView.calculateExtent();\r\n    const fromSize = Math.sqrt(\r\n      Math.pow(fromExtent[2] - fromExtent[0], 2) +\r\n        Math.pow(fromExtent[3] - fromExtent[1], 2)\r\n    );\r\n    const toSize = Math.sqrt(\r\n      Math.pow(extent[2] - extent[0], 2) + Math.pow(extent[3] - extent[1], 2)\r\n    );\r\n    const moySize = (toSize + fromSize) / 2;\r\n    const xSize = distCenter / moySize;\r\n\r\n    const maxZoom =\r\n      action === MapViewAction.Move || zoom > this.maxZoomOnExtent\r\n        ? zoom\r\n        : this.maxZoomOnExtent;\r\n\r\n    olView.fit(extent, {\r\n      size: this.olMap.getSize(),\r\n      maxZoom,\r\n      padding: this.padding,\r\n      duration: xSize > 4 ? 0 : duration,\r\n      callback: (isFinished: boolean) => {\r\n        if (!isFinished) {\r\n          olView.fit(extent, {\r\n            size: this.olMap.getSize(),\r\n            maxZoom,\r\n            padding: this.padding,\r\n            duration: xSize > 4 ? 0 : duration\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set the view state index\r\n   * @param index State index\r\n   */\r\n  private setStateIndex(index: number) {\r\n    this.stateIndex = index;\r\n    this.setState(this.states[index]);\r\n  }\r\n\r\n  /**\r\n   * Set the view state\r\n   * @param state View state\r\n   */\r\n  private setState(state: MapViewState) {\r\n    this.olView.animate({\r\n      resolution: state.resolution,\r\n      center: state.center,\r\n      duration: 0\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On move end, get the view state and record it.\r\n   * @param event Map event\r\n   */\r\n  private onMoveEnd(event: OlMapEvent) {\r\n    const resolution = this.getResolution();\r\n    if (this.resolution$.value !== resolution) {\r\n      this.resolution$.next(resolution);\r\n    }\r\n\r\n    const state = {\r\n      resolution,\r\n      center: this.getCenter(),\r\n      zoom: this.getZoom()\r\n    };\r\n\r\n    if (this.stateHistory === true) {\r\n      const stateIndex = this.stateIndex;\r\n      const stateAtIndex =\r\n        this.states.length === 0 ? undefined : this.states[stateIndex];\r\n      if (!viewStatesAreEqual(state, stateAtIndex)) {\r\n        this.states = this.states.slice(0, stateIndex + 1).concat([state]);\r\n        this.stateIndex = this.states.length - 1;\r\n      }\r\n    }\r\n\r\n    this.state$.next(state);\r\n  }\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport olGeolocation from 'ol/Geolocation';\r\nimport { BehaviorSubject, interval, Subscription } from 'rxjs';\r\nimport Geometry from 'ol/geom/Geometry';\r\nimport * as olproj from 'ol/proj';\r\nimport olFeature from 'ol/Feature';\r\nimport { MapController } from './controller';\r\nimport { Point, Polygon } from 'ol/geom';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport * as olSphere from 'ol/sphere';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport { IgoMap } from '../map';\r\nimport * as olstyle from 'ol/style';\r\nimport { Overlay } from '../../../overlay/shared/overlay';\r\nimport { FeatureMotion } from '../../../feature/shared/feature.enums';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { MapViewOptions } from '../map.interface';\r\nimport { switchMap } from 'rxjs/operators';\r\nimport { computeOlFeaturesExtent, featuresAreOutOfView, hideOlFeature, moveToOlFeatures } from '../../../feature/shared/feature.utils';\r\nexport interface MapGeolocationControllerOptions {\r\n  //  todo keepPositionHistory?: boolean;\r\n  projection: olproj.ProjectionLike\r\n  accuracyThreshold?: number;\r\n  followPosition?: boolean;\r\n  buffer?: GeolocationBuffer;\r\n}\r\nexport interface MapGeolocationState {\r\n  position: number[];\r\n  projection: string;\r\n  accuracy: number;\r\n  altitude: number;\r\n  altitudeAccuracy: number;\r\n  heading: number;\r\n  speed: number;\r\n  enableHighAccuracy: boolean;\r\n  timestamp: Date;\r\n}\r\nexport interface GeolocationBuffer {\r\n  bufferRadius?: number;\r\n  bufferStroke?: [number, number, number, number];\r\n  bufferFill?: [number, number, number, number];\r\n  showBufferRadius?: boolean;\r\n}\r\n\r\n\r\nenum GeolocationOverlayType {\r\n  Position = 'position',\r\n  PositionDirection = 'positionDirection',\r\n  Accuracy = 'accuracy',\r\n  Buffer = 'buffer'\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapGeolocationController extends MapController {\r\n\r\n  private arrowRotation: number;\r\n  private subscriptions$$: Subscription[] = [];\r\n  private geolocationOverlay: Overlay;\r\n  private positionFeatureStyle: olstyle.Style | olstyle.Style[] = new olstyle.Style({\r\n    image: new olstyle.Circle({\r\n      radius: 6,\r\n      fill: new olstyle.Fill({\r\n        color: '#3399CC',\r\n      }),\r\n      stroke: new olstyle.Stroke({\r\n        color: '#fff',\r\n        width: 2,\r\n      }),\r\n    }),\r\n  });\r\n  private accuracyFeatureStyle: olstyle.Style | olstyle.Style[] = new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: 'rgba(120, 120, 120, 0.4)',\r\n      width: 1,\r\n    }),\r\n    fill: new olstyle.Fill({\r\n      color: 'rgba(120, 120, 120, 0.4)',\r\n    }),\r\n  });\r\n\r\n  private get bufferStyle(): olstyle.Style {\r\n    return new olstyle.Style({\r\n      stroke: new olstyle.Stroke({ width: 2, color: this.buffer.bufferStroke }),\r\n      fill: new olstyle.Fill({ color: this.buffer.bufferFill }),\r\n      text: new olstyle.Text({\r\n        textAlign: 'left',\r\n        offsetX: 10,\r\n        offsetY: -10,\r\n        font: '12px Calibri,sans-serif',\r\n        text: this.buffer.showBufferRadius ? `${this.buffer.bufferRadius}m` : '',\r\n        fill: new olstyle.Fill({ color: '#000' }),\r\n        stroke: new olstyle.Stroke({ color: '#fff', width: 3 })\r\n      })\r\n    });\r\n  }\r\n\r\n  private get arrowStyle(): olstyle.Style {\r\n    return new olstyle.Style({\r\n      image: new olstyle.RegularShape({\r\n        radius: 5.5,\r\n        fill: new olstyle.Fill({\r\n          color: 'rgba(0, 132, 202)'\r\n        }),\r\n        stroke: new olstyle.Stroke({\r\n          color: '#fff',\r\n          width: 1.5,\r\n        }),\r\n        points: 3,\r\n        displacement: [0, 9],\r\n        rotation: this.arrowRotation,\r\n        rotateWithView: true\r\n      })\r\n    });\r\n  }\r\n\r\n  private geolocation: olGeolocation;\r\n\r\n  /**\r\n   * Observable of the current emission interval of the position. In seconds\r\n   */\r\n  public readonly emissionIntervalSeconds$: BehaviorSubject<number> = new BehaviorSubject(5);\r\n\r\n  /**\r\n   * Observable of the current position\r\n   */\r\n  public readonly position$ = new BehaviorSubject<MapGeolocationState>(undefined);\r\n  /**\r\n   * Observable of the tracking state\r\n   */\r\n  public readonly tracking$ = new BehaviorSubject<boolean>(undefined);\r\n  /**\r\n   * Observable of the follow position state\r\n   */\r\n  public readonly followPosition$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  private lastPosition: {coordinates: number[], dateTime: Date};\r\n\r\n  /**\r\n   * History of positions\r\n   */\r\n  // private positions: MapGeolocationState[] = [];\r\n\r\n  /**\r\n   * Whether the geolocate controller should keep the position history\r\n   */\r\n  /*\r\n  // todo: refine this method\r\n  set keepPositionHistory(value) {\r\n    this._keepPositionHistory = value;\r\n  }\r\n  get keepPositionHistory(): boolean {\r\n    return this._keepPositionHistory;\r\n  }\r\n  private _keepPositionHistory: boolean = this.options && this.options.keepPositionHistory ? this.options.keepPositionHistory : true;\r\n*/\r\n  /**\r\n   * Whether the geolocate should show a buffer around the current position\r\n   */\r\n  set buffer(value: GeolocationBuffer) {\r\n    this._buffer = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n  }\r\n  get buffer(): GeolocationBuffer {\r\n    return this._buffer;\r\n  }\r\n  private _buffer: GeolocationBuffer = this.options && this.options.buffer ? this.options.buffer : undefined;\r\n\r\n  /**\r\n   * Whether the geolocate controller accuracy threshold to store/show the position.\r\n   */\r\n  set accuracyThreshold(value: number) {\r\n    this._accuracyThreshold = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n  }\r\n\r\n  get accuracyThreshold(): number {\r\n    return this._accuracyThreshold;\r\n  }\r\n  private _accuracyThreshold = this.options && this.options.accuracyThreshold ? this.options.accuracyThreshold : 5000;\r\n\r\n\r\n  get olGeolocation() {\r\n    return this.geolocation;\r\n  }\r\n\r\n  /**\r\n   * Whether the activate the geolocation.\r\n   */\r\n  get tracking() {\r\n    return this.geolocation.getTracking();\r\n  }\r\n\r\n  set tracking(value: boolean) {\r\n    this.geolocation.setTracking(value || false);\r\n    this.tracking$.next(value);\r\n    if (this.storageService && value !== undefined) {\r\n      this.storageService.set('geolocation.tracking', value);\r\n    }\r\n    if (!value) {\r\n      this.position$.next(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Whether the activate the view tracking of the current position\r\n   */\r\n  set followPosition(value: boolean) {\r\n    this._followPosition = value;\r\n    this.followPosition$.next(value);\r\n    if (this.configService?.getConfig('geolocate.followPosition') === false) {\r\n      this._followPosition = false;\r\n      this.followPosition$.next(false);\r\n    }\r\n    this.handleFeatureCreation(this.position$.value);\r\n    if (this.storageService && value !== undefined) {\r\n      this.storageService.set('geolocation.followPosition', value);\r\n    }\r\n  }\r\n\r\n  get followPosition() {\r\n    return this._followPosition;\r\n  }\r\n\r\n\r\n  private _followPosition = this.options && this.options.followPosition ? this.options.followPosition : false;\r\n\r\n\r\n  constructor(\r\n    private map: IgoMap,\r\n    private options?: MapGeolocationControllerOptions,\r\n    private storageService?: StorageService,\r\n    private configService?: ConfigService) {\r\n    super();\r\n    this.geolocationOverlay = new Overlay(this.map);\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  private deleteGeolocationFeatures() {\r\n    this.deleteFeatureByType(GeolocationOverlayType.Position);\r\n    this.deleteFeatureByType(GeolocationOverlayType.PositionDirection);\r\n    this.deleteFeatureByType(GeolocationOverlayType.Accuracy);\r\n    this.deleteFeatureByType(GeolocationOverlayType.Buffer);\r\n  }\r\n\r\n  setupObservers() {\r\n    this.tracking$.subscribe(tracking => {\r\n      if (tracking) {\r\n        this.onPositionChange(true, true);\r\n      } else {\r\n        this.deleteGeolocationFeatures();\r\n      }\r\n    });\r\n\r\n    this.geolocation = new olGeolocation({\r\n      // enableHighAccuracy must be set to true to have the heading value.\r\n      trackingOptions: {\r\n        enableHighAccuracy: true,\r\n        maximumAge: 10000,\r\n        timeout: 600000\r\n      },\r\n      projection: this.options.projection,\r\n    });\r\n    let tracking = false;\r\n    this.subscriptions$$.push(this.emissionIntervalSeconds$\r\n      .pipe(switchMap(value => interval(value * 1000)))\r\n      .subscribe(() => {\r\n        if (tracking === this.tracking) {\r\n          this.onPositionChange(true);\r\n        } else {\r\n          tracking = this.tracking;\r\n          this.onPositionChange(true, true);\r\n        }\r\n      }));\r\n\r\n    this.geolocation.on('change', (evt) => {\r\n      this.onPositionChange(false, false);\r\n    });\r\n  }\r\n\r\n  updateArrowFeatureOrientation(position: MapGeolocationState) {\r\n    const position4326 = olproj.transform(position.position, position.projection, 'EPSG:4326');\r\n    if(!this.lastPosition) {\r\n      this.lastPosition = {coordinates: position4326, dateTime: new Date()};\r\n      return;\r\n    }\r\n    const arrowFeature = this.getFeatureByType(GeolocationOverlayType.PositionDirection);\r\n    const isMoving = position?.speed > 1.25 && this.distanceBetweenPoints(this.lastPosition.coordinates, position4326) > 0.003;\r\n    if(position.accuracy <= this.accuracyThreshold && isMoving) {\r\n      // Calculate the heading using current position and last recorded\r\n      // because ol heading not returning right value\r\n      var dx = position4326[1] - this.lastPosition.coordinates[1];\r\n      var dy = position4326[0] - this.lastPosition.coordinates[0];\r\n      var theta = Math.atan2(dy, dx);\r\n      if (theta < 0) theta = (2*Math.PI) + theta;\r\n      this.arrowRotation = theta;\r\n      if(arrowFeature) {\r\n        arrowFeature.setStyle(this.arrowStyle);\r\n      }\r\n      this.lastPosition = {coordinates: position4326, dateTime: new Date()};\r\n    }\r\n    else {\r\n      if(arrowFeature && ((new Date()).getTime() - this.lastPosition.dateTime.getTime()) > 3000)\r\n        hideOlFeature(arrowFeature);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @returns distance in km between coord1 and coord2\r\n   */\r\n  private distanceBetweenPoints(coord1: number[], coord2: number[]): number{\r\n    return olSphere.getDistance(coord1, coord2) / 1000;\r\n  }\r\n\r\n  public addOnChangedListener(event: (geo: olGeolocation) => any) {\r\n    let listener = () => {\r\n      event(this.geolocation);\r\n    };\r\n    this.geolocation.on(\"change\", listener);\r\n    return listener;\r\n  }\r\n\r\n  public deleteChangedListener(event: () => any) {\r\n    this.geolocation.un(\"change\", event);\r\n  }\r\n\r\n  public updateGeolocationOptions(options: MapViewOptions) {\r\n    if (!options) { return; }\r\n    // todo maybe a dedicated interface for geolocation should be defined instead of putting these inside the mapviewoptions?\r\n    let tracking = options.geolocate;\r\n    let followPosition = options.alwaysTracking;\r\n    if (this.storageService) {\r\n      const storedTracking = this.storageService.get('geolocation.tracking') as boolean;\r\n      if (storedTracking !== null && storedTracking !== undefined) {\r\n        tracking = storedTracking;\r\n      }\r\n\r\n      const storedFollowPosition = this.storageService.get('geolocation.followPosition') as boolean;\r\n      if (storedFollowPosition !== null && storedFollowPosition !== undefined) {\r\n        followPosition = storedFollowPosition;\r\n      }\r\n    }\r\n    this.tracking = tracking;\r\n    this.followPosition = followPosition;\r\n    this.buffer = options.buffer;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    if (this.subscriptions$$.length) {\r\n      this.subscriptions$$.map(s => s.unsubscribe());\r\n    }\r\n    super.teardownObservers();\r\n  }\r\n\r\n  /**\r\n   * Clear the position  history\r\n   */\r\n  /*\r\n  // todo\r\n  clearPositionsHistory() {\r\n    this.positions = [];\r\n  }*/\r\n\r\n  /**\r\n   * On position change, get the position, show it on the map and record it.\r\n   * @param emitEvent Map event\r\n   */\r\n  private onPositionChange(emitEvent: boolean = false, zoomTo: boolean = false) {\r\n    if (!this.tracking) {\r\n      return;\r\n    }\r\n    const geolocateProperties = this.geolocation.getProperties();\r\n\r\n    if (geolocateProperties.accuracy > this.accuracyThreshold) {\r\n      console.warn('Poor geolocation accuracy. No position are stored/shown');\r\n      this.position$.next(undefined);\r\n      return;\r\n    }\r\n\r\n    const position: MapGeolocationState = {\r\n      position: geolocateProperties.position,\r\n      projection: this.geolocation.getProjection().getCode(),\r\n      accuracy: geolocateProperties.accuracy,\r\n      altitude: geolocateProperties.altitude,\r\n      altitudeAccuracy: geolocateProperties.altitudeAccuracy,\r\n      heading: geolocateProperties.heading,\r\n      speed: geolocateProperties.speed,\r\n      enableHighAccuracy: geolocateProperties.trackingOptions?.enableHighAccuracy ? true : false,\r\n      timestamp: new Date()\r\n    };\r\n    this.handleFeatureCreation(position);\r\n    this.handleViewFromFeatures(position, zoomTo);\r\n    if (emitEvent) {\r\n      this.position$.next(position);\r\n      /*if (this.keepPositionHistory === true) {\r\n        // handle position diff to store only true diff;\r\n        this.positions.push(position);\r\n      }*/\r\n    }\r\n  }\r\n\r\n  private getFeatureByType(type: GeolocationOverlayType): olFeature<Geometry> {\r\n    return this.geolocationOverlay.dataSource.ol.getFeatureById(type);\r\n  }\r\n\r\n  private deleteFeatureByType(type: GeolocationOverlayType) {\r\n    const featureById = this.geolocationOverlay.dataSource.ol.getFeatureById(type);\r\n    if (featureById) {\r\n      this.geolocationOverlay.dataSource.ol.removeFeature(featureById);\r\n    }\r\n  }\r\n\r\n  private handleFeatureCreation(position: MapGeolocationState) {\r\n    if (!position || !position.position) {\r\n      return;\r\n    }\r\n    const positionGeometry = new Point(position.position);\r\n    const accuracyGeometry = fromCircle(new OlCircle(position.position, position.accuracy || 0));\r\n    let positionFeature = this.getFeatureByType(GeolocationOverlayType.Position);\r\n    let positionFeatureArrow = this.getFeatureByType(GeolocationOverlayType.PositionDirection);\r\n    let accuracyFeature = this.getFeatureByType(GeolocationOverlayType.Accuracy);\r\n    const positionFeatureExists = positionFeature ? true : false;\r\n    const positionFeatureArrowExists = positionFeatureArrow ? true : false;\r\n    const accuracyFeatureExists = accuracyFeature ? true : false;\r\n    if (!positionFeatureArrowExists) {\r\n      positionFeatureArrow = new olFeature<Point>({ geometry: positionGeometry });\r\n      positionFeatureArrow.setId(GeolocationOverlayType.PositionDirection);\r\n      hideOlFeature(positionFeatureArrow);\r\n    }\r\n    if (!positionFeatureExists) {\r\n      positionFeature = new olFeature<Point>({ geometry: positionGeometry });\r\n      positionFeature.setId(GeolocationOverlayType.Position);\r\n      positionFeature.setStyle(this.positionFeatureStyle);\r\n    }\r\n    if (!accuracyFeatureExists) {\r\n      accuracyFeature = new olFeature<Polygon>({ geometry: accuracyGeometry });\r\n      accuracyFeature.setId(GeolocationOverlayType.Accuracy);\r\n      accuracyFeature.setStyle(this.accuracyFeatureStyle);\r\n    }\r\n\r\n    if (positionGeometry) {\r\n      positionFeatureExists ?\r\n        positionFeature.setGeometry(positionGeometry) : this.geolocationOverlay.addOlFeature(positionFeature, FeatureMotion.None);\r\n      positionFeatureArrowExists ?\r\n        positionFeatureArrow.setGeometry(positionGeometry) : this.geolocationOverlay.addOlFeature(positionFeatureArrow, FeatureMotion.None);\r\n      this.updateArrowFeatureOrientation(position);\r\n      accuracyFeatureExists ?\r\n        accuracyFeature.setGeometry(accuracyGeometry) : this.geolocationOverlay.addOlFeature(accuracyFeature, FeatureMotion.None);\r\n\r\n      if (this.buffer) {\r\n        let bufferFeature = this.getFeatureByType(GeolocationOverlayType.Buffer);\r\n        const bufferFeatureExists = bufferFeature ? true : false;\r\n        const bufferGeometry = new OlCircle(position.position, this.buffer.bufferRadius);\r\n        if (!bufferFeatureExists) {\r\n          bufferFeature = new olFeature(bufferGeometry);\r\n          bufferFeature.setId(GeolocationOverlayType.Buffer);\r\n          bufferFeature.setStyle(this.positionFeatureStyle);\r\n        }\r\n        bufferFeature.setStyle(this.bufferStyle);\r\n        bufferFeatureExists ?\r\n          bufferFeature.setGeometry(bufferGeometry) : this.geolocationOverlay.addOlFeature(bufferFeature, FeatureMotion.None);\r\n      }\r\n    }\r\n\r\n  }\r\n  handleViewFromFeatures(position: MapGeolocationState, zoomTo: boolean = false) {\r\n    let positionFeature = this.getFeatureByType(GeolocationOverlayType.Position);\r\n    let positionFeatureArrow = this.getFeatureByType(GeolocationOverlayType.PositionDirection);\r\n    let accuracyFeature = this.getFeatureByType(GeolocationOverlayType.Accuracy);\r\n    let bufferFeature = this.getFeatureByType(GeolocationOverlayType.Buffer);\r\n    const features = [positionFeature, positionFeatureArrow, accuracyFeature, bufferFeature].filter(f => f);\r\n    if (features.length > 0) {\r\n      const featuresExtent = computeOlFeaturesExtent(this.map, features);\r\n      const edgeRatios = position?.speed > 12.5 ? [0.25,0.25,0.25,0.25] : [0.15,0.1,0.1,0.1];\r\n      const areOutOfView = featuresAreOutOfView(this.map, featuresExtent, edgeRatios);\r\n      let motion = this.followPosition && areOutOfView ? FeatureMotion.Move : FeatureMotion.None;\r\n      if (zoomTo) {\r\n        motion = FeatureMotion.Zoom;\r\n      }\r\n      motion !== FeatureMotion.None ? moveToOlFeatures(this.map, features, motion) : undefined;\r\n    }\r\n  }\r\n}\r\n","import { ObjectEvent } from \"ol/Object\";\r\nimport { getUid } from \"ol/util\";\r\nimport { WMSDataSource } from \"../../datasource/shared/datasources/wms-datasource\";\r\nimport { OgcFilterableDataSource, OgcFilterableDataSourceOptions } from \"../../filter/shared/ogc-filter.interface\";\r\nimport { TimeFilterableDataSource, TimeFilterableDataSourceOptions } from \"../../filter/shared/time-filter.interface\";\r\nimport { Layer, LinkedProperties } from \"../../layer/shared/layers\";\r\nimport { IgoMap } from \"./map\";\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\n\r\nexport function getLinkedLayersOptions(layer: Layer) {\r\n    return layer.options.linkedLayers;\r\n}\r\n\r\nexport function getIgoLayerByLinkId(map: IgoMap, id: string) {\r\n    return map.layers.find(l => l.options.linkedLayers?.linkId === id);\r\n}\r\n\r\nexport function layerHasLinkWithProperty(layer: Layer, property: LinkedProperties): boolean {\r\n    let hasLinkWithProperty = false;\r\n    const layerLLOptions = getLinkedLayersOptions(layer);\r\n    if (layerLLOptions?.links) {\r\n        const link = layerLLOptions.links.find(l => l.properties.includes(property));\r\n        hasLinkWithProperty = link ? true : false;\r\n    }\r\n    return hasLinkWithProperty;\r\n}\r\n\r\nexport function layerHasLinkDeletion(layer: Layer): boolean {\r\n  let hasLinkWithSyncedDelete = false;\r\n  const layerLLOptions = getLinkedLayersOptions(layer);\r\n  if (layerLLOptions?.links) {\r\n      const link = layerLLOptions.links.find(l => l.syncedDelete);\r\n      hasLinkWithSyncedDelete = link ? true : false;\r\n  }\r\n  return hasLinkWithSyncedDelete;\r\n}\r\n\r\nexport function getRootParentByProperty(map: IgoMap, layer: Layer, property: LinkedProperties): Layer {\r\n    let layerToUse = layer;\r\n    let parentLayer = layerToUse;\r\n    let hasParentLayer = true;\r\n    while (hasParentLayer) {\r\n        layerToUse = parentLayer;\r\n        parentLayer = getDirectParentLayerByProperty(map, layerToUse, property);\r\n        hasParentLayer = parentLayer ? true : false;\r\n    }\r\n    if (!hasParentLayer) {\r\n        if (!layerHasLinkWithProperty(layerToUse,property)) {\r\n            layerToUse = undefined;\r\n        }\r\n    }\r\n    return hasParentLayer ? parentLayer : layerToUse;\r\n}\r\n\r\nexport function getDirectParentLayerByProperty(map: IgoMap, layer: Layer, property: LinkedProperties): Layer {\r\n    if (layer?.options.linkedLayers?.linkId) {\r\n        const currentLinkId = layer.options.linkedLayers.linkId;\r\n        let parents = map.layers.filter(pl => {\r\n            const linkedLayers = pl.options.linkedLayers;\r\n            if (linkedLayers && linkedLayers.links) {\r\n                const a = linkedLayers.links.find(l => l.linkedIds.includes(currentLinkId) && l.properties.includes(property));\r\n                return a;\r\n            }\r\n        });\r\n        if (parents.length > 1) {\r\n            console.warn(`Your layer ${layer.title || layer.id} must only have 1 parent (${parents.map(p => p.title || p.id)})\r\n            , The first parent (${parents[0].title || parents[0].id}) will be use to sync properties`);\r\n        }\r\n        return parents[0];\r\n    }\r\n}\r\n\r\nexport function getDirectChildLayersByProperty(map: IgoMap, layer: Layer, property: LinkedProperties): Layer[] {\r\n    let linkedIds = [];\r\n    if (layer?.options.linkedLayers?.links) {\r\n        layer.options.linkedLayers.links\r\n        .filter(l => l.properties.includes(property))\r\n        .map(link => {\r\n            linkedIds = linkedIds.concat(link.linkedIds);});\r\n    }\r\n    return linkedIds.map(lid => getIgoLayerByLinkId(map, lid));\r\n}\r\n\r\nexport function getAllChildLayersByProperty(map: IgoMap, layer: Layer, knownChildLayers: Layer[], property: LinkedProperties): Layer[] {\r\n    let childLayers = getDirectChildLayersByProperty(map, layer,property);\r\n    childLayers.map(cl => {\r\n        knownChildLayers.push(cl);\r\n        const directChildLayers = getDirectChildLayersByProperty(map, cl, property);\r\n        if (directChildLayers) {\r\n            getAllChildLayersByProperty(map, cl, knownChildLayers, property);\r\n        }\r\n\r\n    });\r\n    return knownChildLayers;\r\n}\r\n\r\nexport function getRootParentByDeletion(map: IgoMap, layer: Layer): Layer {\r\n  let layerToUse = layer;\r\n  let parentLayer = layerToUse;\r\n  let hasParentLayer = true;\r\n  while (hasParentLayer) {\r\n      layerToUse = parentLayer;\r\n      parentLayer = getDirectParentLayerByDeletion(map, layerToUse);\r\n      hasParentLayer = parentLayer ? true : false;\r\n  }\r\n  if (!hasParentLayer) {\r\n    if (!layerHasLinkDeletion(layerToUse)) {\r\n      layerToUse = undefined;\r\n    }\r\n  }\r\n  return hasParentLayer ? parentLayer : layerToUse;\r\n}\r\n\r\nexport function getDirectParentLayerByDeletion(map: IgoMap, layer: Layer): Layer {\r\n  if (layer.options.linkedLayers?.linkId) {\r\n      const currentLinkId = layer.options.linkedLayers.linkId;\r\n      let parents = map.layers.filter(pl => {\r\n          const linkedLayers = pl.options.linkedLayers;\r\n          if (linkedLayers && linkedLayers.links) {\r\n              const a = linkedLayers.links.find(l => (l.linkedIds.includes(currentLinkId) && l.syncedDelete));\r\n              return a;\r\n          }\r\n      });\r\n      if (parents.length > 1) {\r\n          console.warn(`Your layer ${layer.title || layer.id} must only have 1 parent (${parents.map(p => p.title || p.id)})\r\n          , The first parent (${parents[0].title || parents[0].id}) will be use to sync properties`);\r\n      }\r\n      return parents[0];\r\n  }\r\n}\r\n\r\nexport function getDirectChildLayersByDeletion(map: IgoMap, layer: Layer): Layer[] {\r\n  let linkedIds = [];\r\n  if (layer?.options.linkedLayers?.links) {\r\n      layer.options.linkedLayers.links\r\n      .filter(l => l.syncedDelete)\r\n      .map(link => {\r\n          linkedIds = linkedIds.concat(link.linkedIds);});\r\n  }\r\n  return linkedIds.map(lid => getIgoLayerByLinkId(map, lid));\r\n}\r\n\r\nexport function getAllChildLayersByDeletion(map: IgoMap, layer: Layer, knownChildLayers: Layer[]): Layer[] {\r\n  let childLayers = getDirectChildLayersByDeletion(map, layer);\r\n  childLayers.map(cl => {\r\n      knownChildLayers.push(cl);\r\n      const directChildLayers = getDirectChildLayersByDeletion(map, cl);\r\n      if (directChildLayers) {\r\n        getAllChildLayersByDeletion(map, cl, knownChildLayers);\r\n      }\r\n\r\n  });\r\n  return knownChildLayers;\r\n}\r\n\r\nexport function initLayerSyncFromRootParentLayers(map: IgoMap, layers: Layer[]) {\r\n    const rootLayersByProperty = {};\r\n    const keys = Object.keys(LinkedProperties);\r\n    keys.map(k => {\r\n      rootLayersByProperty[LinkedProperties[k]] = [];\r\n    });\r\n    layers\r\n      .filter(l => getLinkedLayersOptions(l))\r\n      .map(l => {\r\n        keys.map(key => {\r\n          const k = LinkedProperties[key];\r\n          const plbp = getRootParentByProperty(map, l, k as LinkedProperties);\r\n          const layers = rootLayersByProperty[k];\r\n          const layersId = layers.map(l => l.id);\r\n          if (plbp && !layersId.includes(plbp.id)) {\r\n            rootLayersByProperty[k].push(plbp);\r\n          }\r\n        });\r\n      });\r\n    Object.keys(rootLayersByProperty).map(k => {\r\n      const layers = rootLayersByProperty[k];\r\n      layers.map((l: Layer) => l.ol.notify(k, undefined));\r\n    });\r\n  }\r\n\r\n  export function handleLayerPropertyChange(map: IgoMap, propertyChange: ObjectEvent, initiatorIgoLayer: Layer) {\r\n    if (!propertyChange) {\r\n      return;\r\n    }\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    let isLayerProperty = true;\r\n    let isDatasourceProperty = true;\r\n    const key = propertyChange.key;\r\n    let newValue;\r\n    if (key === 'ogcFilters') {\r\n      isLayerProperty = false;\r\n      isDatasourceProperty = true;\r\n      newValue = (initiatorIgoLayer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    } else if (key === 'timeFilter') {\r\n      isLayerProperty = false;\r\n      isDatasourceProperty = true;\r\n      newValue = (initiatorIgoLayer.dataSource.options as TimeFilterableDataSourceOptions).timeFilter;\r\n    } else {\r\n      isLayerProperty = true;\r\n      isDatasourceProperty = false;\r\n      newValue = initiatorIgoLayer.ol.get(key);\r\n    }\r\n\r\n    const initiatorLinkedLayersOptions = getLinkedLayersOptions(initiatorIgoLayer);\r\n    if (initiatorLinkedLayersOptions) {\r\n      let rootParentByProperty = getRootParentByProperty(map,initiatorIgoLayer, key as LinkedProperties);\r\n      if (!rootParentByProperty) {\r\n        rootParentByProperty = initiatorIgoLayer;\r\n      }\r\n\r\n      const clbp = [rootParentByProperty];\r\n      getAllChildLayersByProperty(map, rootParentByProperty, clbp, key as LinkedProperties);\r\n\r\n      let resolutionPropertyHasChanged = false;\r\n      const initiatorIgoLayerSourceType = initiatorIgoLayer.options.source.options.type;\r\n      const initiatorIgoLayerOgcFilterableDataSourceOptions = initiatorIgoLayer.dataSource.options as OgcFilterableDataSourceOptions;\r\n      clbp.map(l => {\r\n        if (initiatorIgoLayer && l && getUid(initiatorIgoLayer.ol) !== getUid(l?.ol)) {\r\n          const lLayerType = l.options.source.options.type;\r\n          if (isLayerProperty) {\r\n          l.ol.set(key, newValue, true);\r\n          if (key === 'visible') {\r\n            l.visible$.next(newValue);\r\n          }\r\n          if (key === 'minResolution' || key === 'maxResolution') {\r\n            resolutionPropertyHasChanged = true;\r\n          }\r\n          } else if (isDatasourceProperty) {\r\n            if (key === 'ogcFilters') {\r\n              (l.dataSource as OgcFilterableDataSource).setOgcFilters(newValue, false);\r\n              if (lLayerType === 'wfs') {\r\n                l.ol.getSource().refresh();\r\n              }\r\n              if (lLayerType === 'wms') {\r\n                let appliedOgcFilter;\r\n                if (initiatorIgoLayerSourceType === 'wfs') {\r\n                  appliedOgcFilter = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n                    initiatorIgoLayerOgcFilterableDataSourceOptions,\r\n                    (initiatorIgoLayer.dataSource.options as any).fieldNameGeometry,\r\n                    undefined,\r\n                    map.viewController.getOlProjection()\r\n                  );\r\n                } else if (initiatorIgoLayerSourceType === 'wms') {\r\n                  appliedOgcFilter = (initiatorIgoLayer.dataSource as WMSDataSource).ol.getParams().FILTER;\r\n                }\r\n                (l.dataSource as WMSDataSource).ol.updateParams({ FILTER: appliedOgcFilter });\r\n              }\r\n            } else if (l.dataSource instanceof WMSDataSource && key === 'timeFilter') {\r\n              (l.dataSource as TimeFilterableDataSource).setTimeFilter(newValue, false);\r\n              const appliedTimeFilter = (initiatorIgoLayer.ol.getSource() as olSourceImageWMS).getParams().TIME;\r\n              l.dataSource.ol.updateParams({ TIME: appliedTimeFilter });\r\n            }\r\n          }\r\n        }\r\n      });\r\n      if (resolutionPropertyHasChanged) {\r\n        map.viewController.resolution$.next(map.viewController.resolution$.value);\r\n      }\r\n\r\n\r\n    }\r\n  }\r\n","import olMap from 'ol/Map';\r\nimport olView from 'ol/View';\r\nimport olControlAttribution from 'ol/control/Attribution';\r\nimport olControlScaleLine from 'ol/control/ScaleLine';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport * as olinteraction from 'ol/interaction';\r\nimport {getUid} from 'ol/util';\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\n\r\nimport proj4 from 'proj4';\r\nimport { BehaviorSubject, skipWhile, Subject } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { Layer, VectorLayer } from '../../layer/shared/layers';\r\nimport { Overlay } from '../../overlay/shared/overlay';\r\n\r\nimport { LayerWatcher } from '../utils/layer-watcher';\r\nimport {\r\n  MapViewOptions,\r\n  MapOptions,\r\n  MapAttributionOptions,\r\n  MapScaleLineOptions,\r\n  MapExtent,\r\n  MapControlsOptions\r\n} from './map.interface';\r\nimport { MapViewController } from './controllers/view';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { MapGeolocationController } from './controllers/geolocation';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { ObjectEvent } from 'ol/Object';\r\nimport {\r\n  getAllChildLayersByDeletion,\r\n  getRootParentByDeletion,\r\n  handleLayerPropertyChange,\r\n  initLayerSyncFromRootParentLayers\r\n} from './linkedLayers.utils';\r\n\r\n// TODO: This class is messy. Clearly define it's scope and the map browser's.\r\n// Move some stuff into controllers.\r\nexport class IgoMap {\r\n  public ol: olMap;\r\n  public forcedOffline$ = new BehaviorSubject<boolean>(false);\r\n  public layers$ = new BehaviorSubject<Layer[]>([]);\r\n  public layersAddedByClick$ = new BehaviorSubject<Layer[]>(undefined);\r\n  public status$: Subject<SubjectStatus>;\r\n  public propertyChange$: Subject<{event:ObjectEvent, layer: Layer}>;\r\n  public overlay: Overlay;\r\n  public queryResultsOverlay: Overlay;\r\n  public searchResultsOverlay: Overlay;\r\n  public viewController: MapViewController;\r\n  public geolocationController: MapGeolocationController;\r\n  public swipeEnabled$ = new BehaviorSubject<boolean>(false);\r\n  public mapCenter$ = new BehaviorSubject<boolean>(false);\r\n  public selectedFeatures$ = new BehaviorSubject<Layer[]>(null);\r\n\r\n  public bufferDataSource: FeatureDataSource;\r\n\r\n  private layerWatcher: LayerWatcher;\r\n  private options: MapOptions;\r\n  private mapViewOptions: MapViewOptions;\r\n  private defaultOptions: Partial<MapOptions> = {\r\n    controls: { attribution: false }\r\n  };\r\n\r\n  get layers(): Layer[] {\r\n    return this.layers$.value;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.viewController.getOlProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    options?: MapOptions,\r\n    private storageService?: StorageService,\r\n    private configService?: ConfigService) {\r\n    this.options = Object.assign({}, this.defaultOptions, options);\r\n    this.layerWatcher = new LayerWatcher();\r\n    this.status$ = this.layerWatcher.status$;\r\n    this.propertyChange$ = this.layerWatcher.propertyChange$;\r\n    olproj4.register(proj4);\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    const controls = [];\r\n    if (this.options.controls) {\r\n      if (this.options.controls.attribution) {\r\n        const attributionOpt = (this.options.controls.attribution === true\r\n          ? {}\r\n          : this.options.controls.attribution) as MapAttributionOptions;\r\n        controls.push(new olControlAttribution(attributionOpt));\r\n      }\r\n      if (this.options.controls.scaleLine) {\r\n        const scaleLineOpt = (this.options.controls.scaleLine === true\r\n          ? {}\r\n          : this.options.controls.scaleLine) as MapScaleLineOptions;\r\n        controls.push(new olControlScaleLine(scaleLineOpt));\r\n      }\r\n    }\r\n    let interactions = {};\r\n    if (this.options.interactions === false) {\r\n      interactions = {\r\n        altShiftDragRotate: false,\r\n        doubleClickZoom: false,\r\n        keyboard: false,\r\n        mouseWheelZoom: false,\r\n        shiftDragZoom: false,\r\n        dragPan: false,\r\n        pinchRotate: false,\r\n        pinchZoom: false\r\n      };\r\n    }\r\n\r\n    this.ol = new olMap({\r\n      interactions: olinteraction.defaults(interactions),\r\n      controls\r\n    });\r\n\r\n    this.setView(this.options.view || {});\r\n    this.viewController = new MapViewController({\r\n      stateHistory: true\r\n    });\r\n    this.viewController.setOlMap(this.ol);\r\n    this.overlay = new Overlay(this);\r\n    this.queryResultsOverlay = new Overlay(this);\r\n    this.searchResultsOverlay = new Overlay(this);\r\n    this.ol.once('rendercomplete', () => {\r\n      this.geolocationController = new MapGeolocationController(\r\n        this,\r\n        {\r\n          projection: this.viewController.getOlProjection()\r\n        },\r\n        this.storageService,\r\n        this.configService);\r\n      this.geolocationController.setOlMap(this.ol);\r\n      if (this.geolocationController) {\r\n        this.geolocationController.updateGeolocationOptions(this.mapViewOptions);\r\n      }\r\n      this.layers$.subscribe((layers) => {\r\n        for (const layer of layers) {\r\n          if (layer.options.linkedLayers) {\r\n            layer.ol.once('postrender', () => {\r\n              initLayerSyncFromRootParentLayers(this, this.layers);\r\n            });\r\n          }\r\n        }\r\n      });\r\n      this.viewController.monitorRotation();\r\n  });\r\n  this.propertyChange$.pipe(skipWhile((pc) => !pc)).subscribe(p => handleLayerPropertyChange(this, p.event, p.layer));\r\n  }\r\n\r\n\r\n  setTarget(id: string) {\r\n    this.ol.setTarget(id);\r\n    if (id !== undefined) {\r\n      this.layerWatcher.subscribe(() => { }, null);\r\n    } else {\r\n      this.layerWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  updateView(options: MapViewOptions) {\r\n    const currentView = this.ol.getView();\r\n    const viewOptions = Object.assign(\r\n      {\r\n        zoom: currentView.getZoom()\r\n      },\r\n      currentView.getProperties()\r\n    );\r\n\r\n    this.setView(Object.assign(viewOptions, options));\r\n    if (options.maxZoomOnExtent) {\r\n      this.viewController.maxZoomOnExtent = options.maxZoomOnExtent;\r\n    }\r\n    this.mapViewOptions = options;\r\n  }\r\n\r\n  /**\r\n   * Set the map view\r\n   * @param options Map view options\r\n   */\r\n  setView(options: MapViewOptions) {\r\n    if (this.viewController !== undefined) {\r\n      this.viewController.clearStateHistory();\r\n    }\r\n\r\n    options = Object.assign({ constrainResolution: true }, options);\r\n    const view = new olView(options);\r\n    this.ol.setView(view);\r\n\r\n    if (options) {\r\n      if (options.maxLayerZoomExtent) {\r\n        this.viewController.maxLayerZoomExtent = options.maxLayerZoomExtent;\r\n      }\r\n\r\n      if (options.center) {\r\n        const projection = view.getProjection().getCode();\r\n        const center = olproj.fromLonLat(options.center, projection);\r\n        view.setCenter(center);\r\n      }\r\n    }\r\n  }\r\n\r\n  updateControls(value: MapControlsOptions) {\r\n    if (value === undefined) {\r\n      return;\r\n    }\r\n\r\n    const controls = [];\r\n    if (value.attribution) {\r\n      const attributionOpt = (value.attribution === true\r\n        ? {}\r\n        : value.attribution) as MapAttributionOptions;\r\n      controls.push(new olControlAttribution(attributionOpt));\r\n    }\r\n    if (value.scaleLine) {\r\n      const scaleLineOpt = (value.scaleLine === true\r\n        ? {}\r\n        : value.scaleLine) as MapScaleLineOptions;\r\n      controls.push(new olControlScaleLine(scaleLineOpt));\r\n    }\r\n\r\n    const currentControls = Object.assign([], this.ol.getControls().getArray());\r\n    currentControls.forEach(control => {\r\n      this.ol.removeControl(control);\r\n    });\r\n    controls.forEach(control => {\r\n      this.ol.addControl(control);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    return this.viewController.getCenter(projection);\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    return this.viewController.getExtent(projection);\r\n  }\r\n\r\n  // TODO: Move to ViewController and update every place it's used\r\n  getZoom(): number {\r\n    return this.viewController.getZoom();\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (!baseLayer) {\r\n      return;\r\n    }\r\n\r\n    for (const bl of this.getBaseLayers()) {\r\n      bl.visible = false;\r\n    }\r\n\r\n    baseLayer.visible = true;\r\n\r\n    this.viewController.olView.setMinZoom(\r\n      baseLayer.dataSource.options.minZoom || (this.options.view || {}).minZoom\r\n    );\r\n    this.viewController.olView.setMaxZoom(\r\n      baseLayer.dataSource.options.maxZoom || (this.options.view || {}).maxZoom\r\n    );\r\n  }\r\n\r\n  getBaseLayers(): Layer[] {\r\n    return this.layers.filter((layer: Layer) => layer.baseLayer === true);\r\n  }\r\n\r\n  getLayerById(id: string): Layer {\r\n    return this.layers.find((layer: Layer) => layer.id && layer.id === id);\r\n  }\r\n\r\n  getLayerByAlias(alias: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => layer.alias && layer.alias === alias\r\n    );\r\n  }\r\n\r\n  getLayerByOlUId(olUId: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => getUid(layer.ol) && getUid(layer.ol) === olUId\r\n    );\r\n  }\r\n\r\n  getLayerByOlLayer(olLayer: olLayer<olSource>): Layer {\r\n    const olUId = getUid(olLayer);\r\n    return this.getLayerByOlUId(olUId);\r\n  }\r\n\r\n  /**\r\n   * Add a single layer\r\n   * @param layer Layer to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayer(layer: Layer, push = true) {\r\n    this.addLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add many layers\r\n   * @param layers Layers to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayers(layers: Layer[], push = true) {\r\n    let offsetZIndex = 0;\r\n    let offsetBaseLayerZIndex = 0;\r\n    const addedLayers = layers\r\n      .map((layer: Layer) => {\r\n        if (!layer) { return; }\r\n        const offset = layer.zIndex\r\n          ? 0\r\n          : layer.baseLayer\r\n            ? offsetBaseLayerZIndex++\r\n            : offsetZIndex++;\r\n        return this.doAddLayer(layer, offset);\r\n      })\r\n      .filter((layer: Layer | undefined) => layer !== undefined);\r\n    this.setLayers([].concat(this.layers, addedLayers));\r\n  }\r\n\r\n  /**\r\n   * Remove a single layer\r\n   * @param layer Layer to remove\r\n   */\r\n  removeLayer(layer: Layer) {\r\n    this.removeLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove many layers\r\n   * @param layers Layers to remove\r\n   */\r\n  removeLayers(layers: Layer[]) {\r\n    const newLayers = this.layers$.value.slice(0);\r\n    const layersToRemove = [];\r\n    layers.forEach((layer: Layer) => {\r\n      if (layer instanceof VectorLayer) {\r\n        layer.removeLayerFromIDB();\r\n      }\r\n      const index = newLayers.indexOf(layer);\r\n      if (index >= 0) {\r\n        layersToRemove.push(layer);\r\n        newLayers.splice(index, 1);\r\n        this.handleLinkedLayersDeletion(layer, layersToRemove);\r\n        layersToRemove.map(linkedLayer => {\r\n          const linkedIndex = newLayers.indexOf(linkedLayer);\r\n          if (linkedIndex >= 0) {\r\n            newLayers.splice(linkedIndex, 1);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    layersToRemove.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.setLayers(newLayers);\r\n  }\r\n\r\n  /**\r\n   * Build a list of linked layers to delete\r\n   * @param srcLayer Layer that has triggered the deletion\r\n   * @param layersToRemove list to append the layer to delete into\r\n   */\r\n  handleLinkedLayersDeletion(srcLayer: Layer, layersToRemove: Layer[]) {\r\n    let rootParentByDeletion = getRootParentByDeletion(this, srcLayer);\r\n    if (!rootParentByDeletion) {\r\n      rootParentByDeletion = srcLayer;\r\n    }\r\n    const clbd = getAllChildLayersByDeletion(this, rootParentByDeletion, [rootParentByDeletion]);\r\n    for (const layer of clbd) {\r\n      layersToRemove.push(layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all layers\r\n   */\r\n  removeAllLayers() {\r\n    this.layers.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.layers$.next([]);\r\n  }\r\n\r\n  raiseLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index > 1) {\r\n      this.moveLayer(layer, index, index - 1);\r\n    }\r\n  }\r\n\r\n  raiseLayers(layers: Layer[]) {\r\n    for (const layer of layers) {\r\n      this.raiseLayer(layer);\r\n    }\r\n  }\r\n\r\n  lowerLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index < this.layers.length - 1) {\r\n      this.moveLayer(layer, index, index + 1);\r\n    }\r\n  }\r\n\r\n  lowerLayers(layers: Layer[]) {\r\n    const reverseLayers = layers.reverse();\r\n    for (const layer of reverseLayers) {\r\n      this.lowerLayer(layer);\r\n    }\r\n  }\r\n\r\n  moveLayer(layer: Layer, from: number, to: number) {\r\n    const layerTo = this.layers[to];\r\n    const zIndexTo = layerTo.zIndex;\r\n    const zIndexFrom = layer.zIndex;\r\n\r\n    if (layerTo.baseLayer || layer.baseLayer) {\r\n      return;\r\n    }\r\n\r\n    layer.zIndex = zIndexTo;\r\n    layerTo.zIndex = zIndexFrom;\r\n\r\n    this.layers[to] = layer;\r\n    this.layers[from] = layerTo;\r\n    this.layers$.next(this.layers.slice(0));\r\n  }\r\n\r\n  /**\r\n   * Add a layer to the OL map and start watching. If the layer is already\r\n   * added to this map, make it visible but don't add it one again.\r\n   * @param layer Layer\r\n   * @returns The layer added, if any\r\n   */\r\n  private doAddLayer(layer: Layer, offsetZIndex: number) {\r\n    if (layer.baseLayer && layer.visible) {\r\n      this.changeBaseLayer(layer);\r\n    }\r\n\r\n    const existingLayer = this.getLayerById(layer.id);\r\n    if (existingLayer !== undefined) {\r\n      existingLayer.visible = true;\r\n      return;\r\n    }\r\n\r\n    if (!layer.baseLayer && layer.zIndex) {\r\n      layer.zIndex += 10;\r\n    }\r\n\r\n    if (layer.zIndex === undefined || layer.zIndex === 0) {\r\n      const maxZIndex = Math.max(\r\n        layer.baseLayer ? 0 : 10,\r\n        ...this.layers\r\n          .filter(\r\n            (l) => l.baseLayer === layer.baseLayer && l.zIndex < 200 // zIndex > 200 = system layer\r\n          )\r\n          .map((l) => l.zIndex)\r\n      );\r\n      layer.zIndex = maxZIndex + 1 + offsetZIndex;\r\n    }\r\n\r\n    if (layer.baseLayer && layer.zIndex > 9) {\r\n      layer.zIndex = 10; // baselayer must have zIndex < 10\r\n    }\r\n\r\n    layer.setMap(this);\r\n    this.layerWatcher.watchLayer(layer);\r\n    this.ol.addLayer(layer.ol);\r\n\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a layer from the OL map and stop watching\r\n   * @param layer Layer\r\n   */\r\n  private doRemoveLayer(layer: Layer) {\r\n    this.layerWatcher.unwatchLayer(layer);\r\n    this.ol.removeLayer(layer.ol);\r\n    layer.setMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Update the layers observable\r\n   * @param layers Layers\r\n   */\r\n  private setLayers(layers: Layer[]) {\r\n    this.layers$.next(this.sortLayersByZIndex(layers).slice(0));\r\n  }\r\n\r\n  /**\r\n   * Sort layers by descending zIndex\r\n   * @param layers Array of layers\r\n   * @returns The original array, sorted by zIndex\r\n   */\r\n  private sortLayersByZIndex(layers: Layer[]) {\r\n    // Sort by descending zIndex\r\n    return layers.sort(\r\n      (layer1: Layer, layer2: Layer) => layer2.zIndex - layer1.zIndex\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get layer index in the map's inenr array of layers\r\n   * @param layer Layer\r\n   * @returns The layer index\r\n   */\r\n  private getLayerIndex(layer: Layer) {\r\n    return this.layers.findIndex((_layer: Layer) => _layer === layer);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  AfterViewInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { ActivityService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapControlsOptions, MapViewOptions } from '../shared/map.interface';\r\n\r\n@Component({\r\n  selector: 'igo-map-browser',\r\n  templateUrl: './map-browser.component.html',\r\n  styleUrls: ['./map-browser.component.scss']\r\n})\r\nexport class MapBrowserComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  private activityId: string;\r\n  private status$$: Subscription;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get view(): MapViewOptions {\r\n    return this._view;\r\n  }\r\n  set view(value: MapViewOptions) {\r\n    this._view = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateView(value);\r\n    }\r\n  }\r\n  private _view: MapViewOptions;\r\n\r\n  get controls(): MapControlsOptions {\r\n    return this._controls;\r\n  }\r\n\r\n  set controls(value: MapControlsOptions) {\r\n    this._controls = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateControls(value);\r\n    }\r\n  }\r\n  private _controls: MapControlsOptions;\r\n\r\n  public id = `igo-map-target-${new Date().getTime()}`;\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  ngOnInit() {\r\n    this.status$$ = this.map.status$.subscribe(status =>\r\n      this.handleStatusChange(status)\r\n    );\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.map.setTarget(this.id);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.setTarget(undefined);\r\n    this.activityService.unregister(this.activityId);\r\n    this.status$$.unsubscribe();\r\n  }\r\n\r\n  private handleStatusChange(status: SubjectStatus) {\r\n    if (status === SubjectStatus.Working && this.activityId === undefined) {\r\n      this.activityId = this.activityService.register();\r\n    } else if (status === SubjectStatus.Done && this.activityId !== undefined) {\r\n      this.activityService.unregister(this.activityId);\r\n      this.activityId = undefined;\r\n    }\r\n  }\r\n}\r\n","<div [id]=\"id\" class=\"igo-map-browser-target\"></div>\r\n<ng-content></ng-content>\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\n\r\nimport { transform } from 'ol/proj';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n/**\r\n * This directive return the pointer coordinate (on click or pointermove)\r\n * in [longitude, latitude], delayed by in input (pointerMoveDelay)\r\n * to avoid too many emitted values.\r\n */\r\n@Directive({\r\n  selector: '[igoPointerPosition]'\r\n})\r\nexport class PointerPositionDirective implements OnInit, OnDestroy {\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * Delay before emitting an event\r\n   */\r\n  @Input() pointerPositionDelay: number = 1000;\r\n\r\n  /**\r\n   * Event emitted when the pointer move, delayed by pointerMoveDelay\r\n   */\r\n  @Output() pointerPositionCoord = new EventEmitter<[number, number]>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.listenToMapPointerMove();\r\n    this.listenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unlistenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, this.pointerPositionDelay)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map click\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * emit delayed coordinate (longitude, latitude array) based on pointerMoveDelay or on click\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onPointerEvent(event: MapBrowserPointerEvent<any>, delay: number) {\r\n    if (event.dragging || this.mediaService.isTouchScreen()) {return; }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    const lonlat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.pointerPositionCoord.emit(lonlat);\r\n    }, delay);\r\n  }\r\n}\r\n","import * as olStyle from 'ol/style';\r\nimport * as olGeom from 'ol/geom';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { StyleService } from '../../style-service/style.service';\r\n\r\n\r\nexport function featureRandomStyleFunction(): (olFeature: olFeature<OlGeometry>) => olStyle.Style {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n  return (olFeature: olFeature<OlGeometry>) => {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle);\r\n      }\r\n      const style = new olStyle.Style({\r\n        stroke,\r\n        fill,\r\n        image: new olStyle.Circle({\r\n          radius: 5,\r\n          stroke,\r\n          fill\r\n        }),\r\n        text: olFeature.get('_mapTitle') ? new olStyle.Text({\r\n          text: olFeature.get('_mapTitle').toString(),\r\n          offsetX: 5,\r\n          offsetY: -5,\r\n          font: '12px Calibri,sans-serif',\r\n          fill: new olStyle.Fill({ color: '#000' }),\r\n          stroke: new olStyle.Stroke({ color: '#fff', width: 3 }),\r\n          overflow: true\r\n        }): undefined\r\n      });\r\n      return style;\r\n  };\r\n}\r\n\r\nexport function featureRandomStyle(): olStyle.Style {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n\r\n  const style = new olStyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olStyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    })\r\n  });\r\n  return style;\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature olFeature\r\n * @returns OL style function\r\n */\r\nexport function hoverFeatureMarkerStyle(feature: olFeature<olGeom.Geometry>, resolution: number): olStyle.Style[] {\r\n\r\n    const olStyleText = new olStyle.Style({\r\n      text: new olStyle.Text({\r\n        text: feature.get('hoverSummary'),\r\n        textAlign: 'left',\r\n        textBaseline: 'top',\r\n        font: '12px Calibri,sans-serif',\r\n        fill: new olStyle.Fill({ color: '#000' }),\r\n        backgroundFill: new olStyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n        backgroundStroke: new olStyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n        stroke: new olStyle.Stroke({ color: '#fff', width: 3 }),\r\n        overflow: true,\r\n        offsetX: 10,\r\n        offsetY: 20,\r\n        padding: [2.5, 2.5, 2.5, 2.5]\r\n      })\r\n    });\r\n    const olStyles = [olStyleText];\r\n    switch (feature.getGeometry().getType()) {\r\n      case 'Point':\r\n        olStyles.push(new olStyle.Style({\r\n          image: new olStyle.Circle({\r\n            radius: 10,\r\n            stroke: new olStyle.Stroke({\r\n              color: 'blue',\r\n              width: 3\r\n            })\r\n          })\r\n        }));\r\n        break;\r\n      default:\r\n        olStyles.push(new olStyle.Style({\r\n          stroke: new olStyle.Stroke({\r\n            color: 'white',\r\n            width: 5\r\n          })\r\n        }));\r\n        olStyles.push(new olStyle.Style({\r\n          stroke: new olStyle.Stroke({\r\n            color: 'blue',\r\n            width: 3\r\n          })\r\n        }));\r\n    }\r\n\r\n    return olStyles;\r\n  }\r\n\r\n  /**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature olFeature\r\n * @returns OL style function\r\n */\r\nexport function pointerPositionSummaryMarkerStyle(feature: olFeature<OlGeometry>, resolution: number): olStyle.Style {\r\n    return new olStyle.Style({\r\n      image: new olStyle.Icon({\r\n        src: './assets/igo2/geo/icons/cross_black_18px.svg',\r\n        imgSize: [18, 18], // for ie\r\n      }),\r\n\r\n      text: new olStyle.Text({\r\n        text: feature.get('pointerSummary'),\r\n        textAlign: 'left',\r\n        textBaseline: 'bottom',\r\n        font: '12px Calibri,sans-serif',\r\n        fill: new olStyle.Fill({ color: '#000' }),\r\n        backgroundFill: new olStyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n        backgroundStroke: new olStyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n        stroke: new olStyle.Stroke({ color: '#fff', width: 3 }),\r\n        overflow: true,\r\n        offsetX: 10,\r\n        offsetY: -10,\r\n        padding: [2.5, 2.5, 2.5, 2.5]\r\n      })\r\n    });\r\n  }\r\n","import {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  HostListener\r\n} from '@angular/core'\r\n  ;\r\nimport olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olLayerVector from 'ol/layer/Vector';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport olVectorTileSource from 'ol/source/VectorTile';\r\n\r\nimport type { default as OlMapBrowserEvent } from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlGeom from 'ol/geom';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer, Layer, VectorTileLayer } from '../../layer/shared/layers';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { MediaService } from '@igo2/core';\r\nimport { StyleService } from '../../style/style-service/style.service';\r\nimport { unByKey } from 'ol/Observable';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { StyleByAttribute } from '../../style/shared/vector/vector-style.interface';\r\nimport { hoverFeatureMarkerStyle } from '../../style/shared/feature/feature-style';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoHoverFeature]'\r\n})\r\nexport class HoverFeatureDirective implements OnInit, OnDestroy {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private pointerHoverFeatureStore: EntityStore<OlFeature<OlGeometry>> = new EntityStore<OlFeature<OlGeometry>>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  private selectionLayer: olLayerVectorTile;\r\n  private selectionMVT = {};\r\n  private mvtStyleOptions: StyleByAttribute;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private singleClickMapListener;\r\n\r\n  private hoverFeatureId: string = 'hoverFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoHoverFeatureDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoHoverFeatureEnabled: boolean = false;\r\n\r\n  @HostListener('mouseout')\r\n  mouseout() {\r\n    clearTimeout(this.lastTimeoutRequest);\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService,\r\n    private styleService: StyleService,\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n    this.listenToMapClick();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], { map: this.map });\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers: Layer[]) => {\r\n      if (this.store && !layers.find(l => l.id === 'hoverFeatureId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'hoverFeatureId',\r\n      title: 'hoverFeature',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: hoverFeatureMarkerStyle\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n\r\n    this.selectionLayer = new olLayerVectorTile({\r\n      map: this.map.ol,\r\n      zIndex: 901,\r\n      renderMode: \"vector\",\r\n      declutter: true,\r\n      source: new olVectorTileSource({projection: this.map.projection}),\r\n      style: (feature, resolution) => {\r\n        if (this.mvtStyleOptions && feature.getId() in this.selectionMVT) {\r\n          return this.createHoverStyle(feature, this.mvtStyleOptions, resolution);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  createHoverStyle(feature: RenderFeature | OlFeature<OlGeometry>, hoverStyle: StyleByAttribute, resolution: number) {\r\n    const localHoverStyle = { ...hoverStyle };\r\n    let label = hoverStyle.label ? hoverStyle.label.attribute : undefined;\r\n    let hasLabelStyle = hoverStyle.label?.style ? true : false;\r\n\r\n    if (!feature.get('_isLabel')) {\r\n      localHoverStyle.label = undefined;\r\n      hasLabelStyle = false;\r\n      label = undefined;\r\n    } else {\r\n      // clear the style for label....\r\n      const size = localHoverStyle.data ? localHoverStyle.data.length : 0;\r\n      const radius = [];\r\n      const stroke = [];\r\n      const width = [];\r\n      const fill = [];\r\n      for (let i = 0; i < size; i++) {\r\n        radius.push(0);\r\n        stroke.push('rgba(255, 255, 255, 0)');\r\n        width.push(0);\r\n        fill.push('rgba(255, 255, 255, 0)');\r\n      }\r\n      localHoverStyle.radius = radius;\r\n      localHoverStyle.stroke = stroke;\r\n      localHoverStyle.width = width;\r\n      localHoverStyle.fill = fill;\r\n    }\r\n    if (!hasLabelStyle && label) {\r\n      localHoverStyle.label.style =\r\n      {\r\n        textAlign: 'left',\r\n        textBaseline: 'top',\r\n        font: '12px Calibri,sans-serif',\r\n        fill: { color: '#000' },\r\n        backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n        backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n        stroke: { color: '#fff', width: 3 },\r\n        overflow: true,\r\n        offsetX: 10,\r\n        offsetY: 20,\r\n        padding: [2.5, 2.5, 2.5, 2.5]\r\n      };\r\n    }\r\n    return this.styleService.createStyleByAttribute(feature, localHoverStyle, resolution);\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unlistenToMapSingleClick();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerHoverFeatureStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.addFeatureOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map singleclick\r\n   */\r\n  private listenToMapClick() {\r\n    this.singleClickMapListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapSingleClickEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map singleclick\r\n   * @internal\r\n   */\r\n  private unlistenToMapSingleClick() {\r\n    unByKey(this.singleClickMapListener);\r\n    this.singleClickMapListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger clear layer on singleclick.\r\n   * @param event OL map browser singleclick event\r\n   */\r\n  private onMapSingleClickEvent(event: OlMapBrowserEvent<any>) {\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * Trigger hover when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: OlMapBrowserEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoHoverFeatureEnabled ||\r\n      this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    let maximumZindex = -Infinity;\r\n    let topMostOlLayer;\r\n    const pixel = this.map.ol.getPixelFromCoordinate(event.coordinate);\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n\r\n      // retrieve the topmost layer with feature to only apply the hover on this layer.\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        if (!layerOL) {\r\n          return;\r\n        }\r\n        const igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid);\r\n        if (!this.canProcessHover(igoLayer as any)) {\r\n          return;\r\n        }\r\n        if (igoLayer.zIndex <= maximumZindex) {\r\n          return;\r\n        }\r\n        maximumZindex = igoLayer.zIndex;\r\n        topMostOlLayer = layerOL;\r\n\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer instanceof olLayerVector || olLayer instanceof olLayerVectorTile\r\n      });\r\n      if (!topMostOlLayer) {\r\n        // To clear label\r\n        this.clearLayer();\r\n        this.pointerHoverFeatureStore.clear();\r\n        return;\r\n      }\r\n\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        // To avoid flashing feature\r\n        if (\r\n          mapFeature.get('hoverSummary') === undefined &&\r\n          mapFeature.getProperties() !== this.pointerHoverFeatureStore.all()[0]?.getProperties()\r\n        ) {\r\n          this.clearLayer();\r\n          let igoLayer;\r\n          if (layerOL instanceof olLayerVector) {\r\n            const myLayerVector = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorLayer;\r\n            if (!this.canProcessHover(myLayerVector)) {\r\n              return;\r\n            }\r\n            let localOlFeature = this.handleRenderFeature(mapFeature);\r\n            this.setLayerStyleFromOptions(myLayerVector, localOlFeature);\r\n            const featuresToLoad = [localOlFeature];\r\n            localOlFeature.set(\"_isLabel\", false);\r\n            const myLabelOlFeature = new OlFeature();\r\n            myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n            const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n            myLabelOlFeature.setGeometry(labelGeom);\r\n            myLabelOlFeature.setId(localOlFeature.getId());\r\n            myLabelOlFeature.set(\"_isLabel\", true);\r\n            this.setLayerStyleFromOptions(myLayerVector, myLabelOlFeature);\r\n            featuresToLoad.push(myLabelOlFeature);\r\n            this.pointerHoverFeatureStore.load(featuresToLoad);\r\n            igoLayer = myLayerVector;\r\n            return true;\r\n          }\r\n          if (layerOL instanceof olLayerVectorTile) {\r\n            const myLayerVectorTile = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorTileLayer;\r\n            if (!this.canProcessHover(myLayerVectorTile)) {\r\n              return;\r\n            }\r\n            if (myLayerVectorTile?.options?.igoStyle?.styleByAttribute?.hoverStyle) {\r\n              this.mvtStyleOptions = myLayerVectorTile.options.igoStyle.styleByAttribute.hoverStyle;\r\n            } else if (myLayerVectorTile?.options?.igoStyle?.hoverStyle) {\r\n              this.mvtStyleOptions = myLayerVectorTile.options.igoStyle.hoverStyle;\r\n            }\r\n            this.selectionLayer.setSource(layerOL.getSource());\r\n            layerOL.getFeatures(event.pixel).then((mvtFeatures: (RenderFeature | OlFeature<OlGeometry>)[]) => {\r\n              if (!mvtFeatures.length) {\r\n                this.selectionMVT = {};\r\n                this.selectionLayer.changed();\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              const feature = mvtFeatures[0];\r\n              if (!feature) {\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              let localOlFeature = this.handleRenderFeature(feature);\r\n              localOlFeature.set(\"_isLabel\", false);\r\n              const myLabelOlFeature = new OlFeature();\r\n              myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n              const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n              myLabelOlFeature.setGeometry(labelGeom);\r\n              myLabelOlFeature.setId(localOlFeature.getId());\r\n              myLabelOlFeature.set(\"_isLabel\", true);\r\n              this.setLayerStyleFromOptions(myLayerVectorTile, myLabelOlFeature);\r\n              this.pointerHoverFeatureStore.load([myLabelOlFeature]);\r\n              this.selectionMVT[feature.getId()] = localOlFeature;\r\n              this.selectionLayer.changed();\r\n            });\r\n            igoLayer = myLayerVectorTile;\r\n          }\r\n        }\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer === topMostOlLayer\r\n      });\r\n    }, this.igoHoverFeatureDelay);\r\n  }\r\n\r\n  canProcessHover(igoLayer: VectorLayer | VectorTileLayer): boolean {\r\n    if (!igoLayer) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.visible) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.options) {\r\n      return false;\r\n    }\r\n\r\n    if (!igoLayer.options.igoStyle?.styleByAttribute && !igoLayer.options.igoStyle?.hoverStyle) {\r\n      return false;\r\n    }\r\n\r\n    if (\r\n      (igoLayer.options.igoStyle?.styleByAttribute && !igoLayer.options.igoStyle?.styleByAttribute.hoverStyle) &&\r\n      !igoLayer.options.igoStyle?.hoverStyle) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  handleRenderFeature(feature: RenderFeature | OlFeature<OlGeometry>): OlFeature<OlGeometry> {\r\n    let localFeature: OlFeature<OlGeometry>;\r\n    if (feature instanceof RenderFeature) {\r\n      localFeature = new OlFeature({\r\n        geometry: this.getGeometry(feature)\r\n      });\r\n      localFeature.setId(feature.getId());\r\n    } else if (feature instanceof OlFeature) {\r\n      localFeature = feature;\r\n    }\r\n    localFeature.setProperties(feature.getProperties());\r\n    return localFeature;\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addFeatureOverlay(hoverEntity: OlFeature<OlGeometry>[]) {\r\n\r\n    if (hoverEntity.length > 0) {\r\n\r\n      const result = hoverEntity[0];\r\n      this.clearLayer();\r\n      const feature = new OlFeature({\r\n        geometry: result.getGeometry(),\r\n        meta: { id: this.hoverFeatureId },\r\n        hoverSummary: this.getHoverSummary(result.getProperties())\r\n      });\r\n\r\n      this.store.setLayerOlFeatures([feature], FeatureMotion.None);\r\n    }\r\n  }\r\n\r\n  private setLayerStyleFromOptions(igoLayer: VectorLayer | VectorTileLayer, feature: OlFeature<OlGeometry>) {\r\n    const resolution = this.store.layer.map.viewController.getResolution();\r\n    if (igoLayer?.options?.igoStyle?.styleByAttribute?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.igoStyle.styleByAttribute.hoverStyle, resolution));\r\n      return;\r\n    }\r\n    if (igoLayer?.options?.igoStyle?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.igoStyle.hoverStyle, resolution));\r\n    }\r\n  }\r\n\r\n  private getHoverSummary(properties): string {\r\n    let summary = '';\r\n    for (const [key, value] of Object.entries(properties)) {\r\n      if (!key.startsWith('_') && key !== 'geometry') {\r\n        summary += `${key}: ${value}` + '\\n';\r\n      }\r\n    }\r\n    return summary.length >= 2 ? summary.slice(0, -2) : summary;\r\n  }\r\n\r\n  private getGeometry(feature): OlGeom.Geometry {\r\n    let geom;\r\n    if (!feature.getOrientedFlatCoordinates) {\r\n      geom = feature.getGeometry();\r\n    } else {\r\n\r\n      const coords = feature.getOrientedFlatCoordinates();\r\n      const flatCoords = [];\r\n\r\n      coords.forEach((c, idx) => {\r\n        if (idx % 2 === 0) {\r\n          flatCoords.push([parseFloat(coords[idx]), parseFloat(coords[idx + 1])]);\r\n        }\r\n      });\r\n\r\n      // TODO: test MultiX\r\n      switch (feature.getType()) {\r\n        case 'Point':\r\n          geom = new OlGeom.Point(flatCoords);\r\n          break;\r\n        case 'Polygon':\r\n          geom = new OlGeom.Polygon([flatCoords]);\r\n          break;\r\n        case 'LineString':\r\n          geom = new OlGeom.LineString([flatCoords]);\r\n          break;\r\n      }\r\n    }\r\n\r\n    return geom;\r\n  }\r\n\r\n\r\n  /**\r\n   * Clear the pointer store features\r\n   */\r\n  private clearLayer() {\r\n    this.selectionMVT = {};\r\n    if (this.selectionLayer) {\r\n      this.selectionLayer.changed();\r\n    }\r\n    if (this.store) {\r\n      this.store.clearLayer();\r\n    }\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-zoom-button',\r\n  templateUrl: './zoom-button.component.html',\r\n  styleUrls: ['./zoom-button.component.scss']\r\n})\r\nexport class ZoomButtonComponent {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string;\r\n\r\n  get zoom(): number { return this.map.viewController.getZoom(); }\r\n\r\n  get minZoom(): number { return this.map.viewController.olView.getMinZoom() || 1; }\r\n\r\n  get maxZoom(): number { return this.map.viewController.olView.getMaxZoom(); }\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"igo-zoom-button-container\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomIn' | translate: {zoom: zoom + 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom >= maxZoom\"\r\n    (click)=\"map.viewController.zoomIn()\">\r\n    <mat-icon svgIcon=\"plus\"></mat-icon>\r\n  </button>\r\n\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomOut' | translate: {zoom: zoom - 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom <= minZoom\"\r\n    (click)=\"map.viewController.zoomOut()\">\r\n    <mat-icon svgIcon=\"minus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","<div class=\"igo-geolocate-button-container\" *ngIf=\"map.geolocationController\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"map.geolocationController.tracking ? ('igo.geo.mapButtons.geolocateInactive' | translate) :('igo.geo.mapButtons.geolocate' | translate)\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    (click)=\"onGeolocationClick()\">\r\n    <mat-icon svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import { AfterContentInit, Component, Input, OnDestroy } from '@angular/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-geolocate-button',\r\n  templateUrl: './geolocate-button.component.html',\r\n  styleUrls: ['./geolocate-button.component.scss']\r\n})\r\nexport class GeolocateButtonComponent implements AfterContentInit, OnDestroy {\r\n\r\n  private tracking$$: Subscription;\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject('crosshairs-gps');\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  constructor(private configService: ConfigService) {}\r\n  ngAfterContentInit(): void {\r\n    this.map.ol.once('rendercomplete', () => {\r\n      this.tracking$$ =this.map.geolocationController.tracking$.subscribe(tracking => {\r\n        if (tracking) {\r\n          this.icon$.next('crosshairs-gps');\r\n        } else {\r\n          this.configService.getConfig('geolocate.basic') ? this.icon$.next('crosshairs-gps') : this.icon$.next('crosshairs');\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.tracking$$) {\r\n      this.tracking$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onGeolocationClick() {\r\n    const tracking = this.map.geolocationController.tracking;\r\n    this.map.geolocationController.tracking = tracking ? false : true;\r\n  }\r\n}\r\n","import { ConfigService } from '@igo2/core';\r\nimport { Component, Input } from '@angular/core';\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapExtent } from '../shared/map.interface';\r\nimport * as olproj from 'ol/proj';\r\n/*\r\nButton to center the map to the home extent\r\n*/\r\n@Component({\r\n  selector: 'igo-home-extent-button',\r\n  templateUrl:'./home-extent-button.component.html',\r\n  styleUrls: ['./home-extent-button.component.scss'],\r\n})\r\nexport class HomeExtentButtonComponent {\r\n  @Input() map: IgoMap;\r\n  @Input() color: string;\r\n  @Input() extentOverride?: MapExtent;\r\n  @Input() centerOverride?: [number, number];\r\n  @Input() zoomOverride?: number;\r\n\r\n  private homeExtentButtonExtent;\r\n  private homeExtentButtonCenter;\r\n  private homeExtentButtonZoom;\r\n\r\n constructor(public configService: ConfigService) {\r\n      this.computeHomeExtent();\r\n  }\r\n\r\n  computeHomeExtent() {\r\n    this.homeExtentButtonExtent = this.extentOverride || this.configService.getConfig('homeExtentButton.homeExtButtonExtent');\r\n    this.homeExtentButtonCenter = this.centerOverride || this.configService.getConfig('homeExtentButton.homeExtButtonCenter');\r\n    this.homeExtentButtonZoom = this.zoomOverride || this.configService.getConfig('homeExtentButton.homeExtButtonZoom');\r\n\r\n    // priority over extent if these 2 properties are defined;\r\n    if (this.centerOverride && this.zoomOverride) {\r\n      this.homeExtentButtonExtent = undefined;\r\n    }\r\n  }\r\n\r\n  onToggleClick() {\r\n    this.computeHomeExtent();\r\n    if (this.homeExtentButtonExtent) {\r\n      this.map.viewController.zoomToExtent(this.homeExtentButtonExtent);\r\n    } else if (this.homeExtentButtonCenter && this.homeExtentButtonZoom) {\r\n      const center = olproj.fromLonLat(this.homeExtentButtonCenter, this.map.viewController.olView.getProjection().getCode());\r\n      this.map.viewController.olView.setCenter(center);\r\n      this.map.viewController.zoomTo(this.homeExtentButtonZoom);\r\n    }\r\n  }\r\n}\r\n","<div class=\"igo-home-extent-button-container\"><button\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.mapButtons.home-extent' | translate\"\r\n            matTooltipPosition=\"left\"\r\n      [color]=\"color\"\r\n      (click)=\"onToggleClick()\"><mat-icon svgIcon = \"home-map-marker\"></mat-icon></button></div>\r\n","import { Component, Input } from '@angular/core';\r\nimport { StorageService } from '@igo2/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport NoSleep from 'nosleep.js';\r\nimport { userAgent } from '@igo2/utils';\r\n\r\n@Component({\r\n  selector: 'igo-wake-lock-button',\r\n  templateUrl: './wake-lock-button.component.html',\r\n  styleUrls: ['./wake-lock-button.component.scss']\r\n})\r\n\r\n/**\r\n * Prevent display sleep and enable wake lock in all Android and iOS web browsers.\r\n * On iOS, the Wake Lock API is not supported\r\n * https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API\r\n * On not supported browser, a fake video is used to keep the screen open.\r\n *\r\n * TODO: When the API will be supported by every browser, We should remove the NoSleep.js dependency\r\n * and replace it by a WakeLock API implementation.\r\n */\r\nexport class WakeLockButtonComponent {\r\n\r\n  @Input() color: string = 'primary';\r\n  @Input()\r\n  get enabled(): boolean {\r\n    return this.storageService.get('wakeLockEnabled') as boolean;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.storageService.set('wakeLockEnabled', value);\r\n  }\r\n\r\n  private noSleep: NoSleep;\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject('sleep');\r\n  public visible = false;\r\n\r\n  constructor(private storageService: StorageService) {\r\n    this.noSleep = new NoSleep();\r\n    const nonWakeLockApiBrowser = userAgent.satisfies({\r\n      ie: '>0',\r\n      edge: '<84',\r\n      chrome: '<84',\r\n      firefox: '>0',\r\n      opera: '<70',\r\n      safari: '>0'\r\n    });\r\n    if (nonWakeLockApiBrowser) {\r\n      this.disableWakeLock();\r\n      this.enabled = false;\r\n      window.addEventListener('blur', () => {\r\n        this.disableWakeLock();\r\n        this.enabled = false;\r\n      });\r\n    }\r\n    this.enabled ? this.enableWakeLock() : this.disableWakeLock();\r\n  }\r\n\r\n  /**\r\n   * Prevent display sleep and enable wake lock in all Android and iOS web browsers.\r\n   * On iOS, the Wake Lock API is not supported\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API\r\n   * On not supported browser, a fake video is used to keep the screen open.\r\n   */\r\n  private enableWakeLock() {\r\n    this.noSleep.enable();\r\n    this.enabled = true;\r\n    this.icon$.next('sleep-off');\r\n  }\r\n  /**\r\n   * Let display sleep\r\n   */\r\n  private disableWakeLock() {\r\n    this.noSleep.disable();\r\n    this.enabled = false;\r\n    this.icon$.next('sleep');\r\n  }\r\n\r\n  toggleWakeLock() {\r\n    if (this.enabled) {\r\n      this.disableWakeLock();\r\n    } else {\r\n      this.enableWakeLock();\r\n    }\r\n  }\r\n}\r\n","<div class=\"igo-wake-lock-button-container\">\r\n    <button \r\n      [color]=\"color\"\r\n      mat-icon-button\r\n      [matTooltip]=\"enabled ? ('igo.geo.mapButtons.preventScreenLock' | translate): ('igo.geo.mapButtons.letScreenLock' | translate)\"\r\n      matTooltipPosition=\"left\"\r\n      (click)=\"toggleWakeLock()\">\r\n      <mat-icon svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n    </button>\r\n</div>","<div *ngIf=\"baseLayers.length > 0\"\r\n     class=\"igo-baselayers-switcher-container\"\r\n     [ngClass]=\"{'container-expand': expand}\"\r\n     [@baseLayerSwitcherState]=\"expand ? 'expand' : useStaticIcon ? 'collapseIcon' : 'collapseMap'\"\r\n     (@baseLayerSwitcherState.start)=\"showButton=false\"\r\n     (@baseLayerSwitcherState.done)=\"showButton=true\"\r\n     (click)=\"collapseOrExpand()\">\r\n\r\n     <div *ngIf=\"useStaticIcon && !expand && showButton\" class=\"igo-baselayers-switcher-button-container\">\r\n       <button\r\n         mat-icon-button\r\n         [matTooltip]=\"'igo.geo.mapButtons.baselayerSwitcher' | translate\"\r\n         matTooltipPosition=\"right\"\r\n         color=\"primary\">\r\n         <mat-icon svgIcon=\"image-multiple\"></mat-icon>\r\n       </button>\r\n     </div>\r\n\r\n     <igo-mini-basemap class=\"mat-typography\" *ngFor=\"let baseLayer of baseLayers; let i = index\"\r\n       [map]=\"map\"\r\n       [baseLayer]=\"baseLayer\"\r\n       [title]=\"(baseLayers.length > 2 && !expand) ? ('igo.geo.baselayersSwitcher.title' | translate) : baseLayer.title\"\r\n       [display]=\"expand || (i === 0 && !useStaticIcon)\"\r\n       [disabled]=\"!expand && baseLayers.length > 1\">\r\n     </igo-mini-basemap>\r\n\r\n    <div class=\"more-baselayers\">\r\n      <mat-icon class=\"material-icons mat-icon mat-list-avatar\" color=\"primary\" svgIcon=\"menu-down\"></mat-icon>\r\n    </div>\r\n\r\n</div>\r\n","import { Component, Input, AfterViewInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { Layer } from '../../layer';\r\nimport { IgoMap } from '../shared';\r\nimport { baseLayersSwitcherSlideInOut } from './baselayers-switcher.animation';\r\n\r\n@Component({\r\n  selector: 'igo-baselayers-switcher',\r\n  templateUrl: './baselayers-switcher.component.html',\r\n  styleUrls: ['./baselayers-switcher.component.scss'],\r\n  animations: [baseLayersSwitcherSlideInOut()]\r\n})\r\nexport class BaseLayersSwitcherComponent implements AfterViewInit, OnDestroy {\r\n  @Input() map: IgoMap;\r\n  @Input() useStaticIcon: boolean;\r\n\r\n  public _baseLayers: Layer[] = [];\r\n  public expand = false;\r\n  public showButton = true;\r\n\r\n  private layers$$: Subscription;\r\n\r\n  constructor(private mediaService: MediaService) {\r\n    const media = this.mediaService.media$.value;\r\n    if (media === Media.Mobile && this.useStaticIcon === undefined) {\r\n      this.useStaticIcon = true;\r\n    }\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.layers$$ = this.map.layers$.subscribe(arrayLayers => {\r\n      this._baseLayers = arrayLayers.filter(l => l.baseLayer);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  collapseOrExpand() {\r\n    if (this.baseLayers.length > 1 || this.useStaticIcon) {\r\n      this.expand = !this.expand;\r\n    } else {\r\n      this.expand = false;\r\n    }\r\n  }\r\n\r\n  get baseLayers(): Layer[] {\r\n    const mapResolution = this.map.viewController.getResolution();\r\n    const mapZoom = this.map.viewController.getZoom();\r\n\r\n    const bl = this._baseLayers.filter(l => {\r\n      return (\r\n        (!l.options.maxResolution ||\r\n          mapResolution <= l.options.maxResolution) &&\r\n        (!l.options.minResolution || mapResolution >= l.options.minResolution) &&\r\n        (!l.options.source.options.maxZoom || mapZoom <= l.options.source.options.maxZoom) &&\r\n        (!l.options.source.options.minZoom || mapZoom >= l.options.source.options.minZoom)\r\n      );\r\n    });\r\n\r\n    const blHidden = bl.filter(l => !l.visible);\r\n    return blHidden.length + 1 === bl.length ? blHidden : bl;\r\n  }\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function baseLayersSwitcherSlideInOut(): AnimationTriggerMetadata {\r\n  return trigger('baseLayerSwitcherState', [\r\n    state(\r\n      'collapseIcon',\r\n      style({\r\n        height: '40px',\r\n        width: '40px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'collapseMap',\r\n      style({\r\n        height: '85px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'expand',\r\n      style({\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    transition('collapse => expand', animate('200ms')),\r\n    transition('expand => collapse', animate('200ms'))\r\n  ]);\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { DBMode, NgxIndexedDBService } from 'ngx-indexed-db';\r\nimport { Observable, of, Subject } from 'rxjs';\r\nimport { concatMap, first, map, take } from 'rxjs/operators';\r\nimport { CompressionService } from '@igo2/core';\r\nimport { GeoDBData } from './geoDB.interface';\r\nimport { InsertSourceInsertDBEnum } from './geoDB.enums';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GeoDBService {\r\n  readonly dbName: string = 'geoData';\r\n  public collisionsMap: Map<number, string[]> = new Map();\r\n  public _newData: number = 0;\r\n\r\n  constructor(\r\n    private ngxIndexedDBService: NgxIndexedDBService,\r\n    private compression: CompressionService\r\n  ) { }\r\n\r\n  /**\r\n   * Only blob can be compressed\r\n   * @param url\r\n   * @param regionID\r\n   * @param object object to handle\r\n   * @param insertSource type of event user or system\r\n   * @param insertEvent Name of the event where the insert has been triggered\r\n   * @returns\r\n   */\r\n  update(url: string, regionID: any, object: any, insertSource: InsertSourceInsertDBEnum, insertEvent: string): Observable<any> {\r\n    if (!object) {\r\n      return;\r\n    }\r\n    let compress = false;\r\n\r\n    const subject: Subject<GeoDBData> = new Subject();\r\n    let object$: Observable<any> = of(object);\r\n    if (object instanceof Blob) {\r\n      object$ = this.compression.compressBlob(object);\r\n      compress = true;\r\n    }\r\n    let geoDBData: GeoDBData;\r\n    object$.pipe(\r\n      first(),\r\n      concatMap(object => {\r\n        geoDBData = {\r\n          url,\r\n          regionID,\r\n          object: object,\r\n          compressed: compress,\r\n          insertSource,\r\n          insertEvent\r\n        };\r\n        return this.ngxIndexedDBService.getByID(this.dbName, url);\r\n      }),\r\n      concatMap((dbObject: GeoDBData) => {\r\n        if (!dbObject) {\r\n          this._newData++;\r\n          return this.ngxIndexedDBService.add(this.dbName, geoDBData);\r\n        } else {\r\n          const currentRegionID = dbObject.regionID;\r\n          if (currentRegionID !== regionID) {\r\n            const collisions = this.collisionsMap.get(currentRegionID);\r\n            if (collisions !== undefined) {\r\n              collisions.push(dbObject.url);\r\n              this.collisionsMap.set(currentRegionID, collisions);\r\n            } else {\r\n              this.collisionsMap.set(currentRegionID, [dbObject.url]);\r\n            }\r\n          }\r\n          return this.customUpdate(geoDBData);\r\n        }\r\n      })\r\n    ).subscribe((response) => {\r\n      subject.next(response);\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  private customUpdate(geoDBData: GeoDBData): Observable<GeoDBData> {\r\n    const subject: Subject<GeoDBData> = new Subject();\r\n    const deleteRequest = this.ngxIndexedDBService.deleteByKey(this.dbName, geoDBData.url);\r\n    deleteRequest.pipe(\r\n      concatMap(isDeleted => isDeleted ? this.ngxIndexedDBService.add(this.dbName, geoDBData) : of(undefined))\r\n    )\r\n    .subscribe(object => {\r\n      if (object) {\r\n        subject.next(object);\r\n      }\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  get(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.getByID(this.dbName, url).pipe(\r\n      map((data: GeoDBData) => {\r\n        if (data) {\r\n          const object = data.object;\r\n          if (!data.compressed) {\r\n            return object;\r\n          }\r\n          return this.compression.decompressBlob(object);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  getByID(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.getByID(this.dbName, url);\r\n  }\r\n\r\n  deleteByKey(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.deleteByKey(this.dbName, url);\r\n  }\r\n\r\n  getRegionCountByID(id: number): Observable<number> {\r\n    const subject: Subject<number> = new Subject();\r\n    const dbRequest = this.getRegionByID(id)\r\n      .subscribe((datas) => {\r\n        subject.next(datas.length);\r\n        subject.complete();\r\n      });\r\n    return subject;\r\n  }\r\n\r\n  getRegionByID(id: number): Observable<any[]> {\r\n    if (!id) {\r\n      return;\r\n    }\r\n\r\n    const IDBKey: IDBKeyRange = IDBKeyRange.only(id);\r\n    const dbRequest = this.ngxIndexedDBService.getAllByIndex(this.dbName, 'regionID', IDBKey);\r\n    return dbRequest;\r\n  }\r\n\r\n  deleteByRegionID(id: number): Observable<any> {\r\n    if (!id) {\r\n      return;\r\n    }\r\n\r\n    const IDBKey: IDBKeyRange = IDBKeyRange.only(id);\r\n    const dbRequest = this.ngxIndexedDBService.getAllByIndex(this.dbName, 'regionID', IDBKey);\r\n    dbRequest.subscribe((datas: GeoDBData[]) => {\r\n      datas.forEach((data) => {\r\n        this.ngxIndexedDBService.deleteByKey(this.dbName, data.url);\r\n      });\r\n    });\r\n    return dbRequest;\r\n  }\r\n\r\n  openCursor(\r\n    keyRange: IDBKeyRange = IDBKeyRange.lowerBound(0),\r\n    mode: DBMode = DBMode.readonly\r\n  ) {\r\n    const request = this.ngxIndexedDBService.openCursorByIndex(this.dbName, 'regionID', keyRange, mode);\r\n    return request;\r\n  }\r\n\r\n  resetCounters() {\r\n    this.resetCollisionsMap();\r\n    this._newData = 0;\r\n  }\r\n\r\n  resetCollisionsMap() {\r\n    this.collisionsMap = new Map();\r\n  }\r\n\r\n  revertCollisions() {\r\n    for (const [regionID, collisions] of this.collisionsMap) {\r\n      for (const url of collisions) {\r\n        this.ngxIndexedDBService.getByKey(this.dbName, url)\r\n          .pipe(take(1))\r\n          .subscribe((dbObject: GeoDBData) => {\r\n            const updatedObject = dbObject;\r\n            updatedObject.regionID = regionID;\r\n            this.customUpdate(dbObject);\r\n          });\r\n      }\r\n    }\r\n  }\r\n\r\n  get newData(): number {\r\n    return this._newData;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Injectable } from '@angular/core';\r\nimport { ConnectionState, NetworkService } from '@igo2/core';\r\nimport { Observable } from 'rxjs';\r\nimport { GeoDBService } from '../geoDB/geoDB.service';\r\n\r\nexport enum ResponseType {\r\n  Arraybuffer= 'arraybuffer',\r\n  Blob= 'blob',\r\n  Text= 'text',\r\n  Json= 'json',\r\n}\r\nexport interface SimpleGetOptions {\r\n  responseType: ResponseType;\r\n  withCredentials?: boolean;\r\n}\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GeoNetworkService {\r\n  private networkOnline: boolean = true;\r\n  constructor(\r\n    private http: HttpClient,\r\n    public geoDBService: GeoDBService,\r\n    private networkService: NetworkService,\r\n  ) {\r\n    this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.networkOnline = state.connection;\r\n    });\r\n  }\r\n\r\n  get(url: string, simpleGetOptions: SimpleGetOptions): Observable<any> {\r\n    if (window.navigator.onLine && this.networkOnline) {\r\n      return this.getOnline(url, simpleGetOptions);\r\n    }\r\n    return this.getOffline(url);\r\n  }\r\n\r\n  private getOnline(url: string, simpleGetOptions: SimpleGetOptions): Observable<any> {\r\n    let request;\r\n    switch (simpleGetOptions.responseType) {\r\n      // TODO Ajuster pour autre formats\r\n      case 'arraybuffer':\r\n        request = this.http.get(url, { responseType: 'arraybuffer', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      case 'blob':\r\n        request = this.http.get(url, { responseType: 'blob', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      case 'text':\r\n        request = this.http.get(url, { responseType: 'text', withCredentials: simpleGetOptions.withCredentials });\r\n          break;\r\n      case 'json':\r\n        request = this.http.get(url, { responseType: 'json', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      default:\r\n        request = this.http.get(url, { responseType: 'blob', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n    }\r\n    return request;\r\n  }\r\n\r\n  private getOffline(url: string): Observable<any> {\r\n    return this.geoDBService.get(url);\r\n  }\r\n\r\n  public isOnline() {\r\n    return this.networkOnline && window.navigator.onLine;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { NgxIndexedDBService } from 'ngx-indexed-db';\r\nimport { Observable, of, Subject } from 'rxjs';\r\nimport { concatMap, first } from 'rxjs/operators';\r\nimport { LayerDBData } from './layerDB.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerDBService {\r\n  readonly dbName: string = 'layerData';\r\n\r\n  constructor(\r\n    private ngxIndexedDBService: NgxIndexedDBService\r\n  ) { }\r\n\r\n  /**\r\n   * This method allow to update the stored layer into the indexeddb (layerData)\r\n   * @param layerDBData\r\n   * @returns\r\n   */\r\n  update(layerDBData: LayerDBData): Observable<any> {\r\n    const subject: Subject<LayerDBData> = new Subject();\r\n    this.ngxIndexedDBService.getByID(this.dbName, layerDBData.layerId).pipe(\r\n      first(),\r\n      concatMap((dbObject: LayerDBData) => {\r\n        if (!dbObject) {\r\n          return this.ngxIndexedDBService.add(this.dbName, layerDBData);\r\n        } else {\r\n          return this.customUpdate(layerDBData);\r\n        }\r\n      })\r\n    ).subscribe((response) => {\r\n      subject.next(response);\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  private customUpdate(layerDBData: LayerDBData): Observable<LayerDBData> {\r\n    const subject: Subject<LayerDBData> = new Subject();\r\n    const deleteRequest = this.ngxIndexedDBService.deleteByKey(this.dbName, layerDBData.layerId);\r\n    deleteRequest.pipe(\r\n      concatMap(isDeleted => isDeleted ? this.ngxIndexedDBService.add(this.dbName, layerDBData) : of(undefined))\r\n    )\r\n    .subscribe(object => {\r\n      if (object) {\r\n        subject.next(object);\r\n      }\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n\r\n  /**\r\n   * This method retrieve an idb layer definition\r\n   * @param layerId\r\n   * @returns\r\n   */\r\n  getByID(layerId: string): Observable<LayerDBData> {\r\n    return this.ngxIndexedDBService.getByID(this.dbName, layerId);\r\n  }\r\n\r\n  /**\r\n   * This method delete an idb layer definition\r\n   * @param layerId\r\n   * @returns\r\n   */\r\n  deleteByKey(layerId: string): Observable<boolean> {\r\n    return this.ngxIndexedDBService.deleteByKey(this.dbName, layerId);\r\n  }\r\n\r\n  /**\r\n   * This method retrive all idb layer definition\r\n   * @param layerId\r\n   * @returns\r\n   */\r\n  getAll(): Observable<LayerDBData[]> {\r\n    return this.ngxIndexedDBService.getAll(this.dbName);\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { combineLatest, Observable, of } from 'rxjs';\r\nimport { map, catchError, concatMap } from 'rxjs/operators';\r\nimport {stylefunction} from \"ol-mapbox-style\";\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport olLayerVectorTile from 'ol/layer/VectorTile';\r\n\r\nimport { Style } from 'ol/style';\r\nimport * as olStyle from 'ol/style';\r\n\r\nimport {\r\n  OSMDataSource,\r\n  FeatureDataSource,\r\n  XYZDataSource,\r\n  TileDebugDataSource,\r\n  WFSDataSource,\r\n  WMTSDataSource,\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestDataSource,\r\n  TileArcGISRestDataSource,\r\n  WebSocketDataSource,\r\n  MVTDataSource,\r\n  ClusterDataSource\r\n} from '../../datasource';\r\n\r\nimport { DataSourceService } from '../../datasource/shared/datasource.service';\r\n\r\nimport {\r\n  Layer,\r\n  ImageLayer,\r\n  ImageLayerOptions,\r\n  TileLayer,\r\n  TileLayerOptions,\r\n  VectorLayer,\r\n  VectorLayerOptions,\r\n  AnyLayerOptions,\r\n  VectorTileLayer,\r\n  VectorTileLayerOptions,\r\n  LayerOptions\r\n} from './layers';\r\n\r\nimport { computeMVTOptionsOnHover } from '../utils/layer.utils';\r\nimport { StyleService } from '../../style/style-service/style.service';\r\nimport { MessageService } from '@igo2/core';\r\nimport { GeoNetworkService } from '../../offline/shared/geo-network.service';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport { LayerDBService } from '../../offline/layerDB/layerDB.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private styleService: StyleService,\r\n    private dataSourceService: DataSourceService,\r\n    private geoNetworkService: GeoNetworkService,\r\n    private messageService: MessageService,\r\n    private layerDBService: LayerDBService,\r\n    @Optional() private authInterceptor: AuthInterceptor\r\n  ) {}\r\n\r\n  createLayer(layerOptions: AnyLayerOptions): Layer {\r\n    if (!layerOptions.source) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      layerOptions.source.options &&\r\n      layerOptions.source.options._layerOptionsFromSource\r\n    ) {\r\n      layerOptions = ObjectUtils.mergeDeep(\r\n        layerOptions.source.options._layerOptionsFromSource,\r\n        layerOptions || {}\r\n      );\r\n    }\r\n\r\n    let layer;\r\n    switch (layerOptions.source.constructor) {\r\n      case OSMDataSource:\r\n      case WMTSDataSource:\r\n      case XYZDataSource:\r\n      case TileDebugDataSource:\r\n      case CartoDataSource:\r\n      case TileArcGISRestDataSource:\r\n        layer = this.createTileLayer(layerOptions as TileLayerOptions);\r\n        break;\r\n      case FeatureDataSource:\r\n      case WFSDataSource:\r\n      case ArcGISRestDataSource:\r\n      case WebSocketDataSource:\r\n      case ClusterDataSource:\r\n        layer = this.createVectorLayer(layerOptions as VectorLayerOptions);\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case WMSDataSource:\r\n        layer = this.createImageLayer(layerOptions as ImageLayerOptions);\r\n        break;\r\n      case MVTDataSource:\r\n        const _layerOptions = computeMVTOptionsOnHover(layerOptions);\r\n        layer = this.createVectorTileLayer(\r\n          _layerOptions as VectorTileLayerOptions\r\n        );\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return layer;\r\n  }\r\n\r\n  createAsyncLayer(_layerOptions: AnyLayerOptions, detailedContextUri?: string): Observable<Layer> {\r\n    const layerOptions = computeMVTOptionsOnHover(_layerOptions);\r\n    if (layerOptions.source) {\r\n      return new Observable(d => d.next(this.createLayer(layerOptions)));\r\n    }\r\n\r\n    return this.dataSourceService\r\n      .createAsyncDataSource(layerOptions.sourceOptions, detailedContextUri)\r\n      .pipe(\r\n        map(source => {\r\n          if (source === undefined) {\r\n            return undefined;\r\n          }\r\n          return this.createLayer(Object.assign(layerOptions, { source }));\r\n        })\r\n      );\r\n  }\r\n\r\n  private createImageLayer(layerOptions: ImageLayerOptions): ImageLayer {\r\n    return new ImageLayer(layerOptions, this.messageService, this.authInterceptor);\r\n  }\r\n\r\n  private createTileLayer(layerOptions: TileLayerOptions): TileLayer {\r\n    return new TileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n  }\r\n\r\n  private createVectorLayer(layerOptions: VectorLayerOptions): VectorLayer {\r\n    let style: Style[] | Style | OlStyleLike = layerOptions.style;\r\n    let igoLayer: VectorLayer;\r\n\r\n    if (!layerOptions.igoStyle) {\r\n      layerOptions.igoStyle = {};\r\n    }\r\n    const legacyStyleOptions = ['styleByAttribute', 'hoverStyle', 'mapboxStyle', 'clusterBaseStyle', 'style'];\r\n    // handling legacy property.\r\n    this.handleLegacyStyles(layerOptions, legacyStyleOptions);\r\n    if (layerOptions.igoStyle.igoStyleObject && !layerOptions.idbInfo?.storeToIdb) {\r\n      style = (feature, resolution) => this.styleService.createStyle(layerOptions.igoStyle.igoStyleObject, feature, resolution);\r\n    } else if (layerOptions.igoStyle.igoStyleObject && layerOptions.idbInfo?.storeToIdb) {\r\n      // temporary fix todo : handle it with geostyler.\r\n      style = this.styleService.parseStyle('style', layerOptions.igoStyle.igoStyleObject);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ArcGISRestDataSource) {\r\n      const source = layerOptions.source as ArcGISRestDataSource;\r\n      style = source.options.params.style;\r\n    } else if (layerOptions.igoStyle?.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.igoStyle.styleByAttribute,\r\n          resolution\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(\r\n        layerOptions,\r\n        this.messageService,\r\n        this.authInterceptor,\r\n        this.geoNetworkService,\r\n        this.geoNetworkService.geoDBService,\r\n        this.layerDBService);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ClusterDataSource) {\r\n      const serviceStyle = this.styleService;\r\n      const baseStyle = layerOptions.igoStyle.clusterBaseStyle;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createClusterStyle(\r\n          feature,\r\n          resolution,\r\n          layerOptions.clusterParam,\r\n          baseStyle\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(\r\n        layerOptions,\r\n        this.messageService,\r\n        this.authInterceptor,\r\n        this.geoNetworkService,\r\n        this.geoNetworkService.geoDBService,\r\n        this.layerDBService);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorLayer(layerOptionsOl,\r\n        this.messageService,\r\n        this.authInterceptor,\r\n        this.geoNetworkService,\r\n        this.geoNetworkService.geoDBService,\r\n        this.layerDBService);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl as any);\r\n\r\n    return igoLayer;\r\n  }\r\n\r\n  private handleLegacyStyles(layerOptions, legacyStyleOptions: string[]) {\r\n    legacyStyleOptions.map(legacyOption => {\r\n      if (layerOptions[legacyOption]) {\r\n        let newKey = legacyOption;\r\n        if (legacyOption === 'style') {\r\n          if (layerOptions[legacyOption] instanceof olStyle.Style) {\r\n            return;\r\n          }\r\n          if (typeof layerOptions[legacyOption] === 'object') {\r\n            newKey = 'igoStyleObject';\r\n          } else {\r\n            return;\r\n          }\r\n        }\r\n        layerOptions.igoStyle[newKey] = layerOptions[legacyOption];\r\n        delete layerOptions[legacyOption];\r\n        console.warn(`\r\n        The location of this style option (${legacyOption}) is deprecated.\r\n        Please move this property within igoStyle property.\r\n        Ex: ${legacyOption}: {...} must be transfered to igoStyle: { ${newKey}: {...} }\r\n        This legacy conversion will be deleted in 2024.\r\n        `);\r\n      }\r\n    });\r\n  }\r\n\r\n  private createVectorTileLayer(\r\n    layerOptions: VectorTileLayerOptions\r\n  ): VectorTileLayer {\r\n    let style: Style[] | Style | OlStyleLike;\r\n    let igoLayer: VectorTileLayer;\r\n\r\n    if (!layerOptions.igoStyle) {\r\n      layerOptions.igoStyle = {};\r\n    }\r\n    const legacyStyleOptions = ['styleByAttribute', 'hoverStyle', 'mapboxStyle', 'style'];\r\n    // handling legacy property.\r\n    this.handleLegacyStyles(layerOptions, legacyStyleOptions);\r\n\r\n    if (layerOptions.igoStyle.igoStyleObject) {\r\n      style = (feature, resolution) => this.styleService.createStyle(layerOptions.igoStyle.igoStyleObject, feature, resolution);\r\n    }\r\n\r\n    if (layerOptions.igoStyle.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.igoStyle.styleByAttribute,\r\n          resolution\r\n        );\r\n      };\r\n      igoLayer = new VectorTileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorTileLayer(layerOptionsOl, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl);\r\n    return igoLayer;\r\n  }\r\n\r\n  private applyMapboxStyle(layer: Layer, layerOptions: VectorTileLayerOptions) {\r\n    if (layerOptions.igoStyle?.mapboxStyle) {\r\n      this.getStuff(layerOptions.igoStyle.mapboxStyle.url).subscribe(res => {\r\n        if (res.sprite){\r\n          const url = this.getAbsoluteUrl(layerOptions.igoStyle.mapboxStyle.url, res.sprite);\r\n          this.getStuff(url+'.json').subscribe(res2 => {\r\n            stylefunction(layer.ol as olLayerVectorTile, res, layerOptions.igoStyle.mapboxStyle.source, undefined, res2,\r\n              url+'.png');\r\n          });\r\n        } else {\r\n          stylefunction(layer.ol as olLayerVectorTile, res, layerOptions.igoStyle.mapboxStyle.source);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private getStuff(url: string) {\r\n    return this.http.get(url).pipe(\r\n      map((res: any) => res),\r\n      catchError(err => {\r\n        console.log('No style was found');\r\n        return of(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAbsoluteUrl(source, url) {\r\n    const r = new RegExp('^http|\\/\\/', 'i');\r\n    if(r.test(url)){\r\n      return url;\r\n    } else {\r\n      if ( source.substr(source.length -1) === \"/\"){\r\n        return source + url;\r\n      } else{\r\n        return source + \"/\" + url;\r\n      }\r\n    }\r\n  }\r\n\r\n  createAsyncIdbLayers(contextUri: string = '*'): Observable<Layer[]> {\r\n    return this.layerDBService.getAll().pipe(\r\n      concatMap(res => {\r\n        const idbLayers = contextUri !== '*' ? res.filter(l => l.detailedContextUri === contextUri) : res;\r\n        const layersOptions: LayerOptions[] =\r\n          idbLayers.map(idbl => Object.assign({}, idbl.layerOptions, { sourceOptions: idbl.sourceOptions }));\r\n        return combineLatest(layersOptions.map(layerOptions => this.createAsyncLayer(layerOptions)));\r\n      })\r\n    );\r\n  }\r\n\r\n}\r\n","<div class=\"igo-mini-basemap-container\">\r\n\r\n  <div *ngIf=\"display\" (click)=\"changeBaseLayer(baseLayer)\">\r\n    <igo-map-browser [map]=\"basemap\"></igo-map-browser>\r\n    <div *ngIf='title' class='igo-mini-basemap-title'> {{title}} </div>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  AfterViewInit,\r\n  OnDestroy,\r\n  ApplicationRef,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { Layer, LayerOptions } from '../../layer/shared';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../shared';\r\n\r\nimport OlMap from 'ol/Map';\r\nimport OlView from 'ol/View';\r\n\r\n@Component({\r\n  selector: 'igo-mini-basemap',\r\n  templateUrl: './mini-basemap.component.html',\r\n  styleUrls: ['./mini-basemap.component.scss']\r\n})\r\nexport class MiniBaseMapComponent implements AfterViewInit, OnDestroy {\r\n\r\n  @Input() map: IgoMap;\r\n  @Input() disabled: boolean;\r\n  @Input() title: string;\r\n\r\n  @Input()\r\n  get display(): boolean {\r\n    return this._display;\r\n  }\r\n  set display(value: boolean) {\r\n    this._display = value;\r\n    this.cdRef.detectChanges();\r\n    this.basemap.ol.getView().changed();\r\n  }\r\n  private _display: boolean;\r\n\r\n  @Input()\r\n  get baseLayer(): Layer {\r\n    return this._baseLayer;\r\n  }\r\n  set baseLayer(value: Layer) {\r\n    this._baseLayer = value;\r\n    this.handleBaseLayerChanged(value);\r\n  }\r\n  private _baseLayer: Layer;\r\n\r\n  public basemap = new IgoMap({\r\n    controls: {},\r\n    interactions: false\r\n  });\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private appRef: ApplicationRef,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  ngAfterViewInit() {\r\n    this.handleMainMapViewChange(this.map.ol.getView());\r\n    this.map.viewController.olView.on('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.on('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.viewController.olView.un('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.un('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    this.map.changeBaseLayer(baseLayer);\r\n    this.appRef.tick();\r\n  }\r\n\r\n  private handleMainMapViewChange(mainMapView) {\r\n    const mainMapViewProperties = mainMapView.getProperties();\r\n    this.basemap.viewController.olView.setResolution(mainMapViewProperties.resolution);\r\n    this.basemap.viewController.olView.setRotation(mainMapViewProperties.rotation);\r\n    this.basemap.viewController.olView.setCenter(this.map.viewController.getCenter());\r\n  }\r\n\r\n  private handleBaseLayerChanged(baselayer: Layer) {\r\n    this.basemap.removeAllLayers();\r\n\r\n    const options: any = Object.assign(\r\n      Object.create(baselayer.options),\r\n      baselayer.options,\r\n      {\r\n        visible: true,\r\n        baseLayer: false\r\n      }\r\n    );\r\n\r\n    const layer = this.layerService.createLayer(options);\r\n    this.basemap.addLayer(layer);\r\n    this.handleLinkedBaseLayer(layer);\r\n  }\r\n\r\n  private handleLinkedBaseLayer(baselayer: Layer) {\r\n    const linkedLayers = baselayer.options.linkedLayers;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n    if (isParentLayer && currentLinkedId === baselayer.options.linkedLayers.linkId) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        link.linkedIds.map(linkedId => {\r\n          const layerToApply = this.map.layers.find(l => l.options.linkedLayers?.linkId === linkedId);\r\n          if (layerToApply) {\r\n            const linkedLayerOptions: any = Object.assign(\r\n              Object.create(layerToApply.options),\r\n              layerToApply.options,\r\n              {\r\n                zIndex: 9000,\r\n                visible: true,\r\n                baseLayer: false,\r\n              } as LayerOptions\r\n            );\r\n            this.basemap.addLayer(this.layerService.createLayer(linkedLayerOptions));\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n}\r\n","<div *ngIf=\"((rotated$ | async) && !showIfNoRotation) || showIfNoRotation\" class=\"igo-rotation-button-container\"\r\n  [matTooltip]=\"(rotated$ | async) ? ('igo.geo.mapButtons.resetRotation' | translate: {azimuth: azimuthRounded, rotation: rotationRounded}): ('igo.geo.mapButtons.tipRotation' | translate)\"\r\n  matTooltipPosition=\"left\">\r\n  <button mat-icon-button matTooltipPosition=\"left\" [color]=\"color\" [disabled]=\"(rotated$ | async) === false\"\r\n    (click)=\"map.viewController.resetRotation()\">\r\n    <mat-icon [ngStyle]=\"currentStyle$ | async\" svgIcon=\"navigation\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n","import { AfterContentInit, Component, Input } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { bearingToAzimuth } from '@turf/helpers';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-rotation-button',\r\n  templateUrl: './rotation-button.component.html',\r\n  styleUrls: ['./rotation-button.component.scss']\r\n})\r\nexport class RotationButtonComponent implements AfterContentInit {\r\n  readonly rotated$ = new BehaviorSubject<boolean>(false);\r\n  public azimuthRounded: number = 0;\r\n  public rotationRounded: number = 0;\r\n  readonly currentStyle$ = new BehaviorSubject<{}>({\r\n    transform: 'rotate(0rad)'\r\n  });\r\n\r\n  @Input() map: IgoMap;\r\n  @Input() showIfNoRotation: boolean;\r\n  @Input() color: string;\r\n\r\n  constructor() { }\r\n\r\n  ngAfterContentInit() {\r\n    this.map.viewController.rotation$.subscribe(r => {\r\n      const radians = r || 0;\r\n      const deg = radians * 180 / Math.PI;\r\n      this.rotationRounded = Math.round(deg);\r\n      this.azimuthRounded = Math.round(bearingToAzimuth(deg * -1));\r\n      this.currentStyle$.next({\r\n        transform: 'rotate(' + radians + 'rad)'\r\n      });\r\n      this.rotated$.next(radians !== 0);\r\n    }\r\n    );\r\n  }\r\n}\r\n","<div *ngIf=\"infoContent && infoContent.length\" class=\"infoSection\">\r\n    <pre>{{infoContent}}</pre>\r\n</div>","import { Component, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-info-section',\r\n  templateUrl: './info-section.component.html',\r\n  styleUrls: ['./info-section.component.scss']\r\n})\r\nexport class InfoSectionComponent {\r\n\r\n  @Input() infoContent: string = '';\r\n\r\n  constructor() {}\r\n\r\n}\r\n","export enum CatalogItemType {\r\n  Layer = 'layer',\r\n  Group = 'group'\r\n}\r\n\r\nexport enum TypeCatalog {\r\n  wms, wmts, baselayers, arcgisrest, tilearcgisrest, imagearcgisrest, composite\r\n}\r\n\r\nexport type TypeCatalogStrings = keyof typeof TypeCatalog;\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { TooltipType } from '../../layer';\r\nimport { TimeFilterOptions } from '../../filter';\r\nimport { QueryFormat, QueryHtmlTarget } from '../../query';\r\n\r\nimport { ICatalog, ICompositeCatalog , CatalogItem, CatalogItemGroup } from './catalog.interface';\r\nimport { CatalogService } from './catalog.service';\r\nimport { TypeCatalog, TypeCatalogStrings } from './catalog.enum';\r\n\r\nexport abstract class Catalog implements ICatalog {\r\n\r\n    // ICatalog -----------------------------\r\n    id: string;\r\n    title: string;\r\n    url: string;\r\n    removable?: boolean;\r\n    externalProvider?: boolean;\r\n    abstract?: string;\r\n    forcedProperties?: any[];\r\n    items?: CatalogItem[];\r\n    type?: TypeCatalogStrings;\r\n    version?: string;\r\n    matrixSet?: string;\r\n    requestEncoding?: string;\r\n    regFilters?: string[];\r\n    groupImpose?: CatalogItemGroup;\r\n    groupSeparator?: string;\r\n    timeFilter?: TimeFilterOptions;\r\n    queryFormat?: QueryFormat;\r\n    queryHtmlTarget?: QueryHtmlTarget;\r\n    queryParams?: { [key: string]: string; };\r\n    sourceOptions?: { [key: string]: any; };\r\n    count?: number;\r\n    tooltipType?: TooltipType.ABSTRACT | TooltipType.TITLE;\r\n    sortDirection?: 'asc' | 'desc';\r\n    setCrossOriginAnonymous?: boolean;\r\n    showLegend?: boolean;\r\n    profils?: string[];\r\n    // ICatalog -----------------------------\r\n\r\n    protected catalogService: CatalogService;\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        Object.assign(this, options);\r\n        this.catalogService = service;\r\n    }\r\n\r\n    public abstract collectCatalogItems(): Observable<CatalogItem[]>;\r\n}\r\n\r\nclass WMSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wms];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass WMTSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wmts];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMTSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass BaselayersCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.baselayers];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItemGroup[]> {\r\n        return this.catalogService.loadCatalogBaseLayerItems(this);\r\n    }\r\n}\r\n\r\nclass ArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.arcgisrest];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nclass TileOrImageArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService, typeCatalog: TypeCatalog) {\r\n        super(options, service);\r\n        this.type = TypeCatalog[TypeCatalog[typeCatalog]];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nexport class CompositeCatalog extends Catalog implements ICompositeCatalog {\r\n    composite: ICatalog[];\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.composite];\r\n        this.type = TypeCatalog[sType];\r\n        this.url = null;\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogCompositeLayerItems(this);\r\n    }\r\n}\r\n\r\nexport class CatalogFactory {\r\n\r\n    public static createInstanceCatalog(options: Catalog, service: CatalogService): Catalog {\r\n\r\n        let catalog: Catalog;\r\n        if (options.hasOwnProperty('composite')) {\r\n            catalog = new CompositeCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.baselayers]) {\r\n            catalog = new BaselayersCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.arcgisrest]) {\r\n            catalog = new ArcGISRestCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.tilearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.tilearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.imagearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.imagearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.wmts]) {\r\n            catalog = new WMTSCatalog(options, service);\r\n        } else {\r\n            catalog = new WMSCatalog(options, service);\r\n        }\r\n\r\n        return catalog;\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, mergeMap } from 'rxjs/operators';\r\n\r\nimport { default as striptags } from 'striptags';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport * as olextent from 'ol/extent';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport olFeature from 'ol/Feature';\r\nimport * as olgeom from 'ol/geom';\r\n\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\nimport { Feature, FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport {\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  TileArcGISRestDataSource,\r\n  WMSDataSourceOptions,\r\n  ImageArcGISRestDataSource\r\n} from '../../datasource';\r\n\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType,\r\n  QueryHtmlTarget\r\n} from './query.enums';\r\nimport {\r\n  QueryOptions,\r\n  QueryableDataSource,\r\n  QueryableDataSourceOptions,\r\n  QueryUrlData\r\n} from './query.interfaces';\r\nimport { MapExtent } from '../../map/shared/map.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class QueryService {\r\n  public queryEnabled = true;\r\n  public defaultFeatureCount = 20; // default feature count\r\n  public featureCount = 20; // feature count\r\n\r\n  private previousMessageIds = [];\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  query(layers: Layer[], options: QueryOptions): Observable<Feature[]>[] {\r\n    if (this.previousMessageIds.length) {\r\n      this.previousMessageIds.forEach(id => {\r\n        this.messageService.remove(id);\r\n      });\r\n    }\r\n\r\n    const newLayers = layers.filter((layer: Layer) => layer.visible && layer.isInResolutionsRange)\r\n    .map((layer: Layer) => this.queryLayer(layer, options));\r\n    // the directive accept array in this format [observable, observable...]\r\n    // if we use multiple 'url' in queryUrl so the result => this form [observable, observable, [observable, observable]]\r\n    // so we need to flat the array\r\n    let flatArray = [].concat.apply([], newLayers);\r\n    return flatArray;\r\n  }\r\n\r\n  queryLayer(layer: Layer, options: QueryOptions): Observable<Feature[]> | Observable<Feature[]>[] {\r\n    const url = this.getQueryUrl(layer.dataSource, options, false, layer.map.viewController.getExtent());\r\n    if (!url) {\r\n      return of([]);\r\n    }\r\n\r\n    const resolution: number = layer.map.viewController.getResolution();\r\n    const scale: number = layer.map.viewController.getScale();\r\n\r\n    if ((layer.dataSource as QueryableDataSource).options.queryFormat === QueryFormat.HTMLGML2) {\r\n      if (typeof url === 'string') {\r\n        const urlGml = this.getQueryUrl(layer.dataSource, options, true) as string;\r\n        return this.http.get(urlGml, { responseType: 'text' }).pipe(\r\n          mergeMap(gmlRes => {\r\n            const mergedGML = this.mergeGML(gmlRes, url, layer);\r\n            const imposedGeom = mergedGML[0];\r\n            const imposedProperties = mergedGML[1];\r\n            return this.http\r\n              .get(url, { responseType: 'text' })\r\n              .pipe(\r\n                map(res =>\r\n                  this.extractData(res, layer, options, url, imposedGeom, imposedProperties)\r\n                )\r\n              );\r\n          })\r\n        );\r\n      }\r\n      const urlGmls = this.getQueryUrl(layer.dataSource, options, true);\r\n      let observables: any = [];\r\n      for (let i = 0; i < urlGmls.length; i++) {\r\n        const element = urlGmls[i] as QueryUrlData;\r\n        if (this.checkScaleAndResolution(resolution, scale, element)) {\r\n          observables.push(this.requestDataForHTMLGML2(element.url, url[i].url, layer, options));\r\n        }\r\n      }\r\n      return observables;\r\n    } else {\r\n      if (typeof url === 'string') {\r\n        const request = this.http.get(url, { responseType: 'text' });\r\n        return request.pipe(map(res => this.extractData(res, layer, options, url)));\r\n      }\r\n      let observables: any = [];\r\n      for (let i = 0; i < url.length; i++) {\r\n        const element: QueryUrlData = url[i];\r\n        if (this.checkScaleAndResolution(resolution, scale, element)) {\r\n          const request = this.http.get(element.url, { responseType: 'text' });\r\n          observables.push(request.pipe(map(res => this.extractData(res, layer, options, element.url))));\r\n        }\r\n      }\r\n      return observables;\r\n    }\r\n  }\r\n\r\n  private requestDataForHTMLGML2(urlGml: string, url: string ,layer: Layer, options: QueryOptions): Observable<Feature[]> {\r\n    return this.http.get(urlGml, { responseType: 'text' }).pipe(\r\n      mergeMap(gmlRes => {\r\n        const mergedGML = this.mergeGML(gmlRes, url, layer);\r\n        const imposedGeom = mergedGML[0];\r\n        const imposedProperties = mergedGML[1];\r\n        return this.http\r\n          .get(url, { responseType: 'text' })\r\n          .pipe(\r\n            map(res =>\r\n              this.extractData(res, layer, options, url, imposedGeom, imposedProperties)\r\n            )\r\n          );\r\n      })\r\n    );\r\n  }\r\n\r\n  private checkScaleAndResolution(resolution: number, scale: number, element: QueryUrlData): boolean {\r\n    let checkScale: boolean;\r\n    let checkResolution: boolean;\r\n\r\n    if (!element.minResolution && !element.maxResolution && !element.minScale && !element.maxScale) {\r\n      return true;\r\n    } else {\r\n      /******************* checking Resolution *******************/\r\n      if (element.minResolution && element.maxResolution) {\r\n        // if \"minResolution\" and \"maxResolution\" exists check if resoltion is between\r\n        if ((resolution >= element.minResolution) && (resolution <= element.maxResolution)) {\r\n          checkResolution = true;\r\n        }\r\n      } else {\r\n        // check if \"minResolution\" or \"maxResolution\" exists\r\n        if (element.minResolution && resolution >= element.minResolution) { checkResolution = true; }\r\n        if (element.maxResolution && resolution <= element.maxResolution) { checkResolution = true; }\r\n      }\r\n\r\n      /******************* checking Scale *******************/\r\n      if (element.minScale && element.maxScale) {\r\n        // if \"minScale\" and \"maxScale\" exists check if scale is between\r\n        if ((scale > element.minScale) && (scale < element.maxScale)) {\r\n          checkScale = true;\r\n        }\r\n      } else {\r\n        // check if \"minScale\" or \"maxScale\" exists\r\n        if (element.maxScale && scale <= element.maxScale) { checkScale = true; }\r\n        if (element.minScale && scale >= element.minScale) { checkScale = true; }\r\n      }\r\n\r\n      /******************* result of checking *******************/\r\n      if (checkScale === true && checkResolution === true) {\r\n        return true;\r\n      } else if ((checkResolution === true && !checkScale) || (checkScale === true && !checkResolution)) {\r\n        return true;\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  private mergeGML(gmlRes, url, layer: Layer): [FeatureGeometry, { [key: string]: any }] {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(gmlRes);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      features = wmsParser.readFeatures(gmlRes);\r\n    }\r\n    const olmline = new olgeom.MultiLineString([]);\r\n    let pts;\r\n    const ptsArray = [];\r\n    let olmpoly = new olgeom.MultiPolygon([]);\r\n    let firstFeatureType;\r\n    const nbFeatures = features.length;\r\n\r\n    // Check if geometry intersect bbox\r\n    // for geoserver getfeatureinfo response in data projection, not call projection\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const bbox = bboxRaw.split(',');\r\n    const bboxExtent = olextent.createEmpty();\r\n    olextent.extend(bboxExtent, bbox);\r\n    const outBboxExtent = false;\r\n    let titleContent;\r\n    let queryTileField;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        queryTileField = dataSourceOptions.queryTitle;\r\n      }\r\n    }\r\n    features.map(feature => {\r\n\r\n      if (queryTileField) {\r\n        let queryTitleContent = feature.getProperties()[queryTileField];\r\n        if (queryTitleContent) {\r\n          titleContent = !titleContent ? queryTitleContent : `${titleContent},${queryTitleContent}`;\r\n        }\r\n      }\r\n      /*  if (!feature.getGeometry().simplify(100).intersectsExtent(bboxExtent)) {\r\n        outBboxExtent = true;\r\n        // TODO: Check to project the geometry?\r\n      }*/\r\n      const featureGeometryCoordinates = (feature.getGeometry() as any).getCoordinates();\r\n      const featureGeometryType = feature.getGeometry().getType();\r\n\r\n      if (!firstFeatureType && !outBboxExtent) {\r\n        firstFeatureType = featureGeometryType;\r\n      }\r\n      if (!outBboxExtent) {\r\n        switch (featureGeometryType) {\r\n          case 'Point':\r\n            if (nbFeatures === 1) {\r\n              pts = new olgeom.Point(featureGeometryCoordinates, 'XY');\r\n            } else {\r\n              ptsArray.push(featureGeometryCoordinates);\r\n            }\r\n            break;\r\n          case 'LineString':\r\n            olmline.appendLineString(\r\n              new olgeom.LineString(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'Polygon':\r\n            olmpoly.appendPolygon(\r\n              new olgeom.Polygon(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'MultiPolygon':\r\n            olmpoly = new olgeom.MultiPolygon(featureGeometryCoordinates, 'XY');\r\n            break;\r\n          default:\r\n            return;\r\n        }\r\n      }\r\n    });\r\n\r\n    let olmpts;\r\n    if (ptsArray.length === 0 && pts) {\r\n      olmpts = {\r\n        type: pts.getType(),\r\n        coordinates: pts.getCoordinates()\r\n      };\r\n    } else {\r\n      olmpts = {\r\n        type: 'Polygon',\r\n        coordinates: [this.convexHull(ptsArray)]\r\n      };\r\n    }\r\n\r\n    let returnGeometry;\r\n    switch (firstFeatureType) {\r\n      case 'LineString':\r\n        returnGeometry = {\r\n          type: olmline.getType(),\r\n          coordinates: olmline.getCoordinates()\r\n        };\r\n        break;\r\n      case 'Point':\r\n        returnGeometry = olmpts;\r\n        break;\r\n      case 'Polygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n        break;\r\n      case 'MultiPolygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n        break;\r\n    }\r\n    const imposedProperties = {};\r\n\r\n    if (queryTileField) {\r\n      imposedProperties[queryTileField] = titleContent;\r\n    }\r\n\r\n    return [ returnGeometry, imposedProperties];\r\n\r\n\r\n  }\r\n\r\n  cross(a, b, o) {\r\n    return (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]);\r\n  }\r\n\r\n  /**\r\n   * @param points An array of [X, Y] coordinates\r\n   * This method is use instead of turf.js convexHull because Turf needs at least 3 point to make a hull.\r\n   * https://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain#JavaScript\r\n   */\r\n  convexHull(points) {\r\n    points.sort((a, b) => {\r\n      return a[0] === b[0] ? a[1] - b[1] : a[0] - b[0];\r\n    });\r\n\r\n    const lower = [];\r\n    for (const point of points) {\r\n      while (\r\n        lower.length >= 2 &&\r\n        this.cross(lower[lower.length - 2], lower[lower.length - 1], point) <= 0\r\n      ) {\r\n        lower.pop();\r\n      }\r\n      lower.push(point);\r\n    }\r\n\r\n    const upper = [];\r\n    for (let i = points.length - 1; i >= 0; i--) {\r\n      while (\r\n        upper.length >= 2 &&\r\n        this.cross(\r\n          upper[upper.length - 2],\r\n          upper[upper.length - 1],\r\n          points[i]\r\n        ) <= 0\r\n      ) {\r\n        upper.pop();\r\n      }\r\n      upper.push(points[i]);\r\n    }\r\n\r\n    upper.pop();\r\n    lower.pop();\r\n    return lower.concat(upper);\r\n  }\r\n\r\n  private extractData(\r\n    res,\r\n    layer: Layer,\r\n    options: QueryOptions,\r\n    url: string,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ): Feature[] {\r\n    const queryDataSource = layer.dataSource as QueryableDataSource;\r\n\r\n    const allowedFieldsAndAlias = this.getAllowedFieldsAndAlias(layer);\r\n    let features = [];\r\n    switch (queryDataSource.options.queryFormat) {\r\n      case QueryFormat.GML3:\r\n        features = this.extractGML3Data(\r\n          res,\r\n          layer.zIndex,\r\n          allowedFieldsAndAlias\r\n        );\r\n        break;\r\n      case QueryFormat.JSON:\r\n      case QueryFormat.GEOJSON:\r\n      case QueryFormat.GEOJSON2:\r\n        features = this.extractGeoJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.ESRIJSON:\r\n        features = this.extractEsriJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.TEXT:\r\n        features = this.extractTextData(res);\r\n        break;\r\n      case QueryFormat.HTML:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url\r\n        );\r\n        break;\r\n      case QueryFormat.HTMLGML2:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url,\r\n          imposedGeometry,\r\n          imposedProperties\r\n        );\r\n        break;\r\n      case QueryFormat.GML2:\r\n      default:\r\n        features = this.extractGML2Data(res, layer, allowedFieldsAndAlias);\r\n        break;\r\n    }\r\n    if (features.length > 0 && (features[0].geometry === null || !features[0].geometry)) {\r\n      const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n      for (const feature of features) {\r\n        feature.geometry = geomToAdd;\r\n      }\r\n    }\r\n\r\n    const wmsDatasource = layer.dataSource as WMSDataSource;\r\n    const featureCount = wmsDatasource.params?.FEATURE_COUNT ?\r\n      new RegExp('FEATURE_COUNT=' + this.featureCount) :\r\n      new RegExp('FEATURE_COUNT=' + this.defaultFeatureCount);\r\n\r\n    if (\r\n      featureCount.test(url) &&\r\n      ((wmsDatasource.params?.FEATURE_COUNT && this.featureCount > 1 && features.length === this.featureCount) ||\r\n      (!wmsDatasource.params?.FEATURE_COUNT && features.length === this.defaultFeatureCount))) {\r\n      const messageObj = this.messageService.info('igo.geo.query.featureCountMax', undefined, undefined, { value: layer.title });\r\n      this.previousMessageIds.push(messageObj.toastId);\r\n    }\r\n\r\n    return features.map((feature: Feature, index: number) => {\r\n      const mapLabel = feature.properties[queryDataSource.mapLabel];\r\n\r\n      let exclude;\r\n      if (layer.options.sourceOptions?.type === 'wms') {\r\n        const sourceOptions = layer.options\r\n          .sourceOptions as WMSDataSourceOptions;\r\n        exclude = sourceOptions ? sourceOptions.excludeAttribute : undefined;\r\n      }\r\n\r\n      let title = this.getQueryTitle(feature, layer);\r\n      if (!title && features.length > 1) {\r\n        title = `${layer.title} (${index + 1})`;\r\n      } else if (!title) {\r\n        title = layer.title;\r\n      }\r\n\r\n      const meta = Object.assign({}, feature.meta || {}, {\r\n        id: uuid(),\r\n        title,\r\n        mapTitle: mapLabel,\r\n        sourceTitle: layer.title,\r\n        order: 1000 - layer.zIndex,\r\n        excludeAttribute: exclude\r\n      });\r\n\r\n      return Object.assign(feature, {\r\n        meta,\r\n        projection:\r\n          queryDataSource.options.type === 'carto'\r\n            ? 'EPSG:4326'\r\n            : options.projection\r\n      });\r\n    });\r\n  }\r\n\r\n  private createGeometryFromUrlClick(url) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const width = parseInt(searchParams.width, 10);\r\n    const height = parseInt(searchParams.height, 10);\r\n    const xPosition = parseInt(searchParams.i || searchParams.x, 10);\r\n    const yPosition = parseInt(searchParams.j || searchParams.y, 10);\r\n\r\n    const bbox = bboxRaw.split(',');\r\n    let threshold =\r\n      (Math.abs(parseFloat(bbox[0])) - Math.abs(parseFloat(bbox[2]))) * 0.05;\r\n\r\n    // for context in degree (EPSG:4326,4269...)\r\n    if (Math.abs(parseFloat(bbox[0])) < 180) {\r\n      threshold = 0.045;\r\n    }\r\n    const clickx =\r\n      parseFloat(bbox[0]) +\r\n      (Math.abs(parseFloat(bbox[0]) - parseFloat(bbox[2])) * xPosition) /\r\n        width -\r\n      threshold;\r\n    const clicky =\r\n      parseFloat(bbox[1]) +\r\n      (Math.abs(parseFloat(bbox[1]) - parseFloat(bbox[3])) * yPosition) /\r\n        height -\r\n      threshold;\r\n    const clickx1 = clickx + threshold * 2;\r\n    const clicky1 = clicky + threshold * 2;\r\n\r\n    const wktPoly =\r\n      'POLYGON((' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      '))';\r\n\r\n    const format = new olformat.WKT();\r\n    const tenPercentWidthGeom = format.readFeature(wktPoly);\r\n    const f = tenPercentWidthGeom.getGeometry() as any;\r\n\r\n    const newGeom = {\r\n      type: f.getType(),\r\n      coordinates: f.getCoordinates()\r\n    };\r\n\r\n    return newGeom;\r\n  }\r\n\r\n  private extractGML2Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(res);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      try {\r\n        features = wmsParser.readFeatures(res);\r\n      } catch (e) {\r\n        console.warn(\r\n          'query.service: Multipolygons are badly managed in mapserver in GML2. Use another format.'\r\n        );\r\n      }\r\n    }\r\n\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGML3Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML3();\r\n    let features = [];\r\n    try {\r\n      features = parser.readFeatures(res);\r\n    } catch (e) {\r\n      console.warn('query.service: GML3 is not well supported');\r\n    }\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGeoJSONData(res, zIndex, allowedFieldsAndAlias?) {\r\n    let features = [];\r\n    try {\r\n      features = JSON.parse(res.replace(/(\\r|\\n)/g, ' ')).features;\r\n    } catch (e) {\r\n      console.warn('query.service: Unable to parse geojson', '\\n', res);\r\n    }\r\n    features.map(feature => feature.meta = {\r\n      id: uuid(),\r\n      order: 1000 - zIndex,\r\n      alias: allowedFieldsAndAlias\r\n    });\r\n    return features;\r\n  }\r\n\r\n  private extractEsriJSONData(res, zIndex, allowedFieldsAndAlias) {\r\n    if (res) {\r\n      try {\r\n        if (JSON.parse(res).error) {\r\n          return [];\r\n        }\r\n      } catch (e) {}\r\n    }\r\n    const parser = new olFormatEsriJSON();\r\n    const features = parser.readFeatures(res);\r\n\r\n    return features.map(feature => this.featureToResult(feature, zIndex, allowedFieldsAndAlias));\r\n  }\r\n\r\n  private extractTextData(res) {\r\n    // TODO\r\n    return [];\r\n  }\r\n\r\n  private extractHtmlData(\r\n    res,\r\n    htmlTarget: QueryHtmlTarget,\r\n    url,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const projection = searchParams.crs || searchParams.srs || 'EPSG:3857';\r\n    const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n    if (\r\n      htmlTarget !== QueryHtmlTarget.BLANK &&\r\n      htmlTarget !== QueryHtmlTarget.IFRAME\r\n    ) {\r\n      htmlTarget = QueryHtmlTarget.IFRAME;\r\n    }\r\n\r\n    const bodyTagStart = res.toLowerCase().indexOf('<body>');\r\n    const bodyTagEnd = res.toLowerCase().lastIndexOf('</body>') + 7;\r\n    // replace \\r \\n  and ' ' with '' to validate if the body is really empty. Clear all the html tags from body\r\n    const body = striptags(res.slice(bodyTagStart, bodyTagEnd).replace(/(\\r|\\n|\\s)/g, ''));\r\n    if (body === '' || res === '') {\r\n      return [];\r\n    }\r\n\r\n    return [\r\n      {\r\n        type: FEATURE,\r\n        projection,\r\n        properties: Object.assign({ target: htmlTarget, body: res, url }, imposedProperties),\r\n        geometry: imposedGeometry || geomToAdd\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getQueryParams(url) {\r\n    const queryString = url.split('?');\r\n    if (!queryString[1]) {\r\n      return;\r\n    }\r\n    const pairs = queryString[1].split('&');\r\n\r\n    const result = {};\r\n    pairs.forEach(pair => {\r\n      pair = pair.split('=');\r\n      result[pair[0]] = decodeURIComponent(pair[1] || '');\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public featureToResult(\r\n    featureOL: olFeature<olgeom.Geometry>,\r\n    zIndex: number,\r\n    allowedFieldsAndAlias?\r\n  ): Feature {\r\n    const featureGeometry = featureOL.getGeometry() as any;\r\n    const properties: any = Object.assign({}, featureOL.getProperties());\r\n    delete properties.geometry;\r\n    delete properties.GEOMETRIE;\r\n    delete properties.boundedBy;\r\n    delete properties.shape;\r\n    delete properties.SHAPE;\r\n    delete properties.SHAPE_S;\r\n    delete properties.SHAPE_L;\r\n    delete properties.SHAPE_P;\r\n    delete properties.the_geom;\r\n    delete properties.geom;\r\n    delete properties.geom32198;\r\n\r\n    let geometry;\r\n    if (featureGeometry) {\r\n      geometry = {\r\n        type: featureGeometry.getType(),\r\n        coordinates: featureGeometry.getCoordinates()\r\n      };\r\n    }\r\n\r\n    return {\r\n      type: FEATURE,\r\n      projection: undefined,\r\n      properties,\r\n      geometry,\r\n      meta: {\r\n        id: uuid(),\r\n        order: 1000 - zIndex,\r\n        alias: allowedFieldsAndAlias\r\n      }\r\n    };\r\n  }\r\n\r\n  private getQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    forceGML2 = false,\r\n    mapExtent?: MapExtent\r\n  ): string | QueryUrlData[]{\r\n    let url;\r\n\r\n    if (datasource.options.queryUrls) {\r\n      return this.getCustomQueryUrl(datasource, options, mapExtent);\r\n    }\r\n\r\n    switch (datasource.constructor) {\r\n      case WMSDataSource:\r\n        const wmsDatasource = datasource as WMSDataSource;\r\n\r\n        const WMSGetFeatureInfoOptions = {\r\n          INFO_FORMAT:\r\n            wmsDatasource.params.INFO_FORMAT ||\r\n            this.getMimeInfoFormat(datasource.options.queryFormat),\r\n          QUERY_LAYERS: wmsDatasource.params.LAYERS,\r\n          FEATURE_COUNT: wmsDatasource.params.FEATURE_COUNT || this.defaultFeatureCount\r\n        };\r\n\r\n        if (wmsDatasource.params.FEATURE_COUNT) {\r\n          this.featureCount = wmsDatasource.params.FEATURE_COUNT;\r\n        }\r\n\r\n        if (forceGML2) {\r\n          WMSGetFeatureInfoOptions.INFO_FORMAT = this.getMimeInfoFormat(\r\n            QueryFormat.GML2\r\n          );\r\n        }\r\n\r\n        url = wmsDatasource.ol.getFeatureInfoUrl(\r\n          options.coordinates,\r\n          options.resolution,\r\n          options.projection,\r\n          WMSGetFeatureInfoOptions\r\n        );\r\n        // const wmsVersion =\r\n        //   wmsDatasource.params.VERSION ||\r\n        //   wmsDatasource.params.version ||\r\n        //   '1.3.0';\r\n        // if (wmsVersion !== '1.3.0') {\r\n        //   url = url.replace('&I=', '&X=');\r\n        //   url = url.replace('&J=', '&Y=');\r\n        // }\r\n        break;\r\n      case CartoDataSource:\r\n        const cartoDatasource = datasource as CartoDataSource;\r\n        const baseUrl =\r\n          'https://' +\r\n          cartoDatasource.options.account +\r\n          '.carto.com/api/v2/sql?';\r\n        const format = 'format=GeoJSON';\r\n        const sql =\r\n          '&q=' + cartoDatasource.options.config.layers[0].options.sql;\r\n        const clause =\r\n          ' WHERE ST_Intersects(the_geom_webmercator,ST_BUFFER(ST_SetSRID(ST_POINT(';\r\n        const meters = cartoDatasource.options.queryPrecision\r\n          ? cartoDatasource.options.queryPrecision\r\n          : '1000';\r\n        const coordinates =\r\n          options.coordinates[0] +\r\n          ',' +\r\n          options.coordinates[1] +\r\n          '),3857),' +\r\n          meters +\r\n          '))';\r\n\r\n        url = `${baseUrl}${format}${sql}${clause}${coordinates}`;\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case TileArcGISRestDataSource:\r\n        const tileArcGISRestDatasource = datasource as TileArcGISRestDataSource;\r\n        const deltaX = Math.abs(mapExtent[0] - mapExtent[2]);\r\n        const deltaY = Math.abs(mapExtent[1] - mapExtent[3]);\r\n        const maxDelta = deltaX > deltaY ? deltaX : deltaY;\r\n        const clickBuffer = maxDelta * 0.005;\r\n        const threshold = tileArcGISRestDatasource.options.queryPrecision ? tileArcGISRestDatasource.options.queryPrecision : clickBuffer;\r\n        const extent = olextent.buffer(\r\n          olextent.boundingExtent([options.coordinates]),\r\n          threshold\r\n        );\r\n        const serviceUrl =\r\n          tileArcGISRestDatasource.options.url +\r\n          '/' +\r\n          tileArcGISRestDatasource.options.layer +\r\n          '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        url = `${serviceUrl}?${params.join('&')}`;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return url;\r\n  }\r\n\r\n  private getMimeInfoFormat(queryFormat: string) {\r\n    let mime = 'application/vnd.ogc.gml';\r\n    const keyEnum = Object.keys(QueryFormat).find(\r\n      key => QueryFormat[key] === queryFormat\r\n    );\r\n    if (keyEnum) {\r\n      mime = QueryFormatMimeType[keyEnum];\r\n    }\r\n\r\n    return mime;\r\n  }\r\n\r\n  getAllowedFieldsAndAlias(layer: any) {\r\n    let allowedFieldsAndAlias;\r\n    if (\r\n      layer.options?.source?.options?.sourceFields &&\r\n      layer.options.source.options.sourceFields.length >= 1\r\n    ) {\r\n      allowedFieldsAndAlias = {};\r\n      layer.options.source.options.sourceFields.forEach(sourceField => {\r\n        const alias = sourceField.alias ? sourceField.alias : sourceField.name;\r\n        allowedFieldsAndAlias[sourceField.name] = alias;\r\n      });\r\n    }\r\n    return allowedFieldsAndAlias;\r\n  }\r\n\r\n  getQueryTitle(feature: Feature, layer: Layer): string {\r\n    let title;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        title = this.getLabelMatch(feature, dataSourceOptions.queryTitle);\r\n      }\r\n    }\r\n\r\n    return title;\r\n  }\r\n\r\n  getLabelMatch(feature: Feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.properties[v[1]]);\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.properties[labelMatch] || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  /**\r\n   * @param datasource QueryableDataSource\r\n   * @param options QueryOptions\r\n   * @mapExtent extent of the map when click event\r\n   *\r\n   */\r\n\r\n  getCustomQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    mapExtent?: MapExtent): QueryUrlData[] {\r\n\r\n      const extent = olextent.getForViewAndSize(\r\n        options.coordinates,\r\n        options.resolution,\r\n        0,\r\n        [101, 101]\r\n      );\r\n\r\n      return datasource.options.queryUrls.map(item => {\r\n        let data: QueryUrlData = {\r\n          url: item.url.replace(/\\{bbox\\}/g, extent.join(','))\r\n          .replace(/\\{x\\}/g, options.coordinates[0].toString())\r\n          .replace(/\\{y\\}/g, options.coordinates[1].toString())\r\n          .replace(/\\{resolution\\}/g, options.resolution.toString())\r\n          .replace(/\\{srid\\}/g, options.projection.replace('EPSG:',''))\r\n        };\r\n\r\n        // if the queryFormat changed to \"QueryFormat.HTMLGML2\": mapExtent will be undefined\r\n        // we need to check \"mapExtent\" befor replace variables in the url\r\n        if(mapExtent) {\r\n          data.url.replace(/\\{xmin\\}/g, mapExtent[0].toString())\r\n          .replace(/\\{ymin\\}/g, mapExtent[1].toString())\r\n          .replace(/\\{xmax\\}/g, mapExtent[2].toString())\r\n          .replace(/\\{ymax\\}/g, mapExtent[3].toString());\r\n        }\r\n\r\n        if(item.maxResolution) {\r\n          data.maxResolution = item.maxResolution;\r\n        }\r\n\r\n        if(item.minResolution) {\r\n          data.minResolution = item.minResolution;\r\n        }\r\n\r\n        if(item.minScale) {\r\n          data.minScale = item.minScale;\r\n        }\r\n\r\n        if(item.maxScale) {\r\n          data.maxScale = item.maxScale;\r\n        }\r\n\r\n        return data;\r\n      });\r\n    }\r\n}\r\n","import OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\n\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { QueryableDataSource } from './query.interfaces';\r\n\r\n/**\r\n * Whether a layer is queryable\r\n * @param layer Layer\r\n * @returns True if the layer s squeryable\r\n */\r\nexport function layerIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryable === true;\r\n}\r\n\r\n/**\r\n * Whether an OL layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol layer is queryable\r\n */\r\nexport function olLayerIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : layerIsQueryable(layer);\r\n}\r\n\r\n/**\r\n * Whether a layer's feature is queryable\r\n * @param layer Layer\r\n * @returns True if the layer's feature is queryable\r\n */\r\nexport function layerFeatureIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryLayerFeatures !== undefined ? (dataSource.options.queryLayerFeatures === true) : true;\r\n}\r\n\r\n/**\r\n * Whether an OL Vector layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol vector layer is queryable\r\n */\r\nexport function olLayerFeatureIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : (layerIsQueryable(layer) && layerFeatureIsQueryable(layer));\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  AfterViewInit,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { Subscription, Observable, of, zip } from 'rxjs';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport OlFeature from 'ol/Feature';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { EventsKey } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { renderFeatureFromOl } from '../../feature/shared/feature.utils';\r\nimport { featureFromOl } from '../../feature/shared/feature.utils';\r\nimport { QueryService } from './query.service';\r\nimport { layerIsQueryable, olLayerFeatureIsQueryable } from './query.utils';\r\nimport { ctrlKeyDown } from '../../map/shared/map.utils';\r\nimport { OlDragSelectInteraction } from '../../feature/shared/strategies/selection';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { QueryableDataSourceOptions } from './query.interfaces';\r\n\r\n/**\r\n * This directive makes a map queryable with a click of with a drag box.\r\n * By default, all layers are queryable but this can ben controlled at\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoQuery]'\r\n})\r\nexport class QueryDirective implements AfterViewInit, OnDestroy {\r\n  /**\r\n   * Subscriptions to ongoing queries\r\n   */\r\n  private queries$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * OL drag box interaction\r\n   */\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  /**\r\n   * Ol drag box \"end\" event key\r\n   */\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Whter to query features or not\r\n   */\r\n  @Input() queryFeatures: boolean = false;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesHitTolerance: number = 0;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesCondition: (olLayer: OlLayer<OlSource>) => boolean;\r\n\r\n  /**\r\n   * Whether all query should complete before emitting an event\r\n   */\r\n  @Input() waitForAllQueries: boolean = true;\r\n\r\n  /**\r\n   * Event emitted when a query (or all queries) complete\r\n   */\r\n  @Output() query = new EventEmitter<{\r\n    features: Feature[] | Feature[][];\r\n    event: MapBrowserPointerEvent<any>;\r\n  }>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return (this.component.map as any) as IgoMap;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private queryService: QueryService\r\n  ) {}\r\n\r\n  /**\r\n   * Start listening to click and drag box events\r\n   * @internal\r\n   */\r\n  ngAfterViewInit() {\r\n    this.listenToMapClick();\r\n    this.addDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to click and drag box events and cancel ongoind requests\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.cancelOngoingQueries();\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * On map click, issue queries\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Issue queries from a map event and emit events with the results\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    this.cancelOngoingQueries();\r\n    if (!this.queryService.queryEnabled) {\r\n      return;\r\n    }\r\n\r\n    const queries$ = [];\r\n    if (this.queryFeatures) {\r\n      queries$.push(this.doQueryFeatures(event));\r\n    }\r\n\r\n    const resolution = this.map.ol.getView().getResolution();\r\n    const queryLayers = this.map.layers.filter(layerIsQueryable);\r\n    queries$.push(\r\n      ...this.queryService.query(queryLayers, {\r\n        coordinates: event.coordinate as [number, number],\r\n        projection: this.map.projection,\r\n        resolution\r\n      })\r\n    );\r\n\r\n    if (queries$.length === 0) {\r\n      return;\r\n    }\r\n\r\n    if (this.waitForAllQueries) {\r\n      this.queries$$.push(\r\n        zip(...queries$).subscribe((results: Feature[][]) => {\r\n          const features = [].concat(...results);\r\n          this.query.emit({ features, event });\r\n        })\r\n      );\r\n    } else {\r\n      this.queries$$ = queries$.map((query$: Observable<Feature[]>) => {\r\n        return query$.subscribe((features: Feature[]) => {\r\n          this.query.emit({ features, event });\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query features already present on the map\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private doQueryFeatures(\r\n    event: MapBrowserPointerEvent<any>\r\n  ): Observable<Feature[]> {\r\n    const clickedFeatures = [];\r\n\r\n    if (event.type === 'singleclick') {\r\n      this.map.ol.forEachFeatureAtPixel(\r\n        event.pixel,\r\n        (featureOL: OlFeature<OlGeometry>, layerOL: any) => {\r\n          const layer = this.map.getLayerById(layerOL.values_._layer.id);\r\n          if ((layer.dataSource.options as QueryableDataSourceOptions).queryFormatAsWms) {\r\n            return;\r\n          }\r\n          if (featureOL) {\r\n            if (featureOL.get('features')) {\r\n              for (const feature of featureOL.get('features')) {\r\n                const newFeature = featureFromOl(feature, this.map.projection);\r\n                newFeature.meta = {\r\n                  title: feature.values_.nom,\r\n                  id: layerOL.values_._layer.id + '.' + feature.id_,\r\n                  icon: feature.values_._icon,\r\n                  sourceTitle: layerOL.values_.title,\r\n                  alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                  // title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n                };\r\n                clickedFeatures.push(newFeature);\r\n              }\r\n            } else if (featureOL instanceof OlRenderFeature) {\r\n              const newFeature = renderFeatureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            } else {\r\n              const newFeature = featureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            }\r\n          }\r\n        },\r\n        {\r\n          hitTolerance: this.queryFeaturesHitTolerance || 0,\r\n          layerFilter: this.queryFeaturesCondition\r\n            ? this.queryFeaturesCondition\r\n            : olLayerFeatureIsQueryable\r\n        }\r\n      );\r\n    } else if (event.type === 'boxend') {\r\n      const target = event.target as any;\r\n      const dragExtent = target.getGeometry().getExtent();\r\n      this.map.layers\r\n        .filter(layerIsQueryable)\r\n        .filter(layer => layer instanceof VectorLayer && layer.visible)\r\n        .map(layer => {\r\n          const featuresOL = layer.dataSource.ol as olVectorSource<OlGeometry>;\r\n          featuresOL.forEachFeatureIntersectingExtent(dragExtent, (olFeature: any) => {\r\n            const newFeature: Feature = featureFromOl(olFeature, this.map.projection, layer.ol);\r\n            newFeature.meta = {\r\n              id: layer.id + '.' + olFeature.getId(),\r\n              icon: olFeature.values_._icon,\r\n              sourceTitle: layer.title,\r\n              alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n              title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n            };\r\n            clickedFeatures.push(newFeature);\r\n          });\r\n        });\r\n    }\r\n\r\n\r\n    return of(clickedFeatures);\r\n  }\r\n\r\n  /**\r\n   * Cancel ongoing requests, if any\r\n   */\r\n  private cancelOngoingQueries() {\r\n    this.queries$$.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.queries$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteractionOnQuery;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteractionOnQuery = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteractionOnQuery === undefined) {\r\n      olDragSelectInteractionOnQuery = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteractionOnQuery);\r\n      this.olDragSelectInteraction = olDragSelectInteractionOnQuery;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteractionOnQuery.on(\r\n      'boxend',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions,\r\n  SearchSourceSettings\r\n} from './source.interfaces';\r\nimport { FeatureStore } from '../../../feature';\r\nimport { Workspace } from '@igo2/common';\r\n\r\n/**\r\n * Base search source class\r\n */\r\nexport class SearchSource {\r\n  /**\r\n   * Search source ID\r\n   * @internal\r\n   */\r\n  static id = '';\r\n\r\n  /**\r\n   * Search source type\r\n   * @internal\r\n   */\r\n  static type = '';\r\n\r\n  /**\r\n   * Search source options\r\n   * @internal\r\n   */\r\n  protected options: SearchSourceOptions;\r\n\r\n  /**\r\n   * Get search source's id\r\n   * @returns Search source's id\r\n   */\r\n  getId(): string {\r\n    throw new Error('You have to implement the method \"getId\".');\r\n  }\r\n  /**\r\n   * Get search source's type\r\n   * @returns Search source's type\r\n   */\r\n  getType(): string {\r\n    throw new Error('You have to implement the method \"getType\".');\r\n  }\r\n\r\n  /**\r\n   * Get search source's default options\r\n   * @returns Search source default options\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    throw new Error('You have to implement the method \"getDefaultOptions\".');\r\n  }\r\n\r\n  /**\r\n   * Search source's title\r\n   */\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is available\r\n   */\r\n  get available(): boolean {\r\n    return this.options.available !== false;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is enabled\r\n   */\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  get enabled(): boolean {\r\n    return this.available && this.options.enabled !== false;\r\n  }\r\n\r\n  get showInPointerSummary(): boolean {\r\n    const showInPointerSummary = this.options.showInPointerSummary;\r\n    return showInPointerSummary ? showInPointerSummary : false;\r\n  }\r\n\r\n  get showInSettings(): boolean {\r\n    const showInSettings = this.options.showInSettings;\r\n    return showInSettings === undefined ? true : showInSettings;\r\n  }\r\n\r\n  /**\r\n   * Search url\r\n   */\r\n  get searchUrl(): string {\r\n    return this.options.searchUrl;\r\n  }\r\n\r\n  /**\r\n   * Search query params\r\n   */\r\n  get params(): { [key: string]: string } {\r\n    return this.options.params === undefined ? {} : this.options.params;\r\n  }\r\n\r\n  /**\r\n   * Search settings\r\n   */\r\n  get settings(): SearchSourceSettings[] {\r\n    return this.options.settings === undefined ? [] : this.options.settings;\r\n  }\r\n\r\n  set featureStoresWithIndex(storesWithIndex: FeatureStore[]) {\r\n    this._featureStoresWithIndex = storesWithIndex;\r\n  }\r\n  get featureStoresWithIndex() {\r\n    return this._featureStoresWithIndex;\r\n  }\r\n  private _featureStoresWithIndex: FeatureStore[];\r\n\r\n  setWorkspaces(workspaces: Workspace[]) {\r\n    if (workspaces.filter(fw => (fw.entityStore as FeatureStore).searchDocument).length >= 1) {\r\n      this.options.available = true;\r\n    } else {\r\n      this.options.available = false;\r\n    }\r\n    const values = [];\r\n    this.featureStoresWithIndex = workspaces\r\n      .filter(fw => (fw.entityStore as FeatureStore).searchDocument)\r\n      .map(fw => {\r\n        values.push({\r\n          title: fw.title,\r\n          value: fw.title,\r\n          enabled: true\r\n        });\r\n        return fw.entityStore as FeatureStore;\r\n      });\r\n    const datasets = this.options.settings.find(s => s.title === 'datasets');\r\n    if (datasets) {\r\n      datasets.values = values;\r\n    }\r\n    this.setParamFromSetting(datasets);\r\n  }\r\n\r\n  /**\r\n   * Set params from selected settings\r\n   */\r\n  setParamFromSetting(setting: SearchSourceSettings, saveInStorage = true) {\r\n    switch (setting.type) {\r\n      case 'radiobutton':\r\n        setting.values.forEach(conf => {\r\n          if (conf.enabled) {\r\n            this.options.params = Object.assign(this.options.params || {}, {\r\n              [setting.name]: conf.value\r\n            });\r\n          }\r\n        });\r\n        break;\r\n      case 'checkbox':\r\n        let confValue = '';\r\n        setting.values\r\n          .filter(s => s.available !== false)\r\n          .forEach(conf => {\r\n            if (conf.enabled) {\r\n              confValue += conf.value + ',';\r\n            }\r\n          });\r\n        confValue = confValue.slice(0, -1);\r\n        this.options.params = Object.assign(this.options.params || {}, {\r\n          [setting.name]: confValue\r\n        });\r\n        break;\r\n    }\r\n\r\n    if (saveInStorage && this.storageService) {\r\n      this.storageService.set(\r\n        this.getId() + '.options',\r\n        {params: this.options.params}\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search results display order\r\n   */\r\n  get displayOrder(): number {\r\n    return this.options.order === undefined ? 99 : this.options.order;\r\n  }\r\n\r\n  constructor(options: SearchSourceOptions, private storageService?: StorageService) {\r\n    this.options = options;\r\n    if (this.storageService) {\r\n      const storageOptions = this.storageService.get(\r\n        this.getId() + '.options'\r\n      ) as object;\r\n      if (storageOptions) {\r\n        this.options = ObjectUtils.mergeDeep(this.options, storageOptions);\r\n      }\r\n    }\r\n\r\n    this.options = ObjectUtils.mergeDeep(this.getDefaultOptions(), this.options);\r\n\r\n\r\n    // Set Default Params from Settings\r\n    this.settings.forEach(setting => {\r\n      this.setParamFromSetting(setting, false);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get hashtags valid\r\n   * @param hashtag hashtag from query\r\n   */\r\n  getHashtagsValid(term: string, settingsName: string): string[] {\r\n    const hashtags = term.match(/(#[A-Za-zÀ-ÿ-+]+)/g);\r\n    if (!hashtags) {\r\n      return undefined;\r\n    }\r\n\r\n    const searchSourceSetting = this.getSettingsValues(settingsName);\r\n    const hashtagsValid = [];\r\n    hashtags.forEach(hashtag => {\r\n      searchSourceSetting.values.forEach(conf => {\r\n        const hashtagKey = hashtag.substring(1);\r\n        if (typeof conf.value === 'string') {\r\n          const types = conf.value\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n            .split(',');\r\n          const index = types.indexOf(\r\n            hashtagKey\r\n              .toLowerCase()\r\n              .normalize('NFD')\r\n              .replace(/[\\u0300-\\u036f]/g, '')\r\n          );\r\n          if (index !== -1) {\r\n            hashtagsValid.push(types[index]);\r\n          }\r\n        }\r\n        if (conf.hashtags && conf.hashtags.indexOf(hashtagKey.toLowerCase()) !== -1) {\r\n          hashtagsValid.push(conf.value);\r\n        }\r\n      });\r\n    });\r\n\r\n    return hashtagsValid.filter((a, b) => hashtagsValid.indexOf(a) === b);\r\n  }\r\n\r\n  getSettingsValues(search: string): SearchSourceSettings {\r\n    return this.getDefaultOptions().settings.find(\r\n      (value: SearchSourceSettings) => {\r\n        return value.name === search;\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by text implement this class\r\n */\r\nexport interface TextSearch {\r\n  /**\r\n   * Search by text\r\n   * @param term Text\r\n   * @param options Optional: TextSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by coordinates implement this class\r\n */\r\nexport interface ReverseSearch {\r\n  /**\r\n   * Search by text\r\n   * @param lonLat Coordinates\r\n   * @param options Optional: ReverseSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    reverseSearchCoordsFormat?: boolean\r\n  ): Observable<SearchResult[]>;\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { SearchSourceOptions } from '../../search/shared/sources/source.interfaces';\r\n/**\r\n * Map search source. For now it has no search capability. All it does\r\n * is act as a placeholder for the map query results' \"search source\".\r\n */\r\n@Injectable()\r\nexport class QuerySearchSource extends SearchSource {\r\n  static id = 'map';\r\n  static type = FEATURE;\r\n\r\n  constructor(@Inject('options') options: SearchSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return QuerySearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return QuerySearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Carte'\r\n    };\r\n  }\r\n}\r\n","export class GoogleLinks {\r\n  static getGoogleMapsCoordLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleStreetViewLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=&layer=c&cbll=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleMapsNameLink(name) {\r\n    const encodedName = encodeURI(name);\r\n    return 'https://www.google.com/maps?q=' + encodedName;\r\n  }\r\n}\r\n","export class OsmLinks {\r\n  static getOpenStreetMapLink(lon, lat, zoom: number = 17) {\r\n    // return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n    return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=${zoom}/${lat}/${lon}`;\r\n  }\r\n\r\n  static getOpenStreetCamLink(lon, lat, zoom: number = 17) {\r\n    return `https://openstreetcam.org/map/@${lat},${lon},${zoom}z`;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { EMPTY, Observable, of, zip } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService, ConfigService } from '@igo2/core';\r\nimport {\r\n  CapabilitiesService,\r\n  WMSDataSourceOptions,\r\n  WMSDataSourceOptionsParams,\r\n  WMTSDataSourceOptions,\r\n  ArcGISRestDataSourceOptions\r\n} from '../../datasource';\r\nimport { LayerOptions, ImageLayerOptions } from '../../layer';\r\nimport { getResolutionFromScale } from '../../map';\r\n\r\nimport {\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  ForcedProperty\r\n} from './catalog.interface';\r\nimport { Catalog, CatalogFactory, CompositeCatalog } from './catalog.abstract';\r\nimport { CatalogItemType, TypeCatalog } from './catalog.enum';\r\nimport { QueryFormat } from '../../query';\r\nimport { generateIdFromSourceOptions } from '../../utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CatalogService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private capabilitiesService: CapabilitiesService\r\n  ) {}\r\n\r\n  loadCatalogs(): Observable<Catalog[]> {\r\n    const contextConfig = this.config.getConfig('context') || {};\r\n    const catalogConfig = this.config.getConfig('catalog') || {};\r\n    const apiUrl = catalogConfig.url || contextConfig.url;\r\n    const catalogsFromConfig = catalogConfig.sources || [];\r\n\r\n    const observables$ = [];\r\n\r\n    if (apiUrl) {\r\n      // Base layers catalog\r\n      if (catalogConfig.baseLayers) {\r\n        const translate = this.languageService.translate;\r\n        const title = translate.instant('igo.geo.catalog.baseLayers');\r\n        const baseLayersCatalog = [\r\n          {\r\n            id: 'catalog.baselayers',\r\n            title,\r\n            url: `${apiUrl}/baselayers`,\r\n            type: 'baselayers'\r\n          }\r\n        ];\r\n        observables$.push(of(baseLayersCatalog));\r\n      }\r\n\r\n      // Catalogs from API\r\n      const catalogsFromApi$ = this.http\r\n        .get<Catalog[]>(`${apiUrl}/catalogs`)\r\n        .pipe(\r\n          map((catalogs) =>\r\n            catalogs.map((c: any) => Object.assign(c, c.options))\r\n          ),\r\n          catchError((_response: HttpErrorResponse) => EMPTY)\r\n        );\r\n      observables$.push(catalogsFromApi$);\r\n    }\r\n\r\n    // Catalogs from config\r\n    if (catalogsFromConfig.length > 0) {\r\n      observables$.push(\r\n        of(catalogsFromConfig).pipe(\r\n          map((catalogs: Catalog[]) =>\r\n            catalogs.map((c) => {\r\n              if (!c.id) {\r\n                c.id = uuid();\r\n              }\r\n              return c;\r\n            })\r\n          )\r\n        )\r\n      );\r\n    }\r\n\r\n    return zip(...observables$).pipe(\r\n      map((catalogs: Catalog[][]) => [].concat.apply([], catalogs))\r\n    ) as Observable<Catalog[]>;\r\n  }\r\n\r\n  loadCatalogItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    let newCatalog: Catalog;\r\n    newCatalog = CatalogFactory.createInstanceCatalog(catalog, this);\r\n    return newCatalog.collectCatalogItems();\r\n  }\r\n\r\n  loadCatalogBaseLayerItems(catalog: Catalog): Observable<CatalogItemGroup[]> {\r\n    return this.getCatalogBaseLayersOptions(catalog).pipe(\r\n      map((layersOptions: LayerOptions[]) => {\r\n        const items = layersOptions.map((layerOptions: LayerOptions) => {\r\n          return {\r\n            id: generateIdFromSourceOptions(layerOptions.sourceOptions),\r\n            title: layerOptions.title,\r\n            type: CatalogItemType.Layer,\r\n            externalProvider: catalog.externalProvider,\r\n            options: layerOptions\r\n          } as CatalogItemLayer;\r\n        });\r\n        return [\r\n          {\r\n            id: 'catalog.group.baselayers',\r\n            type: CatalogItemType.Group,\r\n            externalProvider: catalog.externalProvider,\r\n            title: catalog.title,\r\n            items\r\n          }\r\n        ];\r\n      })\r\n    );\r\n  }\r\n\r\n  private getCatalogBaseLayersOptions(\r\n    catalog: Catalog\r\n  ): Observable<LayerOptions[]> {\r\n    return this.http.get<LayerOptions[]>(catalog.url);\r\n  }\r\n\r\n  loadCatalogWMSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        const items = [];\r\n        if (!capabilities) {\r\n          return items;\r\n        }\r\n        if (capabilities.Service && capabilities.Service.Abstract && capabilities.Service.Abstract.length) {\r\n          catalog.abstract = capabilities.Service.Abstract;\r\n        }\r\n        const finalLayers = [];\r\n        this.flattenWmsCapabilities(capabilities.Capability.Layer, 0, finalLayers, catalog.groupSeparator);\r\n        const capabilitiesCapabilityLayer = Object.assign({}, capabilities.Capability.Layer);\r\n        capabilitiesCapabilityLayer.Layer = finalLayers.filter(f => f.Layer.length !== 0);\r\n        this.includeRecursiveItems(\r\n          catalog,\r\n          capabilitiesCapabilityLayer,\r\n          items\r\n        );\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  flattenWmsCapabilities(parent, level = 0, finalLayers, separator = ' / ') {\r\n    if (!finalLayers.includes(parent.Title)) {\r\n        const modifiedParent = Object.assign({}, parent);\r\n        modifiedParent.Layer = [];\r\n        finalLayers.push(modifiedParent);\r\n    }\r\n    for (const layer of parent.Layer) {\r\n        const modifiedLayer = Object.assign({}, layer);\r\n        if (level > 0) {\r\n          modifiedLayer.Title = parent.Title + separator + layer.Title;\r\n        }\r\n        if (layer.Layer) {\r\n            this.flattenWmsCapabilities(modifiedLayer, level + 1, finalLayers, separator);\r\n        } else {\r\n            finalLayers.find(ff => ff.Title === parent.Title).Layer.push(layer);\r\n         }\r\n    }\r\n}\r\n\r\n  loadCatalogWMTSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => this.getWMTSItems(catalog, capabilities))\r\n    );\r\n  }\r\n\r\n  loadCatalogArcGISRestItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        return this.getArcGISRESTItems(catalog, capabilities);\r\n      })\r\n    );\r\n  }\r\n\r\n  loadCatalogCompositeLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    const compositeCatalog = (catalog as CompositeCatalog).composite;\r\n\r\n    const catalogsFromInstance = [] as Catalog[];\r\n    compositeCatalog.map((component: Catalog) => {\r\n      component.sortDirection = catalog.sortDirection; // propagate sortDirection with parent value\r\n      catalogsFromInstance.push(\r\n        CatalogFactory.createInstanceCatalog(component, this)\r\n    );\r\n  }\r\n    );\r\n\r\n    // get CatalogItems for each original Catalog-----------------------------------------------------\r\n    const request1$ = [];\r\n    catalogsFromInstance.map((component: Catalog) =>\r\n      request1$.push(component.collectCatalogItems())\r\n    );\r\n\r\n    // integrate imposed group -----------------------------------------------------\r\n    let request2$ = [];\r\n\r\n    function flatDeepLayer(arr) {\r\n      return arr.reduce(\r\n        (acc, val) =>\r\n          acc.concat(\r\n            val.type === CatalogItemType.Group ? flatDeepLayer(val.items) : val\r\n          ),\r\n        []\r\n      );\r\n    }\r\n\r\n    if (\r\n      Object.keys(compositeCatalog).find((k) => compositeCatalog[k].groupImpose)\r\n    ) {\r\n      const pushImposeGroup = (item, index) => {\r\n        const c = catalogsFromInstance[index];\r\n        const outGroupImpose = Object.assign({}, c.groupImpose);\r\n        outGroupImpose.address = c.id;\r\n        outGroupImpose.type = CatalogItemType.Group;\r\n        outGroupImpose.externalProvider = c.externalProvider;\r\n        if (outGroupImpose.sortDirection === undefined) {\r\n          outGroupImpose.sortDirection = c.sortDirection;\r\n        }\r\n        outGroupImpose.items = [];\r\n\r\n        const flatLayer = flatDeepLayer(item);\r\n        flatLayer.map(\r\n          (v) => (v.address = `${outGroupImpose.address}.${outGroupImpose.id}`)\r\n        );\r\n        outGroupImpose.items = flatLayer;\r\n\r\n        return outGroupImpose;\r\n      };\r\n\r\n      request2$ = request1$.map((obs, idx) =>\r\n        obs.pipe(\r\n          map((items) =>\r\n            compositeCatalog[idx].groupImpose\r\n              ? pushImposeGroup(items, idx)\r\n              : items\r\n          )\r\n        )\r\n      );\r\n    } else {\r\n      request2$ = request1$;\r\n    }\r\n\r\n    // concat Group -----------------------------------------------------\r\n    const request3$ = zip(...request2$).pipe(\r\n      map(\r\n        (output: CatalogItem[]) => [].concat(...output) // [].concat.apply([], result1\r\n      )\r\n    );\r\n\r\n    // merge Group (first level only) -----------------------------------------------------\r\n    const groupByGroupId = (data, keyFn) =>\r\n      data.reduce((acc, group) => {\r\n        const groupId = keyFn(group);\r\n        const ind = acc.find((x) => x.id === groupId);\r\n\r\n        if (!ind) {\r\n          acc[acc.length] = group;\r\n        } else {\r\n          const ix = acc.indexOf(ind);\r\n          if (acc[ix].address.split('|').indexOf(group.address) === -1) {\r\n            acc[ix].address = `${acc[ix].address}|${group.address}`;\r\n          }\r\n          acc[ix].items.push(...group.items);\r\n        }\r\n        return acc;\r\n      }, []);\r\n\r\n    // merge Layer for each Level (catalog, group(recursive))\r\n    const recursiveGroupByLayerAddress = (items, keyFn) =>\r\n      items.reduce((acc, item, idx, arr) => {\r\n        const layerTitle = keyFn(item);\r\n        const outItem = Object.assign({}, item);\r\n\r\n        if (item.type === CatalogItemType.Layer) {\r\n          // same title, same address => result: only one item is kept\r\n\r\n          // same title, address diff\r\n          const indicesMatchTitle = [];\r\n          const indicesMatchNewMetadataUrl = []; // metadata\r\n          const diffAddress = arr.filter((x, i) => {\r\n            let bInd = false;\r\n            if (x.title === layerTitle && x.type === CatalogItemType.Layer) {\r\n              if (i !== idx && x.address !== item.address) {\r\n                bInd = true;\r\n              }\r\n              indicesMatchTitle.push(i);\r\n            }\r\n            return bInd;\r\n          }); // $& i !== idx\r\n\r\n          if (diffAddress.length > 0) {\r\n            let nPosition = indicesMatchTitle.findIndex((x) => x === idx) + 1;\r\n            outItem.title = `${item.title} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n            nPosition = indicesMatchNewMetadataUrl.findIndex((x) => x === idx) + 1;\r\n            outItem.newMetadataUrl = `${item.newMetadataUrl} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n          }\r\n\r\n          const exist = acc.find(\r\n            (x) => x.title === outItem.title && x.type === CatalogItemType.Layer\r\n          );\r\n          if (!exist) {\r\n            acc[acc.length] = outItem;\r\n          }\r\n        } else if (item.type === CatalogItemType.Group) {\r\n          outItem.items = recursiveGroupByLayerAddress(\r\n            item.items,\r\n            (layer) => layer.title\r\n          );\r\n          acc[acc.length] = outItem;\r\n        }\r\n\r\n        return acc;\r\n      }, []);\r\n\r\n    const request4$ = request3$.pipe(\r\n      map((output) => groupByGroupId(output, (group) => group.id)),\r\n      map((output) => [].concat(...output)),\r\n      map((data) => recursiveGroupByLayerAddress(data, (layer) => layer.title))\r\n    );\r\n\r\n    return request4$;\r\n  }\r\n\r\n  private getCatalogCapabilities(catalog: Catalog): Observable<any> {\r\n    const sType: string = TypeCatalog[catalog.type as string];\r\n    return this.capabilitiesService\r\n      .getCapabilities(sType as any, catalog.url, catalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          this.messageService.error(\r\n            catalog.title ? 'igo.geo.catalog.unavailable' : 'igo.geo.catalog.someUnavailable',\r\n            'igo.geo.catalog.unavailableTitle',\r\n            undefined,\r\n            catalog.title ? { value: catalog.title } : undefined);\r\n          console.error(e);\r\n          return of(undefined);\r\n        })\r\n      );\r\n  }\r\n\r\n  private computeForcedProperties(\r\n    layerNameFromCatalog: string,\r\n    forcedProperties: ForcedProperty[]): ForcedProperty {\r\n\r\n    if (!forcedProperties || forcedProperties.length === 0) {\r\n      return;\r\n    }\r\n    const returnProperty: ForcedProperty = {\r\n      layerName: layerNameFromCatalog,\r\n      title: undefined,\r\n      metadataUrl: undefined,\r\n      metadataAbstract: undefined,\r\n      metadataAbstractAll: undefined,\r\n      metadataUrlAll: undefined\r\n    };\r\n    //process wildcard before\r\n    // if there is a * wildcard\r\n    const forcedPropertiesForAllLayers = forcedProperties.find(f => f.layerName === '*');\r\n    if (forcedPropertiesForAllLayers) {\r\n      // metadataAbstractAll\r\n      if (forcedPropertiesForAllLayers.metadataAbstractAll) {\r\n        returnProperty.metadataAbstractAll = forcedPropertiesForAllLayers.metadataAbstractAll;\r\n      }\r\n      // metadataUrlAll\r\n      if (forcedPropertiesForAllLayers.metadataUrlAll) {\r\n        returnProperty.metadataUrlAll = forcedPropertiesForAllLayers.metadataUrlAll;\r\n      }\r\n    }\r\n    forcedProperties.map(forcedProperty => {\r\n      // if match found\r\n      if (layerNameFromCatalog === forcedProperty.layerName) {\r\n        // title\r\n        if (forcedProperty.title) {\r\n          returnProperty.title = forcedProperty.title;\r\n        }\r\n        // metadataUrl\r\n        if (forcedProperty.metadataUrl) {\r\n          returnProperty.metadataUrl = forcedProperty.metadataUrl;\r\n        }\r\n        // metadataAbstract\r\n        if (forcedProperty.metadataAbstract) {\r\n          returnProperty.metadataAbstract = forcedProperty.metadataAbstract;\r\n        }\r\n      }\r\n    });\r\n    return returnProperty;\r\n  }\r\n\r\n  /// WMS\r\n\r\n  private prepareCatalogItemLayer(layer, idParent, layersQueryFormat, catalog) {\r\n    const configuredQueryFormat = this.retrieveLayerInfoFormat(\r\n      layer.Name,\r\n      layersQueryFormat\r\n    );\r\n\r\n    const legendOptions =\r\n      catalog.showLegend && layer.Style\r\n        ? this.capabilitiesService.getStyle(layer.Style)\r\n        : undefined;\r\n\r\n    const params = Object.assign({}, catalog.queryParams, {\r\n      LAYERS: layer.Name,\r\n      VERSION: catalog.version\r\n    } as WMSDataSourceOptionsParams);\r\n\r\n    const baseSourceOptions = {\r\n      type: 'wms',\r\n      url: catalog.url,\r\n      crossOrigin: catalog.setCrossOriginAnonymous ? 'anonymous' : undefined,\r\n      queryFormat: configuredQueryFormat,\r\n      queryHtmlTarget:\r\n        configuredQueryFormat === QueryFormat.HTML ||\r\n        configuredQueryFormat === QueryFormat.HTMLGML2\r\n          ? 'iframe'\r\n          : undefined,\r\n      optionsFromCapabilities: true\r\n    };\r\n\r\n    const sourceOptions = Object.assign(\r\n      {},\r\n      baseSourceOptions,\r\n      catalog.sourceOptions,\r\n      { params }\r\n    ) as WMSDataSourceOptions;\r\n\r\n    const propertiesToForce = this.computeForcedProperties(layer.Name, catalog.forcedProperties);\r\n    let baseAbstract;\r\n    let extern = true;\r\n    if (layer.Abstract) {\r\n      baseAbstract = layer.Abstract;\r\n    } else if (!layer.Abstract && catalog.abstract) {\r\n      baseAbstract = catalog.abstract;\r\n    }\r\n    const layerOnlineResource = layer?.DataURL && layer?.DataURL.length >0 ? layer?.DataURL[0].OnlineResource : undefined;\r\n\r\n    let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll || layerOnlineResource;\r\n    let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || baseAbstract;\r\n\r\n    if (\r\n      !propertiesToForce?.metadataUrl &&\r\n      !propertiesToForce?.metadataUrlAll &&\r\n      (propertiesToForce?.metadataAbstract ||\r\n        propertiesToForce?.metadataAbstractAll)\r\n    ) {\r\n      extern = false;\r\n    }\r\n    if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n      extern = false;\r\n    }\r\n\r\n    const layerPrepare = {\r\n      id: generateIdFromSourceOptions(sourceOptions),\r\n      type: CatalogItemType.Layer,\r\n      title: propertiesToForce?.title ? propertiesToForce.title : layer.Title,\r\n      address: idParent,\r\n      externalProvider: catalog.externalProvider || false,\r\n      options: {\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        metadata: {\r\n          url: metadataUrl,\r\n          extern,\r\n          abstract: metadataAbstract,\r\n          type: baseSourceOptions.type\r\n        },\r\n        legendOptions,\r\n        tooltip: { type: catalog.tooltipType },\r\n        sourceOptions\r\n      }\r\n    } as CatalogItem;\r\n\r\n    return ObjectUtils.removeUndefined(layerPrepare);\r\n  }\r\n\r\n  private prepareCatalogItemGroup(\r\n    itemListIn,\r\n    regexes,\r\n    idGroup,\r\n    layersQueryFormat,\r\n    catalog\r\n  ) {\r\n    const groupPrepare = {\r\n      id: idGroup,\r\n      type: CatalogItemType.Group,\r\n      title: itemListIn.Title,\r\n      address: catalog.id,\r\n      externalProvider: catalog.externalProvider || false,\r\n      sortDirection: catalog.sortDirection, // propagate sortDirection\r\n      items: itemListIn.Layer.reduce((items: CatalogItem[], layer: any) => {\r\n        if (layer.Layer !== undefined) {\r\n          // recursive, check next level\r\n          const idGroupItemNextLevel =\r\n            idGroup + `.group.${layer.Name || layer.Layer[0].Name}`;\r\n          const groupItem: CatalogItemGroup = this.prepareCatalogItemGroup(\r\n            layer,\r\n            regexes,\r\n            idGroupItemNextLevel,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(groupItem);\r\n        } else {\r\n          if (this.testLayerRegexes(layer.Name, regexes) === false) {\r\n            return items;\r\n          }\r\n\r\n          const layerItem: CatalogItemLayer<ImageLayerOptions> = this.prepareCatalogItemLayer(\r\n            layer,\r\n            idGroup,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(layerItem);\r\n        }\r\n        return items;\r\n      }, [])\r\n    };\r\n    return groupPrepare;\r\n  }\r\n\r\n  private includeRecursiveItems(\r\n    catalog: Catalog,\r\n    itemListIn: any,\r\n    itemsPrepare: CatalogItem[],\r\n    loopLevel: number = 0\r\n  ) {\r\n    // Dig all levels until last level (layer object are not defined on last level)\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n    if (!itemListIn.Layer) {\r\n      return;\r\n    }\r\n\r\n    for (const item of itemListIn.Layer) {\r\n      if (item.Layer !== undefined) {\r\n        // recursive, check next level\r\n        this.includeRecursiveItems(catalog, item, itemsPrepare, loopLevel + 1);\r\n        continue;\r\n      }\r\n\r\n      const layersQueryFormat = this.findCatalogInfoFormat(catalog);\r\n\r\n      // group(with layers) and layer(without group) level 1\r\n      if (loopLevel !== 0) {\r\n        // TODO: Slice that into multiple methods\r\n        // Define object of group layer\r\n        const idGroupItem = `catalog.group.${itemListIn.Name || item.Name}`;\r\n        const groupItem = this.prepareCatalogItemGroup(\r\n          itemListIn,\r\n          regexes,\r\n          idGroupItem,\r\n          layersQueryFormat,\r\n          catalog\r\n        );\r\n\r\n        if (groupItem.items.length !== 0) {\r\n          itemsPrepare.push(groupItem);\r\n        }\r\n\r\n        // Break the group (don't add a group of layer for each of their layer!)\r\n        break;\r\n      } else {\r\n        // layer without group\r\n        if (this.testLayerRegexes(item.Name, regexes) !== false) {\r\n          const layerItem = this.prepareCatalogItemLayer(\r\n            item,\r\n            catalog.id,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n          itemsPrepare.push(layerItem);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /// WMTS\r\n\r\n  private getWMTSItems(\r\n    catalog,\r\n    capabilities: { [key: string]: any }\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers = capabilities.Contents.Layer;\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    if (\r\n      capabilities.ServiceIdentification &&\r\n      capabilities.ServiceIdentification.Abstract &&\r\n      capabilities.ServiceIdentification.Abstract.length) {\r\n      catalog.abstract = capabilities.ServiceIdentification.Abstract;\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n\r\n        const propertiesToForce = this.computeForcedProperties(layer.Title, catalog.forcedProperties);\r\n        let extern = true;\r\n\r\n        let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll;\r\n        let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || catalog.abstract;\r\n\r\n        if (\r\n          !propertiesToForce?.metadataUrl &&\r\n          !propertiesToForce?.metadataUrlAll &&\r\n          (propertiesToForce?.metadataAbstract ||\r\n            propertiesToForce?.metadataAbstractAll)\r\n        ) {\r\n          extern = false;\r\n        }\r\n        if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n          extern = false;\r\n        }\r\n\r\n\r\n      if (this.testLayerRegexes(layer.Identifier, regexes) === false) {\r\n        return undefined;\r\n      }\r\n      const params = Object.assign({}, catalog.queryParams, {\r\n        version: '1.0.0'\r\n      });\r\n      const baseSourceOptions = {\r\n        type: 'wmts',\r\n        url: catalog.url,\r\n        crossOrigin: catalog.setCrossOriginAnonymous\r\n          ? 'anonymous'\r\n          : undefined,\r\n        layer: layer.Identifier,\r\n        matrixSet: catalog.matrixSet,\r\n        optionsFromCapabilities: true,\r\n        requestEncoding: catalog.requestEncoding || 'KVP',\r\n        style: 'default'\r\n      } as WMTSDataSourceOptions;\r\n      const sourceOptions = Object.assign(\r\n        {},\r\n        baseSourceOptions,\r\n        catalog.sourceOptions,\r\n        { params }\r\n      ) as WMTSDataSourceOptions;\r\n\r\n      return ObjectUtils.removeUndefined({\r\n        id: generateIdFromSourceOptions(sourceOptions),\r\n        type: CatalogItemType.Layer,\r\n        title: propertiesToForce?.title ? propertiesToForce.title : layer.Title,\r\n        address: catalog.id,\r\n        externalProvider: catalog.externalProvider,\r\n        options: {\r\n          sourceOptions,\r\n          metadata: {\r\n            url: metadataUrl,\r\n            extern,\r\n            abstract: metadataAbstract,\r\n            type: baseSourceOptions.type\r\n          }\r\n        }\r\n      } as CatalogItem);\r\n    })\r\n    .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n}\r\n\r\n/// ERSI\r\n\r\n  private getArcGISRESTItems(\r\n    catalog,\r\n    capabilities\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers =\r\n    !capabilities.layers ? [] : capabilities.layers.filter(layer => !layer.type || layer.type === 'Feature Layer');\r\n    if (!capabilities.layers) {\r\n      this.messageService.error(\r\n        'igo.geo.catalog.someUnavailable',\r\n        'igo.geo.catalog.unavailableTitle');\r\n    }\r\n\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    let abstract;\r\n    if (capabilities.serviceDescription && capabilities.serviceDescription.length) {\r\n      const regex = /(<([^>]+)>)/ig;\r\n      abstract = capabilities.serviceDescription.replace(regex, '');\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n\r\n        const propertiesToForce = this.computeForcedProperties(layer.name, catalog.forcedProperties);\r\n        let baseAbstract;\r\n        let extern = true;\r\n        if (layer.Abstract) {\r\n          baseAbstract = layer.Abstract;\r\n        } else if (!layer.Abstract && catalog.abstract) {\r\n          baseAbstract = catalog.abstract;\r\n        }\r\n\r\n        let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll;\r\n        let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || baseAbstract;\r\n\r\n        if (\r\n          !propertiesToForce?.metadataUrl &&\r\n          !propertiesToForce?.metadataUrlAll &&\r\n          (propertiesToForce?.metadataAbstract ||\r\n            propertiesToForce?.metadataAbstractAll)\r\n        ) {\r\n          extern = false;\r\n        }\r\n        if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n          extern = false;\r\n        }\r\n\r\n        if (this.testLayerRegexes(layer.id, regexes) === false) {\r\n          return undefined;\r\n        }\r\n        const baseSourceOptions = {\r\n          type: TypeCatalog[catalog.type],\r\n          url: catalog.url,\r\n          crossOrigin: catalog.setCrossOriginAnonymous\r\n            ? 'anonymous'\r\n            : undefined,\r\n          layer: layer.id as string,\r\n          queryable: true,\r\n          queryFormat: 'esrijson',\r\n          matrixSet: catalog.matrixSet,\r\n          optionsFromCapabilities: true,\r\n          style: 'default'\r\n        } as ArcGISRestDataSourceOptions;\r\n        const sourceOptions = Object.assign(\r\n          {},\r\n          baseSourceOptions,\r\n          catalog.sourceOptions\r\n        ) as ArcGISRestDataSourceOptions;\r\n        return ObjectUtils.removeUndefined({\r\n          id: generateIdFromSourceOptions(sourceOptions),\r\n          type: CatalogItemType.Layer,\r\n          title: propertiesToForce?.title ? propertiesToForce.title : layer.name,\r\n          externalProvider: catalog.externalProvider,\r\n          address: catalog.id,\r\n          options: {\r\n            sourceOptions,\r\n            minResolution: getResolutionFromScale(layer.maxScale),\r\n            maxResolution: getResolutionFromScale(layer.minScale),\r\n            metadata: {\r\n              url: metadataUrl,\r\n              extern,\r\n              abstract: metadataAbstract,\r\n              type: baseSourceOptions.type\r\n            },\r\n          }\r\n        } as CatalogItem);\r\n      })\r\n      .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n  }\r\n\r\n  private testLayerRegexes(layerName: string, regexes: RegExp[]): boolean {\r\n    if (regexes.length === 0) {\r\n      return true;\r\n    }\r\n    return regexes.find((regex: RegExp) => regex.test(layerName)) !== undefined;\r\n  }\r\n\r\n  private retrieveLayerInfoFormat(\r\n    layerNameFromCatalog: string,\r\n    layersQueryFormat: { layer: string; queryFormat: QueryFormat }[]\r\n  ): QueryFormat {\r\n    const currentLayerInfoFormat = layersQueryFormat.find(\r\n      (f) => f.layer === layerNameFromCatalog\r\n    );\r\n    const baseInfoFormat = layersQueryFormat.find((f) => f.layer === '*');\r\n    let queryFormat: QueryFormat;\r\n    if (currentLayerInfoFormat) {\r\n      queryFormat = currentLayerInfoFormat.queryFormat;\r\n    } else if (baseInfoFormat) {\r\n      queryFormat = baseInfoFormat.queryFormat;\r\n    }\r\n    return queryFormat;\r\n  }\r\n\r\n  private findCatalogInfoFormat(\r\n    catalog: Catalog\r\n  ): { layer: string; queryFormat: QueryFormat }[] {\r\n    const layersQueryFormat: { layer: string; queryFormat: QueryFormat }[] = [];\r\n    if (!catalog.queryFormat) {\r\n      return layersQueryFormat;\r\n    }\r\n    Object.keys(catalog.queryFormat).forEach((configuredInfoFormat) => {\r\n      if (catalog.queryFormat[configuredInfoFormat] instanceof Array) {\r\n        catalog.queryFormat[configuredInfoFormat].forEach((layerName) => {\r\n          if (\r\n            !layersQueryFormat.find((specific) => specific.layer === layerName)\r\n          ) {\r\n            layersQueryFormat.push({\r\n              layer: layerName,\r\n              queryFormat: configuredInfoFormat as QueryFormat\r\n            });\r\n          }\r\n        });\r\n      } else {\r\n        if (\r\n          !layersQueryFormat.find(\r\n            (specific) =>\r\n              specific.layer === catalog.queryFormat[configuredInfoFormat]\r\n          )\r\n        ) {\r\n          layersQueryFormat.push({\r\n            layer: catalog.queryFormat[configuredInfoFormat],\r\n            queryFormat: configuredInfoFormat as QueryFormat\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return layersQueryFormat;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <igo-catalog-browser-group\r\n        [catalog]=\"catalog\"\r\n        [group]=\"item\"\r\n        [map]=\"map\"\r\n        [state]=\"store.state\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [collapsed]=\"(store.count === 1) ? false : true\"\r\n        [toggleCollapsed]=\"toggleCollapsedGroup\"\r\n        (addedChange)=\"onGroupAddedChange($event)\"\r\n        (layerAddedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-group>\r\n    </ng-container>\r\n\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [map]=\"map\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"store.state.get(item).added\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { zip, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore, EntityStoreWatcher } from '@igo2/common';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  CatalogItemState,\r\n  CatalogItemType,\r\n  AddedChangeEmitter,\r\n  AddedChangeGroupEmitter\r\n} from '../shared';\r\n\r\n/**\r\n * Component to browse a catalog's groups and layers and display them on a map.\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser',\r\n  templateUrl: './catalog-browser.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Catalog items store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<CatalogItem>;\r\n\r\n // private resolution$$: Subscription;\r\n\r\n  get resolution$(): BehaviorSubject<number> { return this.map.viewController.resolution$; }\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Store holding the catalog's items\r\n   */\r\n  @Input() store: EntityStore<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether a group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsedGroup: boolean = true;\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    const currentItems = this.map.layers.map((layer: Layer) => {\r\n      return {\r\n        id: layer.options.source.id,\r\n        title: layer.title,\r\n        type: CatalogItemType.Layer\r\n      };\r\n    });\r\n    this.store.state.updateMany(currentItems, { added: true }, true);\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.catalog.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n      });\r\n    }\r\n\r\n    const catalogShowLegend = this.catalog ? this.catalog.showLegend : false;\r\n    this.catalogAllowLegend = catalogShowLegend ? catalogShowLegend : this.catalogAllowLegend;\r\n\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Layer added event\r\n   */\r\n  onLayerAddedChange(event: AddedChangeEmitter) {\r\n    const layer = event.layer;\r\n    this.store.state.update(layer, { added: event.added }, false);\r\n    event.added ? this.addLayerToMap(layer, event) : this.removeLayerFromMap(layer);\r\n  }\r\n\r\n  /**\r\n   * When a froup is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Group added event\r\n   */\r\n  onGroupAddedChange(event: AddedChangeGroupEmitter) {\r\n    const group = event.group;\r\n    this.store.state.update(group, { added: event.added }, false);\r\n    event.added ? this.addGroupToMap(group, event) : this.removeGroupFromMap(group);\r\n  }\r\n\r\n  /**\r\n   * Add layer to map\r\n   * @param layer Catalog layer\r\n   */\r\n  private addLayerToMap(layer: CatalogItemLayer, event?: AddedChangeEmitter) {\r\n    this.addLayersToMap([layer], event);\r\n  }\r\n\r\n  /**\r\n   * Remove layer from map\r\n   * @param layer Catalog layer\r\n   */\r\n  private removeLayerFromMap(layer: CatalogItemLayer) {\r\n    this.removeLayersFromMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add multiple layers to map\r\n   * @param layers Catalog layers\r\n   */\r\n  private addLayersToMap(layers: CatalogItemLayer[], event: AddedChangeEmitter | AddedChangeGroupEmitter) {\r\n    const layers$ = layers.map((layer: CatalogItemLayer) => {\r\n      if (!layer.options.sourceOptions.optionsFromApi) {\r\n        layer.options.sourceOptions.optionsFromApi = true;\r\n      }\r\n      if (this.catalog.profils?.length) {\r\n        layer.options.security = { profils: this.catalog.profils };\r\n      }\r\n      return this.layerService.createAsyncLayer(layer.options);\r\n    });\r\n    zip(...layers$).subscribe((layers: Layer[]) => {\r\n      if (event.event.type === 'click' && event.added) {\r\n        this.map.layersAddedByClick$.next(layers);\r\n      }\r\n      this.store.state.updateMany(layers, { added: true });\r\n      this.map.addLayers(layers);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove multiple layers from map\r\n   * @param layers Catalog layers\r\n   */\r\n  private removeLayersFromMap(layers: CatalogItemLayer[]) {\r\n    layers.forEach((layer: CatalogItemLayer) => {\r\n      this.store.state.update(layer, { added: false });\r\n      if (layer.options.baseLayer === true) {\r\n        const currLayer = this.map.getLayerById(layer.options.id);\r\n        if (currLayer !== undefined) {\r\n          this.map.removeLayer(currLayer);\r\n        }\r\n      } else {\r\n        const currLayer = this.map.getLayerById(layer.id);\r\n        if (currLayer !== undefined) {\r\n          this.map.removeLayer(currLayer);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sort the layers by title. asc or desc.\r\n   * @internal\r\n   */\r\n  private sortCatalogItemsByTitle(items: CatalogItem[], direction) {\r\n    const returnItem = items.sort((a, b) => {\r\n      const titleA = a.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      const titleB = b.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n      if (titleA < titleB) {\r\n        return -1;\r\n      }\r\n      if (titleA > titleB) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    switch (direction) {\r\n      case 'asc':\r\n        return returnItem;\r\n      case 'desc':\r\n        return returnItem.reverse();\r\n      default:\r\n        return items;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add all the layers of a group to map\r\n   * @param group Catalog group\r\n   */\r\n  private addGroupToMap(group: CatalogItemGroup, event: AddedChangeGroupEmitter) {\r\n    let layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === false;\r\n    });\r\n    if (group.sortDirection !== undefined) {\r\n      layers = this.sortCatalogItemsByTitle(layers, group.sortDirection);\r\n    }\r\n    this.addLayersToMap(layers.reverse() as CatalogItemLayer[], event);\r\n  }\r\n\r\n  /**\r\n   * Remove all the layers of a group from map\r\n   * @param group Catalog group\r\n   */\r\n  private removeGroupFromMap(group: CatalogItemGroup) {\r\n    const layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === true;\r\n    });\r\n    this.removeLayersFromMap(layers as CatalogItemLayer[]);\r\n  }\r\n}\r\n","<ng-container *ngIf=\"legendItems$ | async as items\">\r\n  <ng-container *ngIf=\"items.length; else noItems\">\r\n    <ng-container *ngFor=\"let item of items.slice().reverse()\" #renderedLegends>\r\n      <div *ngIf=\"getLegend; else noItems\">\r\n        <mat-list-item *ngIf=\"item.title\">\r\n          <mat-icon\r\n            id=\"legend-toggle\"\r\n            class=\"igo-chevron\"\r\n            mat-list-avatar\r\n            igoCollapse\r\n            [target]=\"legend\"\r\n            [collapsed]=\"(item.collapsed)\"\r\n            (toggle)=\"toggleLegendItem($event, item)\"\r\n            svgIcon=\"chevron-up\">\r\n          </mat-icon>\r\n          <h4 matLine>{{computeItemTitle(item) | async}} </h4>\r\n        </mat-list-item>\r\n        <div #legend class=\"igo-layer-legend\" [ngClass]=\"{'with-title': item.title}\">\r\n          <div *ngIf=\"currentStyle !== undefined\">\r\n              <mat-form-field>\r\n                <mat-select tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n                  [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" [(ngModel)]=\"currentStyle\"\r\n                  (selectionChange)=\"onChangeStyle()\">\r\n                  <mat-option *ngFor=\"let style of styles\" [value]=\"style.name\">{{style.title}}</mat-option>\r\n                </mat-select>\r\n            </mat-form-field>\r\n          </div>\r\n          <div *ngIf=\"!(item.collapsed)\">\r\n            <div *ngIf=\"item.url\">\r\n              <img igoImageError *ngIf=\"item.imgGraphValue\" hideError=\"true\" #renderedLegend id=\"{{item.title}}\" (load)=\"onLoadImage(item.title)\"\r\n                [src]=\"item.imgGraphValue\"\r\n                alt=\"{{'igo.geo.layer.legend.loadingLegendText' | translate}}\">\r\n              <small *ngIf=\"imagesHeight[item.title]<16\">\r\n                  {{'igo.geo.layer.legend.noLegendScale' | translate}}\r\n              </small>\r\n            </div>\r\n            <div\r\n              [ngStyle]=\"item.style\"\r\n              [innerHTML]=\"item.html | sanitizeHtml\"\r\n              *ngIf=\"item.html\">\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </ng-container>\r\n  </ng-container>\r\n\r\n  <ng-template #noItems>\r\n    <small>\r\n      {{'igo.geo.layer.legend.noLegendText' | translate}}\r\n    </small>\r\n  </ng-template>\r\n\r\n</ng-container>\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Component, Input, OnInit, OnDestroy, ChangeDetectionStrategy, ViewChildren, ElementRef, ChangeDetectorRef } from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, of, Observable } from 'rxjs';\r\n\r\nimport { Legend } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { Layer, ItemStyleOptions } from '../shared/layers';\r\nimport { LegendMapViewOptions } from '../shared/layers/layer.interface';\r\nimport { CapabilitiesService } from '../../datasource/shared/capabilities.service';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { LanguageService, ConfigService } from '@igo2/core';\r\nimport { WMSDataSource, WMSDataSourceOptions } from '../../datasource';\r\nimport { SecureImagePipe } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend',\r\n  templateUrl: './layer-legend.component.html',\r\n  styleUrls: ['./layer-legend.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendComponent implements OnInit, OnDestroy {\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  /**\r\n   * Observable of the legend items\r\n   */\r\n  legendItems$: BehaviorSubject<Legend[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Subscription to the map's resolution\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  /**\r\n   * The available styles\r\n   */\r\n  public styles;\r\n\r\n  /**\r\n   * The style used to make the legend\r\n   */\r\n  public currentStyle;\r\n\r\n  /**\r\n   * The scale used to make the legend\r\n   */\r\n  private scale: number = undefined;\r\n\r\n  /**\r\n   * The extent used to make the legend\r\n   */\r\n  private view: LegendMapViewOptions = undefined;\r\n  /**\r\n   * Get list of images display\r\n   */\r\n  @ViewChildren('renderedLegend') renderedLegends: QueryList<ElementRef>;\r\n\r\n  /**\r\n   * List of size of images displayed\r\n   */\r\n  public imagesHeight: { [srcKey: string]: number } = {};\r\n\r\n  /**\r\n   * Layer\r\n   */\r\n  @Input() layer: Layer;\r\n\r\n  /**\r\n   * if getLegendGraphic is authorized\r\n   */\r\n  public getLegend = true;\r\n\r\n  /**\r\n   * activeLegend\r\n   */\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * On init, subscribe to the map's resolution and update the legend accordingly\r\n   */\r\n  ngOnInit() {\r\n    let lastlLegend = this.layer.legend;\r\n    this.styles = this.listStyles();\r\n    const sourceOptions = this.layer.options.source.options as any;\r\n    if (sourceOptions && sourceOptions.params && sourceOptions.params.STYLES) {\r\n      // if a styles is provided into the layers wms params\r\n      this.currentStyle = this.styles.find(style => style.name === sourceOptions.params.STYLES).name;\r\n    } else if (!lastlLegend) {\r\n      // if no legend is manually provided\r\n      if (this.styles && this.styles.length > 1) {\r\n        this.currentStyle = this.styles[0].name;\r\n      }\r\n    } else if (this.styles && this.styles.length > 1) {\r\n      this.currentStyle = lastlLegend[0].currentStyle;\r\n    }\r\n    if (typeof this.layer.options.legendOptions !== 'undefined' && this.layer.options.legendOptions.display === false) {\r\n      lastlLegend = [];\r\n    } else {\r\n      lastlLegend = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    }\r\n\r\n    if (this.updateLegendOnResolutionChange || (sourceOptions as WMSDataSourceOptions).contentDependentLegend) {\r\n      const state$ = this.layer.map.viewController.state$;\r\n      this.state$$ = state$.subscribe(() => this.onViewControllerStateChange());\r\n    } else if (lastlLegend && lastlLegend.length !== 0) {\r\n      this.legendItems$.next(lastlLegend);\r\n      for (const legend of lastlLegend) {\r\n        this.getLegendGraphic(legend);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On destroy, unsubscribe to the map's view state\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  getLegendGraphic(item: Legend) {\r\n    if (item.url) {\r\n      const secureIMG = new SecureImagePipe(this.http, this.configService);\r\n      secureIMG.transform(item.url).pipe(\r\n        catchError((err) => {\r\n          if (err.error) {\r\n            err.error.caught = true;\r\n            this.getLegend = false;\r\n            this.cdRef.detectChanges();\r\n            return err;\r\n          }\r\n        })\r\n        ).subscribe(obsLegGraph => {\r\n          const idx = this.legendItems$.value.findIndex(leg => leg.title === item.title);\r\n          const legendGraph = obsLegGraph as string;\r\n          this.legendItems$.value[idx].imgGraphValue = legendGraph;\r\n          this.cdRef.detectChanges();\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  toggleLegendItem(collapsed: boolean, item: Legend) {\r\n    item.collapsed = collapsed;\r\n  }\r\n\r\n  private transfertToggleLegendItem(newLegends: Legend[]): Legend[] {\r\n    const outLegends: Legend[] = newLegends;\r\n    const lastLegends = this.layer.legend;\r\n    for (let i = 0; i < lastLegends.length; i++) {\r\n      outLegends[i].collapsed = lastLegends[i].collapsed;\r\n   }\r\n    return outLegends;\r\n  }\r\n\r\n  computeItemTitle(layerLegend): Observable<string> {\r\n    const layerOptions = this.layer.dataSource.options as any;\r\n    if (layerOptions.type !== 'wms') {\r\n      return of(layerLegend.title);\r\n    }\r\n\r\n    const layers = layerOptions.params.LAYERS.split(',');\r\n    const localLayerOptions = JSON.parse(JSON.stringify(layerOptions)); // to avoid to alter the original options.\r\n    localLayerOptions.params.LAYERS = layers.find(layer => layer === layerLegend.title);\r\n    return this.capabilitiesService\r\n      .getWMSOptions(localLayerOptions)\r\n      .pipe(map(wmsDataSourceOptions => {\r\n        return wmsDataSourceOptions._layerOptionsFromSource.title;\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * On resolution change, compute the effective scale level and update the\r\n   * legend accordingly.\r\n   * @param resolution Map resolution\r\n   */\r\n  private onViewControllerStateChange() {\r\n    this.view = {\r\n      resolution: this.layer.map.viewController.getResolution(),\r\n      extent: this.layer.map.viewController.getExtent(),\r\n      projection: this.layer.map.viewController.getOlProjection().getCode(),\r\n      scale: this.layer.map.viewController.getScale(),\r\n      size: this.layer.map.ol.getSize()\r\n    } as LegendMapViewOptions;\r\n    this.updateLegend();\r\n  }\r\n\r\n  /**\r\n   * Update the legend with scale level and style define\r\n   */\r\n  private updateLegend() {\r\n    let legendItems = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    if (this.layer.legend && this.layer.legend.length > 1) { legendItems = this.transfertToggleLegendItem(legendItems); }\r\n    this.layer.legend = legendItems;\r\n\r\n    if (legendItems.length === 0 && this.legendItems$.value.length === 0) {\r\n      return;\r\n    }\r\n    this.legendItems$.next(legendItems);\r\n    for (const legend of this.legendItems$.value) {\r\n      this.getLegendGraphic(legend);\r\n    }\r\n  }\r\n\r\n  private listStyles() {\r\n    const layerOptions = this.layer.options;\r\n    if (layerOptions && layerOptions.legendOptions) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.layer.legend.default');\r\n      let stylesAvailable = [{ name: '', title } as ItemStyleOptions];\r\n      if (layerOptions.legendOptions.stylesAvailable) {\r\n        stylesAvailable = stylesAvailable.concat(layerOptions.legendOptions.stylesAvailable.filter(sA => (\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'default' &&\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'defaut')));\r\n      }\r\n      stylesAvailable.filter(sa => !sa.title).map((sa) => sa.title = sa.name);\r\n      stylesAvailable.map(s => s.title = s.title.charAt(0).toUpperCase() + s.title.slice(1).replace(/_/g, ' '));\r\n      return stylesAvailable;\r\n    }\r\n    return ;\r\n  }\r\n\r\n  onChangeStyle() {\r\n    this.updateLegend();\r\n    let STYLES = '';\r\n    if (this.layer.dataSource instanceof WMSDataSource) {\r\n      this.layer.dataSource.ol.getParams().LAYERS.split(',').map(layer =>\r\n        STYLES += this.currentStyle + ','\r\n      );\r\n      STYLES = STYLES.slice(0, -1);\r\n      this.layer.dataSource.ol.updateParams({ STYLES });\r\n    }\r\n  }\r\n\r\n  onLoadImage(id: string) {\r\n    let elemRef: HTMLImageElement;\r\n    if (this.renderedLegends.length === 1) {\r\n      elemRef = this.renderedLegends.first.nativeElement as HTMLImageElement;\r\n    } else {\r\n      elemRef = this.renderedLegends.find(renderedLegend => renderedLegend.nativeElement.id === id).nativeElement as HTMLImageElement;\r\n    }\r\n    this.imagesHeight[id] = elemRef.height;\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"haveGroup()\" mat-list-avatar svgIcon=\"blank\"></mat-icon>\r\n  <h4 mat-line matTooltipShowDelay=\"500\" [ngClass]=\"(catalogAllowLegend)?'igo-cataloglayer-title':''\" (click)=\"askForLegend($event)\" [matTooltip]=\"computeTitleTooltip()\">{{title}}</h4>\r\n\r\n    <button *ngIf=\"layer.externalProvider\"\r\n      disabled=\"true\"\r\n      mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloglayer-external-icon\"\r\n      *ngIf=\"layer.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.layer' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n  <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n\r\n  <button\r\n    (mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"computeTooltip() | translate\"\r\n    [color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n    (click)=\"onToggleClick($event)\">\r\n    <mat-icon\r\n       matBadge=\"icon\"\r\n       [igoMatBadgeIcon]=\"getBadgeIcon()\"\r\n       igoMatBadgeColor=\"rgba(0,0,0,0.87)\"\r\n       igoMatBadgeBackgroundColor=\"none\"\r\n       igoMatBadgeInverseColor=\"true\"\r\n       [matBadgeHidden]=\"((inRange$ | async) && (isVisible$ | async) === true) || ((inRange$ | async) && !added) || ((inRange$ | async) && (isPreview$ | async))\"\r\n       [matBadgeDisabled]=\"(inRange$ | async) === false\"\r\n       matBadgeSize=\"small\"\r\n       matBadgePosition=\"after\"\r\n       [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-cataloglayer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"(layerLegendShown$ | async) && (igoLayer$ | async) && catalogAllowLegend\"\r\n    [layer]=\"igoLayer$ | async\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\n\r\nimport { AddedChangeEmitter, CatalogItemLayer } from '../shared';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { first } from 'rxjs/operators';\r\nimport { Layer, TooltipType } from '../../layer/shared/layers';\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Catalog browser layer item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-layer',\r\n  templateUrl: './catalog-browser-layer.component.html',\r\n  styleUrls: ['./catalog-browser-layer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserLayerComponent implements OnInit, OnDestroy {\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public isVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private isPreview$$: Subscription;\r\n  private resolution$$: Subscription;\r\n  private layers$$: Subscription;\r\n  private lastTimeoutRequest;\r\n\r\n  public layerLegendShown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public igoLayer$ = new BehaviorSubject<Layer>(undefined);\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog layer\r\n   */\r\n  @Input() layer: CatalogItemLayer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added = false;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<AddedChangeEmitter>();\r\n\r\n  @Output() addedLayerIsPreview = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.layer);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.layer) || 'layers';\r\n  }\r\n\r\n  constructor(private layerService: LayerService ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.isPreview$$ = this.isPreview$.subscribe(value => this.addedLayerIsPreview.emit(value));\r\n\r\n    this.layers$$ = this.map.layers$.subscribe(() => {\r\n      this.isVisible();\r\n    });\r\n\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe((resolution) => {\r\n      this.isInResolutionsRange(resolution);\r\n      this.isVisible();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.isPreview$$.unsubscribe();\r\n    this.resolution$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  computeTitleTooltip(): string {\r\n      const layerOptions = this.layer.options;\r\n      if (!layerOptions.tooltip) {\r\n        return getEntityTitle(this.layer);\r\n      }\r\n      const layerTooltip = layerOptions.tooltip;\r\n      const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n      switch (layerOptions.tooltip.type) {\r\n        case TooltipType.TITLE:\r\n          return this.layer.title;\r\n        case TooltipType.ABSTRACT:\r\n          if (layerMetadata && layerMetadata.abstract) {\r\n            return layerMetadata.abstract;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        case TooltipType.CUSTOM:\r\n          if (layerTooltip && layerTooltip.text) {\r\n            return layerTooltip.text;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        default:\r\n          return this.layer.title;\r\n      }\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  askForLegend(event) {\r\n    this.layerLegendShown$.next(!this.layerLegendShown$.value);\r\n    this.layerService.createAsyncLayer(this.layer.options).pipe(first())\r\n    .subscribe(layer => this.igoLayer$.next(layer));\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove(event);\r\n          } else {\r\n            this.add(event);\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add(event);\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove(event);\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add(event: Event) {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addedChange.emit({ added: true, layer: this.layer, event });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private remove(event: Event) {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.addedChange.emit({ added: false, layer: this.layer, event });\r\n    }\r\n  }\r\n\r\n  haveGroup(): boolean {\r\n    return !(!this.layer.address || this.layer.address.split('.').length === 1);\r\n  }\r\n\r\n  isInResolutionsRange(resolution: number) {\r\n    const minResolution = (!this.layer.options.minResolution || Number.isNaN(this.layer.options.minResolution))\r\n      ? 0 : this.layer.options.minResolution;\r\n    const maxResolution = (!this.layer.options.maxResolution || Number.isNaN(this.layer.options.maxResolution))\r\n    ? Infinity : this.layer.options.maxResolution;\r\n    this.inRange$.next(\r\n      resolution >= minResolution && resolution <= maxResolution\r\n    );\r\n  }\r\n\r\n  isVisible() {\r\n    if (this.layer?.id) {\r\n      const oLayer = this.map.getLayerById(this.layer?.id);\r\n      oLayer ? this.isVisible$.next(oLayer.visible) : this.isVisible$.next(false);\r\n    }\r\n  }\r\n\r\n  getBadgeIcon() {\r\n    if (this.inRange$.getValue()) {\r\n      return this.isVisible$.getValue() ? '' : 'eye-off';\r\n    } else {\r\n      return 'eye-off';\r\n    }\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      if (this.isPreview$.value) {\r\n        return 'igo.geo.catalog.layer.addToMap';\r\n      } else if (this.inRange$.value) {\r\n        return this.isVisible$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapNotVisible';\r\n      } else {\r\n        return 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n      }\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    mat-list-avatar\r\n    svgIcon=\"chevron-up\"\r\n    igoCollapse\r\n    class=\"igo-chevron\"\r\n    [target]=\"items\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"onToggleCollapsed($event)\">\r\n  </mat-icon>\r\n\r\n  <h4 class=\"igo-catalog-group-title\" id=\"catalog-group-title\" mat-line matTooltipShowDelay=\"500\" [matTooltip]=\"title\" (click)=\"onTitleClick()\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"group.externalProvider\"\r\n    disabled=\"true\"\r\n    mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloggroup-external-icon\"\r\n      *ngIf=\"group.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.group' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <ng-container *ngIf=\"(added$ | async) && (preview$ | async) === false; else notadded\">\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.removeFromMap' | translate\"\r\n      color=\"warn\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick($event)\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n  </ng-container>\r\n\r\n  <ng-template #notadded>\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.addToMap' | translate\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick($event)\">\r\n      <mat-icon svgIcon=\"plus\"></mat-icon>\r\n    </button>\r\n  </ng-template>\r\n</mat-list-item>\r\n\r\n<div #items>\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <!-- todo: add display ans manage CatalogItemGroup -->\r\n    </ng-container>\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution\"\r\n        [map]=\"map\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"state.get(item).added\"\r\n        (addedLayerIsPreview)=\"onLayerPreview($event)\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport type { EntityStateManager } from '@igo2/common';\r\n\r\nimport {\r\n  AddedChangeEmitter,\r\n  AddedChangeGroupEmitter,\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemGroup,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Catalog browser group item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-group',\r\n  templateUrl: './catalog-browser-group.component.html',\r\n  styleUrls: ['./catalog-browser-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserGroupComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Group's items store\r\n   * @internal\r\n   */\r\n  store = new EntityStore<CatalogItem, CatalogItemState>([]);\r\n\r\n  /**\r\n   * Whether all the layers of the group are added\r\n   * @internal\r\n   */\r\n  added$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  preview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Whether the toggle button is disabled\r\n   * @internal\r\n   */\r\n  disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Catalog group\r\n   */\r\n  @Input() group: CatalogItemGroup;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether the group is collapsed\r\n   */\r\n  @Input() collapsed: boolean = true;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Whether the group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsed: boolean = true;\r\n\r\n  /**\r\n   * Parent catalog's items store state. Groups share a unique\r\n   * EntityState that tracks the group and it's layers state (whether they are added or not).\r\n   * Sharing a unique state would also allow us to expand this component to allow\r\n   * the selection of a layer while unselecting any layer already selected in another group.\r\n   * This could be useful to display some layer info before adding it, for example.\r\n   */\r\n  @Input() state: EntityStateManager<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of the group is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<AddedChangeGroupEmitter>();\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of a layer is clicked\r\n   */\r\n  @Output() layerAddedChange = new EventEmitter<AddedChangeEmitter>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return this.group.title;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.load(this.group.items);\r\n    this.evaluateAdded();\r\n    this.evaluateDisabled(this.collapsed);\r\n    if (this.group.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.group.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event: Event) {\r\n    this.added$.value ? this.remove(event) : this.add(event);\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleCollapsed(collapsed: boolean) {\r\n    this.evaluateDisabled(collapsed);\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, evaluate if all the layers of the group\r\n   * are now added or removed. If so, consider that the group itself is added\r\n   * or removed.\r\n   * @internal\r\n   * @param event Layer added change event\r\n   */\r\n  onLayerAddedChange(event: AddedChangeEmitter) {\r\n    this.layerAddedChange.emit(event);\r\n    this.tryToggleGroup(event);\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add(event: Event) {\r\n    this.added$.next(true);\r\n    this.addedChange.emit({\r\n      added: true,\r\n      group: this.group,\r\n      event\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private remove(event: Event) {\r\n    this.added$.next(false);\r\n    this.addedChange.emit({\r\n      added: false,\r\n      group: this.group,\r\n      event\r\n    });\r\n  }\r\n\r\n  onLayerPreview(event) {\r\n    this.preview$.next(event);\r\n  }\r\n\r\n  /**\r\n   * If all the layers of the group added or removed, add or remove the group itself.\r\n   * @param event The last layer added change event to occur\r\n   */\r\n  private tryToggleGroup(event: AddedChangeEmitter) {\r\n    const added = event.added;\r\n    const layer = event.layer;\r\n\r\n    const layersAdded = this.store.view\r\n      .all()\r\n      .filter((item: CatalogItem) => item.id !== layer.id)\r\n      .map((item: CatalogItem) => this.state.get(item).added || false);\r\n\r\n    if (layersAdded.every(value => value === added)) {\r\n      added ? this.add(event.event) : this.remove(event.event);\r\n    } else if (this.added$.value === true) {\r\n      this.added$.next(false);\r\n    }\r\n  }\r\n\r\n  private evaluateAdded() {\r\n    const added = this.store.all().every((item: CatalogItem) => {\r\n      return (this.state.get(item).added || false) === true;\r\n    });\r\n    this.added$.next(added);\r\n  }\r\n\r\n  private evaluateDisabled(collapsed: boolean) {\r\n    let disabled = false;\r\n    if (this.toggleCollapsed === false) {\r\n      disabled = collapsed;\r\n    }\r\n    this.disabled$.next(disabled);\r\n  }\r\n\r\n  onTitleClick() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerListToolService {\r\n  public keyword: string;\r\n  public sortAlpha = false;\r\n  public onlyVisible = false;\r\n  public onlyInRange = false;\r\n  public keywordInitialized = false;\r\n  public sortedAlphaInitialized = false;\r\n  public onlyVisibleInitialized = false;\r\n  public onlyInRangeInitialized = false;\r\n\r\n  constructor() {}\r\n\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <mat-checkbox *ngIf=\"selectionMode\"\r\n    class=\"layerCheck\"\r\n    mat-list-icon\r\n    (change)=\"check()\"\r\n    [checked]=\"layerCheck\">\r\n  </mat-checkbox>\r\n  <h4 (click)=\"toggleLegendOnClick()\" matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"eyeTooltip | translate\"\r\n    (click)=\"toggleVisibility()\">\r\n    <mat-icon\r\n      matBadge=\"?\"\r\n      matBadgeColor=\"accent\"\r\n      matBadgeSize=\"small\"\r\n      matBadgePosition=\"after\"\r\n      [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"(layer.visible$ | async) ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <button *ngIf=\"selectionMode\" class=\"selection-eye\"\r\n  mat-icon-button\r\n  [color]=\"layer.visible ? 'primary' : 'default'\"\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"layer.visible ?\r\n                ('igo.geo.layer.hideLayer' | translate) :\r\n                ('igo.geo.layer.showLayer' | translate)\"\r\n  (click)=\"toggleVisibility()\">\r\n  <mat-icon\r\n    matBadge=\"?\"\r\n    matBadgeColor=\"accent\"\r\n    matBadgeSize=\"small\"\r\n    matBadgePosition=\"after\"\r\n    [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n    [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n    [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n  </mat-icon>\r\n</button>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    class=\"actions-button\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]= \"'igo.geo.layer.moreOptions' | translate\"\r\n    mat-icon-button\r\n    color=\"primary\"\r\n    (click)=\"toggleLayerTool()\">\r\n    <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n  </button>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"showLegend$ | async\"\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  Renderer2,\r\n  ElementRef,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { layerIsQueryable } from '../../query/shared/query.utils';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-item',\r\n  templateUrl: './layer-item.component.html',\r\n  styleUrls: ['./layer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerItemComponent implements OnInit, OnDestroy {\r\n  public focusedCls = 'igo-layer-item-focused';\r\n\r\n  @Input()\r\n  get activeLayer() {\r\n    return this._activeLayer;\r\n  }\r\n  set activeLayer(value) {\r\n    if (value && this.layer && value.id === this.layer.id && !this.selectionMode) {\r\n      this.layerTool$.next(true);\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n  }\r\n  private _activeLayer;\r\n\r\n  layerTool$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  queryBadgeHidden$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  @Input()\r\n  get selectAll() {\r\n    return this._selectAll;\r\n  }\r\n  set selectAll(value: boolean) {\r\n    this._selectAll = value;\r\n    if (value === true) {\r\n      this.layerCheck = true;\r\n    }\r\n  }\r\n  private _selectAll = false;\r\n\r\n  @Input() layerCheck;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  layers$: BehaviorSubject<Layer> = new BehaviorSubject<Layer>(undefined);\r\n\r\n  @Input()\r\n  get layer() {\r\n    return this._layer;\r\n  }\r\n  set layer(value) {\r\n    this._layer = value;\r\n    this.layers$.next(value);\r\n  }\r\n  private _layer;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendIfVisible: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() orderable: boolean = true;\r\n\r\n  @Input() lowerDisabled: boolean = false;\r\n\r\n  @Input() raiseDisabled: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Input() selectionMode;\r\n\r\n  @Input() changeDetection;\r\n\r\n  get opacity() {\r\n    return this.layer.opacity * 100;\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.layer.opacity = opacity / 100;\r\n  }\r\n\r\n  get eyeTooltip() {\r\n    if (this.inResolutionRange$.getValue() === false) {\r\n      return 'igo.geo.layer.notInResolution';\r\n    } else {\r\n      return this.layer.visible ? 'igo.geo.layer.hideLayer' : 'igo.geo.layer.showLayer';\r\n    }\r\n  }\r\n\r\n  @Output() action: EventEmitter<Layer> = new EventEmitter<Layer>(undefined);\r\n  @Output() checkbox = new EventEmitter<{\r\n    layer: Layer;\r\n    check: boolean;\r\n  }>();\r\n\r\n  constructor(\r\n    private networkService: NetworkService,\r\n    private renderer: Renderer2,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  ngOnInit() {\r\n    if (\r\n      this.layer.visible &&\r\n      this.expandLegendIfVisible &&\r\n      this.layer.firstLoadComponent === true\r\n    ) {\r\n      this.layer.firstLoadComponent = false;\r\n      this.layer.legendCollapsed = false;\r\n    }\r\n    this.toggleLegend(this.layer.legendCollapsed);\r\n    this.updateQueryBadge();\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layer && this.layer.options.active) {\r\n        this.layerTool$.next(true);\r\n        this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n      }\r\n    });\r\n\r\n    if (this.changeDetection) {\r\n      this.changeDetection.subscribe(() => this.cdRef.detectChanges());\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    this.toggleLegend(this.showLegend$.value);\r\n  }\r\n\r\n  toggleVisibility() {\r\n    this.layer.visible = !this.layer.visible;\r\n    if (this.toggleLegendOnVisibilityChange) {\r\n      this.toggleLegend(!this.layer.visible);\r\n    }\r\n    this.updateQueryBadge();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    if (\r\n      inResolutionRange === false &&\r\n      this.updateLegendOnResolutionChange === true\r\n    ) {\r\n      this.toggleLegend(true);\r\n    }\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n\r\n  private updateQueryBadge() {\r\n    const hidden =\r\n      this.queryBadge === false ||\r\n      this.layer.visible === false ||\r\n      !layerIsQueryable(this.layer);\r\n    this.queryBadgeHidden$.next(hidden);\r\n  }\r\n\r\n  toggleLayerTool() {\r\n    this.layerTool$.next(!this.layerTool$.getValue());\r\n    if (this.layerTool$.getValue() === true) {\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n    this.action.emit(this.layer);\r\n  }\r\n\r\n  public check() {\r\n    this.layerCheck = !this.layerCheck;\r\n    this.checkbox.emit({layer: this.layer, check: this.layerCheck});\r\n  }\r\n}\r\n","export enum LayerListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\nexport enum LayerListSelectVisibleEnum {\r\n  ALL_VISIBLE = 'ALL_VISIBLE',\r\n  ALL_HIDDEN = 'ALL_HIDDEN',\r\n  MIXED = 'MIXED',\r\n  NULL = 'NULL'\r\n}\r\n\r\nexport enum LayerListDisplacement {\r\n  Raise = 'raise',\r\n  Lower = 'lower',\r\n}\r\n","<mat-list>\r\n  <igo-layer-list-tool *ngIf=\"showToolbar$ | async\"\r\n    floatLabel=\"auto\"\r\n    [layersAreAllVisible]=\"layersAreAllVisible\"\r\n    [term]=\"layerFilterAndSortOptions.keyword\"\r\n    [onlyVisible]=\"layerFilterAndSortOptions.onlyVisible\"\r\n    [sortAlpha]=\"layerFilterAndSortOptions.sortAlpha\"\r\n    (appliedFilterAndSort)=\"onAppliedFilterAndSortChange($event)\"\r\n    (selection)=\"toggleSelectionMode($event)\">\r\n  </igo-layer-list-tool>\r\n</mat-list>\r\n\r\n<mat-list-item *ngIf=\"selection\" class=\"select-all\">\r\n  <mat-checkbox\r\n    class=\"select-all-checkbox mat-subheading-2\"\r\n    [color]=\"!selectAllCheck && layersChecked.length > 0 ? 'accent' : 'primary'\"\r\n    (change)=\"selectAll()\"\r\n    [checked]=\"selectAllCheck\"\r\n    [indeterminate]=\"!selectAllCheck && layersChecked.length > 0\"> {{selectAllCheck ? ('igo.geo.layer.deselectAll' | translate) : ('igo.geo.layer.selectAll' | translate)}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n<mat-divider></mat-divider>\r\n\r\n<igo-list #igoList [ngClass]=\"{'igo-list-tools-multi': selection, 'igo-list-tools-single': (layerTool && !selection), 'igo-list-no-tools': (!layerTool && !selection)}\" [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n    <igo-layer-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n      igoListItem\r\n      [layer]=\"layer\"\r\n      [activeLayer]=\"activeLayer\"\r\n      [orderable]=\"orderable && !layer.baseLayer\"\r\n      [lowerDisabled]=\"getLowerLayer().id === layer.id\"\r\n      [raiseDisabled]=\"getUpperLayer().id === layer.id\"\r\n      [queryBadge]=\"queryBadge\"\r\n      [expandLegendIfVisible]=\"expandLegendOfVisibleLayers\"\r\n      [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\"\r\n      [toggleLegendOnVisibilityChange]=\"toggleLegendOnVisibilityChange\"\r\n      [selectionMode]=\"selection\"\r\n      [selectAll]=\"selectAllCheck\"\r\n      [layerCheck]=\"layer.options.check\"\r\n      [changeDetection]=\"layerItemChangeDetection$\"\r\n      (action)=\"toggleLayerTool($event)\"\r\n      (checkbox)=\"layersCheck($event)\">\r\n    </igo-layer-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<igo-panel *ngIf=\"!selection && layerTool && activeLayer\" class=\"igo-layer-actions-container\" [title]=\"activeLayer.title\">\r\n  <div class=\"igo-layer-button-group\">\r\n    <button\r\n      *ngIf=\"isLayerRemovable(activeLayer)\"\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.removeLayer' | translate\"\r\n      (click)=\"removeLayers()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Lower, true)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabled\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Raise, true)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabled\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <!-- <label>{{ 'igo.geo.layer.opacity' | translate }} </label> -->\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon [matBadge]=\"badgeOpacity\" matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\" class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [value]=\"opacity\"\r\n          (input)=\"changeOpacity($event)\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          (click) = \"$event.stopPropagation()\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n      *ngIf=\"activeLayerExtentIsValid(activeLayer)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayer' | translate\"\r\n      (click)=\"zoomLayerExtents(activeLayer)\">\r\n      <mat-icon matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n\r\n    <ng-container igoLayerItemToolbar\r\n      [ngTemplateOutlet]=\"templateLayerToolbar\"\r\n      [ngTemplateOutletContext]=\"{layer: activeLayer}\">\r\n    </ng-container>\r\n\r\n    <ng-content select=\"[igoLayerItemToolbar]\"></ng-content>\r\n  </div>\r\n</igo-panel>\r\n\r\n<igo-panel *ngIf=\"selection && layers.length > 0\" class=\"igo-layer-actions-container\" [title]=\"'igo.geo.layer.tools' | translate\">\r\n  <div class=\"actions-buttons-multi\">\r\n    <button\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"isAllLayersRemovable(layersChecked) ? ('igo.geo.layer.removeSelectedLayers' | translate) : 'igo.geo.layer.removeSelectedLayersRestriction' | translate\"\r\n      (click)=\"removeLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"'!'\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"isAllLayersRemovable(layersChecked)\"\r\n                svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"eye-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"statusSelectedLayersCheck === 'ALL_HIDDEN' ? ('igo.geo.layer.showSelectedLayers' | translate) : ('igo.geo.layer.hideSelectedLayers' | translate)\"\r\n      (click)=\"toggleVisibility(layersChecked)\">\r\n      <mat-icon\t[svgIcon]=\"(statusSelectedLayersCheck === 'ALL_HIDDEN') ? 'eye-off' : 'eye'\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabledSelection\"\r\n      (click)=\"lowerLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabledSelection\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabledSelection\"\r\n      (click)=\"raiseLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabledSelection\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\"  class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider *ngIf=\"layersChecked.length\"\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [(ngModel)]=\"checkOpacity\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\"\r\n          (click) = \"$event.stopPropagation()\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n    *ngIf=\"layersChecked.length !== 0 && activeLayersExtentAreValid(layersChecked)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayers' | translate\"\r\n      (click)=\"zoomLayersExtents(layersChecked)\">\r\n      <mat-icon svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n  </div>\r\n</igo-panel>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ContentChild,\r\n  OnInit,\r\n  OnDestroy,\r\n  Output,\r\n  EventEmitter,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport scrollIntoView from 'scroll-into-view-if-needed';\r\n\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { LayerListControlsEnum, LayerListDisplacement } from './layer-list.enum';\r\nimport { LayerListSelectVisibleEnum } from './layer-list.enum';\r\nimport {\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  Subscription,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../../metadata/shared/metadata.interface';\r\nimport { LayerListControlsOptions } from '../layer-list-tool/layer-list-tool.interface';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { LinkedProperties } from '../shared/layers/layer.interface';\r\nimport { MatSliderChange } from '@angular/material/slider';\r\nimport * as olextent from 'ol/extent';\r\nimport { getAllChildLayersByProperty, getRootParentByProperty } from '../../map/shared/linkedLayers.utils';\r\n\r\n// TODO: This class could use a clean up. Also, some methods could be moved ealsewhere\r\n@Component({\r\n  selector: 'igo-layer-list',\r\n  templateUrl: './layer-list.component.html',\r\n  styleUrls: ['./layer-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n  thresholdToFilterAndSort = 5;\r\n\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  showToolbar$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public layerTool: boolean;\r\n\r\n  public hideSelectedLayers: boolean = true;\r\n  activeLayer$: BehaviorSubject<Layer> = new BehaviorSubject(undefined);\r\n\r\n  layersChecked: Layer[] = [];\r\n  public selection: boolean;\r\n\r\n  private change$$: Subscription;\r\n  private layers$$: Subscription;\r\n  public layerItemChangeDetection$ = new BehaviorSubject(undefined);\r\n\r\n  @ContentChild('igoLayerItemToolbar', /* TODO: add static flag */ {})\r\n  templateLayerToolbar: TemplateRef<any>;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() ogcButton: boolean = true;\r\n\r\n  @Input() timeButton: boolean = true;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = this.removeProblemLayerInList(value);\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n\r\n  set activeLayer(value: Layer) {\r\n    this._activeLayer = value;\r\n    this.activeLayer$.next(value);\r\n  }\r\n  get activeLayer(): Layer {\r\n    return this._activeLayer;\r\n  }\r\n  private _activeLayer: Layer;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input() layerFilterAndSortOptions: LayerListControlsOptions = {};\r\n\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendOfVisibleLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n\r\n  get keyword(): string {\r\n    return this._keyword;\r\n  }\r\n  set keyword(value: string) {\r\n    this._keyword = value;\r\n    this.next();\r\n  }\r\n  private _keyword = undefined;\r\n\r\n  get onlyVisible(): boolean {\r\n    return this._onlyVisible;\r\n  }\r\n  set onlyVisible(value: boolean) {\r\n    this._onlyVisible = value;\r\n    this.next();\r\n  }\r\n  private _onlyVisible = false;\r\n\r\n  get sortAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha = false;\r\n\r\n  get opacity() {\r\n    return Math.round(this.activeLayer$.getValue().opacity * 100);\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.activeLayer$.getValue().opacity = opacity / 100;\r\n  }\r\n\r\n  get badgeOpacity() {\r\n    if (this.opacity === 100) {\r\n      return;\r\n    }\r\n    return this.opacity;\r\n  }\r\n\r\n  get raiseDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getUpperLayer().id === this.activeLayer.id ||\r\n      this.isUpperBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getLowerLayer().id === this.activeLayer.id ||\r\n      this.isLowerBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get raiseDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.raisableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.lowerableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get checkOpacity() {\r\n    return this.layersCheckedOpacity() * 100;\r\n  }\r\n  set checkOpacity(opacity: number) {\r\n    for (const layer of this.layersChecked) {\r\n      layer.opacity = opacity / 100;\r\n    }\r\n  }\r\n\r\n  get layerListDisplacement(): typeof LayerListDisplacement {\r\n    return LayerListDisplacement;\r\n  }\r\n\r\n  public toggleOpacity = false;\r\n\r\n  public selectAllCheck: boolean;\r\n  public selectAllCheck$ = new BehaviorSubject<boolean>(undefined);\r\n  private selectAllCheck$$: Subscription;\r\n\r\n  constructor(private elRef: ElementRef) { }\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.layers.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.showToolbar$.next(this.computeShowToolbar());\r\n        this.layers$.next(this.computeLayers(this.layers.slice(0)));\r\n        this.appliedFilterAndSort.emit({\r\n          keyword: this.keyword,\r\n          sortAlpha: this.sortAlpha,\r\n          onlyVisible: this.onlyVisible\r\n        });\r\n      });\r\n\r\n    this.selectAllCheck$$ = this.selectAllCheck$.subscribe((value) => {\r\n      this.selectAllCheck = value;\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layers) {\r\n        let checks = 0;\r\n        for (const layer of this.layers) {\r\n          layer.status$.subscribe(valStatus => {\r\n            if (valStatus === 0) {\r\n              this.map.removeLayer(layer);\r\n            }\r\n          });\r\n          if (layer.options.active) {\r\n            this.activeLayer = layer;\r\n            this.layerTool = true;\r\n          }\r\n          if (layer.options.check) {\r\n            checks += 1;\r\n          }\r\n        }\r\n        if (this.excludeBaseLayers) {\r\n          this.selectAllCheck =\r\n            checks ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n              ? true\r\n              : false;\r\n        } else {\r\n          this.selectAllCheck =\r\n            checks === this.layers.filter((lay) => lay.showInLayerList).length\r\n              ? true\r\n              : false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n    this.selectAllCheck$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  activeLayerExtentIsValid(layer: Layer): boolean {\r\n    let valid = false;\r\n    if (layer.options.showButtonZoomToExtent === false) {\r\n      return false;\r\n    }\r\n    const layerExtent = layer.options.extent;\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    if (layerExtent) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = olextent.containsExtent(maxLayerZoomExtent, layerExtent);\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  activeLayersExtentAreValid(layers: Layer[]): boolean {\r\n    let valid = false;\r\n    const layersExtent = olextent.createEmpty();\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent && !layerExtent.includes(Infinity)) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n\r\n    if (!olextent.isEmpty(layersExtent)) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = (olextent.containsExtent(maxLayerZoomExtent, layersExtent));\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  zoomLayerExtents(layer: Layer) {\r\n    this.map.viewController.zoomToExtent(layer.options.extent);\r\n  }\r\n\r\n  zoomLayersExtents(layers: Layer[]) {\r\n    const layersExtent = olextent.createEmpty() as [number, number, number, number];\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n    this.map.viewController.zoomToExtent(layersExtent);\r\n  }\r\n\r\n  changeOpacity(event: MatSliderChange ){\r\n    this.opacity = event.value;\r\n  }\r\n\r\n  clearKeyword() {\r\n    this.keyword = undefined;\r\n  }\r\n\r\n  getLowerLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex < current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isLowerBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index + 1] &&\r\n      this.layers[index + 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getUpperLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex > current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isUpperBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index - 1] &&\r\n      this.layers[index - 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  moveActiveLayer(activeLayer: Layer, actiontype: LayerListDisplacement, fromUi: boolean = false) {\r\n    const sortedLayersToMove = [];\r\n    getRootParentByProperty(this.map,activeLayer,LinkedProperties.ZINDEX);\r\n    let rootParentByProperty = getRootParentByProperty(this.map,activeLayer,LinkedProperties.ZINDEX);\r\n    if (!rootParentByProperty) {\r\n      rootParentByProperty = activeLayer;\r\n    }\r\n    const layersToMove = [rootParentByProperty];\r\n    getAllChildLayersByProperty(this.map, rootParentByProperty, layersToMove, LinkedProperties.ZINDEX);\r\n\r\n    this.layers.map(layer => {\r\n      if (layersToMove.indexOf(layer) !== -1) {\r\n        sortedLayersToMove.push(layer);\r\n      }\r\n    });\r\n\r\n    if (actiontype === LayerListDisplacement.Raise) {\r\n      this.raiseLayers(sortedLayersToMove, fromUi);\r\n    } else if (actiontype === LayerListDisplacement.Lower) {\r\n      this.lowerLayers(sortedLayersToMove, fromUi);\r\n    }\r\n  }\r\n\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  raisableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const previousLayer = this.layers[mapIndex - 1];\r\n      if (\r\n        previousLayer &&\r\n        previousLayer.baseLayer !== true &&\r\n        !layers.find((lay) => previousLayer.id === lay.id) &&\r\n        currentLayer.baseLayer !== true\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  raisableLayer(index: number) {\r\n    if (index < 1) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index - 1].options.check) {\r\n      return this.raisableLayer(index - 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  raiseLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToRaise = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.raisableLayer(index)) {\r\n        layersToRaise.push(layer);\r\n      }\r\n    }\r\n    this.map.raiseLayers(layersToRaise);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const checkItems = this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked');\r\n        const itemFocused = this.elRef.nativeElement.getElementsByClassName('igo-layer-item-focused');\r\n        let targetToScroll;\r\n        if (checkItems.length) {\r\n          targetToScroll = checkItems[0];\r\n        }\r\n        if (itemFocused.length) {\r\n          targetToScroll = itemFocused[0];\r\n        }\r\n        if (targetToScroll) {\r\n          scrollIntoView(targetToScroll, {\r\n            scrollMode: 'if-needed',\r\n            behavior: 'smooth',\r\n            block: 'end',\r\n            inline: 'nearest'\r\n          });\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  lowerableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const nextLayer = this.layers[mapIndex + 1];\r\n      if (\r\n        nextLayer &&\r\n        nextLayer.baseLayer !== true &&\r\n        !layers.find((lay) => nextLayer.id === lay.id)\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  lowerableLayer(index: number) {\r\n    if (\r\n      index >\r\n      this.layers.filter((lay) => lay.baseLayer !== true).length - 2\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index + 1].options.check) {\r\n      return this.lowerableLayer(index + 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  lowerLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToLower = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.lowerableLayer(index)) {\r\n        layersToLower.push(layer);\r\n      }\r\n    }\r\n    this.map.lowerLayers(layersToLower);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const checkItems = this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked');\r\n        const itemFocused = this.elRef.nativeElement.getElementsByClassName('igo-layer-item-focused');\r\n        let targetToScroll;\r\n        if (checkItems.length) {\r\n          targetToScroll = checkItems[checkItems.length-1];\r\n        }\r\n        if (itemFocused.length) {\r\n          targetToScroll = itemFocused[0];\r\n        }\r\n        if (targetToScroll) {\r\n          scrollIntoView(targetToScroll, {\r\n            scrollMode: 'if-needed',\r\n            behavior: 'smooth',\r\n            block: 'end',\r\n            inline: 'nearest'\r\n          });\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private computeLayers(layers: Layer[]): Layer[] {\r\n    let layersOut = this.filterLayers(layers);\r\n    if (this.sortAlpha) {\r\n      layersOut = this.sortLayersByTitle(layersOut);\r\n    } else {\r\n      layersOut = this.sortLayersByZindex(layersOut);\r\n    }\r\n    return layersOut;\r\n  }\r\n\r\n  onKeywordChange(term) {\r\n    this.keyword = term;\r\n  }\r\n\r\n  onAppliedFilterAndSortChange(appliedFilter: LayerListControlsOptions) {\r\n    this.keyword = appliedFilter.keyword;\r\n    this.onlyVisible = appliedFilter.onlyVisible;\r\n    this.sortAlpha = appliedFilter.sortAlpha;\r\n  }\r\n\r\n  private filterLayers(layers: Layer[]): Layer[] {\r\n    if (\r\n      this.layerFilterAndSortOptions.showToolbar === LayerListControlsEnum.never\r\n    ) {\r\n      return layers;\r\n    }\r\n    if (!this.keyword && !this.onlyVisible) {\r\n      return layers;\r\n    }\r\n\r\n    const keepLayerIds = layers.map((layer: Layer) => layer.id);\r\n\r\n    layers.forEach((layer: Layer) => {\r\n      const layerOptions = (layer.options as MetadataLayerOptions) || {};\r\n      const dataSourceOptions = layer.dataSource.options || {};\r\n      const metadata = layerOptions.metadata || ({} as MetadataOptions);\r\n      const keywords = metadata.keywordList || [];\r\n      const layerKeywords = keywords.map((kw: string) => {\r\n        return kw.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      });\r\n\r\n      if (this.keyword && layer.title) {\r\n        const localKeyword = this.keyword\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const layerTitle = layer.title\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const dataSourceType = dataSourceOptions.type || '';\r\n        const keywordRegex = new RegExp(localKeyword, 'gi');\r\n        const keywordInList =\r\n          layerKeywords.find((kw: string) => keywordRegex.test(kw)) !==\r\n          undefined;\r\n        if (\r\n          !keywordRegex.test(layerTitle) &&\r\n          !(this.keyword.toLowerCase() === dataSourceType.toLowerCase()) &&\r\n          !keywordInList\r\n        ) {\r\n          const index = keepLayerIds.indexOf(layer.id);\r\n          if (index > -1) {\r\n            keepLayerIds.splice(index, 1);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.onlyVisible && layer.visible === false) {\r\n        const index = keepLayerIds.indexOf(layer.id);\r\n        if (index > -1) {\r\n          keepLayerIds.splice(index, 1);\r\n        }\r\n      }\r\n    });\r\n\r\n    return layers.filter(\r\n      (layer: Layer) => keepLayerIds.indexOf(layer.id) !== -1\r\n    );\r\n  }\r\n\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  private sortLayersByTitle(layers: Layer[]) {\r\n    return layers.sort((a, b) => {\r\n      if (this.normalize(a.title) < this.normalize(b.title)) {\r\n        return -1;\r\n      }\r\n      if (this.normalize(a.title) > this.normalize(b.title)) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n  }\r\n\r\n  private normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  private computeShowToolbar(): boolean {\r\n    switch (this.layerFilterAndSortOptions.showToolbar) {\r\n      case LayerListControlsEnum.always:\r\n        return true;\r\n      case LayerListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        if (\r\n          this.layers.length >= this.thresholdToFilterAndSort ||\r\n          this.keyword ||\r\n          this.onlyVisible\r\n        ) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  toggleLayerTool(layer) {\r\n    this.toggleOpacity = false;\r\n    if (this.layerTool && layer === this.activeLayer) {\r\n      this.layerTool = false;\r\n    } else {\r\n      this.layerTool = true;\r\n    }\r\n\r\n    for (const lay of this.layers) {\r\n      lay.options.active = false;\r\n    }\r\n    layer.options.active = true;\r\n    this.activeLayer = layer;\r\n  }\r\n\r\n  removeLayers(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      this.layersChecked = [];\r\n      for (const layer of layers) {\r\n        if (layer.options.removable !== false) {\r\n          layer.map.removeLayer(layer);\r\n        } else {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    } else if (!layers && this.activeLayer.options.removable !== false) {\r\n      this.activeLayer.map.removeLayer(this.activeLayer);\r\n      this.layerTool = false;\r\n    }\r\n  }\r\n\r\n  toggleVisibility(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      for (const layer of layers) {\r\n        layer.visible = this.hideSelectedLayers;\r\n      }\r\n    }\r\n    this.layerItemChangeDetection$.next(true);\r\n  }\r\n\r\n  isLayerRemovable(layer: Layer): boolean {\r\n    return layer.options.removable !== false;\r\n  }\r\n\r\n  isAllLayersRemovable(layers: Layer[]): boolean {\r\n    return layers.every(l => this.isLayerRemovable(l));\r\n  }\r\n\r\n  get statusSelectedLayersCheck(): LayerListSelectVisibleEnum {\r\n    let statusSelectedLayers: LayerListSelectVisibleEnum =\r\n      LayerListSelectVisibleEnum.NULL;\r\n    let findTrue: boolean = false;\r\n    let findFalse: boolean = false;\r\n\r\n    if (this.layersChecked.length === 0) {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.NULL;\r\n    } else {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.MIXED;\r\n      this.hideSelectedLayers = false;\r\n\r\n      for (const layer2 of this.layersChecked) {\r\n        if (layer2.visible === true) {\r\n          findTrue = true;\r\n        }\r\n        if (layer2.visible === false) {\r\n          findFalse = true;\r\n        }\r\n      }\r\n\r\n      if (findTrue === true && findFalse === false) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_VISIBLE;\r\n      }\r\n      if (findTrue === false && findFalse === true) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_HIDDEN;\r\n        this.hideSelectedLayers = true;\r\n      }\r\n    }\r\n\r\n    return statusSelectedLayers;\r\n  }\r\n\r\n  layersCheck(event: { layer: Layer; check: boolean }) {\r\n    event.layer.options.check = event.check;\r\n    if (event.check === true) {\r\n      const eventMapIndex = this.layers.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      for (const layer of this.layersChecked) {\r\n        const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n        if (eventMapIndex < mapIndex) {\r\n          this.layersChecked.splice(\r\n            this.layersChecked.findIndex((lay) => layer.id === lay.id),\r\n            0,\r\n            event.layer\r\n          );\r\n\r\n          if (this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          } else if (!this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter((lay) => lay.showInLayerList).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          }\r\n          return;\r\n        }\r\n      }\r\n      this.layersChecked.push(event.layer);\r\n    } else {\r\n      const index = this.layersChecked.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      this.layersChecked.splice(index, 1);\r\n    }\r\n\r\n    if (this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter(\r\n          (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n        ).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    } else if (!this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter((lay) => lay.showInLayerList).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  toggleSelectionMode(value: boolean) {\r\n    this.selection = value;\r\n    this.activeLayer = undefined;\r\n    if (value === true) {\r\n      this.layerTool = false;\r\n      for (const layer of this.layers) {\r\n        if (layer.options.check) {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  layersCheckedOpacity(): any {\r\n    if (this.layersChecked.length > 1) {\r\n      return 1;\r\n    } else {\r\n      const opacity = [];\r\n      for (const layer of this.layersChecked) {\r\n        opacity.push(layer.opacity);\r\n      }\r\n      return opacity;\r\n    }\r\n  }\r\n\r\n  selectAll() {\r\n    if (!this.selectAllCheck) {\r\n      for (const layer of this.layers) {\r\n        if (\r\n          this.excludeBaseLayers &&\r\n          layer.baseLayer !== true &&\r\n          layer.showInLayerList\r\n        ) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        } else if (!this.excludeBaseLayers && layer.showInLayerList) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n      this.selectAllCheck$.next(true);\r\n    } else {\r\n      for (const layer of this.layers) {\r\n        layer.options.check = false;\r\n      }\r\n      this.layersChecked = [];\r\n      this.selectAllCheck$.next(false);\r\n    }\r\n  }\r\n\r\n  isScrolledIntoView(elemSource, elem) {\r\n    const docViewTop = elemSource.scrollTop;\r\n    const docViewBottom = docViewTop + elemSource.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.clientHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  removeProblemLayerInList(layersList: Layer[]): Layer[] {\r\n    for (const layer of layersList) {\r\n      if (layer.olLoadingProblem === true) {\r\n        this.map.removeLayer(layer);\r\n      }\r\n    }\r\n    return layersList;\r\n  }\r\n}\r\n","  <mat-list-item>\r\n      <mat-form-field class=\"inputFilter\" [floatLabel]=\"floatLabel\">\r\n        <input\r\n          matInput\r\n          [placeholder]=\"'igo.geo.layer.filterPlaceholder' | translate\"\r\n          [matTooltip]=\"'igo.geo.layer.subsetLayersListKeyword' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          type=\"text\" [(ngModel)]=\"term\">\r\n        <button\r\n          mat-button\r\n          *ngIf=\"term\"\r\n          matSuffix\r\n          mat-icon-button\r\n          aria-label=\"Clear\"\r\n          color=\"warn\"\r\n          (click)=\"clearTerm()\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      </mat-form-field>\r\n\r\n      <div [matTooltip]=\"sortAlpha ?\r\n      ('igo.geo.layer.sortMapOrder' | translate) :\r\n      ('igo.geo.layer.sortAlphabetically' | translate)\" matTooltipShowDelay=\"500\">\r\n        <button class=\"sort-alpha\" [color]=\"sortAlpha ? 'warn' : 'primary'\" mat-icon-button (click)=\"toggleSortAlpha()\">\r\n          <mat-icon [svgIcon]=\"sortAlpha ? 'sort-ascending' : 'sort-alphabetical-ascending'\"></mat-icon>\r\n        </button>\r\n      </div>\r\n\r\n       <div [matTooltip]=\"onlyVisible ?\r\n        ('igo.geo.layer.resetLayersList' | translate) :\r\n        ('igo.geo.layer.subsetLayersListOnlyVisible' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"only-visible\" mat-icon-button [disabled]=\"layersAreAllVisible && !onlyVisible\"\r\n           [color]=\"onlyVisible ? 'warn' : 'primary'\" (click)=\"toggleOnlyVisible()\">\r\n           <mat-icon\r\n             matBadge=\"icon\"\r\n             igoMatBadgeIcon=\"eye\"\r\n             igoMatBadgeInverseColor=\"true\"\r\n             igoMatBadgeInheritColor=\"true\"\r\n             [svgIcon]=\"onlyVisible ? 'filter-remove' : 'filter'\">\r\n           </mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n       <div [matTooltip]=\"selectionMode ?\r\n        ('igo.geo.layer.deactivateSelectionMode' | translate) :\r\n        ('igo.geo.layer.activateSelectionMode' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"selection-mode\" mat-icon-button\r\n           color=\"primary\" (click)=\"toggleSelectionMode()\">\r\n           <mat-icon [svgIcon]=\"selectionMode ? 'checkbox-multiple-marked-outline' : 'checkbox-multiple-blank-outline'\"></mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  EventEmitter,\r\n  Output,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerListControlsOptions } from './layer-list-tool.interface';\r\n\r\n@Component({\r\n  selector: 'igo-layer-list-tool',\r\n  templateUrl: './layer-list-tool.component.html',\r\n  styleUrls: ['./layer-list-tool.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListToolComponent implements OnInit, OnDestroy {\r\n  public onlyVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public sortAlpha$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public term$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n  onlyVisible$$: Subscription;\r\n  sortAlpha$$: Subscription;\r\n  term$$: Subscription;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input()\r\n  set onlyVisible(value: boolean) {\r\n    this.onlyVisible$.next(value);\r\n  }\r\n  get onlyVisible(): boolean {\r\n    return this.onlyVisible$.value;\r\n  }\r\n\r\n  @Input()\r\n  set sortAlpha(value: boolean) {\r\n    this.sortAlpha$.next(value);\r\n  }\r\n  get sortAlpha(): boolean {\r\n    return this.sortAlpha$.value;\r\n  }\r\n\r\n  @Input()\r\n  set term(value: string) {\r\n    this.term$.next(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n\r\n  public selectionMode = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n  @Output() selection = new EventEmitter<boolean>();\r\n\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe(keyword => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n\r\n    this.onlyVisible$$ = this.onlyVisible$.subscribe(onlyVisible => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n    this.sortAlpha$$ = this.sortAlpha$.subscribe(sortAlpha => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.onlyVisible$$.unsubscribe();\r\n    this.sortAlpha$$.unsubscribe();\r\n    this.term$$.unsubscribe();\r\n  }\r\n\r\n  clearTerm() {\r\n    this.term = undefined;\r\n  }\r\n  toggleSortAlpha() {\r\n    this.sortAlpha = !this.sortAlpha;\r\n  }\r\n\r\n  toggleOnlyVisible() {\r\n    this.onlyVisible = !this.onlyVisible;\r\n  }\r\n\r\n  toggleSelectionMode() {\r\n    this.selectionMode = !this.selectionMode;\r\n    this.selection.emit(this.selectionMode);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy, Optional } from '@angular/core';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\n\r\nimport { RouteService } from '@igo2/core';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { LayerListComponent } from './layer-list.component';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { map, debounceTime } from 'rxjs/operators';\r\n\r\n@Directive({\r\n  selector: '[igoLayerListBinding]'\r\n})\r\nexport class LayerListBindingDirective implements OnInit, OnDestroy {\r\n  private component: LayerListComponent;\r\n  private layersOrResolutionChange$$: Subscription;\r\n  layersVisibility$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: LayerListComponent,\r\n    private mapService: MapService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    // this.component.layers = [];\r\n    this.layersOrResolutionChange$$ = combineLatest([\r\n      this.mapService.getMap().layers$,\r\n      this.mapService.getMap().viewController.resolution$]\r\n    ).pipe(\r\n      debounceTime(10)\r\n    ).subscribe((bunch: [Layer[], number]) => {\r\n      const shownLayers = bunch[0].filter((layer: Layer) => {\r\n        return layer.showInLayerList === true;\r\n      });\r\n      this.component.layers = shownLayers;\r\n      this.setLayersVisibilityStatus(shownLayers, this.component.excludeBaseLayers);\r\n    });\r\n  }\r\n\r\n  private setLayersVisibilityStatus(layers: Layer[], excludeBaseLayers: boolean) {\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n    this.layersVisibility$$ = combineLatest(layers\r\n      .filter(layer => layer.baseLayer !== excludeBaseLayers )\r\n      .map((layer: Layer) => layer.visible$))\r\n      .pipe(map((visibles: boolean[]) => visibles.every(Boolean)))\r\n      .subscribe((allLayersAreVisible: boolean) =>\r\n        this.component.layersAreAllVisible = allLayersAreVisible);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layersOrResolutionChange$$.unsubscribe();\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n  }\r\n\r\n}\r\n","\r\n<div class=\"layer-legend-list-container\">\r\n  <mat-slide-toggle \r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.legend.showAll' | translate\"\r\n  [checked]=\"showAllLegendsValue\" class=\"mat-typography\" \r\n  *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\" [labelPosition]=\"'before'\" (change)=\"toggleShowAllLegends($event.checked)\">\r\n    {{'igo.geo.layer.legend.showAll' | translate}}\r\n  </mat-slide-toggle>\r\n  <mat-divider *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\"></mat-divider>\r\n  <igo-list [navigation]=\"false\" [selection]=\"false\">\r\n    <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n      <igo-layer-legend-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n          igoListItem [layer]=\"layer\"\r\n          [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n      </igo-layer-legend-item>\r\n    </ng-template>\r\n  </igo-list>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButton' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButtonButZoom' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisible' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleButZoom' | translate}} \r\n  </p>\r\n\r\n</div>","import { Component, Input, ChangeDetectionStrategy, OnInit, OnDestroy, EventEmitter, Output } from '@angular/core';\r\nimport { Layer } from '../shared';\r\nimport { BehaviorSubject, ReplaySubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-list',\r\n  templateUrl: './layer-legend-list.component.html',\r\n  styleUrls: ['./layer-legend-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n\r\n  hasVisibleOrInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  hasVisibleAndNotInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  layersInUi$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  showAllLegend: boolean = false;\r\n  public change$ = new ReplaySubject<void>(1);\r\n  private change$$: Subscription;\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() allowShowAllLegends: boolean = false;\r\n\r\n  @Input() showAllLegendsValue: boolean = false;\r\n\r\n  @Output() allLegendsShown = new EventEmitter<boolean>(false);\r\n\r\n  constructor() { }\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(debounce(() => {\r\n        return this.layers.length === 0 ? EMPTY : timer(50);\r\n      }))\r\n      .subscribe(() => {\r\n        const layers = this.computeShownLayers(this.layers.slice(0));\r\n        this.layers$.next(layers);\r\n        this.hasVisibleOrInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n        this.hasVisibleAndNotInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && !layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n\r\n        this.layersInUi$.next(\r\n          this.layers.slice(0).filter(layer => layer.showInLayerList !== false && (!this.excludeBaseLayers || !layer.baseLayer))\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n  private computeShownLayers(layers: Layer[]) {\r\n    let shownLayers = layers.filter((layer: Layer) => layer.visible && layer.isInResolutionsRange);\r\n    if (this.showAllLegendsValue) {\r\n      shownLayers = layers;\r\n    }\r\n    return this.sortLayersByZindex(shownLayers);\r\n  }\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  toggleShowAllLegends(toggle: boolean) {\r\n      this.showAllLegendsValue = toggle;\r\n      this.next();\r\n      this.allLegendsShown.emit(toggle);\r\n  }\r\n}\r\n","<button *ngIf=\"options.trackFeature\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.trackFeature' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"toggleTrackFeature()\">\r\n  <mat-icon svgIcon=\"crosshairs-gps\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { VectorLayer } from '../shared/layers';\r\nimport { VectorLayerOptions } from '../shared/layers/vector-layer.interface';\r\n\r\n@Component({\r\n  selector: 'igo-track-feature-button',\r\n  templateUrl: './track-feature-button.component.html',\r\n  styleUrls: ['./track-feature-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TrackFeatureButtonComponent implements OnInit {\r\n\r\n  @Input() layer: VectorLayer;\r\n\r\n  @Input() trackFeature = false;\r\n\r\n  get options(): VectorLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n\r\n  public color: string = 'primary';\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.color = this.trackFeature ? 'primary' : 'basic';\r\n  }\r\n\r\n  toggleTrackFeature() {\r\n    if (this.trackFeature) {\r\n      this.layer.disableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'basic';\r\n    } else {\r\n      this.layer.enableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'primary';\r\n    }\r\n    this.trackFeature = !this.trackFeature;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-item',\r\n  templateUrl: './layer-legend-item.component.html',\r\n  styleUrls: ['./layer-legend-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendItemComponent implements OnInit, OnDestroy {\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  constructor(private networkService: NetworkService) {}\r\n\r\n  ngOnInit() {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <h4 matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoCollapsibleModule,\r\n  IgoImageModule,\r\n  IgoPanelModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoCustomHtmlModule\r\n} from '@igo2/common';\r\n\r\nimport { LayerService } from './shared/layer.service';\r\nimport { StyleService } from '../style/style-service/style.service';\r\nimport { LayerListToolService } from './layer-list-tool/layer-list-tool.service';\r\nimport { LayerItemComponent } from './layer-item/layer-item.component';\r\nimport { LayerLegendComponent } from './layer-legend/layer-legend.component';\r\nimport { LayerListComponent } from './layer-list/layer-list.component';\r\nimport { LayerListToolComponent } from './layer-list-tool/layer-list-tool.component';\r\nimport { LayerListBindingDirective } from './layer-list/layer-list-binding.directive';\r\nimport { LayerLegendListBindingDirective } from './layer-legend-list/layer-legend-list-binding.directive';\r\nimport { TrackFeatureButtonComponent } from './track-feature-button/track-feature-button.component';\r\nimport { LayerLegendListComponent } from './layer-legend-list/layer-legend-list.component';\r\nimport { LayerLegendItemComponent } from './layer-legend-item/layer-legend-item.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatInputModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    CommonModule,\r\n    FormsModule,\r\n    MatDividerModule,\r\n    MatMenuModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSlideToggleModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatSliderModule,\r\n    MatBadgeModule,\r\n    MatCheckboxModule,\r\n    ColorPickerModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoImageModule,\r\n    IgoPanelModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  exports: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ],\r\n  declarations: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ]\r\n})\r\nexport class IgoLayerModule {\r\n  static forRoot(): ModuleWithProviders<IgoLayerModule> {\r\n    return {\r\n      ngModule: IgoLayerModule,\r\n      providers: [LayerService, StyleService, LayerListToolService]\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoMatBadgeIconModule,\r\n  IgoCollapsibleModule,\r\n  IgoListModule\r\n} from '@igo2/common';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { CatalogBrowserComponent } from './catalog-browser.component';\r\nimport { CatalogBrowserLayerComponent } from './catalog-browser-layer.component';\r\nimport { CatalogBrowserGroupComponent } from './catalog-browser-group.component';\r\nimport { IgoLayerModule } from '../../layer/layer.module';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoMetadataModule,\r\n    IgoLayerModule\r\n  ],\r\n  exports: [\r\n    CatalogBrowserComponent\r\n  ],\r\n  declarations: [\r\n    CatalogBrowserComponent,\r\n    CatalogBrowserGroupComponent,\r\n    CatalogBrowserLayerComponent\r\n  ]\r\n})\r\nexport class IgoCatalogBrowserModule {}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{'igo.geo.catalog.library.addTitle' | translate}}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <form class=\"igo-form\" [formGroup]=\"form\">\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"title\" placeholder=\"{{'igo.geo.printForm.title' | translate}}\" matInput [matAutocomplete]=\"auto2\">\r\n        <mat-autocomplete #auto2=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.title\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.title}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"url\" placeholder=\"URL\" matInput [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.url\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.url}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <mat-select\r\n          formControlName=\"type\"\r\n          placeholder=\"Type\">\r\n          <mat-option\r\n            *ngFor=\"let type of typeCapabilities\"\r\n            [value]=\"type\"\r\n            (click)=\"$event.stopPropagation()\">\r\n              <p mat-line>{{type}}</p>\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n  <span *ngIf=\"error && addedCatalog && emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.externalProvider.unavailableWithEmail', { value: addedCatalog.url, email: emailAddress })}}</p>\r\n  </span>\r\n  <span *ngIf=\"error && addedCatalog && !emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url })}}</p>\r\n  </span>\r\n</div>\r\n<div mat-dialog-actions style=\"justify-content: center\">\r\n  <div class=\"igo-form-button-group add-catalog-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"cancel()\">\r\n      {{'igo.geo.catalog.library.cancel' | translate}}\r\n    </button>\r\n    <button\r\n      id=\"addCatalogBtnDialog\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      color=\"primary\"\r\n      [disabled]=\"!form.valid\"\r\n      (click)=\"addCatalog(form.value)\">\r\n      {{'igo.geo.catalog.library.add' | translate}}\r\n    </button>\r\n  </div>\r\n</div>","import { LanguageService, ConfigService } from '@igo2/core';\r\nimport { Component, OnInit, OnDestroy, Optional, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { UntypedFormBuilder, UntypedFormGroup, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { TypeCapabilities } from '../../datasource';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n@Component({\r\n  selector: 'igo-add-catalog-dialog',\r\n  templateUrl: './add-catalog-dialog.component.html',\r\n  styleUrls: ['./add-catalog-dialog.component.scss']\r\n})\r\nexport class AddCatalogDialogComponent implements OnInit, OnDestroy {\r\n  public form: UntypedFormGroup;\r\n  private defaultAddedCatalogType = 'wms';\r\n  private addedCatalogType$$: Subscription;\r\n  public predefinedCatalogsList$ = new BehaviorSubject<Catalog[]>([]);\r\n  typeCapabilities: string[];\r\n  predefinedCatalogs: Catalog[] = [];\r\n  store: EntityStore<Catalog>;\r\n  error = false;\r\n  addedCatalog: Catalog;\r\n  emailAddress: string;\r\n  private storeViewAll$$: Subscription;\r\n\r\n  constructor(\r\n    private formBuilder: UntypedFormBuilder,\r\n    public languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    public dialogRef: MatDialogRef<AddCatalogDialogComponent>,\r\n    @Optional()\r\n    @Inject(MAT_DIALOG_DATA)\r\n    public data: { predefinedCatalogs: Catalog[]; store: EntityStore<Catalog>; error: boolean; addedCatalog: Catalog }\r\n  ) {\r\n    this.store = data.store;\r\n    this.predefinedCatalogs = data.predefinedCatalogs;\r\n    this.error = data.error;\r\n    this.addedCatalog = data.addedCatalog;\r\n    this.form = this.formBuilder.group({\r\n      id: ['', []],\r\n      title: ['', []],\r\n      url: ['', [Validators.required]],\r\n      type: [this.defaultAddedCatalogType, [Validators.required]]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n    this.typeCapabilities = Object.keys(TypeCapabilities);\r\n\r\n    this.addedCatalogType$$ = this.form\r\n      .get('type')\r\n      .valueChanges.subscribe((value) => {\r\n        if (value === 'wmts') {\r\n          this.form.get('title').setValidators(Validators.required);\r\n        } else {\r\n          this.form.get('title').setValidators([]);\r\n        }\r\n        this.form.get('title').updateValueAndValidity();\r\n      });\r\n\r\n    this.computePredefinedCatalogList();\r\n    this.storeViewAll$$ = this.store.view\r\n      .all$()\r\n      .subscribe(() => this.computePredefinedCatalogList());\r\n\r\n    this.emailAddress = this.configService.getConfig('emailAddress');\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.addedCatalogType$$.unsubscribe();\r\n    this.storeViewAll$$.unsubscribe();\r\n  }\r\n\r\n  changeUrlOrTitle(catalog: Catalog) {\r\n    this.form.patchValue(catalog);\r\n    this.error = false;\r\n    this.computePredefinedCatalogList();\r\n  }\r\n\r\n  computePredefinedCatalogList() {\r\n    this.predefinedCatalogsList$.next(\r\n      this.predefinedCatalogs.filter((c) => !this.store.get(c.id))\r\n    );\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    this.error = false;\r\n    this.dialogRef.close(addedCatalog);\r\n  }\r\n\r\n  cancel() {\r\n    this.error = false;\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\">\r\n  <ng-template ngFor let-catalog [ngForOf]=\"getCatalogs() | async\">\r\n    <igo-catalog-library-item\r\n      igoListItem\r\n      color=\"accent\"\r\n      [map]=\"map\"\r\n      [catalog]=\"catalog\"\r\n      (catalogRemove)=\"onCatalogRemove(catalog)\"\r\n      (select)=\"onCatalogSelect(catalog)\">\r\n    </igo-catalog-library-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<div *ngIf=\"addCatalogAllowed\" class=btnAddCatalog>\r\n  <button\r\n    mat-raised-button\r\n    [matTooltip]=\"'igo.geo.catalog.library.addBtn' | translate\"\r\n    matTooltipPosition=\"above\"\r\n    color=\"primary\"\r\n    (click)=\"addCatalogDialog()\">\r\n    {{'igo.geo.catalog.library.addBtn' | translate}}\r\n    <mat-icon svgIcon=\"earth-plus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { MessageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { Observable, Subscription } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\nimport { Md5 } from 'ts-md5';\r\nimport { CapabilitiesService } from '../../datasource';\r\nimport { IgoMap } from '../../map';\r\nimport { standardizeUrl } from '../../utils/id-generator';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\n/**\r\n * Component to browse a list of available catalogs\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library',\r\n  templateUrl: './catalog-library.component.html',\r\n  styleUrls: ['./catalog-library.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Store holding the catalogs\r\n   */\r\n  @Input() store: EntityStore<Catalog>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() addCatalogAllowed: boolean = false;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() predefinedCatalogs: Catalog[] = [];\r\n\r\n  /**\r\n   * Event emitted a catalog is selected or unselected\r\n   */\r\n  @Output() catalogSelectChange = new EventEmitter<{\r\n    selected: boolean;\r\n    catalog: Catalog;\r\n  }>();\r\n\r\n  submitDisabled = true;\r\n  private addingCatalog$$: Subscription;\r\n\r\n  get addedCatalogs(): Catalog[] {\r\n    return (this.storageService.get('addedCatalogs') || []) as Catalog[];\r\n  }\r\n  set addedCatalogs(catalogs: Catalog[]) {\r\n    this.storageService.set('addedCatalogs', catalogs);\r\n  }\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private messageService: MessageService,\r\n    private storageService: StorageService,\r\n    private dialog: MatDialog\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n\r\n    this.predefinedCatalogs = this.predefinedCatalogs.map(c => {\r\n      c.id = Md5.hashStr(\r\n        (c.type || 'wms') + standardizeUrl(c.url)\r\n      ) as string;\r\n      c.title = c.title === '' || !c.title ? c.url : c.title;\r\n      return c;\r\n    });\r\n  }\r\n\r\n  getCatalogs(): Observable<Catalog[]> {\r\n    return this.store.view.all$();\r\n  }\r\n\r\n  /**\r\n   * When a catalog is selected, update it's state in the store\r\n   * and emit the catalog select change event\r\n   * @internal\r\n   */\r\n  onCatalogSelect(catalog: Catalog) {\r\n    this.store.state.update(\r\n      catalog,\r\n      {\r\n        selected: true,\r\n        focused: true\r\n      },\r\n      true\r\n    );\r\n    this.catalogSelectChange.emit({ selected: true, catalog });\r\n  }\r\n\r\n  private unsubscribeAddingCatalog() {\r\n    if (this.addingCatalog$$) {\r\n      this.addingCatalog$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    if (!addedCatalog) {\r\n      return;\r\n    }\r\n    let id = Md5.hashStr(\r\n      addedCatalog.type + standardizeUrl(addedCatalog.url)\r\n    ) as string;\r\n    const predefinedCatalog = this.predefinedCatalogs.find(\r\n      (c) => c.id === addedCatalog.id\r\n    );\r\n\r\n    if (predefinedCatalog) {\r\n      addedCatalog.version = predefinedCatalog.version;\r\n      addedCatalog.externalProvider = predefinedCatalog.externalProvider;\r\n      id = predefinedCatalog.id;\r\n    }\r\n\r\n    if (this.store.get(id)) {\r\n      this.messageService.alert('igo.geo.catalog.library.inlist.message', 'igo.geo.catalog.library.inlist.title');\r\n      return;\r\n    }\r\n    this.unsubscribeAddingCatalog();\r\n\r\n    this.addingCatalog$$ = this.capabilitiesService\r\n    .getCapabilities(addedCatalog.type as any, addedCatalog.url, addedCatalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          if (e.error) {\r\n            this.addCatalogDialog(true, addedCatalog);\r\n            e.error.caught = true;\r\n            return e;\r\n          }\r\n          this.messageService.error(\r\n            'igo.geo.catalog.unavailable',\r\n            'igo.geo.catalog.unavailableTitle',\r\n            undefined,\r\n            { value: addedCatalog.url });\r\n          throw e;\r\n        })\r\n      )\r\n      .subscribe((capabilities) => {\r\n        let title;\r\n        let version;\r\n        switch (addedCatalog.type) {\r\n          case 'wms':\r\n            title = addedCatalog.title || capabilities.Service.Title;\r\n            version = addedCatalog.version || capabilities.version;\r\n            break;\r\n          case 'arcgisrest':\r\n          case 'imagearcgisrest':\r\n          case 'tilearcgisrest':\r\n            title = addedCatalog.title || capabilities.mapName;\r\n            break;\r\n          case 'wmts':\r\n            title =\r\n              addedCatalog.title ||\r\n              capabilities.ServiceIdentification.ServiceType;\r\n            break;\r\n          default:\r\n            title = addedCatalog.title;\r\n        }\r\n\r\n        const catalogToAdd = ObjectUtils.removeUndefined(\r\n          Object.assign({},\r\n            predefinedCatalog,\r\n            ObjectUtils.removeUndefined({\r\n              id,\r\n              title,\r\n              url: addedCatalog.url,\r\n              type: addedCatalog.type || 'wms',\r\n              externalProvider: addedCatalog.externalProvider || false,\r\n              removable: true,\r\n              version\r\n            })) as Catalog);\r\n        this.store.insert(catalogToAdd);\r\n        const newCatalogs = this.addedCatalogs.slice(0);\r\n        newCatalogs.push(catalogToAdd);\r\n        this.addedCatalogs = newCatalogs;\r\n        this.unsubscribeAddingCatalog();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribeAddingCatalog();\r\n  }\r\n\r\n  onCatalogRemove(catalog) {\r\n    this.store.delete(catalog);\r\n    this.addedCatalogs = this.addedCatalogs\r\n      .slice(0)\r\n      .filter((c) => c.id !== catalog.id);\r\n  }\r\n\r\n  addCatalogDialog(error?, addedCatalog?: Catalog) {\r\n    const dialogRef = this.dialog.open(AddCatalogDialogComponent, {\r\n      width: '700px',\r\n      data: {\r\n        predefinedCatalogs: this.predefinedCatalogs,\r\n        store: this.store,\r\n        error,\r\n        addedCatalog\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((catalog) => {\r\n      this.addCatalog(catalog);\r\n    });\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <h4 mat-line>\r\n    {{title}}\r\n  </h4>\r\n  <mat-icon\r\n    class=\"igo-external-provider\"\r\n    *ngIf=\"catalog.externalProvider\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.catalog.externalProvider.catalog' | translate\"\r\n    color=\"primary\"\r\n    (click)=\"$event.stopPropagation()\"\r\n    svgIcon=\"earth-arrow-right\">\r\n  </mat-icon>\r\n\r\n  <button\r\n  *ngIf=\"catalog.removable\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.catalog.library.remove' | translate\"\r\n  color=\"warn\"\r\n  (click)=\"removeCatalogFromLibrary($event)\">\r\n  <mat-icon svgIcon=\"delete\"></mat-icon>\r\n</button>\r\n\r\n<button\r\n  class=\"igo-blank\"\r\n  *ngIf=\"!catalog.removable\"\r\n  disabled=\"true\"\r\n  mat-icon-button>\r\n  <mat-icon svgIcon=\"blank\"></mat-icon>\r\n</button>\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\nimport { IgoMap } from '../../map';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n/**\r\n * Catalog library item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library-item',\r\n  templateUrl: './catalog-library-item.component.html',\r\n  styleUrls: ['./catalog-library-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryItemComponent {\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() catalogRemove = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return getEntityTitle(this.catalog); }\r\n\r\n  removeCatalogFromLibrary(event) {\r\n    event.stopPropagation();\r\n    this.catalogRemove.emit();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule } from '@igo2/common';\r\n\r\nimport { CatalogLibaryComponent, } from './catalog-library.component';\r\nimport { CatalogLibaryItemComponent } from './catalog-library-item.component';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoListModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatFormFieldModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatAutocompleteModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    CatalogLibaryComponent,\r\n    AddCatalogDialogComponent\r\n  ],\r\n  declarations: [\r\n    CatalogLibaryComponent,\r\n    CatalogLibaryItemComponent,\r\n    AddCatalogDialogComponent\r\n  ]\r\n})\r\nexport class IgoCatalogLibraryModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule, IgoCollapsibleModule, IgoMatBadgeIconModule } from '@igo2/common';\r\n\r\nimport { IgoCatalogBrowserModule } from './catalog-browser/catalog-browser.module';\r\nimport { IgoCatalogLibraryModule } from './catalog-library/catalog-library.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule\r\n  ],\r\n  exports: [\r\n    IgoCatalogBrowserModule,\r\n    IgoCatalogLibraryModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoCatalogModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\nimport { TimeFilterableDataSource } from './time-filter.interface';\r\n\r\n@Pipe({\r\n  name: 'filterableDataSource'\r\n})\r\nexport class FilterableDataSourcePipe implements PipeTransform {\r\n  transform(value: Layer[], arg: string): Layer[] {\r\n    let layers;\r\n\r\n    if (arg === 'time') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as TimeFilterableDataSource;\r\n        return (\r\n          this.isTimeFilterable(datasource) &&\r\n          datasource.options.timeFilter !== undefined &&\r\n          Object.keys(datasource.options.timeFilter).length\r\n        );\r\n      });\r\n    }\r\n    if (arg === 'ogc') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as OgcFilterableDataSource;\r\n        return this.isOgcFilterable(datasource);\r\n      });\r\n    }\r\n    return layers;\r\n  }\r\n\r\n  private isTimeFilterable(dataSource: TimeFilterableDataSource) {\r\n    if (dataSource.options.type !== 'wms') {\r\n      return false;\r\n    }\r\n    return dataSource.options.timeFilterable;\r\n  }\r\n\r\n  private isOgcFilterable(dataSource: OgcFilterableDataSource): boolean {\r\n    let isOgcFilterable = false;\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      dataSource.options.ogcFilters.editable\r\n    ) {\r\n      isOgcFilterable = true;\r\n    }\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      (\r\n        dataSource.options.ogcFilters.pushButtons ||\r\n        dataSource.options.ogcFilters.checkboxes ||\r\n        dataSource.options.ogcFilters.radioButtons ||\r\n        dataSource.options.ogcFilters.select ||\r\n        dataSource.options.ogcFilters.autocomplete)) {\r\n        isOgcFilterable = true;\r\n    }\r\n    return isOgcFilterable;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { TileArcGISRestDataSource } from '../../datasource/shared/datasources/tilearcgisrest-datasource';\r\n\r\n@Injectable()\r\nexport class TimeFilterService {\r\n  constructor() {}\r\n\r\n  filterByDate(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    date: Date | [Date, Date]\r\n  ) {\r\n    let time;\r\n    let newdateform;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(date)) {\r\n      const dates = [];\r\n      if (date[0]) {\r\n        newdateformStart = this.reformatDateTime(date[0]);\r\n        dates.push(date[0]);\r\n      }\r\n      if (date[1]) {\r\n        newdateformEnd = this.reformatDateTime(date[1]);\r\n        dates.push(date[1]);\r\n      }\r\n      if (dates.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else if (date) {\r\n      newdateform = this.reformatDateTime(date);\r\n      time = newdateform;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  filterByYear(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    year: string | [string, string]\r\n  ) {\r\n    let time;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(year)) {\r\n      const years = [];\r\n      if (year[0]) {\r\n        newdateformStart = year[0];\r\n        years.push(year[0]);\r\n      }\r\n      if (year[1]) {\r\n        newdateformEnd = year[1];\r\n        years.push(year[1]);\r\n      }\r\n      if (years.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else { // to reset filter.\r\n      time = year;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  private reformatDateTime(value) {\r\n    const year = value.getFullYear();\r\n    let month = value.getMonth() + 1;\r\n    let day = value.getUTCDate();\r\n    let hour = value.getUTCHours();\r\n    let minute = value.getUTCMinutes();\r\n\r\n    if (Number(month) < 10) {\r\n      month = '0' + month;\r\n    }\r\n\r\n    if (Number(day) < 10) {\r\n      day = '0' + day;\r\n    }\r\n\r\n    if (Number(hour) < 10) {\r\n      hour = '0' + hour;\r\n    }\r\n\r\n    if (Number(minute) < 10) {\r\n      minute = '0' + minute;\r\n    }\r\n\r\n    return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':00Z';\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from './ogc-filter';\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterService {\r\n  constructor() {}\r\n\r\n  public filterByOgc(wmsDatasource: WMSDataSource, filterString: string) {\r\n    const appliedFilter = new OgcFilterWriter().formatProcessedOgcFilter(filterString, wmsDatasource.options.params.LAYERS);\r\n    wmsDatasource.ol.updateParams({ FILTER: appliedFilter });\r\n  }\r\n\r\n  public setOgcWFSFiltersOptions(wfsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wfsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.paramsWFS.fieldNameGeometry,\r\n        new olProjection({ code: options.paramsWFS.srsName }),\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          options.ogcFilters.filters,\r\n          options.paramsWFS.fieldNameGeometry\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public setOgcWMSFiltersOptions(wmsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wmsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.fieldNameGeometry,\r\n        undefined,\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          // With some wms server, this param must be set to make spatials call.\r\n          options.ogcFilters.filters,\r\n          options.fieldNameGeometry\r\n        );\r\n      }\r\n      this.filterByOgc(\r\n        wmsDatasource as WMSDataSource,\r\n        ogcFilterWriter.buildFilter(options.ogcFilters.filters,\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        wmsDatasource.options\r\n        )\r\n      );\r\n      options.filtered = true;\r\n    } else {\r\n      options.ogcFilters.filters = undefined;\r\n      options.ogcFilters.interfaceOgcFilters = [];\r\n      options.filtered = false;\r\n    }\r\n  }\r\n}\r\n","export enum SpatialFilterQueryType {\r\n    AdmRegion = 'AdmRegion',\r\n    Mun = 'Mun',\r\n    Arrond = 'Arrond',\r\n    CircFed = 'CircFed',\r\n    CircProv = 'CircProv',\r\n    DirReg = 'DirReg',\r\n    MRC = 'MRC',\r\n    RegTour = 'RegTour'\r\n}\r\n\r\nexport enum SpatialFilterType {\r\n    Predefined = 'Predefined',\r\n    Polygon = 'Polygon',\r\n    Point = 'Point'\r\n}\r\n\r\nexport enum SpatialFilterItemType {\r\n    Address = 'Address',\r\n    Thematics = 'Thematics'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { Observable } from 'rxjs';\r\nimport { Feature } from '../../feature/shared';\r\nimport {\r\n  SpatialFilterQueryType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterType\r\n} from './spatial-filter.enum';\r\nimport { SpatialFilterThematic } from './spatial-filter.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SpatialFilterService {\r\n  public baseUrl: string = 'https://geoegl.msp.gouv.qc.ca/apis/terrapi/';\r\n\r\n  /*\r\n   * Type association with URL\r\n   */\r\n  public urlFilterList = {\r\n    AdmRegion: 'regadmin',\r\n    Arrond: 'arrondissements',\r\n    CircFed: 'circ-fed',\r\n    CircProv: 'circ-prov',\r\n    DirReg: 'dir-reg',\r\n    MRC: 'mrc',\r\n    Mun: 'municipalites',\r\n    RegTour: 'tourisme',\r\n    bornes: 'bornes-sumi',\r\n    hydro: 'hydro',\r\n    routes: 'routes'\r\n  };\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.baseUrl =\r\n      this.configService.getConfig('spatialFilter.url') || this.baseUrl;\r\n  }\r\n\r\n  getKeyByValue(object, value) {\r\n    return Object.keys(object).find(key => object[key] === value);\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter list component (NO GEOMETRY)\r\n   */\r\n  loadFilterList(type: SpatialFilterQueryType): Observable<Feature[]> {\r\n    const urlPath = type as string;\r\n    if (urlPath) {\r\n      return this.http\r\n        .get<{ features: Feature[] }>(\r\n          this.baseUrl + this.urlFilterList[urlPath]\r\n        )\r\n        .pipe(\r\n          map(featureCollection =>\r\n            featureCollection.features.map(f => {\r\n              f.meta = {\r\n                id: f.properties.code\r\n              };\r\n              return f;\r\n            })\r\n          )\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Loading item list (STRING)\r\n   */\r\n  loadThematicsList() {\r\n    const url = 'types';\r\n    const items: SpatialFilterThematic[] = [];\r\n    return this.http.get(this.baseUrl + url).pipe(\r\n      map((types: string[]) => {\r\n        types.forEach(type => {\r\n          if (type.startsWith('lieux')) {\r\n            const item: SpatialFilterThematic = {\r\n              name: undefined,\r\n              source: type\r\n            };\r\n            let substr = type.substring(6, type.length);\r\n            let name = substr;\r\n            if (substr.includes('.')) {\r\n              const index = substr.indexOf('.');\r\n              name = substr.substring(index + 1, substr.length);\r\n              substr = substr.substring(0, index);\r\n            }\r\n            try {\r\n              item.name = this.languageService.translate.instant(\r\n                'igo.geo.terrapi.' + name\r\n              );\r\n            } catch (e) {\r\n              item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n            }\r\n\r\n            try {\r\n              item.group = this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.group.' + substr\r\n              );\r\n            } catch (e) {\r\n              item.group = substr.substring(0, 1).toUpperCase() + substr.substring(1, name.length - 1);\r\n            }\r\n\r\n            items.push(item);\r\n          } else {\r\n            if (this.getKeyByValue(this.urlFilterList, type)) {\r\n              const item: SpatialFilterThematic = {\r\n                name: undefined,\r\n                source: type\r\n              };\r\n              const name = this.getKeyByValue(this.urlFilterList, type);\r\n              try {\r\n                item.name = this.languageService.translate.instant(\r\n                  'igo.geo.terrapi.' + name\r\n                );\r\n              } catch (e) {\r\n                item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n              }\r\n              item.source = type;\r\n\r\n              items.push(item);\r\n            }\r\n          }\r\n        });\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter item component (Address or Thematics) depends on predefined zone or draw zone (feature)\r\n   */\r\n  loadFilterItem(\r\n    feature,\r\n    itemType: SpatialFilterItemType,\r\n    type?: SpatialFilterQueryType,\r\n    thematic?: SpatialFilterThematic,\r\n    buffer?: number\r\n  ) {\r\n    if (type) {\r\n      // Predefined type\r\n      const urlType = type as string;\r\n      const url = this.baseUrl + this.urlFilterList[urlType];\r\n      let urlItem = '';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        urlItem = 'adresses';\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        urlItem = thematic.source;\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    } else {\r\n      // Draw type\r\n      const url = this.baseUrl + 'locate';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        const urlItem = '?type=adresses';\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        const urlItem = '?type=' + thematic.source;\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get one territory by id (WITH GEOMETRY)\r\n   */\r\n  loadItemById(\r\n    feature: Feature,\r\n    type: SpatialFilterQueryType\r\n  ): Observable<Feature> {\r\n    const featureType = this.urlFilterList[type];\r\n    const featureCode = '/' + feature.properties.code;\r\n    if (featureType && featureCode) {\r\n      return this.http\r\n        .get<Feature>(this.baseUrl + featureType + featureCode, {\r\n          params: {\r\n            geometry: 'true'\r\n          }\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            f.meta = {\r\n              id: f.properties.code,\r\n              alias: f.properties.nom,\r\n              title: f.properties.nom\r\n            };\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get buffer geometry\r\n   */\r\n  loadBufferGeometry(\r\n    feature: Feature,\r\n    filterType: SpatialFilterType,\r\n    buffer?: number,\r\n    type?: SpatialFilterQueryType,\r\n  ): Observable<Feature> {\r\n    if (filterType === SpatialFilterType.Predefined) {\r\n      const featureType = this.urlFilterList[type];\r\n      const featureCode = '/' + feature.properties.code;\r\n      if (featureType && featureCode) {\r\n        return this.http\r\n          .get<Feature>(this.baseUrl + featureType + featureCode,\r\n            {\r\n              params: {\r\n                geometry: '100',\r\n                bufferOutput: buffer.toString()\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(f => {\r\n              f.meta = {\r\n                id: f.properties.code,\r\n                alias: f.properties.nom,\r\n                title: f.properties.nom\r\n              };\r\n              return f;\r\n            })\r\n          );\r\n      }\r\n    } else {\r\n      return this.http\r\n        .post<Feature>(this.baseUrl + 'geospatial/buffer?', {\r\n          buffer,\r\n          loc: JSON.stringify(feature)\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { MessageService } from '@igo2/core';\r\n\r\nimport { Layer } from '../../layer/shared';\r\nimport { OgcFilterWriter, OgcFilterableDataSourceOptions } from '../../filter/shared';\r\n\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DownloadService {\r\n\r\n  constructor(\r\n    private messageService: MessageService\r\n  ) {}\r\n\r\n  open(layer: Layer) {\r\n    this.messageService.success(\r\n      'igo.geo.download.start',\r\n      'igo.geo.download.title'\r\n    );\r\n\r\n    const DSOptions: DataSourceOptions = layer.dataSource.options;\r\n    if (Object.keys(DSOptions.download).length > 0) {\r\n      if (\r\n        DSOptions.download.dynamicUrl &&\r\n        DSOptions.download.url === undefined\r\n      ) {\r\n        let wfsOptions;\r\n        let currentProj = new olProjection({ code: layer.map.projection });\r\n        const paramsWFS = (layer.dataSource.options as any).paramsWFS;\r\n        if (paramsWFS && Object.keys(paramsWFS).length > 0\r\n        ) {\r\n          currentProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : currentProj;\r\n          wfsOptions = (layer.dataSource.options as any).paramsWFS;\r\n        } else {\r\n          wfsOptions = (layer.dataSource.options as any).params;\r\n        }\r\n\r\n        const currentExtent = olproj.transformExtent(\r\n          layer.map.viewController.getExtent(),\r\n          new olProjection({ code: layer.map.projection }),\r\n          currentProj\r\n        );\r\n        const outputFormatDownload =\r\n          wfsOptions.outputFormatDownload === undefined\r\n            ? wfsOptions.outputFormat === undefined ? '' : 'outputformat=' + wfsOptions.outputFormat\r\n            : 'outputformat=' + wfsOptions.outputFormatDownload;\r\n\r\n        const baseurl = DSOptions.download.dynamicUrl\r\n          .replace(/&?outputformat=[^&]*/gi, '')\r\n          .replace(/&?filter=[^&]*/gi, '')\r\n          .replace(/&?bbox=[^&]*/gi, '');\r\n\r\n        const ogcFilters = (layer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n\r\n        let filterQueryString;\r\n        filterQueryString = new OgcFilterWriter()\r\n        .handleOgcFiltersAppliedValue(\r\n          layer.dataSource.options,\r\n          ogcFilters.geometryName,\r\n          currentExtent as [number, number, number, number],\r\n          currentProj);\r\n        if (!filterQueryString) {\r\n          // Prevent getting all the features for empty filter\r\n            filterQueryString = new OgcFilterWriter().buildFilter(\r\n            undefined,\r\n            currentExtent as [number, number, number, number],\r\n            currentProj,\r\n            ogcFilters.geometryName\r\n          );\r\n        } else {\r\n          filterQueryString = 'filter=' + encodeURIComponent(filterQueryString);\r\n        }\r\n        window.open(\r\n          `${baseurl}&${filterQueryString}&${outputFormatDownload}`,\r\n          '_blank'\r\n        );\r\n      } else if (DSOptions.download) {\r\n        window.open(DSOptions.download.url, '_blank');\r\n      }\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"options && options.download && (options.download['dynamicUrl'] || options.download['url']) \"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.download.action' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openDownload(layer)\">\r\n  <mat-icon svgIcon=\"download\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { DownloadDataSourceOptions } from '../shared/download.interface';\r\nimport { DownloadService } from '../shared/download.service';\r\n\r\n@Component({\r\n  selector: 'igo-download-button',\r\n  templateUrl: './download-button.component.html',\r\n  styleUrls: ['./download-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DownloadButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private downloadService: DownloadService) {}\r\n\r\n  openDownload(layer: Layer) {\r\n    this.downloadService.open(layer);\r\n  }\r\n\r\n  get options(): DownloadDataSourceOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.dataSource.options;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { DownloadButtonComponent } from './download-button/download-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [DownloadButtonComponent],\r\n  declarations: [DownloadButtonComponent]\r\n})\r\nexport class IgoDownloadModule {\r\n  static forRoot(): ModuleWithProviders<IgoDownloadModule> {\r\n    return {\r\n      ngModule: IgoDownloadModule\r\n    };\r\n  }\r\n}\r\n","<table class=\"igo-striped mat-typography\" *ngIf=\"ready && feature && isObject(feature.properties) && feature.properties.target !== 'iframe'\">\r\n  <tbody>\r\n    <tr *ngFor=\"let property of filterFeatureProperties(feature) | keyvalue\">\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <mat-icon mat-list-avatar svgIcon=\"{{icon}}\"></mat-icon>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <a href=\"{{property.value}}\" target='_blank' rel=\"noopener noreferrer\"> {{ 'igo.geo.targetHtmlUrl' | translate }} {{title}}</a>\r\n        <button class=\"copyClipboard\" mat-icon-button (click)=\"copyTextToClipboard(property.value)\">\r\n          <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n        </button>\r\n      </td>\r\n\r\n      <td id=\"keyValue\" *ngIf=\"feature.properties.target === undefined\">\r\n        {{property.key}}\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && !isUrl(property.value) && !isEmbeddedLink(property.value)\" [innerHTML]=\"property.value\">\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isEmbeddedLink(property.value)\">\r\n        <u [ngStyle]=\"{'cursor': 'pointer', 'color': 'blue'}\" (click)=\"openSecureUrl(property.value)\">{{ getEmbeddedLinkText(property.value) }}</u>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && (isDoc(property.value) || isUrl(property.value)) && !isImg(property.value)\">\r\n        <u [ngStyle]=\"{'cursor': 'pointer', 'color': 'blue'}\" (click)=\"openSecureUrl(property.value)\">{{ 'igo.geo.targetHtmlUrl' | translate }}</u>\r\n        <button class=\"copyClipboard\" mat-icon-button (click)=\"copyTextToClipboard(property.value)\">\r\n          <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n        </button>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && isUrl(property.value) && isImg(property.value)\">\r\n        <a href=\"{{property.value}}\" target='_blank' (click)=\"openSecureUrl(property.value)\" rel=\"noopener noreferrer\">\r\n          <img igoImageError src=\"{{(property.value | secureImage) | async}}\" width=\"225\" height=\"auto\">\r\n        </a>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isObject(property.value)\" [innerHTML]=\"property.value | json\">\r\n      </td>\r\n\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<iframe *ngIf=\"isHtmlDisplay()\" [srcdoc]=\"htmlSanitizer(feature.properties)\" [src]=\"urlSanitizer(feature.properties.url)\"></iframe>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';\r\nimport { Subject } from 'rxjs';\r\nimport { takeUntil } from 'rxjs/operators';\r\n\r\nimport { NetworkService, ConnectionState, MessageService } from '@igo2/core';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\nimport type { Toolbox } from '@igo2/common';\r\n\r\nimport { Feature } from '../shared';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Clipboard } from '@igo2/utils';\r\n@Component({\r\n  selector: 'igo-feature-details',\r\n  templateUrl: './feature-details.component.html',\r\n  styleUrls: ['./feature-details.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\n\r\nexport class FeatureDetailsComponent implements OnInit, OnDestroy {\r\n  private state: ConnectionState;\r\n  private unsubscribe$ = new Subject<void>();\r\n  ready = false;\r\n\r\n  @Input()\r\n  get source(): SearchSource {\r\n    return this._source;\r\n  }\r\n  set source(value: SearchSource) {\r\n    this._source = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() toolbox: Toolbox;\r\n\r\n  @Input()\r\n  get feature(): Feature {\r\n    return this._feature;\r\n  }\r\n  set feature(value: Feature) {\r\n    this._feature = value;\r\n    this.cdRef.detectChanges();\r\n    this.selectFeature.emit();\r\n  }\r\n\r\n  private _feature: Feature;\r\n  private _source: SearchSource;\r\n\r\n  @Output() routeEvent = new EventEmitter<boolean>();\r\n  @Output() selectFeature = new EventEmitter<boolean>();\r\n  @Output() htmlDisplayEvent = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.feature);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.feature) || 'link';\r\n  }\r\n\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef,\r\n    private sanitizer: DomSanitizer,\r\n    private networkService: NetworkService,\r\n    private messageService: MessageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.networkService.currentState().pipe(takeUntil(this.unsubscribe$)).subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.ready = true;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribe$.next();\r\n    this.unsubscribe$.complete();\r\n  }\r\n\r\n  urlSanitizer(value): SafeResourceUrl {\r\n    return this.sanitizer.bypassSecurityTrustResourceUrl(value);\r\n  }\r\n\r\n\r\n  isHtmlDisplay(): boolean {\r\n    if (this.feature && this.isObject(this.feature.properties) && this.feature.properties.target === 'iframe') {\r\n      this.htmlDisplayEvent.emit(true);\r\n      return true;\r\n    } else {\r\n      this.htmlDisplayEvent.emit(false);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  htmlSanitizer(value): SafeResourceUrl {\r\n    if (!value.body) {\r\n      return;\r\n    }\r\n    const regexBase = /<base href=\"[\\w:\\/\\.]+\">/;\r\n    if (!regexBase.test(value.body)) {\r\n      const url = new URL(value.url, window.location.origin);\r\n      value.body = value.body.replace('<head>', `<head><base href=\"${url.origin}\">`);\r\n    }\r\n\r\n    return this.sanitizer.bypassSecurityTrustHtml(value.body);\r\n  }\r\n\r\n  isObject(value) {\r\n    return typeof value === 'object';\r\n  }\r\n\r\n  openSecureUrl(value) {\r\n    let url: string;\r\n    const regexDepot = new RegExp(this.configService?.getConfig('depot.url') + '.*?(?=\"|$)');\r\n\r\n    if (regexDepot.test(value)) {\r\n      url = value.match(regexDepot)[0];\r\n\r\n      this.http.get(url, {\r\n        responseType: 'blob'\r\n      })\r\n      .subscribe((docOrImage) => {\r\n        const fileUrl = URL.createObjectURL(docOrImage);\r\n        window.open(fileUrl, '_blank');\r\n        this.cdRef.detectChanges();\r\n      },\r\n      (error: Error) => {\r\n        this.messageService.error('igo.geo.targetHtmlUrlUnauthorized', 'igo.geo.targetHtmlUrlUnauthorizedTitle');\r\n      });\r\n    } else {\r\n      let url = value;\r\n      if (this.isEmbeddedLink(value)) {\r\n        var div = document.createElement('div');\r\n        div.innerHTML = value;\r\n        url = div.children[0].getAttribute('href');\r\n      }\r\n      window.open(url, '_blank');\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      const regex = /^https?:\\/\\//;\r\n      return regex.test(value);\r\n    }\r\n  }\r\n\r\n  isDoc(value) {\r\n    if (typeof value === 'string') {\r\n      if (this.isUrl(value)) {\r\n        const regex = /(pdf|docx?|xlsx?)$/;\r\n        return regex.test(value.toLowerCase());\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  isImg(value) {\r\n    if (typeof value ==='string') {\r\n      if (this.isUrl(value)) {\r\n        const regex = /(jpe?g|png|gif)$/;\r\n        return regex.test(value.toLowerCase());\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  isEmbeddedLink(value) {\r\n    if (typeof value === 'string') {\r\n        const matchRegex = /<a/g;\r\n        const match = value.match(matchRegex) || [];\r\n        const count = match.length;\r\n        if (count === 1) {\r\n            return true;\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n  getEmbeddedLinkText(value) {\r\n    const regex = /(?:>).*?(?=<|$)/;\r\n    let text = value.match(regex)[0] as string;\r\n    text = text.replace(/>/g, '');\r\n    return text;\r\n  }\r\n\r\n  filterFeatureProperties(feature) {\r\n    const allowedFieldsAndAlias = feature.meta ? feature.meta.alias : undefined;\r\n    const properties = {};\r\n    let offlineButtonState;\r\n\r\n    if (this.map) {\r\n      this.map.forcedOffline$.pipe(takeUntil(this.unsubscribe$)).subscribe(state => {\r\n        offlineButtonState = state;\r\n      });\r\n    }\r\n\r\n    if (feature.properties && feature.properties.Route && this.toolbox && !this.toolbox.getTool('directions')) {\r\n      delete feature.properties.Route;\r\n    }\r\n\r\n    if (allowedFieldsAndAlias) {\r\n      Object.keys(allowedFieldsAndAlias).forEach(field => {\r\n        properties[allowedFieldsAndAlias[field]] = feature.properties[field];\r\n      });\r\n      return properties;\r\n    } else if (offlineButtonState !== undefined) {\r\n      if (!offlineButtonState) {\r\n        if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n          const excludeAttribute = feature.meta.excludeAttribute;\r\n          excludeAttribute.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      } else {\r\n        if (feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n        const excludeAttribute = feature.meta.excludeAttribute;\r\n        excludeAttribute.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n        const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n        excludeAttributeOffline.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      }\r\n    }\r\n    return feature.properties;\r\n  }\r\n\r\n  /**\r\n   * Copy the url to a clipboard\r\n   */\r\n  copyTextToClipboard(value: string): void {\r\n    const successful = Clipboard.copy(value);\r\n    if (successful) {\r\n      this.messageService.success('igo.geo.query.link.message');\r\n    }\r\n  }\r\n}\r\n","export enum GeometryType {\r\n    Point = 'Point',\r\n    LineString = 'LineString',\r\n    Polygon = 'Polygon',\r\n    Circle = 'Circle'\r\n}\r\n\r\nexport enum LabelType{\r\n    Coordinates = 'Coordinates',\r\n    Length = 'Length',\r\n    Area = 'Area',\r\n    Predefined = 'Predefined',\r\n    Custom = 'Custom'\r\n}\r\n\r\nexport enum CoordinatesUnit {\r\n    DecimalDegree = 'DD',\r\n    DegreesMinutesSeconds = 'DMS'\r\n\r\n}\r\n","export enum FontType {\r\n    Arial = 'Arial',\r\n    ArialBlack = 'Arial Black',\r\n    Verdana = 'Verdana',\r\n    Tahoma = 'Tahoma',\r\n    TrebuchetMS = 'Trebuchet MS',\r\n    Impact = 'Impact',\r\n    TimesNewRoman = 'Times New Roman',\r\n    Georgia = 'Georgia',\r\n    AmericanTypewriter = 'American Typewriter',\r\n    Courier = 'Courier',\r\n    LucidaConsole = 'Lucida Console',\r\n    BrushScriptMT = 'Brush Script MT',\r\n    ComicSansMS = 'Comic Sans MS'\r\n}\r\n","import OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport lineIntersect from '@turf/line-intersect';\r\nimport { lineString } from '@turf/helpers';\r\n\r\nimport {\r\n  GeometrySliceMultiPolygonError,\r\n  GeometrySliceLineStringError,\r\n  GeometrySliceTooManyIntersectionError\r\n } from './geometry.errors';\r\n\r\n/**\r\n * Create a default style for draw and modify interactions\r\n * @param color Style color (R, G, B)\r\n * @returns OL style\r\n */\r\nexport function createDrawInteractionStyle(color?: [number, number, number]): olstyle.Circle {\r\n  color = color || [0, 153, 255];\r\n  return new olstyle.Circle({\r\n    stroke: new olstyle.Stroke({\r\n      color: color.concat([1]),\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: color.concat([0.2])\r\n    }),\r\n    radius: 8\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for drawing a hole\r\n * @returns OL style\r\n */\r\nexport function createDrawHoleInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color:  [0, 153, 255, 1],\r\n      width: 2\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Slice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function sliceOlGeometry(\r\n  olGeometry: OlLineString | OlPolygon,\r\n  olSlicer: OlLineString\r\n): Array<OlLineString | OlPolygon> {\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return sliceOlPolygon(olGeometry, olSlicer);\r\n  } else if (olGeometry instanceof OlLineString) {\r\n    return sliceOlLineString(olGeometry, olSlicer);\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL LineString into one or more lines\r\n * @param olLineString OL line string\r\n * @param olSlicer Slicing line\r\n * @returns New OL line strings\r\n */\r\nexport function sliceOlLineString(olLineString: OlLineString, olSlicer: OlLineString): OlLineString[] {\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL Polygon into one or more polygons\r\n * @param olPolygon OL polygon\r\n * @param olSlicer Slicing line\r\n * @returns New OL polygons\r\n */\r\nexport function sliceOlPolygon(olPolygon: OlPolygon, olSlicer: OlLineString): OlPolygon[] {\r\n  if (olPolygon.getLinearRingCount() > 1) {\r\n    throw new GeometrySliceMultiPolygonError();\r\n  }\r\n\r\n  if (olSlicer.getCoordinates().length > 2) {\r\n    throw new GeometrySliceLineStringError();\r\n  }\r\n\r\n  const olGeoJSON = new OlGeoJSON();\r\n  const slicer = olGeoJSON.writeGeometryObject(olSlicer) as any;\r\n  const outerCoordinates = olPolygon.getLinearRing(0).getCoordinates();\r\n\r\n  const parts = [[], []];\r\n  let totalIntersectionCount = 0;\r\n  for (let i = 0, ii = outerCoordinates.length - 1; i < ii; i++) {\r\n    const segmentCoordinates = [outerCoordinates[i], outerCoordinates[i + 1]];\r\n    const segment = lineString(segmentCoordinates);\r\n    const intersections = lineIntersect(segment, slicer).features;\r\n\r\n    const intersectionCount = intersections.length;\r\n    totalIntersectionCount += intersectionCount;\r\n    if (intersectionCount > 1 || totalIntersectionCount > 2) {\r\n      throw new GeometrySliceTooManyIntersectionError();\r\n    }\r\n\r\n    parts[0].push(segmentCoordinates[0]);\r\n    if (intersectionCount === 1) {\r\n      const intersection = intersections[0].geometry.coordinates;\r\n      parts[0].push(intersection);\r\n      parts[1].push(intersection);\r\n      parts.reverse();\r\n    }\r\n  }\r\n\r\n  if (totalIntersectionCount <= 1) {\r\n    return [];\r\n  }\r\n\r\n  parts[0].push(parts[0][0]);\r\n  parts[1].push(parts[1][0]);\r\n\r\n  return [new OlPolygon([parts[0]]), new OlPolygon([parts[1]])];\r\n}\r\n\r\n/**\r\n * Splice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function addLinearRingToOlPolygon(olPolygon: OlPolygon, olLinearRing: OlLinearRing ) {\r\n  // TODO: make some validation and support updating an existing linear ring\r\n  olPolygon.appendLinearRing(olLinearRing);\r\n}\r\n\r\nexport function getMousePositionFromOlGeometryEvent(\r\n  olEvent: BasicEvent\r\n) {\r\n  const olGeometry = olEvent.target as OlGeometry;\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return olGeometry.getFlatCoordinates().slice(-4, -2) as [number, number];\r\n  }\r\n  const olGeometryCast = olGeometry as OlPoint | OlLineString | OlCircle;\r\n  return olGeometryCast.getFlatCoordinates().slice(-2) as [number, number];\r\n}\r\n","/* eslint-disable */\r\n// See this issue: https://github.com/Microsoft/TypeScript/issues/13965\r\n// And the solution: https://github.com/Microsoft/TypeScript/wiki/Breaking-Changes#extending-built-ins-like-error-array-and-map-may-no-longer-work\r\n// for an explanation as to why the prototype is set manually\r\n/* eslint-enable */\r\n\r\nexport class GeometrySliceError extends Error {}\r\n\r\nexport class GeometrySliceMultiPolygonError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice a MultiPolygon.');\r\n    Object.setPrototypeOf(this, GeometrySliceMultiPolygonError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceLineStringError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice with a line that has more than 2 points.');\r\n    Object.setPrototypeOf(this, GeometrySliceLineStringError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceTooManyIntersectionError extends GeometrySliceError {\r\n  constructor() {\r\n    super('More than 2 intersections found between the target polygon and the slicing line.');\r\n    Object.setPrototypeOf(this, GeometrySliceTooManyIntersectionError.prototype);\r\n  }\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlSelect from 'ol/interaction/Select';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { SelectEvent as OlSelectEvent } from 'ol/interaction/Select';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { doubleClick } from 'ol/events/condition';\r\n\r\nimport { Subject, Subscription, fromEvent, BehaviorSubject } from 'rxjs';\r\n\r\nimport { getMousePositionFromOlGeometryEvent } from '../geometry.utils';\r\n\r\nexport interface DrawControlOptions {\r\n  geometryType: Type | string;\r\n  drawingLayerSource?: OlVectorSource<OlGeometry>;\r\n  drawingLayer?: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  drawingLayerStyle?: OlStyleLike;\r\n  interactionStyle?: OlStyleLike;\r\n  maxPoints?: number;\r\n}\r\n\r\n/**\r\n * Control to draw entities\r\n */\r\nexport class DrawControl {\r\n  /**\r\n   * Draw start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw changes observable (while drawing)\r\n   */\r\n  public changes$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw modify observable (modify drawn features)\r\n   */\r\n  public modify$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw select observable (modify drawn features)\r\n   */\r\n  public select$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw abort observable (abort drawn features)\r\n   */\r\n  public abort$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Freehand mode observable (defaults to false)\r\n   */\r\n  freehand$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Observables from predefined radius (defaults to false and undefined)\r\n   */\r\n  ispredefinedRadius$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  predefinedRadius$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n  radiusDrawEnd$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n  private keyDown$$: Subscription;\r\n\r\n  private olGeometryType: typeof OlGeometry | undefined | string;\r\n  private olInteractionStyle: OlStyleLike;\r\n  private olMap: OlMap;\r\n  private olDrawingLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olDrawInteraction: OlDraw;\r\n  private olSelectInteraction: OlSelect;\r\n  private olModifyInteraction: OlModify;\r\n  private onDrawStartKey: EventsKey;\r\n  private onDrawEndKey: EventsKey;\r\n  private onDrawAbortKey: EventsKey;\r\n  private onDrawKey: EventsKey;\r\n  public radius: number;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  /**\r\n   * take the value of radius\r\n   */\r\n  get radiusVal(): number {\r\n    return this.predefinedRadius$.getValue();\r\n  }\r\n  set radiusValData(radiusCercle: number) {\r\n    this.predefinedRadius$.next(radiusCercle);\r\n  }\r\n\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olDrawingLayerSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayer.getSource();\r\n  }\r\n\r\n  constructor(private options: DrawControlOptions) {\r\n    this.olDrawingLayer = options.drawingLayer ? options.drawingLayer : this.createOlInnerOverlayLayer();\r\n    this.olGeometryType = this.options.geometryType;\r\n    this.olInteractionStyle = this.options.interactionStyle;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined, activateModifyAndSelect?: boolean) {\r\n    if (!olMap) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlInteractions();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n    this.addOlInteractions(activateModifyAndSelect);\r\n  }\r\n\r\n  /**\r\n   * Return the drawing layer source\r\n   */\r\n  getSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayerSource;\r\n\r\n  }\r\n\r\n  setOlInteractionStyle(style) {\r\n    this.olInteractionStyle = style;\r\n  }\r\n\r\n  /**\r\n   * Set the current geometry type\r\n   * @param geometryType the geometry type\r\n   */\r\n  setGeometryType(geometryType: Type) {\r\n    this.olGeometryType = geometryType;\r\n  }\r\n\r\n  /**\r\n   * Get the current geometry type\r\n   */\r\n  getGeometryType() {\r\n    return this.olGeometryType;\r\n  }\r\n\r\n  /**\r\n   * Create a drawing source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<OlVectorSource<OlGeometry>> {\r\n    return new OlVectorLayer({\r\n      source: this.options.drawingLayerSource ? this.options.drawingLayerSource : new OlVectorSource(),\r\n      style: this.options.drawingLayerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer && this.olMap) {\r\n      this.olMap.removeLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the drawing layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer) {\r\n      this.olMap.addLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (!this.options.drawingLayer && !this.options.drawingLayerSource) {\r\n      this.olDrawingLayerSource.clear(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add interactions to the map an set up some listeners\r\n   */\r\n  addOlInteractions(activateModifyAndSelect?: boolean) {\r\n    // Create Draw interaction\r\n    let olDrawInteraction;\r\n    if (!this.freehand$.getValue()) {\r\n      if (!this.ispredefinedRadius$.getValue()) {\r\n        olDrawInteraction = new OlDraw({\r\n          type: this.olGeometryType as Type,\r\n          source: this.getSource(),\r\n          stopClick: true,\r\n          style: this.olInteractionStyle,\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: false,\r\n          freehandCondition: () => false\r\n        });\r\n      } else {\r\n        olDrawInteraction = new OlDraw({\r\n          type: 'Point',\r\n          source: this.getSource(),\r\n          stopClick: true,\r\n          style: this.olInteractionStyle,\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: false,\r\n          freehandCondition: () => false\r\n        });\r\n      }\r\n\r\n    } else {\r\n      if (this.olGeometryType === 'Point') {\r\n        olDrawInteraction = new OlDraw({\r\n          type: 'Circle',\r\n          source: this.getSource(),\r\n          style: typeof this.olInteractionStyle === 'function' ? undefined : this.olInteractionStyle,\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      } else {\r\n        olDrawInteraction = new OlDraw({\r\n          type: this.olGeometryType as Type,\r\n          source: this.getSource(),\r\n          style: this.olInteractionStyle,\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      }\r\n    }\r\n\r\n    // Add Draw interaction to map and create listeners\r\n    this.olMap.addInteraction(olDrawInteraction);\r\n    this.olDrawInteraction = olDrawInteraction;\r\n    this.onDrawStartKey = olDrawInteraction.on('drawstart', (event: OlDrawEvent) => this.onDrawStart(event));\r\n    this.onDrawEndKey = olDrawInteraction.on('drawend', (event: OlDrawEvent) => this.onDrawEnd(event));\r\n    this.onDrawAbortKey = olDrawInteraction.on('drawabort', (event: OlDrawEvent) => this.abort$.next(event.feature.getGeometry()));\r\n\r\n    if (activateModifyAndSelect) {\r\n      // Create a Modify interaction, add it to map and create a listener\r\n      const olModifyInteraction = new OlModify({\r\n        source: this.getSource()\r\n      });\r\n\r\n      this.olMap.addInteraction(olModifyInteraction);\r\n      this.olModifyInteraction = olModifyInteraction;\r\n\r\n      // Create a select interaction and add it to map\r\n      if (!this.olSelectInteraction) {\r\n        const olSelectInteraction = new OlSelect({\r\n          condition: doubleClick,\r\n          style: undefined\r\n        });\r\n        this.olMap.addInteraction(olSelectInteraction);\r\n        this.olSelectInteraction = olSelectInteraction;\r\n\r\n        this.olSelectInteraction.on('select', (event: OlSelectEvent) => this.onSelect(event));\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove interactions\r\n   */\r\n  private removeOlInteractions() {\r\n    this.unsubscribeKeyDown();\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey, this.onDrawAbortKey]);\r\n\r\n    if (this.olMap) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n\r\n    this.olDrawInteraction = undefined;\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * When drawing starts, clear the overlay and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.clearOlInnerOverlaySource();\r\n    this.onDrawKey = olGeometry.on('change', (olGeometryEvent: BasicEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n    this.subscribeKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, update the drawing (feature) geometry observable and add\r\n   * @param event Draw event (drawend)\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    if (event.feature.getGeometry().getType() === 'Point') {\r\n      this.radiusDrawEnd$.next(this.predefinedRadius$.getValue());\r\n    }\r\n    this.unsubscribeKeyDown();\r\n    unByKey(this.onDrawKey);\r\n    const olGeometry = event.feature.getGeometry();\r\n    olGeometry.on('change', () => {\r\n      this.modify$.next(olGeometry);\r\n    });\r\n    this.end$.next(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * When a feature is selected, update the selected feature observable\r\n   * @param event Modify event (modifyend)\r\n   */\r\n  private onSelect(event: OlSelectEvent) {\r\n    if (event.selected.length === 1) {\r\n      this.select$.next(event.selected[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribe to key downs used as drawing interaction shorcuts\r\n   */\r\n  private subscribeKeyDown() {\r\n    this.unsubscribeKeyDown();\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      // On Escape or 'c' keydowns, abort the current drawing\r\n      if (event.key === 'Escape') {\r\n        this.olDrawInteraction.abortDrawing();\r\n        return;\r\n      }\r\n\r\n      // On Backspace or 'u' keydowns, remove last vertex of current drawing\r\n      if (event.key === 'Backspace') {\r\n        this.olDrawInteraction.removeLastPoint();\r\n      }\r\n\r\n      // On Enter or 'f' keydowns, finish current drawing\r\n      if (event.key === 'Enter') {\r\n        this.olDrawInteraction.finishDrawing();\r\n      }\r\n\r\n      // On space bar key down, pan to the current mouse position\r\n      if (event.key === ' ') {\r\n        this.olMap.getView().animate({\r\n          center: this.mousePosition,\r\n          duration: 100\r\n        });\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeKeyDown() {\r\n    if (this.keyDown$$) {\r\n      this.keyDown$$.unsubscribe();\r\n      this.keyDown$$ = undefined;\r\n    }\r\n  }\r\n}\r\n","\r\nexport const MEASURE_UNIT_AUTO = 'auto';\r\n\r\nexport enum MeasureType {\r\n  Length = 'length',\r\n  Area = 'area'\r\n}\r\n\r\nexport enum MeasureLengthUnit {\r\n  Meters = 'meters',\r\n  Kilometers = 'kilometers',\r\n  Miles = 'miles',\r\n  Feet = 'feet'\r\n}\r\n\r\nexport const MeasureLengthUnitAbbreviation = {\r\n  [MeasureLengthUnit.Meters]: 'm',\r\n  [MeasureLengthUnit.Kilometers]: 'km',\r\n  [MeasureLengthUnit.Miles]: 'mi',\r\n  [MeasureLengthUnit.Feet]: 'ft'\r\n};\r\n\r\nexport enum MeasureAreaUnit {\r\n  SquareMeters = 'squareMeters',\r\n  SquareKilometers = 'squareKilometers',\r\n  SquareMiles = 'squareMiles',\r\n  SquareFeet = 'squareFeet',\r\n  Hectares = 'hectares',\r\n  Acres = 'acres'\r\n}\r\n\r\nexport const MeasureAreaUnitAbbreviation = {\r\n  [MeasureAreaUnit.SquareMeters]: 'm²',\r\n  [MeasureAreaUnit.SquareKilometers]: 'km²',\r\n  [MeasureAreaUnit.SquareMiles]: 'mi²',\r\n  [MeasureAreaUnit.SquareFeet]: 'ft²',\r\n  [MeasureAreaUnit.Hectares]: 'ha',\r\n  [MeasureAreaUnit.Acres]: 'ac'\r\n};\r\n","import { LanguageService } from '@igo2/core';\r\nimport * as olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { getCenter as olGetCenter } from 'ol/extent';\r\nimport {\r\n  getLength as olGetLength,\r\n  getArea as olGetArea\r\n} from 'ol/sphere';\r\n\r\nimport { Measure } from './measure.interfaces';\r\nimport {\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation\r\n} from './measure.enum';\r\n\r\n/**\r\n * Convert value from meters to kilometers\r\n * @param value Value in meters\r\n * @returns Value in kilometers\r\n */\r\nexport function metersToKilometers(value: number): number {\r\n  return value * 0.001;\r\n}\r\n\r\n/**\r\n * Convert value from meters to feet\r\n * @param value Value in meters\r\n * @returns Value in feet\r\n */\r\nexport function metersToFeet(value: number): number {\r\n  return value * 3.2808;\r\n}\r\n\r\n/**\r\n * Convert value from meters to miles\r\n * @param value Value in meters\r\n * @returns Value in miles\r\n */\r\nexport function metersToMiles(value: number): number {\r\n  return value * 0.000621;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square kilometers\r\n * @param value Value in square meters\r\n * @returns Value in square kilometers\r\n */\r\nexport function squareMetersToSquareKilometers(value: number): number {\r\n  return value * 0.000001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square miles\r\n * @param value Value in square meters\r\n * @returns Value in square miles\r\n */\r\nexport function squareMetersToSquareMiles(value: number): number {\r\n  return value * 0.0000003861;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square feet\r\n * @param value Value in square meters\r\n * @returns Value in square feet\r\n */\r\nexport function squareMetersToSquareFeet(value: number): number {\r\n  return value * 10.764;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to hectares\r\n * @param value Value in square meters\r\n * @returns Value in hectares\r\n */\r\nexport function squareMetersToHectares(value: number): number {\r\n  return value * 0.0001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to acres\r\n * @param value Value in square meters\r\n * @returns Value in acres\r\n */\r\nexport function squareMetersToAcres(value: number): number {\r\n  return value * 0.00024711;\r\n}\r\n\r\n/**\r\n * Convert value from meters to the specified length unit\r\n * @param value Value in meters\r\n * @param unit Length unit\r\n * @returns Value in unit\r\n */\r\nexport function metersToUnit(value: number, unit: MeasureLengthUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureLengthUnit.Meters, (val: number) => val],\r\n    [MeasureLengthUnit.Kilometers, metersToKilometers],\r\n    [MeasureLengthUnit.Miles, metersToMiles],\r\n    [MeasureLengthUnit.Feet, metersToFeet],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to the specified area unit\r\n * @param value Value in meters\r\n * @param unit Area unit\r\n * @returns Value in unit\r\n */\r\nexport function squareMetersToUnit(value: number, unit: MeasureAreaUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureAreaUnit.SquareMeters, (val: number) => val],\r\n    [MeasureAreaUnit.SquareKilometers, squareMetersToSquareKilometers],\r\n    [MeasureAreaUnit.SquareMiles, squareMetersToSquareMiles],\r\n    [MeasureAreaUnit.SquareFeet, squareMetersToSquareFeet],\r\n    [MeasureAreaUnit.Hectares, squareMetersToHectares],\r\n    [MeasureAreaUnit.Acres, squareMetersToAcres],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * This method format a measure to a readable format\r\n * @param measure Measure\r\n * @param options Formatting options\r\n * @returns Formatted measure\r\n */\r\nexport function formatMeasure(\r\n  measure: number,\r\n  options?: {\r\n    decimal?: number;\r\n    unit?: MeasureAreaUnit | MeasureLengthUnit;\r\n    unitAbbr?: boolean;\r\n    locale?: string;\r\n  },\r\n  languageService?: LanguageService) {\r\n  let decimal = options.decimal;\r\n  if (decimal === undefined || decimal < 0) {\r\n    decimal = 1;\r\n  }\r\n\r\n  const parts = [];\r\n  if (options.locale !== undefined) {\r\n    parts.push(measure.toLocaleString(options.locale, {\r\n      minimumFractionDigits: decimal,\r\n      maximumFractionDigits: decimal\r\n    }));\r\n  } else {\r\n    parts.push(measure.toFixed(decimal).toString());\r\n  }\r\n\r\n  if (options.unit !== undefined && options.unitAbbr === true) {\r\n    if (languageService) {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] ?\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureLengthUnitAbbreviation[options.unit]) :\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureAreaUnitAbbreviation[options.unit])\r\n      );\r\n    } else {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] || MeasureAreaUnitAbbreviation[options.unit]\r\n      );\r\n    }\r\n  }\r\n\r\n  return parts.filter(p => p !== undefined).join(' ');\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestLengthUnit(value: number): MeasureLengthUnit {\r\n  let unit = MeasureLengthUnit.Meters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureLengthUnit.Kilometers];\r\n  while (converted > 1000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = metersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in square meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestAreaUnit(value: number): MeasureAreaUnit {\r\n  let unit = MeasureAreaUnit.SquareMeters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureAreaUnit.SquareKilometers];\r\n  while (converted > 1000000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = squareMetersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Create a default style for a measure interaction\r\n * @returns OL style\r\n */\r\nexport function createMeasureInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      lineDash: [10, 10],\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    }),\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new olstyle.Stroke({\r\n        color: '#ffcc33',\r\n      }),\r\n      fill: new olstyle.Fill({\r\n        color: 'rgba(255, 255, 255, 0.2)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for a measure layer\r\n * @returns OL style\r\n */\r\nexport function createMeasureLayerStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Compute the length in meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Length in meters\r\n */\r\nexport function measureOlGeometryLength(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetLength(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area in square meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Area in square meters\r\n */\r\nexport function measureOlGeometryArea(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint || olGeometry instanceof OlLineString) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetArea(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area (square meters), length (meters) and last length (meters)\r\n * of an OL geometry with a given projection.\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Computed measure\r\n */\r\nexport function measureOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): Measure {\r\n  const length = measureOlGeometryLength(olGeometry, projection);\r\n  const area = measureOlGeometryArea(olGeometry, projection);\r\n\r\n  const lengths = [];\r\n  const coordinates = olGeometry.getFlatCoordinates();\r\n  const coordinatesLength = coordinates.length;\r\n  for (let i = 0; i <= coordinatesLength - 4; i += 2) {\r\n    const olSegment = new OlLineString([\r\n      [coordinates[i], coordinates[i + 1]],\r\n      [coordinates[i + 2], coordinates[i + 3]]\r\n    ]);\r\n\r\n    lengths.push(measureOlGeometryLength(olSegment, projection));\r\n  }\r\n\r\n  return {\r\n    area,\r\n    length,\r\n    lengths\r\n  };\r\n}\r\n\r\n/**\r\n * Update an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nexport function updateOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n  } else {\r\n    olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n    // TODO: handle multi geometries\r\n    const coordinates = olGeometry.getFlatCoordinates();\r\n    const midpointsLength = olMidpoints.length;\r\n    for (let i = 0; i < midpointsLength; i++) {\r\n      const j = i * 2;\r\n      const olSegment = new OlLineString([\r\n        [coordinates[j], coordinates[j + 1]],\r\n        [coordinates[j + 2], coordinates[j + 3]]\r\n      ]);\r\n\r\n      const midpointCoordinate = olSegment.getCoordinateAt(0.5);\r\n      const olMidpoint = olMidpoints[i];\r\n      if (olMidpoint !== undefined) {\r\n        olMidpoint.setCoordinates(midpointCoordinate);\r\n      } else {\r\n        olMidpoints[i] = new OlPoint(midpointCoordinate);\r\n      }\r\n    }\r\n  }\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Clear an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n */\r\nexport function clearOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle) {\r\n  const olMidpoints = olGeometry.get('_midpoints') || [];\r\n  const midpointsLength = olMidpoints.length;\r\n  for (let i = 0; i < midpointsLength; i++) {\r\n    const olMidpoint = olMidpoints[i];\r\n    if (olMidpoint !== undefined) {\r\n      if (olMidpoint !== undefined) {\r\n        clearOlMidpointTooltip(olMidpoint);\r\n      }\r\n    }\r\n  }\r\n\r\n  olGeometry.set('_midpoints', undefined, true);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Return an array of  OL geometry midpoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nfunction getOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let expectedNumber;\r\n  if (olGeometry instanceof OlCircle) {\r\n    expectedNumber = 0;\r\n  } else {\r\n    expectedNumber = Math.max((olGeometry.getFlatCoordinates().length / 2) - 1, 0);\r\n  }\r\n  // TODO: This works but it's quite messy. If time permits,\r\n  // clean this. Maybe a Tooltip class could handle that\r\n  let olMidpoints = olGeometry.get('_midpoints');\r\n\r\n  if (olMidpoints === undefined) {\r\n    if (olGeometry instanceof OlPoint) {\r\n      olMidpoints = new Array(1);\r\n    } else {\r\n      olMidpoints = new Array(expectedNumber);\r\n    }\r\n    olGeometry.set('_midpoints', olMidpoints, true);\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === 0) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === olMidpoints.length) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber > olMidpoints.length) {\r\n    olMidpoints.push(...new Array(expectedNumber - olMidpoints.length));\r\n    return olMidpoints;\r\n  }\r\n\r\n  for (let i = expectedNumber; i < olMidpoints.length; i++) {\r\n    const olMidpoint = olMidpoints[expectedNumber];\r\n    if (olMidpoint !== undefined) {\r\n      clearOlMidpointTooltip(olMidpoint);\r\n    }\r\n  }\r\n  olMidpoints.splice(expectedNumber);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Remove an OL midpoint's tooltip from the map\r\n * @param olMidpoint OL Point\r\n */\r\nfunction clearOlMidpointTooltip(olMidpoint: OlPoint) {\r\n  const olTooltip = olMidpoint.get('_tooltip');\r\n  if (olTooltip !== undefined) {\r\n    const olMap = olTooltip.getMap();\r\n    if (olMap !== undefined) {\r\n      olMap.removeOverlay(olTooltip);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  let typeGeom = '';\r\n  if (olGeometry instanceof OlLineString) {\r\n  typeGeom = 'line-';\r\n  } else if (olGeometry instanceof OlPolygon) {\r\n    typeGeom = 'polygone-';\r\n    }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipAtPoint(olMidpoint, false, typeGeom);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n  return olMidpoints.map((olMidpoint: OlPoint) => {\r\n    return olMidpoint ? olMidpoint.get('_tooltip') : undefined;\r\n  });\r\n}\r\n\r\n/**\r\n * Update an OL geometry center and return it\r\n * @param olGeometry OL Geometry\r\n * @returns OL point\r\n */\r\nexport function updateOlGeometryCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint {\r\n  let olCenter = olGeometry.get('_center');\r\n  const centerCoordinate = olGetCenter(olGeometry.getExtent());\r\n  if (olCenter !== undefined) {\r\n    olCenter.setCoordinates(centerCoordinate);\r\n  } else {\r\n    olCenter = new OlPoint(centerCoordinate);\r\n    olGeometry.set('_center', olCenter);\r\n  }\r\n\r\n  return olCenter;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipAtPoint(olCenter, true);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = olGeometry.get('_center');\r\n  return olCenter ? olCenter.get('_tooltip') : undefined;\r\n}\r\n\r\n/**\r\n * Get all the tooltips of an OL geometry\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getTooltipsOfOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olTooltips = [].concat(getOlTooltipsAtMidpoints(olGeometry) || []);\r\n  const olCenterTooltip = getOlTooltipAtCenter(olGeometry);\r\n  if (olCenterTooltip !== undefined) {\r\n    olTooltips.push(olCenterTooltip);\r\n  }\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipAtPoint(olPoint: OlPoint, center: boolean = false, srcGeomType: string= ''): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: (center ?\r\n    [ 'igo-map-tooltip',\r\n      'igo-map-tooltip-measure', 'igo-map-tooltip-measure-area'] : ['igo-map-tooltip', 'igo-map-tooltip-measure',\r\n      `igo-map-tooltip-measure-${srcGeomType}segments`]).join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import * as Olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport {\r\n  updateOlGeometryMidpoints,\r\n  updateOlGeometryCenter\r\n} from '../../measure/shared/measure.utils';\r\nimport { CoordinatesUnit } from './draw.enum';\r\nimport { convertDDToDMS, roundCoordToString } from '../../map/shared/map.utils';\r\n\r\n\r\n/**\r\n * Create a default style\r\n * @param fillColor the fill color\r\n * @param strokeColor the stroke color\r\n * @param strokeWidth the stroke width\r\n * @param label a label\r\n * @returns OL style\r\n */\r\nexport function createInteractionStyle(fillColor?: string, strokeColor?: string, strokeWidth?: number, label?: string): Olstyle.Style {\r\n  return new Olstyle.Style({\r\n    stroke: new Olstyle.Stroke({\r\n      color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n      width: strokeWidth ? strokeWidth : 1\r\n    }),\r\n    fill: new Olstyle.Fill({\r\n      color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n    }),\r\n    image: new Olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new Olstyle.Stroke({\r\n        color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n        width: strokeWidth ? strokeWidth : 1\r\n      }),\r\n      fill: new Olstyle.Fill({\r\n        color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsDrawAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else if (olGeometry instanceof OlCircle) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getCenter());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else {\r\n    olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipDrawAtPoint(olMidpoint);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipDrawAtCenter(olGeometry: OlLineString | OlPolygon): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipDrawAtPoint(olCenter);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipDrawAtPoint(olPoint: OlPoint): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: [\r\n      'igo-map-tooltip',\r\n      'igo-map-tooltip-draw'\r\n    ].join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n\r\n\r\nexport function DDtoDMS(value: [number, number], unit: CoordinatesUnit): string[] | undefined {\r\n  const conversionMapper = new Map([\r\n    [CoordinatesUnit.DecimalDegree, (val: [number, number]) => {\r\n      if (typeof val[0] === 'number') {\r\n        return roundCoordToString(val, 5) as string[];\r\n      } else {\r\n        const numVal: [number, number] = [Number(val[0]), Number(val[1])];\r\n        return roundCoordToString(numVal, 5) as string[];\r\n      }\r\n    }],\r\n    [CoordinatesUnit.DegreesMinutesSeconds, (val: [number, number]) => convertDDToDMS(val, 2)]\r\n  ]);\r\n  let conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n\r\n","<div>\r\n  <h2 mat-dialog-title>\r\n    {{ 'igo.geo.draw.popupTitle' | translate }}\r\n  </h2>\r\n</div>\r\n\r\n\r\n<div class=\"geometry-type-toggle mat-typography\">\r\n  <mat-button-toggle-group\r\n    (change)=\"onLabelTypeChange($event.value)\" [value]=\"customOrPredefined\">\r\n    <mat-button-toggle [value]=\"labelType.Custom\" >\r\n      {{ 'igo.geo.draw.labelType.custom' | translate }}\r\n    </mat-button-toggle>\r\n    <mat-button-toggle [value]=\"labelType.Predefined\">\r\n      {{ 'igo.geo.draw.labelType.predefined' | translate }}\r\n    </mat-button-toggle>\r\n  </mat-button-toggle-group>\r\n</div>\r\n\r\n<div *ngIf=\"labelFlag !== labelType.Custom\">\r\n  <div>\r\n    <p class=\"mat-typography\">{{ 'igo.geo.draw.builtInInstructions' | translate }}</p>\r\n    <mat-radio-group *ngIf=\"olGeometryType !== 'Polygon'\" class=\"mat-typography\">\r\n      <mat-radio-button *ngFor=\"let option of arrayBuiltInType\" [value]=\"option.value\" [disabled]=\"optionAvailable(option.value)\" \r\n      (change)=\"onLabelTypeChange($event.value)\" [checked]=\"option.checked\">\r\n        {{getProperLengthLabel(option.value)}}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n    <ng-container class=\"mat-typography\" *ngIf=\"olGeometryType === 'Polygon'\">\r\n      <mat-checkbox\r\n        *ngFor=\"let option of arrayBuiltInType\"\r\n        class=\"mat-typography\"\r\n        [value]=\"option.value\"\r\n        [disabled]=\"optionAvailable(option.value)\"\r\n        (change)=\"onLabelTypeChange($event.source.value, $event.checked)\"\r\n        [checked]=\"option.checked\">\r\n        {{getProperLengthLabel(option.value)}}\r\n      </mat-checkbox>\r\n    </ng-container>\r\n    <div *ngIf=\"labelFlag === labelType.Coordinates\">\r\n      <mat-form-field class=\"readOnly-Input\">\r\n        <input\r\n          #input\r\n          matInput\r\n          placeholder=\"(Latitude, Longitude)\"\r\n          value=\"{{currentCoordinates}}\" readonly>\r\n      </mat-form-field>\r\n      <mat-form-field class=\"unit-field\">\r\n        <mat-select [value]=\"coordinatesMeasureUnit\" (selectionChange)=\"onChangeCoordinateUnit($event.value)\">\r\n          <mat-option *ngFor=\"let unit of allCoordinatesUnits\" [value]=\"unit\">\r\n            {{unit}}\r\n          </mat-option>\r\n        </mat-select>  \r\n      </mat-form-field>\r\n    </div>\r\n    <div *ngIf=\"labelFlag === labelType.Length || polygonCheck === 2\">\r\n      <mat-form-field class=\"readOnly-Input\">\r\n        <input\r\n          #input\r\n          matInput\r\n          placeholder={{lengthLabelT}}\r\n          value=\"{{currentLength}}\" readonly>\r\n      </mat-form-field>\r\n      <mat-form-field class=\"unit-field\">\r\n        <mat-select [value]=\"lengthMeasureUnit\" (selectionChange)=\"onChangeLengthUnit($event.value)\">\r\n          <mat-option *ngFor=\"let unit of allLengthUnits\" [value]=\"unit\">\r\n            {{getLengthUnitEnum(unit)}}\r\n          </mat-option>\r\n        </mat-select>  \r\n      </mat-form-field>\r\n    </div>\r\n    <div *ngIf=\"labelFlag === labelType.Area || polygonCheck === 2\">\r\n      <mat-form-field class=\"readOnly-Input\">\r\n        <input\r\n          #input\r\n          matInput\r\n          placeholder=\"{{ 'igo.geo.draw.labelType.Area' | translate }}\"\r\n          value=\"{{currentArea}}\" readonly>\r\n      </mat-form-field>\r\n      <mat-form-field class=\"unit-field\">\r\n        <mat-select [value]=\"areaMeasureUnit\" (selectionChange)=\"onChangeAreaUnit($event.value)\">\r\n          <mat-option *ngFor=\"let unit of allAreaUnits\" [value]=\"unit\">\r\n            {{getAreaUnitEnum(unit)}}\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n\r\n\r\n  <div mat-dialog-actions>\r\n    <button mat-raised-button (click)=\"cancelDrawing()\" >\r\n      {{'igo.geo.draw.cancel' | translate}}\r\n    </button>\r\n    <button \r\n      mat-raised-button \r\n      color=\"primary\" \r\n      (click)=\"confirm()\"> \r\n      {{noLabelButton()}} \r\n    </button>\r\n  </div>\r\n</div>\r\n\r\n<div *ngIf=\"labelFlag === labelType.Custom\">\r\n  <div>\r\n    <p class=\"mat-typography\">{{ 'igo.geo.draw.dialogInstruction' | translate }}</p>\r\n    <mat-form-field class=\"input\">\r\n      <input\r\n        #input\r\n        matInput\r\n        (select)=\"true\"\r\n        (input)=\"getLabelLength($event.target.value)\"\r\n        placeholder=\"{{'igo.geo.draw.dialogTitle' | translate}}\"\r\n        value=\"{{ currentLabel }}\"\r\n        cdkFocusInitial/>\r\n    </mat-form-field>\r\n  </div>\r\n  \r\n  <div mat-dialog-actions>\r\n    <button mat-raised-button (click)=\"cancelDrawing()\" >\r\n      {{'igo.geo.draw.cancel' | translate}}\r\n    </button>\r\n    <button \r\n      mat-raised-button \r\n      color=\"primary\" \r\n      (click)=\"confirm(input.value)\">\r\n      {{noLabelButton()}}\r\n    </button>\r\n  </div>\r\n</div>\r\n","import { Component, Inject, Input } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { CoordinatesUnit, GeometryType, LabelType } from '../shared/draw.enum';\r\nimport { transform } from 'ol/proj';\r\nimport { IgoMap, roundCoordTo } from '../../map/shared';\r\nimport OlFeature from 'ol/Feature';\r\nimport {\r\n  measureOlGeometryLength,\r\n  measureOlGeometryArea,\r\n  metersToUnit,\r\n  squareMetersToUnit\r\n} from '../../measure/shared/measure.utils';\r\nimport {\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation,\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n} from '../../measure/shared/measure.enum';\r\n\r\nimport {fromCircle} from 'ol/geom/Polygon';\r\nimport { getLength } from 'ol/sphere';\r\nimport Circle from 'ol/geom/Circle';\r\nimport { DDtoDMS } from '../shared/draw.utils';\r\n\r\n\r\n@Component({\r\n  selector: 'igo-draw-popup-component',\r\n  templateUrl: './draw-popup.component.html',\r\n  styleUrls: ['./draw-popup.component.scss']\r\n  })\r\nexport class DrawPopupComponent {\r\n  @Input() confirmFlag: boolean = false;\r\n  @Input() labelFlag: LabelType | [LabelType, LabelType] = LabelType.Custom;\r\n  @Input() coordinatesMeasureUnit: CoordinatesUnit;\r\n  @Input() lengthMeasureUnit: MeasureLengthUnit;\r\n  @Input() areaMeasureUnit: MeasureAreaUnit;\r\n\r\n  public geometryType = GeometryType;\r\n  public labelType = LabelType;\r\n  public arrayBuiltInType: any[] = [];\r\n\r\n  public currentLabel: string;\r\n  public currentCoordinates: string;\r\n  public currentArea: string;\r\n  public currentLength: string;\r\n\r\n  public olGeometryType: GeometryType = undefined;\r\n  public lengthInMeters: string;\r\n  public areaInMetersSquare: string;\r\n  public coordinatesInDD: string;\r\n  public currentCoordinatesUnit: string;\r\n\r\n  private longlatDD: [number, number];\r\n  private labelLength: number;\r\n\r\n  public polygonCheck = 0; // Count for polygon label types checkboxes\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    public dialogRef: MatDialogRef<DrawPopupComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: { olGeometry: any, map: IgoMap }\r\n    ) {\r\n      this.currentLabel = this.data.olGeometry.get('draw');\r\n      this.labelLength = this.currentLabel ? this.currentLabel.length: 0;\r\n      let olGeometry;\r\n\r\n      const projection = this.data.map.ol.getView().getProjection();\r\n\r\n      if(this.data.olGeometry instanceof OlFeature) {\r\n        if (this.data.olGeometry.get('rad')){\r\n          const longitudeLatitude = [this.data.olGeometry.get('longitude'), this.data.olGeometry.get('latitude')];\r\n          this.olGeometryType = GeometryType.Circle;\r\n          olGeometry = new Circle(longitudeLatitude, this.data.olGeometry.get('rad'));\r\n        }\r\n        else{\r\n          this.olGeometryType = this.data.olGeometry.getGeometry().getType();\r\n          olGeometry = this.data.olGeometry.get('geometry');\r\n        }\r\n      }\r\n      else{\r\n        this.olGeometryType = this.data.olGeometry.getType();\r\n        olGeometry = this.data.olGeometry;\r\n      }\r\n\r\n      if (this.olGeometryType === GeometryType.Point || this.olGeometryType === GeometryType.Circle){\r\n        if(this.data.olGeometry instanceof OlFeature){\r\n          let longitude = this.data.olGeometry.get('longitude');\r\n          let latitude = this.data.olGeometry.get('latitude');\r\n          this.longlatDD = roundCoordTo([longitude, latitude], 5);\r\n          this.coordinatesInDD = '(' + latitude + ', '\r\n          + longitude + ')';\r\n        }\r\n        else {\r\n          let point4326 = transform(\r\n            this.data.olGeometry.getFlatCoordinates(),\r\n            projection,\r\n            'EPSG:4326'\r\n          );\r\n          this.longlatDD = roundCoordTo([point4326[0], point4326[1]], 5);\r\n          this.coordinatesInDD =\r\n            '(' + this.longlatDD[1] + ', ' + this.longlatDD[0] + ')';\r\n        }\r\n        this.currentCoordinates = this.coordinatesInDD;\r\n      }\r\n      if (this.olGeometryType === GeometryType.LineString){\r\n        this.lengthInMeters = measureOlGeometryLength(olGeometry, projection.getCode()).toFixed(2);\r\n        this.currentLength = this.lengthInMeters;\r\n      }\r\n      else if (this.olGeometryType === GeometryType.Polygon){\r\n        this.lengthInMeters = measureOlGeometryLength(olGeometry, projection.getCode()).toFixed(2);\r\n        this.currentLength = this.lengthInMeters;\r\n        this.areaInMetersSquare = measureOlGeometryArea(olGeometry,projection.getCode()).toFixed(2);\r\n        this.currentArea = this.areaInMetersSquare;\r\n      }\r\n      else if(this.olGeometryType === GeometryType.Circle){\r\n        let circularPolygon = fromCircle(olGeometry, 10000);\r\n        const radius = this.getRadius(circularPolygon);\r\n        this.lengthInMeters = radius.toFixed(2);\r\n        this.currentLength = this.lengthInMeters;\r\n        this.areaInMetersSquare = measureOlGeometryArea(circularPolygon,projection.getCode()).toFixed(2);\r\n        this.currentArea = this.areaInMetersSquare;\r\n      }\r\n\r\n      if (data.olGeometry.get('labelType') === LabelType.Coordinates) {\r\n        this.onLabelTypeChange(LabelType.Predefined);\r\n        this.onLabelTypeChange(LabelType.Coordinates, true);\r\n        this.coordinatesMeasureUnit = data.olGeometry.get('measureUnit');\r\n      } else if (data.olGeometry.get('labelType') === LabelType.Length) {\r\n        this.onLabelTypeChange(LabelType.Predefined);\r\n        this.onLabelTypeChange(LabelType.Length, true);\r\n        this.lengthMeasureUnit = data.olGeometry.get('measureUnit');\r\n      } else if (data.olGeometry.get('labelType') === LabelType.Area) {\r\n        this.onLabelTypeChange(LabelType.Predefined);\r\n        this.onLabelTypeChange(LabelType.Area, true);\r\n        this.areaMeasureUnit = data.olGeometry.get('measureUnit');\r\n      } else if (data.olGeometry.get('labelType')?.length === 2) {\r\n        this.onLabelTypeChange(LabelType.Predefined);\r\n        this.onLabelTypeChange(LabelType.Length, true);\r\n        this.onLabelTypeChange(LabelType.Area, true);\r\n        this.lengthMeasureUnit = data.olGeometry.get('measureUnit')[0];\r\n        this.areaMeasureUnit = data.olGeometry.get('measureUnit')[1];\r\n      }\r\n      this.buildArrayType();\r\n    }\r\n\r\n  /**\r\n   * HTML Interactions\r\n   */\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  confirm(input?: string) {\r\n    this.confirmFlag = true;\r\n    if(this.labelFlag === LabelType.Predefined){\r\n      this.dialogRef.close();\r\n    }\r\n    else if (this.labelFlag === LabelType.Custom){\r\n      this.dialogRef.close({\r\n        label: input\r\n      });\r\n    }\r\n    else if(this.labelFlag === LabelType.Coordinates){\r\n      this.dialogRef.close({\r\n        label: this.currentCoordinates,\r\n        measureUnit: this.coordinatesMeasureUnit\r\n      });\r\n    }\r\n    else if (this.olGeometryType === GeometryType.Polygon) {\r\n      if (this.polygonCheck === 2) {\r\n        this.labelFlag = [LabelType.Length, LabelType.Area];\r\n        this.dialogRef.close({\r\n          label: 'P: ' + this.currentLength + ' ' + MeasureLengthUnitAbbreviation[MeasureLengthUnit.Meters] + '\\n'\r\n          + this.languageService.translate.instant('igo.geo.draw.labelType.A') + this.currentArea + ' ' +\r\n          MeasureAreaUnitAbbreviation[MeasureAreaUnit.SquareMeters], measureUnit: [this.lengthMeasureUnit, this.areaMeasureUnit]\r\n        });\r\n      } else {\r\n        this.labelFlag === LabelType.Length ?\r\n        this.dialogRef.close({\r\n          label: 'P: ' + this.currentLength + ' ' + MeasureLengthUnitAbbreviation[this.lengthMeasureUnit],\r\n          measureUnit: this.lengthMeasureUnit\r\n        }) :\r\n        this.dialogRef.close({\r\n          label: this.currentArea + ' ' + MeasureAreaUnitAbbreviation[this.areaMeasureUnit],\r\n          measureUnit: this.areaMeasureUnit\r\n        });\r\n      }\r\n    }\r\n    else if (this.labelFlag === LabelType.Length){\r\n      if (this.olGeometryType === GeometryType.Circle){\r\n        this.dialogRef.close({\r\n          label: 'R: ' + this.currentLength + ' ' + MeasureLengthUnitAbbreviation[this.lengthMeasureUnit],\r\n          measureUnit: this.lengthMeasureUnit\r\n        });\r\n      }\r\n      else if (this.olGeometryType === GeometryType.LineString) {\r\n        this.dialogRef.close({\r\n          label: this.currentLength + ' ' + MeasureLengthUnitAbbreviation[this.lengthMeasureUnit],\r\n          measureUnit: this.lengthMeasureUnit\r\n        });\r\n      }\r\n    }\r\n    else if (this.labelFlag === LabelType.Area){\r\n      this.dialogRef.close({\r\n        label: this.currentArea + ' ' + MeasureAreaUnitAbbreviation[this.areaMeasureUnit],\r\n        measureUnit: this.areaMeasureUnit\r\n      });\r\n    }\r\n  }\r\n\r\n  onLabelTypeChange(labelType: LabelType, checked?: boolean){\r\n    if (labelType !== LabelType.Predefined &&\r\n      labelType !== LabelType.Custom &&\r\n      this.olGeometryType === GeometryType.Polygon) {\r\n        this.arrayBuiltInType.find(type => type.value === labelType) ?\r\n          this.arrayBuiltInType.find(type => type.value === labelType).checked = checked : this.labelFlag = undefined;\r\n        checked ? this.labelFlag = labelType : this.labelFlag = this.arrayBuiltInType.find(type => type.checked)?.value;\r\n    } else {\r\n      this.labelFlag = labelType;\r\n    }\r\n\r\n    if (labelType === LabelType.Predefined){\r\n      if (this.olGeometryType === GeometryType.Point ){\r\n        this.labelFlag = LabelType.Coordinates;\r\n        this.currentCoordinates = this.coordinatesInDD;\r\n        this.coordinatesMeasureUnit = CoordinatesUnit.DecimalDegree;\r\n      }\r\n      else if (this.olGeometryType === GeometryType.LineString){\r\n        this.labelFlag = LabelType.Length;\r\n        this.currentLength = this.lengthInMeters;\r\n        this.lengthMeasureUnit = MeasureLengthUnit.Meters;\r\n      }\r\n    }\r\n    else if (labelType === LabelType.Area){\r\n      this.currentArea = this.areaInMetersSquare;\r\n      this.areaMeasureUnit = MeasureAreaUnit.SquareMeters;\r\n    }\r\n    else if (labelType === LabelType.Length){\r\n      this.currentLength = this.lengthInMeters;\r\n      this.lengthMeasureUnit = MeasureLengthUnit.Meters;\r\n    }\r\n    else if (this.labelFlag === LabelType.Coordinates){\r\n      this.currentCoordinates = this.coordinatesInDD;\r\n      this.coordinatesMeasureUnit = CoordinatesUnit.DecimalDegree;\r\n    }\r\n\r\n    const labeltypes = [this.labelType.Length, this.labelType.Area];\r\n    if (\r\n      this.olGeometryType === GeometryType.Polygon &&\r\n      labeltypes.includes(labelType)) {\r\n      checked ? this.polygonCheck += 1 : this.polygonCheck -= 1;;\r\n    } else {\r\n      this.polygonCheck = 0;\r\n    }\r\n  }\r\n\r\n  onChangeLengthUnit(lengthUnit: MeasureLengthUnit){\r\n    this.lengthMeasureUnit = lengthUnit;\r\n    this.currentLength = metersToUnit(Number(this.lengthInMeters), lengthUnit).toFixed(2);\r\n  }\r\n\r\n  onChangeAreaUnit(areaUnit: MeasureAreaUnit){\r\n    this.areaMeasureUnit = areaUnit;\r\n    this.currentArea = squareMetersToUnit(Number(this.areaInMetersSquare), areaUnit).toFixed(2);\r\n  }\r\n\r\n  onChangeCoordinateUnit(coordinatesUnit: CoordinatesUnit){\r\n    this.coordinatesMeasureUnit = coordinatesUnit;\r\n    let coordinates = DDtoDMS(this.longlatDD, coordinatesUnit);\r\n    this.currentCoordinates = '(' + coordinates[1] + ', ' + coordinates[0] + ')';\r\n  }\r\n\r\n  buildArrayType() {\r\n    for (const labelType of Object.values(LabelType)){\r\n      if (labelType !== LabelType.Custom && labelType !== LabelType.Predefined){\r\n        this.arrayBuiltInType.push({\r\n          value: labelType,\r\n          checked:\r\n            this.selectOptions(labelType) ||\r\n            this.labelFlag === labelType ||\r\n            (this.polygonCheck === 2 && labelType !== LabelType.Coordinates)\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  noLabelButton(){\r\n    if (this.labelFlag === LabelType.Predefined || (this.labelFlag === LabelType.Custom && this.labelLength === 0)){\r\n      return this.languageService.translate.instant('igo.geo.draw.noLabel');\r\n    }\r\n\r\n    return 'OK';\r\n  }\r\n\r\n  get customOrPredefined(){\r\n    if (this.labelFlag === LabelType.Custom){\r\n      return LabelType.Custom;\r\n    }\r\n    return LabelType.Predefined;\r\n  }\r\n\r\n  optionAvailable(currentOption: LabelType){\r\n    switch(this.olGeometryType){\r\n      case GeometryType.Point:\r\n        if (currentOption === LabelType.Coordinates){\r\n          return false;\r\n        }\r\n        return true;\r\n      case GeometryType.LineString:\r\n        if (currentOption === LabelType.Length){\r\n          return false;\r\n        }\r\n        return true;\r\n      case GeometryType.Polygon:\r\n        if (currentOption === LabelType.Coordinates){\r\n          return true;\r\n        }\r\n        return false;\r\n      default:\r\n        return false;\r\n    }\r\n  }\r\n\r\n  get allLengthUnits(): string[]{\r\n    return Object.values(MeasureLengthUnit);\r\n  }\r\n\r\n  getLengthUnitEnum(lengthUnit: MeasureLengthUnit){\r\n    return MeasureLengthUnitAbbreviation[lengthUnit];\r\n  }\r\n\r\n  get allAreaUnits(): string[]{\r\n    return Object.values(MeasureAreaUnit);\r\n  }\r\n\r\n  get allCoordinatesUnits(): string[]{\r\n    return Object.values(CoordinatesUnit);\r\n  }\r\n\r\n  getAreaUnitEnum(areaUnit: MeasureAreaUnit){\r\n    return MeasureAreaUnitAbbreviation[areaUnit];\r\n  }\r\n\r\n  private getRadius(olGeometry): number{\r\n    const length = getLength(olGeometry);\r\n    return Number(length / (2 * Math.PI));\r\n  }\r\n\r\n  get lengthLabelT(){\r\n    if (this.olGeometryType === GeometryType.Polygon){\r\n      return this.languageService.translate.instant('igo.geo.measure.perimeter');\r\n    }\r\n    if (this.olGeometryType === GeometryType.Circle){\r\n      return this.languageService.translate.instant('igo.geo.search.coordinates.radius');\r\n    }\r\n    return this.languageService.translate.instant('igo.geo.draw.labelType.Length');\r\n  }\r\n\r\n  getLabelLength(event?){\r\n    this.labelLength = event.length;\r\n  }\r\n\r\n  selectOptions(option){\r\n    if (this.olGeometryType === GeometryType.Point){\r\n      return option === LabelType.Coordinates;\r\n    }\r\n    else if (this.olGeometryType === GeometryType.LineString){\r\n      return option === LabelType.Length;\r\n    }\r\n  }\r\n\r\n  getProperLengthLabel(option){\r\n    if (option === LabelType.Length){\r\n      if (this.olGeometryType === GeometryType.Polygon){\r\n        return this.languageService.translate.instant('igo.geo.measure.perimeter');\r\n      }\r\n      if (this.olGeometryType === GeometryType.Circle){\r\n        return this.languageService.translate.instant('igo.geo.search.coordinates.radius');\r\n      }\r\n      return this.languageService.translate.instant('igo.geo.draw.labelType.Length');\r\n    }\r\n    return this.languageService.translate.instant('igo.geo.draw.labelType.' + option);\r\n  }\r\n\r\n\r\n}\r\n","import { Component } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-draw-shorcuts',\r\n  templateUrl: './draw-shorcuts.component.html',\r\n  styleUrls: ['./draw-shorcuts.component.scss']\r\n})\r\n\r\nexport class DrawShorcutsComponent {}\r\n","<mat-dialog-content>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-return\"></mat-icon>{{'igo.geo.draw.finish' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"backspace-outline\"></mat-icon>{{'igo.geo.draw.undo' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-esc\"></mat-icon>{{'igo.geo.draw.abort' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-space\"></mat-icon>{{'igo.geo.draw.move' | translate}}</span>\r\n  </div>\r\n</mat-dialog-content>\r\n<mat-dialog-actions class=\"shortcuts-close\">\r\n  <button mat-raised-button mat-dialog-close color=\"primary\">OK</button>\r\n</mat-dialog-actions>","import { Injectable } from '@angular/core';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { ProjectionLike, transform } from 'ol/proj';\r\nimport { FontType } from '../shared/font.enum';\r\n\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DrawStyleService {\r\n  private fillColor = 'rgba(255,255,255,0.4)';\r\n  private strokeColor = 'rgba(143,7,7,1)';\r\n  private strokeWidth: number = 1;\r\n  private labelsAreShown = true;\r\n  private icon: string;\r\n  private fontSize: string = '15';\r\n  private fontStyle: string = FontType.Arial.toString();\r\n  private offsetX: number = 0;\r\n  private offsetY: number = 0;\r\n\r\n  constructor() {}\r\n\r\n  getFillColor(): string {\r\n    return this.fillColor;\r\n  }\r\n\r\n  setFillColor(fillColor: string) {\r\n    this.fillColor = fillColor;\r\n  }\r\n\r\n  getStrokeColor(): string {\r\n    return this.strokeColor;\r\n  }\r\n\r\n  setStrokeColor(strokeColor: string) {\r\n    this.strokeColor = strokeColor;\r\n  }\r\n\r\n  getStrokeWidth(): number {\r\n    return this.strokeWidth;\r\n  }\r\n\r\n  getLabelsAreShown() {\r\n    return this.labelsAreShown;\r\n  }\r\n\r\n  toggleLabelsAreShown() {\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n  }\r\n\r\n  setIcon(icon: string) {\r\n    this.icon = icon;\r\n  }\r\n\r\n  getIcon() {\r\n    return this.icon;\r\n  }\r\n\r\n  // To edit the label of drawing\r\n  getFontSize() {\r\n    return this.fontSize;\r\n  }\r\n\r\n  setFontSize(fontSize: string) {\r\n    this.fontSize = fontSize;\r\n  }\r\n\r\n  getFontStyle() {\r\n    return this.fontStyle;\r\n  }\r\n\r\n  setFontStyle(fontStyle: string) {\r\n    this.fontStyle = fontStyle;\r\n  }\r\n\r\n  getOffsetX(): number {\r\n    return this.offsetX;\r\n  }\r\n\r\n  setOffsetX(offsetX: number) {\r\n    this.offsetX = offsetX;\r\n  }\r\n\r\n  getOffsetY(): number {\r\n    return this.offsetY;\r\n  }\r\n\r\n  setOffsetY(offsetY: number) {\r\n    this.offsetY = offsetY;\r\n  }\r\n\r\n  createIndividualElementStyle(\r\n    feature,\r\n    resolution,\r\n    labelsAreShown: boolean,\r\n    fontSizeAndStyle: string,\r\n    fillColor: string,\r\n    strokeColor: string,\r\n    offsetX: number,\r\n    offsetY: number,\r\n    proj: ProjectionLike,\r\n    icon?: string\r\n  ): OlStyle.Style {\r\n    let style;\r\n    let labelsAreOffset: boolean = false;\r\n    const geom = feature.getGeometry();\r\n\r\n    if (geom instanceof OlPoint) {\r\n      labelsAreOffset = !labelsAreOffset;\r\n    }\r\n\r\n    // if feature is a circle\r\n    if (feature.get('rad')) {\r\n      const coordinates = transform(feature.getGeometry().flatCoordinates, proj, 'EPSG:4326');\r\n\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n          offsetX: offsetX,\r\n          offsetY: offsetY\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: feature.get('rad') / Math.cos((Math.PI / 180) * coordinates[1]) / resolution,\r\n          stroke: new OlStyle.Stroke({\r\n            color: strokeColor ? strokeColor : this.strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n\r\n      // if feature is an icon\r\n    } else if (icon) {\r\n      this.offsetY = -26;\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n          offsetX: offsetX,\r\n          offsetY: offsetY\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill: new OlStyle.Fill({\r\n          color: fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Icon({\r\n          src: icon\r\n        })\r\n      });\r\n      return style;\r\n\r\n      // if feature is a point, a linestring or a polygon\r\n    } else {\r\n      this.offsetY = labelsAreOffset ? -15 : 0;\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n\r\n          offsetX: offsetX,\r\n          offsetY: offsetY\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill: new OlStyle.Fill({\r\n          color: fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: 5,\r\n          stroke: new OlStyle.Stroke({\r\n            color: strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n    }\r\n  }\r\n}\r\n","<div mat-dialog-content>\r\n  <h2 mat-dialog-title class=\"mat-typography\">{{ 'igo.geo.style.styleModal' | translate }}</h2>\r\n  <div\r\n  class=\"edition-drawing mat-typography\"\r\n  [hidden]=\"data.features.length === 0\">\r\n    <form\r\n      class=\"igo-form\"\r\n      [formGroup]=\"form\">\r\n      <div class=\"fill-color-picker mat-typography\" *ngIf=\"linestringOnly !== true\">\r\n        <span>\r\n          <mat-icon class=\"stroke-palette-icon\" svgIcon=\"square\"></mat-icon>\r\n          {{ 'igo.geo.style.fill' | translate }}\r\n        </span>\r\n\r\n        <mat-form-field\r\n          class=\"fill-field\"\r\n          appearance=\"outline\"\r\n          floatLabel=\"always\"\r\n          tooltip-position=\"below\"\r\n          matTooltipShowDelay=\"500\"\r\n          [matTooltip]=\"'igo.geo.style.colorPicker' | translate\">\r\n          <mat-label>{{ getFeatureFillColor() }}</mat-label>\r\n          <input\r\n            #fillColorInput\r\n            formControlName=\"fill\"\r\n            matInput\r\n            type=\"text\"\r\n            [style.background]=\"getFeatureFillColor()\"\r\n            [readonly]=\"true\"\r\n            [colorPicker]=\"getFeatureFillColor()\"\r\n            [cpWidth]=\"'200px'\"\r\n            [cpOutputFormat]=\"'rgba'\"\r\n            [cpPosition]=\"'bottom'\"\r\n            [cpPositionOffset]=\"'-75%'\"\r\n            [cpCancelButton]=\"true\"\r\n            [cpCancelButtonText]=\"'igo.geo.style.cancel' | translate\"\r\n            [cpOKButton]=\"true\"\r\n            (colorPickerChange)=\"styleModalData.fillColor = $event\">\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"stroke-color-picker mat-typography\">\r\n        <span>\r\n          <mat-icon\r\n            class=\"stroke-palette-icon\"\r\n            svgIcon=\"square-outline\">\r\n          </mat-icon>\r\n          {{'igo.geo.style.stroke' | translate}}\r\n        </span>\r\n\r\n        <mat-form-field\r\n          class=\"stroke-field\"\r\n          appearance=\"outline\"\r\n          floatLabel=\"always\"\r\n          tooltip-position=\"below\"\r\n          matTooltipShowDelay=\"500\"\r\n          [matTooltip]=\"'igo.geo.style.colorPicker' | translate\">\r\n          <mat-label>{{ getFeatureStrokeColor() }}</mat-label>\r\n          <input\r\n            #strokeColorInput\r\n            formControlName=\"stroke\"\r\n            matInput\r\n            type=\"text\"\r\n            [style.background]=\"getFeatureStrokeColor()\"\r\n            [readonly]=\"true\"\r\n            [colorPicker]=\"getFeatureStrokeColor()\"\r\n            [cpWidth]=\"'200px'\"\r\n            [cpPosition]=\"'bottom'\"\r\n            [cpPositionOffset]=\"'-75%'\"\r\n            [cpOutputFormat]=\"'rgba'\"\r\n            [cpCancelButton]=\"true\"\r\n            [cpCancelButtonText]=\"'igo.geo.style.cancel' | translate\"\r\n            [cpOKButton]=\"true\"\r\n            (colorPickerChange)=\"styleModalData.strokeColor = $event\">\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"igo-input-container\">\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.style.fontSize' | translate }}</mat-label>\r\n          <input\r\n            matInput\r\n            #testFontSize\r\n            type=\"number\"\r\n            placeholder=\"10\"\r\n            min=\"10\"\r\n            onkeydown=\"return event.keyCode !== 69\"\r\n            [value]=\"getFeatureFontSize()\"\r\n            (input)=\"styleModalData.fontSize = $event.target.value\">\r\n          <span matSuffix>px</span>\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.style.fontStyle' | translate }}</mat-label>\r\n          <mat-select\r\n            #testFontStyle\r\n            [value]=\"getFeatureFontStyle()\"\r\n            (selectionChange)=\"styleModalData.fontStyle = $event.value\">\r\n            <mat-option\r\n              *ngFor=\"let fontSelect of allFontStyles\"\r\n              [value]=\"fontSelect\">\r\n              {{ fontSelect }}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"igo-input-container\">\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.style.offsetX' | translate }}</mat-label>\r\n          <input\r\n            matInput\r\n            #offsetXInput\r\n            type=\"number\"\r\n            onkeydown=\"return event.keyCode !== 69\"\r\n            [value]=\"getFeatureOffsetX()\"\r\n            (input)=\"styleModalData.offsetX = $event.target.value\">\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.style.offsetY' | translate }}</mat-label>\r\n          <input\r\n            matInput\r\n            #offsetYInput\r\n            type=\"number\"\r\n            onkeydown=\"return event.keyCode !== 69\"\r\n            [value]=\"getFeatureOffsetY()\"\r\n            (input)=\"styleModalData.offsetY= $event.target.value\">\r\n        </mat-form-field>\r\n      </div>\r\n    </form>\r\n  </div>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button \r\n    mat-raised-button \r\n    (click)=\"cancelDrawing()\">{{'igo.geo.style.cancel' | translate}}\r\n  </button>\r\n  <button \r\n    mat-raised-button \r\n    color=\"primary\" \r\n    (click)=\"confirm()\">OK\r\n  </button>\r\n</div>\r\n","import { Component, Inject, Input, OnInit } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { UntypedFormGroup, UntypedFormBuilder } from '@angular/forms';\r\n\r\nimport { DrawStyleService } from '../../style-service/draw-style.service';\r\nimport { FontType } from '../../shared/font.enum';\r\nimport { DrawingMatDialogData, StyleModalData } from '../shared/style-modal.interface';\r\n\r\n@Component({\r\n  selector: 'igo-style-modal-drawing',\r\n  templateUrl: './style-modal-drawing.component.html',\r\n  styleUrls: ['./style-modal-drawing.component.scss']\r\n})\r\nexport class StyleModalDrawingComponent implements OnInit {\r\n  @Input() confirmFlag: boolean = false;\r\n\r\n  public form: UntypedFormGroup;\r\n\r\n  public styleModalData: StyleModalData;\r\n  public linestringOnly: boolean;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<StyleModalDrawingComponent>,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private drawStyleService: DrawStyleService,\r\n    @Inject(MAT_DIALOG_DATA) public data: DrawingMatDialogData) {\r\n      this.buildForm();\r\n    }\r\n\r\n  ngOnInit() {\r\n    this.linestringOnly = true;\r\n    for (const feature of this.data.features) {\r\n      if (feature.geometry.type !== 'LineString') {\r\n        this.linestringOnly = false;\r\n      }\r\n    }\r\n    this.buildStyleData();\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      fill: [''],\r\n      stroke: ['']\r\n    });\r\n  }\r\n\r\n  private buildStyleData() {\r\n    this.styleModalData = {\r\n      fillColor:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.fill\r\n        : 'rgba(255,255,255,0.4)',\r\n      strokeColor:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.stroke\r\n        : 'rgba(143,7,7,1)',\r\n      fontSize:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.fontStyle\r\n            .split(' ')[0]\r\n            .replace('px', '')\r\n        : '20',\r\n      fontStyle:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.fontStyle.substring(\r\n            this.data.features[0].properties.fontStyle.indexOf(' ') + 1)\r\n        : FontType.Arial,\r\n      offsetX:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.offsetX\r\n        : this.drawStyleService.getOffsetX(),\r\n      offsetY:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.offsetY\r\n        : this.drawStyleService.getOffsetY()\r\n    };\r\n  }\r\n\r\n  get allFontStyles(): string[] {\r\n    return Object.values(FontType);\r\n  }\r\n\r\n  getFeatureFontSize(): string {\r\n    if (!this.styleModalData.fontSize) {\r\n      return this.data.features.length > 0\r\n      ? this.data.features[0].properties.fontStyle\r\n          .split(' ')[0]\r\n          .replace('px', '')\r\n      : '20';\r\n    } else {\r\n      return this.styleModalData.fontSize;\r\n    }\r\n  }\r\n\r\n  getFeatureFontStyle() {\r\n    if (!this.styleModalData.fontStyle) {\r\n      return this.data.features.length > 0\r\n      ? this.data.features[0].properties.fontStyle.substring(\r\n        this.data.features[0].properties.fontStyle.indexOf(' ') + 1\r\n        )\r\n      : FontType.Arial;\r\n    } else {\r\n      return this.styleModalData.fontStyle;\r\n    }\r\n  }\r\n\r\n  getFeatureFillColor() {\r\n    if (!this.styleModalData.fillColor) {\r\n      return this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.fill\r\n        : 'rgba(255,255,255,0.4)';\r\n    } else {\r\n      return this.styleModalData.fillColor;\r\n    }\r\n  }\r\n\r\n  getFeatureStrokeColor() {\r\n    if (!this.styleModalData.strokeColor) {\r\n      return this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.stroke\r\n        : 'rgba(143,7,7,1)';\r\n    } else {\r\n      return this.styleModalData.strokeColor;\r\n    }\r\n  }\r\n\r\n  getFeatureOffsetX() {\r\n    if (!this.styleModalData.offsetX) {\r\n      return this.data.features.length > 0\r\n        ? this.data.features[0].properties.offsetX\r\n        : this.drawStyleService.getOffsetX();\r\n    } else {\r\n      return this.styleModalData.offsetX;\r\n    }\r\n  }\r\n\r\n  getFeatureOffsetY() {\r\n    if (!this.styleModalData.offsetY) {\r\n      return this.data.features.length > 0\r\n      ? this.data.features[0].properties.offsetY\r\n      : this.drawStyleService.getOffsetY();\r\n    } else {\r\n      return this.styleModalData.offsetY;\r\n    }\r\n  }\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  confirm() {\r\n    this.confirmFlag = true;\r\n    this.dialogRef.close(this.styleModalData);\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  label: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-draw-popup-component',\r\n  templateUrl: './draw-layer-popup.component.html',\r\n  styleUrls: ['./draw-layer-popup.component.scss']\r\n})\r\nexport class DrawLayerPopupComponent {\r\n  @Input() confirmFlag: boolean = false;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<DrawLayerPopupComponent>,\r\n    // @Inject(MAT_DIALOG_DATA) public data: { currentLabel: string }\r\n  ) {}\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n  confirm(labelString: string) {\r\n    this.confirmFlag = true;\r\n    this.dialogRef.close(labelString);\r\n  }\r\n}\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">\r\n    {{ 'igo.geo.draw.layer.layerDialogInstruction' | translate }}\r\n  </p>\r\n  <mat-form-field class=\"example-full-width\">\r\n    <input\r\n      #input\r\n      matInput\r\n      placeholder=\"{{ 'igo.geo.draw.layer.title' | translate }}\"\r\n      />\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-raised-button (click)=\"cancelDrawing()\">\r\n    {{ 'igo.geo.draw.cancel' | translate }}\r\n  </button>\r\n  <button mat-raised-button color=\"primary\" (click)=\"confirm(input.value)\">\r\n    OK\r\n  </button>\r\n</div>\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n  })\r\nexport class DrawIconService {\r\n\r\n    protected icons: Array<string>;\r\n\r\n    constructor(\r\n      protected config: ConfigService\r\n    ) {\r\n        this.getIconsList();\r\n    }\r\n\r\n    getIcons() {\r\n        return this.icons;\r\n    }\r\n\r\n    getPath(): any {\r\n      return this.config.getConfig('drawingTool.icons') || [];\r\n    }\r\n\r\n    getIconsList() {\r\n      this.icons = this.getPath();\r\n    }\r\n}\r\n","<div>\r\n  <div class=\"geometry-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      (change)=\"onGeometryTypeChange($event.value)\" [value]=\"geometryType.Point\">\r\n      <mat-button-toggle [value]=\"geometryType.Point\">\r\n        {{'igo.geo.draw.' + geometryType.Point | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.LineString\">\r\n        {{'igo.geo.draw.' + geometryType.LineString | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Polygon\">\r\n        {{'igo.geo.draw.' + geometryType.Polygon | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Circle\">\r\n        {{'igo.geo.draw.' + geometryType.Circle | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"draw-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"labelsAreShown\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleLabels()\">\r\n      {{ 'igo.geo.draw.toggleMapTooltips' | translate }}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle\r\n      *ngIf=\"!isPoint()\"\r\n      [checked]=\"freehandMode\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleFreehandMode($event)\">\r\n      {{ 'igo.geo.draw.freehandMode' | translate }}\r\n    </mat-slide-toggle>\r\n\r\n    <div class=\"radius-unit\" *ngIf=\"isCircle()\">\r\n      <form class=\"radius-form\">\r\n        <mat-form-field class=\"radius\">\r\n          <input\r\n            matInput type=\"number\"\r\n            min=\"0\"\r\n            placeholder=\"{{ 'igo.geo.spatialFilter.radius' | translate }}\"\r\n            [formControl]=\"radiusFormControl\"\r\n            [readonly]=\"this.freehandMode\">\r\n        </mat-form-field>\r\n      </form>\r\n\r\n      <mat-form-field class=\"unit-field\">\r\n        <mat-select\r\n          [value]=\"measureUnit\"\r\n          (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n          <mat-option\r\n            *ngFor=\"let measureUnit of measureUnits\"\r\n            [value]=\"measureUnit\">\r\n            {{('igo.geo.measure.' + measureUnit) | translate}}\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n\r\n  <mat-divider></mat-divider>\r\n\r\n  <div>\r\n    <mat-form-field appearance=\"outline\" class=\"layer-select\">\r\n      <mat-label>{{'igo.geo.draw.layer.title' | translate}}</mat-label>\r\n      <mat-select #selectedLayer (selectionChange)=\"onLayerChange(selectedLayer.value)\" [value]=\"updateActiveLayer()\">\r\n        <mat-option *ngFor=\"let layer of allLayers\" [value]=\"layer\">\r\n          {{ layer.title }}\r\n        </mat-option>\r\n        <mat-option id=\"createNewLayer\" >\r\n          {{'igo.geo.draw.layer.createNewLayer' | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n    <button\r\n      *ngIf=\"activeDrawingLayer\"\r\n      mat-icon-button\r\n      [color]=\"activeDrawingLayer.visible ? 'primary' : 'default'\"\r\n      collapsibleButton\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"activeDrawingLayer.visible ?\r\n                    ('igo.geo.layer.hideLayer' | translate) :\r\n                    ('igo.geo.layer.showLayer' | translate)\"\r\n      (click)=\"activeDrawingLayer.visible = !activeDrawingLayer.visible\">\r\n      <mat-icon\r\n        [svgIcon]=\"activeDrawingLayer.visible ? 'eye' : 'eye-off'\">\r\n      </mat-icon>\r\n    </button>\r\n  </div>\r\n  <mat-divider></mat-divider>\r\n  <div>\r\n    <button\r\n      *ngIf=\"activeStore.count$.getValue() > 0\"\r\n      class=\"deleteBtn\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.delete' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      (click)=\"deleteDrawings()\"\r\n    >\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <div>\r\n      <igo-entity-table\r\n        #table\r\n        class=\"table-compact\"\r\n        [store]=\"activeStore\"\r\n        [template]=\"tableTemplate\">\r\n      </igo-entity-table>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"icon-options\">\r\n    <mat-form-field *ngIf=\"icons.length >= 1\">\r\n      <mat-label>{{ 'igo.geo.draw.icon' | translate }}</mat-label>\r\n      <mat-select>\r\n        <mat-select-trigger>\r\n          <div *ngIf=\"icon\" class=\"box\">\r\n            <img src=\"{{ icon }}\">\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option value=\"\" (click)=\"onIconChange()\">{{ 'igo.geo.draw.noIcon' | translate }}</mat-option>\r\n        <mat-option\r\n          *ngFor=\"let icon_html of icons\"\r\n          [value]=\"icon_html\"\r\n          (click)=\"onIconChange(icon_html)\">\r\n          <div class=\"box\">\r\n            <img src=\"{{ icon_html }}\">\r\n          </div>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button\r\n    mat-icon-button\r\n    color=\"accent\"\r\n    disableRipple=\"true\"\r\n    (click)=\"openShorcutsDialog()\"\r\n  >\r\n    <mat-icon\r\n      class=\"shortcuts-icon\"\r\n      svgIcon=\"keyboard-outline\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.shortcuts' | translate\"\r\n    >\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <button\r\n    *ngIf=\"selectedFeatures$.value.length\"\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    (click)=\"openStyleModalDialog()\"\r\n    [matTooltip]=\"'igo.geo.style.styleModalTooltipSelected' | translate\">\r\n    {{'igo.geo.style.styleModal' | translate}}\r\n    <mat-icon\r\n      class=\"style-icon\"\r\n      svgIcon=\"palette\"\r\n      [matBadge]=\"selectedFeatures$.value.length\"\r\n      matBadgeColor=\"warn\"\r\n      matBadgeSize=\"medium\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy,\r\n  FeatureMotion,\r\n  FeatureStoreLoadingStrategy,\r\n  featureToOl\r\n} from '../../feature';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { CoordinatesUnit, GeometryType, LabelType } from '../shared/draw.enum';\r\nimport { FontType } from '../../style/shared/font.enum';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { Draw, FeatureWithDraw } from '../shared/draw.interface';\r\nimport { UntypedFormGroup, UntypedFormBuilder, UntypedFormControl } from '@angular/forms';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { DrawControl } from '../../geometry/shared/controls/draw';\r\nimport {\r\n  EntityRecord,\r\n  EntityTableButton,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate\r\n} from '@igo2/common';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { getDistance, getLength } from 'ol/sphere';\r\nimport { DrawStyleService } from '../../style/style-service/draw-style.service';\r\nimport { first, skip } from 'rxjs/operators';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\nimport { getTooltipsOfOlGeometry } from '../../measure/shared/measure.utils';\r\nimport { createInteractionStyle, DDtoDMS } from '../shared/draw.utils';\r\nimport { transform } from 'ol/proj';\r\nimport { DrawIconService } from '../shared/draw-icon.service';\r\nimport { StyleModalDrawingComponent } from '../../style/style-modal/drawing/style-modal-drawing.component';\r\nimport { StyleModalData } from '../../style/style-modal/shared/style-modal.interface';\r\n\r\nimport {\r\n  trigger,\r\n  state,\r\n  style,\r\n  animate,\r\n  transition\r\n} from '@angular/animations';\r\n\r\nimport { DrawLayerPopupComponent } from './draw-layer-popup.component';\r\n\r\nimport {\r\n  measureOlGeometryLength,\r\n  measureOlGeometryArea,\r\n  metersToUnit,\r\n  squareMetersToUnit\r\n} from '../../measure/shared/measure.utils';\r\n\r\nimport {\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation,\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n} from '../../measure/shared/measure.enum';\r\nimport Polygon, { fromCircle } from 'ol/geom/Polygon';\r\n\r\n\r\n@Component({\r\n  selector: 'igo-draw',\r\n  animations: [\r\n    trigger('openClose', [\r\n      state(\r\n        'open',\r\n        style({\r\n          opacity: 1\r\n        })\r\n      ),\r\n      state(\r\n        'closed',\r\n        style({\r\n          opacity: 0\r\n        })\r\n      ),\r\n      transition('open => closed', [animate('600ms ease')]),\r\n      transition('closed => open', [animate('800ms ease')])\r\n    ])\r\n  ],\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DrawComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    fixedHeader: true,\r\n    tableHeight: 'auto',\r\n    columns: [\r\n      {\r\n        name: 'Drawing',\r\n        title: this.languageService.translate.instant('igo.geo.draw.labels'),\r\n        valueAccessor: (feature: FeatureWithDraw) => {\r\n          return feature.properties.draw;\r\n        }\r\n      },\r\n      {\r\n        name: 'Edition',\r\n        title: '',\r\n        sort: false,\r\n        valueAccessor: (feature: FeatureWithDraw) => {\r\n          return [{\r\n            editMode: false,\r\n            icon: 'pencil',\r\n            color: 'primary',\r\n            click: () => { this.editLabelDrawing(feature);},\r\n            style: 'mat-icon-button'\r\n          }] as EntityTableButton[];\r\n        },\r\n        renderer: EntityTableColumnRenderer.ButtonGroup,\r\n      }\r\n    ]\r\n  };\r\n\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n  @Input() map: IgoMap; // Map to draw on\r\n\r\n  @Input()\r\n  get stores(): FeatureStore<FeatureWithDraw>[] {\r\n    return this._stores;\r\n  }\r\n  set stores(value: FeatureStore<FeatureWithDraw>[]) {\r\n    this._stores = value;\r\n  }\r\n  private _stores:FeatureStore<FeatureWithDraw>[] = [];\r\n\r\n  @Input()\r\n  get drawControls(): [string, DrawControl][]{\r\n    return this._drawControls;\r\n  }\r\n  set drawControls(value: [string, DrawControl][]){\r\n    this._drawControls = value;\r\n  }\r\n  private _drawControls = [];\r\n\r\n  @Input()\r\n  get activeDrawingLayer(): VectorLayer {\r\n    return this._activeDrawingLayer;\r\n  }\r\n  set activeDrawingLayer(value: VectorLayer) {\r\n    this._activeDrawingLayer = value;\r\n  }\r\n  private _activeDrawingLayer: VectorLayer;\r\n\r\n  @Output() activeLayerChange = new EventEmitter<VectorLayer>();\r\n  @Output() drawControlsEvent = new EventEmitter<[string, DrawControl][]>();\r\n  @Output() layersIDEvent = new EventEmitter<string>();\r\n\r\n  @Output() fillColor: string;\r\n  @Output() strokeColor: string;\r\n  @Output() strokeWidth: number;\r\n\r\n  @Output() fontSize: string;\r\n  @Output() fontStyle: string;\r\n\r\n  public activeStore: FeatureStore<FeatureWithDraw>;\r\n  private layerCounterID: number = 0;\r\n  public draw$: BehaviorSubject<Draw> = new BehaviorSubject({}); // Observable of draw\r\n  private activeDrawingLayerSource = new OlVectorSource();\r\n  private activeDrawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private drawSelect$$: Subscription;\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithDraw[]> =\r\n    new BehaviorSubject([]);\r\n  public fillForm: string;\r\n  public strokeForm: string;\r\n  public drawControlIsDisabled: boolean = true;\r\n  public drawControlIsActive: boolean = false;\r\n  public labelsAreShown: boolean;\r\n  public freehandMode = false;\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  public position: string = 'bottom';\r\n  public form: UntypedFormGroup;\r\n  public icons: Array<string>;\r\n  public icon: string;\r\n\r\n  public radiusFormControl = new UntypedFormControl(1000);\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  public radiusFormControlChange$$: Subscription = new Subscription();\r\n  public predefinedRadius$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n  public radiusDrawEnd$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n  private numberOfDrawings: number;\r\n  public isCreatingNewLayer: boolean = false;\r\n  private currGeometryType = this.geometryType.Point as any;\r\n\r\n  @ViewChild('selectedLayer') select;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private drawStyleService: DrawStyleService,\r\n    private dialog: MatDialog,\r\n    private drawIconService: DrawIconService\r\n\r\n  ) {\r\n    this.buildForm();\r\n    this.fillColor = this.drawStyleService.getFillColor();\r\n    this.strokeColor = this.drawStyleService.getStrokeColor();\r\n    this.strokeWidth = this.drawStyleService.getStrokeWidth();\r\n    this.labelsAreShown = this.drawStyleService.getLabelsAreShown();\r\n    this.icons = this.drawIconService.getIcons();\r\n    this.icon = this.drawStyleService.getIcon();\r\n\r\n    this.fontSize = this.drawStyleService.getFontSize();\r\n    this.fontStyle = this.drawStyleService.getFontStyle();\r\n  }\r\n\r\n  // Initialize the store that will contain the entities and create the Draw control\r\n  ngOnInit() {\r\n    if (!this.stores.length) {\r\n      this.activeStore = new FeatureStore<FeatureWithDraw>([], {\r\n        map: this.map\r\n      });\r\n      this.initStore();\r\n      this.activeDrawControl = this.createDrawControl(\r\n        this.fillColor,\r\n        this.strokeColor,\r\n        this.strokeWidth\r\n      );\r\n      this.activeDrawControl.setGeometryType(this.geometryType.Point as any);\r\n      this.toggleDrawControl();\r\n      this.stores.push(this.activeStore);\r\n      this.drawControls.push([this.activeDrawingLayer.id, this.activeDrawControl]);\r\n      this.drawControlsEvent.emit(this.drawControls);\r\n      this.layersIDEvent.emit(this.activeDrawingLayer.id);\r\n      this.onLayerChange(this.activeDrawingLayer);\r\n    } else {\r\n      this.activeStore = this.stores.find(store => store.layer.id === this.activeDrawingLayer.id);\r\n      this.activeDrawControl = this.drawControls.find(dc => dc[0] === this.activeDrawingLayer.id)[1];\r\n      this.deactivateDrawControl();\r\n      this.allLayers.forEach(layer => {\r\n        if (layer.id !== this.activeDrawingLayer.id) {\r\n          layer.opacity = 0;\r\n        }\r\n        let store = this.stores.find(s => s.layer.id === layer.id);\r\n\r\n        this.subscriptions$$.push(\r\n          store.stateView\r\n            .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n              return record.state.selected === true;\r\n            })\r\n            .pipe(\r\n              first()\r\n            )\r\n            .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n              records.forEach((record) => {\r\n                record.state.selected = false;\r\n              });\r\n            })\r\n        );\r\n\r\n        this.subscriptions$$.push(\r\n          store.stateView\r\n            .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n              return record.state.selected === true;\r\n            })\r\n            .pipe(\r\n              skip(1) // Skip initial emission\r\n            )\r\n            .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n              this.selectedFeatures$.next(records.map((record) => record.entity));\r\n            })\r\n        );\r\n\r\n        this.subscriptions$$.push(\r\n          store.count$.subscribe((cnt) => {\r\n            cnt >= 1\r\n              ? (this.activeStore.layer.options.showInLayerList = true)\r\n              : (this.activeStore.layer.options.showInLayerList = false);\r\n          })\r\n        );\r\n      });\r\n      this.onLayerChange(this.activeDrawingLayer);\r\n    }\r\n\r\n    this.radiusFormControlChange$$ = this.radiusFormControl.valueChanges.subscribe(value => {\r\n      if (this.activeDrawControl.ispredefinedRadius$.getValue()) {\r\n        this.changeRadius(value);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove the drawing layer and the interactions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.allLayers.forEach(layer => layer.opacity = 1);\r\n    this.activeStore.state.updateAll({selected: false});\r\n    this.deactivateDrawControl();\r\n    this.subscriptions$$.map((s) => s.unsubscribe());\r\n    this.radiusFormControlChange$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(\r\n    fillColor?: string,\r\n    strokeColor?: string,\r\n    strokeWidth?: number\r\n  ) {\r\n    const activeDrawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.activeDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(\r\n        fillColor,\r\n        strokeColor,\r\n        strokeWidth\r\n      )\r\n    });\r\n    return activeDrawControl;\r\n  }\r\n\r\n  /**\r\n   * Store initialization, including drawing layer creation\r\n   */\r\n\r\n  private initStore(newTitle?: string, isNewLayer?: boolean) {\r\n    this.createLayer(newTitle, isNewLayer);\r\n    this.subscriptions$$.push(\r\n      this.activeStore.stateView\r\n        .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          skip(1) // Skip initial emission\r\n        )\r\n        .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n          this.selectedFeatures$.next(records.map((record) => record.entity));\r\n        })\r\n    );\r\n\r\n    this.subscriptions$$.push(\r\n      this.activeStore.count$.subscribe((cnt) => {\r\n        cnt >= 1\r\n          ? (this.activeStore.layer.options.showInLayerList = true)\r\n          : (this.activeStore.layer.options.showInLayerList = false);\r\n      })\r\n    );\r\n  }\r\n\r\n/**\r\n * Open the style modal dialog box\r\n */\r\n  openStyleModalDialog() {\r\n    setTimeout(() => {\r\n      // open the dialog box used to style features\r\n      const dialogRef = this.dialog.open(StyleModalDrawingComponent, {\r\n        disableClose: false,\r\n        data: {\r\n          features: this.selectedFeatures$.getValue(),\r\n          icons: this.icons,\r\n          icon: this.icon\r\n        },\r\n        autoFocus: false\r\n      });\r\n\r\n      // when dialog box is closed, get label and set it to geometry\r\n      dialogRef.afterClosed().subscribe((data: StyleModalData) => {\r\n        // checks if the user clicked ok\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n          this.onFontChange(this.labelsAreShown, data.fontSize, data.fontStyle);\r\n          this.onColorChange(this.labelsAreShown, this.icon ? true : false, data.fillColor, data.strokeColor);\r\n          this.onOffsetLabelChange(this.labelsAreShown, data.offsetX, data.offsetY);\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  /**\r\n   * Open a dialog box to enter label and do something\r\n   * @param olGeometry geometry at draw end or selected geometry\r\n   * @param drawEnd event fired at drawEnd?\r\n   */\r\n  private openDrawDialog(olGeometry, isDrawEnd: boolean) {\r\n    setTimeout(() => {\r\n      // open the dialog box used to enter label\r\n      const dialogRef = this.dialog.open(DrawPopupComponent, {\r\n        disableClose: false,\r\n        data: {olGeometry: olGeometry, map: this.map}\r\n      });\r\n\r\n      // when dialog box is closed, get label and set it to geometry\r\n      dialogRef.afterClosed().subscribe((result) => {\r\n        // checks if the user clicked ok\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n\r\n          this.updateLabelOfOlGeometry(olGeometry, result.label);\r\n          this.updateLabelType(olGeometry, dialogRef.componentInstance.labelFlag);\r\n          this.updateMeasureUnit(olGeometry, result.measureUnit);\r\n\r\n          if (!(olGeometry instanceof OlFeature)){\r\n            this.updateFontSizeAndStyle(olGeometry, '15', FontType.Arial);\r\n            this.updateFillAndStrokeColor(\r\n              olGeometry,\r\n              'rgba(255,255,255,0.4)',\r\n              'rgba(143,7,7,1)'\r\n            );\r\n            this.updateOffset(\r\n              olGeometry,\r\n              0,\r\n              (olGeometry instanceof OlPoint) ? -15 : 0\r\n            );\r\n          }\r\n\r\n          isDrawEnd ? this.onDrawEnd(olGeometry): this.onSelectDraw(olGeometry, result.label,\r\n            [dialogRef.componentInstance.labelFlag, result.measureUnit]);\r\n          this.updateHeightTable();\r\n        }\r\n        // deletes the feature\r\n        else {\r\n          this.activeDrawingLayerSource\r\n            .getFeatures()\r\n            .forEach((drawingLayerFeature) => {\r\n              const geometry = drawingLayerFeature.getGeometry() as any;\r\n              if (olGeometry === geometry) {\r\n                this.activeDrawingLayerSource.removeFeature(\r\n                  drawingLayerFeature\r\n                );\r\n              }\r\n            });\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlGeometry, radius?: number) {\r\n    this.addFeatureToStore(olGeometry, radius);\r\n    this.clearLabelsOfOlGeometry(olGeometry);\r\n    this.activeStore.layer.ol.getSource().refresh();\r\n  }\r\n\r\n  private onModifyDraw(olGeometry) {\r\n    const entities = this.activeStore.all();\r\n\r\n    entities.forEach((entity) => {\r\n      const entityId = entity.properties.id;\r\n      const olGeometryId = olGeometry.ol_uid;\r\n\r\n      if (entityId === olGeometryId) {\r\n        if (entity.properties.labelType === LabelType.Coordinates){\r\n          let longLat = DDtoDMS([entity.properties.longitude, entity.properties.latitude],\r\n            entity.properties.measureUnit as CoordinatesUnit);\r\n          this.updateLabelOfOlGeometry(olGeometry, '(' + longLat[1] + ', ' + longLat[0] + ')');\r\n        }\r\n        else if (entity.properties.labelType === LabelType.Length){\r\n          if (olGeometry instanceof OlCircle){\r\n            let circularPolygon = fromCircle(olGeometry, 10000);\r\n            const radius = metersToUnit(this.getRadius(circularPolygon), entity.properties.measureUnit as MeasureLengthUnit);\r\n            const unit = MeasureLengthUnitAbbreviation[entity.properties.measureUnit];\r\n            const radiusLabel = 'R: ' + radius.toFixed(2).toString() + ' ' + unit;\r\n            this.updateLabelOfOlGeometry(olGeometry, radiusLabel);\r\n          }\r\n          else {\r\n            let olGeometryLength = measureOlGeometryLength(olGeometry, this.map.ol.getView().getProjection().getCode());\r\n            let measureUnit: any;\r\n            const temp: MeasureLengthUnit = entity.properties.measureUnit as MeasureLengthUnit;\r\n            measureUnit = MeasureLengthUnitAbbreviation[entity.properties.measureUnit];\r\n            olGeometryLength = metersToUnit(olGeometryLength, temp);\r\n            let lengthLabel = olGeometry instanceof Polygon ?\r\n              'P: ' + olGeometryLength.toFixed(2).toString() + ' ' + measureUnit\r\n              : olGeometryLength.toFixed(2).toString() + ' ' + measureUnit;\r\n            this.updateLabelOfOlGeometry(olGeometry, lengthLabel);\r\n          }\r\n        }\r\n        else if (entity.properties.labelType === LabelType.Area){\r\n          if (olGeometry instanceof OlCircle){\r\n            let circularPolygon = fromCircle(olGeometry, 10000);\r\n            let circleArea = measureOlGeometryArea(circularPolygon, this.map.ol.getView().getProjection().getCode());\r\n            const unit = MeasureAreaUnitAbbreviation[entity.properties.measureUnit];\r\n            const temp: MeasureAreaUnit = entity.properties.measureUnit as MeasureAreaUnit;\r\n            circleArea = squareMetersToUnit(circleArea, temp);\r\n            const areaLabel = circleArea.toFixed(2).toString() + ' ' + unit;\r\n            this.updateLabelOfOlGeometry(olGeometry, areaLabel);\r\n          }\r\n          else {\r\n            let olGeometryArea = measureOlGeometryArea(olGeometry, this.map.ol.getView().getProjection().getCode());\r\n            let measureUnit: any;\r\n            const temp: MeasureAreaUnit = entity.properties.measureUnit as MeasureAreaUnit;\r\n            measureUnit = MeasureAreaUnitAbbreviation[entity.properties.measureUnit];\r\n            olGeometryArea = squareMetersToUnit(olGeometryArea, temp);\r\n            const lengthLabel = olGeometryArea.toFixed(2).toString() + ' ' + measureUnit;\r\n            this.updateLabelOfOlGeometry(olGeometry, lengthLabel);\r\n          }\r\n        }\r\n        else {\r\n          this.updateLabelOfOlGeometry(olGeometry, entity.properties.draw);\r\n        }\r\n\r\n        this.updateLabelType(\r\n          olGeometry,\r\n          entity.properties.labelType\r\n        );\r\n        this.updateMeasureUnit(olGeometry, entity.properties.measureUnit);\r\n        this.updateFontSizeAndStyle(\r\n          olGeometry,\r\n          entity.properties.fontStyle.split(' ')[0].replace('px', ''),\r\n          entity.properties.fontStyle.substring(\r\n            entity.properties.fontStyle.indexOf(' ') + 1\r\n          )\r\n        );\r\n        this.updateFillAndStrokeColor(\r\n          olGeometry,\r\n          entity.properties.drawingStyle.fill,\r\n          entity.properties.drawingStyle.stroke\r\n        );\r\n        this.updateOffset(\r\n          olGeometry,\r\n          entity.properties.offsetX,\r\n          entity.properties.offsetY\r\n        );\r\n        this.replaceFeatureInStore(entity, olGeometry);\r\n      }\r\n    });\r\n  }\r\n\r\n  private onSelectDraw(olFeature: OlFeature<OlGeometry>, label: string, labelTypeAndUnit?) {\r\n    const entities = this.activeStore.all();\r\n\r\n    const olGeometry = olFeature.getGeometry() as any;\r\n    olGeometry.ol_uid = olFeature.get('id');\r\n\r\n    const olGeometryCoordinates = JSON.stringify(\r\n      olGeometry.getCoordinates()[0]\r\n    );\r\n\r\n    entities.forEach((entity) => {\r\n      const entityCoordinates = JSON.stringify(entity.geometry.coordinates[0]);\r\n      if (olGeometryCoordinates === entityCoordinates) {\r\n        const fontSize = olFeature\r\n          .get('fontStyle')\r\n          .split(' ')[0]\r\n          .replace('px', '');\r\n        const fontStyle = olFeature\r\n          .get('fontStyle')\r\n          .substring(olFeature.get('fontStyle').indexOf(' ') + 1);\r\n\r\n        const fillColor = olFeature.get('drawingStyle').fill;\r\n        const strokeColor = olFeature.get('drawingStyle').stroke;\r\n\r\n        const offsetX = olFeature.get('offsetX');\r\n        const offsetY = olFeature.get('offsetY');\r\n\r\n        const rad: number = entity.properties.rad\r\n          ? entity.properties.rad\r\n          : undefined;\r\n        this.updateLabelOfOlGeometry(olGeometry, label);\r\n        this.updateFontSizeAndStyle(olGeometry, fontSize, fontStyle);\r\n        this.updateFillAndStrokeColor(olGeometry, fillColor, strokeColor);\r\n        this.updateOffset(olGeometry, offsetX, offsetY);\r\n        this.updateLabelType(olGeometry, labelTypeAndUnit[0]);\r\n        this.updateMeasureUnit(olGeometry, labelTypeAndUnit[1]);\r\n        this.replaceFeatureInStore(entity, olGeometry, rad);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add a feature with draw label to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(\r\n    olGeometry,\r\n    radius?: number,\r\n    feature?: FeatureWithDraw,\r\n  ) {\r\n    let rad: number;\r\n    let center4326: Array<number>;\r\n    let point4326: Array<number>;\r\n    let lon4326: number;\r\n    let lat4326: number;\r\n\r\n    const featureId = feature ? feature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n\r\n    if (olGeometry instanceof OlCircle || radius) {\r\n      if (radius) {\r\n        rad = radius;\r\n      } else {\r\n        geometry.type = 'Point';\r\n        geometry.coordinates = olGeometry.getCenter();\r\n        const extent4326 = transform(\r\n          [\r\n            olGeometry.getFlatCoordinates()[2],\r\n            olGeometry.getFlatCoordinates()[3]\r\n          ],\r\n          projection,\r\n          'EPSG:4326'\r\n        );\r\n        center4326 = transform(\r\n          [\r\n            olGeometry.getFlatCoordinates()[0],\r\n            olGeometry.getFlatCoordinates()[1]\r\n          ],\r\n          projection,\r\n          'EPSG:4326'\r\n        );\r\n        lon4326 = center4326[0];\r\n        lat4326 = center4326[1];\r\n        rad = getDistance(center4326, extent4326);\r\n        this.radiusFormControl.setValue(Math.round(rad));\r\n      }\r\n\r\n    }\r\n    if (this.activeDrawControl.radiusDrawEnd$.getValue()) {\r\n      rad = this.activeDrawControl.radiusDrawEnd$.getValue();\r\n    }\r\n\r\n    if (olGeometry instanceof OlPoint) {\r\n      point4326 = transform(\r\n        olGeometry.getFlatCoordinates(),\r\n        projection,\r\n        'EPSG:4326'\r\n      );\r\n      lon4326 = point4326[0];\r\n      lat4326 = point4326[1];\r\n    }\r\n\r\n    this.activeStore.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        draw: olGeometry.get('_label'),\r\n        longitude: lon4326 ? lon4326 : null,\r\n        latitude: lat4326 ? lat4326 : null,\r\n        rad: rad ? rad : null,\r\n        fontStyle: olGeometry.get('fontStyle_'),\r\n        drawingStyle: {\r\n          fill: olGeometry.get('fillColor_'),\r\n          stroke: olGeometry.get('strokeColor_')\r\n        },\r\n        offsetX: olGeometry.get('offsetX_'),\r\n        offsetY: olGeometry.get('offsetY_'),\r\n        labelType: olGeometry.get('labelType_'),\r\n        measureUnit: olGeometry.get('measureUnit_')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n    this.activeStore.setLayerExtent();\r\n    this.activeDrawControl.predefinedRadius$.next(undefined);\r\n    this.activeDrawControl.radiusDrawEnd$.next(undefined);\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      fill: [''],\r\n      stroke: ['']\r\n    });\r\n  }\r\n\r\n  public setupLayer(isNewLayer?: boolean) {\r\n    setTimeout(() => {\r\n      const dialogRef = this.dialog.open(DrawLayerPopupComponent, {\r\n        disableClose: false,\r\n      });\r\n      dialogRef.afterClosed().subscribe((label: string) => {\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n          this.activeStore.state.updateAll({selected: false});\r\n          this.activeStore = new FeatureStore<FeatureWithDraw>([], { map: this.map });\r\n          this.activeDrawingLayerSource = new OlVectorSource();\r\n          this.activeDrawingLayer.opacity = 0;\r\n          this.deactivateDrawControl();\r\n          this.initStore(label, isNewLayer);\r\n          this.activeDrawControl = this.createDrawControl(\r\n            this.fillColor,\r\n            this.strokeColor,\r\n            this.strokeWidth\r\n          );\r\n          this.activeDrawControl.setGeometryType(this.currGeometryType);\r\n          this.toggleDrawControl();\r\n          this.stores.push(this.activeStore);\r\n          this.drawControls.push([this.activeDrawingLayer.id, this.activeDrawControl]);\r\n          this.drawControlsEvent.emit(this.drawControls);\r\n          this.layersIDEvent.emit(this.activeDrawingLayer.id);\r\n          this.isCreatingNewLayer = false;\r\n          if (!this.labelsAreShown){\r\n            this.onToggleLabels();\r\n          }\r\n          this.activeLayerChange.emit(this.activeDrawingLayer);\r\n        } else {\r\n          this.select.value = this.activeDrawingLayer;\r\n          this.select.selectionChange.emit(this.activeDrawingLayer);\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  // HTML user interactions\r\n\r\n  /**\r\n   * Called when the user double-clicks the selected drawing\r\n   */\r\n  editLabelDrawing(feature) {\r\n    const olGeometryFeature = featureToOl(\r\n      feature,\r\n      this.map.ol.getView().getProjection().getCode()\r\n    );\r\n    this.openDrawDialog(olGeometryFeature, false);\r\n\r\n  }\r\n\r\n  openShorcutsDialog() {\r\n    this.dialog.open(DrawShorcutsComponent);\r\n  }\r\n\r\n  deleteDrawings() {\r\n    this.activeStore.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach((selectedFeature) => {\r\n      this.activeDrawingLayerSource\r\n        .getFeatures()\r\n        .forEach((drawingLayerFeature) => {\r\n          const geometry = drawingLayerFeature.getGeometry() as any;\r\n          if (selectedFeature.properties.id === geometry.ol_uid) {\r\n            this.activeDrawingLayerSource.removeFeature(drawingLayerFeature);\r\n          }\r\n        });\r\n    });\r\n    this.updateHeightTable();\r\n    this.activeStore.setLayerExtent();\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the labels toggle\r\n   */\r\n  onToggleLabels() {\r\n    this.drawStyleService.toggleLabelsAreShown();\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n    this.icon\r\n      ? this.elementStyle(\r\n          this.labelsAreShown,\r\n          true\r\n        )\r\n      : this.elementStyle(\r\n          this.labelsAreShown,\r\n          false\r\n        );\r\n    this.createDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the Draw control is toggled\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggleIsChecked: boolean) {\r\n    toggleIsChecked ? this.toggleDrawControl() : this.deactivateDrawControl();\r\n  }\r\n\r\n  onToggleFreehandMode(event: any) {\r\n    if (this.isCircle() && !event.checked) {\r\n      this.activeDrawControl.ispredefinedRadius$.next(true);\r\n      this.changeRadius(this.radiusFormControl.value);\r\n    } else {\r\n      this.activeDrawControl.setOlInteractionStyle(createInteractionStyle(this.fillColor, this.strokeColor, this.strokeWidth));\r\n      this.activeDrawControl.ispredefinedRadius$.next(false);\r\n    }\r\n    this.freehandMode = event.checked;\r\n    this.activeDrawControl.freehand$.next(event.checked);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  // User changes properties of a drawing element\r\n\r\n  /**\r\n   * Display the current layer with the current store and the current layerSource\r\n   */\r\n\r\n  public onLayerChange(currLayer?: VectorLayer) {\r\n    if (currLayer) {\r\n      this.activeStore.state.updateAll({selected: false});\r\n      this.isCreatingNewLayer = false;\r\n      this.activeDrawingLayer.opacity = 0;\r\n      this.activeDrawingLayer = currLayer;\r\n      this.activeDrawingLayer.opacity = 1;\r\n      this.deactivateDrawControl();\r\n      if (!this.labelsAreShown){\r\n        this.onToggleLabels();\r\n      }\r\n      this.activeStore = this.stores.find(store => store.layer.id === this.activeDrawingLayer.id);\r\n      this.activeDrawControl = this.drawControls.find(dc => dc[0] === this.activeDrawingLayer.id)[1];\r\n      this.activeDrawingLayerSource = this.activeDrawControl.olDrawingLayerSource;\r\n      this.activeDrawControl.setGeometryType(this.currGeometryType);\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.setupLayer(true);\r\n    }\r\n    this.activeLayerChange.emit(this.activeDrawingLayer);\r\n  }\r\n\r\n  public createLayer(newTitle?, isNewLayer?) {\r\n    for (const layer of this.allLayers){\r\n      let numberId = Number(layer.id.replace('igo-draw-layer',''));\r\n      this.layerCounterID = Math.max(numberId,this.layerCounterID);\r\n    }\r\n    this.activeDrawingLayer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'igo-draw-layer' + ++this.layerCounterID,\r\n      title: isNewLayer\r\n        ? newTitle\r\n        : this.languageService.translate.instant('igo.geo.draw.drawing'),\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: (feature, resolution) => {\r\n        return this.drawStyleService.createIndividualElementStyle(\r\n          feature,\r\n          resolution,\r\n          this.labelsAreShown,\r\n          feature.get('fontStyle'),\r\n          feature.get('drawingStyle').fill,\r\n          feature.get('drawingStyle').stroke,\r\n          feature.get('offsetX'),\r\n          feature.get('offsetY'),\r\n          this.map.projection,\r\n          this.icon\r\n        );\r\n      },\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      }\r\n    });\r\n\r\n    tryBindStoreLayer(this.activeStore, this.activeDrawingLayer);\r\n\r\n    tryAddLoadingStrategy(\r\n      this.activeStore,\r\n      new FeatureStoreLoadingStrategy({\r\n        motion: FeatureMotion.None\r\n      })\r\n    );\r\n\r\n    tryAddSelectionStrategy(\r\n      this.activeStore,\r\n      new FeatureStoreSelectionStrategy({\r\n        map: this.map,\r\n        motion: FeatureMotion.None,\r\n        many: true\r\n      })\r\n    );\r\n    this.activeStore.layer.visible = true;\r\n    this.activeStore.source.ol.on(\r\n      'removefeature',\r\n      (event: OlVectorSourceEvent<OlGeometry>) => {\r\n        const olGeometry = event.feature.getGeometry();\r\n        this.clearLabelsOfOlGeometry(olGeometry);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the color in a color picker\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param isAnIcon wheter the feature is an icon or not\r\n   * @param fillColor which is the filling color\r\n   * @param strokeColor which is the stroke color\r\n   */\r\n  onColorChange(\r\n    labelsAreShown: boolean,\r\n    isAnIcon: boolean,\r\n    fillColor: string,\r\n    strokeColor: string\r\n  ) {\r\n    if (this.selectedFeatures$.value.length > 0 && !isAnIcon) {\r\n      this.selectedFeatures$.value.forEach((feature) => {\r\n        let olFeature = featureToOl(\r\n          feature,\r\n          this.map.ol.getView().getProjection().getCode()\r\n        );\r\n        this.updateFillAndStrokeColor(olFeature, fillColor, strokeColor);\r\n\r\n        const entity = this.activeStore\r\n          .all()\r\n          .find((e) => e.meta.id === olFeature.getId());\r\n        entity.properties.drawingStyle.fill = olFeature.get('fillColor_');\r\n        entity.properties.drawingStyle.stroke = olFeature.get('strokeColor_');\r\n        this.activeStore.update(entity);\r\n      });\r\n    }\r\n\r\n    this.elementStyle(labelsAreShown, isAnIcon);\r\n    this.createDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the font size or/and style\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param size the size of the font\r\n   * @param style the style of the font\r\n   */\r\n\r\n  onFontChange(labelsAreShown: boolean, size: string, style: FontType) {\r\n    if (this.selectedFeatures$.value.length > 0) {\r\n      this.selectedFeatures$.value.forEach((feature) => {\r\n        let olFeature = featureToOl(\r\n          feature,\r\n          this.map.ol.getView().getProjection().getCode()\r\n        );\r\n        this.updateFontSizeAndStyle(olFeature, size, style);\r\n        const entity = this.activeStore\r\n          .all()\r\n          .find((e) => e.meta.id === olFeature.getId());\r\n        entity.properties.fontStyle = olFeature.get('fontStyle_');\r\n        this.activeStore.update(entity);\r\n        olFeature = this.activeStore.layer.ol.getSource().getFeatures().find(f => f.getId() === entity.meta.id);\r\n        olFeature.setProperties({ fontStyle: entity.properties.fontStyle });\r\n        olFeature.changed();\r\n      });\r\n\r\n      this.fontSize = size;\r\n      this.fontStyle = style;\r\n\r\n      this.drawStyleService.setFontSize(size);\r\n      this.drawStyleService.setFontStyle(style);\r\n\r\n      this.elementStyle(labelsAreShown);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the value of the horizontal/vertical offset\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param offsetX horizontal offset of the label\r\n   * @param offsetY vertical offset of the label\r\n   */\r\n\r\n  onOffsetLabelChange(\r\n    labelsAreShown: boolean,\r\n    offsetX: number,\r\n    offsetY: number\r\n  ) {\r\n    if (this.selectedFeatures$.value.length > 0) {\r\n      this.selectedFeatures$.value.forEach((feature) => {\r\n        let olFeature = featureToOl(\r\n          feature,\r\n          this.map.ol.getView().getProjection().getCode()\r\n        );\r\n        this.updateOffset(olFeature, offsetX, offsetY);\r\n        const entity = this.activeStore\r\n          .all()\r\n          .find((e) => e.meta.id === olFeature.getId());\r\n        entity.properties.offsetX = olFeature.get('offsetX_');\r\n        entity.properties.offsetY = olFeature.get('offsetY_');\r\n        this.activeStore.update(entity);\r\n        olFeature = this.activeStore.layer.ol.getSource().getFeatures().find(f => f.getId() === entity.meta.id);\r\n        olFeature.setProperties({ offsetX: entity.properties.offsetX, offsetY: entity.properties.offsetY });\r\n        olFeature.changed();\r\n      });\r\n      this.elementStyle(labelsAreShown);\r\n    }\r\n  }\r\n\r\n  onIconChange(event?) {\r\n    this.icon = event;\r\n    this.drawStyleService.setIcon(this.icon);\r\n    this.elementStyle(true, this.icon);\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: Type) {\r\n    this.currGeometryType = geometryType;\r\n    this.activeDrawControl.setGeometryType(geometryType);\r\n    this.freehandMode ?\r\n      this.onToggleFreehandMode({ checked: true }) :\r\n      this.onToggleFreehandMode({ checked: false });\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  // Updates the properties of olFeature inputted\r\n\r\n  /**\r\n   * Update the label of a geometry when a label is entered in a dialog box\r\n   * @param OlFeature the feature\r\n   * @param label the label\r\n   */\r\n  private updateLabelOfOlGeometry(OlFeature, label: string) {\r\n    OlFeature.setProperties(\r\n      {\r\n        _label: label\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateFontSizeAndStyle(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    fontSize: string,\r\n    fontStyle: string\r\n  ) {\r\n    olFeature.setProperties(\r\n      {\r\n        fontStyle_: `${fontSize}px ${fontStyle}`\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateFillAndStrokeColor(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    fillColor: string,\r\n    strokeColor: string\r\n  ) {\r\n    olFeature.setProperties(\r\n      {\r\n        fillColor_: fillColor,\r\n        strokeColor_: strokeColor\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateOffset(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    offsetX: number,\r\n    offsetY: number\r\n  ) {\r\n    olFeature.setProperties(\r\n      {\r\n        offsetX_: offsetX,\r\n        offsetY_: offsetY\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateLabelType(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    typeOfLabel: LabelType | [LabelType, LabelType]\r\n  ){\r\n    olFeature.setProperties(\r\n      {\r\n        labelType_:typeOfLabel\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateMeasureUnit(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    measureUnit: MeasureLengthUnit | MeasureAreaUnit | CoordinatesUnit | []\r\n  ){\r\n    olFeature.setProperties(\r\n      {\r\n        measureUnit_: measureUnit\r\n      },\r\n      true\r\n    );\r\n\r\n  }\r\n\r\n  // Updates values of the selected element on the HTML view\r\n\r\n  getFeatureFontSize(): string {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.fontStyle\r\n          .split(' ')[0]\r\n          .replace('px', '')\r\n      : '15';\r\n  }\r\n\r\n  getFeatureFontStyle() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.fontStyle.substring(\r\n          this.selectedFeatures$.value[0].properties.fontStyle.indexOf(' ') + 1\r\n        )\r\n      : FontType.Arial;\r\n  }\r\n\r\n  getFeatureFillColor() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.drawingStyle.fill\r\n      : 'rgba(255,255,255,0.4)';\r\n  }\r\n\r\n  getFeatureStrokeColor() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.drawingStyle.stroke\r\n      : 'rgba(143,7,7,1)';\r\n  }\r\n\r\n  getFeatureOffsetX() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.offsetX\r\n      : this.drawStyleService.getOffsetX();\r\n  }\r\n\r\n  getFeatureOffsetY() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.offsetY\r\n      : '0';\r\n  }\r\n\r\n  get allFontStyles(): string[] {\r\n    return Object.values(FontType);\r\n  }\r\n\r\n  get allLayers() {\r\n    return this.map.layers.filter((layer) =>\r\n      String(layer.id).includes('igo-draw-layer')\r\n    );\r\n  }\r\n\r\n  updateHeightTable() {\r\n    // Check the amount of rows as a possible alternative\r\n    this.numberOfDrawings = this.activeStore.count$.getValue();\r\n    this.numberOfDrawings > 10\r\n      ? (this.tableTemplate.tableHeight = '35vh')\r\n      : (this.tableTemplate.tableHeight = 'auto');\r\n  }\r\n\r\n  updateActiveLayer() {\r\n    let currLayer = this.allLayers.find(layer => layer.title === this.activeDrawingLayer.title);\r\n    return currLayer ? currLayer : this.allLayers[0];\r\n  }\r\n\r\n  // Helper methods\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometry\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearLabelsOfOlGeometry(olGeometry) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach(\r\n      (olTooltip: OlOverlay | undefined) => {\r\n        if (olTooltip && olTooltip.getMap()) {\r\n          this.map.ol.removeOverlay(olTooltip);\r\n        }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Replace the feature in the store\r\n   * @param entity the entity to replace\r\n   * @param olGeometry the new geometry to insert in the store\r\n   */\r\n  private replaceFeatureInStore(\r\n    entity,\r\n    olGeometry: OlGeometry,\r\n    radius?: number\r\n  ) {\r\n    this.activeStore.delete(entity);\r\n    this.onDrawEnd(olGeometry, radius);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (!this.activeDrawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.drawControlIsActive = false;\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl() {\r\n    this.drawControlIsDisabled = false;\r\n    this.drawControlIsActive = true;\r\n    this.drawEnd$$ = this.activeDrawControl.end$.subscribe(\r\n      (olGeometry: OlGeometry) => {\r\n        this.openDrawDialog(olGeometry, true);\r\n      }\r\n    );\r\n\r\n    this.activeDrawControl.modify$.subscribe((olGeometry: OlGeometry) => {\r\n      this.onModifyDraw(olGeometry);\r\n    });\r\n\r\n    if (!this.drawSelect$$) {\r\n      this.drawSelect$$ = this.activeDrawControl.select$.subscribe(\r\n        (olFeature: OlFeature<OlGeometry>) => {\r\n          this.openDrawDialog(olFeature, false);\r\n        }\r\n      );\r\n    }\r\n    this.activeDrawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * get the geometry of design\r\n   *\r\n   */\r\n\r\n  isPoint() {\r\n    return this.activeDrawControl.getGeometryType() === this.geometryType.Point;\r\n  }\r\n\r\n  isLineString() {\r\n    return this.activeDrawControl.getGeometryType() === this.geometryType.LineString;\r\n  }\r\n\r\n  isPolygon() {\r\n    return this.activeDrawControl.getGeometryType() === this.geometryType.Polygon;\r\n  }\r\n\r\n  isCircle() {\r\n    return this.activeDrawControl.getGeometryType() === this.geometryType.Circle;\r\n  }\r\n\r\n  /**\r\n   * The fonction to predefine the radius of the user\r\n   *\r\n   */\r\n\r\n  changeRadius(radius: number) {\r\n    let radiusMeters: number;\r\n\r\n    if (radius) {\r\n      this.measureUnit === MeasureLengthUnit.Meters ? radiusMeters = radius :\r\n        radiusMeters = radius * 1000;\r\n    } else {\r\n      radiusMeters = undefined;\r\n    }\r\n\r\n    const pointStyle = (feature: OlFeature<OlGeometry>, resolution: number) => {\r\n      const geom = feature.getGeometry() as OlPoint;\r\n      const coordinates = olproj.transform(geom.getCoordinates(), this.map.projection, 'EPSG:4326');\r\n\r\n      const radius = radiusMeters / (Math.cos((Math.PI / 180) * coordinates[1])) / resolution;\r\n      this.activeDrawControl.predefinedRadius$.next(radiusMeters);\r\n      return new OlStyle.Style({\r\n        image: new OlStyle.Circle({\r\n          radius: radius,\r\n          stroke: new OlStyle.Stroke({\r\n            width: 1,\r\n            color: 'rgba(143,7,7,1)'\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'rgba(255,255,255,0.4)'\r\n          })\r\n        })\r\n      });\r\n    };\r\n\r\n    this.activeDrawControl.setOlInteractionStyle(pointStyle);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  onMeasureUnitChange(selectedMeasureUnit: MeasureLengthUnit) {\r\n    if (selectedMeasureUnit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = selectedMeasureUnit;\r\n      this.measureUnit === MeasureLengthUnit.Meters ? this.radiusFormControl.setValue(this.radiusFormControl.value * 1000) :\r\n        this.radiusFormControl.setValue(this.radiusFormControl.value / 1000);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Recreates the style of the feature stored\r\n   */\r\n  private elementStyle(labelsAreShown: boolean, isAnIcon?) {\r\n    if (isAnIcon) {\r\n      this.activeStore.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createIndividualElementStyle(\r\n          feature,\r\n          resolution,\r\n          labelsAreShown,\r\n          feature.get('fontStyle'),\r\n          feature.get('drawingStyle').fill,\r\n          feature.get('drawingStyle').stroke,\r\n          feature.get('offsetX'),\r\n          feature.get('offsetY'),\r\n          this.map.projection,\r\n          this.icon\r\n        );\r\n      });\r\n    } else {\r\n      this.activeStore.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createIndividualElementStyle(\r\n          feature,\r\n          resolution,\r\n          labelsAreShown,\r\n          feature.get('fontStyle'),\r\n          feature.get('drawingStyle').fill,\r\n          feature.get('drawingStyle').stroke,\r\n          feature.get('offsetX'),\r\n          feature.get('offsetY'),\r\n          this.map.projection\r\n        );\r\n      });\r\n    }\r\n  }\r\n\r\n  private getRadius(olGeometry): number{\r\n    const length = getLength(olGeometry);\r\n    return Number(length / (2 * Math.PI));\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\nimport { DrawComponent } from './draw.component';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\nimport { DrawLayerPopupComponent } from './draw-layer-popup.component';\r\n\r\nimport { BrowserModule } from '@angular/platform-browser';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\n\r\nimport {MatRadioModule} from '@angular/material/radio';\r\n\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatListModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDialogModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule,\r\n    ColorPickerModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatRadioModule,\r\n    MatCheckboxModule\r\n  ],\r\n  declarations: [DrawComponent, DrawPopupComponent, DrawLayerPopupComponent, DrawShorcutsComponent],\r\n  exports: [DrawComponent]\r\n})\r\nexport class IgoDrawModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoImageModule } from '@igo2/common';\r\n\r\nimport { FeatureDetailsComponent } from './feature-details.component';\r\nimport { FeatureDetailsDirective } from './feature-details.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule,\r\n    IgoImageModule\r\n  ],\r\n  exports: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective],\r\n  declarations: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective]\r\n})\r\nexport class IgoFeatureDetailsModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { FeatureFormComponent } from './feature-form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [\r\n    IgoFormModule,\r\n    FeatureFormComponent\r\n  ],\r\n  declarations: [\r\n    FeatureFormComponent\r\n  ]\r\n})\r\nexport class IgoFeatureFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFeatureDetailsModule } from './feature-details/feature-details.module';\r\nimport { IgoFeatureFormModule } from './feature-form/feature-form.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoFeatureDetailsModule,\r\n    IgoFeatureFormModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoFeatureModule {}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlTranslate from 'ol/interaction/Translate';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlInteraction from 'ol/interaction/Interaction';\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport MapBrowserEvent from 'ol/MapBrowserEvent';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { ModifyEvent as OlModifyEvent } from 'ol/interaction/Modify';\r\nimport { TranslateEvent as OlTranslateEvent } from 'ol/interaction/Translate';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subject, Subscription, fromEvent } from 'rxjs';\r\n\r\nimport {\r\n  addLinearRingToOlPolygon,\r\n  createDrawHoleInteractionStyle,\r\n  getMousePositionFromOlGeometryEvent\r\n} from '../geometry.utils';\r\n\r\nexport interface ModifyControlOptions {\r\n  source?: OlVectorSource<any>;\r\n  layer?: OlVectorLayer<any>;\r\n  layerStyle?: OlStyleLike;\r\n  drawStyle?: OlStyleLike;\r\n  modify?: boolean;\r\n  translate?: boolean;\r\n}\r\n\r\n/**\r\n * Control to modify geometries\r\n */\r\nexport class ModifyControl {\r\n  /**\r\n   * Modify start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Modify end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Geometry changes observable\r\n   */\r\n  public changes$: Subject<OlGeometry> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer<any>;\r\n  public olModifyInteraction: OlModify;\r\n  private onModifyStartKey: any;\r\n  private onModifyEndKey: any;\r\n  private onModifyKey: any;\r\n  private olModifyInteractionIsActive: boolean = false;\r\n  private olTranslateInteraction: OlTranslate;\r\n  private onTranslateStartKey: any;\r\n  private onTranslateEndKey: any;\r\n  private onTranslateKey: any;\r\n  private olTranslateInteractionIsActive: boolean = false;\r\n  private olDrawInteraction: OlDraw;\r\n  private onDrawStartKey: any;\r\n  private onDrawEndKey: any;\r\n  private onDrawKey: any;\r\n  private olDrawInteractionIsActive: boolean = false;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  private keyDown$$: Subscription;\r\n  private drawKeyUp$$: Subscription;\r\n  private drawKeyDown$$: Subscription;\r\n\r\n  private removedOlInteractions: OlInteraction[] = [];\r\n  private olLinearRingsLayer: OlVectorLayer<any>;\r\n\r\n  // This is the geometry to test against when drawing holes\r\n  private olOuterGeometry: OlGeometry;\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<any> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * OL linear rings source\r\n   * @internal\r\n   */\r\n  get olLinearRingsSource(): OlVectorSource<any> {\r\n    return this.olLinearRingsLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * Whether a modify control should be available\r\n   */\r\n  private modify: boolean = true;\r\n\r\n  /**\r\n   * Whether a translate control should be available\r\n   */\r\n  private translate: boolean = true;\r\n\r\n  constructor(private options: ModifyControlOptions) {\r\n    if (options.modify !== undefined) {\r\n      this.modify = options.modify;\r\n    }\r\n    if (options.translate !== undefined) {\r\n      this.translate = options.translate;\r\n    }\r\n\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n    this.olLinearRingsLayer = this.createOlLinearRingsLayer();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlModifyInteraction();\r\n      this.removeOlTranslateInteraction();\r\n      this.removeOlDrawInteraction();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n\r\n    // The order in which these interactions\r\n    // are added is important\r\n    if (this.modify === true) {\r\n      this.addOlDrawInteraction();\r\n    }\r\n\r\n    if (this.translate === true) {\r\n      this.addOlTranslateInteraction();\r\n      this.activateTranslateInteraction();\r\n    }\r\n\r\n    if (this.modify === true) {\r\n      this.addOlModifyInteraction();\r\n      this.activateModifyInteraction();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource<any> {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Add an OL geometry to the overlay and start modifying it\r\n   * @param olGeometry Ol Geometry\r\n   */\r\n  setOlGeometry(olGeometry: OlGeometry) {\r\n    const olFeature = new OlFeature({ geometry: olGeometry });\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  private createOlLinearRingsLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      style: createDrawHoleInteractionStyle(),\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the linear rings layer\r\n   */\r\n  private addOlLinearRingsLayer() {\r\n    this.olMap.addLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings layer\r\n   */\r\n  private removeOlLinearRingsLayer() {\r\n    this.olMap.removeLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings source\r\n   */\r\n  private clearOlLinearRingsSource() {\r\n    this.olLinearRingsSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Add a modify interaction to the map an set up some listeners\r\n   */\r\n  private addOlModifyInteraction() {\r\n    const olModifyInteraction = new OlModify({\r\n      source: this.olOverlaySource,\r\n      style: this.options.drawStyle as OlStyle.Style\r\n    });\r\n    this.olModifyInteraction = olModifyInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the modify interaction\r\n   */\r\n  private removeOlModifyInteraction() {\r\n    if (this.olModifyInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateModifyInteraction();\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  private activateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = true;\r\n    this.onModifyStartKey = this.olModifyInteraction.on(\r\n      'modifystart',\r\n      (event: OlModifyEvent) => this.onModifyStart(event)\r\n    );\r\n    this.onModifyEndKey = this.olModifyInteraction.on(\r\n      'modifyend',\r\n      (event: OlModifyEvent) => this.onModifyEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olModifyInteraction);\r\n  }\r\n\r\n  private deactivateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = false;\r\n\r\n    unByKey([this.onModifyStartKey, this.onModifyEndKey, this.onModifyKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When modifying starts, clear the overlay and start watching for changes\r\n   * @param event Modify start event\r\n   */\r\n  private onModifyStart(event: OlModifyEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onModifyKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        this.changes$.next(olGeometryEvent.target as OlLineString | OlCircle | OlPolygon);\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When modifying ends, update the geometry observable and stop watching for changes\r\n   * @param event Modify end event\r\n   */\r\n  private onModifyEnd(event: OlModifyEvent) {\r\n    unByKey(this.onModifyKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to space key down to pan the map\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key === ' ') {\r\n          // On space bar, pan to the current mouse position\r\n          this.olMap.getView().animate({\r\n            center: this.mousePosition,\r\n            duration: 0\r\n          });\r\n          return;\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a translate interaction to the map an set up some listeners\r\n   */\r\n  private addOlTranslateInteraction() {\r\n    const olTranslateInteraction = new OlTranslate({\r\n      layers: [this.olOverlayLayer]\r\n    });\r\n    this.olTranslateInteraction = olTranslateInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the translate interaction\r\n   */\r\n  private removeOlTranslateInteraction() {\r\n    if (this.olTranslateInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateTranslateInteraction();\r\n    this.olTranslateInteraction = undefined;\r\n  }\r\n\r\n  private activateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = true;\r\n    this.onTranslateStartKey = this.olTranslateInteraction.on(\r\n      'translatestart',\r\n      (event: OlTranslateEvent) => this.onTranslateStart(event)\r\n    );\r\n    this.onTranslateEndKey = this.olTranslateInteraction.on(\r\n      'translateend',\r\n      (event: OlTranslateEvent) => this.onTranslateEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olTranslateInteraction);\r\n  }\r\n\r\n  private deactivateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = false;\r\n    unByKey([\r\n      this.onTranslateStartKey,\r\n      this.onTranslateEndKey,\r\n      this.onTranslateKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olTranslateInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When translation starts, clear the overlay and start watching for changes\r\n   * @param event Translate start event\r\n   */\r\n  private onTranslateStart(event: OlTranslateEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onTranslateKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        // this.changes$.next(olGeometryEvent.target);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Translate end event\r\n   */\r\n  private onTranslateEnd(event: OlTranslateEvent) {\r\n    unByKey(this.onTranslateKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n  }\r\n\r\n  /**\r\n   * Add a draw interaction to the map an set up some listeners\r\n   */\r\n  private addOlDrawInteraction() {\r\n    const olDrawInteraction = new OlDraw({\r\n      type: 'Polygon',\r\n      source: this.olLinearRingsSource,\r\n      stopClick: true,\r\n      style: createDrawHoleInteractionStyle(),\r\n      condition: (event: MapBrowserEvent<any>) => {\r\n        const olOuterGeometry = this.olOuterGeometry || this.getOlGeometry();\r\n        const intersects = olOuterGeometry.intersectsCoordinate(\r\n          event.coordinate\r\n        );\r\n        return intersects;\r\n      }\r\n    });\r\n\r\n    this.olDrawInteraction = olDrawInteraction;\r\n    this.subscribeToDrawKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key down to activate the draw control\r\n   */\r\n  private subscribeToDrawKeyDown() {\r\n    this.drawKeyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyDown();\r\n\r\n        const olGeometry = this.getOlGeometry();\r\n        if (!olGeometry || !(olGeometry instanceof OlPolygon)) {\r\n          return;\r\n        }\r\n\r\n        this.subscribeToDrawKeyUp();\r\n\r\n        this.deactivateModifyInteraction();\r\n        this.deactivateTranslateInteraction();\r\n        this.activateDrawInteraction();\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key up to deactivate the draw control\r\n   */\r\n  private subscribeToDrawKeyUp() {\r\n    this.drawKeyUp$$ = fromEvent(document, 'keyup').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyUp();\r\n        this.unsubscribeToKeyDown();\r\n        this.deactivateDrawInteraction();\r\n\r\n        this.activateModifyInteraction();\r\n        if (this.translate === true) {\r\n          this.activateTranslateInteraction();\r\n        }\r\n        this.subscribeToDrawKeyDown();\r\n\r\n        this.olOuterGeometry = undefined;\r\n        this.clearOlLinearRingsSource();\r\n        this.end$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to draw key down\r\n   */\r\n  private unsubscribeToDrawKeyDown() {\r\n    if (this.drawKeyDown$$ !== undefined) {\r\n      this.drawKeyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key up\r\n   */\r\n  private unsubscribeToDrawKeyUp() {\r\n    if (this.drawKeyUp$$ !== undefined) {\r\n      this.drawKeyUp$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the draw interaction\r\n   */\r\n  private removeOlDrawInteraction() {\r\n    if (this.olDrawInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.unsubscribeToKeyDown();\r\n    this.unsubscribeToDrawKeyUp();\r\n    this.unsubscribeToDrawKeyDown();\r\n    this.deactivateDrawInteraction();\r\n    this.clearOlLinearRingsSource();\r\n    this.olDrawInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * Activate the draw interaction\r\n   */\r\n  private activateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.clearOlLinearRingsSource();\r\n    this.addOlLinearRingsLayer();\r\n\r\n    this.olMap.getInteractions().forEach((olInteraction: OlInteraction) => {\r\n      if (olInteraction instanceof OlDragBoxInteraction) {\r\n        this.olMap.removeInteraction(olInteraction);\r\n        this.removedOlInteractions.push(olInteraction);\r\n      }\r\n    });\r\n\r\n    this.olDrawInteractionIsActive = true;\r\n    this.onDrawStartKey = this.olDrawInteraction.on(\r\n      'drawstart',\r\n      (event: OlDrawEvent) => this.onDrawStart(event)\r\n    );\r\n    this.onDrawEndKey = this.olDrawInteraction.on(\r\n      'drawend',\r\n      (event: OlDrawEvent) => this.onDrawEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olDrawInteraction);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the draw interaction\r\n   */\r\n  private deactivateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.removeOlLinearRingsLayer();\r\n\r\n    this.removedOlInteractions.forEach((olInteraction: OlInteraction) => {\r\n      this.olMap.addInteraction(olInteraction);\r\n    });\r\n    this.removedOlInteractions = [];\r\n\r\n    this.olDrawInteractionIsActive = false;\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When draw start, add a new linerar ring to the geometry and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.olOuterGeometry = this.getOlGeometry().clone();\r\n\r\n    const linearRingCoordinates = ((olGeometry as any).getLinearRing() as any).getCoordinates();\r\n    this.addLinearRingToOlGeometry(linearRingCoordinates);\r\n    this.start$.next(this.getOlGeometry());\r\n\r\n    this.onDrawKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        const olGeometryTarget = olGeometryEvent.target as OlPolygon;\r\n        const _linearRingCoordinates = olGeometryTarget\r\n          .getLinearRing(0)\r\n          .getCoordinates();\r\n        this.updateLinearRingOfOlGeometry(_linearRingCoordinates);\r\n        this.changes$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Draw end event\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    unByKey(this.onDrawKey);\r\n    this.olOuterGeometry = undefined;\r\n\r\n    const linearRingCoordinates = ((event.feature\r\n      .getGeometry() as any)\r\n      .getLinearRing() as any)\r\n      .getCoordinates();\r\n    this.updateLinearRingOfOlGeometry(linearRingCoordinates);\r\n    this.clearOlLinearRingsSource();\r\n    this.end$.next(this.getOlGeometry());\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Add a linear ring to the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private addLinearRingToOlGeometry(coordinates: number[]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    const olLinearRing = new OlLinearRing(coordinates);\r\n    addLinearRingToOlPolygon(olGeometry, olLinearRing);\r\n  }\r\n\r\n  /**\r\n   * Update the last linear ring of the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private updateLinearRingOfOlGeometry(coordinates: number[][]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    // Remove the last linear ring (the one we are updating)\r\n    const olLinearRings = olGeometry.getLinearRings().slice(0, -1);\r\n    const newCoordinates = olLinearRings.map((olLinearRing: OlLinearRing) => {\r\n      return olLinearRing.getCoordinates();\r\n    });\r\n    newCoordinates.push(coordinates);\r\n    olGeometry.setCoordinates(newCoordinates);\r\n  }\r\n\r\n  /**\r\n   * Get the geometry being modified\r\n   * @returns OL Geometry\r\n   */\r\n  private getOlGeometry(): OlGeometry {\r\n    const olFeatures = this.olOverlaySource.getFeatures();\r\n    return olFeatures.length > 0 ? olFeatures[0].getGeometry() : undefined;\r\n  }\r\n}\r\n","export const LAYER = 'Layer';\r\n","<h3 mat-dialog-title>{{'igo.geo.measure.dialog.title' | translate}}</h3>\r\n\r\n<table *ngIf=\"data.length > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.length.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Meters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Kilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Miles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Feet}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInFeet' | translate}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<table *ngIf=\"data.area > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.area.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMeters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat:measureAreaUnit.SquareKilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMiles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Acres}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInAcres' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Hectares}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInHectares' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{'igo.geo.measure.dialog.perimeterInMeters' | translate}}</td>\r\n      <td>{{data.perimeter | measureFormat: measureLengthUnit.Meters}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n","import { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { MeasurerDialogData } from '../shared/measure.interfaces';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit} from '../shared/measure.enum';\r\n\r\n@Component({\r\n  selector: 'igo-measurer-dialog',\r\n  templateUrl: 'measurer-dialog.component.html',\r\n  styleUrls: ['./measurer-dialog.component.scss']\r\n})\r\nexport class MeasurerDialogComponent {\r\n\r\n  measureAreaUnit = MeasureAreaUnit;\r\n\r\n  measureLengthUnit = MeasureLengthUnit;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<MeasurerDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: MeasurerDialogData\r\n  ) {}\r\n\r\n  onNoClick(): void {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n}\r\n","<div>\r\n  <div class=\"measure-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      [value]=\"activeMeasureType\"\r\n      (change)=\"onMeasureTypeChange($event.value)\">\r\n      <mat-button-toggle [value]=\"measureType.Length\">\r\n        {{('igo.geo.measure.' + measureType.Length) | translate}}\r\n      </mat-button-toggle>\r\n      <mat-button-toggle [value]=\"measureType.Area\">\r\n        {{('igo.geo.measure.' + measureType.Area) | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"measure-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.measure.toggleActive' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasLine$ | async)\"\r\n      [checked]=\"displayLines\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayLines($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayLines' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayDistance\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayDistance($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayDistance' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayAreas\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayAreas($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayAreas' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"measureUnitsAuto\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleMeasureUnitsAuto($event.checked)\">\r\n      {{'igo.geo.measure.toggleAutoUnits' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <ng-container *ngIf=\"measure$ | async as measure\">\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Length || activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Length\"\r\n      [measureUnit]=\"measureLengthUnit.Meters\"\r\n      [measure]=\"measure.length\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"(activeMeasureType === measureType.Area ? 'igo.geo.measure.perimeter' : 'igo.geo.measure.length') | translate\"\r\n      (measureUnitChange)=\"onLengthUnitChange($event)\">\r\n    </igo-measurer-item>\r\n\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Area\"\r\n      [measureUnit]=\"measureAreaUnit.SquareMeters\"\r\n      [measure]=\"measure.area\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"'igo.geo.measure.area' | translate\"\r\n      (measureUnitChange)=\"onAreaUnitChange($event)\">\r\n    </igo-measurer-item>\r\n  </ng-container>\r\n\r\n  <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n  <div class=\"measure-store-buttons\">\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.calculate.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"accent\"\r\n      (click)=\"onCalculateClick()\">\r\n      <mat-icon svgIcon=\"calculator\"></mat-icon>\r\n    </button>\r\n\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.delete.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"warn\"\r\n      (click)=\"onDeleteClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <!--button\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.modify.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length !== 1\"\r\n      (click)=\"onModifyClick()\">\r\n      <mat-icon svgIcon=\"edit\"></mat-icon>\r\n    </button-->\r\n  </div>\r\n\r\n  <igo-entity-table\r\n    #table\r\n    class=\"table-compact\"\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport OlStyle from 'ol/style/Style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { LanguageService, StorageScope, StorageService } from '@igo2/core';\r\nimport { EntityRecord, EntityTableTemplate } from '@igo2/common';\r\nimport type { EntityTableComponent } from '@igo2/common';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy\r\n} from '../../feature';\r\nimport { DrawControl, ModifyControl } from '../../geometry/shared';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { Measure, MeasurerDialogData, FeatureWithMeasure } from '../shared/measure.interfaces';\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit,\r\n} from '../shared/measure.enum';\r\nimport {\r\n  measureOlGeometry,\r\n  createMeasureInteractionStyle,\r\n  createMeasureLayerStyle,\r\n  updateOlTooltipsAtMidpoints,\r\n  updateOlTooltipAtCenter,\r\n  getTooltipsOfOlGeometry,\r\n  squareMetersToUnit,\r\n  metersToUnit,\r\n  formatMeasure\r\n} from '../shared/measure.utils';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * Tool to measure lengths and areas\r\n */\r\n@Component({\r\n  selector: 'igo-measurer',\r\n  templateUrl: './measurer.component.html',\r\n  styleUrls: ['./measurer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'length',\r\n        title: this.languageService.translate.instant('igo.geo.measure.lengthHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeLengthUnit;\r\n          const measure = metersToUnit(localFeature.properties.measure.length, unit);\r\n          return formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          });\r\n        }\r\n      },\r\n      {\r\n        name: 'area',\r\n        title: this.languageService.translate.instant('igo.geo.measure.areaHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeAreaUnit;\r\n          const measure = squareMetersToUnit(localFeature.properties.measure.area, unit);\r\n          return measure ? formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          }) : '';\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Reference to the MeasureType enum\r\n   * @internal\r\n   */\r\n  public measureType = MeasureType;\r\n\r\n  /**\r\n   * Reference to the AreaMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureAreaUnit = MeasureAreaUnit;\r\n\r\n  /**\r\n   * Reference to the LengthMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureLengthUnit = MeasureLengthUnit;\r\n\r\n  /**\r\n   * Whether measure units should be automatically determined\r\n   * @internal\r\n   */\r\n  public measureUnitsAuto: boolean = false;\r\n\r\n  /**\r\n   * Whether display of distances of areas\r\n   * @internal\r\n   */\r\n  public displayDistance: boolean = true;\r\n\r\n  /**\r\n   * Whether display of distances of lines\r\n   * @internal\r\n   */\r\n  public displayLines: boolean = true;\r\n\r\n  /**\r\n   * Whether display of areas\r\n   * @internal\r\n   */\r\n  public displayAreas: boolean = true;\r\n\r\n  /**\r\n   * Observable of line boolean\r\n   * @internal\r\n   */\r\n   public hasLine$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area boolean\r\n   * @internal\r\n   */\r\n  public hasArea$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<Measure> = new BehaviorSubject({});\r\n\r\n  /**\r\n   * Observable of selected features\r\n   * @internal\r\n   */\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithMeasure[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * OL draw source\r\n   * @internal\r\n   */\r\n  public showTooltips: boolean = true;\r\n\r\n  /**\r\n   * Whether draw control toggle is disabled or not\r\n   * @internal\r\n   */\r\n  public drawControlIsDisabled: boolean = true;\r\n\r\n  /**\r\n   * Draw line control\r\n   */\r\n  private drawLineControl: DrawControl;\r\n\r\n  /**\r\n   * Draw polygon control\r\n   */\r\n  private drawPolygonControl: DrawControl;\r\n\r\n  /**\r\n   * Modify control\r\n   */\r\n  private modifyControl: ModifyControl;\r\n\r\n  /**\r\n   * Active OL geometry\r\n   */\r\n  private activeOlGeometry: OlLineString | OlPolygon;\r\n\r\n  /**\r\n   * Active mlength unit\r\n   */\r\n  private activeLengthUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  /**\r\n   * Active area unit\r\n   */\r\n  private activeAreaUnit: MeasureAreaUnit = MeasureAreaUnit.SquareMeters;\r\n\r\n  /**\r\n   * Feature added listener key\r\n   */\r\n  private onFeatureAddedKey;\r\n\r\n  /**\r\n   * Feature removed listener key\r\n   */\r\n  private onFeatureRemovedKey;\r\n\r\n  /**\r\n   * Active draw control\r\n   * @internal\r\n   */\r\n  private activeDrawControl: DrawControl;\r\n\r\n  /**\r\n   * Subscription to draw start\r\n   */\r\n  private drawStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to draw end\r\n   */\r\n  private drawEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private drawChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify start\r\n   */\r\n  private modifyStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify end\r\n   */\r\n  private modifyEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private modifyChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to measures selection\r\n   */\r\n  private selectedFeatures$$: Subscription;\r\n\r\n  /**\r\n   * OL draw source\r\n   */\r\n  private olDrawSource = new OlVectorSource();\r\n\r\n  /**\r\n   * The map to measure on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The measures store\r\n   */\r\n  @Input() store: FeatureStore<FeatureWithMeasure>;\r\n\r\n  /**\r\n   * Measure type\r\n   * @internal\r\n   */\r\n  @Input()\r\n  set activeMeasureType(value: MeasureType) { this.setActiveMeasureType(value); }\r\n  get activeMeasureType(): MeasureType { return this._activeMeasureType; }\r\n  private _activeMeasureType: MeasureType;\r\n\r\n  /**\r\n   * The minimum length a segment must have to display a tooltip.\r\n   * It also applies to area tooltips.\r\n   */\r\n  @Input() minSegmentLength: number = 10;\r\n\r\n  @ViewChild('table', { static: true }) table: EntityTableComponent;\r\n\r\n  /**\r\n   * Wheter one of the draw control is active\r\n   * @internal\r\n   */\r\n  get drawControlIsActive(): boolean {\r\n    return this.activeDrawControl !== undefined;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.map.ol.getView().getProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dialog: MatDialog,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * Add draw controls and activate one\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.createDrawLineControl();\r\n    this.createDrawPolygonControl();\r\n    this.createModifyControl();\r\n    this.toggleDrawControl();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    this.checkDistanceAreaToggle();\r\n    this.setActiveMeasureType(MeasureType.Length);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.setActiveMeasureType(undefined);\r\n    this.deactivateModifyControl();\r\n    this.freezeStore();\r\n    this.subscriptions$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onMeasureTypeChange(measureType: MeasureType) {\r\n    this.activeMeasureType = measureType;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggle: boolean) {\r\n    if (toggle === true) {\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.deactivateDrawControl();\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n   onToggleMeasureUnitsAuto(toggle: boolean) {\r\n    this.measureUnitsAuto = toggle;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayDistance(toggle: boolean) {\r\n    this.displayDistance = toggle;\r\n    this.onDisplayDistance();\r\n    toggle ? (this.storageService.set('distanceToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('distanceToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the lines\r\n   * @internal\r\n   */\r\n  onToggleDisplayLines(toggle: boolean) {\r\n    this.displayLines = toggle;\r\n    this.onDisplayLines();\r\n    toggle ? (this.storageService.set('linesToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('linesToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayAreas(toggle: boolean) {\r\n    this.displayAreas = toggle;\r\n    this.onDisplayAreas();\r\n    toggle ? (this.storageService.set('areasToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('areasToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Set display parametres in current values\r\n   * @internal\r\n   */\r\n  checkDistanceAreaToggle(){\r\n    if (this.storageService.get('distanceToggle') === false){\r\n      this.displayDistance = false;\r\n    }\r\n    if (this.storageService.get('linesToggle') === false){\r\n      this.displayLines = false;\r\n    }\r\n    if (this.storageService.get('areasToggle') === false){\r\n      this.displayAreas = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of areas\r\n   * @internal\r\n   */\r\n  onDisplayDistance() {\r\n    if (this.displayDistance) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of lines\r\n   * @internal\r\n   */\r\n  onDisplayLines() {\r\n    if (this.displayLines) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onDisplayAreas() {\r\n    if (this.displayAreas) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onLengthUnitChange(unit: MeasureLengthUnit) {\r\n    this.activeLengthUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onAreaUnitChange(unit: MeasureAreaUnit) {\r\n    this.activeAreaUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  onCalculateClick() {\r\n    const features = this.selectedFeatures$.value;\r\n    const area = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      return sum + localFeature.properties.measure.area || 0;\r\n    }, 0);\r\n    const length = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'Polygon') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n    const perimeter = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'LineString') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n\r\n    this.openDialog({\r\n      area,\r\n      length,\r\n      perimeter\r\n    });\r\n  }\r\n\r\n  onDeleteClick() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach(selectedFeature => {\r\n      this.olDrawSource.getFeatures().forEach(drawingLayerFeature => {\r\n        const geometry = drawingLayerFeature.getGeometry() as any;\r\n        if (selectedFeature.properties.id === geometry.ol_uid) {\r\n          this.olDrawSource.removeFeature(drawingLayerFeature);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  onModifyClick() {\r\n    if (this.selectedFeatures$.value.length !== 1) { return; }\r\n\r\n    if (this.modifyControl.active === true) {\r\n      this.deactivateModifyControl();\r\n      this.toggleDrawControl();\r\n    } else {\r\n      const localFeature = this.selectedFeatures$.value[0];\r\n      const olFeatures = this.store.layer.ol.getSource().getFeatures();\r\n      const olFeature = olFeatures.find((_olFeature: OlFeature<OlGeometry>) => {\r\n        return _olFeature.get('id') === localFeature.properties.id;\r\n      });\r\n\r\n      if (olFeature !== undefined) {\r\n        this.deactivateDrawControl();\r\n        this.activateModifyControl();\r\n\r\n        const olGeometry = olFeature.getGeometry();\r\n        this.clearTooltipsOfOlGeometry(olGeometry as (OlLineString | OlPolygon));\r\n        this.modifyControl.setOlGeometry(olGeometry);\r\n      }\r\n    }\r\n  }\r\n\r\n  private openDialog(data: MeasurerDialogData): void {\r\n    this.dialog.open(MeasurerDialogComponent, {data});\r\n  }\r\n\r\n  /**\r\n   * Initialize the measure store and set up some listeners\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      title: this.languageService.translate.instant('igo.geo.measure.layerTitle'),\r\n      isIgoInternalLayer: true,\r\n      id: `igo-measures-${uuid()}`,\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: createMeasureLayerStyle(),\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: { enabled: false }\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n    store.layer.visible = true;\r\n    layer.visible$.subscribe(visible => {\r\n      if (visible) {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-measure-by-display'));\r\n      }\r\n      else {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-measure-by-display'));\r\n      }\r\n    });\r\n\r\n    tryAddLoadingStrategy(store);\r\n\r\n    tryAddSelectionStrategy(store, new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      many: true\r\n    }));\r\n\r\n    this.onFeatureAddedKey = store.source.ol.on('addfeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const localFeature = event.feature;\r\n      const olGeometry = localFeature.getGeometry() as any;\r\n      this.updateMeasureOfOlGeometry(olGeometry, localFeature.get('measure'));\r\n      this.onDisplayDistance();\r\n    });\r\n\r\n    this.onFeatureRemovedKey = store.source.ol.on('removefeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const olGeometry = event.feature.getGeometry() as any;\r\n      this.clearTooltipsOfOlGeometry(olGeometry);\r\n    });\r\n\r\n    this.selectedFeatures$$ = store.stateView.manyBy$((record: EntityRecord<FeatureWithMeasure>) => {\r\n      return record.state.selected === true;\r\n    }).pipe(\r\n      skip(1) // Skip initial emission\r\n    )\r\n    .subscribe((records: EntityRecord<FeatureWithMeasure>[]) => {\r\n      if (this.modifyControl.active === true) {\r\n        this.deactivateModifyControl();\r\n      }\r\n      this.selectedFeatures$.next(records.map(record => record.entity));\r\n    });\r\n\r\n    this.subscriptions$$.push(this.store.entities$.subscribe(objectsExists => {\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'Polygon')){\r\n        this.hasArea$.next(true);\r\n      } else {\r\n        this.hasArea$.next(false);\r\n      }\r\n\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'LineString')){\r\n        this.hasLine$.next(true);\r\n      } else {\r\n        this.hasLine$.next(false);\r\n      }\r\n    }));\r\n\r\n    this.subscriptions$$.push(this.store.count$.subscribe(cnt => {\r\n      cnt >= 1 ?\r\n        this.store.layer.options.showInLayerList = true :\r\n        this.store.layer.options.showInLayerList = false;\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Freeze any store, meaning the layer is removed, strategies are deactivated\r\n   * and some listener removed\r\n   * @internal\r\n   */\r\n  private freezeStore() {\r\n    const store = this.store;\r\n    this.selectedFeatures$$.unsubscribe();\r\n    unByKey(this.onFeatureAddedKey);\r\n    unByKey(this.onFeatureRemovedKey);\r\n    store.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    store.deactivateStrategyOfType(FeatureStoreSelectionStrategy);\r\n  }\r\n\r\n  /**\r\n   * Create a draw line control\r\n   */\r\n  private createDrawLineControl() {\r\n    this.drawLineControl = new DrawControl({\r\n      geometryType: 'LineString',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createDrawPolygonControl() {\r\n    this.drawPolygonControl = new DrawControl({\r\n      geometryType: 'Polygon',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createModifyControl() {\r\n    this.modifyControl = new ModifyControl({\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate the right control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    // this.deactivateModifyControl();\r\n    if (this.activeMeasureType === MeasureType.Length) {\r\n      this.activateDrawControl(this.drawLineControl);\r\n    } else if (this.activeMeasureType === MeasureType.Area) {\r\n      this.activateDrawControl(this.drawPolygonControl);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param drawControl Draw control\r\n   */\r\n  private activateDrawControl(drawControl: DrawControl) {\r\n    this.drawControlIsDisabled = false;\r\n    this.activeDrawControl = drawControl;\r\n    this.drawStart$$ = drawControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawStart(olGeometry));\r\n    this.drawEnd$$ = drawControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawEnd(olGeometry));\r\n    this.drawChanges$$ = drawControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawChanges(olGeometry));\r\n    this.drawChanges$$ = drawControl.abort$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => {\r\n        this.clearTooltipsOfOlGeometry(olGeometry);\r\n        this.clearMeasures();\r\n      });\r\n    drawControl.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (this.activeDrawControl === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n    if (this.drawStart$$ !== undefined ) { this.drawStart$$.unsubscribe(); }\r\n    if (this.drawEnd$$ !== undefined ) { this.drawEnd$$.unsubscribe(); }\r\n    if (this.drawChanges$$ !== undefined ) { this.drawChanges$$.unsubscribe(); }\r\n\r\n    this.clearTooltipsOfOlSource(this.olDrawSource);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.clearTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.activeDrawControl = undefined;\r\n    this.activeOlGeometry = undefined;\r\n  }\r\n\r\n  private setActiveMeasureType(measureType: MeasureType) {\r\n    this._activeMeasureType = measureType;\r\n    this.clearMeasures();\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = undefined;\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n    this.addFeatureToStore(olGeometry);\r\n    this.clearTooltipsOfOlGeometry(olGeometry);\r\n    this.olDrawSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawChanges(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, Object.assign({}, measure, {\r\n      area: undefined // We don't want to display an area tooltip while drawing.\r\n    }));\r\n    this.measure$.next(measure);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param modifyControl Modify control\r\n   */\r\n  private activateModifyControl() {\r\n    const selection = this.store.getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    selection.deactivate();\r\n    selection.clear();\r\n\r\n    this.modifyStart$$ = this.modifyControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyStart(olGeometry));\r\n    this.modifyEnd$$ = this.modifyControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyEnd(olGeometry));\r\n    this.modifyChanges$$ = this.modifyControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyChanges(olGeometry));\r\n    this.modifyControl.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active modify control\r\n   */\r\n  private deactivateModifyControl() {\r\n    if (this.modifyStart$$ !== undefined ) { this.modifyStart$$.unsubscribe(); }\r\n    if (this.modifyEnd$$ !== undefined ) { this.modifyEnd$$.unsubscribe(); }\r\n    if (this.modifyChanges$$ !== undefined ) { this.modifyChanges$$.unsubscribe(); }\r\n\r\n    if (this.activeOlGeometry !== undefined) {\r\n      if (this.selectedFeatures$.value.length === 1) {\r\n        const localFeature = this.selectedFeatures$.value[0];\r\n        this.addFeatureToStore(this.activeOlGeometry, localFeature);\r\n      }\r\n      this.finalizeMeasureOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n\r\n    this.store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n\r\n    this.activeOlGeometry = undefined;\r\n    this.modifyControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawStart(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyChanges(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawChanges(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  private finalizeMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, measure);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables\r\n   * @param olGeometry Ol linestring or polygon\r\n   * @param measure Measure\r\n   */\r\n  private updateMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon, measure: Measure) {\r\n    olGeometry.setProperties({_measure: measure}, true);\r\n    this.updateTooltipsOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the measures observables\r\n   */\r\n  private clearMeasures() {\r\n    this.measure$.next({});\r\n  }\r\n\r\n  /**\r\n   * Add a feature with measures to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(olGeometry, localFeature?: FeatureWithMeasure) {\r\n    const featureId = localFeature ? localFeature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        measure: olGeometry.get('_measure')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update all the tooltips of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   * @param lengths Lengths of the OL geometry's segments\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = olGeometry.get('_measure');\r\n    const lengths = measure.lengths;\r\n    const area = measure.area;\r\n\r\n    const olMidpointsTooltips = updateOlTooltipsAtMidpoints(olGeometry);\r\n    if (lengths.length === olMidpointsTooltips.length) {\r\n      for (let i = 0; i < olMidpointsTooltips.length; i++) {\r\n        const length = lengths[i];\r\n        if (length !== undefined) {\r\n          this.updateOlTooltip(\r\n            olMidpointsTooltips[i],\r\n            metersToUnit(length, this.activeLengthUnit),\r\n            this.activeLengthUnit,\r\n            MeasureType.Length\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (area !== undefined) {\r\n      this.updateOlTooltip(\r\n        updateOlTooltipAtCenter(olGeometry),\r\n        squareMetersToUnit(area, this.activeAreaUnit),\r\n        this.activeAreaUnit,\r\n        MeasureType.Area\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of a geoemtry\r\n   */\r\n  private showTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (this.shouldShowTooltip(olTooltip)) {\r\n        this.map.ol.addOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometrys\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (olTooltip !== undefined && olTooltip.getMap() !== undefined) {\r\n        this.map.ol.removeOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private updateTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.updateTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private showTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.showTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the map tooltips\r\n   * @param olDrawSource OL vector source\r\n   */\r\n  private clearTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry !== undefined) {\r\n        this.clearTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update an OL tooltip properties and inner HTML and add it to the map if possible\r\n   * @param olTooltip OL tooltip\r\n   * @param measure The measure valeu ti display\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateOlTooltip(\r\n    olTooltip: OlOverlay,\r\n    measure: number,\r\n    unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    type: MeasureType\r\n  ) {\r\n    olTooltip.setProperties({_measure: measure, _unit: unit, _type: type}, true);\r\n    olTooltip.getElement().innerHTML = this.computeTooltipInnerHTML(olTooltip);\r\n    if (this.shouldShowTooltip(olTooltip)) {\r\n      this.map.ol.addOverlay(olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Compute a tooltip's content\r\n   * @param olTooltip OL overlay\r\n   * @returns Inner HTML\r\n   */\r\n  private computeTooltipInnerHTML(olTooltip: OlOverlay): string {\r\n    const properties = olTooltip.getProperties() as any;\r\n    return formatMeasure(properties._measure, {\r\n      decimal: 1,\r\n      unit: properties._unit,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    }, this.languageService);\r\n  }\r\n\r\n  /**\r\n   * Whether a tooltip should be showned based on the length\r\n   * of the segment it is bound to.\r\n   * @param olTooltip OL overlay\r\n   * @returns True if the tooltip should be shown\r\n   */\r\n  private shouldShowTooltip(olTooltip: OlOverlay): boolean {\r\n    if (this.showTooltips === false) {\r\n      return false;\r\n    }\r\n\r\n    const properties = olTooltip.getProperties() as any;\r\n    const measure = properties._measure;\r\n    if (measure === undefined) {\r\n      return false;\r\n    }\r\n\r\n    if (properties._unit === MeasureType.Length) {\r\n      const minSegmentLength = metersToUnit(this.minSegmentLength, properties._unit) || 0;\r\n      return measure > Math.max(minSegmentLength, 0);\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit } from '../shared/measure.enum';\r\nimport { metersToUnit, squareMetersToUnit, formatMeasure } from '../shared/measure.utils';\r\n\r\n/**\r\n * This pipe returns a measure converted from meters (or square meters)\r\n * to the specified unit. It also keeps a certain number of decimals.\r\n */\r\n@Pipe({\r\n  name: 'measureFormat'\r\n})\r\nexport class MeasureFormatPipe implements PipeTransform {\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  transform(\r\n    value: number, unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    unitAbbr: boolean = false,\r\n    decimal: number = 1\r\n  ): number {\r\n    let out;\r\n    if (Object.values(MeasureAreaUnit).indexOf(unit as MeasureAreaUnit) >= 0) {\r\n      out = squareMetersToUnit(value, unit as MeasureAreaUnit);\r\n    } else if (Object.values(MeasureLengthUnit).indexOf(unit as MeasureLengthUnit) >= 0) {\r\n      out = metersToUnit(value, unit as MeasureLengthUnit);\r\n    }\r\n\r\n    return out ? formatMeasure(out, {\r\n      decimal: 1,\r\n      unit,\r\n      unitAbbr,\r\n      locale: 'fr'\r\n    }) : out;\r\n  }\r\n}\r\n","import { DrawControlOptions } from './../shared/controls/draw';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  Optional,\r\n  Self,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { NgControl, ControlValueAccessor } from '@angular/forms';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport * as olproj from 'ol/proj';\r\nimport Point from 'ol/geom/Point';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport {\r\n  MeasureLengthUnit,\r\n  updateOlGeometryMidpoints,\r\n  formatMeasure,\r\n  measureOlGeometry\r\n} from '../../measure';\r\nimport { DrawControl, ModifyControl, ModifyControlOptions } from '../shared/controls';\r\nimport { createDrawInteractionStyle } from '../shared/geometry.utils';\r\nimport { GeoJSONGeometry } from '../shared/geometry.interfaces';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\n\r\ninterface HasRadius {\r\n  getRadius: () => number\r\n  setRadius: (radius: number) => void\r\n}\r\n\r\n/**\r\n * This input allows a user to draw a new geometry or to edit\r\n * an existing one on a map. A text input is also displayed in the\r\n * form with some instructions.\r\n * This is still WIP.\r\n */\r\n@Component({\r\n  selector: 'igo-geometry-form-field-input',\r\n  templateUrl: './geometry-form-field-input.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class GeometryFormFieldInputComponent implements OnInit, OnDestroy, ControlValueAccessor {\r\n\r\n  private olOverlayLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olGeoJSON = new OlGeoJSON();\r\n  private ready = false;\r\n\r\n  private drawControl: DrawControl;\r\n  private modifyControl: ModifyControl;\r\n  private defaultDrawStyleRadius: number;\r\n  private olGeometryEnds$$: Subscription;\r\n  private olGeometryChanges$$: Subscription;\r\n  private olTooltip = this.createMeasureTooltip();\r\n\r\n  /**\r\n   * Active control\r\n   * @internal\r\n   */\r\n  public activeControl: DrawControl | ModifyControl;\r\n\r\n  /**\r\n   * The map to draw the geometry on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The geometry type\r\n   */\r\n  @Input()\r\n  set geometryType(value: Type) {\r\n    this._geometryType = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get geometryType(): Type { return this._geometryType; }\r\n  private _geometryType: Type;\r\n\r\n  /**\r\n   * The drawGuide around the mouse pointer to help drawing\r\n   */\r\n  @Input() drawGuide: number = null;\r\n\r\n  /**\r\n   * Whether a measure tooltip should be displayed\r\n   */\r\n  @Input() measure: boolean = false;\r\n\r\n  /**\r\n   * Whether draw control should be active or not\r\n   */\r\n  @Input()\r\n  get drawControlIsActive(): boolean { return this._drawControlIsActive; }\r\n  set drawControlIsActive(value: boolean) {\r\n    this._drawControlIsActive = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    this.deactivateControl();\r\n    if (!this._drawControlIsActive) {\r\n      return;\r\n    } else {\r\n      this.toggleControl();\r\n    }\r\n  }\r\n  private _drawControlIsActive: boolean = true;\r\n\r\n  /**\r\n   * Whether freehand draw control should be active or not\r\n   */\r\n  @Input()\r\n  get freehandDrawIsActive(): boolean { return this._freehandDrawIsActive; }\r\n  set freehandDrawIsActive(value: boolean) {\r\n    this._freehandDrawIsActive = value;\r\n    this.deactivateControl();\r\n\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (!this.drawControlIsActive) {\r\n      return;\r\n    }\r\n    this.toggleControl();\r\n  }\r\n  private _freehandDrawIsActive: boolean;\r\n\r\n  /**\r\n   * Whether freehand draw control should be active or not\r\n   */\r\n  @Input()\r\n  get predefinedRadius(): boolean { return this._predefinedRadius; }\r\n  set predefinedRadius(value: boolean) {\r\n    this._predefinedRadius = value;\r\n    this.drawControl.ispredefinedRadius$.next(value);\r\n  }\r\n  private _predefinedRadius: boolean;\r\n\r\n  /**\r\n   * Control options\r\n   */\r\n  @Input() controlOptions: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Style for the draw control (applies while the geometry is being drawn)\r\n   */\r\n  @Input()\r\n  set drawStyle(value: OlStyleLike | OlStyle.RegularShape) {\r\n    if (value === undefined) {\r\n      value = createDrawInteractionStyle();\r\n    }\r\n    this._drawStyle = value;\r\n\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(value);\r\n    if (olGuideStyle !== undefined) {\r\n      this.defaultDrawStyleRadius = olGuideStyle.getRadius();\r\n    } else {\r\n      this.defaultDrawStyleRadius = null;\r\n    }\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get drawStyle(): OlStyleLike | OlStyle.RegularShape { return this._drawStyle; }\r\n  private _drawStyle: OlStyleLike | OlStyle.RegularShape;\r\n\r\n  /**\r\n   * Style for the overlay layer (applies once the geometry is added to the map)\r\n   * If not specified, drawStyle applies\r\n   */\r\n  @Input()\r\n  set overlayStyle(value: OlStyleLike | OlStyle.RegularShape) { this._overlayStyle = value; }\r\n  get overlayStyle(): OlStyleLike | OlStyle.RegularShape { return this._overlayStyle; }\r\n  private _overlayStyle: OlStyleLike | OlStyle.RegularShape;\r\n\r\n  /**\r\n   * The geometry value (GeoJSON)\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  @Input()\r\n  set value(value: GeoJSONGeometry) {\r\n    this._value = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (value) {\r\n      this.addGeoJSONToOverlay(value);\r\n    } else {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n    this.onChange(value);\r\n    this.toggleControl();\r\n    this.cdRef.detectChanges();\r\n  }\r\n  get value(): GeoJSONGeometry { return this._value; }\r\n  private _value: GeoJSONGeometry;\r\n\r\n  /**\r\n   * The vector source to add the geometry to\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<OlGeometry> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  @Input()\r\n  set radius(value: any) {\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    if (this.modifyControl.getSource()) {\r\n      this.modifyControl.getSource().refresh();\r\n    }\r\n    if (this.freehandDrawIsActive) {\r\n      let olModify;\r\n      setTimeout(() => {\r\n        olModify = this.modifyControl.olModifyInteraction;\r\n        if (olModify) {\r\n          if (olModify.features_) {\r\n            olModify.features_.clear();\r\n            this.addGeoJSONToOverlay(this.value);\r\n          }\r\n        }\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    @Optional() @Self() public ngControl: NgControl\r\n  ) {\r\n    if (this.ngControl !== undefined) {\r\n      // Setting the value accessor directly (instead of using\r\n      // the providers) to avoid running into a circular import.\r\n      this.ngControl.valueAccessor = this;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an overlay layer, add the initial geometry to it (if any)\r\n   * and toggle the right interaction.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    if (this.drawStyle === undefined) {\r\n      this.drawStyle = createDrawInteractionStyle();\r\n    }\r\n\r\n    if (this.overlayStyle === undefined) {\r\n      this.overlayStyle = this.drawStyle;\r\n    }\r\n\r\n    this.addOlOverlayLayer();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    if (this.value) {\r\n      this.addGeoJSONToOverlay(this.value);\r\n    }\r\n    this.toggleControl();\r\n\r\n    this.ready = true;\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    // This is mandatory when the form control is reused after\r\n    // this component has been destroyed. It seems like the control\r\n    // keeps a reference to this component even after it's destroyed\r\n    // and it attempts to set it's value\r\n    this.ready = false;\r\n\r\n    this.deactivateControl();\r\n    this.olOverlaySource.clear();\r\n    this.map.ol.removeLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnChange(fn: Function) {\r\n    this.onChange = fn;\r\n  }\r\n  private onChange: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnTouched(fn: Function) {\r\n    this.onTouched = fn;\r\n  }\r\n  private onTouched: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  writeValue(value: GeoJSONGeometry) {\r\n    this.value = value;\r\n  }\r\n\r\n  /**\r\n   * Add an overlay layer to the map\r\n   */\r\n  private addOlOverlayLayer() {\r\n    this.olOverlayLayer = new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      zIndex: 500,\r\n      style: null\r\n    });\r\n    this.map.ol.addLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create a draw control and subscribe to it's geometry\r\n   */\r\n  private createDrawControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      geometryType: this.geometryType || 'Point',\r\n      drawingLayer: this.olOverlayLayer,\r\n      interactionStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as DrawControlOptions;\r\n    this.drawControl = new DrawControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Create a modify control and subscribe to it's geometry\r\n   */\r\n  private createModifyControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      layer: this.olOverlayLayer,\r\n      drawStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as ModifyControlOptions;\r\n    this.modifyControl = new ModifyControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Toggle the proper control (draw or modify)\r\n   */\r\n  private toggleControl() {\r\n    let activate;\r\n    if (!this.value && this.geometryType) {\r\n      activate = this.drawControl;\r\n    } else {\r\n      activate = this.modifyControl;\r\n    }\r\n\r\n    // If the control that should be activated\r\n    // is not the same as the current active control,\r\n    // deactivate the current control and activate the new one\r\n    // Otherwise, do nothing and keep the current control active\r\n    if (activate !== this.activeControl) {\r\n      this.deactivateControl();\r\n      this.activateControl(activate);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param control Control\r\n   */\r\n  private activateControl(control: DrawControl | ModifyControl) {\r\n    this.activeControl = control;\r\n    this.olGeometryEnds$$ = control.end$\r\n      .subscribe((olGeometry: OlGeometry) => this.onOlGeometryEnds(olGeometry));\r\n    if (this.measure === true && control === this.drawControl) {\r\n      this.olGeometryChanges$$ = control.changes$\r\n        .subscribe((olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) => this.onOlGeometryChanges(olGeometry));\r\n    }\r\n    control.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active control\r\n   */\r\n  private deactivateControl() {\r\n    this.removeMeasureTooltip();\r\n    if (this.activeControl !== undefined) {\r\n      this.activeControl.setOlMap(undefined);\r\n    }\r\n    if (this.olGeometryEnds$$ !== undefined) {\r\n      this.olGeometryEnds$$.unsubscribe();\r\n    }\r\n    if (this.olGeometryChanges$$ !== undefined) {\r\n      this.olGeometryChanges$$.unsubscribe();\r\n    }\r\n    this.activeControl = undefined;\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryEnds(olGeometry: OlGeometry | undefined) {\r\n    this.removeMeasureTooltip();\r\n    this.setOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryChanges(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    if (olGeometry.getType() !== 'Point') {\r\n      this.updateMeasureTooltip(olGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, convert the output value to GeoJSON and keep it.\r\n   * Restore the double click interaction.\r\n   * @param olGeometry OL geometry\r\n   */\r\n  private setOlGeometry(olGeometry: OlGeometry | undefined) {\r\n    let value;\r\n    if (olGeometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (olGeometry.getType() === 'Circle') { // Because Circle doesn't exist as a GeoJSON object\r\n      olGeometry = this.circleToPoint(olGeometry);\r\n    }\r\n\r\n    value = this.olGeoJSON.writeGeometryObject(olGeometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: 'EPSG:4326'\r\n    });\r\n    if (olGeometry.get('radius')) {\r\n      value.radius = olGeometry.get('radius');\r\n      olGeometry.set('radius', value.radius);\r\n    }\r\n    this.writeValue(value);\r\n  }\r\n\r\n  private circleToPoint(olGeometry) {\r\n    const center = olGeometry.getCenter();\r\n    const coordinates = olproj.transform(center, this.map.projection, 'EPSG:4326');\r\n    const radius = Math.round(olGeometry.getRadius() * (Math.cos((Math.PI / 180) * coordinates[1])));\r\n\r\n    // Convert it to a point object\r\n    olGeometry = new Point(center);\r\n    olGeometry.set('radius', radius, true);\r\n    return olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Add a GeoJSON geometry to the overlay\r\n   * @param geometry GeoJSON geometry\r\n   */\r\n  private addGeoJSONToOverlay(geometry: GeoJSONGeometry) {\r\n    const olGeometry = this.olGeoJSON.readGeometry(geometry, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: this.map.projection\r\n    });\r\n    const olFeature = new OlFeature({\r\n      geometry: olGeometry\r\n    });\r\n    olFeature.setStyle(this.overlayStyle as OlStyle.Style);\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create the measure tooltip\r\n   */\r\n  private createMeasureTooltip() {\r\n    return new OlOverlay({\r\n      element: document.createElement('div'),\r\n      offset: [-30, -10],\r\n      className: [\r\n        'igo-map-tooltip',\r\n        'igo-map-tooltip-measure'\r\n      ].join(' '),\r\n      stopEvent: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the measure tooltip of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   */\r\n  private updateMeasureTooltip(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    const measure = measureOlGeometry(olGeometry, this.map.projection);\r\n    const lengths = measure.lengths;\r\n    const lastIndex = olGeometry.getType() === 'Polygon' ? lengths.length - 2 : lengths.length - 1;\r\n    const lastLength = lengths[lastIndex];\r\n\r\n    const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n    const olLastMidpoint = olMidpoints[lastIndex];\r\n    if (olMidpoints.length === 0 || olLastMidpoint === undefined) {\r\n      this.removeMeasureTooltip();\r\n      return;\r\n    }\r\n\r\n    this.olTooltip.setPosition(olLastMidpoint.getFlatCoordinates());\r\n\r\n    const innerHtml = formatMeasure(lastLength, {\r\n      decimal: 1,\r\n      unit: MeasureLengthUnit.Meters,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    });\r\n    this.olTooltip.getElement().innerHTML = innerHtml;\r\n    if (this.olTooltip.getMap() === undefined) {\r\n      this.map.ol.addOverlay(this.olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the measure tooltip from the map\r\n   */\r\n  private removeMeasureTooltip() {\r\n    if (this.olTooltip.getMap && this.olTooltip.getMap() !== undefined) {\r\n      this.map.ol.removeOverlay(this.olTooltip);\r\n      this.olTooltip.setMap(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adjust the draw style with the specified draw guide distance, if possible\r\n   * @param olStyle Draw style to update\r\n   * @param resolution Resolution (to make the screen size of symbol fit the drawGuide value)\r\n   */\r\n  private updateDrawStyleWithDrawGuide(olStyle: OlStyleLike | OlStyle.RegularShape, resolution: number) {\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(olStyle);\r\n    if (olGuideStyle === undefined) {\r\n      return;\r\n    }\r\n    const drawGuide = this.drawGuide;\r\n    let radius;\r\n    if (!drawGuide || drawGuide < 0) {\r\n      radius = this.defaultDrawStyleRadius;\r\n    } else {\r\n      radius = drawGuide > 0 ? drawGuide / resolution : drawGuide;\r\n    }\r\n    olGuideStyle.setRadius(radius);\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private getGuideStyleFromDrawStyle(olStyle: OlStyleLike | OlStyle.RegularShape): HasRadius | undefined {\r\n    let baseStyle: unknown;\r\n    if (Array.isArray(olStyle)) {\r\n      baseStyle = olStyle[0];\r\n    } else {\r\n      baseStyle = olStyle;\r\n    }\r\n\r\n    if (typeof (baseStyle as any).getImage === 'function') {\r\n      baseStyle = (baseStyle as any).getImage() as OlStyle.Image;\r\n    }\r\n\r\n    let guideStyle: HasRadius;\r\n    if (typeof (baseStyle as any).setRadius === 'function') {\r\n      guideStyle = baseStyle as HasRadius;\r\n    }\r\n\r\n    return guideStyle;\r\n  }\r\n}\r\n","<ng-template></ng-template>","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { GeometryFormFieldComponent } from './geometry-form-field.component';\r\nimport { GeometryFormFieldInputComponent } from './geometry-form-field-input.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ],\r\n  declarations: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ]\r\n})\r\nexport class IgoGeometryFormFieldModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoGeometryFormFieldModule } from './geometry-form-field/geometry-form-field.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoGeometryModule {}\r\n","<button *ngIf=\"header && options.timeFilterable && options.timeFilter\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"history\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"header && options.timeFilterable && options.timeFilter\">\r\n  <igo-time-filter-item\r\n    *ngIf=\"timeFilterCollapse && options.timeFilter\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [layer]=\"layer\">\r\n  </igo-time-filter-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { TimeFilterableDataSourceOptions } from '../shared/time-filter.interface';\r\nimport { WMSDataSourceOptions } from '../../datasource/shared/datasources/wms-datasource.interface';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-button',\r\n  templateUrl: './time-filter-button.component.html',\r\n  styleUrls: ['./time-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterButtonComponent implements OnInit {\r\n\r\n  public options: TimeFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.timeFilter as any;\r\n    if (filter && filter.enabled) {\r\n      return 1;\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  public timeFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n  }\r\n}\r\n","<div *ngIf=\"style === 'calendar' && type !=='year'\">\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n    <mat-form-field>\r\n      <mat-datetimepicker-toggle class=\"time-filter-mat-datetimepicker-toggle\" [for]=\"datetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n      <mat-datetimepicker #datetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n      <input matInput autocomplete=\"false\"\r\n        placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\"\r\n        [matDatetimepicker]=\"datetimePicker\"\r\n        [(ngModel)]=\"date\"\r\n        [min]=\"min\"\r\n        [max]=\"max\"\r\n        readonly=\"readonly\"\r\n        (dateChange)=\"handleDateChange($event)\">\r\n    </mat-form-field>\r\n\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle class=\"time-filter-mat-datetimepicker-toggle\" [for]=\"minDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #minDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\"\r\n          [matDatetimepicker]=\"minDatetimePicker\"\r\n          [(ngModel)]=\"startDate\"\r\n          [min]=\"min\"\r\n          [max]=\"getRangeMaxDate()\"\r\n          readonly=\"readonly\"\r\n          (input)=\"startDate\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle class=\"time-filter-mat-datetimepicker-toggle\" [for]=\"maxDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #maxDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\"\r\n          [matDatetimepicker]=\"maxDatetimePicker\"\r\n          [(ngModel)]=\"endDate\"\r\n          [min]=\"getRangeMinDate()\"\r\n          [max]=\"max\"\r\n          readonly=\"readonly\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<div *ngIf=\"style === 'calendar' && type ==='year'\">\r\n\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\" [(ngModel)]=\"year\" (selectionChange)=\"handleYearChange($event)\">\r\n                  <mat-option [value]=\"year\" *ngFor=\"let year of listYears\">{{year}}</mat-option>\r\n            </mat-select>\r\n        </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\" [(ngModel)]=\"startYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"startYear\" *ngFor=\"let startYear of startListYears\">{{startYear}}</mat-option>\r\n            </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n    <mat-form-field>\r\n        <mat-select placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\" [(ngModel)]=\"endYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"endYear\" *ngFor=\"let endYear of endListYears\">{{endYear}}</mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n\r\n</div>\r\n\r\n\r\n  <br>\r\n  <div *ngIf=\"!isRange && style === 'slider' && type === 'year'\" class=\"igo-col igo-col-100 igo-col-100-m mat-typography\">\r\n    <span>{{startYear}}</span>\r\n    <mat-slider\r\n        id=\"time-slider\"\r\n        tickInterval=\"auto\"\r\n        step=\"{{step}}\"\r\n        [min]=\"startYear\"\r\n        [max]=\"endYear\"\r\n        [value]=\"handleSliderValue()\"\r\n        [color]=\"color\"\r\n        thumbLabel\r\n        (input)=\"handleSliderYearChange($event)\"\r\n        (change)=\"handleSliderYearChange($event)\"\r\n        [disabled]= \"!options.enabled || !layer.visible\">\r\n    </mat-slider>\r\n    <span>{{endYear}}</span>\r\n    <p *ngIf= \"options.enabled\" class=\"date-below\">{{year}}</p>\r\n    <div #actions class=\"igo-layer-actions-container\">\r\n      <mat-slide-toggle (change)=\"toggleFilterState()\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" [color]=\"color\" [checked]=\"options.enabled\"\r\n        [disabled]=\"!layer.visible\">\r\n      </mat-slide-toggle>\r\n      <button [disabled]= \"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"playYear($event)\">\r\n        <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n       </button>\r\n      <button [disabled]=\"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n<div *ngIf=\"style === 'slider' && type !== 'year'\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n  <mat-slider\r\n      id=\"time-slider\"\r\n      tickInterval=\"auto\"\r\n      step=\"{{step}}\"\r\n      [min]=\"dateToNumber(min)\"\r\n      [max]=\"dateToNumber(max)\"\r\n      [value]=\"handleSliderValue()\"\r\n      thumbLabel\r\n      (input)=\"handleSliderDateChange($event)\"\r\n      (selectionChange)=\"handleSliderDateChange($event)\">\r\n  </mat-slider>\r\n  <p class=\"date-below\">{{handleSliderTooltip()}}</p>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n   <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { DateAdapter } from '@angular/material/core';\r\nimport { MatSlider } from '@angular/material/slider';\r\nimport { default as moment } from 'moment';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterOptions } from '../shared/time-filter.interface';\r\nimport { TimeFilterType, TimeFilterStyle } from '../shared/time-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-form',\r\n  templateUrl: './time-filter-form.component.html',\r\n  styleUrls: ['./time-filter-form.component.scss']\r\n})\r\nexport class TimeFilterFormComponent implements OnInit {\r\n  @Input() layer: Layer;\r\n\r\n  @Input() options: TimeFilterOptions;\r\n\r\n  public color = 'primary';\r\n  public date: Date;\r\n  public startDate: Date;\r\n  public endDate: Date;\r\n  public year: any;\r\n  public startYear: any;\r\n  public endYear: any;\r\n  public initStartYear: any;\r\n  public initEndYear: any;\r\n  public listYears: Array<string> = [];\r\n  public startListYears: Array<string> = [];\r\n  public endListYears: Array<string> = [];\r\n\r\n  @Input()\r\n  set currentValue(value: string) {\r\n    if (value) {\r\n      if (this.type !== TimeFilterType.YEAR) {\r\n        const valueArray = value.split('/');\r\n        if (valueArray.length > 0) {\r\n          const startDate = new Date(valueArray[0]);\r\n          const endDate = new Date(valueArray[1]);\r\n          if (!isNaN(startDate.valueOf())) {\r\n            this.startDate = startDate;\r\n          }\r\n          if (!isNaN(endDate.valueOf())) {\r\n            this.endDate = endDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public interval: any;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  @Output() change: EventEmitter<Date | [Date, Date]> = new EventEmitter();\r\n  @Output()\r\n  yearChange: EventEmitter<string | [string, string]> = new EventEmitter();\r\n  @ViewChild(MatSlider) mySlider;\r\n\r\n  get type(): TimeFilterType {\r\n    return this.options.type === undefined\r\n      ? TimeFilterType.DATE\r\n      : this.options.type;\r\n  }\r\n\r\n  get isRange(): boolean {\r\n    return this.options.range === undefined ||\r\n      this.options.style === TimeFilterStyle.SLIDER\r\n      ? false\r\n      : this.options.range;\r\n  }\r\n\r\n  get style(): TimeFilterStyle {\r\n    return this.options.style === undefined\r\n      ? TimeFilterStyle.SLIDER\r\n      : this.options.style;\r\n  }\r\n\r\n  get step(): number {\r\n    let step = 10800000;\r\n    if (this.options.step === undefined) {\r\n      switch (this.type) {\r\n        case TimeFilterType.DATE:\r\n        case TimeFilterType.DATETIME:\r\n          step = 10800000;\r\n          break;\r\n        case TimeFilterType.TIME:\r\n          step = 3600000;\r\n          break;\r\n        case TimeFilterType.YEAR:\r\n          step = 31536000000;\r\n          break;\r\n        default:\r\n          step = 10800000;\r\n      }\r\n    } else {\r\n      step = this.getStepDefinition(this.options.step);\r\n    }\r\n\r\n    return step;\r\n  }\r\n\r\n  get timeInterval(): number {\r\n    return this.options.timeInterval === undefined\r\n      ? 2000\r\n      : this.options.timeInterval;\r\n  }\r\n\r\n  get min(): Date {\r\n    if (this.options.min) {\r\n      const min = new Date(this.options.min);\r\n      return new Date(min.getTime() + min.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get max(): Date {\r\n    if (this.options.max) {\r\n      const max = new Date(this.options.max);\r\n      return new Date(max.getTime() + max.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get is(): boolean {\r\n    return this.options.range === undefined ? false : this.options.range;\r\n  }\r\n\r\n  constructor(private dateAdapter: DateAdapter<Date>) {\r\n    this.dateAdapter.setLocale('fr');\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.startDate === undefined) {\r\n      this.startDate = new Date(this.min);\r\n    }\r\n    if (this.endDate === undefined) {\r\n      this.endDate = new Date(this.max);\r\n    }\r\n    if (this.startYear === undefined) {\r\n      this.startYear = new Date(this.startDate).getFullYear();\r\n      this.initStartYear = this.startYear;\r\n    }\r\n    if (this.endYear === undefined) {\r\n      this.endYear = new Date(this.endDate).getFullYear();\r\n      this.initEndYear = this.endYear;\r\n    }\r\n\r\n    if (!this.isRange) {\r\n      for (let i = this.startYear; i <= this.endYear + 1; i++) {\r\n        this.listYears.push(i);\r\n      }\r\n    } else {\r\n      for (let i = this.startYear; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      for (let i = this.startYear + 1; i <= this.endYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n    }\r\n    this.options.enabled =\r\n      this.options.enabled === undefined ? true : this.options.enabled;\r\n    this.checkFilterValue();\r\n    if (this.options.enabled) {\r\n      if (!this.isRange && this.style === 'slider' && this.type === 'year') {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.storeCurrentFilterValue();\r\n      this.yearChange.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  storeCurrentFilterValue() {\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.options.value = this.year.toString();\r\n    }\r\n  }\r\n\r\n  checkFilterValue() {\r\n    const olSource = this.layer.dataSource.ol as olSourceImageWMS;\r\n    const timeFromWms = olSource.getParams().TIME;\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.year = new Date(timeFromWms.toString()).getFullYear() + 1;\r\n      } else if (this.options.value) {\r\n        this.year = new Date(this.options.value.toString()).getFullYear() + 1;\r\n      } else {\r\n        this.year = new Date(this.min).getFullYear() + 1;\r\n      }\r\n    } else if (\r\n      this.isRange &&\r\n      this.style === TimeFilterStyle.CALENDAR &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.startYear = parseInt(timeFromWms.substr(0, 4), 10);\r\n        this.endYear = parseInt(timeFromWms.substr(5, 4), 10);\r\n        const newStartListYears: any[] = [];\r\n        const newEndListYears: any[] = [];\r\n        for (let i = this.initStartYear; i < this.endYear; i++) {\r\n          newStartListYears.push(i);\r\n        }\r\n        for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n          newEndListYears.push(i);\r\n        }\r\n        this.startListYears = newStartListYears;\r\n        this.endListYears = newEndListYears;\r\n      }\r\n    }\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n  }\r\n\r\n  handleDateChange(event: any) {\r\n    this.setupDateOutput();\r\n    this.applyTypeChange();\r\n\r\n    // Only if is range, use 2 dates to make the range\r\n    if (this.isRange) {\r\n      this.change.emit([this.startDate, this.endDate]);\r\n    } else {\r\n      this.change.emit(this.startDate);\r\n    }\r\n  }\r\n\r\n  handleYearChange(event: any) {\r\n    if (this.isRange) {\r\n      this.endListYears = [];\r\n      for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n      this.startListYears = [];\r\n      for (let i = this.initStartYear + 1; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      this.yearChange.emit([this.startYear, this.endYear]);\r\n    } else {\r\n      this.yearChange.emit(this.year);\r\n    }\r\n  }\r\n\r\n  handleListYearChange(event: any) {\r\n    this.handleYearChange([this.startYear, this.endYear]);\r\n  }\r\n\r\n  handleListYearStartChange(event: any) {\r\n    this.change.emit([this.startDate, this.endDate]);\r\n  }\r\n\r\n  dateToNumber(date: Date): number {\r\n    let newDate;\r\n    if (date) {\r\n      newDate = new Date(date);\r\n    } else {\r\n      newDate = new Date(this.min);\r\n    }\r\n\r\n    return newDate.getTime();\r\n  }\r\n\r\n  setSliderThumbLabel(label: string) {\r\n    const thumbLabel = this.findThumbLabel(\r\n      this.mySlider._elementRef.nativeElement.childNodes\r\n    );\r\n    if (thumbLabel) {\r\n      thumbLabel.textContent = label;\r\n    }\r\n  }\r\n\r\n  findThumbLabel(test: any[]): any {\r\n    let thumbLabel;\r\n\r\n    test.forEach(value => {\r\n      if (value.className === 'mat-slider-thumb-label-text') {\r\n        thumbLabel = value;\r\n      }\r\n\r\n      if (value.children.length > 0 && !thumbLabel) {\r\n        thumbLabel = this.findThumbLabel(value.childNodes);\r\n      }\r\n    }, this);\r\n    return thumbLabel;\r\n  }\r\n\r\n  toggleFilterState() {\r\n    this.options.enabled = !this.options.enabled;\r\n\r\n    if (this.options.enabled) {\r\n      if (\r\n        !this.isRange &&\r\n        TimeFilterStyle.SLIDER &&\r\n        this.type === TimeFilterType.YEAR\r\n      ) {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.stopFilter();\r\n      this.storeCurrentFilterValue();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    this.date = new Date(this.min);\r\n    this.year = this.date.getFullYear();\r\n    if (\r\n      !this.isRange &&\r\n      TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.yearChange.emit(this.year);\r\n    } else {\r\n      this.setupDateOutput();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n          let newMinDateNumber;\r\n          const maxDateNumber = new Date(that.max);\r\n\r\n          newMinDateNumber =\r\n            that.date === undefined ? that.min.getTime() : that.date.getTime();\r\n          newMinDateNumber += that.mySlider.step;\r\n          that.date = new Date(newMinDateNumber);\r\n\r\n          if (newMinDateNumber > maxDateNumber.getTime()) {\r\n            that.stopFilter();\r\n          }\r\n\r\n          that.handleDateChange({ value: that.date, date: that.date });\r\n        },\r\n        this.timeInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  playYear(event: any) {\r\n    if (\r\n      this.year + this.mySlider.step >\r\n      this.max.getFullYear() + this.mySlider.step\r\n    ) {\r\n      this.stopFilter();\r\n      this.resetFilter(event);\r\n    }\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(() => {\r\n        if (\r\n          (this.year + this.mySlider.step) > this.max.getFullYear()) {\r\n          this.stopFilter();\r\n        } else {\r\n          this.year = this.year + this.mySlider.step;\r\n        }\r\n        this.yearChange.emit(this.year);\r\n\r\n      }, this.timeInterval, this);\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  handleSliderDateChange(event: any) {\r\n    this.date = new Date(event.value);\r\n    this.setSliderThumbLabel(this.handleSliderTooltip());\r\n    this.handleDateChange(event);\r\n  }\r\n\r\n  handleSliderYearChange(event: any) {\r\n    this.year = event.value;\r\n    this.yearChange.emit(this.year);\r\n  }\r\n\r\n  handleSliderValue(): number {\r\n    if (this.options.current === true || !this.min) {\r\n      const currentDate = new Date();\r\n      this.date = this.getRoundedDate(currentDate);\r\n    }\r\n    if (this.type === TimeFilterType.YEAR) {\r\n      return this.year;\r\n    } else {\r\n      return this.date === undefined ? this.min.getTime() : this.date.getTime();\r\n    }\r\n  }\r\n\r\n  handleSliderTooltip() {\r\n    let label: string;\r\n\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toDateString()\r\n            : this.date.toDateString();\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toTimeString()\r\n            : this.date.toTimeString();\r\n        break;\r\n      // datetime\r\n      default:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toUTCString()\r\n            : this.date.toUTCString();\r\n        break;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  setupDateOutput() {\r\n    if (this.style === TimeFilterStyle.SLIDER) {\r\n      this.startDate = new Date(this.date);\r\n      this.startDate.setSeconds(-(this.step / 1000));\r\n      this.endDate = new Date(this.startDate);\r\n      this.endDate.setSeconds(this.step / 1000);\r\n    } else if (!this.isRange && !!this.date) {\r\n      this.endDate = new Date(this.date);\r\n      this.startDate = new Date(this.date);\r\n    } else if (this.isRange && (!!this.date || !this.date)) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    } else if (!this.date) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    }\r\n  }\r\n\r\n  applyTypeChange() {\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        if (this.startDate !== undefined || this.endDate !== undefined) {\r\n          this.startDate.setHours(0);\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setHours(23);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        if (this.style === TimeFilterStyle.CALENDAR) {\r\n          if (this.startDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.startDate.getHours();\r\n            const selectedMinute = this.startDate.getMinutes();\r\n            this.startDate = this.min;\r\n            this.startDate.setHours(selectedHour);\r\n            this.startDate.setMinutes(selectedMinute);\r\n          }\r\n\r\n          if (this.endDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.endDate.getHours();\r\n            const selectedMinute = this.endDate.getMinutes();\r\n            this.endDate = this.min;\r\n            this.endDate.setHours(selectedHour);\r\n            this.endDate.setMinutes(selectedMinute);\r\n          }\r\n        }\r\n\r\n        if (!this.isRange && this.step > 60 * 60 * 1000) {\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      // datetime\r\n      default:\r\n      // do nothing\r\n    }\r\n  }\r\n\r\n  getRangeMinDate(): Date {\r\n    return this.startDate === undefined ? this.min : this.startDate;\r\n  }\r\n\r\n  getRangeMaxDate(): Date {\r\n    return this.endDate === undefined ? this.max : this.endDate;\r\n  }\r\n\r\n  /**\r\n   * Round date at a certain time, 10 minutes by Default\r\n   * @param date - Date to Round\r\n   * @param atMinute - round to closest 'atMinute' minute, rounded 10 by default\r\n   * @return the rounded date\r\n   */\r\n  getRoundedDate(date, atMinute = 10) {\r\n    const coeff = 1000 * 60 * atMinute;\r\n    return new Date(Math.round(date.getTime() / coeff) * coeff);\r\n  }\r\n\r\n  /**\r\n   * Get the step (period) definition from the layer dimension tag\r\n   * @param step The step as ISO 8601 example: PT10M for 10 Minutes\r\n   * @return the duration in milliseconds\r\n   */\r\n  getStepDefinition(step) {\r\n    return moment.duration(step).asMilliseconds();\r\n  }\r\n}\r\n","<mat-list-item *ngIf=\"header\">\r\n  <mat-icon\r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"filters\"\r\n    [collapsed]=\"filtersCollapsed\"\r\n    (click)=\"toggleFiltersCollapsed()\"\r\n    svgIcon=\"chevron-up\" >\r\n  </mat-icon>\r\n  <h4 (click)=\"toggleLegendOnClick()\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\"  matLine>{{layer.title}}</h4>\r\n  \r\n  <button *ngIf=\"header\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"layer.visible ?\r\n                  ('igo.geo.layer.hideLayer' | translate) :\r\n                  ('igo.geo.layer.showLayer' | translate)\"\r\n    (click)=\"layer.visible = !layer.visible\">\r\n    <mat-icon\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #filters class=\"igo-datasource-filters-container\">\r\n  <div #legend class=\"igo-layer-legend-container\">\r\n    <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n    </igo-layer-legend>\r\n  </div>\r\n  <igo-time-filter-form\r\n    [layer]= \"layer\"\r\n    [options]=\"datasource.options.timeFilter\"\r\n    [currentValue]=\"datasource.options.params.TIME\"\r\n    (change)=\"handleDateChange($event)\"\r\n    (yearChange)=\"handleYearChange($event)\">\r\n  </igo-time-filter-form>\r\n</div>\r\n","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterableDataSource } from '../shared/time-filter.interface';\r\nimport { TimeFilterService } from '../shared/time-filter.service';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-item',\r\n  templateUrl: './time-filter-item.component.html',\r\n  styleUrls: ['./time-filter-item.component.scss']\r\n})\r\nexport class TimeFilterItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n\r\n  filtersCollapsed: boolean = false;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  get datasource(): TimeFilterableDataSource {\r\n    return this.layer.dataSource as TimeFilterableDataSource;\r\n  }\r\n  constructor(private timeFilterService: TimeFilterService) {}\r\n\r\n  ngOnInit(): void {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  handleYearChange(year: string | [string, string]) {\r\n    this.timeFilterService.filterByYear(this.datasource, year);\r\n  }\r\n\r\n  handleDateChange(date: Date | [Date, Date]) {\r\n    this.timeFilterService.filterByDate(this.datasource, date);\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'time'\">\r\n    <igo-time-filter-item [header]=\"true\" igoListItem [layer]=\"layer\"></igo-time-filter-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-list',\r\n  templateUrl: './time-filter-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterListComponent {\r\n  @Input()\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _layers: Layer[] = [];\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olWKT from 'ol/format/WKT';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WktService {\r\n  constructor() {}\r\n\r\n  public wktToFeature(wkt, wktProj, featureProj) {\r\n    return new olWKT().readFeature(wkt, {\r\n      dataProjection: wktProj,\r\n      featureProjection: featureProj\r\n    });\r\n  }\r\n  public extentToWkt(epsgTO, extent, extentProj) {\r\n    let currentExtent = olproj.transformExtent(extent, extentProj, epsgTO);\r\n    currentExtent = this.roundCoordinateArray(currentExtent, epsgTO, 0);\r\n    const wktPoly = `POLYGON((\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]}))`;\r\n    const wktLine = `LINESTRING(\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]})`;\r\n    const wktMultiPoints = `MULTIPOINT(\r\n        ${extent[0]} ${extent[1]},\r\n        ${extent[0]} ${extent[3]},\r\n        ${extent[2]} ${extent[3]},\r\n        ${extent[2]} ${extent[1]})`;\r\n    return {\r\n      wktPoly,\r\n      wktLine,\r\n      wktMultiPoints\r\n    };\r\n  }\r\n\r\n  private roundCoordinateArray(coordinateArray, projection, decimal = 0) {\r\n    const lproj = olproj.get(projection);\r\n    const units = lproj.getUnits();\r\n    const olUnits = ['ft', 'm', 'us-ft'];\r\n    if (olUnits.indexOf(units) !== -1) {\r\n      coordinateArray = this.roundArray(coordinateArray, decimal);\r\n    }\r\n    return coordinateArray;\r\n  }\r\n\r\n  private roundArray(array, decimal = 0) {\r\n    let x = 0;\r\n    while (x < array.length) {\r\n      array[x] = array[x].toFixed(decimal);\r\n      x++;\r\n    }\r\n    return array;\r\n  }\r\n\r\n  public snrcToWkt(snrc, epsgTO) {\r\n    snrc = snrc.toLowerCase();\r\n    let wktPoly;\r\n    const ew = {\r\n      1: { from: -56, to: -64 },\r\n      2: { from: -64, to: -72 },\r\n      3: { from: -72, to: -80 },\r\n      4: { from: -80, to: -88 },\r\n      5: { from: -88, to: -96 },\r\n      6: { from: -96, to: -104 },\r\n      7: { from: -104, to: -112 },\r\n      8: { from: -112, to: -120 },\r\n      9: { from: -120, to: -128 },\r\n      10: { from: -128, to: -136 }\r\n    };\r\n    const sn = {\r\n      1: { from: 44, to: 48 },\r\n      2: { from: 48, to: 52 },\r\n      3: { from: 52, to: 56 },\r\n      4: { from: 56, to: 60 },\r\n      5: { from: 60, to: 64 },\r\n      6: { from: 64, to: 68 },\r\n      7: { from: 68, to: 72 },\r\n      8: { from: 72, to: 76 },\r\n      9: { from: 76, to: -128 }\r\n    };\r\n    const snrc250kIndex = [\r\n      ['m', 'n', 'o', 'p'],\r\n      ['l', 'k', 'j', 'i'],\r\n      ['e', 'f', 'g', 'h'],\r\n      ['d', 'c', 'b', 'a']\r\n    ];\r\n\r\n    const snrc50kIndex = [\r\n      ['13', '14', '15', '16'],\r\n      ['12', '11', '10', '09'],\r\n      ['05', '06', '07', '08'],\r\n      ['04', '03', '02', '01']\r\n    ];\r\n    const checkSNRC50k = /\\d{2,3}[a-p][0,1][0-9]/gi;\r\n    const checkSNRC250k = /\\d{2,3}[a-p]/gi;\r\n    const checkSNRC1m = /\\d{2,3}/gi;\r\n\r\n    let snrc1m = false;\r\n    let snrc250k = false;\r\n    let snrc50k = false;\r\n\r\n    if (checkSNRC50k.test(snrc)) {\r\n      snrc50k = true;\r\n    } else {\r\n      if (checkSNRC250k.test(snrc)) {\r\n        snrc250k = true;\r\n      } else {\r\n        if (checkSNRC1m.test(snrc)) {\r\n          snrc1m = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (snrc1m) {\r\n      snrc += 'a01';\r\n    } else if (snrc250k) {\r\n      snrc += '01';\r\n    }\r\n    if (/\\d{2,3}[a-p][0,1][0-9]/gi.test(snrc)) {\r\n      const regex1m = /(?=[a-p])/gi;\r\n      const ar1m = snrc.split(regex1m);\r\n      const part1m = ar1m[0];\r\n      const part250k = ar1m[1][0];\r\n      const part50k = ar1m[1].split(part250k)[1];\r\n      let separator = 1;\r\n      if (part1m.length === 3) {\r\n        separator = 2;\r\n      }\r\n      const partEW = part1m.substring(0, separator);\r\n      const partSN = part1m.substring(separator);\r\n      const unit1mEW = 8;\r\n      const unit1mSN = 4;\r\n      const unit250kEW = 2;\r\n      const unit250kSN = 1;\r\n      const unit50kEW = 0.5;\r\n      const unit50kSN = 0.25;\r\n      let index250kEW = 0;\r\n      let index250kSN = 0;\r\n      let index50kEW = 0;\r\n      let index50kSN = 0;\r\n      snrc250kIndex.forEach(element => {\r\n        if (element.indexOf(part250k) !== -1) {\r\n          index250kSN = snrc250kIndex.indexOf(element);\r\n          index250kEW = element.indexOf(part250k);\r\n        }\r\n      });\r\n      snrc50kIndex.forEach(element => {\r\n        if (element.indexOf(part50k) !== -1) {\r\n          index50kSN = snrc50kIndex.indexOf(element);\r\n          index50kEW = element.indexOf(part50k);\r\n        }\r\n      });\r\n\r\n      let increment250kEW = 0;\r\n      let increment250kSN = 0;\r\n      let increment50kEW = 0;\r\n      let increment50kSN = 0;\r\n      let unitPerTypeEW = unit1mEW;\r\n      let unitPerTypeSN = unit1mSN;\r\n      if (snrc250k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = 0;\r\n        increment50kSN = 0;\r\n        unitPerTypeEW = unit250kEW;\r\n        unitPerTypeSN = unit250kSN;\r\n      } else if (snrc50k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = index50kEW * unit50kEW;\r\n        increment50kSN = index50kSN * unit50kSN;\r\n        unitPerTypeEW = unit50kEW;\r\n        unitPerTypeSN = unit50kSN;\r\n      }\r\n\r\n      const coord: {ul?: any, lr?: any, ur?: any, ll?: any} = {\r\n        ul: [\r\n          ew[partEW].to + increment250kEW + increment50kEW,\r\n          sn[partSN].to - increment250kSN - increment50kSN\r\n        ]\r\n      };\r\n\r\n      coord.lr = [\r\n        coord.ul[0] + unitPerTypeEW,\r\n        coord.ul[1] - unitPerTypeSN\r\n      ];\r\n      coord.ur = [coord.ul[0], coord.ul[1] - unitPerTypeSN];\r\n      coord.ll = [coord.ul[0] + unitPerTypeEW, coord.ul[1]];\r\n\r\n      coord.ul = olproj.transform(\r\n        [coord.ul[0], coord.ul[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.lr = olproj.transform(\r\n        [coord.lr[0], coord.lr[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ur = olproj.transform(\r\n        [coord.ur[0], coord.ur[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ll = olproj.transform(\r\n        [coord.ll[0], coord.ll[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n\r\n      // Rounded coordinate to shorten url in get\r\n      coord.ul = this.roundCoordinateArray(coord.ul, epsgTO, 0);\r\n      coord.lr = this.roundCoordinateArray(coord.lr, epsgTO, 0);\r\n      coord.ur = this.roundCoordinateArray(coord.ur, epsgTO, 0);\r\n      coord.ll = this.roundCoordinateArray(coord.ll, epsgTO, 0);\r\n\r\n      wktPoly =\r\n        'POLYGON((' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        '))';\r\n      const wktLine =\r\n        'LINESTRING(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n\r\n      const wktMultiPoints =\r\n        'MULTIPOINT(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n      return {\r\n        wktPoly,\r\n        wktLine,\r\n        wktMultiPoints\r\n      };\r\n    }\r\n  }\r\n}\r\n","<mat-checkbox\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\"\r\n  (click)=\"$event.stopPropagation()\"\r\n  (change)=\"toggleFilterState($event)\"\r\n  [checked]=\"currentFilter.active\">\r\n</mat-checkbox>\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'logical': activeFilters.indexOf(currentFilter) !== 0 && currentFilter.active===true, 'logicalHidden': activeFilters.indexOf(currentFilter) === 0 || currentFilter.active!==true}\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.parentLogical\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.parentLogical ? (('igo.geo.operators.tooltip.'+ currentFilter.parentLogical) | translate) : ''\"\r\n    (selectionChange)=\"changeLogical($event.value)\">\r\n      <mat-option\r\n        [value]=ogcFilterOperator.And\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.And' | translate\">\r\n          {{'igo.geo.operators.And' | translate}}\r\n      </mat-option>\r\n      <mat-option\r\n        [value]=ogcFilterOperator.Or\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.Or' | translate\">\r\n          {{'igo.geo.operators.Or' | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"field\"\r\n  *ngIf=\"(currentFilterIsSpatial$ | async)===false && (fields$ | async) && (fields$| async).length > 0 && (fields$| async)[0].name !== ''\"\r\n  (mouseenter)=\"inputClearable = 'selectField'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <input\r\n  matInput\r\n  [placeholder]=\"'igo.geo.sourceFields.selectField' | translate\"\r\n  [disabled]=\"!currentFilter.active\"\r\n  [matAutocomplete]=\"autoCompleteField\"\r\n  [value]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ''\"\r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ('igo.geo.sourceFields.selectField' | translate)\"\r\n  (input)=\"updateFieldsList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteField=\"matAutocomplete\"\r\n  (optionSelected)='changeField($event.option.id)'>\r\n    <mat-option\r\n      *ngFor=\"let field of filteredFields$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"field.alias\"\r\n      [id]=\"field.name\"\r\n      [matTooltip]=\"field.alias\">\r\n      {{field.alias}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"currentFilter.propertyName && inputClearable === 'selectField' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearSelectedField()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'operator': (currentFilterIsSpatial$ | async)===false , 'dualInput': (currentFilterIsSpatial$ | async)}\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <mat-select\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.operator ? (('igo.geo.operators.tooltip.'+ currentFilter.operator) | translate) : ('igo.geo.filter.selectOperator' | translate)\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.operator\"\r\n    (selectionChange)=\"changeOperator($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let operator of (ogcFilterOperators$ | async) | keyvalue\"\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"operator.key\"\r\n        [matTooltip]=\"('igo.geo.operators.tooltip.'+ operator.key) | translate\">\r\n          {{('igo.geo.operators.'+ operator.key) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"spatialSelector\"\r\n*ngIf=\"currentFilterIsSpatial$ | async\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.igoSpatialSelector\"\r\n    (selectionChange)=\"changeSpatialSelector($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let igoSpatialSelector of igoSpatialSelectors\"\r\n        [value]=\"igoSpatialSelector.type\">\r\n          {{('igo.geo.spatialSelector.'+ igoSpatialSelector.type) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"singleInput\"\r\n*ngIf=\"['expression','pattern'].indexOf(detectProperty()) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [matAutocomplete]=\"autoCompleteValues\"\r\n    [value]=\"detectProperty() === 'expression' ? currentFilter.expression : currentFilter.pattern\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"detectProperty() === 'expression' ? currentFilter.expression || '' : currentFilter.pattern || ''\"\r\n    (input)=\"updateValuesList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteValues=\"matAutocomplete\"\r\n    (optionSelected)=\"changeProperty($event.option.value)\">\r\n    <mat-option\r\n      *ngFor=\"let value of filteredValues$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"value\"\r\n      [matTooltip]=\"value\">\r\n      {{value}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"isClearable() && inputClearable === 'selectProperty' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearProperty()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n<div class=\"igo-layer-button-group\">\r\n  <button\r\n    mat-icon-button\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.filter.removeFilter' | translate\"\r\n    color=\"warn\"\r\n    (click)=\"deleteFilter()\">\r\n    <mat-icon svgIcon=\"delete\"></mat-icon>\r\n  </button>\r\n</div>\r\n\r\n<mat-form-field\r\nclass=\"snrc\"\r\n*ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'snrc'\"\r\n(mouseenter)=\"inputClearable = 'selectSNRC'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholderSnrc' | translate\"\r\n    [value]=\"currentFilter.igoSNRC\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.igoSNRC ? currentFilter.igoSNRC : ''\"\r\n    (input)=\"changeSNRC($event.target.value)\">\r\n  <button\r\n    mat-button\r\n    *ngIf=\"currentFilter.igoSNRC\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active && inputClearable === 'selectSNRC' && currentFilter.active\"\r\n    (click)=\"currentFilter.igoSNRC=''\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n  </mat-form-field>\r\n\r\n  <ng-container *ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'fixedExtent'\">\r\n    <button\r\n    mat-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    *ngIf=\"currentFilter.igoSpatialSelector === 'fixedExtent'\"\r\n    matSuffix\r\n    mat-icon-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"changeMapExtentGeometry()\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialSelector.btnSetExtent' | translate\">\r\n      <mat-icon svgIcon=\"arrow-expand-all\"></mat-icon>\r\n  </button>\r\n</ng-container>\r\n\r\n<br/>\r\n\r\n<mat-form-field\r\nclass=\"dualInput\"\r\n*ngIf=\"!isTemporalOperator() && ['lowerBoundary','begin'].indexOf(detectProperty(1)) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty1'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator1\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(1) === 'lowerBoundary' ? currentFilter.lowerBoundary : currentFilter.begin\"\r\n      (input)=\"updateValuesList($event.target.value,1)\">\r\n    <mat-autocomplete #autoDualValueOperator1=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,1)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(1) && inputClearable === 'selectProperty1' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(1)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"dualInput\"\r\n  *ngIf=\"!isTemporalOperator() && ['upperBoundary','end'].indexOf(detectProperty(2)) !== -1\"\r\n  (mouseenter)=\"inputClearable = 'selectProperty2'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator2\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(2) === 'upperBoundary' ? currentFilter.upperBoundary : currentFilter.end\"\r\n      (input)=\"updateValuesList($event.target.value,2)\">\r\n    <mat-autocomplete #autoDualValueOperator2=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,2)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(2) && inputClearable === 'selectProperty2' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(2)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<igo-ogc-filter-time *ngIf=\"isTemporalOperator()\"\r\n  [(datasource)]=\"datasource\"\r\n  [(currentFilter)]=\"currentFilter\"\r\n  (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n</igo-ogc-filter-time>\r\n\r\n<!--\r\nTODO C'EST PERTINENT je crois\r\n<mat-form-field class=\"field\" *ngIf=\"!(currentFilterIsSpatial$ | async) && (fields$| async) && (fields$| async).length === 1 &&  (fields$| async)[0].name === ''\">\r\n<input [disabled]=\"!currentFilter.active\" matInput #fieldPerUser (keyup)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\"\r\n  (blur)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\" [(ngModel)]=\"currentFilter.propertyName\">\r\n<button mat-button *ngIf=\"currentFilter.propertyName\" matSuffix mat-icon-button aria-label=\"Clear\" (click)=\"currentFilter.propertyName=''\">\r\n  <mat-icon svgIcon=\"close\"></mat-icon>\r\n</button>\r\n</mat-form-field>\r\n\r\n\r\n\r\n<mat-checkbox labelPosition='before' (change)=\"changeCaseSensitive($event)\" [(ngModel)]=\"currentFilter.matchCase\">\r\n  {{('igo.geo.operators.caseSensitive') | translate}}\r\n</mat-checkbox>\r\n\r\n</mat-list-item> -->\r\n","import { Component, Input, OnInit } from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { WktService } from '../../wkt/shared/wkt.service';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-form',\r\n  templateUrl: './ogc-filter-form.component.html',\r\n  styleUrls: ['./ogc-filter-form.component.scss']\r\n})\r\nexport class OgcFilterFormComponent implements OnInit {\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  filteredValues$: Observable<string[]>;\r\n  filteredFields$: Observable<SourceFieldsOptionsParams[]>;\r\n  public allOgcFilterOperators;\r\n  public ogcFilterOperators$ = new BehaviorSubject<{ [key: string]: any }>(\r\n    undefined\r\n  );\r\n  public igoSpatialSelectors;\r\n  public value = '';\r\n  public inputOperator;\r\n  public selectedField$ = new BehaviorSubject<SourceFieldsOptionsParams>(\r\n    undefined\r\n  );\r\n  public fields$ = new BehaviorSubject<SourceFieldsOptionsParams[]>([]);\r\n  public color = 'primary';\r\n  public disabled;\r\n  public currentFilterIsSpatial$ = new BehaviorSubject<boolean>(false);\r\n  public defaultStepMillisecond = 6000;\r\n  public inputClearable: string;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() currentFilter: any;\r\n\r\n  set snrc(value: any) {\r\n    const checkSNRC50k = /^\\d{2}[a-l][0,1][0-9]$/gi;\r\n    const checkSNRC250k = /^\\d{2}[a-p]$/gi;\r\n    const checkSNRC1m = /^\\d{2}$/gi;\r\n    if (\r\n      checkSNRC1m.test(value) ||\r\n      checkSNRC250k.test(value) ||\r\n      checkSNRC50k.test(value)\r\n    ) {\r\n      this._snrc = value;\r\n      this.currentFilter.igoSNRC = value;\r\n    }\r\n  }\r\n\r\n  get snrc(): any {\r\n    return this._snrc;\r\n  }\r\n\r\n  private _snrc = '';\r\n\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  get activeFilters() {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.active === true\r\n    );\r\n  }\r\n\r\n  get allowedOperators() {\r\n    return new OgcFilterWriter().computeAllowedOperators(\r\n      this.fields$.value,\r\n      this.currentFilter.propertyName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType\r\n    );\r\n  }\r\n\r\n  constructor(private wktService: WktService) {\r\n    // TODO: Filter permitted operator based on wfscapabilities\r\n    // Need to work on regex on XML capabilities because\r\n    // comaparison operator's name varies between WFS servers...\r\n    // Ex: IsNull vs PropertyIsNull vs IsNil ...\r\n    this.allOgcFilterOperators = new OgcFilterWriter().operators;\r\n    this.ogcFilterOperators$.next(this.allOgcFilterOperators);\r\n    this.igoSpatialSelectors = [\r\n      {\r\n        type: 'fixedExtent'\r\n      },\r\n      {\r\n        type: 'snrc'\r\n      }\r\n    ];\r\n    // TODO: selectFeature & drawFeature\r\n  }\r\n\r\n  ngOnInit() {\r\n\r\n    if ( this.datasource.options.sourceFields) {\r\n      const sFields = this.datasource.options.sourceFields.filter(\r\n        (sf) =>\r\n          sf.excludeFromOgcFilters === undefined || !sf.excludeFromOgcFilters\r\n      );\r\n      sFields.map((sfs) => {\r\n        if (sfs.values) {\r\n          sfs.values.sort();\r\n        }\r\n      });\r\n      this.fields$.next(sFields);\r\n    }\r\n\r\n    this.updateFieldsList();\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.updateValuesList();\r\n    this.selectedField$.subscribe((f) => {\r\n      this.ogcFilterOperators$.next(this.allowedOperators);\r\n      if (\r\n        Object.keys(this.allowedOperators).indexOf(\r\n          this.currentFilter.operator\r\n        ) === -1\r\n      ) {\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n      }\r\n      this.updateValuesList();\r\n    });\r\n    this.currentFilterIsSpatial();\r\n  }\r\n\r\n  updateFieldsList(value?: string) {\r\n    this.filteredFields$ =\r\n      value && value.length > 0 ? of(this._filterFields(value)) : this.fields$;\r\n    if (this.fields$.value.find((f) => f.name === value)) {\r\n      this.changeField(value);\r\n    }\r\n  }\r\n\r\n  updateValuesList(value?: string, pos?: number) {\r\n    this.filteredValues$ =\r\n      value && value.length > 0\r\n        ? of(this._filterValues(value))\r\n        : this.selectedField$.value\r\n        ? of(this.selectedField$.value.values)\r\n        : of([]);\r\n    if (value && value.length >= 1) {\r\n      this.changeProperty(value, pos);\r\n    }\r\n  }\r\n\r\n  private _filterFields(value: string): SourceFieldsOptionsParams[] {\r\n    const keywordRegex = new RegExp(\r\n      value.normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.fields$.value.filter((val) =>\r\n      keywordRegex.test(\r\n        val.alias.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  private _filterValues(value: string): string[] {\r\n    const keywordRegex = new RegExp(\r\n      value\r\n        .toString()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.selectedField$.value.values.filter((val) =>\r\n      val && keywordRegex.test(\r\n        val\r\n          .toString()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  clearSelectedField() {\r\n    this.currentFilter.propertyName = '';\r\n    this.selectedField$.next(undefined);\r\n    this.clearProperty();\r\n  }\r\n\r\n  isClearable(pos?: number) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return this.currentFilter[detectedProperty];\r\n    }\r\n  }\r\n  clearProperty(pos?: number) {\r\n    // this.autoCompleteInputValues.closePanel();\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return (this.currentFilter[detectedProperty] = '');\r\n    }\r\n  }\r\n\r\n  toggleFilterState(event) {\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    ).active = event.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  deleteFilter() {\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    ogcFilters.interfaceOgcFilters = ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.filterid !== this.currentFilter.filterid\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeLogical(logical: string) {\r\n    this.currentFilter.parentLogical = logical;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeOperator(operator: string) {\r\n    this.currentFilter.operator = operator;\r\n    this.currentFilterIsSpatial();\r\n\r\n    if (\r\n      this.currentFilterIsSpatial$.value &&\r\n      this.currentFilter.wkt_geometry.length === 0\r\n    ) {\r\n      this.changeSpatialSelector(this.currentFilter.igoSpatialSelector);\r\n    } else {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  changeField(field: string) {\r\n    this.currentFilter.propertyName = field;\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  // Issue with mapserver 7.2 and Postgis layers. Fixed in 7.4\r\n  // Due to this issue, the checkbox is hide.\r\n  changeCaseSensitive(matchCase) {\r\n    this.currentFilter.matchCase = matchCase.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        (f) => f.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.refreshFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  changeNumericProperty(value, pos: number) {\r\n    this.changeProperty(parseFloat(value), pos);\r\n  }\r\n\r\n  changeSpatialSelector(value: any) {\r\n    this.currentFilter.igoSpatialSelector = value;\r\n\r\n    if (value === 'fixedExtent') {\r\n      this.changeMapExtentGeometry(false);\r\n    }\r\n    this.currentFilterIsSpatial();\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeSNRC(value: any) {\r\n    this.snrc = value;\r\n    this.changeSNRCGeometry();\r\n  }\r\n\r\n  changeSNRCGeometry() {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.snrc && this.currentFilter.igoSpatialSelector === 'snrc') {\r\n      this.currentFilter.wkt_geometry = this.wktService.snrcToWkt(\r\n        this.snrc,\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeMapExtentGeometry(refresh: boolean = true) {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.currentFilter.igoSpatialSelector === 'fixedExtent') {\r\n      this.currentFilter.wkt_geometry = this.wktService.extentToWkt(\r\n        this.map.projection,\r\n        this.map.viewController.getExtent(),\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    if (refresh) {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  private currentFilterIsSpatial() {\r\n    let isSpatial = false;\r\n    if (this.currentFilter) {\r\n      isSpatial =\r\n        [\r\n          OgcFilterOperator.Contains,\r\n          OgcFilterOperator.Intersects,\r\n          OgcFilterOperator.Within\r\n        ].indexOf(this.currentFilter.operator) !== -1;\r\n    }\r\n    this.currentFilterIsSpatial$.next(isSpatial);\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter.operator.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n}\r\n","<igo-ogc-filter-selection\r\n  *ngIf=\"!advancedOgcFilters\"\r\n  igoListItem\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\"\r\n  [currentFilter]=\"currentFilter\">\r\n</igo-ogc-filter-selection>\r\n\r\n<ng-template \r\n*ngIf=\"advancedOgcFilters && datasource.options.ogcFilters.editable\"\r\nngFor let-currentFilter \r\n[ngForOf]=\"datasource.options.ogcFilters.interfaceOgcFilters\">\r\n<igo-ogc-filter-form\r\n  [currentFilter]=\"currentFilter\"\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\">\r\n</igo-ogc-filter-form>\r\n</ng-template>","import { Component, Input } from '@angular/core';\r\nimport { OgcFilterableDataSource } from '../shared/ogc-filter.interface';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-form',\r\n  templateUrl: './ogc-filterable-form.component.html'\r\n})\r\nexport class OgcFilterableFormComponent {\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters;\r\n  }\r\n\r\n  get advancedOgcFilters(): boolean {\r\n    if (this.datasource.options.ogcFilters) {\r\n      return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n    }\r\n    return;\r\n  }\r\n\r\n  get currentFilter(): any {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters ?\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters[0] : undefined;\r\n  }\r\n\r\n  public color = 'primary';\r\n\r\n  constructor() {}\r\n}\r\n","<div [ngClass]=\"{'separate-item' : header === true}\" >\r\n  <mat-list-item>\r\n    <mat-icon\r\n      *ngIf=\"header\"\r\n      class=\"igo-chevron\"\r\n      mat-list-avatar\r\n      igoCollapse [target]=\"ogcFilters\"\r\n      [collapsed]=\"filtersCollapsed\"\r\n      (click)=\"toggleFiltersCollapsed()\"\r\n      svgIcon=\"chevron-up\">\r\n    </mat-icon>\r\n    <h4 (click)=\"toggleLegendOnClick()\" *ngIf=\"header\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\" matLine [matTooltip]=\"layer.title\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n      <button *ngIf=\"isAdvancedOgcFilters() && filtersAreEditable\" [disabled]=\"addFilterDisabled()\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.addFilter' | translate\" [color]=\"color\" (click)=\"addFilterToSequence()\">\r\n        <mat-icon svgIcon=\"plus\"></mat-icon>\r\n      </button>\r\n      <button *ngIf=\"header\"\r\n        mat-icon-button\r\n        [color]=\"layer.visible ? 'primary' : 'default'\"\r\n        collapsibleButton\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"layer.visible ?\r\n                      ('igo.geo.layer.hideLayer' | translate) :\r\n                      ('igo.geo.layer.showLayer' | translate)\"\r\n        (click)=\"layer.visible = !layer.visible\">\r\n        <mat-icon\r\n          [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n          [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n        </mat-icon>\r\n      </button>\r\n  </mat-list-item>\r\n\r\n  <div #ogcFilters>\r\n      <div *ngIf=\"header\" #legend class=\"igo-layer-legend-container\">\r\n        <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n        </igo-layer-legend>\r\n      </div>\r\n    <igo-ogc-filterable-form [datasource]=\"datasource\" [map]=\"map\" [refreshFilters]=\"refreshFunc\">\r\n    </igo-ogc-filterable-form>\r\n\r\n    <section *ngIf=\"hasSelector && filtersAreEditable\" class=\"mat-typography advancedOgcFilters\">\r\n      <mat-divider></mat-divider>\r\n      <mat-checkbox labelPosition='before' (change)=\"changeOgcFilterType($event)\"\r\n        [(ngModel)]=\"datasource.options.ogcFilters.advancedOgcFilters\">\r\n        {{'igo.geo.filter.advancedOgcFilters' | translate}}\r\n      </mat-checkbox>\r\n    </section>\r\n  </div>\r\n</div>","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { WFSDataSourceOptionsParams } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions,\r\n  OgcInterfaceFilterOptions\r\n} from '../shared/ogc-filter.interface';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterWriter } from '../shared/ogc-filter';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-item',\r\n  templateUrl: './ogc-filterable-item.component.html',\r\n  styleUrls: ['./ogc-filterable-item.component.scss']\r\n})\r\nexport class OgcFilterableItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  private lastRunOgcFilter;\r\n  private defaultLogicalParent = OgcFilterOperator.And;\r\n  public hasActiveSpatialFilter = false;\r\n  public filtersAreEditable = true;\r\n  public filtersCollapsed = true;\r\n  public hasSelector: boolean = false;\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n  private ogcFilterWriter;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters.bind(this);\r\n  }\r\n\r\n  get datasource(): OgcFilterableDataSource {\r\n    return this.layer.dataSource as OgcFilterableDataSource;\r\n  }\r\n\r\n  constructor(private ogcFilterService: OGCFilterService) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.layer.visible) {\r\n      this.filtersCollapsed = false;\r\n    }\r\n\r\n    const ogcFilters = this.datasource.options.ogcFilters;\r\n    if (\r\n      (ogcFilters.pushButtons && ogcFilters.pushButtons.bundles.length > 0) ||\r\n      (ogcFilters.checkboxes && ogcFilters.checkboxes.bundles.length > 0) ||\r\n      (ogcFilters.radioButtons && ogcFilters.radioButtons.bundles.length > 0) ||\r\n      (ogcFilters.select && ogcFilters.select.bundles.length > 0) ||\r\n      (ogcFilters.autocomplete && ogcFilters.autocomplete.bundles.length > 0)) {\r\n      if (ogcFilters.advancedOgcFilters === undefined) {\r\n        ogcFilters.advancedOgcFilters = false;\r\n      }\r\n      this.hasSelector = true;\r\n    }\r\n\r\n    switch (this.datasource.options.type) {\r\n      case 'wms':\r\n        this.ogcFilterService.setOgcWMSFiltersOptions(this.datasource);\r\n        break;\r\n      case 'wfs':\r\n        this.ogcFilterService.setOgcWFSFiltersOptions(this.datasource);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    if (ogcFilters) {\r\n      if (ogcFilters.interfaceOgcFilters) {\r\n        this.lastRunOgcFilter = JSON.parse(\r\n          JSON.stringify(ogcFilters.interfaceOgcFilters)\r\n        );\r\n        if (\r\n          ogcFilters.interfaceOgcFilters.filter(f => f.wkt_geometry).length >= 1\r\n        ) {\r\n          this.hasActiveSpatialFilter = true;\r\n        }\r\n      }\r\n\r\n      this.filtersAreEditable = ogcFilters.editable\r\n        ? ogcFilters.editable\r\n        : false;\r\n    }\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  addFilterToSequence() {\r\n    this.filtersCollapsed = false;\r\n    const interfaceOgcFilters: OgcInterfaceFilterOptions[] = this.datasource\r\n      .options.ogcFilters.interfaceOgcFilters;\r\n    const arr = interfaceOgcFilters || [];\r\n    const lastLevel = arr.length === 0 ? 0 : arr[arr.length - 1].level;\r\n    let firstFieldName = '';\r\n    const includedFields = this.datasource.options.sourceFields.filter(f => !f.excludeFromOgcFilters);\r\n    if (includedFields.length > 0) {\r\n      firstFieldName =\r\n        includedFields[0].name === undefined ? '' : includedFields[0].name;\r\n    }\r\n    let fieldNameGeometry;\r\n    const datasourceOptions = this.datasource\r\n      .options as WFSDataSourceOptionsParams;\r\n    if (datasourceOptions.fieldNameGeometry) {\r\n      fieldNameGeometry = datasourceOptions.fieldNameGeometry;\r\n    } else if (\r\n      (this.datasource.options as any).paramsWFS &&\r\n      (this.datasource.options as any).paramsWFS.fieldNameGeometry\r\n    ) {\r\n      fieldNameGeometry = (this.datasource.options as any).paramsWFS\r\n        .fieldNameGeometry;\r\n    }\r\n    const allowedOperators = this.ogcFilterWriter.computeAllowedOperators(\r\n      this.datasource.options.sourceFields,\r\n      firstFieldName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType);\r\n    const firstOperatorName = Object.keys(allowedOperators)[0];\r\n\r\n    arr.push(\r\n      this.ogcFilterWriter.addInterfaceFilter(\r\n        {\r\n          propertyName: firstFieldName,\r\n          operator: firstOperatorName,\r\n          active: true,\r\n          igoSpatialSelector: 'fixedExtent',\r\n          srsName: this.map.projection,\r\n        } as OgcInterfaceFilterOptions,\r\n        fieldNameGeometry,\r\n        lastLevel,\r\n        this.defaultLogicalParent\r\n      )\r\n    );\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters = arr;\r\n  }\r\n\r\n  refreshFilters(force?: boolean) {\r\n    if (force === true) {\r\n      this.lastRunOgcFilter = undefined;\r\n    }\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    const activeFilters = ogcFilters.interfaceOgcFilters ?\r\n      ogcFilters.interfaceOgcFilters.filter(f => f.active === true) : [];\r\n    if (activeFilters.length === 0) {\r\n      ogcFilters.filters = undefined;\r\n      ogcFilters.filtered = false;\r\n    }\r\n    if (activeFilters.length > 1) {\r\n      activeFilters[0].parentLogical = activeFilters[1].parentLogical;\r\n    }\r\n    if (\r\n      activeFilters.filter(\r\n        af => ['Contains', 'Intersects', 'Within'].indexOf(af.operator) !== -1\r\n      ).length === 0\r\n    ) {\r\n      this.hasActiveSpatialFilter = false;\r\n    } else {\r\n      this.hasActiveSpatialFilter = true;\r\n    }\r\n\r\n    if (\r\n      !(JSON.stringify(this.lastRunOgcFilter) === JSON.stringify(activeFilters))\r\n    ) {\r\n      if (this.layer.dataSource.options.type === 'wfs') {\r\n        const ogcDataSource: any = this.layer.dataSource;\r\n        const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n        ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n          activeFilters\r\n        );\r\n        this.layer.dataSource.ol.refresh();\r\n      } else if (\r\n        this.layer.dataSource.options.type === 'wms' &&\r\n        ogcFilters.enabled\r\n      ) {\r\n        let rebuildFilter = '';\r\n        if (activeFilters.length >= 1) {\r\n          const ogcDataSource: any = this.layer.dataSource;\r\n          const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n          ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n            activeFilters\r\n          );\r\n          rebuildFilter = this.ogcFilterWriter.buildFilter(\r\n            ogcLayer.filters,\r\n            undefined,\r\n            undefined,\r\n            (this.layer.dataSource.options as any).fieldNameGeometry,\r\n            ogcDataSource.options\r\n          );\r\n        }\r\n        this.ogcFilterService.filterByOgc(\r\n          this.datasource as WMSDataSource,\r\n          rebuildFilter\r\n        );\r\n        this.datasource.options.ogcFilters.filtered =\r\n          activeFilters.length === 0 ? false : true;\r\n      }\r\n\r\n      this.lastRunOgcFilter = JSON.parse(JSON.stringify(activeFilters));\r\n    } else {\r\n      // identical filter. Nothing triggered\r\n    }\r\n    (this.layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  public isAdvancedOgcFilters(): boolean {\r\n    return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n  }\r\n\r\n  public addFilterDisabled(): boolean {\r\n    return (\r\n      !this.datasource.options.sourceFields ||\r\n      this.datasource.options.sourceFields.length === 0\r\n    );\r\n  }\r\n\r\n  private changeOgcFiltersAdvancedOgcFilters(value: boolean) {\r\n    this.datasource.options.ogcFilters.advancedOgcFilters = value;\r\n  }\r\n\r\n  changeOgcFilterType(isAdvancedOgcFilters) {\r\n    this.changeOgcFiltersAdvancedOgcFilters(isAdvancedOgcFilters.checked);\r\n    if (isAdvancedOgcFilters.checked) {\r\n      this.refreshFilters(true);\r\n    }\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","\r\n<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <div  id=\"no-layer-message\" *ngIf=\"(layers | filterableDataSource : 'ogc').length === 0\">{{'igo.geo.filter.noFilterableLayer' | translate}}</div>\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'ogc'\">\r\n    <igo-ogc-filterable-item igoListItem [header]=\"true\" [layer]=\"layer\" \r\n    [map]=\"layer.map\" ></igo-ogc-filterable-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-list',\r\n  templateUrl: './ogc-filterable-list.component.html',\r\n  styleUrls: ['./ogc-filterable-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterableListComponent {\r\n\r\n  @Input() layers: Layer[];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  constructor() {}\r\n}\r\n","<button\r\n  *ngIf=\"header && options.ogcFilters && options.ogcFilters.enabled &&\r\n  (options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.autocomplete\r\n    || options.ogcFilters.editable)\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"filter\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"options.ogcFilters && options.ogcFilters.enabled &&\r\n(options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.autocomplete\r\n  || options.ogcFilters.editable)\">\r\n  <igo-ogc-filterable-item\r\n    *ngIf=\"ogcFilterCollapse && options.ogcFilters.enabled\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [map]=\"layer.map\"\r\n    [layer]=\"layer\">\r\n  </igo-ogc-filterable-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterableDataSourceOptions, IgoOgcSelector } from '../shared/ogc-filter.interface';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-button',\r\n  templateUrl: './ogc-filter-button.component.html',\r\n  styleUrls: ['./ogc-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterButtonComponent implements OnInit {\r\n\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.ogcFilters as any;\r\n    let cnt = 0;\r\n    if (filter && !filter.advancedOgcFilters) {\r\n      if (filter.pushButtons) {\r\n        const pushButtons = filter.pushButtons as IgoOgcSelector;\r\n        const currentPushButtonGroup = pushButtons.groups.find(gr => gr.enabled);\r\n        let cntPushButtons = 0;\r\n        if (currentPushButtonGroup) {\r\n          currentPushButtonGroup.computedSelectors?.map(cb => cntPushButtons += (cb.selectors as any)?.filter(\r\n            button => button.enabled).length);\r\n        }\r\n        cnt += cntPushButtons;\r\n      }\r\n      if (filter.checkboxes) {\r\n        const checkboxes = filter.checkboxes as IgoOgcSelector;\r\n        const currentCheckboxGroup = checkboxes.groups.find(gr => gr.enabled);\r\n        let cntCheckboxes = 0;\r\n        if (currentCheckboxGroup) {\r\n          currentCheckboxGroup.computedSelectors?.map(cb => cntCheckboxes += (cb.selectors as any)?.filter(\r\n            checkbox => checkbox.enabled).length);\r\n        }\r\n        cnt += cntCheckboxes;\r\n      }\r\n      if (filter.radioButtons) {\r\n        const radioButtons = filter.radioButtons as IgoOgcSelector;\r\n        const currentRadioButtonsGroup = radioButtons.groups.find(gr => gr.enabled);\r\n        let cntRadioButtons = 0;\r\n        if (currentRadioButtonsGroup) {\r\n          currentRadioButtonsGroup.computedSelectors?.map(cb => cntRadioButtons += (cb.selectors as any)?.filter(\r\n            radio => radio.enabled).length);\r\n        }\r\n        cnt += cntRadioButtons;\r\n      }\r\n      if (filter.select) {\r\n        const select = filter.select as IgoOgcSelector;\r\n        const currentSelectGroup = select.groups.find(gr => gr.enabled);\r\n        let cntSelect = 0;\r\n        if (currentSelectGroup) {\r\n          currentSelectGroup.computedSelectors?.map(cb => cntSelect += (cb.selectors as any)?.filter(\r\n            multi => multi.enabled).length);\r\n        }\r\n        cnt += cntSelect;\r\n      }\r\n      if (filter.autocomplete) {\r\n        const autocomplete = filter.autocomplete as IgoOgcSelector;\r\n        const currentAutocompleteGroup = autocomplete.groups.find(gr => gr.enabled);\r\n        let cntAutocomplete = 0;\r\n        if (currentAutocompleteGroup) {\r\n          currentAutocompleteGroup.computedSelectors?.map(cb => cntAutocomplete += (cb.selectors as any)?.filter(\r\n            autocomplete => autocomplete.enabled).length);\r\n        }\r\n        cnt += cntAutocomplete;\r\n      }\r\n    } else if (filter && filter.filters && !filter.filters.filters) {\r\n      return 1;\r\n    } else if (filter && filter.filters && filter.filters.filters) {\r\n      return filter.filters.filters.length;\r\n    }\r\n    if (filter.filters && filter.filters.operator === 'During' && filter.filters.active &&\r\n      filter.interfaceOgcFilters && filter.interfaceOgcFilters[0].active) {\r\n      const filterActiveValue = filter.interfaceOgcFilters[0];\r\n      if (filter.filters.calendarModeYear) {\r\n        // year mode check just year\r\n        if ((filterActiveValue.begin.substring(0,4) !== this.options.minDate.substring(0,4) ) ||\r\n        (filterActiveValue.end.substring(0,4) !== this.options.maxDate.substring(0,4) )) {\r\n          cnt += 1;\r\n        }\r\n      } else if ((filterActiveValue.begin !== this.options.minDate) || (filterActiveValue.end !== this.options.maxDate)) {\r\n        cnt += 1;\r\n      }\r\n    }\r\n    return cnt > 0 ? cnt : undefined;\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean;\r\n\r\n  public ogcFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { default as moment } from 'moment';\r\n\r\nimport {\r\n    OgcFilterableDataSource\r\n  } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterTimeService {\r\n\r\n    readonly defaultStepMillisecond = 60000;\r\n\r\n    constructor() {}\r\n\r\n    step(datasource: OgcFilterableDataSource, currentFilter): string {\r\n    return datasource.options.stepDate\r\n      ? datasource.options.stepDate\r\n      : currentFilter.step;\r\n    }\r\n\r\n    stepMillisecond(dataSource: OgcFilterableDataSource, currentFilter): number {\r\n        const step = moment.duration(this.step(dataSource, currentFilter)).asMilliseconds();\r\n        return step === 0 ? this.defaultStepMillisecond : step;\r\n    }\r\n\r\n    stepIsYearDuration(step: string) {\r\n        const year = moment.duration(step);\r\n        return (\r\n            year.years() !== 0 &&\r\n            year.months() === 0 &&\r\n            year.weeks() === 0 &&\r\n            year.days() === 0 &&\r\n            year.hours() === 0 &&\r\n            year.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsMonthDuration(step: string) {\r\n        const month = moment.duration(step);\r\n        return (\r\n            month.months() !== 0 &&\r\n            month.weeks() === 0 &&\r\n            month.days() === 0 &&\r\n            month.hours() === 0 &&\r\n            month.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsWeekDuration(step: string) {\r\n        const week = moment.duration(step);\r\n        return (\r\n            week.weeks() !== 0 &&\r\n            week.days() === 7 &&\r\n            week.hours() === 0 &&\r\n            week.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsDayDuration(step: string) {\r\n        const day = moment.duration(step);\r\n        return day.days() !== 0 && day.hours() === 0 && day.minutes() === 0;\r\n    }\r\n\r\n    stepIsHourDuration(step: string) {\r\n        const hour = moment.duration(step);\r\n        return hour.hours() !== 0 && hour.minutes() === 0;\r\n    }\r\n\r\n    stepIsMinuteDuration(step: string) {\r\n        const minute = moment.duration(step);\r\n        return minute.minutes() !== 0;\r\n    }\r\n\r\n    dateToNumber(date: Date): number {\r\n        let newDate = new Date();\r\n        if (date) {\r\n          newDate = new Date(date);\r\n        }\r\n        return newDate.getTime();\r\n    }\r\n\r\n    public addStep(value, stepMillisecond) {\r\n        return moment(value).add(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n\r\n    public subtractStep(value, stepMillisecond) {\r\n        return moment(value).subtract(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n}\r\n","<form [formGroup]=\"form\">\r\n  <div *ngFor=\"let selector of ogcFiltersSelectors\">\r\n    <div class=\"pushButtonGroups\" *ngIf=\"selector.selectorType === 'pushButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getPushButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"pushButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentPushButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getPushButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentPushButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-button-toggle-group\r\n          formControlName=\"pushButtons\" class=\"mat-typography\" appearance=\"legacy\" vertical={{bundleIsVertical(bundle)}} multiple=\"true\">\r\n          <mat-button-toggle *ngFor=\"let ogcPushButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcPushButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n            [ngStyle]=\"getButtonColor(ogcPushButton)\"\r\n            [checked]=\"ogcPushButton.enabled\" (change)=\"onSelectionChange(ogcPushButton, selector.selectorType)\"\r\n            [value]=\"ogcPushButton\">{{ogcPushButton.title}}\r\n          </mat-button-toggle>\r\n        </mat-button-toggle-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"checkboxGroups\" *ngIf=\"selector.selectorType === 'checkbox'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getCheckboxesGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"checkboxesGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentCheckboxesGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getCheckboxesGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentCheckboxesGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"checkboxes mat-typography\">\r\n          <mat-checkbox *ngFor=\"let ogcCheckbox of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcCheckbox)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcCheckbox.enabled\" (change)=\"onSelectionChange(ogcCheckbox, selector.selectorType)\"\r\n            [value]=\"ogcCheckbox\">{{ogcCheckbox.title}}\r\n          </mat-checkbox>\r\n        </div>\r\n        <p *ngIf=\"isLessResults(bundle, 'checkbox') || isMoreResults(bundle, 'checkbox')\">\r\n          <u *ngIf=\"isLessResults(bundle, 'checkbox')\"\r\n            class=\"lessResults mat-typography\"\r\n            (click)=\"displayLessResults('checkbox')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n          </u>\r\n          <u *ngIf=\"isMoreResults(bundle, 'checkbox')\"\r\n            class=\"moreResults mat-typography\"\r\n            (click)=\"displayMoreResults('checkbox')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n          </u>\r\n        </p>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"radioButtonGroups\" *ngIf=\"selector.selectorType === 'radioButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getRadioButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"radioButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentRadioButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getRadioButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentRadioButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-radio-group\r\n          formControlName=\"radioButtons\" class=\"mat-typography\">\r\n          <mat-radio-button *ngIf=\"bundle.unfiltered\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (change)=\"emptyRadioButtons()\">{{ 'igo.geo.filter.resetFilters' | translate }}\r\n          </mat-radio-button>\r\n          <mat-radio-button *ngFor=\"let ogcRadioButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcRadioButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcRadioButton.enabled\" (change)=\"onSelectionChange(ogcRadioButton, selector.selectorType)\"\r\n            [value]=\"ogcRadioButton\">{{ogcRadioButton.title}}\r\n          </mat-radio-button>\r\n          <p *ngIf=\"isLessResults(bundle, 'radio') || isMoreResults(bundle, 'radio')\">\r\n            <u *ngIf=\"isLessResults(bundle, 'radio')\"\r\n              class=\"lessResults mat-typography\"\r\n              (click)=\"displayLessResults('radio')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n            </u>\r\n            <u *ngIf=\"isMoreResults(bundle, 'radio')\"\r\n              class=\"moreResults mat-typography\"\r\n              (click)=\"displayMoreResults('radio')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n            </u>\r\n          </p>\r\n        </mat-radio-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"selectGroups\" *ngIf=\"selector.selectorType === 'select'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getSelectGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"selectGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentSelectGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getSelectGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentSelectGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered && !bundle.multiple\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptySelect()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field [style.width.%]=\"bundle.width ? bundle.width : undefined\">\r\n            <div *ngIf=\"bundle.multiple; else notMulti\">\r\n              <mat-select\r\n                #selection [multiple]=\"bundle.multiple\" [placeholder]=\"bundle.title\" formControlName=\"selectMulti\">\r\n                <div class=\"checkboxes mat-typography\">\r\n                  <mat-checkbox *ngIf=\"bundle.multiple\"\r\n                    [(ngModel)]=\"selectAllSelected\" [ngModelOptions]=\"{standalone: true}\"\r\n                    (change)=\"toggleAllSelection()\">Tous\r\n                  </mat-checkbox>\r\n                </div>\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  (onSelectionChange)=\"selectOptionClick($event.source.value, bundle, $event)\"\r\n                  [value]=\"ogcSelect\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </div>\r\n            <ng-template #notMulti>\r\n              <mat-select\r\n                [placeholder]=\"bundle.title\" formControlName=\"select\">\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  [value]=\"ogcSelect\" (onSelectionChange)=\"selectOptionClick($event.source.value, bundle)\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </ng-template>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"autocompleteGroups\" *ngIf=\"selector.selectorType === 'autocomplete'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getAutocompleteGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"autocompleteGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentAutocompleteGroup\">\r\n            <mat-option *ngFor=\"let autocompleteGroup of getAutocompleteGroups()\"\r\n              [value]=\"autocompleteGroup\">{{autocompleteGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentAutocompleteGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptyAutocomplete()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field *ngIf=\"filteredOgcAutocomplete[bundle.id]\" [style.width.%]=\"bundle.width ? bundle.width : undefined\">\r\n            <input matInput type=\"text\" formControlName=\"autocomplete\" #autocomplete class=\"autocomplete\"\r\n              [matAutocomplete]=\"auto\" [placeholder]=\"bundle.title\">\r\n              <mat-autocomplete #auto=\"matAutocomplete\" #autocomplete (optionSelected)=\"autocompleteOptionClick($event.option.value)\"\r\n              [displayWith]=\"displayFn\">\r\n                <mat-option *ngFor=\"let ogcAutocomplete of filteredOgcAutocomplete[bundle.id] | async\" [value]=\"ogcAutocomplete\">\r\n                  {{ ogcAutocomplete.value }}\r\n                </mat-option>\r\n              </mat-autocomplete>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n  </div>\r\n</form>\r\n\r\n<div *ngIf=\"isTemporalOperator()\">\r\n  <mat-divider></mat-divider>\r\n  <h4 *ngIf=\"!currentFilter.title\">{{ 'igo.geo.filter.reportingDate' | translate }}</h4>\r\n  <h4 *ngIf=\"currentFilter.title\">{{ currentFilter.title }}</h4>\r\n  <igo-ogc-filter-time\r\n    [(datasource)]=\"datasource\"\r\n    [(currentFilter)]=\"currentFilter\"\r\n    (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n  </igo-ogc-filter-time>\r\n</div>","import {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { DOMService, DOMValue } from '@igo2/common';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  IgoOgcFilterObject,\r\n  OgcPushButton,\r\n  OgcSelectorBundle,\r\n  SelectorGroup\r\n\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { IgoMap } from '../../map';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { UntypedFormBuilder, UntypedFormGroup, Validators } from '@angular/forms';\r\nimport { debounceTime, map } from 'rxjs/operators';\r\nimport { OgcFilterOperator } from '../shared/ogc-filter.enum';\r\nimport { MatSelect } from '@angular/material/select';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-selection',\r\n  templateUrl: './ogc-filter-selection.component.html',\r\n  styleUrls: ['./ogc-filter-selection.component.scss'],\r\n  providers: [ DOMService ]\r\n})\r\nexport class OgcFilterSelectionComponent implements OnInit {\r\n\r\n  @ViewChild('selection') sel: MatSelect;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() checkboxesIndex = 5;\r\n  @Input() radioButtonsIndex = 5;\r\n  @Input() baseIndex = 5;\r\n\r\n  @Input()\r\n  get currentFilter(): any {\r\n    return this._currentFilter;\r\n  }\r\n  set currentFilter(value) {\r\n    this._currentFilter = value;\r\n    if (this._currentFilter?.sliderOptions) {\r\n      this._currentFilter.sliderOptions.enabled = false; // remove slider toggle (animation temporelle)\r\n    }\r\n  }\r\n  private _currentFilter: any;\r\n\r\n  public ogcFilterOperator = OgcFilterOperator;\r\n\r\n  public form: UntypedFormGroup;\r\n  private ogcFilterWriter: OgcFilterWriter;\r\n  public color = 'primary';\r\n  public selectAllSelected = false;\r\n  public selectEnabled$ = new BehaviorSubject(undefined);\r\n  public selectEnableds$ = new BehaviorSubject([]);\r\n  public autocompleteEnabled$ = new BehaviorSubject(undefined);\r\n  public filteredOgcAutocomplete = {};\r\n\r\n  public applyFiltersTimeout;\r\n\r\n  get ogcFiltersSelectors() {\r\n    const ogcSelector = [];\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.pushButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.checkboxes);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.radioButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.select);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.autocomplete) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.autocomplete);\r\n    }\r\n    ogcSelector.sort((a, b) => {\r\n      if (a.order < b.order) {\r\n        return -1;\r\n      }\r\n      if (a.order > b.order) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    return ogcSelector;\r\n  }\r\n\r\n  get currentPushButtonsGroup() {\r\n    return this.form.get('pushButtonsGroup').value;\r\n  }\r\n  set currentPushButtonsGroup(value) {\r\n    this.form.patchValue({ pushButtonsGroup: value });\r\n  }\r\n\r\n  get currentCheckboxesGroup() {\r\n    return this.form.get('checkboxesGroup').value;\r\n  }\r\n  set currentCheckboxesGroup(value) {\r\n    this.form.patchValue({ checkboxesGroup: value });\r\n  }\r\n\r\n  get currentRadioButtonsGroup() {\r\n    return this.form.get('radioButtonsGroup').value;\r\n  }\r\n  set currentRadioButtonsGroup(value) {\r\n    this.form.patchValue({ radioButtonsGroup: value });\r\n  }\r\n\r\n  get currentSelectGroup() {\r\n    return this.form.get('selectGroup').value;\r\n  }\r\n  set currentSelectGroup(value) {\r\n    this.form.patchValue({ selectGroup: value });\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  get currentAutocompleteGroup() {\r\n    return this.form.get('autocompleteGroup').value;\r\n  }\r\n  set currentAutocompleteGroup(value) {\r\n    this.form.patchValue({ autocompleteGroup: value });\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  get selectEnabled() {\r\n    return this.selectEnabled$.value;\r\n  }\r\n\r\n  set selectEnabled(value) {\r\n    this.selectEnabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value === selector ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get selectEnableds() {\r\n    return this.selectEnableds$.value;\r\n  }\r\n\r\n  set selectEnableds(value) {\r\n    this.selectEnableds$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value.includes(selector) ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get autocompleteEnabled() {\r\n    return this.autocompleteEnabled$.value;\r\n  }\r\n\r\n  set autocompleteEnabled(value) {\r\n    this.autocompleteEnabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentAutocompleteGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value === selector.title ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  constructor(\r\n    private ogcFilterService: OGCFilterService,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private domService: DOMService,\r\n    private configService: ConfigService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n    this.buildForm();\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      pushButtons: ['', [Validators.required]],\r\n      radioButtons: ['', [Validators.required]],\r\n      pushButtonsGroup: ['', [Validators.required]],\r\n      checkboxesGroup: ['', [Validators.required]],\r\n      radioButtonsGroup: ['', [Validators.required]],\r\n      selectGroup: ['', [Validators.required]],\r\n      select: ['', [Validators.required]],\r\n      selectMulti: ['', [Validators.required]],\r\n      autocompleteGroup: ['', [Validators.required]],\r\n      autocomplete: ['', [Validators.required]]\r\n    });\r\n  }\r\n\r\n  getPushButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      return this.datasource.options.ogcFilters.pushButtons.groups;\r\n    }\r\n  }\r\n\r\n  getCheckboxesGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      return this.datasource.options.ogcFilters.checkboxes.groups;\r\n    }\r\n  }\r\n\r\n  getRadioButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      return this.datasource.options.ogcFilters.radioButtons.groups;\r\n    }\r\n  }\r\n\r\n  getSelectGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      return this.datasource.options.ogcFilters.select.groups;\r\n    }\r\n  }\r\n\r\n  getAutocompleteGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.autocomplete) {\r\n      return this.datasource.options.ogcFilters.autocomplete.groups;\r\n    }\r\n  }\r\n\r\n  async ngOnInit() {\r\n    if (this.datasource.options.ogcFilters) {\r\n      if (this.datasource.options.ogcFilters.pushButtons) {\r\n        this.currentPushButtonsGroup =\r\n          this.datasource.options.ogcFilters.pushButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.pushButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.checkboxes) {\r\n        this.currentCheckboxesGroup =\r\n          this.datasource.options.ogcFilters.checkboxes.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.checkboxes.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.radioButtons) {\r\n        this.currentRadioButtonsGroup =\r\n          this.datasource.options.ogcFilters.radioButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.radioButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.select) {\r\n        this.currentSelectGroup =\r\n          this.datasource.options.ogcFilters.select.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.select.groups[0];\r\n        this.getSelectEnabled();\r\n        await this.getSelectDomValues();\r\n      }\r\n      if (this.datasource.options.ogcFilters.autocomplete) {\r\n        this.currentAutocompleteGroup =\r\n          this.datasource.options.ogcFilters.autocomplete.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.autocomplete.groups[0];\r\n        this.getAutocompleteEnabled();\r\n        await this.getAutocompleteDomValues();\r\n      }\r\n      this.applyFilters();\r\n    }\r\n\r\n    this.form\r\n    .get('pushButtonsGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onPushButtonsChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n    .get('checkboxesGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onCheckboxesChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtonsGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onRadioButtonsChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('selectGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onSelectChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('autocompleteGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onAutocompleteChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('pushButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n  }\r\n\r\n  private getSelectEnabled() {\r\n    const enableds = [];\r\n    let enabled;\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      if (compSelect.multiple) {\r\n        compSelect.selectors?.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enableds.push(selector);\r\n          }\r\n        });\r\n        this.selectEnableds = enableds;\r\n        this.form.controls['selectMulti'].setValue(enableds);\r\n      } else {\r\n        compSelect.selectors?.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enabled = selector;\r\n          }\r\n        });\r\n        this.form.controls['select'].reset(enabled);\r\n        this.selectEnabled$.subscribe((value) => {\r\n          if (this.form.controls['select'].value !== value) {\r\n            this.form.controls['select'].setValue(value);\r\n          }\r\n        });\r\n        this.selectEnabled = enabled;\r\n      }\r\n    });\r\n  }\r\n\r\n  private getAutocompleteEnabled() {\r\n    let enabled;\r\n    this.currentAutocompleteGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        if (selector.enabled) {\r\n          const dom = {\r\n            id: selector.filters.expression,\r\n            value: selector.title\r\n          };\r\n          enabled = selector.title;\r\n          this.form.controls['autocomplete'].setValue(dom);\r\n        }\r\n      });\r\n      this.autocompleteEnabled = enabled;\r\n    });\r\n  }\r\n\r\n  getToolTip(selector): string {\r\n    let toolTip;\r\n    if (selector.tooltip) {\r\n      if (Array.isArray(selector.tooltip)) {\r\n        toolTip = selector.tooltip.join('\\n');\r\n      } else {\r\n        toolTip = selector.tooltip;\r\n      }\r\n    }\r\n    return toolTip || '';\r\n  }\r\n\r\n  async getSelectDomValues() {\r\n    for (const bundle of this.datasource.options.ogcFilters.select.bundles) {\r\n      if (bundle.domSelectors) {\r\n        let domValues;\r\n        for (const domSelector of bundle.domSelectors) {\r\n          let filterDOM;\r\n          for (const domOptions of this.configService.getConfig('dom')) {\r\n            if (domSelector.id === domOptions.id || domSelector.name === domOptions.name) {\r\n              filterDOM = {\r\n                id: domOptions.id,\r\n                url: domOptions.url,\r\n                name: domOptions.name,\r\n                values: domOptions.values\r\n              };\r\n            }\r\n          }\r\n          filterDOM.url ? domValues = await this.domService.getDom(filterDOM) as DOMValue[] :\r\n            domValues = filterDOM.values;\r\n\r\n          if (domValues) {\r\n            let newBundle = bundle;\r\n            newBundle.selectors = [];\r\n            let selector;\r\n            for (const value of domValues) {\r\n              if (bundle.multiple) {\r\n                let enabled;\r\n                this.selectEnableds?.find(sel => sel.title === value.value) ? enabled = true : enabled = false;\r\n                selector = {\r\n                  title: value.value,\r\n                  enabled,\r\n                  filters: {\r\n                    operator: domSelector.operator,\r\n                    propertyName: domSelector.propertyName,\r\n                    expression: value.id,\r\n                  }\r\n                };\r\n              } else {\r\n                selector = {\r\n                  title: value.value,\r\n                  enabled: this.selectEnabled?.title === value.value ?\r\n                    true : false,\r\n                  filters: {\r\n                    operator: domSelector.operator,\r\n                    propertyName: domSelector.propertyName,\r\n                    expression: value.id,\r\n                  }\r\n                };\r\n              }\r\n              newBundle.selectors.push(selector);\r\n            }\r\n            this.getSelectGroups().find(group => group.ids.includes(newBundle.id)).computedSelectors\r\n              .find(comp => comp.title === newBundle.title).selectors = newBundle.selectors;\r\n          }\r\n        }\r\n        this.getSelectEnabled();\r\n      }\r\n    }\r\n  }\r\n\r\n  async getAutocompleteDomValues() {\r\n    for (const bundle of this.datasource.options.ogcFilters.autocomplete.bundles) {\r\n      if (bundle.domSelectors) {\r\n        let domValues;\r\n        for (const domSelector of bundle.domSelectors) {\r\n          let filterDOM;\r\n          for (const domOptions of this.configService.getConfig('dom')) {\r\n            if (domSelector.id === domOptions.id || domSelector.name === domOptions.name) {\r\n              filterDOM = {\r\n                id: domOptions.id,\r\n                url: domOptions.url,\r\n                name: domOptions.name,\r\n                values: domOptions.values\r\n              };\r\n            }\r\n          }\r\n          filterDOM.url ? domValues = await this.domService.getDom(filterDOM) as DOMValue[] :\r\n            domValues = filterDOM.values;\r\n\r\n          if (domValues) {\r\n            let newBundle = bundle;\r\n            newBundle.selectors = [];\r\n            let selector;\r\n            for (const value of domValues) {\r\n              selector = {\r\n                title: value.value,\r\n                enabled: this.autocompleteEnabled && this.autocompleteEnabled === value.value ?\r\n                  true : false,\r\n                filters: {\r\n                  operator: domSelector.operator,\r\n                  propertyName: domSelector.propertyName,\r\n                  expression: value.id,\r\n                }\r\n              };\r\n              newBundle.selectors.push(selector);\r\n            }\r\n            this.getAutocompleteGroups().find(group => group.ids.includes(newBundle.id)).computedSelectors\r\n              .find(comp => comp.title === newBundle.title).selectors = newBundle.selectors;\r\n          }\r\n        }\r\n\r\n        this.filteredOgcAutocomplete[bundle.id] = new Observable<any[]>();\r\n        this.cdRef.detectChanges();\r\n        this.filteredOgcAutocomplete[bundle.id] = this.form.controls['autocomplete'].valueChanges.pipe(\r\n          map(value => {\r\n            if (value.length) {\r\n              return domValues?.filter((option) => {\r\n                const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                return featureNameNormalized.includes(filterNormalized);\r\n              });\r\n            }\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // getButtonStyle(pb: OgcPushButton): {} {\r\n\r\n  //   let styles;\r\n  //   if (pb.color) {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? `rgba(${pb.color})` : `rgba(255,255,255,0)`\r\n  //     };\r\n  //   } else {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? 'accent': `rgba(255,255,255,0)`,\r\n  //       'color': pb.enabled ? `rgba(0,0,0,0.9)` : `rgba(33,33,33,0.38)`\r\n  //     }\r\n  //   }\r\n  //   return styles;\r\n  // }\r\n\r\n  getButtonColor(pushButton: OgcPushButton): {} {\r\n    let styles;\r\n    if (pushButton.color && pushButton.enabled) {\r\n      styles = {\r\n        'background-color': `rgba(${pushButton.color})`\r\n      };\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  bundleIsVertical(bundle: OgcSelectorBundle): boolean {\r\n    return bundle.vertical ? bundle.vertical : false;\r\n  }\r\n\r\n  private onPushButtonsChangeGroup() {\r\n    this.getPushButtonsGroups().map(group => group.enabled = false);\r\n    this.getPushButtonsGroups().find(group => group === this.currentPushButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onCheckboxesChangeGroup() {\r\n    this.getCheckboxesGroups().map(group => group.enabled = false);\r\n    this.getCheckboxesGroups().find(group => group === this.currentCheckboxesGroup).enabled = true;\r\n  }\r\n\r\n  private onRadioButtonsChangeGroup() {\r\n    this.getRadioButtonsGroups().map(group => group.enabled = false);\r\n    this.getRadioButtonsGroups().find(group => group === this.currentRadioButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onSelectChangeGroup() {\r\n    this.getSelectGroups().map(group => group.enabled = false);\r\n    this.getSelectGroups().find(group => group === this.currentSelectGroup).enabled = true;\r\n  }\r\n\r\n  private onAutocompleteChangeGroup() {\r\n    this.getAutocompleteGroups().map(group => group.enabled = false);\r\n    this.getAutocompleteGroups().find(group => group === this.currentAutocompleteGroup).enabled = true;\r\n  }\r\n\r\n  onSelectionChange(currentOgcSelection?, selectorType?) {\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    if (selectorType === 'radioButton') {\r\n      this.emptyRadioButtons();\r\n    }\r\n\r\n    if (currentOgcSelection) {\r\n      currentOgcSelection.enabled = !currentOgcSelection.enabled;\r\n    }\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  emptyRadioButtons() {\r\n    this.currentRadioButtonsGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors.map(selector => selector.enabled = false);\r\n\r\n      this.applyFiltersTimeout = setTimeout(() => {\r\n        this.applyFilters();\r\n      }, 750);\r\n   });\r\n  }\r\n\r\n  emptySelect() {\r\n    this.selectEnabled = undefined;\r\n  }\r\n\r\n  emptyAutocomplete() {\r\n    this.autocompleteEnabled = undefined;\r\n    this.form.controls['autocomplete'].setValue('');\r\n    this.form.controls['autocomplete'].markAsUntouched();\r\n  }\r\n\r\n  toggleAllSelection() {\r\n    if (this.selectAllSelected) {\r\n      const enableds = [];\r\n      this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n        compSelect.selectors?.forEach(selector => {\r\n          enableds.push(selector);\r\n        });\r\n      });\r\n      this.sel.options.forEach((item: MatOption) => item.select());\r\n      this.selectEnableds = enableds;\r\n    } else {\r\n      this.sel.options.forEach((item: MatOption) => item.deselect());\r\n      this.selectEnableds = [];\r\n    }\r\n  }\r\n\r\n  selectOptionClick(value, bundle, event?) {\r\n    if (bundle.multiple) {\r\n      const enableds = this.selectEnableds;\r\n      let newStatus = true;\r\n      this.sel.options.forEach((item: MatOption) => {\r\n        if (!item.selected) {\r\n          newStatus = false;\r\n        }\r\n      });\r\n      this.selectAllSelected = newStatus;\r\n      if (event.isUserInput) {\r\n        if (enableds.length) {\r\n          for (const enabled of enableds) {\r\n            if (enabled.title === value.title) {\r\n              if (enabled.enabled && value.enabled) {\r\n                enableds.splice(enableds.indexOf(enabled), 1);\r\n                this.selectEnableds = enableds;\r\n                break;\r\n              }\r\n            } else if (enableds.indexOf(enabled) === enableds.length - 1) {\r\n              enableds.push(value);\r\n              this.selectEnableds = enableds;\r\n              break;\r\n            }\r\n          }\r\n        } else {\r\n          enableds.push(value);\r\n          this.selectEnableds = enableds;\r\n        }\r\n      }\r\n    } else {\r\n      this.selectEnabled = value;\r\n    }\r\n  }\r\n\r\n  autocompleteOptionClick(value) {\r\n    this.autocompleteEnabled = value.value;\r\n  }\r\n\r\n  displayFn(dom): string {\r\n    return dom ? dom.value : undefined;\r\n  }\r\n\r\n  private applyFilters() {\r\n    let filterQueryString = '';\r\n    const conditions = [];\r\n    const currentGroups = [this.currentPushButtonsGroup, this.currentCheckboxesGroup,\r\n      this.currentRadioButtonsGroup, this.currentSelectGroup, this.currentAutocompleteGroup];\r\n    for (const currentGroup of currentGroups) {\r\n      if (currentGroup.computedSelectors) {\r\n        currentGroup.computedSelectors.map(selectorBundle => {\r\n          const bundleCondition = [];\r\n          selectorBundle.selectors?.filter(ogcSelector => ogcSelector.enabled === true)\r\n          .forEach(enabledSelector => bundleCondition.push(enabledSelector.filters));\r\n          if (bundleCondition.length >= 1 ) {\r\n            if (bundleCondition.length === 1) {\r\n              conditions.push(bundleCondition[0]);\r\n            } else {\r\n              conditions.push({logical: selectorBundle.logical, filters: bundleCondition});\r\n            }\r\n          }\r\n        });\r\n      }\r\n    }\r\n    if (this.isTemporalOperator() && this._currentFilter.active) {\r\n      conditions.push(this.datasource.options.ogcFilters.interfaceOgcFilters[0]);\r\n    }\r\n    if (conditions.length >= 1) {\r\n      filterQueryString = this.ogcFilterWriter\r\n        .buildFilter(conditions.length === 1 ?\r\n          conditions[0] : {logical: 'And', filters: conditions } as IgoOgcFilterObject);\r\n    }\r\n    if (this.datasource.options.type === 'wms') {\r\n      this.ogcFilterService.filterByOgc(this.datasource as WMSDataSource, filterQueryString );\r\n    }\r\n    if (this.datasource.options.type === 'wfs') {\r\n      // TODO: Check how to prevent wfs to refresh when filter icon is pushed...\r\n      this.datasource.ol.refresh();\r\n    }\r\n    this.datasource.setOgcFilters(this.datasource.options.ogcFilters, true);\r\n  }\r\n\r\n  isMoreResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return selectorsLength > index;\r\n  }\r\n\r\n  displayMoreResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex += 5 : this.checkboxesIndex += 5;\r\n    return;\r\n  }\r\n\r\n  isLessResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return this.baseIndex !== index && selectorsLength > this.baseIndex;\r\n  }\r\n\r\n  displayLessResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex = this.baseIndex : this.checkboxesIndex = this.baseIndex;\r\n    return;\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter?.operator?.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        filter => filter.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.applyFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n}\r\n","<mat-tab-group\r\n  [selectedIndex]=\"selectedTypeIndex.value\"\r\n  (selectedIndexChange)=\"selectedTypeIndex.setValue($event)\"\r\n  (selectedTabChange)=\"onTypeChange($event)\">\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.predefined' | translate\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.spatialFilter.searchLabel' | translate}}</mat-label>\r\n      <mat-select (selectionChange)=\"onSelectionChange()\" [(value)]=\"selectedQueryType\">\r\n        <mat-option *ngFor=\"let queryType of queryType\" [value]=\"queryType\">\r\n          {{('igo.geo.terrapi.' + queryType) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n    <igo-spatial-filter-list\r\n      [store]=\"store\"\r\n      [queryType]=\"selectedQueryType\"\r\n      [zone]=\"zone\"\r\n      [layers]=\"layers\"\r\n      (zoneChange)=\"zoneChange.emit($event)\"\r\n      (zoneWithBufferChange)=\"zoneWithBufferChange.emit($event)\"\r\n      (bufferChange)=\"bufferChange.emit($event)\"\r\n      (measureUnitChange)=\"measureUnitChange.emit($event)\">\r\n    </igo-spatial-filter-list>\r\n  </mat-tab>\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.draw' | translate\">\r\n    <div class=\"spatial-type-toggle\">\r\n      <mat-button-toggle-group\r\n        [value]=\"activeDrawType\"\r\n        (change)=\"onDrawTypeChange($event.value)\">\r\n        <mat-button-toggle [value]=\"spatialType.Polygon\" [matTooltip]=\"'igo.geo.spatialFilter.drawPolygon' | translate\">\r\n            <mat-icon svgIcon=\"pentagon-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"spatialType.Point\" [matTooltip]=\"'igo.geo.spatialFilter.drawCircle' | translate\">\r\n            <mat-icon svgIcon=\"record-circle-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n      </mat-button-toggle-group>\r\n    </div>\r\n  </mat-tab>\r\n\r\n</mat-tab-group>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { Layer } from '../../../layer';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-type',\r\n  templateUrl: './spatial-filter-type.component.html',\r\n  styleUrls: ['./spatial-filter-type.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterTypeComponent implements OnInit {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  public queryType: string[] = ['Arrond', 'CircFed', 'CircProv', 'DirReg', 'Mun', 'MRC', 'AdmRegion', 'RegTour'];\r\n  public selectedTypeIndex = new UntypedFormControl(0);\r\n\r\n  /**\r\n   * Reference to the SpatialFIlterType enum\r\n   * @internal\r\n   */\r\n  public spatialType = SpatialFilterType;\r\n\r\n  public activeDrawType: SpatialFilterType = this.spatialType.Polygon;\r\n\r\n  @Input() selectedQueryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public type: SpatialFilterType;\r\n\r\n  @Output() eventType = new EventEmitter<SpatialFilterType>();\r\n\r\n  @Output() eventQueryType = new EventEmitter<SpatialFilterQueryType>();\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = this.spatialType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onTypeChange(event) {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = SpatialFilterType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onDrawTypeChange(spatialType: SpatialFilterType) {\r\n    this.activeDrawType = spatialType;\r\n    this.eventType.emit(this.activeDrawType);\r\n  }\r\n\r\n  onSelectionChange() {\r\n    this.eventQueryType.emit(this.selectedQueryType);\r\n    this.zoneChange.emit(undefined);\r\n  }\r\n}\r\n","<form class=\"form-list\">\r\n    <mat-form-field class=\"zone-list\">\r\n        <input #input type=\"text\" placeholder=\"{{'igo.geo.spatialFilter.listLabel' | translate}}\" matInput\r\n        [formControl]=\"formControl\" [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onZoneChange($event.option.value)\"\r\n        [displayWith]=\"displayFn\">\r\n            <mat-option *ngFor=\"let entities of this.store.view.all$() | async\" [value]=\"entities\">\r\n                {{entities.properties.nom}}\r\n            </mat-option>\r\n        </mat-autocomplete>\r\n    </mat-form-field>\r\n<form>\r\n\r\n<div class=\"buffer-div\">\r\n    <form class=\"buffer-form\">\r\n        <mat-form-field class=\"buffer\">\r\n            <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n            [value]=\"0\" [readonly]=\"!zone\">\r\n        </mat-form-field>\r\n    </form>\r\n\r\n    <mat-form-field class=\"unit-field\">\r\n        <mat-select\r\n        [value]=\"measureUnit\"\r\n        (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n        <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n            {{('igo.geo.measure.' + measureUnit) | translate}}\r\n        </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n</div>\r\n","import { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { SpatialFilterService } from './../../shared/spatial-filter.service';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from './../../shared/spatial-filter.enum';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure/shared';\r\nimport { MessageService } from '@igo2/core';\r\nimport { Layer } from '../../../layer';\r\n\r\n@Component({\r\n  selector: 'igo-spatial-filter-list',\r\n  templateUrl: './spatial-filter-list.component.html',\r\n  styleUrls: ['./spatial-filter-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterListComponent implements OnInit, OnDestroy {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  @Input()\r\n  get queryType(): SpatialFilterQueryType {\r\n    return this._queryType;\r\n  }\r\n  set queryType(queryType: SpatialFilterQueryType) {\r\n    this.formControl.setValue('');\r\n    this._queryType = queryType;\r\n  }\r\n  private _queryType: SpatialFilterQueryType;\r\n\r\n  @Input()\r\n  get zone() {\r\n    return this._zone;\r\n  }\r\n  set zone(value) {\r\n    this._zone = value;\r\n    if (!value) {\r\n      this.zoneWithBuffer = undefined;\r\n      this.bufferFormControl.setValue(0);\r\n    }\r\n  }\r\n  private _zone;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public zoneWithBuffer;\r\n  public selectedZone: any;\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  public formControl = new UntypedFormControl();\r\n\r\n  public bufferFormControl = new UntypedFormControl();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  formValueChanges$$: Subscription;\r\n  bufferValueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService) {}\r\n\r\n  ngOnInit() {\r\n    this.formValueChanges$$ = this.formControl.valueChanges.subscribe((value) => {\r\n      if (value.length) {\r\n        this.store.view.filter((feature) => {\r\n          const filterNormalized = value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          const featureNameNormalized = feature.properties.nom.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          return featureNameNormalized.includes(filterNormalized);\r\n        });\r\n      }\r\n    });\r\n\r\n    this.bufferValueChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500),\r\n        distinctUntilChanged()\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value * 1000,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0 && this.layers.length > 0) {\r\n          this.bufferChange.emit(value);\r\n          this.zoneWithBufferChange.emit(this.selectedZone);\r\n        } else if (\r\n            value < 0 ||\r\n            (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n            (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.messageService.alert('igo.geo.spatialFilter.bufferAlert', 'igo.geo.spatialFilter.warning');\r\n        }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.formValueChanges$$.unsubscribe();\r\n  }\r\n\r\n  displayFn(feature?: Feature): string | undefined {\r\n    return feature ? feature.properties.nom : undefined;\r\n  }\r\n\r\n  onZoneChange(feature) {\r\n    if (feature && this.queryType) {\r\n      this.spatialFilterService.loadItemById(feature, this.queryType)\r\n      .subscribe((featureGeom: Feature) => {\r\n        this.selectedZone = featureGeom;\r\n        this.zoneChange.emit(featureGeom);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n    }\r\n  }\r\n}\r\n","<igo-geometry-form-field-input\r\n  [formControl]=\"formControl\"\r\n  [map]=\"map\"\r\n  [geometryType]=\"geometryType\"\r\n  [drawGuide]=\"drawGuide$ | async\"\r\n  [measure]=\"measure\"\r\n  [drawControlIsActive]=\"drawControlIsActive\"\r\n  [freehandDrawIsActive]=\"freehandDrawIsActive\"\r\n  [drawStyle]=\"drawStyle$ | async\"\r\n  [overlayStyle]=\"overlayStyle$ | async\"\r\n  [radius]=\"radius\"\r\n  [predefinedRadius]=\"predefinedRadius\">\r\n</igo-geometry-form-field-input>\r\n\r\n<div class=\"header\">\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onDrawControlChange()\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"freehandDrawIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onfreehandControlChange()\">\r\n      {{'igo.geo.spatialFilter.freehandControl' | translate}}\r\n    </mat-slide-toggle>\r\n</div>\r\n\r\n<div class=\"buffer-unit\" *ngIf=\"isPolygon()\">\r\n  <form class=\"buffer-form\">\r\n    <mat-form-field class=\"buffer\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n      [value]=\"0\" [readonly]=\"this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<div class=\"radius-unit\" *ngIf=\"isPoint()\">\r\n  <form class=\"radius-form\">\r\n    <mat-form-field class=\"radius\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.radius' | translate}}\" [formControl]=\"radiusFormControl\"\r\n      [value]=\"1000\" (input)=\"getRadius()\" [readonly]=\"this.freehandDrawIsActive && this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<mat-label class=\"title mat-typography\">{{'igo.geo.spatialFilter.search' | translate}} : </mat-label>\r\n<mat-radio-group [value]=\"selectedItemType\">\r\n    <mat-radio-button *ngFor=\"let item of itemType\"\r\n      [value]=\"item\"\r\n      (change)=\"onItemTypeChange($event)\">\r\n      {{'igo.geo.spatialFilter.' + item | translate}}\r\n    </mat-radio-button>\r\n</mat-radio-group>\r\n\r\n<div class=\"thematics\" *ngIf=\"(selectedItemType==='Thematics' && !tableTemplate) || (selectedItemType==='Thematics' && tableTemplate && !listIsVisible)\">\r\n  <mat-table>\r\n      <!-- Name Column -->\r\n      <ng-container matColumnDef=\"name\">\r\n        <mat-header-cell *matHeaderCellDef class=\"thematics-header\">{{'igo.geo.spatialFilter.Thematics' | translate}}</mat-header-cell>\r\n      </ng-container>\r\n\r\n      <!-- Select Column -->\r\n      <ng-container matColumnDef=\"select\">\r\n        <mat-header-cell *matHeaderCellDef class=\"checks-header\">\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"isAllSelected()\"\r\n                        [indeterminate]=\"selectedThematics.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </mat-header-cell>\r\n    </ng-container>\r\n\r\n    <mat-header-row *matHeaderRowDef=\"displayedColumns\"></mat-header-row>\r\n    <mat-row *matRowDef=\"let row; columns: displayedColumns;\"></mat-row>\r\n\r\n  </mat-table>\r\n\r\n  <mat-tree [dataSource]=\"dataSource\" [treeControl]=\"treeControl\">\r\n    <!-- This is the tree node template for leaf nodes -->\r\n    <mat-tree-node *matTreeNodeDef=\"let node\" matTreeNodeToggle>\r\n      <li class=\"mat-tree-node\">\r\n        <!-- use a disabled button to provide padding for tree leaf -->\r\n        <button mat-icon-button disabled></button>\r\n        {{node.name}}\r\n        <mat-checkbox class=\"tree-check\" (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"$event ? onToggleChange(node) : null\"\r\n                      [checked]=\"selectedThematics.isSelected(node)\">\r\n        </mat-checkbox>\r\n      </li>\r\n    </mat-tree-node>\r\n\r\n    <!-- This is the tree node template for expandable nodes -->\r\n    <mat-nested-tree-node *matTreeNodeDef=\"let node; when: hasChild\">\r\n        <div class=\"mat-tree-node\">\r\n          <button mat-icon-button\r\n            (click)=\"onToggleClick(node)\">\r\n            <mat-icon [svgIcon]=\"treeControl.isExpanded(node) ? 'chevron-down' : 'chevron-right'\"></mat-icon>\r\n          </button>\r\n          {{node.name}}\r\n          <mat-checkbox class=\"tree-check-2\" (change)=\"$event ? childrensToggle(node) : null\"\r\n                        [checked]=\"isAllSelected(node)\"\r\n                        [indeterminate]=\"hasChildrenSelected(node) && !isAllSelected(node)\">\r\n          </mat-checkbox>\r\n        </div>\r\n        <ul class=\"tree-ul\" [class.example-tree-invisible]=\"!treeControl.isExpanded(node)\">\r\n          <ng-container matTreeNodeOutlet></ng-container>\r\n        </ul>\r\n    </mat-nested-tree-node>\r\n\r\n  </mat-tree>\r\n</div>\r\n\r\n<div class=\"buttons\">\r\n\r\n  <button *ngIf=\"isPredefined()\" mat-raised-button class=\"clear-search-button\" [disabled]=\"disabledClearSearch()\"\r\n    (click)=\"clearSearch()\">\r\n      {{'igo.geo.spatialFilter.clearSearch' | translate}}\r\n  </button>\r\n\r\n  <button *ngIf=\"isPolygon() || isPoint()\" mat-raised-button class=\"clear-form-button\" [disabled]=\"this.formControl.value === null\"\r\n    (click)=\"clearDrawZone()\">\r\n    {{'igo.geo.spatialFilter.clearForm' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"search-button\" [disabled]=\"disableSearchButton()\" color=\"primary\"\r\n    (click)=\"toggleSearchButton()\">\r\n    {{'igo.geo.spatialFilter.goSearch' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"remove-button\" [disabled]=\"allLayers.length === 0\" (click)=\"clearButton()\">\r\n    {{'igo.geo.spatialFilter.removeLayer' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"export-button\" [disabled]=\"!store.entities$.getValue().length\" (click)=\"export.emit()\">\r\n    {{'igo.geo.spatialFilter.exportLayer' | translate}}\r\n  </button>\r\n\r\n</div>\r\n\r\n<button\r\n  class=\"chevron-down\"\r\n  *ngIf=\"store.all().length && tableTemplate && !listIsVisible\"\r\n  mat-icon-button\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.spatialFilter.showSearchResults' | translate\"\r\n  (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n</button>\r\n\r\n<div class=\"results\" *ngIf=\"store.all().length && tableTemplate && listIsVisible\">\r\n  <button\r\n    *ngIf=\"listIsVisible\"\r\n    mat-icon-button\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialFilter.hideSearchResults' | translate\"\r\n    (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n  </button>\r\n  <igo-entity-table\r\n    class=\"results-list\"\r\n    [template]=\"tableTemplate\"\r\n    [store]=\"store\"\r\n    (entitySelectChange)=\"entityChange.emit($event)\">\r\n  </igo-entity-table>\r\n</div>\r\n","import OlFeature from 'ol/Feature';\r\nimport {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\nimport { IgoMap } from '../../../map';\r\nimport { SpatialFilterItemType } from './../../shared/spatial-filter.enum';\r\nimport { Feature } from './../../../feature/shared/feature.interfaces';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { GeoJSONGeometry } from '../../../geometry/shared/geometry.interfaces';\r\nimport * as olStyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { MatTreeNestedDataSource } from '@angular/material/tree';\r\nimport { SpatialFilterService } from '../../shared/spatial-filter.service';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { EntityStore, EntityStoreFilterSelectionStrategy, EntityTableColumnRenderer, EntityTableTemplate } from '@igo2/common';\r\nimport { Layer, VectorLayer } from '../../../layer/shared';\r\nimport { NestedTreeControl } from '@angular/cdk/tree';\r\nimport { SpatialFilterThematic } from './../../shared/spatial-filter.interface';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { FeatureMotion, FeatureStoreSelectionStrategy } from '../../../feature';\r\nimport { FeatureDataSource } from '../../../datasource/shared';\r\n\r\n/**\r\n * Spatial-Filter-Item (search parameters)\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-item',\r\n  templateUrl: './spatial-filter-item.component.html',\r\n  styleUrls: ['./spatial-filter-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterItemComponent implements OnDestroy, OnInit {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get type(): SpatialFilterType {\r\n    return this._type;\r\n  }\r\n  set type(type: SpatialFilterType) {\r\n    this._type = type;\r\n    const index = this.geometryTypes.findIndex(geom => geom === this.type);\r\n    this.geometryType = this.geometryTypes[index];\r\n    this.formControl.reset();\r\n    this.radius = undefined;\r\n    this.drawGuide$.next(null);\r\n    this.drawStyle$.next(undefined);\r\n\r\n    // Necessary to keep reference to the geometry form field input\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      const geojson: GeoJSONGeometry = {\r\n        type: 'Point',\r\n        coordinates: ''\r\n      };\r\n      this.formControl.setValue(geojson);\r\n    }\r\n\r\n    // Necessary to apply the right style when geometry type is Point\r\n    if (this.type === SpatialFilterType.Point) {\r\n      this.radius = 1000; // Base radius\r\n      this.radiusFormControl.setValue(this.radius);\r\n      this.PointStyle = (feature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const geom = feature.getGeometry() as OlPoint;\r\n        const coordinates = olproj.transform(geom.getCoordinates(), this.map.projection, 'EPSG:4326');\r\n        return new olStyle.Style ({\r\n          image: new olStyle.Circle ({\r\n            radius: this.radius / (Math.cos((Math.PI / 180) * coordinates[1])) / resolution, // Latitude correction\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PointStyle;\r\n      this.drawStyle$.next(this.overlayStyle);\r\n    } else {\r\n      // If geometry types is Polygon\r\n      this.radius = undefined;\r\n      this.PolyStyle = () => {\r\n        return new olStyle.Style ({\r\n          stroke: new olStyle.Stroke({\r\n            width: 2,\r\n            color: 'rgba(0, 153, 255)'\r\n          }),\r\n          fill: new olStyle.Fill({\r\n            color: 'rgba(0, 153, 255, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      const color = [0, 153, 255];\r\n      const drawStyle = () => {\r\n        return new olStyle.Style({\r\n          image: new olStyle.Circle ({\r\n            radius: 8,\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          }),\r\n          stroke: new olStyle.Stroke({\r\n            color: color.concat([1]),\r\n            width: 2\r\n          }),\r\n          fill:  new olStyle.Fill({\r\n            color: color.concat([0.2])\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PolyStyle;\r\n      this.drawStyle$.next(drawStyle);\r\n    }\r\n    this.overlayStyle$.next(this.overlayStyle);\r\n  }\r\n  private _type: SpatialFilterType;\r\n\r\n  @Input() queryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() loading;\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n    this._store.entities$.subscribe(() => { this.cdRef.detectChanges(); });\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  @Input() allLayers: Layer[] = [];\r\n\r\n  @Input()\r\n  get thematicLength(): number {\r\n    return this._thematicLength;\r\n  }\r\n  set thematicLength(value: number) {\r\n    this._thematicLength = value;\r\n  }\r\n  private _thematicLength: number;\r\n\r\n  @Output() toggleSearch = new EventEmitter();\r\n\r\n  @Output() itemTypeChange = new EventEmitter<SpatialFilterItemType>();\r\n\r\n  @Output() thematicChange = new EventEmitter<SpatialFilterThematic[]>();\r\n\r\n  @Output() drawZoneEvent = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferEvent = new EventEmitter<number>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  @Output() radiusEvent = new EventEmitter<number>();\r\n  @Output() freehandControl = new EventEmitter<boolean>();\r\n  @Output() predefinedRadius = new EventEmitter<boolean>();\r\n\r\n  @Output() clearButtonEvent = new EventEmitter();\r\n\r\n  @Output() clearSearchEvent = new EventEmitter();\r\n\r\n  @Output() export = new EventEmitter();\r\n\r\n  @Output() openWorkspace = new EventEmitter();\r\n  @Output() entityChange = new EventEmitter<any>();\r\n\r\n  public itemType: SpatialFilterItemType[] = [SpatialFilterItemType.Address, SpatialFilterItemType.Thematics];\r\n  public selectedItemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  public selectedSourceAddress;\r\n\r\n  treeControl: NestedTreeControl<SpatialFilterThematic> = new NestedTreeControl<SpatialFilterThematic>(node => node.children);\r\n\r\n  // For thematics and results tables\r\n  public displayedColumns: string[] = ['name', 'select'];\r\n  public childrens: SpatialFilterThematic[] = [];\r\n  public groups: string[] = [];\r\n  public thematics: SpatialFilterThematic[] = [];\r\n  public dataSource = new MatTreeNestedDataSource<SpatialFilterThematic>();\r\n  public selectedThematics = new SelectionModel<SpatialFilterThematic>(true, []);\r\n\r\n  // For geometry form field input\r\n  value$: BehaviorSubject<GeoJSONGeometry> = new BehaviorSubject(undefined);\r\n  drawGuide$: BehaviorSubject<number> = new BehaviorSubject(null);\r\n  overlayStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n  drawStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n\r\n  private value$$: Subscription;\r\n  private radiusChanges$$: Subscription;\r\n  private bufferChanges$$: Subscription;\r\n\r\n  public formControl = new UntypedFormControl();\r\n  public geometryType: Type | string;\r\n  public geometryTypeField = false;\r\n  public geometryTypes: string[] = ['Point', 'Polygon'];\r\n  public drawGuideField = false;\r\n  public drawGuide: number = null;\r\n  public drawGuidePlaceholder = '';\r\n  public measure = false;\r\n  public drawControlIsActive = true;\r\n  public freehandDrawIsActive = false;\r\n  public drawStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public drawZone;\r\n  public overlayStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PointStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PolyStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n\r\n  public radius: number;\r\n  public buffer: number = 0;\r\n  public radiusFormControl = new UntypedFormControl();\r\n  public bufferFormControl = new UntypedFormControl();\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  public zoneWithBuffer;\r\n\r\n  public listIsVisible = true;\r\n  public tableTemplate: EntityTableTemplate;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.spatialFilterService.loadThematicsList()\r\n    .subscribe((items: SpatialFilterThematic[]) => {\r\n      for (const item of items) {\r\n        this.childrens.push(item);\r\n        this.childrens.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      }\r\n      this.groups.push(this.languageService.translate.instant('igo.geo.terrapi.limites'));\r\n      const limits: SpatialFilterThematic = {\r\n        name: this.groups[0],\r\n        children: []\r\n      };\r\n      this.thematics.push(limits);\r\n      this.childrens.forEach(child => {\r\n        if (child.group && (this.groups.indexOf(child.group) === -1)) {\r\n          this.groups.push(child.group);\r\n          const thematic: SpatialFilterThematic = {\r\n            name: child.group,\r\n            children: []\r\n          };\r\n          this.thematics.push(thematic);\r\n        }\r\n\r\n        if (!child.group) {\r\n          if (\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.AdmRegion') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Mun') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Arrond') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircFed') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircProv') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.DirReg') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.MRC') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.RegTour')) {\r\n              child.group = limits.name;\r\n          } else if (child.name === this.languageService.translate.instant('igo.geo.terrapi.routes')) {\r\n            child.group = this.languageService.translate.instant('igo.geo.spatialFilter.group.transport');\r\n          } else {\r\n            const thematic: SpatialFilterThematic = {\r\n              name: child.name,\r\n              children: [],\r\n              source: child.source\r\n            };\r\n            this.thematics.push(thematic);\r\n          }\r\n        }\r\n        this.thematics.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      });\r\n      this.thematics.forEach(thematic => {\r\n        for (const child of this.childrens) {\r\n          if (child.group === thematic.name) {\r\n            thematic.children.push(child);\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.dataSource.data = this.thematics;\r\n\r\n    this.drawGuide$.next(null);\r\n    this.value$.next(this.formControl.value ? this.formControl.value : undefined);\r\n    this.value$$ = this.formControl.valueChanges.subscribe((value: GeoJSONGeometry) => {\r\n      if (value) {\r\n        this.value$.next(value);\r\n        this.drawZone = this.formControl.value as Feature;\r\n        if (this.buffer !== 0) {\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n          this.bufferFormControl.setValue(this.buffer);\r\n        }\r\n      } else {\r\n        this.value$.next(undefined);\r\n        this.drawZone = undefined;\r\n      }\r\n    });\r\n\r\n    this.value$.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.radiusChanges$$ = this.radiusFormControl.valueChanges.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.bufferChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500)\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value * 1000\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n        } else if (\r\n          value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.buffer = 0;\r\n            this.messageService.alert('igo.geo.spatialFilter.bufferAlert','igo.geo.spatialFilter.warning');\r\n        }\r\n    });\r\n\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map: this.map,\r\n      hitTolerance: 15,\r\n      motion: FeatureMotion.Default,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n\r\n    this.store.addStrategy(selectionStrategy, true);\r\n    this.store.addStrategy(selectedRecordStrategy, false);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the value stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.value$$.unsubscribe();\r\n    this.radiusChanges$$.unsubscribe();\r\n    this.bufferChanges$$.unsubscribe();\r\n    this.cdRef.detach();\r\n    if (this.radiusChanges$$) {\r\n      this.radiusChanges$$.unsubscribe();\r\n    }\r\n    if (this.value$$) {\r\n      this.value$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onItemTypeChange(event) {\r\n    this.selectedItemType = event.value;\r\n    this.itemTypeChange.emit(this.selectedItemType);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      if (this.isPolygon()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n      } else if (this.isPoint()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value * 1000) :\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value / 1000);\r\n      }\r\n    }\r\n  }\r\n\r\n  isPredefined() {\r\n    return this.type === SpatialFilterType.Predefined;\r\n  }\r\n\r\n  isPolygon() {\r\n    return this.type === SpatialFilterType.Polygon;\r\n  }\r\n\r\n  isPoint() {\r\n    return this.type === SpatialFilterType.Point;\r\n  }\r\n\r\n  hasChild(_: number, node: SpatialFilterThematic) {\r\n    if (node.children) {\r\n      return node.children.length;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  onToggleClick(node: SpatialFilterThematic) {\r\n    this.treeControl.isExpanded(node) ? this.treeControl.collapse(node) : this.treeControl.expand(node);\r\n  }\r\n\r\n  isAllSelected(node?: SpatialFilterThematic) {\r\n    let numSelected;\r\n    let numNodes = 0;\r\n    if (!node) {\r\n      numSelected = this.selectedThematics.selected.length;\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          numNodes++;\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.thematics.find(thematic => thematic.source === children.source)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    } else {\r\n      numSelected = node.children.length;\r\n      node.children.forEach(children => {\r\n        if (this.selectedThematics.selected.find(thematic => thematic === children)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (numNodes >= 1) {\r\n      return numSelected === numNodes;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  hasChildrenSelected(node: SpatialFilterThematic) {\r\n    let bool = false;\r\n    node.children.forEach(child => {\r\n      if (this.selectedThematics.selected.find(thematic => thematic.source === child.source)) {\r\n        bool = true;\r\n      }\r\n    });\r\n    return bool;\r\n  }\r\n\r\n  /**\r\n   * Apply header checkbox\r\n   */\r\n  masterToggle() {\r\n    this.isAllSelected() ?\r\n      this.selectedThematics.clear() :\r\n      this.selectAll();\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n\r\n    if (this.isAllSelected()) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.expand(thematic);\r\n        }\r\n      });\r\n    } else {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.collapse(thematic);\r\n        }\r\n      });\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  selectAll(node?: SpatialFilterThematic) {\r\n    if (!node) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          this.selectedThematics.select(thematic);\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.selectedThematics.selected.find(thematic => thematic.source === children.source)) {\r\n          this.selectedThematics.select(children);\r\n        }\r\n      });\r\n    } else {\r\n      if (this.hasChild(0, node)) {\r\n        node.children.forEach(children => this.selectedThematics.select(children));\r\n      }\r\n    }\r\n  }\r\n\r\n  childrensToggle(node: SpatialFilterThematic) {\r\n    this.isAllSelected(node) ?\r\n    node.children.forEach(child => this.selectedThematics.deselect(child)) :\r\n    this.selectAll(node);\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.treeControl.expand(node);\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  /**\r\n   * Apply changes to the thematics selected tree and emit event\r\n   */\r\n  onToggleChange(nodeSelected: SpatialFilterThematic) {\r\n    let selected = false;\r\n    if (this.selectedThematics.selected.find(thematic => thematic.source === nodeSelected.source) !== undefined) {\r\n      selected = true;\r\n    }\r\n\r\n    this.childrens.forEach(children => {\r\n      if (children === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(children);\r\n      }\r\n      if (children === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(children);\r\n      }\r\n    });\r\n    this.thematics.forEach(thematic => {\r\n      if (thematic === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(thematic);\r\n      }\r\n      if (thematic === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(thematic);\r\n      }\r\n    });\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  onDrawControlChange() {\r\n    this.drawControlIsActive = !this.drawControlIsActive;\r\n  }\r\n\r\n  onfreehandControlChange() {\r\n    this.freehandDrawIsActive = !this.freehandDrawIsActive;\r\n    this.freehandControl.emit(this.freehandDrawIsActive);\r\n    if (this.isPoint()) {\r\n      this.predefinedRadius.emit(!this.freehandDrawIsActive);\r\n      if (this.freehandDrawIsActive) {\r\n        this.overlayStyle$.next(undefined);\r\n        this.drawStyle$.next(undefined);\r\n      }\r\n    } else {\r\n      this.predefinedRadius.emit(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Launch search button\r\n   */\r\n  toggleSearchButton() {\r\n    if (!this.isPredefined()) {\r\n      if (this.buffer > 0) {\r\n        this.zoneWithBuffer.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.zoneWithBuffer.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.zoneWithBuffer);\r\n      } else {\r\n        this.drawZone.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.drawZone.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.drawZone);\r\n      }\r\n    }\r\n    if (this.isPoint()) {\r\n      this.radiusEvent.emit(this.radius);\r\n    } else if (this.isPolygon()) {\r\n      this.bufferEvent.emit(this.buffer);\r\n    }\r\n    this.toggleSearch.emit();\r\n    this.store.entities$.pipe(\r\n      debounceTime(500)\r\n    ).subscribe((value) => {\r\n      if (value.length && this.layers.length === this.thematicLength + 1) {\r\n        this.openWorkspace.emit();\r\n        this.createTableTemplate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Launch clear button (clear store and map layers)\r\n   */\r\n  clearButton() {\r\n    this.loading = true;\r\n    if (this.store) {\r\n      this.store.clear();\r\n    }\r\n    if (this.isPoint() || this.isPolygon()) {\r\n      this.drawZone = undefined;\r\n      this.formControl.reset();\r\n    }\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.clearButtonEvent.emit();\r\n    this.loading = false;\r\n    this.tableTemplate = undefined;\r\n  }\r\n\r\n  clearDrawZone() {\r\n    this.formControl.reset();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n  }\r\n\r\n  /**\r\n   * Launch clear search (clear field if type is predefined)\r\n   */\r\n  clearSearch() {\r\n    this.selectedThematics.clear();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.thematicChange.emit([]);\r\n    this.clearSearchEvent.emit();\r\n  }\r\n\r\n  /**\r\n   * Verify conditions of incomplete fields or busy service\r\n   */\r\n  disableSearchButton(): boolean {\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address) {\r\n        if (this.queryType !== undefined && this.zone !== undefined) {\r\n          return this.loading;\r\n        }\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.queryType !== undefined && this.zone !== undefined && this.selectedThematics.selected.length > 0) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon || this.type === SpatialFilterType.Point) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address && this.formControl.value !== null) {\r\n        return this.loading;\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.selectedThematics.selected.length > 0 && this.formControl.value !== null) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  disabledClearSearch() {\r\n    let disable = true;\r\n    this.selectedItemType === SpatialFilterItemType.Address ?\r\n      disable = this.queryType === undefined :\r\n      disable = this.queryType === undefined && this.selectedThematics.selected.length === 0;\r\n\r\n    return disable;\r\n  }\r\n\r\n  /**\r\n   * Manage radius value at user change\r\n   */\r\n  getRadius() {\r\n    let formValue;\r\n    if (this.formControl.value !== null) {\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        formValue = this.formControl.value.radius :\r\n        formValue = this.formControl.value.radius / 1000;\r\n    } else {\r\n      formValue = undefined;\r\n    }\r\n\r\n    if (this.type === SpatialFilterType.Point) {\r\n      if (!this.freehandDrawIsActive) {\r\n        if (\r\n          this.radiusFormControl.value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && this.radiusFormControl.value >= 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && this.radiusFormControl.value >= 100)) {\r\n          this.messageService.alert('igo.geo.spatialFilter.radiusAlert', 'igo.geo.spatialFilter.warning');\r\n          this.radius = 1000;\r\n          this.measureUnit === MeasureLengthUnit.Meters ?\r\n            this.radiusFormControl.setValue(this.radius) :\r\n            this.radiusFormControl.setValue(this.radius / 1000);\r\n          this.drawGuide$.next(this.radius);\r\n          return;\r\n        }\r\n      } else {\r\n        if (formValue) {\r\n          if (formValue >= 100000) {\r\n            this.messageService.alert('igo.geo.spatialFilter.radiusAlert', 'igo.geo.spatialFilter.warning');\r\n            this.formControl.reset();\r\n            return;\r\n          }\r\n          if (formValue !== this.radiusFormControl.value) {\r\n            this.radiusFormControl.setValue(formValue);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      if (this.measureUnit === MeasureLengthUnit.Meters) {\r\n        this.radius = this.radiusFormControl.value;\r\n        this.drawGuide$.next(this.radius);\r\n      } else {\r\n        this.radius = this.radiusFormControl.value * 1000;\r\n        this.drawGuide$.next(this.radius * 1000);\r\n      }\r\n      this.overlayStyle$.next(this.PointStyle);\r\n      this.drawStyle$.next(this.PointStyle);\r\n    }\r\n  }\r\n\r\n  toggleVisibleList() {\r\n    this.listIsVisible = !this.listIsVisible;\r\n  }\r\n\r\n  private createTableTemplate() {\r\n    const typeColumn = {\r\n      name: 'meta.title',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.type'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const nameColumn = {\r\n      name: 'properties.nom',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.searchResults'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const columns = [typeColumn, nameColumn];\r\n\r\n    this.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n}\r\n","<div class=\"datetime-container\">\r\n  <mat-slide-toggle \r\n    *ngIf=\"this.currentFilter.sliderOptions?.enabled\"\r\n    [(ngModel)]=\"sliderMode\"\r\n    (change)=\"modeChange($event)\">\r\n    {{'igo.geo.filter.sliderModeTitle' | translate}}\r\n  </mat-slide-toggle>\r\n\r\n  <div class=\"slider-container\" *ngIf=\"sliderMode\">\r\n    <igo-ogc-filter-time-slider\r\n      [begin]=\"beginValue\"\r\n      [max]=\"this.restrictedToStep() ? this.maxDate : this.endValue\"\r\n      [currentFilter]=\"currentFilter\" \r\n      [datasource]=\"datasource\"\r\n      (changeProperty)=\"changePropertyByPass($event)\"\r\n    >\r\n    </igo-ogc-filter-time-slider>\r\n    \r\n  </div>\r\n\r\n  <div *ngIf=\"!sliderMode\">\r\n\r\n    <div class=\"year-input-container\" *ngIf=\"calendarTypeYear\">\r\n      <!-- to emulate a year-picker, 2 input: first input to show user just year and second input hiden and bind \r\n        with the datepicker  -->\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.startYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearBegin}}\"\r\n          (change)= \"yearOnlyInputChange($event, beginDatepicker, 'begin')\"\r\n          [disabled]= \"filterStateDisable\"\r\n          >\r\n        <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n  \r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #beginDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"beginValue\"\r\n          (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #beginYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"beginDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [min]=\"handleDate(datasource.options.minDate)\"\r\n          [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.endYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearEnd}}\"\r\n          (change)= \"yearOnlyInputChange($event, endDatepicker, 'end')\"\r\n          [disabled] = \"filterStateDisable\">\r\n        <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #endDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"endValue\"\r\n          (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #endYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"endDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n          [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [max]=\"handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n      <button class=\"reset-button\" \r\n        mat-icon-button\r\n        color=\"primary\" \r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class='toggle-filter-state' \r\n        (change)=\"toggleFilterState()\" \r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [checked]=\"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n\r\n    </div>\r\n\r\n    <div class=\"datetime-input-container\" *ngIf=\"calendarType()!=='year'\">\r\n      <div class=\"datetime-input\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n          <input #begin\r\n            matInput\r\n            [matDatepicker]=\"beginDatepicker\"\r\n            [placeholder]=\"'igo.geo.timeFilter.startDate' | translate\"\r\n            [attr.disabled]=\"!currentFilter.active\"\r\n            (dateChange)=\"changeTemporalProperty(begin.value, 1)\"\r\n            [matDatepickerFilter]=\"filterBeginFunction\"\r\n            [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n            [min]=\"handleDate(datasource.options.minDate)\"\r\n            [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\" \r\n            [disabled]= \"filterStateDisable\">\r\n          <span class=\"filler\"></span>\r\n          <mat-datepicker\r\n            #beginDatepicker\r\n            [startView]=\"calendarView()\"\r\n            [startAt]=\"beginValue\"\r\n            (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n            (monthSelected)=\"monthSelected($event, beginDatepicker, 'begin')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let hour of beginHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let minute of beginMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"datetime-input\" *ngIf=\"!restrictedToStep()\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n            <input #end\r\n              matInput\r\n              [matDatepicker]=\"endDatepicker\"\r\n              [placeholder]=\"'igo.geo.timeFilter.endDate' | translate\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (dateChange)=\"changeTemporalProperty(end.value, 2)\"\r\n              [matDatepickerFilter]=\"filterEndFunction\"\r\n              [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n              [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n              [max]=\"handleDate(datasource.options.maxDate)\" \r\n              [disabled]= \"filterStateDisable\">\r\n            <span class=\"filler\"></span>\r\n            <mat-datepicker #endDatepicker\r\n              [startView]=\"calendarView()\"\r\n              [startAt]=\"endValue\"\r\n              (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n              (monthSelected)=\"monthSelected($event, endDatepicker, 'end')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\" >\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let hour of endHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let minute of endMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <button class=\"reset-button\" \r\n        mat-icon-button color=\"primary\"\r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class=\"toggle-filter-state\" \r\n        (change)=\"toggleFilterState()\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        [checked]= \"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  ElementRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\nimport {\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFilterableDataSource,\r\n  OgcFilterDuringOptions\r\n} from '../shared/ogc-filter.interface';\r\n\r\nimport { default as moment } from 'moment';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time',\r\n  templateUrl: './ogc-filter-time.component.html',\r\n  styleUrls: ['./ogc-filter-time.component.scss']\r\n})\r\nexport class OgcFilterTimeComponent implements OnInit {\r\n  @Input() datasource: OgcFilterableDataSource;\r\n  @Input() currentFilter: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: string;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n\r\n  beginHours: number[];\r\n  endHours: number[];\r\n  beginMinutes: number[];\r\n  endMinutes: number[];\r\n  beginHourFormControl = new UntypedFormControl();\r\n  beginMinuteFormControl = new UntypedFormControl();\r\n  endHourFormControl = new UntypedFormControl();\r\n  endMinuteFormControl = new UntypedFormControl();\r\n  _beginValue: Date;\r\n  _endValue: Date;\r\n  readonly _defaultMin: string = '1900-01-01';\r\n  readonly _defaultMax: string = '2052-01-06';\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderModeEnabled: boolean = true;\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  public sliderMode = false;\r\n\r\n  readonly defaultStepMillisecond = 60000;\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  public onlyYearBegin: number;\r\n  public onlyYearEnd: number;\r\n  public calendarTypeYear = false;\r\n  public resetIcon = 'replay';\r\n  public filterStateDisable: boolean;\r\n\r\n  @ViewChild('endDatepickerTime') endDatepickerTime: ElementRef;\r\n  @ViewChild('beginDatepickerTime') beginDatepickerTime: ElementRef;\r\n  @ViewChild('beginTime') beginTime: HTMLInputElement;\r\n  @ViewChild('endTime') endTime: HTMLInputElement;\r\n\r\n  get step(): string {\r\n    return this.datasource.options.stepDate\r\n      ? this.datasource.options.stepDate\r\n      : this.currentFilter.step;\r\n  }\r\n\r\n  get stepMilliseconds(): number {\r\n    const step = moment.duration(this.step).asMilliseconds();\r\n    return step === 0 ? this.defaultStepMillisecond : step;\r\n  }\r\n\r\n  set beginValue(begin: Date) {\r\n    this._beginValue = begin;\r\n  }\r\n\r\n  get beginValue(): Date {\r\n    return this._beginValue;\r\n  }\r\n\r\n  set endValue(end: Date) {\r\n    this._endValue = end;\r\n  }\r\n\r\n  get endValue(): Date {\r\n    return this._endValue;\r\n  }\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? 2000\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get maxDate(): string {\r\n    return this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    return this.currentFilter.displayFormat ? this.currentFilter.displayFormat : this._defaultDisplayFormat;\r\n  }\r\n\r\n  public filterBeginFunction;\r\n  public filterEndFunction;\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {}\r\n\r\n  ngOnInit(){\r\n    if (this.currentFilter.sliderOptions) {\r\n      this.currentFilter.sliderOptions.enabled = this.currentFilter.sliderOptions.enabled !== undefined ?\r\n        this.currentFilter.sliderOptions.enabled : this._defaultSliderModeEnabled;\r\n    }\r\n    this.beginValue = this.parseFilter(this.handleMin());\r\n    this.endValue = this.parseFilter(this.handleMax());\r\n\r\n    this.onlyYearBegin = this.beginValue.getUTCFullYear();\r\n    this.onlyYearEnd = this.endValue.getUTCFullYear();\r\n    this.calendarTypeYear = this.isCalendarYearMode();\r\n    this.setFilterStateDisable();\r\n    this.updateHoursMinutesArray();\r\n    // update value for now value\r\n    this.updateValues();\r\n    this.dateFilter(this.filterBeginFunction, 'begin');\r\n    this.dateFilter(this.filterEndFunction, 'end');\r\n  }\r\n\r\n  parseFilter(filter): Date {\r\n    if (!filter){\r\n      return new Date();\r\n    } else if ( isNaN( new Date(filter).getTime() ) ) {\r\n      if (filter.search('now') >= 0 ) {\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if (filter.match(/\\+/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('+') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if (filter.match(/\\-/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('-') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return new Date();\r\n      }\r\n      if (filter.search('today') >= 0){\r\n        const _now = moment().endOf('day').toDate();\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if ( filter.match(/\\+/) ) {\r\n          const intervalInt = parseInt( filter.substring(filter.search('+') + 1, interval.index), 10 );\r\n          return moment(_now).add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if ( filter.match(/\\-/) ) {\r\n          const intervalInt = parseInt(filter.substring(filter.search('-') + 1, interval.index), 10);\r\n          return moment(_now).subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return _now;\r\n      }\r\n      return new Date();\r\n    }\r\n    if (this.currentFilter.calendarModeYear) {\r\n      const date = this.getDateFromStringWithoutTime(filter);\r\n      return date;\r\n    } else {\r\n      return filter ? new Date(filter) : new Date();\r\n    }\r\n  }\r\n\r\n  changeTemporalProperty(value, position?, refreshFilter = true) {\r\n    let valueTmp = this.getDateTime(value, position);\r\n    if (this.isCalendarYearMode()) {\r\n      let dateStringFromYearNotime;\r\n      if (position === 1) {\r\n        this.beginValue = value;\r\n        this.onlyYearBegin = this.beginValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearBegin}-01-01`;\r\n      } else {\r\n        this.endValue = value;\r\n        this.onlyYearEnd = this.endValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearEnd}-01-01`;\r\n      }\r\n      // call service with string date without time\r\n      this.changeProperty.next({ value: dateStringFromYearNotime, pos: position, refreshFilter });\r\n      return;\r\n    }\r\n    if (position === 2 && this.calendarType() === 'date' && !this.sliderMode) {\r\n      /* Above month: see yearSelected or monthSelected */\r\n      valueTmp = moment(valueTmp).endOf('day').toDate();\r\n    }\r\n\r\n    if (position === 1) {\r\n      this.beginValue = valueTmp;\r\n      if (this.restrictedToStep()) {\r\n        this.changeTemporalProperty(this.ogcFilterTimeService.addStep(valueTmp, this.stepMilliseconds), 2, refreshFilter);\r\n      }\r\n    } else {\r\n      this.endValue = valueTmp;\r\n    }\r\n    this.updateHoursMinutesArray();\r\n    this.changeProperty.next({ value: valueTmp.toISOString(), pos: position, refreshFilter });\r\n  }\r\n\r\n  handleDate(value): Date {\r\n    if (!value || value === '') {\r\n      return undefined;\r\n    }\r\n    if (typeof(value) === 'string' && this.currentFilter.calendarModeYear) {\r\n      return this.getDateFromStringWithoutTime(value);\r\n    }\r\n    return new Date(value);\r\n  }\r\n\r\n  calendarType() {\r\n    if (this.currentFilter.calendarModeYear) {\r\n      return 'year';\r\n    }\r\n    if (this.stepMilliseconds < 86400000) {\r\n      return 'datetime';\r\n    }\r\n    return 'date';\r\n  }\r\n\r\n  isCalendarYearMode(): boolean {\r\n    if (this.calendarType() === 'year') {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  yearOnlyInputChange(changeEvent, datePicker?: any, property?: string) {\r\n    const year = changeEvent.target.value;\r\n    const date = this.getDateFromStringWithoutTime(year);\r\n    this.yearSelected(date, datePicker, property);\r\n  }\r\n\r\n  yearSelected(year, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        // change value 01 jan to 31 dec same year\r\n        year = moment(year).endOf('year').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep() && !this.calendarTypeYear) {\r\n        this.yearSelected(year, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(year, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  monthSelected(month, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        month = moment(month).endOf('month').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep()) {\r\n        this.monthSelected(month, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(month, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  calendarView() {\r\n    const test = this.stepMilliseconds;\r\n    const diff = Math.abs(\r\n      this.parseFilter(this.currentFilter.end).getTime() -\r\n        this.parseFilter(this.currentFilter.begin).getTime()\r\n    );\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      return 'multi-year';\r\n    } else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      return 'year';\r\n    } else if (test < 86400000 && diff < 86400000) {\r\n      return 'clock';\r\n    } else {\r\n      return 'month';\r\n    }\r\n  }\r\n\r\n  dateFilter(type: string, date: string) {\r\n    const dateValue = new Date(date);\r\n    const diff = dateValue.getTime() - new Date(this.handleMin()).getTime();\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'years', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'years', true);\r\n        this.filterEndFunction = (monthDiffPlus1 % moment.duration(this.step).asYears()) === 0;\r\n        return;\r\n      } else if ( type === 'begin' ) {\r\n        this.filterBeginFunction = (monthDiff % moment.duration(this.step).asYears()) === 0;\r\n        return;\r\n      }\r\n    }\r\n    else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'months', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'months', true);\r\n        this.filterEndFunction = (monthDiffPlus1 % moment.duration(this.step).asMonths()) === 0;\r\n        return;\r\n      } else if ( type === 'begin' ) {\r\n        this.filterBeginFunction = (monthDiff % moment.duration(this.step).asMonths()) === 0;\r\n        return;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsWeekDuration(this.step)) {\r\n      const weekDiff = moment(dateValue).diff(moment(this.handleMin()), 'weeks', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const weekDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'weeks', true);\r\n        this.filterEndFunction = (weekDiffPlus1 % moment.duration(this.step).asWeeks()) === 0;\r\n        return;\r\n      } else if ( type === 'begin' ) {\r\n        this.filterBeginFunction = (weekDiff % moment.duration(this.step).asWeeks()) === 0;\r\n        return;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsDayDuration(this.step)) {\r\n      const dayDiff = moment(dateValue).diff(moment(this.handleMin()), 'days', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const dayDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'days', true);\r\n        const _mod = (dayDiffPlus1 % moment.duration(this.step).asDays());\r\n        this.filterEndFunction = (_mod < 0.0000001 && _mod > -0.0000001) || _mod === 0 ; // 1 millisecond = 1.1574074074074076e-8\r\n        return;\r\n      } else if ( type === 'begin' ) {\r\n        const _mod = ((dayDiff % moment.duration(this.step).asDays()) + 1);\r\n        this.filterBeginFunction = (_mod < 0.0000001 && _mod > -0.0000001 && _mod !== 0) || _mod === 1 ; // 1 millisecond = 1.1574074074074076e-8\r\n        return;\r\n      }\r\n    } else if ( this.ogcFilterTimeService.stepIsHourDuration(this.step) ) {\r\n      if ( type === 'end' ) {\r\n        const hourDiff = moment(dateValue).diff(moment(this.handleMin()), 'hours', true);\r\n        this.filterEndFunction = (hourDiff % moment.duration(this.step).asHours()) === 0;\r\n        return;\r\n      } else if (type === 'begin') {\r\n        const hourDiff = moment(dateValue).diff(moment(this.handleMin()), 'hours', true);\r\n        this.filterBeginFunction = (hourDiff % moment.duration(this.step).asHours()) === 0;\r\n        return;\r\n      }\r\n    } else if ( this.ogcFilterTimeService.stepIsMinuteDuration(this.step) ) {\r\n      if ( type === 'end' ) {\r\n        this.filterEndFunction = true;\r\n        return;\r\n      } else if (type === 'begin') {\r\n        this.filterBeginFunction = true;\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.filterEndFunction = diff % this.stepMilliseconds === 0;\r\n    this.filterBeginFunction = diff % this.stepMilliseconds === 0;\r\n    return;\r\n  }\r\n\r\n  getDateTime(date, pos) {\r\n    const valuetmp = new Date(date);\r\n    let valuetmp2;\r\n    if (!this.sliderMode) {\r\n      switch (pos) {\r\n        case 1: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n            this.beginHourFormControl.value,\r\n            this.beginMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n        case 2: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n              this.endHourFormControl.value,\r\n              this.endMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return new Date(valuetmp2 ? valuetmp2 : valuetmp);\r\n  }\r\n\r\n  handleMinuteIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsMinuteDuration(this.step)) {\r\n      if (this.stepMilliseconds < 3600000) {\r\n        return this.stepMilliseconds / 1000 === 60 ? 1 : this.stepMilliseconds / 1000;\r\n      } else {\r\n        return (this.stepMilliseconds % 3600000) / 60;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  handleHourIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return this.stepMilliseconds / 1000 / 60 / 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  fullBeginHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginHours = Array.from(\r\n        {\r\n          length:\r\n            (this.endHourFormControl.value - 0) / this.handleHourIncrement() + 1\r\n        },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.beginHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.beginHourFormControl.setValue(this.beginValue.getHours());\r\n  }\r\n\r\n  fullEndHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endHours = Array.from(\r\n        {\r\n          length:\r\n            (23 - this.beginHourFormControl.value) /\r\n              this.handleHourIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginHourFormControl.value + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.endHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.endHourFormControl.setValue(this.endValue.getHours());\r\n  }\r\n\r\n  fullBeginMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginMinutes = Array.from(\r\n        {\r\n          length:\r\n            (this.endMinuteFormControl.value - 0) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.beginMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.beginMinuteFormControl.setValue(this.beginValue.getMinutes());\r\n  }\r\n\r\n  fullEndMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endMinutes = Array.from(\r\n        {\r\n          length:\r\n            (59 - this.beginMinuteFormControl.value) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginMinuteFormControl.value + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.endMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.endMinuteFormControl.setValue(this.endValue.getMinutes());\r\n  }\r\n\r\n  updateHoursMinutesArray() {\r\n    const beginTmp = new Date(this.beginValue);\r\n    const endTmp = new Date(this.endValue);\r\n    if (beginTmp.setHours(0, 0) === endTmp.setHours(0, 0)) {\r\n      this.fullBeginHoursArray(true);\r\n      this.fullEndHoursArray(true);\r\n      if (this.beginValue.getHours() === this.endValue.getHours()) {\r\n        this.fullBeginMinutesArray(true);\r\n        this.fullEndMinutesArray(true);\r\n      }\r\n    } else {\r\n      this.fullBeginHoursArray();\r\n      this.fullEndHoursArray();\r\n      this.fullBeginMinutesArray();\r\n      this.fullEndMinutesArray();\r\n    }\r\n  }\r\n\r\n  private updateValues() {\r\n    this.changeTemporalProperty(this.beginValue, 1, false);\r\n    this.changeTemporalProperty(this.endValue, 2, true);\r\n  }\r\n\r\n  public restrictedToStep(): boolean {\r\n    return this.currentFilter.restrictToStep\r\n      ? this.currentFilter.restrictToStep : false;\r\n  }\r\n\r\n  public handleMin() {\r\n    return this.currentFilter.begin ? this.currentFilter.begin :\r\n              (this.datasource.options.minDate ? this.datasource.options.minDate : this._defaultMin);\r\n  }\r\n\r\n  public handleMax() {\r\n    return this.currentFilter.end ? this.currentFilter.end :\r\n              (this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax);\r\n  }\r\n\r\n  changePropertyByPass(event) {\r\n    this.changeProperty.next(event);\r\n  }\r\n\r\n  modeChange(event) {\r\n    if (!event.checked) {\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  setFilterStateDisable() {\r\n    if (this.currentFilter) {\r\n      this.filterStateDisable = !this.currentFilter.active;\r\n    } else {\r\n      this.filterStateDisable = false;\r\n    }\r\n    if(this.calendarType() === 'datetime') {\r\n      if (this.filterStateDisable === true) {\r\n        this.beginHourFormControl.disable();\r\n        this.beginMinuteFormControl.disable();\r\n        this.endHourFormControl.disable();\r\n        this.endMinuteFormControl.disable();\r\n      } else {\r\n        this.beginHourFormControl.enable();\r\n        this.beginMinuteFormControl.enable();\r\n        this.endHourFormControl.enable();\r\n        this.endMinuteFormControl.enable();\r\n      }\r\n    }\r\n  }\r\n  getDateFromStringWithoutTime(stringDate: string): Date {\r\n    // warning create date with no time make a date UTC with TZ and the date create maybe not the same year, month and day\r\n    // exemple:\r\n    // new Date('2022-01-01') -> Fri Dec 31 2021 19:00:00 GMT-0500 (heure normale de l’Est nord-américain)\r\n    // to create same date as string, add time 00 in the creation\r\n    // new Date('2022-01-01 00:00:00') -> Sat Jan 01 2022 00:00:00 GMT-0500 (heure normale de l’Est nord-américain)\r\n    let year;\r\n    let month = '01';\r\n    let day = '01';\r\n    if (stringDate.length === 10) {\r\n       const dateItems = stringDate.split('-');\r\n        if (dateItems.length !== 3) {\r\n          throw new Error('Error in config date begin-end for ogcFilter: Date without time format need to be YYYY-MM-DD or YYYY');\r\n        } else {\r\n          year = dateItems[0];\r\n          month = dateItems[1];\r\n          day = dateItems[2];\r\n        }\r\n    } else if (stringDate.length === 4) {\r\n      year = stringDate;\r\n    } else {\r\n      return new Date(stringDate);\r\n    }\r\n    return new Date(`${year}-${month}-${day} 00:00:00`);\r\n  }\r\n\r\n  resetFilter() {\r\n    let filterOriginConfig = this.datasource.options.ogcFilters.filters as OgcFilterDuringOptions;\r\n\r\n    let minDefaultDate;\r\n    let maxDefaultDate;\r\n    let minDefaultISOString;\r\n    let maxDefaultISOString;\r\n\r\n    if (this.calendarTypeYear) {\r\n      if (filterOriginConfig.end === 'today') {\r\n        let todayDateStringNoTime = new Date().toLocaleDateString('en-CA'); // '2022-02-13'\r\n        maxDefaultISOString = `${todayDateStringNoTime.substring(0,4)}-01-01`;\r\n      } else {\r\n        maxDefaultISOString = `${filterOriginConfig.end.substring(0,4)}-01-01`;\r\n      }\r\n      minDefaultISOString = `${filterOriginConfig.begin.substring(0,4)}-01-01`;\r\n      minDefaultDate = this.getDateFromStringWithoutTime(minDefaultISOString);\r\n      maxDefaultDate = this.getDateFromStringWithoutTime(maxDefaultISOString);\r\n    } else {\r\n      minDefaultDate = this.parseFilter(filterOriginConfig.begin);\r\n      maxDefaultDate = this.parseFilter(filterOriginConfig.end);\r\n      minDefaultISOString = minDefaultDate.toISOString();\r\n      maxDefaultISOString = maxDefaultDate.toISOString();\r\n    }\r\n\r\n    if ((this.currentFilter.begin !== minDefaultISOString ) ||\r\n    (this.currentFilter.end !== maxDefaultISOString)) {\r\n      this.beginValue = minDefaultDate;\r\n      this.endValue = maxDefaultDate;\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  toggleFilterState() {\r\n    if (this.currentFilter.active === true) {\r\n      this.currentFilter.active = false;\r\n    } else {\r\n      this.currentFilter.active = true;\r\n    }\r\n    this.setFilterStateDisable();\r\n    this.updateValues();\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\n\r\nimport { default as moment } from 'moment';\r\nimport { MatSlider } from '@angular/material/slider';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time-slider',\r\n  templateUrl: './ogc-filter-time-slider.component.html',\r\n  styleUrls: ['./ogc-filter-time-slider.component.scss']\r\n})\r\nexport class OgcFilterTimeSliderComponent implements OnInit {\r\n  @Input() currentFilter: any;\r\n  @Input() begin: any;\r\n  @Input() max: any;\r\n  @Input() datasource: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: any;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n  @ViewChild(MatSlider) slider: MatSlider;\r\n\r\n  interval;\r\n  sliderValue: number = 1;\r\n  calculatedStep: number = 0;\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderInterval: number = 2000;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? this._defaultSliderInterval\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    if (this.currentFilter.sliderOptions?.displayFormat){\r\n      return this.currentFilter.sliderOptions.displayFormat;\r\n    }\r\n    if (this.currentFilter.displayFormat) {\r\n      return this.currentFilter.displayFormat;\r\n    }\r\n    return this._defaultDisplayFormat;\r\n  }\r\n\r\n  get beginMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.begin);\r\n  }\r\n\r\n  get maxMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.max);\r\n  }\r\n\r\n  get stepMillisecond(): number {\r\n    return this.ogcFilterTimeService.stepMillisecond(this.datasource, this.currentFilter);\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {\r\n    this.sliderDisplayWith = this.sliderDisplayWith.bind(this);\r\n  }\r\n\r\n  ngOnInit(){\r\n    this.calculateStep();\r\n    this.handleSliderInput({value: 1});\r\n  }\r\n\r\n  sliderDisplayWith(value) {\r\n    let dateTmp = new Date(this.beginMillisecond + ((value - 1) * this.stepMillisecond));\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'year').toDate();\r\n    } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'month').toDate();\r\n    }\r\n\r\n    return moment(dateTmp).format(this.displayFormat);\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n\r\n          if (this.slider.value < this.calculatedStep) {\r\n            const _increment = '_increment';\r\n            const _emitInputEvent = '_emitInputEvent';\r\n            this.slider[_increment](1);\r\n            this.slider[_emitInputEvent]();\r\n          } else {\r\n            this.stopFilter();\r\n          }\r\n        },\r\n        this.sliderInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n    this.slider.value = 1;\r\n    const _increment = '_increment';\r\n    const _emitInputEvent = '_emitInputEvent';\r\n    this.slider[_emitInputEvent]();\r\n  }\r\n\r\n  handleSliderInput(matSliderChange) {\r\n    if (matSliderChange) {\r\n\r\n      if ( this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'year').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'year').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'month').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'month').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).startOf('month').toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsDayDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsHourDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsMinuteDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n            const dateTmp = new Date(this.beginMillisecond + (this.stepMillisecond * (matSliderChange.value - 1)));\r\n            this.changeProperty.next({value: dateTmp.toISOString(), pos: 1, refreshFilter: false});\r\n            this.changeProperty.next({value: new Date(this.ogcFilterTimeService.addStep(dateTmp.toISOString(),\r\n                                        this.stepMillisecond)).toISOString(),\r\n                                        pos: 2, refreshFilter: true});\r\n      }\r\n    }\r\n  }\r\n\r\n  calculateStep(){\r\n    for (let i = 1; (this.maxMillisecond - (this.beginMillisecond + (i * this.stepMillisecond))) >= -1; i++) {\r\n      this.calculatedStep = i;\r\n    }\r\n  }\r\n\r\n}\r\n","<div class=\"slider-container\">\r\n  <mat-slider\r\n    id=\"time-slider\"\r\n    [step]=\"1\"\r\n    [min]=\"1\"\r\n    [max]=\"calculatedStep\"\r\n    [(ngModel)]=\"sliderValue\"\r\n    [displayWith]=\"sliderDisplayWith\"\r\n    (input)=\"handleSliderInput($event)\"\r\n    thumbLabel\r\n    >\r\n  </mat-slider>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n    <mat-icon [svgIcon]=\"playIcon\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n    <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n  </button>\r\n  \r\n</div>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule, MatNativeDateModule, MAT_DATE_LOCALE } from '@angular/material/core';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatTreeModule } from '@angular/material/tree';\r\n\r\nimport {\r\n  MatDatetimepickerModule,\r\n  MatNativeDatetimeModule\r\n} from '@mat-datetimepicker/core';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoEntityModule,\r\n  IgoDOMModule\r\n} from '@igo2/common';\r\nimport { IgoGeometryModule } from './../geometry/geometry.module';\r\n\r\nimport { FilterableDataSourcePipe } from './shared/filterable-datasource.pipe';\r\nimport { IgoLayerModule } from '../layer/layer.module';\r\nimport { TimeFilterButtonComponent } from './time-filter-button/time-filter-button.component';\r\nimport { TimeFilterFormComponent } from './time-filter-form/time-filter-form.component';\r\nimport { TimeFilterItemComponent } from './time-filter-item/time-filter-item.component';\r\nimport { TimeFilterListBindingDirective } from './time-filter-list/time-filter-list-binding.directive';\r\nimport { TimeFilterListComponent } from './time-filter-list/time-filter-list.component';\r\nimport { TimeFilterService } from './shared/time-filter.service';\r\n\r\nimport { OgcFilterFormComponent } from './ogc-filter-form/ogc-filter-form.component';\r\nimport { OgcFilterableFormComponent } from './ogc-filterable-form/ogc-filterable-form.component';\r\nimport { OgcFilterableItemComponent } from './ogc-filterable-item/ogc-filterable-item.component';\r\nimport { OgcFilterableListBindingDirective } from './ogc-filterable-list/ogc-filterable-list-binding.directive';\r\nimport { OgcFilterableListComponent } from './ogc-filterable-list/ogc-filterable-list.component';\r\nimport { OgcFilterButtonComponent } from './ogc-filter-button/ogc-filter-button.component';\r\nimport { OGCFilterService } from './shared/ogc-filter.service';\r\nimport { OGCFilterTimeService } from './shared/ogc-filter-time.service';\r\nimport { OgcFilterSelectionComponent } from './ogc-filter-selection/ogc-filter-selection.component';\r\n\r\nimport { SpatialFilterTypeComponent } from './spatial-filter/spatial-filter-type/spatial-filter-type.component';\r\nimport { SpatialFilterListComponent } from './spatial-filter/spatial-filter-list/spatial-filter-list.component';\r\nimport { SpatialFilterItemComponent } from './spatial-filter/spatial-filter-item/spatial-filter-item.component';\r\nimport { SpatialFilterService } from './shared/spatial-filter.service';\r\nimport { OgcFilterTimeComponent } from './ogc-filter-time/ogc-filter-time.component';\r\nimport { OgcFilterTimeSliderComponent } from './ogc-filter-time/ogc-filter-time-slider.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatAutocompleteModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTabsModule,\r\n    MatRadioModule,\r\n    MatMenuModule,\r\n    MatTableModule,\r\n    MatTreeModule,\r\n    MatButtonToggleModule,\r\n    MatCheckboxModule,\r\n    MatSliderModule,\r\n    MatSlideToggleModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatDatetimepickerModule,\r\n    MatNativeDatetimeModule,\r\n    IgoLanguageModule,\r\n    IgoLayerModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoEntityModule,\r\n    IgoDOMModule,\r\n    IgoKeyValueModule,\r\n    IgoGeometryModule,\r\n    MatBadgeModule\r\n  ],\r\n  exports: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  declarations: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  providers: [TimeFilterService, OGCFilterService, OGCFilterTimeService, SpatialFilterService]\r\n})\r\nexport class IgoFilterModule {\r\n  static forRoot(): ModuleWithProviders<IgoFilterModule> {\r\n    return {\r\n      ngModule: IgoFilterModule,\r\n      providers: [\r\n        {\r\n          provide: MAT_DATE_LOCALE,\r\n          useValue: 'fr-FR'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const ExportFormat = strEnum(['URL', 'GeoJSON', 'GML', 'GPX', 'KML', 'Shapefile', 'CSVcomma', 'CSVsemicolon']);\r\nexport type ExportFormat = keyof typeof ExportFormat;\r\n\r\nexport const EncodingFormat = strEnum(['UTF8', 'LATIN1']);\r\nexport type EncodingFormat = keyof typeof EncodingFormat;\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport {encode} from 'windows-1252';\r\n\r\nimport { ExportFormat, EncodingFormat } from './export.type';\r\n\r\nimport {\r\n  ExportInvalidFileError,\r\n  ExportNothingToExportError\r\n} from './export.errors';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ExportService {\r\n  static ogreFormats = {\r\n    GML: 'gml',\r\n    GPX: 'gpx',\r\n    KML: 'kml',\r\n    Shapefile: 'ESRI Shapefile',\r\n    CSVcomma: 'CSVcomma',\r\n    CSVsemicolon: 'CSVsemicolon'\r\n  };\r\n\r\n  static noOgreFallbacks = ['GML', 'GPX', 'KML'];\r\n\r\n  private ogreUrl: string;\r\n  private aggregateInComment: boolean = true;\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const gpxAggregateInComment = this.config.getConfig(\r\n      'importExport.gpxAggregateInComment'\r\n    );\r\n    if (gpxAggregateInComment !== undefined) {\r\n      this.aggregateInComment = gpxAggregateInComment;\r\n    }\r\n  }\r\n\r\n  export(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<void> {\r\n    const exportOlFeatures = this.generateFeature(olFeatures, format);\r\n\r\n    return this.exportAsync(exportOlFeatures, format, title, encoding, projectionIn, projectionOut);\r\n  }\r\n\r\n  public generateFeature(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    excludePrefix: string = '_'\r\n  ): OlFeature<OlGeometry>[] {\r\n    if (format === ExportFormat.GPX && this.aggregateInComment) {\r\n      return this.generateAggregatedFeature(olFeatures);\r\n    }\r\n\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature\r\n        .getKeys()\r\n        .filter((key: string) => !key.startsWith(excludePrefix));\r\n      const properties = keys.reduce(\r\n        (acc: object, key: string) => {\r\n          acc[key] = olFeature.get(key);\r\n          return acc;\r\n        },\r\n        { geometry: olFeature.getGeometry() }\r\n      );\r\n      return new OlFeature(properties);\r\n    });\r\n  }\r\n\r\n  private generateAggregatedFeature(olFeatures: OlFeature<OlGeometry>[]): OlFeature<OlGeometry>[] {\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature.getKeys().filter((key: string) => !key.startsWith('_'));\r\n      let comment: string = '';\r\n      const properties = keys.reduce((acc: object, key: string) => {\r\n        if (key && key !== 'geometry') {\r\n          key === 'id' && olFeature.get('draw') ? comment += key + ':' + olFeature.get('draw') + '   \\r\\n'\r\n          : comment += key + ':' + olFeature.get(key) + '   \\r\\n';\r\n        }\r\n        acc[key] = olFeature.get(key);\r\n        return acc;\r\n      },\r\n      {\r\n        geometry: olFeature.getGeometry()\r\n      });\r\n      const newFeature = new OlFeature(properties);\r\n      newFeature.set('name', olFeature.getId());\r\n      newFeature.set('cmt', comment);\r\n\r\n      return newFeature;\r\n    });\r\n  }\r\n\r\n  private exportAsync(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<void> {\r\n    const doExport = (observer: Observer<void>) => {\r\n      const nothingToExport = this.nothingToExport(olFeatures, format);\r\n      if (nothingToExport) {\r\n        observer.error(new ExportNothingToExportError());\r\n        return;\r\n      }\r\n\r\n      const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n      if (ogreFormats.indexOf(format) >= 0) {\r\n        if (!this.ogreUrl) {\r\n          if (ExportService.noOgreFallbacks.indexOf(format) >= 0) {\r\n            this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n          } else {\r\n            observer.error(new ExportInvalidFileError());\r\n          }\r\n          return;\r\n        }\r\n        this.exportWithOgre(olFeatures, observer, format, title, encoding, projectionIn, projectionOut);\r\n      } else {\r\n        this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n      }\r\n    };\r\n\r\n    return new Observable(doExport);\r\n  }\r\n\r\n  protected exportToFile(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const olFormat = new olformat[format]();\r\n    const featuresText = olFormat.writeFeatures(olFeatures, {\r\n      dataProjection: projectionOut,\r\n      featureProjection: projectionIn,\r\n      featureType: 'feature',\r\n      featureNS: 'http://example.com/feature'\r\n    });\r\n\r\n    const fileName = `${title}.${format.toLowerCase()}`;\r\n\r\n    downloadContent(featuresText, 'text/plain;charset=utf-8', fileName);\r\n    observer.complete();\r\n  }\r\n\r\n  private exportWithOgre(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: string,\r\n    title: string,\r\n    encodingType: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    let featuresText: string = new olformat.GeoJSON().writeFeatures(\r\n      olFeatures,\r\n      {\r\n        dataProjection: projectionOut,\r\n        featureProjection: projectionIn\r\n      }\r\n    );\r\n\r\n    const url = `${this.ogreUrl}/convertJson`;\r\n    const form = document.createElement('form');\r\n    form.style.display = 'none';\r\n    document.body.appendChild(form);\r\n    form.setAttribute('method', 'post');\r\n    form.setAttribute('target', '_blank');\r\n    form.setAttribute('action', url);\r\n\r\n    if (encodingType === EncodingFormat.UTF8) {\r\n      form.acceptCharset = 'UTF-8';\r\n      form.enctype = 'application/x-www-form-urlencoded; charset=utf-8;';\r\n    } else if (encodingType === EncodingFormat.LATIN1) {\r\n      const enctype = 'ISO-8859-1';\r\n      const featuresJson = JSON.parse(featuresText);\r\n      featuresJson.features.map(f => {\r\n        const encodedProperties = String.fromCharCode\r\n          .apply(null, encode(JSON.stringify(f.properties), { mode: 'replacement' }));\r\n        f.properties = JSON.parse(encodedProperties);\r\n      });\r\n      featuresText = JSON.stringify(featuresJson);\r\n      const encoding = document.createElement('input');\r\n      encoding.setAttribute('type', 'hidden');\r\n      encoding.setAttribute('name', 'encoding');\r\n      encoding.setAttribute('value', enctype);\r\n      form.appendChild(encoding);\r\n    }\r\n\r\n    if (format === 'CSVsemicolon') {\r\n      const options = document.createElement('input');\r\n      options.setAttribute('type', 'hidden');\r\n      options.setAttribute('name', 'lco');\r\n      options.setAttribute('value', 'SEPARATOR=SEMICOLON');\r\n      form.appendChild(options);\r\n    }\r\n\r\n    const geojsonField = document.createElement('input');\r\n    geojsonField.setAttribute('type', 'hidden');\r\n    geojsonField.setAttribute('name', 'json');\r\n    geojsonField.setAttribute('value', featuresText);\r\n    form.appendChild(geojsonField);\r\n\r\n    const outputNameField = document.createElement('input');\r\n    let outputName = format === 'Shapefile' ? `${title}.zip` : `${title}.${format.toLowerCase()}`;\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      outputName = `${title}.csv`;\r\n    }\r\n    outputName = outputName.replace(' ', '_');\r\n    outputName = outputName.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/’/g, \"'\");\r\n    outputNameField.setAttribute('type', 'hidden');\r\n    outputNameField.setAttribute('name', 'outputName');\r\n    outputNameField.setAttribute('value', outputName);\r\n    form.appendChild(outputNameField);\r\n\r\n    let ogreFormat = ExportService.ogreFormats[format];\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      ogreFormat = 'CSV';\r\n    }\r\n    const outputFormatField = document.createElement('input');\r\n    outputFormatField.setAttribute('type', 'hidden');\r\n    outputFormatField.setAttribute('name', 'format');\r\n    outputFormatField.setAttribute('value', ogreFormat);\r\n    form.appendChild(outputFormatField);\r\n\r\n    form.submit();\r\n    document.body.removeChild(form);\r\n\r\n    observer.complete();\r\n  }\r\n\r\n  private nothingToExport(olFeatures: OlFeature<OlGeometry>[], format: string): boolean {\r\n    if (olFeatures.length === 0) {\r\n      return true;\r\n    }\r\n    if (format === 'GPX') {\r\n      const pointOrLine = olFeatures.find(olFeature => {\r\n        return (\r\n          ['Point', 'LineString', 'MultiLineString'].indexOf(olFeature.getGeometry().getType()) >= 0\r\n        );\r\n      });\r\n      return pointOrLine === undefined;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadContent(content: string, mimeType: string, fileName: string) {\r\n  const uri = `data:${mimeType},${encodeURIComponent(content)}`;\r\n  downloadFromUri(uri, fileName);\r\n}\r\n\r\n/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadFromUri(uri: string, fileName: string) {\r\n  const element = document.createElement('a');\r\n  element.setAttribute('href', uri);\r\n  element.setAttribute('download', fileName);\r\n  element.style.display = 'none';\r\n  document.body.appendChild(element);\r\n\r\n  element.click();\r\n\r\n  document.body.removeChild(element);\r\n}\r\n","import { MessageService } from '@igo2/core';\r\n\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureDataSourceOptions } from '../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  featureToOl,\r\n  moveToOlFeatures,\r\n  computeOlFeaturesExtent\r\n} from '../../feature/shared/feature.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { StyleService } from '../../style/style-service/style.service';\r\nimport { StyleByAttribute } from '../../style/shared/vector/vector-style.interface';\r\nimport { StyleListService } from '../../style/style-list/style-list.service';\r\nimport { ClusterParam } from '../../layer/shared/clusterParam';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { ClusterDataSourceOptions } from '../../datasource/shared/datasources/cluster-datasource.interface';\r\nimport { uuid } from '@igo2/utils';\r\nimport { featureRandomStyle, featureRandomStyleFunction } from '../../style/shared/feature/feature-style';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { ConfirmDialogService } from '@igo2/common';\r\nimport { first, of } from 'rxjs';\r\n\r\nexport function addLayerAndFeaturesToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  contextUri: string,\r\n  layerTitle: string,\r\n  layerService: LayerService,\r\n  storeToIdb: boolean = false\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n\r\n  const id = uuid();\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    id,\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  let randomStyle;\r\n  let editable: boolean = false;\r\n  if (\r\n    olFeatures[0].getKeys().includes('_style') ||\r\n    olFeatures[0].getKeys().includes('_mapTitle')) {\r\n    randomStyle = featureRandomStyleFunction();\r\n  } else {\r\n    randomStyle = featureRandomStyle();\r\n    editable = true;\r\n  }\r\n  const layer = layerService.createLayer({\r\n    id,\r\n    title: layerTitle,\r\n    workspace: { enabled: true, searchIndexEnabled: true },\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    igoStyle: { editable },\r\n    idbInfo: { firstLoad: true, storeToIdb, contextUri: contextUri || '*' },\r\n    style: randomStyle\r\n  }) as VectorLayer;\r\n  layer.setExtent(computeOlFeaturesExtent(map, olFeatures));\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addLayerAndFeaturesStyledToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService,\r\n  layerId?: string,\r\n  imposedSourceOptions?,\r\n  imposedLayerOptions?,\r\n  zoomTo: boolean = true\r\n\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute, resolution);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style'), feature, resolution\r\n    );\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      'default.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList('default.distance');\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList('default.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList('default.style'), feature, resolution\r\n    );\r\n  }\r\n\r\n  let source;\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else if (styleListService.getStyleList(layerTitle.toString())) {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.addFeatures(olFeatures);\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer(\r\n    Object.assign({\r\n      title: layerTitle,\r\n      id: layerId || uuid(),\r\n      isIgoInternalLayer: true,\r\n      source,\r\n      style\r\n    }, imposedLayerOptions));\r\n  map.addLayer(layer);\r\n  if (zoomTo){\r\n    moveToOlFeatures(map, olFeatures);\r\n  }\r\n  return layer;\r\n}\r\n\r\nfunction padTo2Digits(num) {\r\n  return num.toString().padStart(2, '0');\r\n}\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  contextUri: string,\r\n  messageService: MessageService,\r\n  layerService: LayerService,\r\n  confirmDialogService?: ConfirmDialogService,\r\n  styleListService?: StyleListService,\r\n  styleService?: StyleService\r\n) {\r\n  if (features.length === 0) {\r\n    handleNothingToImportError(file, messageService);\r\n    return;\r\n  }\r\n\r\n  let layerTitle = computeLayerTitleFromFile(file);\r\n\r\n  const obs$ = confirmDialogService ? confirmDialogService.open('igo.geo.import.promptStoreToIdb') : of(false);\r\n\r\n  obs$.pipe(first()).subscribe((confirm) => {\r\n    const d = new Date();\r\n    const dformat =\r\n    [d.getFullYear(),\r\n      padTo2Digits(d.getMonth() + 1),\r\n      padTo2Digits(d.getDate()), ].join('/') +\r\n    ' ' +\r\n    [padTo2Digits(d.getHours()),padTo2Digits(d.getMinutes())].join(':');\r\n\r\n\r\n    layerTitle = confirm ? `${layerTitle} (${dformat})` : layerTitle;\r\n    if (!styleListService) {\r\n      addLayerAndFeaturesToMap(features, map, contextUri, layerTitle, layerService, confirm);\r\n    } else {\r\n      addLayerAndFeaturesStyledToMap(\r\n        features,\r\n        map,\r\n        layerTitle,\r\n        styleListService,\r\n        styleService\r\n      );\r\n    }\r\n\r\n    messageService.success(\r\n      'igo.geo.dropGeoFile.success.text',\r\n      'igo.geo.dropGeoFile.success.title',\r\n      undefined,\r\n      { value: layerTitle });\r\n  });\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError,\r\n    'Invalid SRS definition': handleSRSImportError,\r\n    'Error 500 with OGRE': handleOgreServerImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService\r\n) {\r\n  messageService.error(\r\n    'igo.geo.dropGeoFile.invalid.text',\r\n    'igo.geo.dropGeoFile.invalid.title',\r\n    undefined,\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    });\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService\r\n) {\r\n  messageService.error('igo.geo.dropGeoFile.unreadable.text',\r\n    'igo.geo.dropGeoFile.unreadable.title',\r\n    undefined,\r\n    { value: file.name });\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  sizeMb: number\r\n) {\r\n  messageService.error(\r\n    'igo.geo.dropGeoFile.tooLarge.text',\r\n    'igo.geo.dropGeoFile.tooLarge.title',\r\n    undefined,\r\n    {\r\n      value: file.name,\r\n      size: sizeMb\r\n    });\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n) {\r\n  messageService.error(\r\n    'igo.geo.dropGeoFile.empty.text',\r\n    'igo.geo.dropGeoFile.empty.title',\r\n    undefined,\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    });\r\n}\r\n\r\nexport function handleSRSImportError(\r\n  file: File,\r\n  messageService: MessageService\r\n) {\r\n  messageService.error(\r\n    'igo.geo.dropGeoFile.invalidSRS.text',\r\n    'igo.geo.dropGeoFile.invalidSRS.title',\r\n    undefined,\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    });\r\n}\r\n\r\nexport function handleOgreServerImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService\r\n) {\r\n  messageService.error('igo.geo.dropGeoFile.ogreServer.text', 'igo.geo.dropGeoFile.ogreServer.title');\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name\r\n    .split('.')\r\n    .pop()\r\n    .toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportOgreServerError extends ImportError {\r\n  constructor() {\r\n      super('Error 500 with OGRE');\r\n      Object.setPrototypeOf(this, ImportOgreServerError.prototype);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  ImportInvalidFileError,\r\n  ImportUnreadableFileError,\r\n  ImportSizeError,\r\n  ImportSRSError,\r\n  ImportOgreServerError\r\n} from './import.errors';\r\nimport { computeLayerTitleFromFile, getFileExtension } from './import.utils';\r\nimport { ImportExportServiceOptions } from './import.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportService {\r\n\r\n  static formatExtensionAssociation = {\r\n    GeoJSON: 'geojson',\r\n    GML: 'gml',\r\n    GPX: 'gpx',\r\n    KML: 'kml',\r\n    Shapefile: 'zip'\r\n  };\r\n\r\n  static allowedMimeTypes = [\r\n    'application/gml+xml',\r\n    'application/vnd.google-earth.kml+xml',\r\n    'application/gpx+xml',\r\n    'application/json'\r\n  ];\r\n\r\n  static allowedZipMimeTypes = [\r\n    'application/zip',\r\n    'application/x-zip-compressed',\r\n    'application/x-zip'\r\n  ];\r\n\r\n  static allowedExtensions = ['geojson', 'kml', 'gpx', 'json', 'gml', 'zip'];\r\n\r\n  private ogreUrl: string;\r\n  private clientSideFileSizeMax: number;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    const importConfig = this.config.getConfig('importExport') as ImportExportServiceOptions;\r\n    this.ogreUrl = importConfig.url;\r\n    const configFileSizeMb = importConfig.clientSideFileSizeMaxMb;\r\n    this.clientSideFileSizeMax = (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n    if (importConfig.formats) {\r\n      ImportService.allowedExtensions = importConfig.formats\r\n        .map(format => ImportService.formatExtensionAssociation[format])\r\n        .filter(e => e);\r\n      if (ImportService.allowedExtensions.includes('geojson')) {\r\n        ImportService.allowedExtensions.push('json');\r\n      }\r\n    }\r\n  }\r\n\r\n  import(\r\n    file: File,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<Feature[]> {\r\n    return this.importAsync(file, projectionIn, projectionOut);\r\n  }\r\n\r\n  private getFileImporter(\r\n    file: File\r\n  ): (\r\n      file: File,\r\n      observer: Observer<Feature[]>,\r\n      projectionIn: string,\r\n      projectionOut: string\r\n    ) => void {\r\n    const extension = getFileExtension(file);\r\n    const allowedExtensions = ImportService.allowedExtensions;\r\n    let zipMimeTypes = [];\r\n    if (allowedExtensions.includes('zip')) {\r\n      zipMimeTypes = ImportService.allowedZipMimeTypes;\r\n    }\r\n    const mimeType = file.type;\r\n    const allowedMimeTypes = [\r\n      ...ImportService.allowedMimeTypes,\r\n      ...zipMimeTypes\r\n    ];\r\n\r\n    if (\r\n      allowedMimeTypes.indexOf(mimeType) < 0 &&\r\n      allowedExtensions.indexOf(extension) < 0\r\n    ) {\r\n      return undefined;\r\n    } else if (\r\n      mimeType === 'application/json' ||\r\n      ['json', 'geojson', 'kml', 'gpx'].indexOf(extension) >= 0\r\n    ) {\r\n      return this.importFile;\r\n    } else if (this.ogreUrl !== undefined) {\r\n      return this.importFileWithOgre;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private importAsync(\r\n    file: File,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<Feature[]> {\r\n    const doImport = (observer: Observer<Feature[]>) => {\r\n      if (file.size >= this.clientSideFileSizeMax) {\r\n        observer.error(new ImportSizeError());\r\n        return;\r\n      }\r\n      const importer = this.getFileImporter(file);\r\n      if (importer === undefined) {\r\n        observer.error(new ImportInvalidFileError());\r\n        return;\r\n      }\r\n\r\n      importer.call(this, file, observer, projectionIn, projectionOut);\r\n    };\r\n\r\n    return new Observable(doImport);\r\n  }\r\n\r\n  private importFile(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const reader = new FileReader();\r\n\r\n    reader.onload = (event: any) => {\r\n      try {\r\n        const features = this.parseFeaturesFromFile(\r\n          file,\r\n          event.target.result,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n        observer.next(features);\r\n      } catch (e) {\r\n        observer.error(new ImportUnreadableFileError());\r\n      }\r\n\r\n      observer.complete();\r\n    };\r\n\r\n    reader.onerror = evt => {\r\n      observer.error(new ImportUnreadableFileError());\r\n    };\r\n\r\n    reader.readAsText(file, 'UTF-8');\r\n  }\r\n\r\n  private importFileWithOgre(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const url = `${this.ogreUrl}/convert`;\r\n    const formData = new FormData();\r\n    formData.append('upload', file);\r\n    formData.append('sourceSrs', projectionIn);\r\n    formData.append('targetSrs', projectionOut);\r\n    formData.append('formatOutput', 'GEOJSON');\r\n    formData.append('skipFailures', '');\r\n\r\n    this.http.post(url, formData, { headers: new HttpHeaders() })\r\n      .subscribe(\r\n        (response: { errors?: string[] } | object | null) => {\r\n          if (response === null) {\r\n            observer.error(new ImportUnreadableFileError());\r\n            return;\r\n          }\r\n\r\n          const errors = (response as any).errors || [];\r\n          if (errors.length > 0) {\r\n            observer.error(new ImportUnreadableFileError());\r\n          } else {\r\n            const features = this.parseFeaturesFromGeoJSON(\r\n              file,\r\n              response,\r\n              projectionOut\r\n            );\r\n            observer.next(features);\r\n            observer.complete();\r\n          }\r\n        },\r\n        (error: any) => {\r\n          error.error.caught = true;\r\n          const errMsg = error.error.msg || '';\r\n          if (errMsg === 'No valid files found') {\r\n            observer.error(new ImportInvalidFileError());\r\n          } else if (errMsg && errMsg.startWith('ERROR 1: Failed to process SRS definition')\r\n          ) {\r\n            observer.error(new ImportSRSError());\r\n          } else if (error.status === 500) {\r\n            observer.error(new ImportOgreServerError());\r\n          } else {\r\n            observer.error(new ImportUnreadableFileError());\r\n          }\r\n        }\r\n      );\r\n  }\r\n\r\n  private parseFeaturesFromFile(\r\n    file: File,\r\n    data: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n\r\n    const GeoJSON = new olformat.GeoJSON();\r\n\r\n    let format;\r\n    if (mimeType === 'application/vnd.google-earth.kml+xml') {\r\n      format = new olformat.KML();\r\n    } else if (mimeType === 'application/gml+xml') {\r\n      format = new olformat.GML();\r\n    } else if (mimeType === 'application/gpx+xml') {\r\n      format = new olformat.GPX();\r\n    } else {\r\n      switch (extension) {\r\n        case 'kml':\r\n          format = new olformat.KML();\r\n          break;\r\n        case 'gpx':\r\n          format = new olformat.GPX();\r\n          break;\r\n        case 'gml':\r\n          format = new olformat.GML();\r\n          break;\r\n        default:\r\n          format = GeoJSON;\r\n          break;\r\n      }\r\n    }\r\n\r\n    const olFeatures = format.readFeatures(data, {\r\n      dataProjection: projectionIn,\r\n      featureProjection: projectionOut\r\n    });\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(GeoJSON.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features;\r\n  }\r\n\r\n  private parseFeaturesFromGeoJSON(\r\n    file: File,\r\n    data: object,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const olFormat = new olformat.GeoJSON();\r\n    const olFeatures = olFormat.readFeatures(data);\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(olFormat.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features as Feature[];\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleListService {\r\n  private styleList: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in styleList file\r\n   */\r\n  public getStyleList(key: string): any {\r\n    return ObjectUtils.resolve(this.styleList, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all styleList's variables\r\n   */\r\n  public load(options: StyleListOptions) {\r\n    const baseStyleList = options.default || {};\r\n    if (!options.path) {\r\n      this.styleList = baseStyleList;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`StyleList file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((styleListResponse: object) => {\r\n          this.styleList = ObjectUtils.mergeDeep(baseStyleList, styleListResponse);\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","<div class=\"import-export-toggle mat-typography\">\r\n  <mat-button-toggle-group\r\n        [value]=\"selectedMode\"\r\n        (change)=\"onImportExportChange($event)\">\r\n        <mat-button-toggle [value]=\"'import'\">\r\n          {{'igo.geo.importExportForm.importTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"'export'\">\r\n          {{'igo.geo.importExportForm.exportTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n  </mat-button-toggle-group>\r\n</div>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"importForm\" *ngIf=\"selectedMode === 'import'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.importProjPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"inputProj\">\r\n        <mat-option\r\n          *ngFor=\"let projection of (projections$ | async)\"\r\n          [value]=\"projection\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line *ngIf=\"projection.translateKey\">{{('igo.geo.importExportForm.projections.' + projection.translateKey) | translate: projection}}</p>\r\n          <p mat-line *ngIf=\"!projection.translateKey\">{{projection.alias}}</p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"importForm.invalid ? ('igo.geo.importExportForm.projections.choose' | translate) : ('igo.geo.importExportForm.importButton' | translate)\"\r\n    class=\"igo-form-button-group\">\r\n    <button\r\n      [disabled]=\"importForm.invalid || (loading$ | async)\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"fileInput.click()\">\r\n        {{'igo.geo.importExportForm.importButton' | translate}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n    <input\r\n      hidden\r\n      #fileInput\r\n      type=\"file\"\r\n      [style.display]=\"'none'\"\r\n      (click)=\"fileInput.value = null\"\r\n      (change)=\"importFiles($event.target.files)\">\r\n  </div>\r\n</form>\r\n<section class=\"mat-typography\" *ngIf=\"selectedMode === 'import'\">\r\n  <div *ngIf=\"importHtmlClarifications === ''\">\r\n    <h4>{{'igo.geo.importExportForm.importClarifications' | translate}}</h4>\r\n    <ul>\r\n      <li>{{'igo.geo.importExportForm.importSizeMax' | translate: {size: fileSizeMb} }}</li>\r\n      <li>{{'igo.geo.importExportForm.importFormatAuthorized' | translate}}</li>\r\n      <li>{{'igo.geo.importExportForm.importShpZip' | translate}}</li>\r\n    </ul>\r\n  </div>\r\n  <igo-custom-html *ngIf=\"importHtmlClarifications !== ''\" class=\"mat-typography\"\r\n    [html]=\"importHtmlClarifications\">\r\n  </igo-custom-html>\r\n</section>\r\n\r\n<section class=\"mat-typography\" *ngIf=\"(exportableLayers$ | async).length === 0 && selectedMode === 'export'\">\r\n  <h4>{{'igo.geo.importExportForm.exportNoLayersExportable' | translate}}</h4>\r\n</section>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"form\" *ngIf=\"(exportableLayers$ | async).length > 0 && selectedMode === 'export'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportLayerPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"layers\" multiple>\r\n        <mat-select-trigger>\r\n          {{layers.length ? getLayerTitleById(layers[0]) : ''}}\r\n          <span *ngIf=\"layers.length > 1\" class=\"export-select-trigger\">\r\n            (+{{layers.length - 1}} {{(layers?.length === 2 ? 'igo.geo.importExportForm.other' : 'igo.geo.importExportForm.others') | translate }})\r\n          </span>\r\n        </mat-select-trigger>\r\n        <mat-option\r\n          *ngFor=\"let layer of (exportableLayers$ | async)\"\r\n          [ngClass]=\"{'igo-export-layer-mat-option': layerHasSelectedFeatures(layer)}\"\r\n          [value]=\"layer.id\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line>{{layer.title}}</p>\r\n          <p mat-line>\r\n            <mat-slide-toggle *ngIf=\"layerHasSelectedFeatures(layer)\"\r\n              [labelPosition]=\"'after'\"\r\n              (click)=\"onlySelectedClick($event,layer.id)\"\r\n              (checked)=\"inLayersIdToExportSelectionOnly(layer)\"\r\n              (change)=\"onlySelected($event,layer.id)\">\r\n              <small>{{'igo.geo.importExportForm.exportSelectedFeature' | translate}}</small>\r\n            </mat-slide-toggle>\r\n          </p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportFormatPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"format\">\r\n        <ng-container *ngIf=\"(formats$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let format of (formats$ | async) | keyvalue\" [value]=\"format.key\">\r\n            {{'igo.geo.export.format.' + format.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n        <mat-option *ngIf=\"(formats$ | async).length === 0\" disabled=\"true\">\r\n          {{'igo.geo.export.noFormat.title' | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"forceNaming && form.value.format !== 'URL'\">\r\n    <mat-form-field>\r\n        <input matInput formControlName=\"name\" placeholder=\"{{'igo.geo.importExportForm.exportFileNamePlaceholder' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon'\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.encodingPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"encoding\">\r\n        <ng-container *ngIf=\"(encodings$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let encoding of (encodings$ | async) | keyvalue\" [value]=\"encoding.key\">\r\n            {{'igo.geo.export.encoding.' + encoding.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"export-combine-layers mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon')\">\r\n    <mat-slide-toggle\r\n        formControlName=\"combineLayers\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportCombineResults' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-separator mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon') && form.value.combineLayers\">\r\n    <mat-slide-toggle\r\n        formControlName=\"separator\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportSeparator' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-options mat-typography\" *ngIf=\"form.value.format !== 'URL'\">\r\n    <mat-slide-toggle\r\n        formControlName=\"featureInMapExtent\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportFeatureInExtent' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (loading$ | async)\"\r\n      (click)=\"handleExportFormSubmit(form.value)\">\r\n      {{form.value.format !== 'URL'  ? ('igo.geo.importExportForm.exportButton' | translate): (form.value.layers.length > 1  ? ('igo.geo.importExportForm.exportButtonLinks' | translate): ('igo.geo.importExportForm.exportButtonLink' | translate))}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n  </div>\r\n\r\n  <igo-custom-html *ngIf=\"exportHtmlClarifications !== ''\" class=\"mat-typography\"\r\n    [html]=\"exportHtmlClarifications\">\r\n  </igo-custom-html>\r\n\r\n</form>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { UntypedFormGroup, UntypedFormBuilder, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  MessageService,\r\n  LanguageService,\r\n  ConfigService,\r\n  StorageService\r\n} from '@igo2/core';\r\nimport { strEnum } from '@igo2/utils';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\nimport olPoint from 'ol/geom/Point';\r\nimport { circular } from 'ol/geom/Polygon';\r\n\r\nimport {\r\n  handleFileExportError,\r\n  handleFileExportSuccess\r\n} from '../shared/export.utils';\r\nimport { ExportOptions } from '../shared/export.interface';\r\nimport { ExportFormat, EncodingFormat } from '../shared/export.type';\r\nimport { ExportService } from '../shared/export.service';\r\nimport { ImportService } from '../shared/import.service';\r\nimport {\r\n  handleFileImportSuccess,\r\n  handleFileImportError\r\n} from '../shared/import.utils';\r\nimport { StyleService } from '../../style/style-service/style.service';\r\nimport { StyleListService } from '../../style/style-list/style-list.service';\r\nimport { skipWhile } from 'rxjs/operators';\r\nimport { ConfirmDialogService, EntityRecord, Workspace } from '@igo2/common';\r\nimport type { WorkspaceStore } from '@igo2/common';\r\nimport { WfsWorkspace } from '../../workspace/shared/wfs-workspace';\r\nimport { EditionWorkspace } from '../../workspace/shared/edition-workspace';\r\nimport { FeatureWorkspace } from '../../workspace/shared/feature-workspace';\r\nimport { MatSlideToggleChange } from '@angular/material/slide-toggle';\r\nimport { InputProjections, ProjectionsLimitationsOptions } from '../../map/';\r\nimport { DownloadService } from '../../download/shared/download.service';\r\nimport { computeProjectionsConstraints } from '../../map';\r\n\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { ImportExportServiceOptions } from '../shared/import.interface';\r\n\r\n@Component({\r\n  selector: 'igo-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class ImportExportComponent implements OnDestroy, OnInit {\r\n  public form: UntypedFormGroup;\r\n  public importForm: UntypedFormGroup;\r\n  public formats$ = new BehaviorSubject(undefined);\r\n  public encodings$ = new BehaviorSubject(undefined);\r\n  public exportableLayers$: BehaviorSubject<AnyLayer[]> = new BehaviorSubject(\r\n    []\r\n  );\r\n  public loading$ = new BehaviorSubject(false);\r\n  public forceNaming = false;\r\n  public controlFormat = 'format';\r\n\r\n  private layers$$: Subscription;\r\n  private exportableLayers$$: Subscription;\r\n  private formats$$: Subscription;\r\n  private encodings$$: Subscription;\r\n  private formLayer$$: Subscription;\r\n  private exportOptions$$: Subscription;\r\n\r\n  public importHtmlClarifications: string;\r\n  public exportHtmlClarifications: string;\r\n\r\n  private espgCodeRegex = new RegExp('^\\\\d{4,6}');\r\n  private clientSideFileSizeMax: number;\r\n  public fileSizeMb: number;\r\n\r\n  public projections$: BehaviorSubject<InputProjections[]> = new BehaviorSubject([]);\r\n  private projectionsConstraints: ProjectionsLimitationsOptions;\r\n\r\n  public popupChecked: boolean = false;\r\n\r\n  private previousLayerSpecs$: BehaviorSubject<\r\n    {\r\n      id: string;\r\n      visible: boolean;\r\n      opacity: number;\r\n      queryable: boolean;\r\n    }[]\r\n  > = new BehaviorSubject(undefined);\r\n\r\n  @Input() selectFirstProj: boolean = false;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() contextUri: string;\r\n\r\n  private _projectionsLimitations: ProjectionsLimitationsOptions = {};\r\n  @Input()\r\n  set projectionsLimitations(value: ProjectionsLimitationsOptions) {\r\n    this._projectionsLimitations = value;\r\n    this.computeProjections();\r\n  }\r\n  get projectionsLimitations(): ProjectionsLimitationsOptions {\r\n    return this._projectionsLimitations || {};\r\n  }\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  @Input() selectedMode = 'import';\r\n\r\n  @Output() selectMode = new EventEmitter<string>();\r\n\r\n  @Input() exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  @Output() exportOptionsChange = new EventEmitter<ExportOptions>();\r\n\r\n  get layers() {\r\n    return this.form.get('layers').value;\r\n  }\r\n  set layers(value) {\r\n    this.form.patchValue({ layers: value });\r\n  }\r\n\r\n  get inputProj() {\r\n    return this.importForm.get('inputProj').value;\r\n  }\r\n  set inputProj(value) {\r\n    this.importForm.patchValue({ inputProj: value });\r\n  }\r\n\r\n  get popupAllowed(): boolean {\r\n    return this.storageService.get('importExportPopupAllowed') as boolean || false;\r\n  }\r\n\r\n  set popupAllowed(value: boolean) {\r\n    this.storageService.set('importExportPopupAllowed', value);\r\n  }\r\n\r\n  constructor(\r\n    private importService: ImportService,\r\n    private exportService: ExportService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private config: ConfigService,\r\n    private cdRef: ChangeDetectorRef,\r\n    private storageService: StorageService,\r\n    private downloadService: DownloadService,\r\n    private layerService: LayerService,\r\n    private confirmDialogService: ConfirmDialogService\r\n  ) {\r\n    this.loadConfig();\r\n    this.buildForm();\r\n    this.computeProjections();\r\n    this.importHtmlClarifications = this.languageService.translate.instant('igo.geo.importExportForm.importHtmlClarifications');\r\n    this.exportHtmlClarifications = this.languageService.translate.instant('igo.geo.importExportForm.exportHtmlClarifications');\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      this.exportableLayers$.next(\r\n        layers.filter((layer: Layer) => {\r\n          return (\r\n            (layer instanceof VectorLayer && layer.exportable === true) ||\r\n            (layer.dataSource.options.download &&\r\n              layer.dataSource.options.download.url)\r\n          );\r\n        }) as AnyLayer[]\r\n      );\r\n    });\r\n    const configFileSizeMb = this.config.getConfig(\r\n      'importExport.clientSideFileSizeMaxMb'\r\n    );\r\n    this.clientSideFileSizeMax =\r\n      (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n    this.fileSizeMb = this.clientSideFileSizeMax / Math.pow(1024, 2);\r\n\r\n    this.exportOptions$$ = this.exportOptions$\r\n      .pipe(skipWhile((exportOptions) => !exportOptions))\r\n      .subscribe((exportOptions) => {\r\n        this.form.patchValue(exportOptions, { emitEvent: true });\r\n        if (exportOptions.layers) {\r\n          this.computeFormats(\r\n            exportOptions.layers.map((l) => this.map.getLayerById(l))\r\n          );\r\n        }\r\n      });\r\n    this.formLayer$$ = this.form\r\n      .get('format')\r\n      .valueChanges\r\n      .subscribe((format) => {\r\n        const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n        if (\r\n          !this.popupChecked &&\r\n          this.form.get('layers').value?.length > 1 &&\r\n          (ogreFormats.indexOf(format) >= 0 || format === ExportFormat.URL)) {\r\n          if (!this.handlePopup(true)) {\r\n            this.form.patchValue({ format: undefined }, { emitEvent: false });\r\n          }\r\n        }\r\n      });\r\n\r\n    this.formLayer$$ = this.form\r\n      .get('layers')\r\n      .valueChanges.subscribe((layersId) => {\r\n        this.handlePreviousLayerSpecs();\r\n        const selectedLayers = layersId instanceof Array ? layersId : [layersId];\r\n        this.form.patchValue({ layers: selectedLayers }, { emitEvent: false });\r\n        const layers = selectedLayers.map((l) => this.map.getLayerById(l));\r\n        this.computeFormats(layers);\r\n\r\n        if (\r\n          Object.keys(this.formats$.value).indexOf(this.form.value.format) ===\r\n          -1\r\n        ) {\r\n          this.form.patchValue({ format: undefined });\r\n        }\r\n\r\n        this.loading$.next(true);\r\n        const previousSpecs: {\r\n          id: string;\r\n          visible: boolean;\r\n          opacity: number;\r\n          queryable: boolean;\r\n        }[] = [];\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer instanceof VectorLayer &&\r\n            layer.dataSource.ol.getFeatures().length === 0\r\n          ) {\r\n            previousSpecs.push({\r\n              id: layer.id,\r\n              visible: layer.visible,\r\n              opacity: layer.opacity,\r\n              queryable: (layer as any).queryable\r\n            });\r\n            layer.opacity = 0;\r\n            layer.visible = true;\r\n          }\r\n        });\r\n\r\n        this.previousLayerSpecs$.next(previousSpecs);\r\n        setTimeout(() => {\r\n          this.loading$.next(false);\r\n        }, 500);\r\n      });\r\n\r\n    this.formats$$ = this.formats$\r\n      .pipe(skipWhile((formats) => !formats))\r\n      .subscribe((formats) => {\r\n        if (Object.keys(formats).length === 1) {\r\n          this.form.patchValue({ format: formats[Object.keys(formats)[0]] });\r\n        }\r\n      });\r\n\r\n    this.encodings$$ = this.encodings$\r\n      .pipe(skipWhile((encodings) => !encodings))\r\n      .subscribe((encodings) => {\r\n        if (Object.keys(encodings).length === 1) {\r\n          this.form.patchValue({ encoding: encodings[Object.keys(encodings)[0]] });\r\n        }\r\n      });\r\n\r\n    this.exportableLayers$$ = this.exportableLayers$\r\n      .pipe(skipWhile((layers) => !layers))\r\n      .subscribe((layers) => {\r\n        if (layers.length === 1) {\r\n          this.form.patchValue({ layers: layers[0].id });\r\n        }\r\n      });\r\n\r\n    this.form.controls[this.controlFormat].valueChanges.subscribe((format) => {\r\n      if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n        this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      } else {\r\n        this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      }\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    if (this.selectFirstProj) {\r\n      if (this.projections$.value.length === 0) {\r\n        this.importForm.patchValue({ inputProj: { translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4326', zone: '' } });\r\n      } else {\r\n        this.importForm.patchValue({ inputProj: this.projections$.value[0] });\r\n      }\r\n    } else {\r\n      this.importForm.patchValue({ inputProj: undefined });\r\n    }\r\n  }\r\n\r\n  private computeProjections() {\r\n    this.projectionsConstraints = computeProjectionsConstraints(this.projectionsLimitations);\r\n    const projections: InputProjections[] = [];\r\n\r\n    if (this.projectionsConstraints.nad83) {\r\n      projections.push({ translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4269', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.wgs84) {\r\n      projections.push({ translateKey: 'wgs84', alias: 'WGS84', code: 'EPSG:4326', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.webMercator) {\r\n      projections.push({ translateKey: 'webMercator', alias: 'Web Mercator', code: 'EPSG:3857', zone: '' });\r\n    }\r\n\r\n    if (this.projectionsConstraints.mtm) {\r\n      // all mtm zones\r\n      const minZone = this.projectionsConstraints.mtmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.mtmZone.maxZone;\r\n\r\n      for (let mtmZone = minZone; mtmZone <= maxZone; mtmZone++) {\r\n        const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n        projections.push({ translateKey: 'mtm', alias: `MTM ${mtmZone}`, code, zone: `${mtmZone}` });\r\n      }\r\n    }\r\n\r\n    if (this.projectionsConstraints.utm) {\r\n      // all utm zones\r\n      const minZone = this.projectionsConstraints.utmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.utmZone.maxZone;\r\n\r\n      for (let utmZone = minZone; utmZone <= maxZone; utmZone++) {\r\n        const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n        projections.push({ translateKey: 'utm', alias: `UTM ${utmZone}`, code, zone: `${utmZone}` });\r\n      }\r\n    }\r\n\r\n    let configProjection = [];\r\n    if (this.projectionsConstraints.projFromConfig) {\r\n      configProjection = this.config.getConfig('projections') || [];\r\n    }\r\n\r\n    this.projections$.next(configProjection.concat(projections));\r\n  }\r\n\r\n  private getWorkspaceByLayerId(id: string): Workspace {\r\n    const wksFromLayerId = this.store\r\n      .all()\r\n      .find(workspace => (workspace as WfsWorkspace | FeatureWorkspace | EditionWorkspace).layer.id === id);\r\n    if (wksFromLayerId) {\r\n      return wksFromLayerId;\r\n    }\r\n    return;\r\n  }\r\n\r\n  public getLayerTitleById(id): string {\r\n    return this.map.getLayerById(id)?.title;\r\n  }\r\n\r\n\r\n  layerHasSelectedFeatures(layer: Layer): boolean {\r\n    const wksFromLayer = this.getWorkspaceByLayerId(layer.id);\r\n    if (wksFromLayer) {\r\n      const recs = wksFromLayer.entityStore.stateView\r\n        .firstBy((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        });\r\n      return recs ? true : false;\r\n    }\r\n  }\r\n\r\n  public onlySelected(event: MatSlideToggleChange, id: string) {\r\n    let layersWithSelection = this.form.value.layersWithSelection;\r\n    if (event.checked) {\r\n      layersWithSelection.push(id);\r\n    } else {\r\n      layersWithSelection = layersWithSelection.filter(layerId => layerId !== id);\r\n    }\r\n    this.form.patchValue({ layersWithSelection });\r\n  }\r\n\r\n  public onlySelectedClick(event, id: string) {\r\n    if (this.form.value.layers.find(layerId => layerId === id)) {\r\n      event.stopPropagation();\r\n    }\r\n  }\r\n\r\n  public inLayersIdToExportSelectionOnly(layer: Layer): boolean {\r\n    return this.form.value.layersWithSelection.find(layerId => layerId === layer.id) ? true : false;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.exportableLayers$$.unsubscribe();\r\n    this.formats$$.unsubscribe();\r\n    this.encodings$$.unsubscribe();\r\n    this.formLayer$$.unsubscribe();\r\n    if (this.exportOptions$$) {\r\n      this.exportOptions$$.unsubscribe();\r\n    }\r\n    this.exportOptionsChange.emit(this.form.value);\r\n    this.handlePreviousLayerSpecs();\r\n  }\r\n\r\n  private handlePreviousLayerSpecs() {\r\n    const previousSpecs = this.previousLayerSpecs$.value;\r\n    if (previousSpecs && previousSpecs.length) {\r\n      previousSpecs.forEach((specs) => {\r\n        const previousLayer = this.map.getLayerById(specs.id);\r\n        previousLayer.visible = specs.visible;\r\n        previousLayer.opacity = specs.opacity;\r\n        (previousLayer as any).queryable = specs.queryable;\r\n      });\r\n    }\r\n    this.previousLayerSpecs$.next(undefined);\r\n  }\r\n\r\n  importFiles(files: File[]) {\r\n    let inputProj = this.inputProj.code;\r\n    if (this.espgCodeRegex.test(inputProj)) {\r\n      inputProj = `EPSG:${inputProj}`;\r\n    }\r\n\r\n    this.loading$.next(true);\r\n    for (const file of files) {\r\n      this.importService.import(file, inputProj).subscribe(\r\n        (features: Feature[]) => this.onFileImportSuccess(file, features),\r\n        (error: Error) => this.onFileImportError(file, error),\r\n        () => {\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  handlePopup(preCheck: boolean = true): boolean {\r\n    const p1 = window.open('', 'popup', 'width=1, height=1');\r\n    p1.close();\r\n    const p2 = window.open('', 'popup', 'width=1, height=1');\r\n    if (!p2 || p2.closed || typeof p2.closed === 'undefined' || p2 === null) {\r\n      this.onPopupBlockedError(preCheck);\r\n      this.popupAllowed = false;\r\n    } else {\r\n      p2.close();\r\n      this.popupAllowed = true;\r\n      this.popupChecked = true;\r\n    }\r\n    return this.popupAllowed;\r\n  }\r\n\r\n  handleExportFormSubmit(data: ExportOptions) {\r\n    this.loading$.next(true);\r\n\r\n    const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n    if (!this.popupChecked && data.layers.length > 1 &&\r\n      (ogreFormats.indexOf(data.format) >= 0 || data.format === ExportFormat.URL) && !this.popupAllowed) {\r\n      this.handlePopup();\r\n    }\r\n\r\n    let geomTypesCSV: { geometryType: string, features: any[] }[] = [];\r\n    let featuresCSV: any[] = [];\r\n    let filename: string = \"\";\r\n\r\n    for (const [layerIndex, layer] of data.layers.entries()) {\r\n      const lay = this.map.getLayerById(layer);\r\n      if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma)\r\n      || !data.combineLayers || data.layers.length === 1) {\r\n        filename = lay.title;\r\n        if (data.name) {\r\n          filename = data.name;\r\n        }\r\n      } else {\r\n        filename = this.languageService.translate.instant('igo.geo.export.combinedLayers');\r\n      }\r\n      const dSOptions: DataSourceOptions = lay.dataSource.options;\r\n      if (data.format === ExportFormat.URL && dSOptions.download && (dSOptions.download.url || dSOptions.download.dynamicUrl)) {\r\n        setTimeout(() => {\r\n          // better look an feel\r\n          const url = dSOptions.download.url || dSOptions.download.dynamicUrl;\r\n          url.match(/service=wfs/gi) ? this.downloadService.open(lay) : window.open(url , '_blank');\r\n          this.loading$.next(false);\r\n        }, 500);\r\n        return;\r\n      }\r\n      const wks = this.getWorkspaceByLayerId(layer);\r\n      let olFeatures;\r\n      if (wks && wks.entityStore && wks.entityStore.stateView.all().length) {\r\n\r\n        if (data.layersWithSelection.indexOf(layer) !== -1 && data.featureInMapExtent) {\r\n          // Only export selected feature && into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent && e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.layersWithSelection.indexOf(layer) !== -1 && !data.featureInMapExtent) {\r\n          // Only export selected feature &&  (into map extent OR not)\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.featureInMapExtent) {\r\n          // Only into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent).map(e => (e.entity as Feature).ol);\r\n        } else {\r\n          // All features\r\n          olFeatures = wks.entityStore.stateView.all().map(e => (e.entity as Feature).ol);\r\n        }\r\n      }\r\n      else {\r\n        const ol = lay.dataSource.ol as olVectorSource<OlGeometry> | olClusterSource ;\r\n        if (data.featureInMapExtent) {\r\n          olFeatures = ol.getFeaturesInExtent(\r\n            lay.map.viewController.getExtent()\r\n          );\r\n        } else {\r\n          olFeatures = ol.getFeatures();\r\n        }\r\n        if (lay.dataSource instanceof ClusterDataSource) {\r\n          olFeatures = olFeatures.flatMap((cluster: any) =>\r\n            cluster.get('features')\r\n          );\r\n        }\r\n      }\r\n\r\n\r\n      let geomTypes: { geometryType: string, features: any[] }[] = [];\r\n      if (data.format === ExportFormat.Shapefile || data.format === ExportFormat.GPX) {\r\n        olFeatures.forEach((olFeature) => {\r\n          const featureGeomType = olFeature.getGeometry().getType();\r\n          const currentGeomType = geomTypes.find(geomType => geomType.geometryType === featureGeomType);\r\n          if (currentGeomType) {\r\n            currentGeomType.features.push(olFeature);\r\n          } else {\r\n            geomTypes.push({ geometryType: featureGeomType, features: [olFeature] });\r\n          }\r\n        });\r\n      } else {\r\n        geomTypes = [{ geometryType: '', features: olFeatures }];\r\n      }\r\n\r\n      geomTypes.forEach(geomType => {\r\n        geomType.features.forEach(feature => {\r\n          const radius: number = feature.get('rad');\r\n          if (radius) {\r\n            const center4326: Array<number> = [feature.get('longitude'), feature.get('latitude')];\r\n            const circle = circular(center4326, radius, 500);\r\n            circle.transform('EPSG:4326', feature.get('_projection'));\r\n            feature.setGeometry(circle);\r\n          }\r\n        });\r\n      });\r\n\r\n      if (data.format === ExportFormat.GPX) {\r\n        const gpxFeatureCnt = geomTypes.length;\r\n        geomTypes = geomTypes.filter(geomType => ['LineString', 'Point'].includes(geomType.geometryType));\r\n        const gpxFeatureCntPointOrPoly = geomTypes.length;\r\n        if (gpxFeatureCnt > gpxFeatureCntPointOrPoly) {\r\n          this.messageService.error('igo.geo.export.gpx.error.poly.text', 'igo.geo.export.gpx.error.poly.title', { timeOut: 20000 });\r\n        }\r\n      } else if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n        geomTypes.forEach(geomType => geomTypesCSV.push(geomType));\r\n\r\n        if (layerIndex !== data.layers.length - 1) {\r\n          continue;\r\n        } else {\r\n          let previousFeature = undefined;\r\n          geomTypesCSV.forEach(geomType => {\r\n            geomType.features.forEach(currentFeature => {\r\n              if (data.separator) {\r\n                if (previousFeature) {\r\n                  if (currentFeature.get('_featureStore').layer.options.title !==\r\n                  previousFeature.get('_featureStore').layer.options.title) {\r\n                    const titleEmptyRows = this.createTitleEmptyRows(previousFeature, currentFeature);\r\n                    featuresCSV.push(titleEmptyRows[2]);\r\n                    featuresCSV.push(titleEmptyRows[0]);\r\n                    featuresCSV.push(titleEmptyRows[1]);\r\n                  }\r\n                } else {\r\n                  const titleEmptyRows = this.createTitleEmptyRows(currentFeature, currentFeature);\r\n                  featuresCSV.push(titleEmptyRows[0]);\r\n                }\r\n              }\r\n              featuresCSV.push(currentFeature);\r\n              previousFeature = currentFeature;\r\n            });\r\n          });\r\n        }\r\n      }\r\n\r\n      if (geomTypes.length === 0) {\r\n        this.loading$.next(false);\r\n        this.messageService.error('igo.geo.export.nothing.text', 'igo.geo.export.nothing.title', { timeOut: 20000 });\r\n\r\n      } else {\r\n        if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) || !data.combineLayers) {\r\n          geomTypes.map(geomType =>\r\n            this.exportService.export(geomType.features, data.format, filename + geomType.geometryType, data.encoding, this.map.projection)\r\n            .subscribe(\r\n              () => {},\r\n              (error: Error) => this.onFileExportError(error),\r\n              () => {\r\n                this.onFileExportSuccess();\r\n\r\n                geomType.features.forEach(feature => {\r\n                  this.circleToPoint(feature);\r\n                });\r\n\r\n                this.loading$.next(false);\r\n            }\r\n          ));\r\n        }\r\n      }\r\n    };\r\n    if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n      this.exportService.export(featuresCSV, data.format, filename, data.encoding, this.map.projection)\r\n      .subscribe(\r\n        () => {},\r\n        (error: Error) => this.onFileExportError(error),\r\n        () => {\r\n          this.onFileExportSuccess();\r\n\r\n          featuresCSV.forEach(feature => {\r\n            this.circleToPoint(feature);\r\n          });\r\n\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private createTitleEmptyRows(previousFeature, currentFeature) {\r\n    const titleRow = currentFeature.clone();\r\n    const headerRow = currentFeature.clone();\r\n    const emptyRow = currentFeature.clone();\r\n    const previousFeatureKeys: Array<string> = previousFeature.getKeys();\r\n    let firstKeyPrevious: string = '';\r\n    for (const key in previousFeatureKeys) {\r\n      if (previousFeatureKeys[key] !== 'geometry') {\r\n        firstKeyPrevious = previousFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n\r\n    const currentFeatureKeys: Array<string> = currentFeature.getKeys();\r\n    let firstKeyCurrent: string = '';\r\n    for (const key in currentFeatureKeys) {\r\n      if (currentFeatureKeys[key] !== 'geometry') {\r\n        firstKeyCurrent = currentFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    const allKeys: Array<string> = currentFeature.getKeys();\r\n    previousFeatureKeys.forEach(previousKey => {\r\n      if (allKeys.includes(previousKey) && previousKey !== firstKeyPrevious) {\r\n        allKeys.push(previousKey);\r\n      }\r\n    });\r\n    allKeys.unshift(firstKeyPrevious);\r\n\r\n    let firstKeyAll: string = '';\r\n    for (const key in allKeys) {\r\n      if (allKeys[key] !== 'geometry') {\r\n        firstKeyAll = allKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    allKeys.forEach(key => {\r\n      const sameKeys: boolean = previousFeatureKeys.length === currentFeatureKeys.length &&\r\n      previousFeatureKeys.every((value, index) => value === currentFeatureKeys[index]);\r\n      if (key === firstKeyAll && !sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title + \" ===============>\", true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyAll && sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyCurrent) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key !== 'geometry') {\r\n        titleRow.unset(key, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else {\r\n        titleRow.unset(key, true);\r\n        emptyRow.unset(key, true);\r\n      }\r\n\r\n      if (!(currentFeatureKeys.includes(key))) {\r\n        headerRow.unset(key, true);\r\n      }\r\n    });\r\n    const titleEmptyRows = [titleRow, headerRow, emptyRow];\r\n    return titleEmptyRows;\r\n  }\r\n\r\n  private circleToPoint(feature) {\r\n    const radius: number = feature.get('rad');\r\n\r\n    if (radius) {\r\n      const point = new olPoint([feature.get('longitude'), feature.get('latitude')]);\r\n      point.transform('EPSG:4326', feature.get('_projection'));\r\n      feature.setGeometry(point);\r\n    }\r\n  }\r\n\r\n  private buildForm() {\r\n    this.importForm = this.formBuilder.group({\r\n      inputProj: ['', [Validators.required]]\r\n    });\r\n\r\n    if (this.forceNaming) {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n        name: ['', [Validators.required]]\r\n      });\r\n    } else {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n      });\r\n    }\r\n  }\r\n\r\n  private onFileImportSuccess(file: File, features: Feature[]) {\r\n    const importExportOptions = this.config.getConfig('importExport') as ImportExportServiceOptions;\r\n    const confirmDialogService = importExportOptions?.allowToStoreLayer ? this.confirmDialogService : undefined;\r\n    const importWithStyle =importExportOptions?.importWithStyle || this.config.getConfig('importWithStyle');\r\n    if (this.config.getConfig('importWithStyle')) {\r\n      console.warn(`\r\n      The location of this config importWithStyle is deprecated.\r\n      Please move this property within importExport configuration.\r\n      Ex: importWithStyle: true/false must be transfered to importExport: { importWithStyle: true/false }\r\n      Refer to environnement.ts OR config/config.json\r\n      This legacy conversion will be deleted in 2024.\r\n      `);\r\n    }\r\n    if (!importWithStyle) {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.contextUri,\r\n        this.messageService,\r\n        this.layerService,\r\n        confirmDialogService\r\n      );\r\n    } else {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.contextUri,\r\n        this.messageService,\r\n        this.layerService,\r\n        confirmDialogService,\r\n        this.styleListService,\r\n        this.styleService\r\n      );\r\n    }\r\n  }\r\n\r\n  private onFileImportError(file: File, error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileImportError(\r\n      file,\r\n      error,\r\n      this.messageService,\r\n      this.fileSizeMb\r\n    );\r\n  }\r\n\r\n  private onPopupBlockedError(preCheck: boolean = true) {\r\n    this.loading$.next(false);\r\n    const extraMessage = preCheck ? 'igo.geo.export.popupBlocked.selectAgain' : 'igo.geo.export.popupBlocked.retry';\r\n    this.messageService.error(\r\n      'igo.geo.export.popupBlocked.text',\r\n      'igo.geo.export.popupBlocked.title',\r\n      { timeOut: 20000 },\r\n      {extraMessage});\r\n  }\r\n\r\n  private onFileExportError(error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileExportError(error, this.messageService);\r\n  }\r\n\r\n  private loadConfig() {\r\n    if (this.config.getConfig('importExport.forceNaming') !== undefined) {\r\n      this.forceNaming = this.config.getConfig('importExport.forceNaming');\r\n    }\r\n    this.computeFormats();\r\n    this.loadEncodings();\r\n  }\r\n\r\n  public encodingDefaultValue(format: ExportFormat) {\r\n    if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n      this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      return EncodingFormat.LATIN1;\r\n    } else {\r\n      this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      return EncodingFormat.UTF8;\r\n    }\r\n  }\r\n\r\n  private loadEncodings() {\r\n    this.encodings$.next(EncodingFormat);\r\n  }\r\n\r\n  private computeFormats(layers?: AnyLayer[]) {\r\n    let appliedformats: string[] = Object.keys(ExportFormat);\r\n    const formatsType = {\r\n      onlyUrl: false,\r\n      onlyVector: false,\r\n      vectorAndUrl: false,\r\n      customList: false\r\n    };\r\n    const customList = [];\r\n    if (layers && layers.length) {\r\n      layers.forEach((layer) => {\r\n        if (!layer) {\r\n          return;\r\n        }\r\n        if (layer.dataSource.options.download?.allowedFormats) {\r\n          formatsType.customList = true;\r\n          customList.push({layer: layer.title, formats: this.validateListFormat(layer.dataSource.options.download.allowedFormats)});\r\n        } else if (\r\n          !(layer instanceof VectorLayer) &&\r\n          layer.dataSource.options.download &&\r\n          layer.dataSource.options.download.url\r\n        ) {\r\n          formatsType.onlyUrl = true;\r\n        } else if (\r\n          layer.dataSource.options.download &&\r\n          (layer.dataSource.options.download.url || layer.dataSource.options.download.dynamicUrl)\r\n        ) {\r\n          formatsType.vectorAndUrl = true;\r\n        } else if (layer instanceof VectorLayer) {\r\n          formatsType.onlyVector = true;\r\n        }\r\n      });\r\n\r\n      if (formatsType.onlyUrl === true && formatsType.onlyVector === false) {\r\n        appliedformats = ['URL'];\r\n      } else if (\r\n        formatsType.onlyVector === true &&\r\n        formatsType.onlyUrl === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (ExportFormat.URL in this.formats$.value) {\r\n          const keys = Object.keys(this.formats$.value).filter(\r\n            (key) => key !== 'URL'\r\n          );\r\n          appliedformats = keys;\r\n        }\r\n      } else if (\r\n        formatsType.vectorAndUrl === true &&\r\n        formatsType.onlyUrl === false &&\r\n        formatsType.onlyVector === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (!(ExportFormat.URL in this.formats$.value)) {\r\n          const keys = Object.keys(this.formats$.value);\r\n          keys.push('URL');\r\n          appliedformats = keys;\r\n        }\r\n      }\r\n    }\r\n    const configImportExportFormats = this.config.getConfig('importExport.formats');\r\n    if (configImportExportFormats) {\r\n      const validatedListFormat = this.validateListFormat(configImportExportFormats);\r\n      appliedformats = appliedformats.filter(af => validatedListFormat.includes(af));\r\n    }\r\n    if (formatsType.customList) {\r\n      let commonFormats;\r\n      const layersWithCustomFormats = [];\r\n      let previousCustomListFormats = customList[0].formats;\r\n      customList.map(list => {\r\n        layersWithCustomFormats.push(list.layer);\r\n        commonFormats = list.formats.filter(value => previousCustomListFormats.includes(value));\r\n        previousCustomListFormats = list.formats;\r\n      });\r\n      const finalFormats = commonFormats.filter(value => appliedformats.includes(value));\r\n      if (finalFormats.length > 0) {\r\n        this.formats$.next(strEnum(finalFormats));\r\n\r\n        if (layers && layers.length) {\r\n          if (layers.length > 1) {\r\n            this.messageService.alert(\r\n              'igo.geo.export.customList.text',\r\n              'igo.geo.export.customList.title',\r\n              undefined,\r\n              { value: layersWithCustomFormats.join() }\r\n            );\r\n          }\r\n        }\r\n      } else {\r\n        this.formats$.next([]);\r\n        this.messageService.alert('igo.geo.export.noFormat.text','igo.geo.export.noFormat.title');\r\n      }\r\n      return;\r\n    } else {\r\n      this.formats$.next(strEnum(appliedformats));\r\n    }\r\n  }\r\n\r\n  private validateListFormat(formats: string[]): string[] {\r\n    return formats\r\n      .filter((format) => {\r\n        if (\r\n          format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GPX.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.KML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.Shapefile.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.URL.toUpperCase()\r\n        ) {\r\n          return format;\r\n        }\r\n      })\r\n      .map((format) => {\r\n        if (format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase()) {\r\n          format = ExportFormat.CSVcomma;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase()) {\r\n          format = ExportFormat.CSVsemicolon;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GML.toUpperCase()) {\r\n          format = ExportFormat.GML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GPX.toUpperCase()) {\r\n          format = ExportFormat.GPX;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase()) {\r\n          format = ExportFormat.GeoJSON;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.KML.toUpperCase()) {\r\n          format = ExportFormat.KML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.Shapefile.toUpperCase()) {\r\n          format = ExportFormat.Shapefile;\r\n          return format;\r\n        }\r\n\r\n        if (format.toUpperCase() === ExportFormat.URL.toUpperCase()) {\r\n          format = ExportFormat.URL;\r\n          return format;\r\n        }\r\n      });\r\n  }\r\n\r\n  public modeChanged(mode) {\r\n    this.selectMode.emit(mode);\r\n  }\r\n\r\n  private onFileExportSuccess() {\r\n    handleFileExportSuccess(this.messageService);\r\n  }\r\n\r\n  onImportExportChange(event) {\r\n    this.selectedMode = event.value;\r\n  }\r\n}\r\n","import { ProjectionsLimitationsOptions } from './projection.interfaces';\r\n\r\n/**\r\n * Return a number of zone MTM for a longitude for province of Quebec only\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneMtm(lon: number): number {\r\n    let lonMin = -54;\r\n    const lonMax = -81;\r\n    if (lon < lonMax || lon > lonMin) {\r\n      return 0;\r\n    }\r\n    else {\r\n      const deltaLon = 3;\r\n      let zone = 2;\r\n      while (Math.abs(lon - lonMin) > deltaLon) {\r\n        lonMin = lonMin - deltaLon;\r\n        zone++;\r\n      }\r\n      return zone;\r\n    }\r\n  }\r\n/**\r\n * Return a number of zone UTM for a longitude\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneUtm(lon: number): number {\r\n  let lonMin = -180;\r\n  const lonMax = 180;\r\n  const deltaLon = 6;\r\n  let zone = 1;\r\n  while (Math.abs(lon - lonMin) > deltaLon) {\r\n    lonMin = lonMin + deltaLon;\r\n    zone++;\r\n  }\r\n  return zone;\r\n}\r\n\r\n/**\r\n * Compute the contraints of projections\r\n * @param projectionsLimitations: ProjectionsLimitationsOptions\r\n * @returns projectionsContraints: ProjectionsLimitationsOptions\r\n */\r\nexport function computeProjectionsConstraints(\r\n    projectionsLimitations: ProjectionsLimitationsOptions):\r\n    ProjectionsLimitationsOptions {\r\n    const mtmZone = projectionsLimitations.mtmZone;\r\n    const utmZone = projectionsLimitations.utmZone;\r\n    const projectionsConstraints = {\r\n        projFromConfig: projectionsLimitations.projFromConfig === false ? false : true,\r\n        nad83: projectionsLimitations.nad83 === false ? false : true,\r\n        wgs84: projectionsLimitations.wgs84 === false ? false : true,\r\n        webMercator: projectionsLimitations.webMercator === false ? false : true,\r\n        utm: projectionsLimitations.utm === false ? false : true,\r\n        mtm: projectionsLimitations.mtm === false ? false : true,\r\n        utmZone: {\r\n        minZone: utmZone && utmZone.minZone ? utmZone.minZone : 17,\r\n        maxZone: utmZone && utmZone.maxZone ? utmZone.maxZone : 21,\r\n        },\r\n        mtmZone: {\r\n        minZone: mtmZone && mtmZone.minZone ? mtmZone.minZone : 2,\r\n        maxZone: mtmZone && mtmZone.maxZone ? mtmZone.maxZone : 10,\r\n        }\r\n    };\r\n    return projectionsConstraints;\r\n  }\r\n","import {\r\n  getEntityProperty,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\nimport { MessageService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { ExportNothingToExportError } from './export.errors';\r\n\r\nexport function handleFileExportError(\r\n  error: Error,\r\n  messageService: MessageService\r\n) {\r\n  if (error instanceof ExportNothingToExportError) {\r\n    handleNothingToExportError(messageService);\r\n    return;\r\n  }\r\n  messageService.error('igo.geo.export.failed.text', 'igo.geo.export.failed.title');\r\n}\r\n\r\nexport function handleFileExportSuccess(\r\n  messageService: MessageService\r\n) {\r\n  messageService.success('igo.geo.export.success.text', 'igo.geo.export.success.title');\r\n}\r\n\r\nexport function handleNothingToExportError(\r\n  messageService: MessageService\r\n) {\r\n  messageService.error('igo.geo.export.nothing.text', 'igo.geo.export.nothing.title');\r\n}\r\n\r\n/**\r\n * Export array to CSV\r\n *\r\n * @param rows Array of arrays to export as CSV\r\n * @param separator Cell separator\r\n */\r\nexport function exportToCSV(rows: any[][], fileName: string, separator: string = ';') {\r\n  const lines = rows.map((row: any[][], index: number) => row.join(separator));\r\n  const csvContent = lines.join('\\n');\r\n  downloadContent(csvContent, 'text/csv;charset=utf-8', fileName);\r\n}\r\n\r\n/**\r\n * Return an array of values from an array of entities.\r\n *\r\n * @param entities Array of entities\r\n * @param scolumns Columns definition of the output data\r\n */\r\nexport function entitiesToRowData(entities: object[], columns: EntityTableColumn[]) {\r\n  return entities.map((entity: object) => {\r\n    return columns.map((column: EntityTableColumn) => {\r\n      let valueAccessor;\r\n      if (column.renderer === undefined || column.renderer === EntityTableColumnRenderer.Default) {\r\n        valueAccessor = column.valueAccessor;\r\n      }\r\n      valueAccessor = valueAccessor ? valueAccessor : getEntityProperty;\r\n      return valueAccessor(entity, column.name);\r\n    });\r\n  });\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoDrapDropModule, IgoSpinnerModule, IgoCustomHtmlModule } from '@igo2/common';\r\n\r\nimport { ExportButtonComponent } from './export-button/export-button.component';\r\nimport { ImportExportComponent } from './import-export/import-export.component';\r\nimport { DropGeoFileDirective } from './shared/drop-geo-file.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    IgoKeyValueModule,\r\n    IgoDrapDropModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  exports: [ImportExportComponent, DropGeoFileDirective, ExportButtonComponent],\r\n  declarations: [ImportExportComponent, DropGeoFileDirective, ExportButtonComponent]\r\n})\r\nexport class IgoImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoImportExportModule> {\r\n    return {\r\n      ngModule: IgoImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule } from '@igo2/common';\r\nimport { MapBrowserComponent } from './map-browser/map-browser.component';\r\nimport { ZoomButtonComponent } from './zoom-button/zoom-button.component';\r\nimport { GeolocateButtonComponent } from './geolocate-button/geolocate-button.component';\r\nimport { HomeExtentButtonComponent } from './home-extent-button/home-extent-button.component';\r\nimport { RotationButtonComponent } from './rotation-button/rotation-button.component';\r\nimport { BaseLayersSwitcherComponent } from './baselayers-switcher/baselayers-switcher.component';\r\nimport { MiniBaseMapComponent } from './baselayers-switcher/mini-basemap.component';\r\nimport { MapOfflineDirective } from './shared/mapOffline.directive';\r\nimport { OfflineButtonComponent } from './offline-button/offline-button.component';\r\nimport { WakeLockButtonComponent } from './wake-lock-button/wake-lock-button.component';\r\nimport { PointerPositionDirective } from './shared/map-pointer-position.directive';\r\nimport { HoverFeatureDirective } from './shared/hover-feature.directive';\r\nimport { SwipeControlComponent } from './swipe-control/swipe-control.component';\r\nimport { MapCenterComponent } from './map-center/map-center.component';\r\nimport { MenuButtonComponent } from './menu-button/menu-button.component';\r\nimport { InfoSectionComponent } from './info-section/info-section.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    WakeLockButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ],\r\n  declarations: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    WakeLockButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ]\r\n})\r\nexport class IgoMapModule {}\r\n","<mat-form-field\r\n  class=\"measure-field\"\r\n  appearance=\"outline\"\r\n  floatLabel=\"always\">\r\n  <mat-label>{{placeholder}}</mat-label>\r\n  <input\r\n    matInput\r\n    [readonly]=\"true\"\r\n    [value]=\"((measure$ | async) || 0) | measureFormat: measureUnit\">\r\n</mat-form-field>\r\n<mat-form-field class=\"unit-field\">\r\n  <mat-select\r\n    [value]=\"measureUnit\"\r\n    [disabled]=\"auto\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n      {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit\r\n} from '../shared/measure.enum';\r\nimport { computeBestAreaUnit, computeBestLengthUnit } from '../shared/measure.utils';\r\n\r\n/**\r\n * Measurer item\r\n */\r\n@Component({\r\n  selector: 'igo-measurer-item',\r\n  templateUrl: './measurer-item.component.html',\r\n  styleUrls: ['./measurer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerItemComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Measure observable\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the measure observable when the auto mode is on\r\n   * @internal\r\n   */\r\n  public measure$$: Subscription;\r\n\r\n  /**\r\n   * Measure type\r\n   */\r\n  @Input() measureType: MeasureType;\r\n\r\n  /**\r\n   * Measure unit\r\n   */\r\n  @Input() measureUnit: MeasureAreaUnit | MeasureLengthUnit;\r\n\r\n  /**\r\n   * Measure\r\n   */\r\n  @Input()\r\n  set measure(value: number) {\r\n    this.measure$.next(value);\r\n  }\r\n  get measure(): number { return this.measure$.value; }\r\n\r\n  /**\r\n   * Whther measure units should be automatically determined\r\n   */\r\n  @Input()\r\n  set auto(value: boolean) { this.toggleAutoUnit(value); }\r\n  get auto(): boolean { return this._auto; }\r\n  private _auto: boolean = false;\r\n\r\n  /**\r\n   * Placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Event emitted when the measure unit changes\r\n   */\r\n  @Output() measureUnitChange = new EventEmitter<MeasureAreaUnit | MeasureLengthUnit>();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    if (this.measureType === MeasureType.Area) {\r\n      return Object.values(MeasureAreaUnit);\r\n    }\r\n    return Object.values(MeasureLengthUnit);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Toggle the auto unit off\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toggleAutoUnit(false);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureAreaUnit | MeasureLengthUnit) {\r\n    this.measureUnit = unit;\r\n    this.measureUnitChange.emit(unit);\r\n  }\r\n\r\n  private toggleAutoUnit(toggle: boolean) {\r\n    if (this.measure$$ !== undefined) {\r\n      this.measure$$.unsubscribe();\r\n    }\r\n    if (toggle === true) {\r\n      this.measure$$ = this.measure$.subscribe((measure: number) => {\r\n        this.computeBestMeasureUnit(measure);\r\n      });\r\n    }\r\n    this._auto = toggle;\r\n  }\r\n\r\n  private computeBestMeasureUnit(measure: number) {\r\n    let measureUnit = this.measureUnit;\r\n    if (this.measureType === MeasureType.Area) {\r\n      measureUnit = computeBestAreaUnit(measure);\r\n    } else if (this.measureType === MeasureType.Length) {\r\n      measureUnit = computeBestLengthUnit(measure);\r\n    }\r\n    if (measureUnit !== this.measureUnit) {\r\n      this.onMeasureUnitChange(measureUnit);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\n\r\nimport { MeasureFormatPipe } from './measure-format.pipe';\r\nimport { MeasurerItemComponent } from './measurer-item.component';\r\nimport { MeasurerComponent } from './measurer.component';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDividerModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule\r\n  ],\r\n  declarations: [\r\n    MeasureFormatPipe,\r\n    MeasurerItemComponent,\r\n    MeasurerComponent,\r\n    MeasurerDialogComponent\r\n  ],\r\n  exports: [\r\n    MeasureFormatPipe,\r\n    MeasurerComponent\r\n  ]\r\n})\r\nexport class IgoMeasurerModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoMeasurerModule } from './measurer/measurer.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n    IgoMeasurerModule\r\n  ]\r\n})\r\nexport class IgoMeasureModule {}\r\n","export enum OverlayAction {\r\n    None,\r\n    Move,\r\n    Zoom,\r\n    ZoomIfOutMapExtent\r\n  }\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayAction } from './overlay.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OverlayService {\r\n  public features$ = new BehaviorSubject<[Feature[], OverlayAction]>([\r\n    [],\r\n    undefined\r\n  ]);\r\n\r\n  constructor() {}\r\n\r\n  setFeatures(features: Feature[], action: OverlayAction = OverlayAction.None) {\r\n    this.features$.next([features, action]);\r\n  }\r\n\r\n  clear() {\r\n    this.features$.next([[], OverlayAction.None]);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayService } from '../shared/overlay.service';\r\nimport { OverlayAction } from '../shared/overlay.enum';\r\n\r\n@Directive({\r\n  selector: '[igoOverlay]'\r\n})\r\nexport class OverlayDirective implements OnInit, OnDestroy {\r\n  private features$$: Subscription;\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private overlayService: OverlayService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.features$$ = this.overlayService.features$.subscribe(res =>\r\n      this.handleFeatures(res[0], res[1])\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.features$$.unsubscribe();\r\n  }\r\n\r\n  private handleFeatures(features: Feature[], action: OverlayAction) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\nimport { OverlayDirective } from './shared/overlay.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [OverlayDirective],\r\n  declarations: [OverlayDirective]\r\n})\r\nexport class IgoOverlayModule {\r\n  static forRoot(): ModuleWithProviders<IgoOverlayModule> {\r\n    return {\r\n      ngModule: IgoOverlayModule\r\n    };\r\n  }\r\n}\r\n","/*\r\n * The MIT License (MIT)\r\n *\r\n * Copyright (c) 2016-2017 Dan \"Ducky\" Little\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal\r\n * in the Software without restriction, including without limitation the rights\r\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n * copies of the Software, and to permit persons to whom the Software is\r\n * furnished to do so, subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in all\r\n * copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n * SOFTWARE.\r\n */\r\n\r\nexport default function jsGeoPdfPlugin(jsPDFAPI) {\r\n\r\n    const setGeoArea = function(pdfExt, geoExt) {\r\n        const bbox = pdfExt.join(' ');\r\n        // the ordering may seem odd here but PDF\r\n        //  flips the Y axis upside down and this accounts for that\r\n        //  change.\r\n        const minx = geoExt[0];\r\n        const maxx = geoExt[2];\r\n        const maxy = geoExt[1];\r\n        const miny = geoExt[3];\r\n        const bounds = [miny, minx, maxy, minx, maxy, maxx, miny, maxx].join(' ');\r\n        const bbox_obj = this.internal.newAdditionalObject();\r\n        const bounds_obj = this.internal.newAdditionalObject();\r\n        const proj_obj = this.internal.newAdditionalObject();\r\n\r\n        proj_obj.content = '<< /EPSG 3857 /Type /PROJCS /WKT (PROJCS[\"WGS_1984_Web_Mercator_Auxiliary_Sphere\"'+\r\n        ',GEOGCS[\"GCS_WGS_1984\",DATUM[\"D_WGS_1984\",SPHEROID[\"WGS_1984\",6378137.0,298.257223563]],PRIMEM[\"Greenwich\",0.0]'+\r\n        ',UNIT[\"Degree\",0.017453292519943295]],PROJECTION[\"Mercator_Auxiliary_Sphere\"],PARAMETER[\"False_Easting\",0.0]'+\r\n        ',PARAMETER[\"False_Northing\",0.0],PARAMETER[\"Central_Meridian\",0.0],PARAMETER[\"Standard_Parallel_1\",0.0]'+\r\n        ',PARAMETER[\"Auxiliary_Sphere_Type\",0.0],UNIT[\"Meter\",1.0]]) >>';\r\n\r\n        bounds_obj.content = '<< /Bounds [ 0 1 0 0 1 0 1 1 ] /GCS ' +\r\n        proj_obj.objId + ' 0 R /GPTS [ ' + bounds + ' ] /LPTS [ 0 1 0 0 1 0 1 1 ] /Subtype /GEO /Type /Measure >>';\r\n\r\n        bbox_obj.content = '<< /BBox [ ' + bbox + ' ] /Measure ' + bounds_obj.objId + ' 0 R /Name (Layer) /Type /Viewport >>';\r\n\r\n        const title_obj = this.internal.newAdditionalObject();\r\n        const date = new Date().toLocaleDateString('en-CA');\r\n        title_obj.content = '<< /Name IGO2 /Type /OCG /Date '+ date +' >>';\r\n\r\n        return bbox_obj.objId;\r\n    };\r\n\r\n    jsPDFAPI.setGeoArea = function(pdfExt, geoExt) {\r\n        this.internal.events.subscribe('putPage', function() {\r\n            const bbox_id = setGeoArea.call(this, pdfExt, geoExt);\r\n            this.internal.write('/VP [ ' + bbox_id + ' 0 R ]');\r\n        });\r\n    };\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const PrintOutputFormat = strEnum(['Pdf', 'Image']);\r\n\r\nexport type PrintOutputFormat = keyof typeof PrintOutputFormat;\r\n\r\nexport const PrintPaperFormat = strEnum([\r\n  'A0',\r\n  'A1',\r\n  'A2',\r\n  'A3',\r\n  'A4',\r\n  'A5',\r\n  'Letter',\r\n  'Legal'\r\n]);\r\nexport type PrintPaperFormat = keyof typeof PrintPaperFormat;\r\n\r\nexport const PrintOrientation = strEnum(['landscape', 'portrait']);\r\nexport type PrintOrientation = keyof typeof PrintOrientation;\r\n\r\nexport const PrintResolution = strEnum(['72', '96', '150', '300']);\r\nexport type PrintResolution = keyof typeof PrintResolution;\r\n\r\nexport const PrintSaveImageFormat = strEnum([\r\n  'Bmp',\r\n  'Gif',\r\n  'Jpeg',\r\n  'Png',\r\n  'Tiff'\r\n]);\r\nexport type PrintSaveImageFormat = keyof typeof PrintSaveImageFormat;\r\n\r\nexport const PrintLegendPosition = strEnum([\r\n  'none',\r\n  'topright',\r\n  'topleft',\r\n  'bottomleft',\r\n  'bottomright',\r\n  'newpage'\r\n]);\r\nexport type PrintLegendPosition = keyof typeof PrintLegendPosition;\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { Observable, Subject, forkJoin } from 'rxjs';\r\nimport { map as rxMap } from 'rxjs/operators';\r\n\r\nimport { saveAs } from 'file-saver';\r\nimport jsPDF from 'jspdf';\r\nimport html2canvas from 'html2canvas';\r\nimport { default as JSZip } from 'jszip';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { SecureImagePipe } from '@igo2/common';\r\nimport { MessageService, ActivityService, LanguageService, ConfigService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { formatScale } from '../../map/shared/map.utils';\r\nimport { LegendMapViewOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { getLayersLegends } from '../../layer/utils/outputLegend';\r\n\r\nimport { PrintOptions, TextPdfSizeAndMargin } from './print.interface';\r\nimport GeoPdfPlugin from './geopdf';\r\nimport { PrintPaperFormat } from './print.type';\r\n\r\ndeclare global {\r\n  interface Navigator {\r\n    msSaveBlob?: (blob: any, defaultName?: string) => boolean\r\n  }\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class PrintService {\r\n  zipFile: JSZip;\r\n  nbFileToProcess: number;\r\n  activityId: string;\r\n  imgSizeAdded: Array<number>;\r\n\r\n  TEXTPDFFONT = {\r\n    titleFont: 'Times',\r\n    titleFontStyle: 'bold',\r\n    subtitleFont: 'Times',\r\n    subtitleFontStyle: 'bold',\r\n    commentFont: 'courier',\r\n    commentFontStyle: 'normal',\r\n    commentFontSize: 12\r\n  };\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private activityService: ActivityService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {}\r\n\r\n  print(map: IgoMap, options: PrintOptions): Subject<any> {\r\n    const status$ = new Subject();\r\n    const paperFormat: string = options.paperFormat;\r\n    const resolution = +options.resolution; // Default is 96\r\n    const orientation = options.orientation;\r\n    const legendPostion = options.legendPosition;\r\n    this.activityId = this.activityService.register();\r\n\r\n    GeoPdfPlugin(jsPDF.API);\r\n\r\n    const doc = new jsPDF({\r\n      orientation,\r\n      format: paperFormat.toLowerCase(),\r\n      unit: 'mm' // default\r\n    });\r\n\r\n    const dimensions = [\r\n      doc.internal.pageSize.width,\r\n      doc.internal.pageSize.height\r\n    ];\r\n\r\n    const margins = [10, 10, 10, 10];\r\n    const width = dimensions[0] - margins[3] - margins[1];\r\n    const height = dimensions[1] - margins[0] - margins[2];\r\n    const size = [width, height];\r\n    let titleSizes: TextPdfSizeAndMargin;\r\n    let subtitleSizes: TextPdfSizeAndMargin;\r\n\r\n    // if paper format A1 or A0 add margin top\r\n    if ((options.title !== '' || options.subtitle) &&\r\n      (paperFormat === PrintPaperFormat.A1 || paperFormat === PrintPaperFormat.A0)) {\r\n      margins[0] += 10;\r\n    }\r\n    // PDF title\r\n    const fontSizeInPt = Math.round(2 * (height + 145) * 0.05) / 2; //calculate the fontSize title from the page height.\r\n    if (options.title !== undefined && options.title !== '') {\r\n      titleSizes = this.getTextPdfObjectSizeAndMarg(options.title,\r\n        margins,\r\n        this.TEXTPDFFONT.titleFont,\r\n        fontSizeInPt,\r\n        this.TEXTPDFFONT.titleFontStyle,\r\n        doc);\r\n\r\n      this.addTextInPdfDoc(doc,\r\n        options.title,\r\n        this.TEXTPDFFONT.titleFont,\r\n        this.TEXTPDFFONT.titleFontStyle,\r\n        titleSizes.fontSize,\r\n        titleSizes.marginLeft + margins[3],\r\n        margins[0]);\r\n\r\n      margins[0] = titleSizes.height + margins[0]; // cumulative margin top for next elem to place in pdf doc\r\n    }\r\n\r\n    // PDF subtitle\r\n    if (options.subtitle !== undefined && options.subtitle !== '') {\r\n      subtitleSizes = this.getTextPdfObjectSizeAndMarg(options.subtitle,\r\n        margins,\r\n        this.TEXTPDFFONT.subtitleFont,\r\n        (options.title !== '') ? titleSizes.fontSize * 0.7 : fontSizeInPt * 0.7, // 70% size of title\r\n        this.TEXTPDFFONT.subtitleFontStyle,\r\n        doc);\r\n\r\n       this.addTextInPdfDoc(doc,\r\n        options.subtitle,\r\n        this.TEXTPDFFONT.subtitleFont,\r\n        this.TEXTPDFFONT.subtitleFontStyle,\r\n        subtitleSizes.fontSize,\r\n        subtitleSizes.marginLeft + margins[3],\r\n        margins[0]\r\n      );\r\n\r\n      margins[0] += 5; // cumulative marg top for next elem to place in pdf doc. 5 is a fix it could be adjust\r\n    }\r\n\r\n    if (options.showProjection === true || options.showScale === true) {\r\n      this.addProjScale(\r\n        doc,\r\n        map,\r\n        resolution,\r\n        options.showProjection,\r\n        options.showScale\r\n        );\r\n    }\r\n    if (options.comment !== undefined && options.comment !== '') {\r\n      this.addComment(doc, options.comment);\r\n    }\r\n\r\n    this.addMap(doc, map, resolution, size, margins).subscribe(\r\n      async (status: SubjectStatus) => {\r\n        if (status === SubjectStatus.Done) {\r\n          await this.addScale(doc, map, margins);\r\n          await this.handleMeasureLayer(doc, map, margins);\r\n\r\n          const width = this.imgSizeAdded[0];\r\n          const height = this.imgSizeAdded[1];\r\n          const res = 1;\r\n          this.addGeoRef(doc, map, width, height, res, margins);\r\n\r\n          if (options.legendPosition !== 'none') {\r\n            if (['topleft', 'topright', 'bottomleft', 'bottomright'].indexOf(options.legendPosition) > -1 ) {\r\n              await this.addLegendSamePage(doc, map, margins, resolution, options.legendPosition);\r\n            } else if (options.legendPosition === 'newpage') {\r\n              await this.addLegend(doc, map, margins, resolution);\r\n            }\r\n          } else {\r\n            await this.saveDoc(doc);\r\n          }\r\n        }\r\n\r\n        if (status === SubjectStatus.Done || status === SubjectStatus.Error) {\r\n          this.activityService.unregister(this.activityId);\r\n          status$.next(SubjectStatus.Done);\r\n        }\r\n      }\r\n    );\r\n\r\n    return status$;\r\n  }\r\n  // ref GeoMoose https://github.com/geomoose/gm3/tree/main/src/gm3/components/print\r\n  addGeoRef(doc, map, width, height, resolution, margins) {\r\n    const unit = 'mm';\r\n    const docHeight = doc.internal.pageSize.getHeight();\r\n\r\n    // x,y = margin left-bottom corner for img in pdf doc\r\n    const x = margins[3];\r\n    const y = docHeight - margins[0] - height;\r\n\r\n    let pdf_extents = [x, y, x + width, y + height];\r\n    for(let i = 0; i < pdf_extents.length; i++) {\r\n      pdf_extents[i] = this.pdf_units2points(pdf_extents[i], unit);\r\n    }\r\n\r\n    const mapExtent = map.viewController.getExtent('EPSG:3857');\r\n    doc.setGeoArea(pdf_extents, mapExtent);\r\n\r\n  }\r\n\r\n  /**\r\n   * Add measure overlay on the map on the document when the measure layer is present\r\n   * @param  doc - Pdf document where measure tooltip will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async handleMeasureLayer(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n  ) {\r\n    if (map.layers.find(layer => layer.visible && layer.id.startsWith('igo-measures-'))) {\r\n      let canvasOverlayHTMLMeasures;\r\n      const mapOverlayMeasuresHTML = map.ol.getOverlayContainer();\r\n      await html2canvas(mapOverlayMeasuresHTML, {\r\n        scale: 1,\r\n        backgroundColor: null\r\n      }).then(e => {\r\n        canvasOverlayHTMLMeasures = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTMLMeasures, margins); // this adds measure overlays\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get html code for all layers legend\r\n   * @param  map IgoMap\r\n   * @param  width The width that the legend need to be\r\n   * @return Html code for the legend\r\n   */\r\n  getLayersLegendHtml(\r\n    map: IgoMap,\r\n    width: number,\r\n    resolution: number\r\n  ): Observable<string> {\r\n    return new Observable((observer) => {\r\n      let html = '';\r\n      const legends = getLayersLegends(\r\n        map.layers,\r\n        {\r\n          resolution: map.viewController.getResolution(),\r\n          extent: map.viewController.getExtent(),\r\n          projection: map.viewController.getOlProjection().getCode(),\r\n          // scale: map.viewController.getScale(resolution),\r\n          size: map.ol.getSize()\r\n        } as LegendMapViewOptions\r\n      );\r\n\r\n      if (legends.filter(l => l.display === true).length === 0) {\r\n        observer.next(html);\r\n        observer.complete();\r\n        return;\r\n      }\r\n      // Define important style to be sure that all container is convert\r\n      // to image not just visible part\r\n      html += '<style media=\"screen\" type=\"text/css\">';\r\n      html += '.html2canvas-container { width: ' + width + 'mm !important; height: 2000px !important; }';\r\n      html += 'table.tableLegend {table-layout: auto;}';\r\n      html += 'div.styleLegend {padding-top: 5px; padding-right:5px;padding-left:5px;padding-bottom:5px;}';\r\n      html += '</style>';\r\n      // The font size will also be lowered afterwards (globally along the legend size)\r\n      // this allows having a good relative font size here and to keep ajusting the legend size\r\n      // while keeping good relative font size\r\n      html += '<font size=\"3\" face=\"Times\" >';\r\n      html += '<div class=\"styleLegend\">';\r\n      html += '<table class=\"tableLegend\" >';\r\n\r\n      // For each legend, define an html table cell\r\n      const images$ = legends.filter(l => l.display && l.isInResolutionsRange === true)\r\n      .map((legend) =>\r\n        this.getDataImage(legend.url).pipe(\r\n          rxMap((dataImage) => {\r\n            let htmlImg = '<tr><td>' + legend.title.toUpperCase() + '</td></tr>';\r\n            htmlImg += '<tr><td><img src=\"' + dataImage + '\"></td></tr>';\r\n            return htmlImg;\r\n          })\r\n        )\r\n      );\r\n      forkJoin(images$).subscribe((dataImages) => {\r\n        html = dataImages.reduce((acc, current) => (acc += current), html);\r\n        html += '</table>';\r\n        html += '</div>';\r\n        observer.next(html);\r\n        observer.complete();\r\n      });\r\n    });\r\n  }\r\n\r\n  getDataImage(url: string): Observable<string> {\r\n    const secureIMG = new SecureImagePipe(this.http, this.configService);\r\n    return secureIMG.transform(url);\r\n  }\r\n\r\n  /**\r\n   * Get all the legend in a single image\r\n   * * @param  format - Image format. default value to \"png\"\r\n   * @return The image of the legend\r\n   */\r\n  async getLayersLegendImage(\r\n    map,\r\n    format: string = 'png',\r\n    doZipFile: boolean,\r\n    resolution: number\r\n  ) {\r\n    const status$ = new Subject();\r\n    // Get html code for the legend\r\n    const width = 200; // milimeters unit, originally define for document pdf\r\n    let html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    format = format.toLowerCase();\r\n\r\n    // If no legend show No LEGEND in an image\r\n    if (html.length === 0) {\r\n      html = '<font size=\"12\" face=\"Courier New\" >';\r\n      html += '<div align=\"center\"><b>NO LEGEND</b></div>';\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      let status = SubjectStatus.Done;\r\n      try {\r\n        if (!doZipFile) {\r\n          // Save the canvas as file\r\n          this.saveCanvasImageAsFile(canvas, 'legendImage', format);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(canvas, 'legendImage' + '.' + format);\r\n        }\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n      status$.next(status);\r\n    }\r\n\r\n    return status$;\r\n  }\r\n\r\n\r\n  getTextPdfObjectSizeAndMarg(text: string, margins, font:string, fontSizeInPt: number, fontStyle:string, doc: jsPDF)\r\n  : TextPdfSizeAndMargin {\r\n    const pdfResolution = 96;\r\n    const docWidth = doc.internal.pageSize.getWidth();\r\n    const pageWidth = docWidth - margins[1] - margins[3];\r\n\r\n    // important to set it first, the textDimension change when font change!\r\n    doc.setFont(font, fontStyle);\r\n    doc.setFontSize(fontSizeInPt);\r\n\r\n    let textDimensions = doc.getTextDimensions(text);\r\n    let textMarginLeft: number;\r\n\r\n    if (textDimensions.w > pageWidth) {\r\n      // if the text is to long, reduce fontSize 70% and the overflow with be cut in print...\r\n      textMarginLeft = 0;\r\n      fontSizeInPt = fontSizeInPt * 0.7;\r\n      doc.setFontSize(fontSizeInPt);\r\n      textDimensions = doc.getTextDimensions(text);\r\n\r\n    } else {\r\n      textMarginLeft = (pageWidth - textDimensions.w ) / 2 ;\r\n    }\r\n\r\n    return {\r\n      'fontSize': fontSizeInPt,\r\n      'marginLeft': textMarginLeft,\r\n      'height': textDimensions.h\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Add comment to the document\r\n   * * @param  doc - pdf document\r\n   * * @param  comment - Comment to add in the document\r\n   */\r\n  private addComment(doc: jsPDF, comment: string) {\r\n    const commentMarginLeft = 10; //margin left and bottom is fix\r\n    const commentMarginBottom = 10;\r\n    const marginTop = doc.internal.pageSize.height - commentMarginBottom;\r\n    this. addTextInPdfDoc(doc,comment,\r\n      this.TEXTPDFFONT.commentFont,\r\n      this.TEXTPDFFONT.commentFontStyle,\r\n      this.TEXTPDFFONT.commentFontSize,\r\n      commentMarginLeft,\r\n      marginTop,\r\n      true\r\n    );\r\n  }\r\n\r\n  private addTextInPdfDoc(doc: jsPDF,\r\n    textToAdd: string,\r\n    textFont: string,\r\n    textFontStyle: string,\r\n    textFontSize: number,\r\n    textMarginLeft: number,\r\n    textMarginTop: number,\r\n    isComment: boolean = false)\r\n    {\r\n      doc.setFont(textFont, textFontStyle);\r\n      doc.setFontSize(textFontSize);\r\n\r\n      if(isComment) {\r\n        textToAdd = doc.splitTextToSize(textToAdd, (doc.internal.pageSize.getWidth() - (textMarginLeft * 3)));\r\n      }\r\n      doc.text(textToAdd, textMarginLeft, textMarginTop);\r\n    }\r\n\r\n  /**\r\n   * Add projection and/or scale to the document\r\n   * @param  doc - pdf document\r\n   * @param  map - Map of the app\r\n   * @param  dpi - DPI resolution of the document\r\n   * @param  projection - Bool to indicate if projection need to be added\r\n   * @param  scale - Bool to indicate if scale need to be added\r\n   */\r\n  private addProjScale(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    dpi: number,\r\n    projection: boolean,\r\n    scale: boolean\r\n  ) {\r\n    const translate = this.languageService.translate;\r\n    const projScaleSize = 12;\r\n    const projScaleMarginLeft = 10;\r\n    const marginBottom = 15;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    let textProjScale: string = '';\r\n    if (projection === true) {\r\n      const projText = translate.instant('igo.geo.printForm.projection');\r\n      textProjScale += projText + ': ' + map.projection;\r\n    }\r\n    if (scale === true) {\r\n      if (projection === true) {\r\n        textProjScale += '   ';\r\n      }\r\n      const scaleText = translate.instant('igo.geo.printForm.scale');\r\n      const mapScale = map.viewController.getScale(dpi);\r\n      textProjScale += scaleText + ': ~ 1 / ' + formatScale(mapScale);\r\n    }\r\n    doc.setFont('courier');\r\n    doc.setFontSize(projScaleSize);\r\n    doc.text(textProjScale, projScaleMarginLeft, heightPixels);\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addLegend(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    margins: Array<number>,\r\n    resolution: number\r\n  ) {\r\n    // Get html code for the legend\r\n    const width = doc.internal.pageSize.width;\r\n    const html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    // If no legend, save the map directly\r\n    if (html === '') {\r\n      await this.saveDoc(doc);\r\n      return true;\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      const pourcentageReduction = 0.85;\r\n      const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution, pourcentageReduction\r\n        * (25.4 * canvas.height) / resolution];\r\n      let imgData;\r\n      doc.addPage();\r\n      imgData = canvas.toDataURL('image/png');\r\n      doc.addImage(imgData, 'PNG', 10, 10, imageSize[0], imageSize[1]);\r\n    }\r\n\r\n    await this.saveDoc(doc);\r\n\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n     private async addLegendSamePage(\r\n      doc: jsPDF,\r\n      map: IgoMap,\r\n      margins: Array<number>,\r\n      resolution: number,\r\n      legendPosition: string\r\n    ) {\r\n      // Get html code for the legend\r\n      const width = doc.internal.pageSize.width;\r\n      const html = await this.getLayersLegendHtml(\r\n        map,\r\n        width,\r\n        resolution\r\n      ).toPromise();\r\n      // If no legend, save the map directly\r\n      if (html === '') {\r\n        await this.saveDoc(doc);\r\n        return true;\r\n      }\r\n      // Create div to contain html code for legend\r\n      const div = window.document.createElement('div');\r\n      div.style.position = 'absolute';\r\n      div.style.top = '0';\r\n      // Add html code to convert in the new window\r\n      window.document.body.appendChild(div);\r\n      div.innerHTML = html;\r\n      await this.timeout(1);\r\n      const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n        console.log(e);\r\n      });\r\n      let marginsLegend;\r\n      if (canvas) {\r\n        const pourcentageReduction = 0.85;\r\n        const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution,\r\n           pourcentageReduction * (25.4 * canvas.height) / resolution];\r\n        // Move the legend to the correct position on the page\r\n        if ( legendPosition === 'bottomright') {\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1], margins[1],\r\n           margins[2], doc.internal.pageSize.width - margins[1] - imageSize[0]];\r\n        } else if (legendPosition === 'topright') {\r\n          marginsLegend = [margins[0], margins[1], doc.internal.pageSize.height - margins[0] - imageSize[1],\r\n          doc.internal.pageSize.width - margins[1] - imageSize[0] ];\r\n        } else if (legendPosition === 'bottomleft') {\r\n          // When the legend is in the bottom left, raise the legend slightly upward so that attributions are visible\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1] - 15,\r\n          doc.internal.pageSize.width - margins[3] - imageSize[0], margins[2] + 15, margins[3] ];\r\n        } else if (legendPosition === 'topleft') {\r\n          marginsLegend = [margins[0], doc.internal.pageSize.width - margins[3] - imageSize[0],\r\n           doc.internal.pageSize.height - margins[0] - imageSize[1], margins[3] ];\r\n        }\r\n        this.addCanvas(doc, canvas, marginsLegend); // this adds the legend\r\n        await this.saveDoc(doc);\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Add scale and attributions on the map on the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addScale(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n    ) {\r\n      const mapSize = map.ol.getSize();\r\n      const extent = map.ol.getView().calculateExtent(mapSize);\r\n      // Get the scale and attribution\r\n      // we use cloneNode to modify the nodes to print without modifying it on the page, using deep:true to get children\r\n      let canvasOverlayHTML;\r\n      const mapOverlayHTML = map.ol.getOverlayContainerStopEvent();\r\n      // Remove the UI buttons from the nodes\r\n      const OverlayHTMLButtons = mapOverlayHTML.getElementsByTagName('button');\r\n      const OverlayHTMLButtonsarr = Array.from(OverlayHTMLButtons);\r\n      for (const OverlayHTMLButton of OverlayHTMLButtonsarr) {\r\n        OverlayHTMLButton.setAttribute('data-html2canvas-ignore', 'true');\r\n      }\r\n      // Find attributions by class and delete\r\n      // the collapsed class to open attribution Copyright\r\n      const element = mapOverlayHTML.querySelector('.ol-attribution');\r\n      const olCollapsed: boolean = element.classList.contains('ol-collapsed');\r\n      if (olCollapsed) {\r\n        element.classList.remove('ol-collapsed');\r\n      }\r\n      // Change the styles of hyperlink in the printed version\r\n      // Transform the Overlay into a canvas\r\n      // scale is necessary to make it in google chrome\r\n      // background as null because otherwise it is white and cover the map\r\n      // allowtaint is to allow rendering images in the attributions\r\n      // useCORS: true pour permettre de renderer les images (ne marche pas en local)\r\n      const canvas = await html2canvas(mapOverlayHTML, {\r\n        scale: 1,\r\n        backgroundColor: null,\r\n        allowTaint: true,\r\n        useCORS: true,\r\n      }).then( e => {\r\n        canvasOverlayHTML = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTML, margins); // this adds scales and attributions\r\n      if (olCollapsed) {\r\n        element.classList.add('ol-collapsed');\r\n      }\r\n }\r\n\r\n /**\r\n  * Add Copyrigh to the map canvas\r\n  * @param map - Map of the app\r\n  * @param canvas Canvas of the map\r\n  */\r\n  private async addCopyrightToImage(\r\n    map: IgoMap,\r\n    canvas : HTMLCanvasElement\r\n    ) {\r\n      const context = canvas.getContext('2d');\r\n      let canvasOverlayHTML;\r\n      const mapOverlayHTML = map.ol.getOverlayContainerStopEvent();\r\n      // Remove the UI buttons from the nodes\r\n      const OverlayHTMLButtons = mapOverlayHTML.getElementsByTagName('button');\r\n      const OverlayHTMLButtonsarr = Array.from(OverlayHTMLButtons);\r\n      for (const OverlayHTMLButton of OverlayHTMLButtonsarr) {\r\n        OverlayHTMLButton.setAttribute('data-html2canvas-ignore', 'true');\r\n      }\r\n      // Find attributions by class and delete\r\n      // the collapsed class to open attribution Copyright\r\n      const element = mapOverlayHTML.querySelector('.ol-attribution');\r\n      const olCollapsed: boolean = element.classList.contains('ol-collapsed');\r\n      if (olCollapsed) {\r\n        element.classList.remove('ol-collapsed');\r\n      }\r\n\r\n      await html2canvas(mapOverlayHTML, {\r\n        scale: 1,\r\n        backgroundColor: null,\r\n        allowTaint: true,\r\n        useCORS: true,\r\n      }).then( e => {\r\n        canvasOverlayHTML = e;\r\n      });\r\n      context.drawImage(canvasOverlayHTML, 0, 0);\r\n      if (olCollapsed) {\r\n        element.classList.add('ol-collapsed');\r\n      }\r\n  }\r\n\r\n  defineNbFileToProcess(nbFileToProcess) {\r\n    this.nbFileToProcess = nbFileToProcess;\r\n  }\r\n\r\n  private timeout(ms) {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n\r\n  private addCanvas(\r\n    doc: jsPDF,\r\n    canvas: HTMLCanvasElement,\r\n    margins: Array<number>\r\n  ) {\r\n    let image;\r\n    if (canvas) {\r\n      image = canvas.toDataURL('image/png');\r\n    }\r\n\r\n    if (image !== undefined) {\r\n      if (image.length < 20 ) { //  img is corrupt    todo: fix addScale in mobile make a corrupt img\r\n        console.log('Warning: An image cannot be print in pdf file');\r\n        return;\r\n      }\r\n      const imageSize = this.getImageSizeToFitPdf(doc, canvas, margins);\r\n      doc.addImage(\r\n        image,\r\n        'PNG',\r\n        margins[3],\r\n        margins[0],\r\n        imageSize[0],\r\n        imageSize[1]\r\n      );\r\n      doc.rect(margins[3], margins[0], imageSize[0], imageSize[1]);\r\n      this.imgSizeAdded = imageSize; // keep img size for georef later\r\n    }\r\n  }\r\n\r\n  // TODO fix printing with image resolution\r\n  private addMap(\r\n    doc: jsPDF,\r\n    map: IgoMap,\r\n    resolution: number,\r\n    size: Array<number>,\r\n    margins: Array<number>\r\n  ) {\r\n    const status$ = new Subject();\r\n\r\n    const mapSize = map.ol.getSize();\r\n    const extent = map.ol.getView().calculateExtent(mapSize);\r\n\r\n    const widthPixels = Math.round((size[0] * resolution) / 25.4);\r\n    const heightPixels = Math.round((size[1] * resolution) / 25.4);\r\n\r\n    let timeout;\r\n\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      const canvases = event.target.getViewport().getElementsByTagName('canvas');\r\n      const mapStatus$$ = map.status$.subscribe((mapStatus: SubjectStatus) => {\r\n        clearTimeout(timeout);\r\n\r\n        if (mapStatus !== SubjectStatus.Done) {\r\n          return;\r\n        }\r\n\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error('igo.geo.printForm.corsErrorMessageBody','igo.geo.printForm.corsErrorMessageHeader');\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      });\r\n\r\n      // If no loading as started after 200ms, then probably no loading\r\n      // is required.\r\n      timeout = window.setTimeout(() => {\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error('igo.geo.printForm.corsErrorMessageBody', 'igo.geo.printForm.corsErrorMessageHeader');\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      }, 200);\r\n    });\r\n\r\n    this.renderMap(map, [widthPixels, heightPixels], extent);\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Download an image of the map with addition of informations\r\n   * @param  map - Map of the app\r\n   * @param  format - Image format. default value to \"png\"\r\n   * @param  projection - Indicate if projection need to be add. Default to false\r\n   * @param  scale - Indicate if scale need to be add. Default to false\r\n   * @param  legend - Indicate if the legend of layers need to be download. Default to false\r\n   * @param  title - Title to add for the map - Default to blank\r\n   * @param  subtitle - Subtitle to add for the map - Default to blank\r\n   * @param  comment - Comment to add for the map - Default to blank\r\n   * @param  doZipFile - Indicate if we do a zip with the file\r\n   * @return Image file of the map with extension format given as parameter\r\n   */\r\n  downloadMapImage(\r\n    map: IgoMap,\r\n    resolution: number,\r\n    format = 'png',\r\n    projection = false,\r\n    scale = false,\r\n    title = '',\r\n    subtitle = '',\r\n    comment = '',\r\n    doZipFile = true,\r\n    legendPosition: string\r\n  ) {\r\n    const status$ = new Subject();\r\n    // const resolution = map.ol.getView().getResolution();\r\n    this.activityId = this.activityService.register();\r\n    const translate = this.languageService.translate;\r\n    map.ol.once('rendercomplete', async (event: any) => {\r\n      format = format.toLowerCase();\r\n      const oldCanvas = event.target\r\n        .getViewport()\r\n        .getElementsByTagName('canvas')[0];\r\n      const newCanvas = document.createElement('canvas');\r\n      const newContext = newCanvas.getContext('2d');\r\n      // Postion in height to set the canvas in new canvas\r\n      let positionHCanvas = 0;\r\n      // Get height/width of map canvas\r\n      const width = oldCanvas.width;\r\n      let height = oldCanvas.height;\r\n      // Set Font to calculate comment width\r\n      newContext.font = '20px Calibri';\r\n      const commentWidth = newContext.measureText(comment).width;\r\n      // Add height for title if defined\r\n      height = title !== '' ? height + 30 : height;\r\n      // Add height for title if defined\r\n      height = subtitle !== '' ? height + 30 : height;\r\n      // Add height for projection or scale (same line) if defined\r\n      height = projection !== false || scale !== false ? height + 30 : height;\r\n      const positionHProjScale = height - 10;\r\n      // Define number of line depending of the comment length\r\n      const commentNbLine = Math.ceil(commentWidth / width);\r\n      // Add height for multiline comment if defined\r\n      height = comment !== '' ? height + commentNbLine * 30 : height;\r\n      let positionHComment = height - commentNbLine * 20 + 5;\r\n      // Set the new canvas with the new calculated size\r\n      newCanvas.width = width;\r\n      newCanvas.height = height;\r\n      if (['bmp','gif', 'jpeg', 'png', 'tiff'].indexOf(format) > -1) {\r\n        // Patch Jpeg default black background to white\r\n        if (format === 'jpeg') {\r\n          newContext.fillStyle = '#ffffff';\r\n          newContext.fillRect(0, 0, width, height);\r\n          newContext.fillStyle = '#000000';\r\n        } else if (title !== '' || subtitle !== '' || comment !== '' ||\r\n            projection !== false || scale !== false) {\r\n              newContext.fillStyle = '#ffffff';\r\n              newContext.fillRect(0, 0, width, height);\r\n              newContext.fillStyle = '#000000';\r\n        }\r\n      }\r\n\r\n      // If a title need to be added to canvas\r\n      if (title !== '') {\r\n        // Set font for title\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 30;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(title, width / 2, 20, width * 0.9);\r\n      }\r\n      if (subtitle !== '') {\r\n        // Set font for subtitle\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 60;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(subtitle, width / 2, 50, width * 0.9);\r\n      }\r\n      // Set font for next section\r\n      newContext.font = '20px Calibri';\r\n      // If projection or/end scale need to be added to canvas\r\n      if((projection !== false) || (scale !== false)) {\r\n        let projectionScaleText = '';\r\n        if (projection !== false) {\r\n          const projText = translate.instant('igo.geo.printForm.projection');\r\n          projectionScaleText = projText + ': ' + map.projection + '         ';\r\n        }\r\n\r\n        if (scale !== false) {\r\n          const scaleText = translate.instant('igo.geo.printForm.scale');\r\n          const mapScale = map.viewController.getScale(resolution);\r\n          projectionScaleText += scaleText + ': ~ 1 / ' + formatScale(mapScale);\r\n        }\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(projectionScaleText, width / 2, positionHProjScale, width * 0.9);\r\n      }\r\n\r\n      // If a comment need to be added to canvas\r\n      if (comment !== '') {\r\n        newContext.textAlign = 'center';\r\n        // If only one line, no need to multiline the comment\r\n        if (commentNbLine === 1) {\r\n          newContext.fillText(comment, width / 2, positionHComment);\r\n        } else {\r\n          // Separate the setenses to be approx. the same length\r\n          const nbCommentChar = comment.length;\r\n          const CommentLengthToCut = Math.floor(nbCommentChar / commentNbLine);\r\n          let commentCurrentLine = '';\r\n          let positionFirstCutChar = 0;\r\n          let positionLastBlank;\r\n          // Loop for the number of line calculated\r\n          for (let i = 0; i < commentNbLine; i++) {\r\n            // For all line except last\r\n            if (commentNbLine - 1 > i) {\r\n              // Get comment current line to find the right place tu cut comment\r\n              commentCurrentLine = comment.substr(\r\n                positionFirstCutChar,\r\n                CommentLengthToCut\r\n              );\r\n              // Cut the setence at blank\r\n              positionLastBlank = commentCurrentLine.lastIndexOf(' ');\r\n              newContext.fillText(\r\n                commentCurrentLine.substr(0, positionLastBlank),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n              positionFirstCutChar += positionLastBlank;\r\n              // Go to next line for insertion\r\n              positionHComment += 20;\r\n            } else {\r\n              // Don't cut last part\r\n              newContext.fillText(\r\n                comment.substr(positionFirstCutChar),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Add map to new canvas\r\n      newContext.drawImage(oldCanvas, 0, positionHCanvas);\r\n      // Add copyrigh\r\n      await this.addCopyrightToImage(map, newCanvas);\r\n\r\n      // Check the legendPosition\r\n      if (legendPosition !== 'none') {\r\n        if (['topleft', 'topright', 'bottomleft', 'bottomright'].indexOf(legendPosition) > -1) {\r\n          await this.addLegendToImage(\r\n            newCanvas,\r\n            map,\r\n            resolution,\r\n            legendPosition,\r\n            format\r\n          );\r\n        } else if (legendPosition === 'newpage') {\r\n          await this.getLayersLegendImage(\r\n            map,\r\n            format,\r\n            doZipFile,\r\n            resolution\r\n          );\r\n        }\r\n      }\r\n\r\n      let status = SubjectStatus.Done;\r\n      let fileNameWithExt = 'map.' + format;\r\n      if (format.toLowerCase() === 'tiff') {\r\n        fileNameWithExt = 'map' + map.projection.replace(':', '_') + '.' + format;\r\n      }\r\n\r\n      try {\r\n        // Save the canvas as file\r\n        if (!doZipFile) {\r\n          this.saveCanvasImageAsFile(newCanvas, fileNameWithExt, format);\r\n        } else if (format.toLowerCase() === 'tiff') {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, fileNameWithExt);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, fileNameWithExt);\r\n        }\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n\r\n      status$.next(status);\r\n\r\n      if (format.toLowerCase() === 'tiff') {\r\n        const tfwFileNameWithExt = fileNameWithExt.substring(0, fileNameWithExt.toLowerCase().indexOf('.tiff')) + '.tfw';\r\n        const tiwContent = this.getWorldFileInformation(map);\r\n        const blob = new Blob([tiwContent], {\r\n          type: 'text/plain;charset=utf-8'\r\n        });\r\n        if (!doZipFile) {\r\n          // saveAs automaticly replace ':' for '_'\r\n          saveAs(blob, tfwFileNameWithExt);\r\n          this.saveFileProcessing();\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.addFileToZip(tfwFileNameWithExt,blob);\r\n        }\r\n      }\r\n    });\r\n    map.ol.renderSync();\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Create and Add Legend to the map canvas\r\n   * @param  canvas Canvas of the map\r\n   * @param  map Map of the app\r\n   * @param  resolution Resolution of map\r\n   * @param  legendPosition Legend position\r\n   * @param  format Image format\r\n   */\r\n  private async addLegendToImage(\r\n      canvas: HTMLCanvasElement,\r\n      map: IgoMap,\r\n      resolution: number,\r\n      legendPosition: string,\r\n      format: string\r\n  ) {\r\n    const fileNameWithExt = 'map.' + format;\r\n    const context = canvas.getContext('2d');\r\n\r\n    // Get html code for the legend\r\n    const html = await this.getLayersLegendHtml(\r\n      map,\r\n      canvas.width,\r\n      resolution\r\n    ).toPromise();\r\n    // If no legend, save the map directly\r\n    if (html === '') {\r\n      await this.saveCanvasImageAsFile(canvas, fileNameWithExt, format);\r\n      return true;\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n    await this.timeout(1);\r\n    const canvasLegend = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvasLegend) {\r\n      const canvasHeight = canvas.height;\r\n      const canvasWidth = canvas.width;\r\n      const legendHeight = canvasLegend.height;\r\n      const legendWidth = canvasLegend.width;\r\n      // Move the legend to the correct position on the page\r\n      const offset = canvasHeight * 0.01;\r\n      let legendX: number;\r\n      let legendY: number;\r\n\r\n      if (legendPosition === 'bottomright') {\r\n        legendX = canvasWidth - legendWidth - offset;\r\n        legendY = canvasHeight - legendHeight - offset;\r\n      } else if (legendPosition === 'topright') {\r\n        legendX = canvasWidth - legendWidth - offset;\r\n        legendY = offset;\r\n      } else if (legendPosition === 'bottomleft') {\r\n        legendX = offset;\r\n        legendY = canvasHeight - legendHeight - offset - 15;\r\n      } else if (legendPosition === 'topleft') {\r\n        legendX = offset;\r\n        legendY = offset;\r\n      }\r\n\r\n      context.drawImage(canvasLegend, legendX, legendY, legendWidth, legendHeight);\r\n      context.strokeRect(legendX, legendY, legendWidth, legendHeight);\r\n      div.parentNode.removeChild(div); // remove temp div (IE style)\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private renderMap(map, size, extent) {\r\n    map.ol.updateSize();\r\n    map.ol.renderSync();\r\n  }\r\n\r\n  /**\r\n   * Save document\r\n   * @param  doc - Document to save\r\n   */\r\n  protected async saveDoc(doc: jsPDF) {\r\n    await doc.save('map_georef.pdf', { returnPromise: true });\r\n  }\r\n\r\n  /**\r\n   * Calculate the best Image size to fit in pdf\r\n   * @param doc - Pdf Document\r\n   * @param canvas - Canvas of image\r\n   * @param margins - Page margins\r\n   */\r\n  private getImageSizeToFitPdf(doc, canvas, margins) {\r\n    // Define variable to calculate best size to fit in one page\r\n    const pageHeight = doc.internal.pageSize.getHeight() - (margins[0] + margins[2] + 10);\r\n    const pageWidth = doc.internal.pageSize.getWidth() - (margins[1] + margins[3]);\r\n    const canHeight = this.pdf_units2points(canvas.height, 'mm');\r\n    const canWidth = this.pdf_units2points(canvas.width, 'mm');\r\n\r\n    const heightRatio = canHeight / pageHeight;\r\n    const widthRatio = canWidth / pageWidth;\r\n    const maxRatio = heightRatio > widthRatio ? heightRatio : widthRatio;\r\n    const imgHeigh = maxRatio > 1 ? canHeight / maxRatio : canHeight;\r\n    const imgWidth = maxRatio > 1 ? canWidth / maxRatio : canWidth;\r\n\r\n    return [imgWidth, imgHeigh];\r\n  }\r\n\r\n  /**\r\n   * Get a world file information for tiff\r\n   * @param  map - Map of the app\r\n   */\r\n  private getWorldFileInformation(map) {\r\n    const currentResolution = map.viewController.getResolution();\r\n    const currentExtent = map.viewController.getExtent(); // Return [minx, miny, maxx, maxy]\r\n    return [\r\n      currentResolution,\r\n      0,\r\n      0,\r\n      -currentResolution,\r\n      currentExtent[0] + currentResolution / 0.5,\r\n      currentExtent[3] - currentResolution / 0.5\r\n    ].join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Save canvas image as file\r\n   * @param canvas - Canvas to save\r\n   * @param name - Name of the file\r\n   * @param format - file format\r\n   */\r\n  private saveCanvasImageAsFile(canvas, nameWithExt, format) {\r\n    const blobFormat = 'image/' + format;\r\n    const that = this;\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      canvas.toBlob((blob) => {\r\n        // download image\r\n        saveAs(blob, nameWithExt);\r\n        that.saveFileProcessing();\r\n      }, blobFormat);\r\n    } catch (err) {\r\n      this.messageService.error('igo.geo.printForm.corsErrorMessageBody','igo.geo.printForm.corsErrorMessageHeader');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to a zip\r\n   * @param canvas - File to add to the zip\r\n   * @param  name -Name of the fileoverview\r\n   */\r\n  private generateCanvaFileToZip(canvas, name) {\r\n    const blobFormat = 'image/' + 'jpeg';\r\n    const that = this;\r\n    if (\r\n      !this.hasOwnProperty('zipFile') ||\r\n      typeof this.zipFile === 'undefined'\r\n    ) {\r\n      this.zipFile = new JSZip();\r\n    }\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      if (navigator.msSaveBlob) {\r\n        this.addFileToZip(name, canvas.msToBlob());\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          that.addFileToZip(name, blob);\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error('igo.geo.printForm.corsErrorMessageBody','igo.geo.printForm.corsErrorMessageHeader');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to zip, if all file are zipped, download\r\n   * @param name - Name of the files\r\n   * @param blob - Contain of file\r\n   */\r\n  private addFileToZip(name, blob) {\r\n    // add file to zip\r\n    this.zipFile.file(name, blob);\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Download zip file\r\n      this.getZipFile();\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  private saveFileProcessing() {\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the zipped file\r\n   * @return Retun a zip file\r\n   */\r\n  private getZipFile() {\r\n    const that = this;\r\n    this.zipFile.generateAsync({ type: 'blob' }).then((blob) => {\r\n      // 1) generate the zip file\r\n      saveAs(blob, 'map.zip');\r\n      delete that.zipFile;\r\n    });\r\n  }\r\n\r\n\r\n  private pdf_units2points(n, unit): number {\r\n    let k = 1;\r\n\r\n    // this code is borrowed from jsPDF\r\n    //  as it does not expose a public API\r\n    //  for converting units to points.\r\n    switch (unit) {\r\n        case 'pt':\r\n            k = 1;\r\n            break;\r\n        case 'mm':\r\n            k = 72 / 25.4;\r\n            break;\r\n        case 'cm':\r\n            k = 72 / 2.54;\r\n            break;\r\n        case 'in':\r\n            k = 72;\r\n            break;\r\n        case 'px':\r\n            k = 96 / 72;\r\n            break;\r\n        case 'pc':\r\n            k = 12;\r\n            break;\r\n        case 'em':\r\n            k = 12;\r\n            break;\r\n        case 'ex':\r\n            k = 6;\r\n            break;\r\n        default:\r\n            throw new Error('Invalid unit: ' + unit);\r\n    }\r\n\r\n    return n * k;\r\n  }\r\n\r\n}\r\n","import { Layer } from '../shared/layers/layer';\r\nimport { LegendMapViewOptions, OutputLayerLegend } from '../shared/layers/layer.interface';\r\n\r\n/**\r\n * Get all the layers legend\r\n * @return Array of legend\r\n */\r\nexport function getLayersLegends(layers: Layer[], view?: LegendMapViewOptions): OutputLayerLegend[] {\r\n  const legends = [];\r\n\r\n  for (const layer of layers) {\r\n    const legendOptions = layer.options.legendOptions;\r\n    if (layer.visible === false) { continue; }\r\n\r\n    const legendUrls = layer.dataSource.getLegend(undefined, view) || [];\r\n    for (const legendUrl of legendUrls) {\r\n      if (legendUrl.url === undefined) { continue; }\r\n\r\n      // Add legend info to the list\r\n      legends.push({\r\n        title: layer.title || '',\r\n        url: legendUrl.url,\r\n        display: legendOptions?.display === undefined ? true : legendOptions.display,\r\n        isInResolutionsRange: layer.isInResolutionsRange,\r\n      });\r\n    }\r\n  }\r\n\r\n  return legends;\r\n}\r\n","<form class=\"igo-form\" [formGroup]=\"form\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"title\"\r\n        placeholder=\"{{'igo.geo.printForm.title' | translate}}\">\r\n        <mat-error *ngIf=\"titleField.errors?.maxlength\">{{'igo.geo.formValidation.maxLength' | translate: { \r\n          column: 'igo.geo.printForm.title' | translate, \r\n          value: 130 } }}</mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"subtitle\"\r\n        placeholder=\"{{'igo.geo.printForm.subtitle' | translate}}\">\r\n        <mat-error *ngIf=\"subtitleField.errors?.maxlength\">{{'igo.geo.formValidation.maxLength' | translate: { \r\n          column: 'igo.geo.printForm.subtitle' | translate, \r\n          value: 120 } }}</mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"comment\"\r\n        placeholder=\"{{'igo.geo.printForm.comment' | translate}}\">\r\n        <mat-error *ngIf=\"commentField.errors?.maxlength\">{{'igo.geo.formValidation.maxLength' | translate: { \r\n          column: 'igo.geo.printForm.comment' | translate, \r\n          value: maxLength } }}</mat-error>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <div class=\"print-slide-toggle-container mat-typography\">\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showProjection\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showProjection' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showScale\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showScale' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"doZipFile\"\r\n        [labelPosition]=\"'before'\"\r\n        [style.display]=\"isPrintService ? 'none' : ''\">\r\n        {{'igo.geo.printForm.doZipFile' | translate}}\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"legendPosition\"\r\n        placeholder=\"{{'igo.geo.printForm.legendPosition' | translate}}\">\r\n        <mat-option *ngFor=\"let legendPosition of legendPositions | keyvalue \" [value]=\"legendPosition.key\">\r\n          <ng-container *ngIf=\"!['newpage', 'newimage'].includes(legendPosition.value)\">\r\n            {{'igo.geo.printForm.legendPositions.' + legendPosition.value | translate}}\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"['newpage', 'newimage'].includes(legendPosition.value)\">\r\n            {{ ((outputFormat === 'Pdf') ? 'igo.geo.printForm.legendPositions.newpage' : \r\n            'igo.geo.printForm.legendPositions.newimage') | translate}}\r\n          </ng-container>\r\n        </mat-option>\r\n\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select (selectionChange)=\"toggleImageSaveProp()\"\r\n        formControlName=\"outputFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.outputFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let outputFormat of outputFormats | keyvalue \" [value]=\"outputFormat.key\">\r\n            {{outputFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select (selectionChange)=\"changeCommentLength()\"\r\n        formControlName=\"paperFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.paperFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let paperFormat of paperFormats | keyvalue \" [value]=\"paperFormat.key\">\r\n          {{('igo.geo.printForm.paperFormats.' + paperFormat.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'none' : 'block'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"imageFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.imageFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let imageFormat of imageFormats | keyvalue \" [value]=\"imageFormat.key\">\r\n          {{imageFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" style=\"display: none;\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"resolution\"\r\n        placeholder=\"{{'igo.geo.printForm.resolution' | translate}}\">\r\n        <mat-option *ngFor=\"let resolution of resolutions | keyvalue \" [value]=\"resolution.key\">\r\n          {{resolution.value + ' PPI'}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select (selectionChange)=\"changeCommentLength()\"\r\n        formControlName=\"orientation\"\r\n        placeholder=\"{{'igo.geo.printForm.orientation' | translate}}\">\r\n        <mat-option *ngFor=\"let orientation of orientations | keyvalue \" [value]=\"orientation.key\">\r\n          {{('igo.geo.printForm.' + orientation.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group print-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (disabled$ | async)\"\r\n      (click)=\"handleFormSubmit(form.value, form.valid)\">\r\n      {{'igo.geo.printForm.saveBtn' | translate}}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n","import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';\r\nimport {\r\n  UntypedFormGroup,\r\n  UntypedFormBuilder,\r\n  UntypedFormControl,\r\n  Validators\r\n} from '@angular/forms';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\n@Component({\r\n  selector: 'igo-print-form',\r\n  templateUrl: './print-form.component.html',\r\n  styleUrls: ['./print-form.component.scss']\r\n})\r\nexport class PrintFormComponent implements OnInit {\r\n  public form: UntypedFormGroup;\r\n  public outputFormats = PrintOutputFormat;\r\n  public paperFormats = PrintPaperFormat;\r\n  public orientations = PrintOrientation;\r\n  public resolutions = PrintResolution;\r\n  public imageFormats = PrintSaveImageFormat;\r\n  public legendPositions = PrintLegendPosition;\r\n  public isPrintService = true;\r\n\r\n  @Input() disabled$: BehaviorSubject<boolean>;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this.imageFormatField.value;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this.imageFormatField.setValue(value || PrintSaveImageFormat.Jpeg, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this.outputFormatField.value;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this.outputFormatField.setValue(value || PrintOutputFormat.Pdf, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this.paperFormatField.value;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this.paperFormatField.setValue(value || PrintPaperFormat.Letter, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this.orientationField.value;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this.orientationField.setValue(value || PrintOrientation.landscape, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this.resolutionField.value;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this.resolutionField.setValue(value || PrintResolution['96'], {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this.legendPositionField.value;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this.legendPositionField.setValue(value || PrintLegendPosition.none, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get title(): string {\r\n    return this.titleField.value;\r\n  }\r\n  set title(value: string) {\r\n    this.titleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get subtitle(): string {\r\n    return this.subtitleField.value;\r\n  }\r\n  set subtitle(value: string) {\r\n    this.subtitleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get comment(): string {\r\n    return this.commentField.value;\r\n  }\r\n  set comment(value: string) {\r\n    this.commentField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showProjection(): boolean {\r\n    return this.showProjectionField.value;\r\n  }\r\n  set showProjection(value: boolean) {\r\n    this.showProjectionField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showScale(): boolean {\r\n    return this.showScaleField.value;\r\n  }\r\n  set showScale(value: boolean) {\r\n    this.showScaleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showLegend(): boolean {\r\n    return this.showLegendField.value;\r\n  }\r\n  set showLegend(value: boolean) {\r\n    this.showLegendField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  @Input()\r\n  get doZipFile(): boolean {\r\n    return this.doZipFileField.value;\r\n  }\r\n  set doZipFile(value: boolean) {\r\n    this.doZipFileField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  get outputFormatField() {\r\n    return (this.form.controls as any).outputFormat as UntypedFormControl;\r\n  }\r\n\r\n  get paperFormatField() {\r\n    return (this.form.controls as any).paperFormat as UntypedFormControl;\r\n  }\r\n\r\n  get imageFormatField() {\r\n    return (this.form.controls as any).imageFormat as UntypedFormControl;\r\n  }\r\n\r\n  get orientationField() {\r\n    return (this.form.controls as any).orientation as UntypedFormControl;\r\n  }\r\n\r\n  get resolutionField() {\r\n    return (this.form.controls as any).resolution as UntypedFormControl;\r\n  }\r\n\r\n  get commentField() {\r\n    return (this.form.controls as any).comment as UntypedFormControl;\r\n  }\r\n\r\n  get showProjectionField() {\r\n    return (this.form.controls as any).showProjection as UntypedFormControl;\r\n  }\r\n\r\n  get showScaleField() {\r\n    return (this.form.controls as any).showScale as UntypedFormControl;\r\n  }\r\n\r\n  get showLegendField() {\r\n    return (this.form.controls as any).showLegend as UntypedFormControl;\r\n  }\r\n\r\n  get doZipFileField() {\r\n    return (this.form.controls as any).doZipFile as UntypedFormControl;\r\n  }\r\n\r\n  get titleField() {\r\n    return (this.form.controls as any).title as UntypedFormControl;\r\n  }\r\n\r\n  get subtitleField() {\r\n    return (this.form.controls as any).subtitle as UntypedFormControl;\r\n  }\r\n\r\n  get legendPositionField() {\r\n    return (this.form.controls as any).legendPosition as UntypedFormControl;\r\n  }\r\n\r\n  @Output() submit: EventEmitter<PrintOptions> = new EventEmitter();\r\n\r\n  maxLength: number = 180;\r\n\r\n  constructor(private formBuilder: UntypedFormBuilder) {\r\n    this.form = this.formBuilder.group({\r\n      title: ['', [Validators.minLength(0), Validators.maxLength(130)]],\r\n      subtitle: ['', [Validators.minLength(0), Validators.maxLength(120)]],\r\n      comment: ['', [Validators.minLength(0), Validators.maxLength(this.maxLength)]],\r\n      outputFormat: ['', [Validators.required]],\r\n      paperFormat: ['', [Validators.required]],\r\n      imageFormat: [ '', [Validators.required]],\r\n      resolution: ['', [Validators.required]],\r\n      orientation: ['', [Validators.required]],\r\n      legendPosition: ['', [Validators.required]],\r\n      showProjection: false,\r\n      showScale: false,\r\n      showLegend: false,\r\n      doZipFile: [{hidden: this.isPrintService }]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.doZipFileField.setValue(false);\r\n  }\r\n\r\n  handleFormSubmit(data: PrintOptions, isValid: boolean) {\r\n    data.isPrintService = this.isPrintService;\r\n    if (isValid) {\r\n      this.submit.emit(data);\r\n    }\r\n  }\r\n\r\n  toggleImageSaveProp() {\r\n    if (this.outputFormatField.value === 'Image') {\r\n      this.isPrintService = false;\r\n      this.commentField.clearValidators();\r\n      this.commentField.updateValueAndValidity();\r\n    } else {\r\n      this.isPrintService = true;\r\n    }\r\n  }\r\n\r\n  changeCommentLength() {\r\n    switch (this.paperFormat) {\r\n      case PrintPaperFormat.A0:\r\n        // A0, landscape, length 900 | A0, portrait, comment length:  600\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 900 : 600;\r\n        break;\r\n      case PrintPaperFormat.A1:\r\n        // A1, landscape, length 600 | A1, portrait, length 400;\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 600 : 400;\r\n        break;\r\n      case PrintPaperFormat.A2:\r\n        // A2, landscape, length 400 | A2, portrait, length 300;\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 400 : 300;\r\n        break;\r\n      case PrintPaperFormat.A3:\r\n        // A3, landscape, length 300 | A3, portrait, length 200;\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 300 : 200;\r\n        break;\r\n      case PrintPaperFormat.A4:\r\n        // A4, landscape length 200 | A4, portrait length 120;\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 200 : 100;\r\n        break;\r\n      case PrintPaperFormat.A5:\r\n        // A5, landscape length 120 | A5, portrait length 80;\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 120 : 80;\r\n        break;\r\n      case PrintPaperFormat.Letter:\r\n        // lettre, landscape, 180 | lettre, portrait, 140\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 180 : 140;\r\n        break;\r\n      default:\r\n        // legal, landscape, 200 | legal, portrait, 140\r\n        this.maxLength = (this.orientation === PrintOrientation.landscape) ? 200 : 140;\r\n        break;\r\n    }\r\n\r\n    this.commentField.setValidators([Validators.maxLength(this.maxLength)]​);\r\n    this.commentField.updateValueAndValidity();\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\nimport { PrintService } from '../shared/print.service';\r\n\r\n@Component({\r\n  selector: 'igo-print',\r\n  templateUrl: './print.component.html'\r\n})\r\nexport class PrintComponent {\r\n  public disabled$ = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this._outputFormat;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this._outputFormat = value;\r\n  }\r\n  private _outputFormat: PrintOutputFormat;\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this._paperFormat;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this._paperFormat = value;\r\n  }\r\n  private _paperFormat: PrintPaperFormat;\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this._orientation;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this._orientation = value;\r\n  }\r\n  private _orientation: PrintOrientation;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this._imageFormat;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this._imageFormat = value;\r\n  }\r\n  private _imageFormat: PrintSaveImageFormat;\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this._legendPosition;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this._legendPosition = value;\r\n  }\r\n  private _legendPosition: PrintLegendPosition;\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this._resolution;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this._resolution = value;\r\n  }\r\n  private _resolution: PrintResolution;\r\n\r\n  constructor(private printService: PrintService) {}\r\n\r\n  handleFormSubmit(data: PrintOptions) {\r\n\r\n    this.disabled$.next(true);\r\n\r\n    if (data.isPrintService === true) {\r\n      this.printService\r\n        .print(this.map, data)\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          this.disabled$.next(false);\r\n        });\r\n    } else {\r\n      let nbFileToProcess = 1;\r\n\r\n      if (data.showLegend) {\r\n        nbFileToProcess++;\r\n      }\r\n      if (data.imageFormat.toLowerCase() === 'tiff') {\r\n        nbFileToProcess++;\r\n      }\r\n\r\n      if (data.legendPosition === 'newpage') {\r\n        nbFileToProcess++;\r\n      }\r\n\r\n      this.printService.defineNbFileToProcess(nbFileToProcess);\r\n\r\n      const resolution = +data.resolution;\r\n\r\n      this.printService\r\n        .downloadMapImage(\r\n          this.map,\r\n          resolution,\r\n          data.imageFormat,\r\n          data.showProjection,\r\n          data.showScale,\r\n          data.title,\r\n          data.subtitle,\r\n          data.comment,\r\n          data.doZipFile,\r\n          data.legendPosition\r\n        )\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          this.disabled$.next(false);\r\n        });\r\n    }\r\n  }\r\n}\r\n","<igo-print-form\r\n  [outputFormat]=\"outputFormat\"\r\n  [paperFormat]=\"paperFormat\"\r\n  [orientation]=\"orientation\"\r\n  [imageFormat]=\"imageFormat\"\r\n  [resolution]=\"resolution\"\r\n  [legendPosition]=\"legendPosition\"\r\n  [disabled$]=\"disabled$\"\r\n  (submit)=\"handleFormSubmit($event)\">\r\n</igo-print-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule } from '@igo2/common';\r\n\r\nimport { PrintComponent } from './print/print.component';\r\nimport { PrintFormComponent } from './print-form/print-form.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule\r\n  ],\r\n  exports: [PrintComponent, PrintFormComponent],\r\n  declarations: [PrintComponent, PrintFormComponent]\r\n})\r\nexport class IgoPrintModule {}\r\n","import { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\n\r\nimport { QuerySearchSource } from './query-search-source';\r\n\r\n/**\r\n * Map search source factory\r\n * @ignore\r\n */\r\nexport function querySearchSourceFactory(config: ConfigService) {\r\n  return new QuerySearchSource(\r\n    config.getConfig(`searchSources.${QuerySearchSource.id}`) || {}\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the map search source\r\n */\r\nexport function provideQuerySearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: querySearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule, IgoMessageModule } from '@igo2/core';\r\n\r\nimport { QueryDirective } from './shared/query.directive';\r\nimport { QueryService } from './shared/query.service';\r\nimport { provideQuerySearchSource } from './shared/query-search-source.providers';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, IgoLanguageModule, IgoMessageModule],\r\n  exports: [QueryDirective],\r\n  declarations: [QueryDirective],\r\n  providers: [QueryService]\r\n})\r\nexport class IgoQueryModule {\r\n  static forRoot(): ModuleWithProviders<IgoQueryModule> {\r\n    return {\r\n      ngModule: IgoQueryModule,\r\n      providers: [provideQuerySearchSource()]\r\n    };\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\n\r\nexport abstract class DirectionsSource {\r\n  abstract enabled: boolean;\r\n  abstract getName(): string;\r\n  abstract route(coordinates: [number, number][], directionsOptions: DirectionOptions): Observable<Direction[]>;\r\n}\r\n","import { DirectionsSource } from '../directions-sources/directions-source';\r\n\r\nexport class DirectionsSourceService {\r\n  constructor(public sources: DirectionsSource[]) {}\r\n}\r\n\r\nexport function directionsSourceServiceFactory(sources: DirectionsSource[]) {\r\n  return new DirectionsSourceService(sources);\r\n}\r\n\r\nexport function provideDirectionsSourceService() {\r\n  return {\r\n    provide: DirectionsSourceService,\r\n    useFactory: directionsSourceServiceFactory,\r\n    deps: [DirectionsSource]\r\n  };\r\n}\r\n","export enum DirectionsFormat {\r\n  GeoJSON,\r\n  JSON\r\n}\r\nexport enum SourceDirectionsType {\r\n  Route = 'route',\r\n  Trip = 'trip'\r\n}\r\n\r\nexport enum ProposalType {\r\n  Coord = 'coord',\r\n  Text = 'text'\r\n}\r\n\r\nexport enum DirectionType {\r\n  Stop = 'stop',\r\n  Route = 'route',\r\n  Vertex = 'vertex'\r\n}\r\n\r\nexport enum DirectionRelativePositionType {\r\n  Start = 'start',\r\n  Intermediate = 'intermediate',\r\n  End = 'end'\r\n}\r\n","import olFeature from 'ol/Feature';\r\nimport * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olGeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olProj from 'ol/proj';\r\n\r\nimport { uuid, NumberUtils } from '@igo2/utils';\r\n\r\nimport { Direction, FeatureWithDirection, FeatureWithStop, Stop } from './directions.interface';\r\nimport { createOverlayMarkerStyle } from '../../style/shared/overlay/overlay-marker-style.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { tryAddLoadingStrategy } from '../../feature/shared/strategies.utils';\r\nimport { FeatureStoreLoadingStrategy } from '../../feature/shared/strategies/loading';\r\nimport { FEATURE, FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { DirectionRelativePositionType, DirectionType } from './directions.enum';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './store';\r\n\r\n/**\r\n * Function that updat the sort of the list base on the provided field.\r\n * @param source stop store\r\n * @param direction asc / desc sort order\r\n * @param field the field to use to sort the view\r\n */\r\nexport function updateStoreSorting(stopsStore: StopsStore, direction: 'asc' | 'desc' = 'asc', field = 'position') {\r\n  stopsStore.view.sort({\r\n    direction,\r\n    valueAccessor: (entity: Stop) => entity[field]\r\n  });\r\n}\r\n\r\nexport function computeRelativePosition(index: number, totalLength): DirectionRelativePositionType {\r\n  let relativePosition = DirectionRelativePositionType.Intermediate;\r\n  if (index === 0) {\r\n    relativePosition = DirectionRelativePositionType.Start;\r\n  } else if (index === totalLength - 1) {\r\n    relativePosition = DirectionRelativePositionType.End;\r\n  }\r\n  return relativePosition;\r\n}\r\n\r\nexport function computeStopsPosition(stopsStore: StopsStore) {\r\n\r\n  const stopsToComputePosition = [...stopsStore.all()];\r\n  stopsToComputePosition.sort((a, b) => a.position - b.position);\r\n  stopsToComputePosition.map((stop, i) => {\r\n    stop.position = i;\r\n    stop.relativePosition = computeRelativePosition(stop.position, stopsToComputePosition.length);\r\n  });\r\n  if (stopsToComputePosition) {\r\n    stopsStore.updateMany(stopsToComputePosition);\r\n  }\r\n}\r\n\r\n/**\r\n * Function that add a stop to the stop store. Stop are always added before the last stop.\r\n * @param stopsStore stop store as an EntityStore\r\n */\r\nexport function addStopToStore(stopsStore: StopsStore): Stop {\r\n\r\n  const id = uuid();\r\n  const stops = stopsStore.all();\r\n  let positions: number[];\r\n  if (stopsStore.count === 0) {\r\n    positions = [0];\r\n  } else {\r\n    positions = stops.map(stop => stop.position);\r\n  }\r\n  const maxPosition: number = Math.max(...positions);\r\n  const insertPosition: number = maxPosition;\r\n  const lastPosition: number = maxPosition + 1;\r\n\r\n  const stopToUpdate = stopsStore.all().find(stop => stop.position === maxPosition);\r\n  if (stopToUpdate) {\r\n    stopToUpdate.position = lastPosition;\r\n    stopToUpdate.relativePosition = computeRelativePosition(lastPosition, stopsStore.count + 1);\r\n  }\r\n\r\n  stopsStore.insert({ id, position: insertPosition, relativePosition: computeRelativePosition(insertPosition, stopsStore.count + 1) });\r\n\r\n  updateStoreSorting(stopsStore);\r\n  return stopsStore.get(id);\r\n}\r\n\r\nexport function removeStopFromStore(stopsStore: StopsStore, stop: Stop) {\r\n  stopsStore.delete(stop);\r\n  computeStopsPosition(stopsStore);\r\n}\r\n\r\n/**\r\n * Create a style for the directions stops and routes\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function directionsStyle(\r\n  feature: olFeature<OlGeometry>,\r\n  resolution: number\r\n): olStyle.Style | olStyle.Style[] {\r\n  const vertexStyle = [\r\n    new olStyle.Style({\r\n      geometry: feature.getGeometry(),\r\n      image: new olStyle.Circle({\r\n        radius: 7,\r\n        stroke: new olStyle.Stroke({ color: '#FF0000', width: 3 })\r\n      })\r\n    })\r\n  ];\r\n\r\n  const stopStyle = createOverlayMarkerStyle({\r\n    text: feature.get('stopText'),\r\n    opacity: feature.get('stopOpacity'),\r\n    markerColor: feature.get('stopColor'),\r\n    markerOutlineColor: [255, 255, 255]\r\n  });\r\n\r\n  const routeStyle = [\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(106, 121, 130, ${feature.get('active') ? 0.75 : 0})`, width: 10 })\r\n    }),\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(79, 169, 221, ${feature.get('active') ? 0.75 : 0})`, width: 6 })\r\n    })\r\n  ];\r\n\r\n  if (feature.get('type') === DirectionType.Stop) {\r\n    return stopStyle;\r\n  }\r\n  if (feature.get('type') === 'vertex') {\r\n    return vertexStyle;\r\n  }\r\n  if (feature.get('type') === DirectionType.Route) {\r\n    return routeStyle;\r\n  }\r\n}\r\n\r\nexport function initStopsFeatureStore(stopsFeatureStore: StopsFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stopsLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-stops-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.stopLayer'),\r\n    zIndex: 911,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-stops-layer',\r\n      links: [\r\n        {\r\n          syncedDelete: true,\r\n          linkedIds: ['igo-direction-route-layer'],\r\n          properties: []\r\n        }\r\n      ]\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stopsFeatureStore, stopsLayer);\r\n  stopsFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stopsFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initRoutesFeatureStore(routesFeatureStore: RoutesFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const routeLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-route-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.routeLayer'),\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(routesFeatureStore, routeLayer);\r\n  routesFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(routesFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initStepFeatureStore(stepFeatureStore: StepFeatureStore) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stepLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-step-layer',\r\n    title: '',\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: false,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: false,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stepFeatureStore, stepLayer);\r\n  stepFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stepFeatureStore, loadingStrategy);\r\n}\r\n\r\n\r\nexport function addStopToStopsFeatureStore(\r\n  stop: Stop,\r\n  stopsStore: StopsStore,\r\n  stopsFeatureStore: StopsFeatureStore,\r\n  projection: string,\r\n  languageService: LanguageService) {\r\n  let stopColor;\r\n  let stopText;\r\n\r\n\r\n  switch (stop.relativePosition) {\r\n    case DirectionRelativePositionType.Start:\r\n      stopColor = '#008000';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.start');\r\n      break;\r\n    case DirectionRelativePositionType.End:\r\n      stopColor = '#f64139';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.end');\r\n      break;\r\n    default:\r\n      stopColor = '#ffd700';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.intermediate') + ' #' + stop.position;\r\n      break;\r\n  }\r\n\r\n  const geometry = new olGeom.Point(\r\n    olProj.transform(stop.coordinates, projection, stopsFeatureStore.map.projection)\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: stopsFeatureStore.map.projection,\r\n    dataProjection: stopsFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n  const previousStop = stopsFeatureStore.get(stop.id);\r\n  const previousStopRevision = previousStop ? previousStop.meta.revision : 0;\r\n\r\n  const stopFeatureStore: FeatureWithStop = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: stopsFeatureStore.map.projection,\r\n    properties: {\r\n      id: stop.id,\r\n      type: DirectionType.Stop,\r\n      stopText,\r\n      stopColor,\r\n      stopOpacity: 1,\r\n      stop\r\n    },\r\n    meta: {\r\n      id: stop.id,\r\n      revision: previousStopRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  stopsFeatureStore.update(stopFeatureStore);\r\n}\r\n\r\nexport function addDirectionToRoutesFeatureStore(\r\n  routesFeatureStore: RoutesFeatureStore,\r\n  direction: Direction,\r\n  projection: string,\r\n  active: boolean = false,\r\n  moveToExtent = false) {\r\n  const geom = direction.geometry.coordinates;\r\n  const geometry4326 = new olGeom.LineString(geom);\r\n  const geometry = geometry4326.transform(\r\n    projection,\r\n    routesFeatureStore.map.projection\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: routesFeatureStore.map.projection,\r\n    dataProjection: routesFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n\r\n  const previousRoute = routesFeatureStore.get(direction.id);\r\n  const previousRouteRevision = previousRoute\r\n    ? previousRoute.meta.revision\r\n    : 0;\r\n\r\n  const routeFeatureStore: FeatureWithDirection = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: routesFeatureStore.map.projection,\r\n    properties: {\r\n      id: direction.id,\r\n      type: DirectionType.Route,\r\n      active,\r\n      direction\r\n    },\r\n    meta: {\r\n      id: direction.id,\r\n      revision: previousRouteRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  routesFeatureStore.update(routeFeatureStore);\r\n}\r\n\r\nexport function formatDistance(distance: number): string {\r\n  if (distance === 0) {\r\n    return;\r\n  }\r\n  if (distance >= 100000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 1000, 1) + ' km';\r\n  }\r\n  if (distance >= 10000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  if (distance >= 1000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  return NumberUtils.roundToNDecimal(distance, 0) + ' m';\r\n}\r\n\r\nexport function formatDuration(duration: number): string {\r\n  if (duration >= 3600) {\r\n    const hour = Math.floor(duration / 3600);\r\n    const minute = Math.round((duration / 3600 - hour) * 60);\r\n    if (minute === 60) {\r\n      return hour + 1 + ' h';\r\n    }\r\n    return hour + ' h ' + minute + ' min';\r\n  }\r\n\r\n  if (duration >= 60) {\r\n    return Math.round(duration / 60) + ' min';\r\n  }\r\n  return duration + ' s';\r\n}\r\n\r\nexport function formatInstruction(\r\n  type,\r\n  modifier,\r\n  route,\r\n  direction,\r\n  stepPosition,\r\n  exit,\r\n  languageService: LanguageService,\r\n  lastStep = false\r\n) {\r\n  const translate = languageService.translate;\r\n  let directive;\r\n  let image = 'forward';\r\n  let cssClass = 'rotate-270';\r\n  const translatedDirection = translateBearing(direction, languageService);\r\n  const translatedModifier = translateModifier(modifier, languageService);\r\n  const prefix = modifier === 'straight' ? '' : translate.instant('igo.geo.directions.modifier.prefix');\r\n\r\n  let aggregatedDirection = prefix + translatedModifier;\r\n\r\n\r\n  if (modifier?.search('slight') >= 0) {\r\n    aggregatedDirection = translatedModifier;\r\n  }\r\n\r\n  if (modifier === 'uturn') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-90';\r\n  } else if (modifier === 'sharp right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'slight right') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-290';\r\n  } else if (modifier === 'straight') {\r\n    image = 'forward';\r\n  } else if (modifier === 'slight left') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-250';\r\n  } else if (modifier === 'left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'sharp left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  }\r\n\r\n  if (type === 'turn') {\r\n    if (modifier === 'straight') {\r\n      directive = translate.instant('igo.geo.directions.turn.straight', { route });\r\n    } else if (modifier === 'uturn') {\r\n      directive = translate.instant('igo.geo.directions.turn.uturn', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.turn.else', { route, aggregatedDirection, translatedModifier });\r\n    }\r\n  } else if (type === 'new name') {\r\n    directive = translate.instant('igo.geo.directions.new name', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'depart') {\r\n    directive = translate.instant('igo.geo.directions.depart', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'arrive') {\r\n    if (lastStep) {\r\n      const coma = !translatedModifier ? '' : ', ';\r\n      aggregatedDirection = !translatedModifier ? '' : aggregatedDirection;\r\n      directive = translate.instant('igo.geo.directions.arrive.lastStep', { coma, aggregatedDirection });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.arrive.intermediate', { route });\r\n      image = 'map-marker';\r\n      cssClass = '';\r\n    }\r\n  } else if (type === 'merge') {\r\n    directive = translate.instant('igo.geo.directions.merge', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'on ramp') {\r\n    directive = translate.instant('igo.geo.directions.on ramp', { aggregatedDirection });\r\n  } else if (type === 'off ramp') {\r\n    directive = translate.instant('igo.geo.directions.off ramp', { aggregatedDirection });\r\n  } else if (type === 'fork') {\r\n    if (modifier.search('left') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.left', { route });\r\n    } else if (modifier.search('right') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.right', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.fork.else', { route });\r\n    }\r\n  } else if (type === 'end of road') {\r\n    directive = translate.instant('igo.geo.directions.end of road', { translatedModifier, route });\r\n  } else if (type === 'use lane') {\r\n    directive = translate.instant('igo.geo.directions.use lane');\r\n  } else if (type === 'continue' && modifier !== 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.continue.notUturn', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'roundabout') {\r\n    const cntSuffix = exit === 1 ?\r\n      translate.instant('igo.geo.directions.cntSuffix.first') :\r\n      translate.instant('igo.geo.directions.cntSuffix.secondAndMore');\r\n    directive = translate.instant('igo.geo.directions.roundabout', { exit, cntSuffix, route });\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'rotary') {\r\n    directive = translate.instant('igo.geo.directions.rotary');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'roundabout turn') {\r\n    directive = translate.instant('igo.geo.directions.roundabout turn');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'exit roundabout') {\r\n    directive = translate.instant('igo.geo.directions.exit roundabout', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'notification') {\r\n    directive = translate.instant('igo.geo.directions.notification');\r\n  } else if (modifier === 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.uturnText', { translatedDirection, route });\r\n  } else {\r\n    directive = translate.instant('igo.geo.directions.unknown');\r\n  }\r\n\r\n  image = lastStep ? 'flag-variant' : image;\r\n  cssClass = lastStep ? '' : cssClass;\r\n  image = stepPosition === 0 ? 'compass' : image;\r\n  cssClass = stepPosition === 0 ? '' : cssClass;\r\n\r\n  return { instruction: directive, image, cssClass };\r\n}\r\n\r\nexport function translateModifier(modifier, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (modifier === 'uturn') {\r\n    return translate.instant('igo.geo.directions.uturn');\r\n  } else if (modifier === 'sharp right') {\r\n    return translate.instant('igo.geo.directions.sharp right');\r\n  } else if (modifier === 'right') {\r\n    return translate.instant('igo.geo.directions.right');\r\n  } else if (modifier === 'slight right') {\r\n    return translate.instant('igo.geo.directions.slight right');\r\n  } else if (modifier === 'sharp left') {\r\n    return languageService.translate.instant('igo.geo.directions.sharp left');\r\n  } else if (modifier === 'left') {\r\n    return languageService.translate.instant('igo.geo.directions.left');\r\n  } else if (modifier === 'slight left') {\r\n    return languageService.translate.instant('igo.geo.directions.slight left');\r\n  } else if (modifier === 'straight') {\r\n    return languageService.translate.instant('igo.geo.directions.straight');\r\n  } else {\r\n    return modifier;\r\n  }\r\n}\r\n\r\nexport function translateBearing(bearing: number, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (bearing >= 337 || bearing < 23) {\r\n    return translate.instant('igo.geo.cardinalPoints.n');\r\n  } else if (bearing < 67) {\r\n    return translate.instant('igo.geo.cardinalPoints.ne');\r\n  } else if (bearing < 113) {\r\n    return translate.instant('igo.geo.cardinalPoints.e');\r\n  } else if (bearing < 157) {\r\n    return translate.instant('igo.geo.cardinalPoints.se');\r\n  } else if (bearing < 203) {\r\n    return translate.instant('igo.geo.cardinalPoints.s');\r\n  } else if (bearing < 247) {\r\n    return translate.instant('igo.geo.cardinalPoints.sw');\r\n  } else if (bearing < 293) {\r\n    return translate.instant('igo.geo.cardinalPoints.w');\r\n  } else if (bearing < 337) {\r\n    return translate.instant('igo.geo.cardinalPoints.nw');\r\n  } else {\r\n    return;\r\n  }\r\n}\r\n\r\n\r\n","<div cdkDropList class=\"stops-list\" (cdkDropListDropped)=\"drop($event)\">\r\n  <div touchleave  \r\n  (touchenter)=\"onStopEnter(stop)\"\r\n  (touchleave)=\"onStopLeave()\"\r\n  (mouseover)=\"onStopEnter(stop)\"\r\n  (mouseleave)=\"onStopLeave()\"\r\n  (cdkDragStarted)=\"stopIsDragged=true\"\r\n  (cdkDragEnded)=\"stopIsDragged=false\"\r\n  cdkDragLockAxis=\"y\" class=\"stop-box mat-typography\" *ngFor=\"let stop of stopsStore.view.all$() | async; let i = index;\" cdkDrag>\r\n    <div [ngClass]=\"getNgClass(stop)\">\r\n      <mat-form-field>\r\n        <input id=\"{{stop.id}}\" type=\"text\"\r\n            [placeholder]=\"getPlaceholder(stop)\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"stop.text\"\r\n            aria-label=\"Number\"\r\n            matInput\r\n            (focus)=\"onInputFocus(stop)\"\r\n            [(ngModel)]=\"stop.text\"\r\n            (keyup)=\"setStopText($event,stop)\"\r\n            (keydown.enter)=\"$event.preventDefault()\"\r\n            [matAutocomplete]=\"auto\">\r\n        <button \r\n            mat-button \r\n            *ngIf=\"(stop.text || stop.coordinates) && stopWithHover && stop.id===stopWithHover.id\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"'igo.geo.directionsForm.clearStop' | translate\"\r\n            matSuffix mat-icon-button color=\"warn\" aria-label=\"Clear\" (click)=\"clearStop(stop)\">\r\n            <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      \r\n        <mat-autocomplete [displayWith]=\"getOptionText\" #auto=\"matAutocomplete\" (optionSelected)=\"chooseProposal($event,stop)\">\r\n          <mat-optgroup *ngFor=\"let source of stop.searchProposals\" [label]=\"source.source.title\" [disabled]=\"source.source.enabled === false\">\r\n          <mat-option *ngFor=\"let result of source.results\" [value]=\"result\" \r\n          matTooltipShowDelay=\"500\" [matTooltip]=\"result.meta ? result.meta.title : ''\">\r\n            {{ result.meta ? result.meta.title : '' }}\r\n          </mat-option>\r\n          </mat-optgroup>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n\r\n\r\n\r\n    <div class=\"igo-form-button-group\" *ngIf=\"!stopIsDragged && stopWithHover && stop.id === stopWithHover.id\">\r\n      <button class=\"swipe-vertical\" cdkDragHandle mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.moveStop' | translate\" color=\"primary\">\r\n        <mat-icon svgIcon=\"gesture-swipe-vertical\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"(stopsStore.count$ | async)> 2\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\" (click)=\"removeStop(stop)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n      <button *ngIf=\"(stopsStore.count$ | async)<= 2\" disabled=\"true\" mat-icon-button tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\">\r\n        <mat-icon svgIcon=\"blank\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n</div>","import { Component, EventEmitter, Input, OnDestroy, Output } from '@angular/core';\r\nimport { CdkDragDrop, moveItemInArray } from '@angular/cdk/drag-drop';\r\n\r\nimport * as olProj from 'ol/proj';\r\nimport * as olObservable from 'ol/Observable';\r\n\r\nimport { Stop } from '../shared/directions.interface';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport pointOnFeature from '@turf/point-on-feature';\r\nimport { computeRelativePosition, removeStopFromStore, updateStoreSorting } from '../shared/directions.utils';\r\nimport { MatAutocomplete } from '@angular/material/autocomplete';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { StopsFeatureStore, StopsStore } from '../shared/store';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { DirectionRelativePositionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-inputs',\r\n  templateUrl: './directions-inputs.component.html',\r\n  styleUrls: ['./directions-inputs.component.scss']\r\n})\r\nexport class DirectionsInputsComponent implements OnDestroy {\r\n\r\n  private readonly invalidKeys = ['Control', 'Shift', 'Alt'];\r\n  private onMapClickEventKeys = [];\r\n  public stopWithHover: Stop;\r\n  public stopIsDragged: boolean = false;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() projection: string;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n\r\n  @Output() stopInputHasFocus: EventEmitter<boolean> = new EventEmitter<boolean>(false);\r\n  constructor(private languageService: LanguageService) { }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unlistenMapSingleClick();\r\n  }\r\n  onStopEnter(stop: Stop) {\r\n    this.stopWithHover = stop;\r\n  }\r\n  onStopLeave() {\r\n    this.stopWithHover = undefined;\r\n  }\r\n\r\n  getOptionText(option) {\r\n    if (option instanceof Object) {\r\n      return option?.meta ? option.meta.title : '';\r\n    }\r\n    return option;\r\n  }\r\n\r\n  chooseProposal(event: { source: MatAutocomplete, option: MatOption }, stop: Stop) {\r\n    const result: Feature = event.option.value;\r\n    if (result) {\r\n      let geomCoord;\r\n      const geom = result.geometry;\r\n      if (geom.type === 'Point') {\r\n        geomCoord = geom.coordinates;\r\n      } else {\r\n        const point = pointOnFeature(result.geometry);\r\n        geomCoord = [\r\n          point.geometry.coordinates[0],\r\n          point.geometry.coordinates[1]\r\n        ];\r\n      }\r\n      if (geomCoord) {\r\n        stop.coordinates = geomCoord;\r\n        stop.text = result.meta.title;\r\n        this.stopsStore.update(stop);\r\n      }\r\n    }\r\n  }\r\n\r\n  setStopText(event: KeyboardEvent, stop: Stop) {\r\n    this.unlistenMapSingleClick();\r\n    const term = (event.target as HTMLInputElement).value;\r\n    if (term.length === 0) {\r\n      this.clearStop(stop);\r\n    } else if (this.validateTerm(term)) {\r\n      stop.text = term;\r\n      this.stopsStore.update(stop);\r\n    }\r\n  }\r\n\r\n  validateTerm(term: string) {\r\n    if (\r\n      this.keyIsValid(term) &&\r\n      (term.length >= this.length || term.length === 0)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private keyIsValid(key: string) {\r\n    return this.invalidKeys.find(value => value === key) === undefined;\r\n  }\r\n\r\n  getNgClass(stop: Stop): string {\r\n    if (!this.stopWithHover) {\r\n      return 'igo-input-container';\r\n    } else if (stop.id === this.stopWithHover.id) {\r\n      return 'igo-input-container reduce';\r\n    } else {\r\n      return 'igo-input-container';\r\n    }\r\n  }\r\n\r\n  getPlaceholder(stop: Stop): string {\r\n    let extra = '';\r\n    if (stop.relativePosition) {\r\n      if (stop.relativePosition === DirectionRelativePositionType.Intermediate) {\r\n        extra = ' #' + stop.position;\r\n      }\r\n      return this.languageService.translate.instant('igo.geo.directionsForm.' + stop.relativePosition) + extra;\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  removeStop(stop: Stop) {\r\n    removeStopFromStore(this.stopsStore, stop);\r\n  }\r\n\r\n  clearStop(stop: Stop) {\r\n    this.stopsStore.update({ id: stop.id, relativePosition: stop.relativePosition, position: stop.position });\r\n  }\r\n\r\n  drop(event: CdkDragDrop<string[]>) {\r\n    this.moveStops(event.previousIndex, event.currentIndex);\r\n  }\r\n\r\n  private moveStops(fromIndex, toIndex) {\r\n    if (fromIndex !== toIndex) {\r\n      const stops = [...this.stopsStore.view.all()];\r\n      moveItemInArray(stops, fromIndex, toIndex);\r\n      stops.map((stop, i) => {\r\n        stop.relativePosition = computeRelativePosition(i, stops.length);\r\n        stop.position = i;\r\n      });\r\n      this.stopsStore.updateMany(stops);\r\n      updateStoreSorting(this.stopsStore);\r\n    }\r\n  }\r\n\r\n  onInputFocus(stop: Stop) {\r\n    if (!stop.text || stop.text?.length === 0) {\r\n      this.unlistenMapSingleClick();\r\n      this.stopInputHasFocus.emit(true);\r\n      this.listenMapSingleClick(stop);\r\n    }\r\n  }\r\n\r\n  private listenMapSingleClick(stop: Stop) {\r\n    const key = this.stopsFeatureStore.layer.map.ol.once('singleclick', event => {\r\n      const clickCoordinates = olProj.transform(\r\n        event.coordinate,\r\n        this.stopsFeatureStore.layer.map.projection,\r\n        this.projection\r\n      );\r\n      const roundedCoord = roundCoordTo(clickCoordinates as [number, number], this.coordRoundedDecimals);\r\n      stop.text = roundedCoord.join(',');\r\n      stop.coordinates = roundedCoord;\r\n      this.stopsStore.update(stop);\r\n      setTimeout(() => {\r\n        this.stopInputHasFocus.emit(false);\r\n      }, 500);\r\n    });\r\n    this.onMapClickEventKeys.push(key);\r\n  }\r\n\r\n  private unlistenMapSingleClick() {\r\n    this.onMapClickEventKeys.map(key => {\r\n      olObservable.unByKey(key);\r\n    });\r\n    this.onMapClickEventKeys = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable } from 'rxjs';\r\n\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsSource } from '../directions-sources/directions-source';\r\nimport { DirectionsSourceService } from './directions-source.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DirectionsService {\r\n  constructor(private directionsSourceService: DirectionsSourceService) {}\r\n\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]>[] {\r\n    if (coordinates.length === 0) {\r\n      return;\r\n    }\r\n    return this.directionsSourceService.sources\r\n      .filter((source: DirectionsSource) => source.enabled)\r\n      .map((source: DirectionsSource) => this.routeSource(source, coordinates, directionsOptions));\r\n  }\r\n\r\n  routeSource(\r\n    source: DirectionsSource,\r\n    coordinates: [number, number][],\r\n    directionsOptions: DirectionOptions = {}\r\n  ): Observable<Direction[]> {\r\n    const request = source.route(coordinates, directionsOptions );\r\n    return request;\r\n  }\r\n}\r\n","import { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchSource } from './sources/source';\r\nimport { SearchResult } from './search.interfaces';\r\n\r\n/**\r\n * Function that checks whether a search source implements TextSearch\r\n * @param source Search source\r\n * @returns True if the search source implements TextSearch\r\n */\r\nexport function sourceCanSearch(source: SearchSource): boolean {\r\n  return (source as any).search !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch\r\n */\r\nexport function sourceCanReverseSearch(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch AND is shown in the pointer summary\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch AND is shown in the pointer summary\r\n */\r\nexport function sourceCanReverseSearchAsSummary(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined && source.showInPointerSummary === true;\r\n}\r\n\r\n/**\r\n * Return a search result out of an Feature. This is used to adapt\r\n * the IGO query module to the new Feature/SearchResult interfaces\r\n * @param feature feature\r\n * @param source Search source\r\n * @returns SearchResult\r\n */\r\nexport function featureToSearchResult(\r\n  feature: Feature,\r\n  source: SearchSource\r\n): SearchResult<Feature> {\r\n  if (feature.properties) {\r\n    delete feature.properties.geometry;\r\n    delete feature.properties.GEOMETRIE;\r\n    delete feature.properties.boundedBy;\r\n    delete feature.properties.shape;\r\n    delete feature.properties.SHAPE;\r\n    delete feature.properties.SHAPE_S;\r\n    delete feature.properties.SHAPE_L;\r\n    delete feature.properties.SHAPE_P;\r\n    delete feature.properties.the_geom;\r\n    delete feature.properties.geom;\r\n    delete feature.properties.geom32198;\r\n  }\r\n  feature.sourceId = source.getId();\r\n  return {\r\n    source,\r\n    data: feature,\r\n    meta: {\r\n      dataType: FEATURE,\r\n      id: feature.meta.id as string,\r\n      title: feature.meta.title,\r\n      icon: feature.meta.icon || 'map-marker'\r\n    }\r\n  };\r\n}\r\n\r\nexport function findDiff(str1: string, str2: string){\r\n  let diff = '';\r\n  str2.split('').forEach((val, i) => {\r\n    if (val !== str1.charAt(i)) {\r\n      diff += val;\r\n    }\r\n  });\r\n  return diff;\r\n}\r\n\r\n\r\n/**\r\n * Return a score calculation based on \"from\" term with the \"to\" term,\r\n * where the perfect match is 100 and a total difference is 0 or under.\r\n * @param from string\r\n * @param to string\r\n * @param caseSensitive boolean\r\n * @returns number\r\n */\r\nexport function computeTermSimilarity(from, to, caseSensitive: boolean = false): number {\r\n  if (!from || !to) {\r\n    return 0;\r\n  }\r\n  const termFrom = caseSensitive ? from : from.toString().toLowerCase();\r\n  const termTo = caseSensitive ? to : to.toString().toLowerCase();\r\n  const fromToDiff = findDiff(termFrom, termTo);\r\n  const toFromDiff = findDiff(termTo, termFrom);\r\n  const totalDiff = fromToDiff + toFromDiff;\r\n\r\n  let delta = 0;\r\n  if (totalDiff.length) {\r\n    delta = totalDiff.length / termFrom.length * 100;\r\n  }\r\n\r\n  return 100 - Math.floor(delta);\r\n}\r\n","import { Workspace } from '@igo2/common';\r\nimport { SearchSource } from './sources/source';\r\nimport { SearchSourceSettings } from './sources/source.interfaces';\r\n\r\n/**\r\n * Service where all available search sources are registered.\r\n */\r\nexport class SearchSourceService {\r\n\r\n  constructor(private sources: SearchSource[]) {}\r\n\r\n  /**\r\n   * Return available search sources\r\n   * @returns Search sources\r\n   */\r\n  getSources(): SearchSource[] {\r\n    return this.sources;\r\n  }\r\n\r\n  /**\r\n   * Return enabled search sources\r\n   * @returns Search sources\r\n   */\r\n  getEnabledSources(): SearchSource[] {\r\n    return this.getSources().filter(\r\n      (source: SearchSource) => source.enabled === true\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable search sources of given type\r\n   * @param type Search type\r\n   * @todo It would be better to track the enabled search sources\r\n   *  without updating their 'enabled' property.\r\n   */\r\n  enableSourcesByType(type: string) {\r\n    this.getSources().forEach((source: SearchSource) => {\r\n      if ((source.constructor as typeof SearchSource).type === type) {\r\n        source.enabled = true;\r\n      } else {\r\n        source.enabled = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set Param from the selected settings\r\n   * @param source search-source\r\n   * @param setting settings\r\n   */\r\n  setParamFromSetting(source: SearchSource, setting: SearchSourceSettings) {\r\n    source.setParamFromSetting(setting);\r\n  }\r\n\r\n    /**\r\n   * Set Param from the selected settings\r\n   * @param source search-source\r\n   * @param setting settings\r\n   */\r\n    setWorkspaces(source: SearchSource, workspaces: Workspace[]) {\r\n      source.setWorkspaces(workspaces);\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { stringToLonLat } from '../../map';\r\nimport { MapService } from '../../map/shared/map.service';\r\n\r\nimport { SearchSource, TextSearch, ReverseSearch } from './sources/source';\r\nimport {\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './sources/source.interfaces';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { Research } from './search.interfaces';\r\nimport {\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch,\r\n  sourceCanReverseSearchAsSummary\r\n} from './search.utils';\r\nimport { StorageService } from '@igo2/core';\r\n\r\n/**\r\n * This service perform researches in all the search sources enabled.\r\n * It returns Research objects who's 'request' property needs to be\r\n * subscribed to in order to trigger the research. This services has\r\n * keeps internal state of the researches it performed\r\n * and the results they yielded.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchService {\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mapService: MapService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * Perform a research by text\r\n   * @param term Any text\r\n   * @returns Researches\r\n   */\r\n  search(term: string, options: TextSearchOptions = {}): Research[] {\r\n    if (!this.termIsValid(term)) {\r\n      return [];\r\n    }\r\n\r\n    const proj = this.mapService.getMap()?.projection || 'EPSG:3857';\r\n    const response = stringToLonLat(term, proj, {\r\n      forceNA: options.forceNA\r\n    });\r\n    if (response.lonLat) {\r\n      return this.reverseSearch(response.lonLat, { distance: response.radius, conf: response.conf });\r\n    } else if (response.message) {\r\n      console.log(response.message);\r\n    }\r\n\r\n    options.extent = this.mapService\r\n      .getMap()\r\n      ?.viewController.getExtent('EPSG:4326');\r\n\r\n    let sources;\r\n\r\n    if (options.getEnabledOnly || options.getEnabledOnly === undefined) {\r\n      sources = this.searchSourceService.getEnabledSources();\r\n    } else {\r\n      sources = this.searchSourceService.getSources();\r\n    }\r\n\r\n    if (options.sourceId) {\r\n      sources = sources.filter((source) => source.getId() === options.sourceId);\r\n    } else if (options.searchType) {\r\n      sources = sources.filter(\r\n        (source) => source.getType() === options.searchType\r\n      );\r\n    }\r\n\r\n    sources = sources.filter(sourceCanSearch);\r\n    return this.searchSources(sources, term, options);\r\n  }\r\n\r\n  /**\r\n   * Perform a research by lon/lat\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Researches\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    asPointerSummary: boolean = false\r\n  ) {\r\n    const reverseSourceFonction = asPointerSummary\r\n      ? sourceCanReverseSearchAsSummary\r\n      : sourceCanReverseSearch;\r\n    const sources = this.searchSourceService\r\n      .getEnabledSources()\r\n      .filter(reverseSourceFonction);\r\n    const reverseSearchCoordsFormat = this.storageService.get('reverseSearchCoordsFormatEnabled') as boolean || false;\r\n\r\n    return this.reverseSearchSources(sources, lonLat, options || {}, reverseSearchCoordsFormat);\r\n  }\r\n\r\n  /**\r\n   * Create a text research out of all given search sources\r\n   * @param sources Search sources that implement TextSearch\r\n   * @param term Search term\r\n   * @returns Observable of Researches\r\n   */\r\n  private searchSources(\r\n    sources: SearchSource[],\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as TextSearch).search(term, options),\r\n        reverse: false,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a reverse research out of all given search sources\r\n   * @param sources Search sources that implement ReverseSearch\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Observable of Researches\r\n   */\r\n  private reverseSearchSources(\r\n    sources: SearchSource[],\r\n    lonLat: [number, number],\r\n    options: ReverseSearchOptions,\r\n    reverseSearchCoordsFormat: boolean\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as ReverseSearch).reverseSearch(\r\n          lonLat,\r\n          options,\r\n          reverseSearchCoordsFormat\r\n        ),\r\n        reverse: true,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate that a search term is valid\r\n   * @param term Search term\r\n   * @returns True if the search term is valid\r\n   */\r\n  private termIsValid(term: string): boolean {\r\n    return typeof term === 'string' && term !== '';\r\n  }\r\n}\r\n","<div class=\"igo-form-button-group\">\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.addStop' | translate\" color=\"primary\" (click)=\"addStop()\">\r\n    <mat-icon svgIcon=\"map-marker-plus\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1 || (stopsStore.count$ | async)>=1\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.resetDirectionsBtn' | translate\" color=\"warn\" (click)=\"resetStops()\">\r\n    <mat-icon svgIcon=\"file-restore\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"zoomRoute()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.zoomRoute' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"magnify-plus-outline\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyDirectionsToClipboard()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.copy' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyLinkToClipboard()\" \r\n    [matTooltip]=\"'igo.geo.directionsForm.link' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"link\"></mat-icon>\r\n  </button>\r\n</div>","import { Component, Input, Optional } from '@angular/core';\r\nimport { LanguageService, MessageService, RouteService } from '@igo2/core';\r\nimport { Clipboard } from '@igo2/utils';\r\nimport { Subject } from 'rxjs';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { FeatureWithDirection } from '../shared/directions.interface';\r\n\r\nimport { addStopToStore, formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StopsStore } from '../shared/store';\r\n\r\n@Component({\r\n  selector: 'igo-directions-buttons',\r\n  templateUrl: './directions-buttons.component.html',\r\n  styleUrls: ['./directions-buttons.component.scss']\r\n})\r\nexport class DirectionsButtonsComponent {\r\n\r\n  get activeRoute() {\r\n    return this.routesFeatureStore.all().find(route => route.properties.active);\r\n  }\r\n  @Input() contextUri: string;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private route: RouteService) { }\r\n\r\n  resetStops() {\r\n    this.stopsStore.clearStops();\r\n  }\r\n\r\n  // stop are always added before the last stop.\r\n  addStop(): void {\r\n    addStopToStore(this.stopsStore);\r\n  }\r\n\r\n\r\n  copyLinkToClipboard() {\r\n    const successful = Clipboard.copy(this.getUrl());\r\n    if (successful) {\r\n      this.messageService.success(\r\n        'igo.geo.directionsForm.dialog.copyMsgLink',\r\n        'igo.geo.directionsForm.dialog.copyTitle');\r\n    }\r\n  }\r\n\r\n  zoomRoute() {\r\n    this.zoomToActiveRoute$.next();\r\n  }\r\n\r\n  copyDirectionsToClipboard() {\r\n    const directionsBody = this.directionsToText();\r\n    const successful = Clipboard.copy(directionsBody);\r\n    if (successful) {\r\n      this.messageService.success(\r\n        'igo.geo.directionsForm.dialog.copyMsg',\r\n        'igo.geo.directionsForm.dialog.copyTitle');\r\n    }\r\n  }\r\n\r\n  private directionsToText() {\r\n    const indent = '\\t';\r\n    let activeRouteDirective =\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.instructions'\r\n      ) + ':\\n';\r\n    let wayPointList = '';\r\n    const summary =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.summary') +\r\n      ': \\n' +\r\n      indent +\r\n      this.activeRoute.properties.direction.title +\r\n      '\\n' +\r\n      indent +\r\n      formatDistance(this.activeRoute.properties.direction.distance) +\r\n      '\\n' +\r\n      indent +\r\n      formatDuration(this.activeRoute.properties.direction.duration) +\r\n      '\\n\\n' +\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.stopsList'\r\n      ) +\r\n      ':\\n';\r\n\r\n    const url =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.link') +\r\n      ':\\n' +\r\n      indent +\r\n      this.getUrl();\r\n\r\n    let wayPointsCnt = 1;\r\n    this.stopsStore.view.all().forEach(stop => {\r\n      let coord = '';\r\n      let stopText = '';\r\n      if (stop.text !== roundCoordTo(stop.coordinates).join(',')) {\r\n        stopText = stop.text;\r\n        coord = ` ( ${roundCoordTo(stop.coordinates).join(',')} )`;\r\n      } else {\r\n        stopText = roundCoordTo(stop.coordinates).join(\r\n          ','\r\n        );\r\n      }\r\n\r\n      wayPointList =\r\n        wayPointList +\r\n        indent +\r\n        wayPointsCnt.toLocaleString() +\r\n        '. ' +\r\n        stopText +\r\n        coord +\r\n        '\\n';\r\n      wayPointsCnt++;\r\n    });\r\n\r\n    let localCnt = 0;\r\n    this.activeRoute.properties.direction.steps.forEach(step => {\r\n      const instruction = this.formatStep(step, localCnt).instruction;\r\n      const distance =\r\n        formatDistance(step.distance) === undefined\r\n          ? ''\r\n          : ' (' + formatDistance(step.distance) + ')';\r\n      activeRouteDirective =\r\n        activeRouteDirective +\r\n        indent +\r\n        (localCnt + 1).toLocaleString() +\r\n        '. ' +\r\n        instruction +\r\n        distance +\r\n        '\\n';\r\n      localCnt++;\r\n    });\r\n\r\n    const directionsBody =\r\n      summary + wayPointList + '\\n' + url + '\\n\\n' + activeRouteDirective;\r\n\r\n    return directionsBody;\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeRoute.properties.direction.steps.length - 1\r\n    );\r\n  }\r\n\r\n  private getUrl() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n    let context = '';\r\n    if (this.contextUri) {\r\n      context = `context=${this.contextUri}&`;\r\n    }\r\n\r\n    const pos = this.routesFeatureStore.all()\r\n    .map((direction: FeatureWithDirection) => direction.properties.id).indexOf(this.activeRoute.properties.id);\r\n    let routingOptions = '';\r\n    if (pos !== 0) {\r\n      const routingOptionsKey = this.route.options.directionsOptionsKey;\r\n      routingOptions = `&${routingOptionsKey}=result:${pos}`;\r\n    }\r\n    const directionsKey = this.route.options.directionsCoordKey;\r\n    const stopsCoordinates = this.stopsStore.view.all().map(stop => roundCoordTo(stop.coordinates, 6));\r\n    let directionsUrl = '';\r\n    if (stopsCoordinates.length >= 2) {\r\n      directionsUrl = `${directionsKey}=${stopsCoordinates.join(';')}`;\r\n      return `${location.origin}${location.pathname}?${context}tool=directions&sidenav=1&${directionsUrl}${routingOptions}`;\r\n    }\r\n    return;\r\n  }\r\n}\r\n","<div class=\"igo-input-container\" *ngIf=\"directions && activeDirection\">\r\n    <mat-form-field *ngIf=\"directions && directions.length > 1\">\r\n        <mat-select placeholder=\"{{'igo.geo.directionsForm.drivingOptions' | translate}}\"\r\n            (selectionChange)=\"changeRoute()\" [(ngModel)]=\"activeDirection\">\r\n            <mat-option *ngFor=\"let direction of directions; let cnt = index;\" [value]=\"direction\">\r\n                Option {{cnt + 1}} : {{formatDistance(direction.distance)}}\r\n                ({{formatDuration(direction.duration)}})\r\n            </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n\r\n    <mat-divider *ngIf=\"directions && directions.length === 0\"></mat-divider>\r\n\r\n    <mat-list (mouseleave)=\"onStepsListBlur()\">\r\n        <h2 mat-header class=\"igo-route-title mat-typography\">{{activeDirection.title}}</h2>\r\n        <h2 mat-subheader>{{formatDistance(activeDirection.distance)}}, {{formatDuration(activeDirection.duration)}}</h2>\r\n        <mat-list-item class=\"igo-steps\" \r\n            (mouseenter)=\"showSegment(step)\" \r\n            (click)=\"showSegment(step,true)\" \r\n            *ngFor=\"let step of activeDirection.steps; let cnt = index;\" igoListItem>\r\n            <mat-icon [ngClass]=\"formatStep(step,cnt).cssClass\" mat-list-icon svgIcon=\"{{formatStep(step,cnt).image}}\">\r\n            </mat-icon>\r\n\r\n            <h4 mat-line>{{cnt +1}}. {{formatStep(step,cnt).instruction}}</h4>\r\n            <h4 mat-line class=\"right\">{{formatDistance(step.distance)}}</h4>\r\n        </mat-list-item>\r\n\r\n        <mat-divider></mat-divider>\r\n\r\n    </mat-list>\r\n\r\n</div>","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Direction, FeatureWithStep, IgoStep } from '../shared/directions.interface';\r\nimport { formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StepFeatureStore } from '../shared/store';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olGeom from 'ol/geom';\r\n\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { DirectionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-results',\r\n  templateUrl: './directions-results.component.html',\r\n  styleUrls: ['./directions-results.component.scss']\r\n})\r\nexport class DirectionsResultsComponent implements OnInit, OnDestroy {\r\n\r\n  public activeDirection: Direction;\r\n  public directions: Direction[];\r\n\r\n  private entities$$: Subscription;\r\n\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) { }\r\n\r\n  ngOnInit(): void {\r\n    this.entities$$ = this.routesFeatureStore.entities$\r\n      .pipe(debounceTime(200))\r\n      .subscribe(entities => {\r\n        const activeFeatureWithDirection = entities.find(entity => entity.properties.active);\r\n        this.directions = entities.map(entity => entity.properties.direction);\r\n        if (activeFeatureWithDirection) {\r\n          this.activeDirection = activeFeatureWithDirection.properties.direction;\r\n        } else {\r\n          this.activeDirection = undefined;\r\n        }\r\n        this.cdRef.detectChanges();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.entities$$.unsubscribe();\r\n  }\r\n\r\n  changeRoute() {\r\n    this.routesFeatureStore.entities$.value.map(entity =>\r\n      entity.properties.active = !entity.properties.active\r\n    );\r\n    this.routesFeatureStore.layer.ol.getSource().getFeatures().map(feature =>\r\n      feature.set('active', !feature.get('active'))\r\n    );\r\n  }\r\n\r\n  formatDistance(distance: number): string {\r\n    return formatDistance(distance);\r\n  }\r\n\r\n  formatDuration(duration: number): string {\r\n    return formatDuration(duration);\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeDirection.steps.length - 1\r\n    );\r\n  }\r\n\r\n  onStepsListBlur() {\r\n    this.stepFeatureStore.clear();\r\n  }\r\n\r\n  showSegment(step: IgoStep, zoomToExtent = false) {\r\n    this.showRouteSegmentGeometry(step, zoomToExtent);\r\n  }\r\n\r\n  showRouteSegmentGeometry(step: IgoStep, zoomToExtent = false) {\r\n\r\n    const coordinates = step.geometry.coordinates;\r\n    const vertexId = 'vertex';\r\n    const geometry4326 = new olGeom.LineString(coordinates);\r\n    const geometryMapProjection = geometry4326.transform(\r\n      'EPSG:4326',\r\n      this.stepFeatureStore.layer.map.projection\r\n    );\r\n    const routeSegmentCoordinates = (geometryMapProjection as any).getCoordinates();\r\n    const lastPoint = routeSegmentCoordinates[0];\r\n\r\n    const geometry = new olGeom.Point(lastPoint);\r\n    const feature = new olFeature({ geometry });\r\n\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.stepFeatureStore.layer.map.projection,\r\n      dataProjection: this.stepFeatureStore.layer.map.projection\r\n    }) as FeatureGeometry;\r\n\r\n    const previousVertex = this.stepFeatureStore.get(vertexId);\r\n    const previousVertexRevision = previousVertex\r\n      ? previousVertex.meta.revision\r\n      : 0;\r\n\r\n    const stepFeature: FeatureWithStep = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.stepFeatureStore.layer.map.projection,\r\n      properties: {\r\n        id: vertexId,\r\n        step,\r\n        type: DirectionType.Vertex\r\n      },\r\n      meta: {\r\n        id: vertexId,\r\n        revision: previousVertexRevision + 1\r\n      },\r\n      ol: feature\r\n    };\r\n    this.stepFeatureStore.update(stepFeature);\r\n    if (zoomToExtent) {\r\n      this.stepFeatureStore.layer.map.viewController.zoomToExtent(feature.getGeometry().getExtent() as [number, number, number, number]);\r\n    }\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { debounceTime, distinctUntilChanged, map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport * as olCondition from 'ol/events/condition';\r\nimport * as olInteraction from 'ol/interaction';\r\nimport * as olProj from 'ol/proj';\r\nimport { TranslateEvent } from 'ol/interaction/Translate';\r\nimport Collection from 'ol/Collection';\r\nimport { SelectEvent } from 'ol/interaction/Select';\r\n\r\nimport { DirectionOptions, FeatureWithStopProperties, Stop } from './shared/directions.interface';\r\nimport { Subject, Subscription } from 'rxjs';\r\nimport { addDirectionToRoutesFeatureStore, addStopToStopsFeatureStore, addStopToStore,\r\n  initRoutesFeatureStore, initStepFeatureStore, initStopsFeatureStore, updateStoreSorting } from './shared/directions.utils';\r\nimport { Feature } from '../feature/shared/feature.interfaces';\r\nimport { DirectionsService } from './shared/directions.service';\r\nimport { DirectionType, ProposalType } from './shared/directions.enum';\r\nimport { roundCoordTo, stringToLonLat } from '../map';\r\nimport { SearchService } from '../search/shared/search.service';\r\nimport { ChangeUtils, ObjectUtils } from '@igo2/utils';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './shared/store';\r\nimport { FeatureStoreLoadingStrategy } from '../feature/shared/strategies/loading';\r\nimport { Research, SearchResult } from '../search/shared/search.interfaces';\r\nimport { QueryService } from '../query/shared/query.service';\r\n\r\n@Component({\r\n  selector: 'igo-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class DirectionsComponent implements OnInit, OnDestroy {\r\n\r\n  private watcher: EntityStoreWatcher<Stop>;\r\n\r\n  public projection: string = 'EPSG:4326';\r\n\r\n  private zoomRoute$$: Subscription;\r\n  private storeEmpty$$: Subscription;\r\n  private storeChange$$: Subscription;\r\n  private routesQueries$$: Subscription[] = [];\r\n\r\n  private selectStopInteraction: olInteraction.Select;\r\n  private translateStop: olInteraction.Translate;\r\n  private selectedRoute;\r\n  private focusOnStop: boolean = false;\r\n  private isTranslating: boolean = false;\r\n\r\n  public previousStops: Stop[] = [];\r\n\r\n  private searchs$$: Subscription[] = [];\r\n\r\n  @Input() contextUri: string;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private languageService: LanguageService,\r\n    private directionsService: DirectionsService,\r\n    private searchService: SearchService,\r\n    private queryService: QueryService\r\n  ) { }\r\n\r\n\r\n  ngOnInit(): void {\r\n    this.queryService.queryEnabled = false;\r\n    this.initEntityStores();\r\n    setTimeout(() => {\r\n      initStopsFeatureStore(this.stopsFeatureStore, this.languageService);\r\n      initRoutesFeatureStore(this.routesFeatureStore, this.languageService);\r\n      initStepFeatureStore(this.stepFeatureStore);\r\n      this.initOlInteraction();\r\n    }, 1);\r\n\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.queryService.queryEnabled = true;\r\n    this.storeEmpty$$.unsubscribe();\r\n    this.storeChange$$.unsubscribe();\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    this.zoomRoute$$.unsubscribe();\r\n    this.freezeStores();\r\n  }\r\n\r\n  private freezeStores() {\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute);\r\n    this.stopsFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.routesFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.stepFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n  }\r\n\r\n  private initEntityStores() {\r\n    this.watcher = new EntityStoreWatcher(this.stopsStore, this.cdRef);\r\n    this.monitorEmptyEntityStore();\r\n    this.monitorEntityStoreChange();\r\n    this.monitorActiveRouteZoom();\r\n  }\r\n\r\n  private monitorActiveRouteZoom() {\r\n    this.zoomRoute$$ = this.zoomToActiveRoute$.subscribe(() => {\r\n      if (this.routesFeatureStore.count >= 1) {\r\n        const activeRoute = this.routesFeatureStore.all().find(route => route.properties.active);\r\n\r\n        if (activeRoute) {\r\n          activeRoute.ol.getGeometry();\r\n          const routeExtent = activeRoute.ol.getGeometry().getExtent();\r\n          this.routesFeatureStore.layer.map.viewController.zoomToExtent(routeExtent as [number, number, number, number]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private initOlInteraction() {\r\n    this.selectStopInteraction = new olInteraction.Select({\r\n      layers: [this.stopsFeatureStore.layer.ol],\r\n      hitTolerance: 7,\r\n      condition: (event) => {\r\n        return event.type === 'pointermove' && !event.dragging;\r\n      }\r\n    });\r\n\r\n    this.translateStop = new olInteraction.Translate({\r\n      features: this.selectStopInteraction.getFeatures()\r\n    });\r\n    this.translateStop.on('translating', (evt: TranslateEvent) => {\r\n      this.isTranslating = true;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n    this.translateStop.on('translateend', (evt: TranslateEvent) => {\r\n      this.isTranslating = false;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n\r\n    this.selectedRoute = new olInteraction.Select({\r\n      layers: [this.routesFeatureStore.layer.ol],\r\n      condition: olCondition.click,\r\n      hitTolerance: 7,\r\n      filter: feature => {\r\n        return feature.get('type') === DirectionType.Route &&\r\n          feature.get('active') &&\r\n          !this.isTranslating;\r\n      }\r\n    });\r\n    this.selectedRoute.on('select', (evt: SelectEvent) => {\r\n      if (this.focusOnStop === false) {\r\n        const selectCoordinates = roundCoordTo(\r\n          olProj.transform(\r\n            (evt as any).mapBrowserEvent.coordinate,\r\n            this.routesFeatureStore.layer.map.projection,\r\n            this.projection\r\n          ) as [number, number], this.coordRoundedDecimals);\r\n        const addedStop = addStopToStore(this.stopsStore);\r\n        addedStop.text = selectCoordinates.join(',');\r\n        addedStop.coordinates = [selectCoordinates[0], selectCoordinates[1]];\r\n      }\r\n    });\r\n\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  onStopInputHasFocusChange(stopInputHasFocus: boolean) {\r\n    stopInputHasFocus ?\r\n      this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute) :\r\n      this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  private executeStopTranslation(\r\n    features: Collection<any>\r\n  ) {\r\n    if (features.getLength() === 0) {\r\n      return;\r\n    }\r\n    const firstFeature = features.getArray()[0];\r\n    const translatedStopId = firstFeature.getId();\r\n\r\n    const translationCoordinates = olProj.transform(\r\n      firstFeature.getGeometry().getCoordinates(),\r\n      this.stopsFeatureStore.layer.map.projection,\r\n      this.projection\r\n    );\r\n    const translatedStop = this.stopsStore.get(translatedStopId);\r\n    const roundedCoord = roundCoordTo(translationCoordinates as [number, number], this.coordRoundedDecimals);\r\n    translatedStop.coordinates = roundedCoord;\r\n    translatedStop.text = roundedCoord.join(',');\r\n    this.stopsStore.update(translatedStop);\r\n  }\r\n\r\n\r\n  private monitorEmptyEntityStore() {\r\n    // Watch if the store is empty to reset it\r\n    this.storeEmpty$$ = this.stopsStore.count$\r\n      .pipe(\r\n        distinctUntilChanged()\r\n      ).subscribe((count) => {\r\n        if (count < 2) {\r\n          addStopToStore(this.stopsStore);\r\n          if (this.stopsStore.count === 2) {\r\n            this.stopsStore.storeInitialized$.next(true);\r\n            return;\r\n          }\r\n          this.stopsStore.storeInitialized$.next(false);\r\n        }\r\n        this.routesQueries$$.map((u) => u.unsubscribe());\r\n      });\r\n  }\r\n\r\n  private monitorEntityStoreChange() {\r\n    this.storeChange$$ = this.stopsStore.entities$\r\n      .pipe(debounceTime(this.debounce))\r\n      .subscribe((stops: Stop[]) => {\r\n        this.handleStopDiff(stops);\r\n        updateStoreSorting(this.stopsStore);\r\n        this.handleStopsFeature();\r\n        this.getRoutes(this.isTranslating);\r\n      });\r\n  }\r\n\r\n  cancelSearch() {\r\n    this.searchs$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  private handleStopDiff(stops: Stop[]) {\r\n    const simplifiedStops = stops.map((stop: Stop) => {\r\n      return ObjectUtils.removeUndefined({ ...{ id: stop.id, text: stop.text, coordinates: stop.coordinates } });\r\n    });\r\n    const diff = ChangeUtils.findChanges(this.previousStops, simplifiedStops, ['coordinates']);\r\n    const stopIdToProcess = diff.added.concat(diff.modified);\r\n    if (stopIdToProcess) {\r\n      stopIdToProcess.map((change) => {\r\n        const changedStop = (change.newValue as Stop);\r\n        if (changedStop) {\r\n          const stop: Stop = this.stopsStore.get(changedStop.id);\r\n          const term = stop.text;\r\n          if (!term || term.length === 0) {\r\n            return;\r\n          }\r\n          const response = stringToLonLat(term, this.stopsFeatureStore.layer.map.projection);\r\n          let researches: Research[];\r\n          let isCoord = false;\r\n          if (response.lonLat) {\r\n            isCoord = true;\r\n          }\r\n          researches = this.searchService.search(term, { searchType: 'Feature' });\r\n          this.cancelSearch();\r\n          const requests$ = researches.map(res => res.request\r\n            .pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n\r\n          );\r\n          this.searchs$$ = requests$.map((request) => {\r\n            return request.pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n              .subscribe((res: SearchResult[]) => {\r\n                if (res.length > 0) {\r\n                  const source = res[0].source;\r\n                  const meta = res[0].meta;\r\n                  const results = res.map(r => r.data);\r\n                  if (!stop.searchProposals) {\r\n                    stop.searchProposals = [];\r\n                  }\r\n                  stop.searchProposals = stop.searchProposals.filter(sp => sp.type === (isCoord ? ProposalType.Coord : ProposalType.Text));\r\n                  let storedSource = stop.searchProposals.find(sp => sp.source === source);\r\n                  if (storedSource) {\r\n                    storedSource.results = results;\r\n                  } else {\r\n                    stop.searchProposals.push({\r\n                      type: isCoord ? ProposalType.Coord : ProposalType.Text,\r\n                      source,\r\n                      meta,\r\n                      results\r\n                    });\r\n                  }\r\n                }\r\n                this.cdRef.detectChanges();\r\n              });\r\n          });\r\n        }\r\n      });\r\n    }\r\n    this.previousStops = simplifiedStops;\r\n  }\r\n\r\n  private handleStopsFeature() {\r\n    const stops = this.stopsStore.all();\r\n    const stopsWithCoordinates = stops.filter(stop => stop.coordinates);\r\n    stopsWithCoordinates.map(stop => this.addStopOverlay(stop));\r\n    this.stopsFeatureStore.all().map(\r\n      (stopFeature: Feature<FeatureWithStopProperties>) => {\r\n        if (!this.stopsStore.get(stopFeature.properties.id)) {\r\n          this.stopsFeatureStore.delete(stopFeature);\r\n        }\r\n      });\r\n    const stopsWithoutCoordinates = stops.filter(stop => !stop.coordinates);\r\n    stopsWithoutCoordinates.map(stop => {\r\n      const stopFeature = this.stopsFeatureStore.get(stop.id);\r\n      if (stopFeature) {\r\n        this.stopsFeatureStore.delete(stopFeature);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getRoutes(isOverview: boolean = false) {\r\n    const stopsWithCoordinates = this.stopsStore.view\r\n      .all()\r\n      .filter(stop => stop.coordinates);\r\n    if (stopsWithCoordinates.length < 2) {\r\n      this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n      return;\r\n    }\r\n\r\n    const roundedCoordinates = stopsWithCoordinates.map((stop) => {\r\n      const roundedCoord = roundCoordTo(stop.coordinates, this.coordRoundedDecimals);\r\n      return roundedCoord;\r\n    });\r\n    const overviewDirectionsOptions: DirectionOptions = {\r\n      overview: true,\r\n      steps: false,\r\n      alternatives: false,\r\n      continue_straight: false\r\n    };\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    const routeResponse = this.directionsService.route(\r\n      roundedCoordinates,\r\n      isOverview ? overviewDirectionsOptions : undefined\r\n    );\r\n    if (routeResponse) {\r\n      routeResponse.map(res =>\r\n        this.routesQueries$$.push(\r\n          res.subscribe(directions => {\r\n            this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n            directions.map(direction =>\r\n              addDirectionToRoutesFeatureStore(\r\n                this.routesFeatureStore,\r\n                direction,\r\n                this.projection,\r\n                direction === directions[0] ? true : false)\r\n            );\r\n          })\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  public addStopOverlay(stop: Stop) {\r\n    addStopToStopsFeatureStore(stop, this.stopsStore, this.stopsFeatureStore, this.projection, this.languageService);\r\n  }\r\n}\r\n","<igo-directions-buttons [contextUri]=\"contextUri\" [zoomToActiveRoute$]=\"zoomToActiveRoute$\" [routesFeatureStore]=\"routesFeatureStore\" [stopsStore]=\"stopsStore\"></igo-directions-buttons>\r\n\r\n<igo-directions-inputs (stopInputHasFocus)=\"onStopInputHasFocusChange($event)\" [coordRoundedDecimals]=\"coordRoundedDecimals\" [projection]=\"projection\" [stopsFeatureStore]=\"stopsFeatureStore\" [stopsStore]=\"stopsStore\" [debounce]=\"debounce\" [length]=\"length\"></igo-directions-inputs>\r\n<br>\r\n<igo-directions-results [stepFeatureStore]=\"stepFeatureStore\" [routesFeatureStore]=\"routesFeatureStore\"></igo-directions-results>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { provideDirectionsSourceService } from './shared/directions-source.service';\r\nimport { DragDropModule } from '@angular/cdk/drag-drop';\r\nimport { DirectionsInputsComponent } from './directions-inputs/directions-inputs.component';\r\nimport { DirectionsComponent } from './directions.component';\r\nimport { DirectionsButtonsComponent } from './directions-buttons/directions-buttons.component';\r\nimport { DirectionsResultsComponent } from './directions-results/directions-results.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    DragDropModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatListModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatAutocompleteModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  declarations: [\r\n     DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  providers: [provideDirectionsSourceService()]\r\n})\r\nexport class IgoDirectionsModule {\r\n  static forRoot(): ModuleWithProviders<IgoDirectionsModule> {\r\n    return {\r\n      ngModule: IgoDirectionsModule\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceService } from './search-source.service';\r\n\r\n/**\r\n * Search source factory\r\n * @ignore\r\n */\r\nexport function searchSourceServiceFactory(sources: SearchSource[]) {\r\n  return new SearchSourceService(sources);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the SearchSource service\r\n */\r\nexport function provideSearchSourceService() {\r\n  return {\r\n    provide: SearchSourceService,\r\n    useFactory: searchSourceServiceFactory,\r\n    deps: [SearchSource]\r\n  };\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpClient, HttpParams, HttpParameterCodec } from '@angular/common/http';\r\n\r\nimport { Observable, of, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport pointOnFeature from '@turf/point-on-feature';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\nimport { GoogleLinks } from './../../../utils/googleLinks';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  IChercheData,\r\n  IChercheResponse,\r\n  IChercheReverseData,\r\n  IChercheReverseResponse\r\n} from './icherche.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class IChercheSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n\r\n// Fix the \"+\" is replaced with space \" \" in a query string\r\n// https://github.com/angular/angular/issues/11058\r\nexport class IgoHttpParameterCodec implements HttpParameterCodec {\r\n  encodeKey(key: string): string {\r\n    return encodeURIComponent(key);\r\n  }\r\n\r\n  encodeValue(value: string): string {\r\n    return encodeURIComponent(value);\r\n  }\r\n\r\n  decodeKey(key: string): string {\r\n    return decodeURIComponent(key);\r\n  }\r\n\r\n  decodeValue(value: string): string {\r\n    return decodeURIComponent(value);\r\n  }\r\n}\r\n\r\n/**\r\n * ICherche search source\r\n */\r\n@Injectable()\r\nexport class IChercheSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'icherche';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  private hashtagsLieuxToKeep = [];\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    @Inject(IChercheSearchResultFormatter)\r\n    private formatter: IChercheSearchResultFormatter,\r\n    injector: Injector\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n\r\n    this.languageService.language$.subscribe(() => {\r\n      this.title$.next(this.languageService.translate.instant(this.options.title));\r\n    });\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n\r\n    const types = this.options.params?.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : [\r\n            'adresses',\r\n            'codes-postaux',\r\n            'routes',\r\n            'intersections',\r\n            'municipalites',\r\n            'mrc',\r\n            'regadmin',\r\n            'lieux'\r\n          ];\r\n\r\n    return {\r\n      title: 'igo.geo.search.icherche.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1,\r\n              hashtags: ['adresse']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldAddress',\r\n              value: 'anciennes-adresses',\r\n              enabled: types.indexOf('anciennes-adresses') !== -1,\r\n              hashtags: ['anciennes-adresses']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldCity',\r\n              value: 'anciennes-municipalites',\r\n              enabled: types.indexOf('anciennes-municipalites') !== -1,\r\n              hashtags: ['anciennes-municipalites']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cn',\r\n              value: 'bornes-cn',\r\n              enabled: types.indexOf('bornes-cn') !== -1,\r\n              hashtags: ['borne', 'bornes', 'cn']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.sumi',\r\n              value: 'bornes-sumi',\r\n              enabled: types.indexOf('bornes-sumi') !== -1,\r\n              hashtags: ['borne', 'bornes', 'sumi']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cadastre',\r\n              value: 'cadastre',\r\n              enabled: types.indexOf('cadastre') !== -1,\r\n              hashtags: ['cadastre']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.postalCode',\r\n              value: 'codes-postaux',\r\n              enabled: types.indexOf('codes-postaux') !== -1,\r\n              hashtags: ['code-postal']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.entreprise',\r\n              value: 'entreprises',\r\n              enabled: types.indexOf('entreprises') !== -1,\r\n              available: false,\r\n              hashtags: ['entreprise']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cycleStop',\r\n              value: 'haltes_cyclables',\r\n              enabled: types.indexOf('haltes_cyclables') !== -1,\r\n              hashtags: ['haltevelo','haltes_cyclables']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.restArea',\r\n              value: 'haltes_routieres',\r\n              enabled: types.indexOf('haltes_routieres') !== -1,\r\n              hashtags: ['halteroute','haltes_routieres']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.hq',\r\n              value: 'hq',\r\n              enabled: types.indexOf('hq') !== -1,\r\n              hashtags: ['hq']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.intersection',\r\n              value: 'intersections',\r\n              enabled: types.indexOf('intersections') !== -1,\r\n              hashtags: ['intersection', '+']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.place',\r\n              value: 'lieux',\r\n              enabled: types.indexOf('lieux') !== -1,\r\n              hashtags: ['lieu']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1,\r\n              hashtags: ['mrc']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1,\r\n              hashtags: ['municipalité', 'mun']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1,\r\n              hashtags: ['région-administrative', 'regadmin']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.gcc',\r\n              value: 'bornes-gcc',\r\n              enabled: types.indexOf('bornes-gcc') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repère', 'gcc', 'ccg']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.km',\r\n              value: 'bornes-km',\r\n              enabled: types.indexOf('bornes-km') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repère', 'km']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              hashtags: ['route']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.exit',\r\n              value: 'sorties-autoroute',\r\n              enabled: types.indexOf('sorties-autoroute') !== -1,\r\n              hashtags: ['sortie', 'sorties', 'exit']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30 || !ecmax\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'loc',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.map',\r\n              value: 'true',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.quebec',\r\n              value: 'false',\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(term, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http.get(`${this.searchUrl}/geocode`, { params }).pipe(\r\n      map((response: IChercheResponse) => this.extractResults(response, term)),\r\n      catchError((err) => {\r\n        err.error.toDisplay = true;\r\n        err.error.title = this.languageService.translate.instant(\r\n          this.getDefaultOptions().title\r\n        );\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          const regex = new RegExp(`^${v.value}(\\\\.|$)`);\r\n          const typesMatched = types.filter((value) => regex.test(value));\r\n          v.available = typesMatched.length > 0;\r\n          if (v.value === 'lieux') {\r\n            this.hashtagsLieuxToKeep = [\r\n              ...(new Set(\r\n                typesMatched\r\n                  .map((t) => t.split('.'))\r\n                  .reduce((a, b) => a.concat(b))\r\n                  .filter((t) => t !== 'lieux')\r\n              ) as any)\r\n            ];\r\n          }\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    const queryParams: any = Object.assign(\r\n      {\r\n        geometry: true,\r\n        bbox: true,\r\n        icon: true,\r\n        type:\r\n          'adresses,codes-postaux,municipalites,mrc,regadmin,lieux,entreprises,bornes-sumi'\r\n      },\r\n      this.params,\r\n      this.computeOptionsParam(term, options || {}).params,\r\n      {\r\n        q: this.computeTerm(term),\r\n        page: options.page\r\n      }\r\n    );\r\n\r\n    if (queryParams.loc === 'true') {\r\n      const [xMin, yMin, xMax, yMax] = options.extent;\r\n      queryParams.loc = `${xMin},${yMin};${xMax},${yMin};${xMax},${yMax};${xMin},${yMax};${xMin},${yMin}`;\r\n    } else if (queryParams.loc === 'false') {\r\n      delete queryParams.loc;\r\n    }\r\n\r\n    if (/#[A-Za-z]+/.test(queryParams.q)) {\r\n      queryParams.type = 'lieux';\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(queryParams),\r\n      encoder: new IgoHttpParameterCodec()\r\n    });\r\n  }\r\n\r\n  private extractResults(response: IChercheResponse, term: string): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheData) => {\r\n      return this.formatter.formatResult(this.dataToResult(data, term, response));\r\n    });\r\n  }\r\n\r\n  private dataToResult(\r\n    data: IChercheData,\r\n    term: string,\r\n    response?: IChercheResponse\r\n  ): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.highlight.title || data.properties.nom;\r\n    const subtitleHtml = data.highlight.title2\r\n      ? ' <small> ' + data.highlight.title2 + '</small>'\r\n      : '';\r\n    const subtitleHtml2 = data.highlight.title3\r\n      ? '<br><small> ' + data.highlight.title3 + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml + subtitleHtml2,\r\n        icon: data.icon || 'map-marker',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.nom),\r\n        nextPage:\r\n          response.features.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    if (!data.geometry) {\r\n      return Object.assign({ type: data.index }, properties);\r\n    }\r\n\r\n    const googleLinksProperties: {\r\n      GoogleMaps: string;\r\n      GoogleStreetView?: string;\r\n    } = {\r\n      GoogleMaps: ''\r\n    };\r\n\r\n    let googleMaps;\r\n    if (data.geometry.type === 'Point') {\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    } else {\r\n      const point = pointOnFeature(data.geometry);\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        point.geometry.coordinates[0],\r\n        point.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    let googleMapsNom;\r\n    if (data.index === 'routes') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + data.properties.municipalite\r\n      );\r\n    } else if (data.index === 'municipalites') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + 'ville'\r\n      );\r\n    } else if (data.index === 'mrc') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        'mrc+' + data.properties.nom\r\n      );\r\n    } else if (data.index === 'regadmin') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ',+QC'\r\n      );\r\n    } else {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom || data.highlight.title\r\n      );\r\n    }\r\n\r\n    googleLinksProperties.GoogleMaps =\r\n      '<a href=' +\r\n      googleMaps +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByCoord') +\r\n      '</a> <br /> <a href=' +\r\n      googleMapsNom +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByName') +\r\n      '</a>';\r\n\r\n    if (data.geometry.type === 'Point') {\r\n      googleLinksProperties.GoogleStreetView = GoogleLinks.getGoogleStreetViewLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(\r\n      { type: data.index },\r\n      properties,\r\n      googleLinksProperties,\r\n      routing\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    // Keep hashtags for \"lieux\"\r\n    const hashtags = term.match(/(#[A-Za-z]+)/g) || [];\r\n    let keep = false;\r\n    keep = hashtags.some((hashtag) => {\r\n      const hashtagKey = hashtag.substring(1);\r\n      return this.hashtagsLieuxToKeep.some(\r\n        (h) =>\r\n          h\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '') ===\r\n          hashtagKey\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n      );\r\n    });\r\n\r\n    if (!keep) {\r\n      term = term.replace(/(#[A-Za-z]+)/g, '');\r\n    }\r\n\r\n    return term.replace(/[^\\wÀ-ÿ !\\-\\+\\(\\)\\.\\/½¼¾,'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n}\r\n\r\n/**\r\n * IChercheReverse search source\r\n */\r\n@Injectable()\r\nexport class IChercheReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'icherchereverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    injector: Injector,\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.language$.subscribe(() => {\r\n      this.title$.next(this.languageService.translate.instant(this.options.title));\r\n    });\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const types =\r\n      this.options.params && this.options.params.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : ['adresses', 'municipalites', 'mrc', 'regadmin'];\r\n\r\n    return {\r\n      title: 'igo.geo.search.ichercheReverse.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              available: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.district',\r\n              value: 'arrondissements',\r\n              enabled: types.indexOf('arrondissements') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'radius',\r\n          name: 'bufferInput',\r\n          values: [\r\n            {\r\n              title: '100 m',\r\n              value: 100,\r\n              enabled: !this.options.distance || this.options.distance === 100\r\n            },\r\n            {\r\n              title: '500 m',\r\n              value: 500,\r\n              enabled: this.options.distance === 500\r\n            },\r\n            {\r\n              title: '1 km',\r\n              value: 1000,\r\n              enabled: this.options.distance === 1000\r\n            },\r\n            {\r\n              title: '2 km',\r\n              value: 2000,\r\n              enabled: this.options.distance === 2000\r\n            },\r\n            {\r\n              title: '5 km',\r\n              value: 5000,\r\n              enabled: this.options.distance === 5000\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    return this.http.get(`${this.searchUrl}/locate`, { params }).pipe(\r\n      map((response: IChercheReverseResponse) => {\r\n        return this.extractResults(response);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          v.available = types.indexOf(v.value as string) > -1;\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    if (options.distance || this.options.distance) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        bufferInput: options.distance || this.options.distance\r\n      });\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          loc: lonLat.join(','),\r\n          sort: 'distance',\r\n          geometry: true,\r\n          icon: true\r\n        },\r\n        options.params || {},\r\n        this.params\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: IChercheReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private getSubtitle(data: IChercheReverseData) {\r\n    if (!this.settings.length) {\r\n      return '';\r\n    }\r\n    let subtitle = '';\r\n    switch (data.properties.type) {\r\n      case 'arrondissements':\r\n        subtitle = data.properties.municipalite + ' (Arrondissement)';\r\n        break;\r\n      default:\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        const type = typeSetting.values.find(\r\n          (t) => t.value === data.properties.type\r\n        );\r\n        if (type) {\r\n          subtitle = this.languageService.translate.instant(type.title);\r\n        }\r\n    }\r\n    return subtitle;\r\n  }\r\n\r\n  private dataToResult(data: IChercheReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.properties.nom;\r\n    const subtitleHtml = ' <small> ' + this.getSubtitle(data) + '</small>';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.icon || 'map-marker',\r\n        pointerSummaryTitle: this.getSubtitle(data)+ ': ' + data.properties.nom\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheReverseData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheReverseSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(properties, routing);\r\n  }\r\n\r\n  private computeExtent(\r\n    data: IChercheReverseData\r\n  ): [number, number, number, number] | undefined {\r\n    return data.bbox\r\n      ? [data.bbox[0], data.bbox[2], data.bbox[1], data.bbox[3]]\r\n      : undefined;\r\n  }\r\n}\r\n","import { Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  IChercheSearchSource,\r\n  IChercheSearchResultFormatter,\r\n  IChercheReverseSearchSource\r\n} from './icherche';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultIChercheSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new IChercheSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultIChercheSearchResultFormatter() {\r\n  return {\r\n    provide: IChercheSearchResultFormatter,\r\n    useFactory: defaultIChercheSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ICherche search source factory\r\n * @ignore\r\n */\r\nexport function ichercheSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: IChercheSearchResultFormatter,\r\n  injector: Injector\r\n) {\r\n  return new IChercheSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheSearchSource.id}`),\r\n    formatter,\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search source\r\n */\r\nexport function provideIChercheSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheSearchSourceFactory,\r\n    multi: true,\r\n    deps: [\r\n      HttpClient,\r\n      LanguageService,\r\n      StorageService,\r\n      ConfigService,\r\n      IChercheSearchResultFormatter,\r\n      Injector\r\n    ]\r\n  };\r\n}\r\n\r\n/**\r\n * IChercheReverse search source factory\r\n * @ignore\r\n */\r\nexport function ichercheReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  injector: Injector\r\n) {\r\n  return new IChercheReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheReverseSearchSource.id}`),\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideIChercheReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, Injector]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport * as olproj from 'ol/proj';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport * as olformat from 'ol/format';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, ReverseSearch } from './source';\r\nimport { SearchSourceOptions, ReverseSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { GoogleLinks } from '../../../utils/googleLinks';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { lonLatConversion, roundCoordTo, convertDDToDMS } from '../../../map/shared/map.utils';\r\nimport { OsmLinks } from '../../../utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class CoordinatesSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n/**\r\n * CoordinatesReverse search source\r\n */\r\n@Injectable()\r\nexport class CoordinatesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'coordinatesreverse';\r\n  static type = FEATURE;\r\n\r\n  private projections;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    @Inject('options') options: SearchSourceOptions,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('projections') projections: Projection[]\r\n  ) {\r\n    super(options, storageService);\r\n    this.projections = projections;\r\n    this.languageService.language$.subscribe(() => {\r\n      this.title$.next(this.languageService.translate.instant(this.options.title));\r\n    });\r\n  }\r\n\r\n  getId(): string {\r\n    return CoordinatesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CoordinatesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'igo.geo.search.coordinates.name',\r\n      order: 1,\r\n      showInSettings: false\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param options options of ReverseSearchOptions (distance, conf, zoom, params)\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    reverseSearchCoordsFormatEnabled?: boolean\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    return of([this.dataToResult(lonLat, options, reverseSearchCoordsFormatEnabled)]);\r\n  }\r\n\r\n  private dataToResult(data: [number, number], options: ReverseSearchOptions,\r\n    reverseSearchCoordsFormatEnabled: boolean): SearchResult<Feature> {\r\n\r\n    const dataDMS = convertDDToDMS(data);\r\n    const convertedCoord = lonLatConversion(data, this.projections);\r\n    const coords = convertedCoord.reduce((obj, item) => (\r\n      obj[item.alias] = item.igo2CoordFormat, obj), {});\r\n\r\n    const roundedCoordString = (!reverseSearchCoordsFormatEnabled) ?\r\n      roundCoordTo(data, 6).join(', ') : roundCoordTo(data, 6).reverse().join(', ');\r\n\r\n    const roundedCoordStringDMS = (!reverseSearchCoordsFormatEnabled) ?\r\n      dataDMS.join(', ') : dataDMS.reverse().join(', ');\r\n\r\n    let geometry: FeatureGeometry = {\r\n      type: 'Point',\r\n      coordinates: [data[0], data[1]]\r\n    };\r\n\r\n    const properties = {};\r\n    let subtitleHtml = '';\r\n    if (options.distance) {\r\n      const radiusKey = this.languageService.translate.instant('igo.geo.search.coordinates.radius');\r\n      properties[radiusKey] = options.distance;\r\n      subtitleHtml = '<br><small>Rayon: ' + options.distance + ' m</small>';\r\n\r\n      // Create polygon\r\n      const center = olproj.transform([data[0], data[1]], 'EPSG:4326', 'EPSG:3857');\r\n      const circleGeometry = new OlCircle(center, options.distance);\r\n      const polygonGeometry = fromCircle(circleGeometry);\r\n      const writer = new olformat.GeoJSON();\r\n      geometry = JSON.parse(writer.writeGeometry(polygonGeometry.transform('EPSG:3857', 'EPSG:4326')));\r\n    }\r\n\r\n    if (options.conf) {\r\n      const confKey = this.languageService.translate.instant('igo.geo.search.coordinates.conf');\r\n      properties[confKey] = options.conf;\r\n      subtitleHtml += subtitleHtml === '' ? '<br>' : '<small> - </small>';\r\n      subtitleHtml += '<small>Confiance: ' + options.conf + '%</small>';\r\n    }\r\n\r\n    const coordKey = (!reverseSearchCoordsFormatEnabled) ?\r\n      this.languageService.translate.instant('igo.geo.search.coordinates.coord'):\r\n      this.languageService.translate.instant('igo.geo.search.coordinates.reversedCoord');\r\n    properties[coordKey] = roundedCoordString;\r\n\r\n    const coordKeyDMS = (!reverseSearchCoordsFormatEnabled) ?\r\n     this.languageService.translate.instant('igo.geo.search.coordinates.coordDMS'):\r\n     this.languageService.translate.instant('igo.geo.search.coordinates.reversedCoordDMS');\r\n    properties[coordKeyDMS] = roundedCoordStringDMS;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent: undefined,\r\n        properties: Object.assign(\r\n          properties,\r\n          coords,\r\n          {\r\n            GoogleMaps: GoogleLinks.getGoogleMapsCoordLink(data[0], data[1]),\r\n            GoogleStreetView: GoogleLinks.getGoogleStreetViewLink(\r\n              data[0],\r\n              data[1]\r\n            ),\r\n            OpenStreetMap: OsmLinks.getOpenStreetMapLink(data[0], data[1], 14),\r\n            Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n          }\r\n        ),\r\n        meta: {\r\n          id: data[0].toString() + ',' + data[1].toString(),\r\n          title: roundedCoordString\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id: data[0].toString() + ',' + data[1].toString(),\r\n        title: roundedCoordString,\r\n        titleHtml: roundedCoordString + subtitleHtml,\r\n        icon: 'map-marker',\r\n        score: 100, // every coord exists\r\n      }\r\n    };\r\n  }\r\n}\r\n","import { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  CoordinatesReverseSearchSource,\r\n  CoordinatesSearchResultFormatter\r\n} from './coordinates';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { ProjectionService } from '../../../map/shared/projection.service';\r\n\r\n/**\r\n * Coordinate search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultCoordinatesSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new CoordinatesSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Coordinates search result formatter\r\n */\r\nexport function provideDefaultCoordinatesSearchResultFormatter() {\r\n  return {\r\n    provide: CoordinatesSearchResultFormatter,\r\n    useFactory: defaultCoordinatesSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * CoordinatesReverse search source factory\r\n * @ignore\r\n */\r\nexport function CoordinatesReverseSearchSourceFactory(\r\n  config: ConfigService,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  _projectionService: ProjectionService\r\n) {\r\n  return new CoordinatesReverseSearchSource(\r\n    config.getConfig(`searchSources.${CoordinatesReverseSearchSource.id}`),\r\n    languageService,\r\n    storageService,\r\n    (config.getConfig('projections') as Projection[]) || []\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Coordinate search source\r\n */\r\nexport function provideCoordinatesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: CoordinatesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService, LanguageService, StorageService, ProjectionService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\nimport { LAYER } from '../../../layer';\r\nimport { QueryableDataSourceOptions, QueryFormat } from '../../../query';\r\nimport { QueryHtmlTarget } from './../../../query/shared/query.enums';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { TextSearchOptions } from './source.interfaces';\r\nimport {\r\n  ILayerSearchSourceOptions,\r\n  ILayerData,\r\n  ILayerItemResponse,\r\n  ILayerServiceResponse,\r\n  ILayerDataSource\r\n} from './ilayer.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class ILayerSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(data: ILayerData): ILayerData {\r\n    const allowedKey = [\r\n      'title',\r\n      'abstract',\r\n      'groupTitle',\r\n      'metadataUrl',\r\n      'downloadUrl',\r\n      'urlInfo',\r\n      'name'\r\n    ];\r\n\r\n    const property = Object.entries(data.properties)\r\n      .filter(([key]) => allowedKey.indexOf(key) !== -1)\r\n      .reduce((out: { [key: string]: any }, entries: [string, any]) => {\r\n        const [key, value] = entries;\r\n        let newKey;\r\n        try {\r\n          newKey = this.languageService.translate.instant(\r\n            'igo.geo.search.ilayer.properties.' + key\r\n          );\r\n        } catch (e) {\r\n          newKey = key;\r\n        }\r\n        out[newKey] = value ? value : '';\r\n        return out;\r\n      }, {});\r\n\r\n    const dataR = Object.assign({}, data);\r\n    dataR.properties = property as ILayerDataSource;\r\n\r\n    return dataR;\r\n  }\r\n}\r\n\r\n/**\r\n * ILayer search source\r\n */\r\n@Injectable()\r\nexport class ILayerSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'ilayer';\r\n  static type = LAYER;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: ILayerSearchSourceOptions,\r\n    @Inject(ILayerSearchResultFormatter)\r\n    private formatter: ILayerSearchResultFormatter\r\n  ) {\r\n    super(options, storageService);\r\n    this.languageService.language$.subscribe(() => {\r\n      this.title$.next(this.languageService.translate.instant(this.options.title));\r\n    });\r\n  }\r\n\r\n  getId(): string {\r\n    return ILayerSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return ILayerSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): ILayerSearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n    return {\r\n      title: 'igo.geo.search.ilayer.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.layer',\r\n              value: 'layer',\r\n              enabled: true,\r\n              hashtags: ['layer', 'layers', 'couche', 'couches']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.groupLayer',\r\n              value: 'group',\r\n              enabled: false,\r\n              hashtags: ['gr-layer', 'gr-layers', 'gr-couche', 'gr-couches']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50 || !ecmax\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a layer by name or keyword\r\n   * @param term Layer name or keyword\r\n   * @returns Observable of <SearchResult<LayerOptions>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<ILayerItemResponse>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q') || !params.get('type')) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(\r\n        map((response: ILayerServiceResponse) => this.extractResults(response, term))\r\n      );\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(\r\n        Object.assign(\r\n          {\r\n            q: this.computeTerm(term)\r\n          },\r\n          this.params,\r\n          this.computeOptionsParam(term, options || {}).params,\r\n          {\r\n            page: options.page\r\n          }\r\n        )\r\n      )\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    return term.replace(/(#[^\\s]*)/g, '').replace(/[^\\wÀ-ÿ !\\-\\(\\),'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  private extractResults(\r\n    response: ILayerServiceResponse, term: string\r\n  ): SearchResult<ILayerItemResponse>[] {\r\n    return response.items.map((data: ILayerData) =>\r\n    this.dataToResult(data, term, response)\r\n    );\r\n  }\r\n\r\n  private dataToResult(\r\n    data: ILayerData,\r\n    term: string,\r\n    response?: ILayerServiceResponse\r\n  ): SearchResult<ILayerItemResponse> {\r\n    const layerOptions = this.computeLayerOptions(data);\r\n\r\n    const titleHtml = data.highlight.title || data.properties.title;\r\n    const groupTitle = data.highlight.groupTitle || data.properties.groupTitle;\r\n    const subtitleHtml = groupTitle\r\n      ? ' <small style=\"color: #6f6969\"> ' + groupTitle + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: LAYER,\r\n        id: [this.getId(), data.properties.id].join('.'),\r\n        title: data.properties.title,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.properties.type === 'Layer' ? 'layers' : 'map',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.name),\r\n        nextPage:\r\n          response.items.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      },\r\n      data: layerOptions\r\n    };\r\n  }\r\n\r\n  private computeLayerOptions(data: ILayerData): ILayerItemResponse {\r\n    const url = data.properties.url;\r\n    const queryParams: QueryableDataSourceOptions = this.extractQueryParamsFromSourceUrl(\r\n      url\r\n    );\r\n    return ObjectUtils.removeUndefined({\r\n      sourceOptions: {\r\n        id: data.properties.id,\r\n        type: data.properties.format,\r\n        url,\r\n        queryFormat: queryParams.queryFormat,\r\n        queryHtmlTarget: queryParams.queryHtmlTarget,\r\n        params: data.properties.format === 'wms' ? {LAYERS: data.properties.name} : undefined,\r\n        layer: data.properties.format === 'wms' ? undefined : data.properties.name,\r\n        optionsFromCapabilities: true,\r\n        crossOrigin: 'anonymous'\r\n      },\r\n      title: data.properties.title,\r\n      maxResolution: getResolutionFromScale(\r\n        Number(data.properties.maxScaleDenom)\r\n      ),\r\n      minResolution: getResolutionFromScale(\r\n        Number(data.properties.minScaleDenom)\r\n      ),\r\n      metadata: {\r\n        url: data.properties.metadataUrl,\r\n        extern: data.properties.metadataUrl ? true : undefined,\r\n        abstract: data.properties.abstract || undefined\r\n      },\r\n      properties: this.formatter.formatResult(data).properties\r\n    });\r\n  }\r\n\r\n  private extractQueryParamsFromSourceUrl(\r\n    url: string\r\n  ): { queryFormat: QueryFormat; queryHtmlTarget: QueryHtmlTarget } {\r\n    let queryFormat;\r\n    let queryHtmlTarget;\r\n    const formatOpt = (this.options as ILayerSearchSourceOptions).queryFormat;\r\n    if (formatOpt) {\r\n      for (const key of Object.keys(formatOpt)) {\r\n        const value = formatOpt[key];\r\n        if (value === '*') {\r\n          queryFormat = QueryFormat[key.toUpperCase()];\r\n          break;\r\n        }\r\n\r\n        const urls = ((value as any) as { urls: string[] }).urls;\r\n        if (Array.isArray(urls)) {\r\n          urls.forEach(urlOpt => {\r\n            if (url.indexOf(urlOpt) !== -1) {\r\n              queryFormat = QueryFormat[key.toUpperCase()];\r\n            }\r\n          });\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (\r\n        queryFormat === QueryFormat.HTML ||\r\n        queryFormat === QueryFormat.HTMLGML2\r\n      ) {\r\n        queryHtmlTarget = 'iframe';\r\n      }\r\n    }\r\n\r\n    return {\r\n      queryFormat,\r\n      queryHtmlTarget\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { ILayerSearchSource, ILayerSearchResultFormatter } from './ilayer';\r\n\r\n/**\r\n * ILayer search result formatter factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new ILayerSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search result formatter\r\n */\r\nexport function provideILayerSearchResultFormatter() {\r\n  return {\r\n    provide: ILayerSearchResultFormatter,\r\n    useFactory: ilayerSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ILayer search source factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: ILayerSearchResultFormatter\r\n) {\r\n  return new ILayerSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${ILayerSearchSource.id}`),\r\n    formatter\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search source\r\n */\r\nexport function provideILayerSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ilayerSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, ILayerSearchResultFormatter]\r\n  };\r\n}\r\n","import { FEATURE } from '../../feature';\r\nimport { LAYER } from '../../layer';\r\n\r\nexport const SEARCH_TYPES = [FEATURE, LAYER];\r\n","<div class=\"igo-search-selector\">\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-selector-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSelectorMenu\">\r\n    <mat-icon svgIcon=\"menu-down\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #searchSelectorMenu=\"matMenu\"\r\n    class=\"no-border-radius\"\r\n    xPosition=\"before\"\r\n    yPosition=\"above\">\r\n    <mat-radio-group\r\n      class=\"igo-search-selector-radio-group\"\r\n      [value]=\"searchType$ | async\"\r\n      (change)=\"onSearchTypeChange($event.value)\">\r\n      <mat-radio-button *ngFor=\"let searchType of searchTypes\" [value]=\"searchType\">\r\n        {{getSearchTypeTitle(searchType) | translate}}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n  </mat-menu>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-selector',\r\n  templateUrl: './search-selector.component.html',\r\n  styleUrls: ['./search-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSelectorComponent implements OnInit, OnDestroy {\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * The search type enabled\r\n   */\r\n  @Input()\r\n  set searchType(value: string) { this.setSearchType(value); }\r\n  get searchType(): string { return this.searchType$.value; }\r\n\r\n  /**\r\n   * Event emitted when the enabled search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  constructor(private searchSourceService: SearchSourceService) {}\r\n\r\n  ngOnInit() {\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Enable the selected search type\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Get a search type's title. The title\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  getSearchTypeTitle(searchType: string) {\r\n    return `igo.geo.search.${searchType.toLowerCase()}.title`;\r\n  }\r\n\r\n  /**\r\n   * Emit an event and enable the search sources of the given type.\r\n   * @param searchType Search type\r\n   */\r\n  private setSearchType(searchType: string | undefined) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchTypeChange.emit(searchType);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { SearchSelectorComponent } from './search-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatTabsModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSelectorComponent],\r\n  declarations: [SearchSelectorComponent]\r\n})\r\nexport class IgoSearchSelectorModule {}\r\n","<div class=\"igo-search-settings\">\r\n\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-settings-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSettingsMenu\">\r\n    <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n  </button>\r\n  <mat-menu\r\n    #searchSettingsMenu=\"matMenu\"\r\n    class=\"no-border-radius\">\r\n    <div class=\"checkAllButton\" *ngIf=\"getSearchSources().length>4\">\r\n      <button mat-raised-button\r\n        (click)=\"checkUncheckAllSources($event)\">{{!searchSourcesAllEnabled  ? ('igo.geo.search.searchSources.unselectAll' | translate): ('igo.geo.search.searchSources.selectAll' | translate)}}</button>\r\n    </div>\r\n      <ng-container *ngFor=\"let source of getSearchSources()\">\r\n        <span class=\"igo-search-settings-search-source\">\r\n          <mat-checkbox\r\n            class=\"igo-search-settings-checkbox\"\r\n            [checked]=\"source.enabled\"\r\n            [value]=\"source\"\r\n            (click)=\"$event.stopPropagation()\"\r\n            (change)=\"onCheckSearchSource($event, source)\">\r\n          </mat-checkbox>\r\n          <button *ngIf=\"source.settings.length > 0\"\r\n            [matMenuTriggerFor]=\"sub_menu\"\r\n            mat-menu-item>{{source.title}}\r\n          </button>\r\n          <button\r\n            mat-menu-item\r\n            *ngIf=\"source.settings.length === 0\">\r\n            {{source.title}}\r\n          </button>\r\n        </span>\r\n          <mat-menu #sub_menu=\"matMenu\">\r\n            <ng-container *ngFor=\"let setting of source.settings\">\r\n              <button\r\n                  mat-menu-item\r\n                  [matMenuTriggerFor]=\"test_sub_menu\">\r\n                {{'igo.geo.search.searchSources.settings.'+ setting.title | translate}}\r\n              </button>\r\n              <mat-menu #test_sub_menu=\"matMenu\"\r\n                [ngSwitch]=\"setting.type\"\r\n                yPosition=\"above\">\r\n                <span *ngSwitchCase=\"'radiobutton'\">\r\n                  <mat-radio-group\r\n                    class=\"igo-search-settings-radio-group\"\r\n                    [value]=\"setting\">\r\n                    <mat-radio-button *ngFor=\"let settingValue of setting.values\"\r\n                      class=\"mat-typography\"\r\n                      [value]=\"settingValue\"\r\n                      [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                      [checked]=\"settingValue.enabled\"\r\n                      (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"settingsValueCheckedRadioButton($event, source, setting, settingValue)\">\r\n                      {{settingValue.title | translate}}\r\n                    </mat-radio-button>\r\n                  </mat-radio-group>\r\n                </span>\r\n                <span *ngSwitchCase=\"'checkbox'\">\r\n                  <div class=\"checkAllButton\" *ngIf=\"setting.values.length > 3\">\r\n                    <button mat-raised-button\r\n                      (click)=\"checkUncheckAll($event, source, setting)\">{{setting.allEnabled || setting.allEnabled === undefined  ? ('igo.geo.search.searchSources.settings.unselectAll' | translate): ('igo.geo.search.searchSources.settings.selectAll' | translate)}}</button>\r\n                  </div>\r\n                  <mat-checkbox *ngFor=\"let settingValue of getAvailableValues(setting)\"\r\n                    class=\"mat-menu-item\"\r\n                    [style.display]=\"displayBlock\"\r\n                    [checked]=\"settingValue.enabled\"\r\n                    [value]=\"setting\"\r\n                    [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                    (click)=\"$event.stopPropagation()\"\r\n                    (change)=\"settingsValueCheckedCheckbox($event, source, setting, settingValue)\">\r\n                    {{settingValue.title | translate}}\r\n                  </mat-checkbox>\r\n                </span>\r\n              </mat-menu>\r\n            </ng-container>\r\n          </mat-menu>\r\n      </ng-container>\r\n        <mat-divider></mat-divider>\r\n        <span class=\"pointer-summary-slide-toggle-container mat-typography\">\r\n          <mat-slide-toggle class=\"search-option\" (change)=\"changePointerReverseSearch($event)\" tooltip-position=\"below\"\r\n            *ngIf=\"hasPointerReverseSearchSource && !isTouchScreen\" \r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.pointerSearchSummary.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"pointerSummaryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.pointerSearchSummary.title' | translate}}\r\n          </mat-slide-toggle>\r\n          <mat-slide-toggle class=\"search-option\" (change)=\"changeSearchResultsGeometry($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.searchResultsGeometry.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"searchResultsGeometryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.searchResultsGeometry.title' | translate}}\r\n          </mat-slide-toggle>\r\n          <mat-slide-toggle class=\"search-option\" (change)=\"reverseSearchCoordsFormat($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"reverseSearchCoordsFormatEnabled ? ('igo.geo.search.reverseCoordFormat.tooltipLatLon' | translate)\r\n            : ('igo.geo.search.reverseCoordFormat.tooltipLonLat' | translate)\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"reverseSearchCoordsFormatEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.reverseCoordFormat.title' | translate}}\r\n          </mat-slide-toggle>\r\n        </span>\r\n  </mat-menu>\r\n</div>\r\n","import { MatCheckboxChange } from '@angular/material/checkbox';\r\nimport { MatRadioChange } from '@angular/material/radio';\r\n\r\nimport {\r\n  Component,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  HostListener,\r\n  Input\r\n} from '@angular/core';\r\n\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\nimport { SearchSource } from '../shared/sources/source';\r\nimport {\r\n  SearchSourceSettings,\r\n  SettingOptions\r\n} from '../shared/sources/source.interfaces';\r\nimport {\r\n  sourceCanReverseSearchAsSummary,\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch\r\n} from '../shared/search.utils';\r\nimport { MediaService, StorageService } from '@igo2/core';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-settings',\r\n  templateUrl: './search-settings.component.html',\r\n  styleUrls: ['./search-settings.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSettingsComponent implements OnInit {\r\n  public hasPointerReverseSearchSource: boolean = false;\r\n  public searchSourcesAllEnabled: boolean = false;\r\n\r\n  public buffer = [];\r\n  public lastKeyTime = Date.now();\r\n\r\n  public displayBlock = 'block';\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n  @Input() reverseSearchCoordsFormatEnabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the enabled search source changes\r\n   */\r\n  @Output() searchSourceChange = new EventEmitter<SearchSource>();\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry summary is changed\r\n   */\r\n  @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the coords format is changed\r\n   */\r\n  @Output() reverseSearchCoordsFormatStatus = new EventEmitter<boolean>();\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    if (event.key === 'F2') {\r\n      this.pointerSummaryEnabled = !this.pointerSummaryEnabled;\r\n      this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.hasPointerReverseSearchSource = this.hasReverseSearchSourcesForPointerSummary();\r\n  }\r\n\r\n  /**\r\n   * Get all search sources\r\n   * @internal\r\n   */\r\n  getSearchSources(): SearchSource[] {\r\n    const textSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n\r\n    const reverseSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanReverseSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n    const sources = textSearchSources.concat(reverseSearchSources);\r\n    this.computeSourcesCheckAllBehavior(sources);\r\n    return sources;\r\n  }\r\n\r\n  /**\r\n   * Get all search sources usable for pointer summary\r\n   * @internal\r\n   */\r\n  hasReverseSearchSourcesForPointerSummary(): boolean {\r\n    if (\r\n      this.searchSourceService\r\n        .getEnabledSources()\r\n        .filter(sourceCanReverseSearchAsSummary).length\r\n    ) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (checkbox style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedCheckbox(\r\n    event: MatCheckboxChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    settingValue.enabled = event.checked;\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (settings)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSettingCheckAllBehavior(setting: SearchSourceSettings) {\r\n    if (setting.allEnabled === undefined) {\r\n      if (setting.values.find((settingValue) => settingValue.enabled)) {\r\n        setting.allEnabled = false;\r\n      } else {\r\n        setting.allEnabled = true;\r\n      }\r\n    } else {\r\n      setting.allEnabled = !setting.allEnabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (sources)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSourcesCheckAllBehavior(sources: SearchSource[]) {\r\n    const enabledSourcesCnt = sources.filter((source) => source.enabled).length;\r\n    const disabledSourcesCnt = sources.filter((source) => !source.enabled)\r\n      .length;\r\n    this.searchSourcesAllEnabled =\r\n      enabledSourcesCnt >= disabledSourcesCnt ? false : true;\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAll(event, source: SearchSource, setting: SearchSourceSettings) {\r\n    event.stopPropagation();\r\n    this.computeSettingCheckAllBehavior(setting);\r\n    setting.values.forEach((settingValue) => {\r\n      settingValue.enabled = setting.allEnabled;\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAllSources(event) {\r\n    event.stopPropagation();\r\n    this.getSearchSources().map((source) => {\r\n      source.enabled = this.searchSourcesAllEnabled;\r\n      this.searchSourceChange.emit(source);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (radiobutton style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedRadioButton(\r\n    event: MatRadioChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    setting.values.forEach((conf) => {\r\n      if (conf.value !== settingValue.value) {\r\n        conf.enabled = !event.source.checked;\r\n      } else {\r\n        conf.enabled = event.source.checked;\r\n      }\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  onCheckSearchSource(event: MatCheckboxChange, source: SearchSource) {\r\n    source.enabled = event.checked;\r\n    const storage = (this.storageService.get(source.getId() + '.options') || {}) as SettingOptions;\r\n    storage.enabled = source.enabled;\r\n    this.storageService.set(\r\n      source.getId() + '.options',\r\n      storage\r\n    );\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  getAvailableValues(setting: SearchSourceSettings) {\r\n    return setting.values.filter((s) => s.available !== false);\r\n  }\r\n\r\n  getAvailableHashtagsValues(setting: SettingOptions) {\r\n    if (setting.hashtags) {\r\n      return setting.hashtags.map((h) => '#' + h).join(', ');\r\n    }\r\n    return;\r\n  }\r\n\r\n  stopPropagation(event) {\r\n    event.stopPropagation();\r\n  }\r\n\r\n  changePointerReverseSearch(event) {\r\n    this.pointerSummaryEnabled = event.checked;\r\n    this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n  }\r\n\r\n  changeSearchResultsGeometry(event) {\r\n    this.searchResultsGeometryEnabled = event.checked;\r\n    this.searchResultsGeometryStatus.emit(this.searchResultsGeometryEnabled);\r\n  }\r\n\r\n  reverseSearchCoordsFormat(event) {\r\n    this.reverseSearchCoordsFormatEnabled = event.checked;\r\n    this.reverseSearchCoordsFormatStatus.emit(this.reverseSearchCoordsFormatEnabled);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { SearchSettingsComponent } from './search-settings.component';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  declarations: [SearchSettingsComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatCheckboxModule,\r\n    MatDividerModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSettingsComponent]\r\n})\r\nexport class IgoSearchSettingsModule { }\r\n","<div class=\"igo-search-bar-container\" [ngClass]=\"{empty: empty$ | async}\">\r\n  <mat-form-field [floatLabel]=\"floatLabel\" [appearance]=\"appearance\">\r\n    <mat-label *ngIf=\"label\">{{label}}</mat-label>\r\n    <input\r\n      #input\r\n      matInput\r\n      autocomplete=\"off\"\r\n      [ngClass]=\"{'hasSearchIcon': showSearchButton}\"\r\n      [disabled]=\"disabled$ | async\"\r\n      [placeholder]=\"placeholder ? placeholder : (placeholder$ | async) ? (placeholder$.value | translate) : undefined\"\r\n      [value]=\"term$ | async\"\r\n      (keyup)=\"onKeyup($event)\"\r\n      (touchend)=\"onKeyup($event)\">\r\n  </mat-form-field>\r\n\r\n  <div class=\"search-bar-buttons\">\r\n    <button *ngIf=\"(empty$ | async)===false\"\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      (click)=\"onClearButtonClick()\"\r\n      [matTooltip]=\"'igo.geo.search.clearSearch' | translate\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n    \r\n    <button *ngIf=\"showSearchButton\"\r\n      mat-icon-button\r\n      [color]=\"color\">\r\n      <mat-icon svgIcon=\"magnify\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-search-selector\r\n      *ngIf=\"searchSelector\"\r\n      [searchTypes]=\"searchTypes\"\r\n      [searchType]=\"searchType$ | async\"\r\n      (searchTypeChange)=\"onSearchTypeChange($event)\">\r\n    </igo-search-selector>\r\n\r\n    <igo-search-settings\r\n      *ngIf=\"searchSettings\"\r\n      [pointerSummaryEnabled]=\"pointerSummaryEnabled\"\r\n      (pointerSummaryStatus)=\"pointerSummaryStatus.emit($event)\"\r\n      [searchResultsGeometryEnabled]=\"searchResultsGeometryEnabled\"\r\n      (searchResultsGeometryStatus)=\"searchResultsGeometryStatus.emit($event)\"\r\n      [reverseSearchCoordsFormatEnabled]=\"reverseSearchCoordsFormatEnabled\"\r\n      (reverseSearchCoordsFormatStatus)=\"reverseSearchCoordsFormatStatus.emit($event)\"\r\n      (searchSourceChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-settings>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport {\r\n  FloatLabelType,\r\n  MatFormFieldAppearance\r\n} from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription, timer } from 'rxjs';\r\nimport { debounce, distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * Searchbar that triggers a research in all search sources enabled.\r\n * If the store input is defined, the search results will be loaded\r\n * into that store. An event is always emitted when a research is completed.\r\n */\r\n@Component({\r\n  selector: 'igo-search-bar',\r\n  templateUrl: './search-bar.component.html',\r\n  styleUrls: ['./search-bar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchBarComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Invalid keys\r\n   */\r\n  static invalidKeys = [\r\n    'Control',\r\n    'Shift',\r\n    'Alt',\r\n    'ArrowDown',\r\n    'ArrowUp',\r\n    'ArrowRight',\r\n    'ArrowLeft'\r\n  ];\r\n\r\n  readonly placeholder$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.search.placeholder'\r\n  );\r\n\r\n  readonly empty$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  /**\r\n   * Subscription to the ssearch bar term\r\n   */\r\n  private term$$: Subscription;\r\n\r\n  /**\r\n   * Search term stream\r\n   */\r\n  private stream$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Subscription to the search term stream\r\n   */\r\n  private stream$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  private researches$$: Subscription[];\r\n\r\n  /**\r\n   * whether to show search button or not\r\n   */\r\n\r\n  public showSearchButton: boolean = false;\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set searchType(value: string) {\r\n    this.setSearchType(value);\r\n  }\r\n  get searchType(): string {\r\n    return this.searchType$.value;\r\n  }\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated by the searchbar setting\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry setting is changed\r\n   */\r\n   @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n   /**\r\n   * Event emitted when the coords format setting is changed\r\n   */\r\n   @Output() reverseSearchCoordsFormatStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this.setTerm(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n  readonly term$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Whether this component is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) {\r\n    this.disabled$.next(value);\r\n  }\r\n  get disabled(): boolean {\r\n    return this.disabled$.value;\r\n  }\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n\r\n  /**\r\n   * When reverse coordinates status change\r\n   */\r\n  @Input()\r\n  get reverseSearchCoordsFormatEnabled(): boolean {\r\n    return this._reverseSearchCoordsFormatEnabled;\r\n  }\r\n  set reverseSearchCoordsFormatEnabled(value: boolean) {\r\n    this._reverseSearchCoordsFormatEnabled = value;\r\n    this.setTerm(this.term, true);\r\n  }\r\n  private _reverseSearchCoordsFormatEnabled = false;\r\n\r\n  /**\r\n   * Whether a float label should be displayed\r\n   */\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  @Input() appearance: MatFormFieldAppearance = 'legacy';\r\n\r\n  @Input() placeholder: string;\r\n\r\n  @Input() label: string;\r\n\r\n  /**\r\n   * Icons color (search and clear)\r\n   */\r\n  @Input() color = 'primary';\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Debounce time between each keystroke\r\n   */\r\n  @Input() debounce = 200;\r\n\r\n  /**\r\n   * Minimum term length required to trigger a research\r\n   */\r\n  @Input() minLength = 2;\r\n\r\n  /**\r\n   * Search Selector\r\n   */\r\n  @Input() searchSelector = false;\r\n\r\n  /**\r\n   * Search Settings\r\n   */\r\n  @Input() searchSettings = false;\r\n\r\n  /**\r\n   * Force coordinates in north america\r\n   */\r\n  @Input() forceNA = false;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * Event emitted when the search term changes\r\n   */\r\n  @Output() searchTermChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed\r\n   */\r\n  @Output() search = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() clearFeature = new EventEmitter();\r\n\r\n  /**\r\n   * Event emitted when the search settings changes\r\n   */\r\n  @Output() searchSettingsChange = new EventEmitter();\r\n\r\n  /**\r\n   * Input element\r\n   * @internal\r\n   */\r\n  @ViewChild('input', { static: true }) input: ElementRef;\r\n\r\n  /**\r\n   * Whether the search bar is empty\r\n   * @internal\r\n   */\r\n  get empty(): boolean {\r\n    return this.term.length === 0;\r\n  }\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe((term: string) => {\r\n      this.empty$.next(term === undefined || term.length === 0);\r\n    });\r\n\r\n    this.stream$$ = this.stream$\r\n      .pipe(\r\n        debounce(() => timer(this.debounce))\r\n      )\r\n      .subscribe((term: string) => this.onSetTerm(term));\r\n\r\n    this.handlePlaceholder();\r\n\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n\r\n    const configValue = this.configService.getConfig(\"searchBar.showSearchButton\");\r\n    this.showSearchButton = configValue !== undefined ? configValue : false;\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the search term stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.term$$.unsubscribe();\r\n    this.stream$$.unsubscribe();\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When a user types, validates the key and send it into the\r\n   * stream if it's valid\r\n   * @param event Keyboard event\r\n   * @internal\r\n   */\r\n  onKeyup(event: KeyboardEvent) {\r\n    const key = event.key;\r\n    if (!this.keyIsValid(key)) {\r\n      return;\r\n    }\r\n    const term = (event.target as HTMLInputElement).value;\r\n    this.setTerm(term);\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   * @internal\r\n   */\r\n  onClearButtonClick() {\r\n    this.clear();\r\n    this.clearFeature.emit();\r\n  }\r\n\r\n  /**\r\n   * Update search type\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Update the placeholder with the enabled search type. The placeholder\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  setSearchType(searchType: string) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.doSearch(this.term);\r\n    this.searchSettingsChange.emit();\r\n    this.handlePlaceholder();\r\n  }\r\n\r\n  /**\r\n   * Send the term into the stream only if this component is not disabled\r\n   * @param term Search term\r\n   */\r\n  setTerm(term: string, reverseCoordEvent?: boolean) {\r\n\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    term = term || '';\r\n\r\n    if (term !== this.term && !reverseCoordEvent) {\r\n      this.term$.next(term);\r\n    }\r\n\r\n    const slug = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (slug.length >= this.minLength || slug.length === 0) {\r\n      this.stream$.next(term);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   */\r\n  private clear() {\r\n    this.term$.next('');\r\n    this.stream$.next('');\r\n    this.input.nativeElement.focus();\r\n  }\r\n\r\n  /**\r\n   * Validate if a given key stroke is a valid input\r\n   */\r\n  private keyIsValid(key: string) {\r\n    return SearchBarComponent.invalidKeys.indexOf(key) === -1;\r\n  }\r\n\r\n  /**\r\n   * When the search term changes, emit an event and trigger a\r\n   * research in every enabled search sources.\r\n   * @param term Search term\r\n   */\r\n  private onSetTerm(term: string | undefined) {\r\n    this.searchTermChange.emit(term);\r\n    this.doSearch(term);\r\n  }\r\n\r\n  private handlePlaceholder() {\r\n    const searchTypes = [\r\n      ...new Set(\r\n        this.searchSourceService\r\n          .getEnabledSources()\r\n          .filter((ss) => !['map', 'coordinatesreverse'].includes(ss.getId()))\r\n          .map((ss) => ss.getType())\r\n      )\r\n    ];\r\n\r\n    let placeholder = `igo.geo.search.placeholder`;\r\n    if (searchTypes.length === 1) {\r\n      placeholder = `igo.geo.search.${searchTypes[0].toLowerCase()}.placeholder`;\r\n    } else if (searchTypes.length === 0) {\r\n      placeholder = `igo.geo.search.emptyType.placeholder`;\r\n    }\r\n    this.placeholder$.next(placeholder);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchTypeChange.emit(searchType);\r\n\r\n    const placeholder = `igo.geo.search.${searchType.toLowerCase()}.placeholder`;\r\n    this.placeholder$.next(placeholder);\r\n\r\n    this.setTerm(this.term);\r\n  }\r\n\r\n  /**\r\n   * Execute the search\r\n   * @param term Search term\r\n   */\r\n  private doSearch(rawTerm: string | undefined) {\r\n    if (this.researches$$) {\r\n      this.researches$$.map((research) => research.unsubscribe());\r\n      this.researches$$ = undefined;\r\n    }\r\n\r\n    let terms;\r\n    if (this.termSplitter && rawTerm.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = rawTerm.split(this.termSplitter).filter((t) => t.length >= this.minLength);\r\n      if (this.store) {\r\n        this.store.clear();\r\n      }\r\n    } else {\r\n      terms = [rawTerm];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      const slug = term ? term.replace(/(#[^\\s]*)/g, '').trim() : '';\r\n      if (slug === '') {\r\n        if (this.store !== undefined) {\r\n          this.store.clear();\r\n        }\r\n        return;\r\n      }\r\n\r\n      researches = researches.concat(this.searchService.search(term, {\r\n        forceNA: this.forceNA\r\n      }));\r\n    });\r\n    this.researches$$ = researches.map((research) => {\r\n      return research.request.subscribe((results: SearchResult[]) => {\r\n        this.onResearchCompleted(research, results);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * When a research  is completed, emit an event and update\r\n   * the store's items.\r\n   * @param research Research\r\n   * @param results Research results\r\n   */\r\n  private onResearchCompleted(research: Research, results: SearchResult[]) {\r\n    this.search.emit({ research, results });\r\n\r\n    if (this.store !== undefined) {\r\n      const newResults = this.store\r\n        .all()\r\n        .filter((result) => result.source !== research.source)\r\n        .concat(results);\r\n      this.store.updateMany(newResults);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoSearchSelectorModule } from '../search-selector/search-selector.module';\r\nimport { IgoSearchSettingsModule } from '../search-settings/search-settings.module';\r\nimport { SearchBarComponent } from './search-bar.component';\r\nimport { SearchUrlParamDirective } from './search-url-param.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    IgoLanguageModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    SearchBarComponent,\r\n  ],\r\n  declarations: [\r\n    SearchBarComponent,\r\n    SearchUrlParamDirective\r\n  ]\r\n})\r\nexport class IgoSearchBarModule {}\r\n","<mat-list-item (mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\">\r\n  <mat-icon *ngIf=\"icon\" mat-list-avatar svgIcon=\"{{showIcons ? icon : 'blank'}}\"></mat-icon>\r\n\r\n  <h4 matLine *ngIf=\"titleHtml\" [innerHtml]=\"titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"tooltipHtml\" matTooltipClass=\"search-result-tooltip\"></h4>\r\n  <h4 matLine *ngIf=\"!titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"title\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"withZoomButton\"\r\n    igoStopPropagation\r\n    mat-icon-button\r\n    (click)=\"onZoomHandler()\">\r\n    <mat-icon svgIcon=\"magnify\"></mat-icon>\r\n  </button>\r\n\r\n  <ng-content\r\n    select=[igoSearchItemToolbar]>\r\n  </ng-content>\r\n\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, EventEmitter, Output } from '@angular/core';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport {\r\n  getEntityTitle,\r\n  getEntityTitleHtml,\r\n  getEntityIcon\r\n} from '@igo2/common';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { FeatureMotion, moveToOlFeatures } from '../../feature';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Search results list item\r\n */\r\n@Component({\r\n  selector: 'igo-search-results-item',\r\n  templateUrl: './search-results-item.component.html',\r\n  styleUrls: ['./search-results-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsItemComponent {\r\n  /**\r\n   * Search result item\r\n   */\r\n  @Input() result: SearchResult;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search result title\r\n   * @internal\r\n   */\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  @Output() zoomEvent = new EventEmitter<boolean>();\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get title(): string {\r\n    return getEntityTitle(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result HTML title\r\n   * @internal\r\n   */\r\n  get titleHtml(): string {\r\n    return getEntityTitleHtml(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result tooltip\r\n   * @internal\r\n   */\r\n  get tooltipHtml(): string {\r\n    return this.titleHtml\r\n      .replace(/<small?[^>]+(>|$)/g, '\\n')\r\n      .replace(/<\\/?[^>]+(>|$)/g, '');\r\n  }\r\n\r\n  /**\r\n   * Search result icon\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.result);\r\n  }\r\n\r\n  onZoomHandler() {\r\n    const olFeature = this.format.readFeature(this.result.data, {\r\n      dataProjection: this.result.data.projection,\r\n      featureProjection: this.map.projection\r\n    });\r\n    moveToOlFeatures(this.map, [olFeature], FeatureMotion.Default);\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    const element = event.target;\r\n    const type = event.type;\r\n    switch (type) {\r\n      case 'mouseenter':\r\n        const hideBtn = element.querySelector('#hide-save-search-result-btn');\r\n        (hideBtn) ?\r\n        hideBtn.setAttribute('id', 'show-save-search-result-btn') : null;\r\n        break;\r\n      case 'mouseleave':\r\n        const showBtn = element.querySelector('#show-save-search-result-btn');\r\n        (showBtn) ?\r\n        showBtn.setAttribute('id', 'hide-save-search-result-btn') : null;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\" *ngIf=\"tabsMode === false\">\r\n  <ng-template\r\n    #groupTemplate\r\n    ngFor let-group\r\n    [ngForOf]=\"results$ | async\">\r\n\r\n    <igo-collapsible [class]=\"group.source.getId()\"\r\n      *ngIf=\"mode === searchResultMode.Grouped; else flatTemplate\"\r\n      [title]=\"computeGroupTitle(group)\"\r\n      [collapsed]=\"collapsed[group.source.title]\"\r\n      (toggle)=\"collapsed[group.source.title] = $event\">\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </igo-collapsible>\r\n\r\n    <ng-template #flatTemplate>\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </ng-template>\r\n\r\n    <ng-template #storeItemTemplate let-results=\"results\">\r\n      <ng-template ngFor let-result [ngForOf]=\"results\">\r\n        <igo-search-results-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [map]=\"map\"\r\n          [result]=\"result\"\r\n          [showIcons]=\"showIcons\"\r\n          [withZoomButton]=\"withZoomButton\"\r\n          [focused]=\"store.state.get(result).focused\"\r\n          [selected]=\"store.state.get(result).selected\"\r\n          (focus)=\"resultFocus.emit(result)\"\r\n          (unfocus)=\"resultUnfocus.emit(result)\"\r\n          (select)=\"onResultSelect(result)\"\r\n          (mouseenter)=\"resultFocus.emit(result)\"\r\n          (mouseleave)=\"resultUnfocus.emit(result)\">\r\n\r\n          <ng-container igoSearchItemToolbar\r\n            [ngTemplateOutlet]=\"templateSearchToolbar\"\r\n            [ngTemplateOutletContext]=\"{result: result}\">\r\n          </ng-container>\r\n\r\n        </igo-search-results-item>\r\n      </ng-template>\r\n      <span class=\"moreResults mat-typography\" *ngIf=\"isMoreResults(group)\" (click)=\"displayMoreResults(group)\">\r\n        <u>{{ 'igo.geo.search.displayMoreResults' | translate }}</u>\r\n      </span>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n\r\n</igo-list>\r\n\r\n<igo-list [navigation]=\"true\" *ngIf=\"tabsMode\">\r\n\r\n  <ng-container *ngIf=\"mode === searchResultMode.Grouped; then tabsTemplate else flatTemplate\"></ng-container>\r\n\r\n  <ng-template #tabsTemplate>\r\n    <mat-tab-group class=\"custom-tabs-view\" dynamicHeight>\r\n      <mat-tab *ngFor=\"let group of results$ | async\" [label]=\"computeGroupTitle(group)\">\r\n        <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {group: group}\"></ng-container>\r\n      </mat-tab>\r\n    </mat-tab-group>\r\n  </ng-template>\r\n\r\n  <ng-template #flatTemplate>\r\n    <ng-template ngFor let-group [ngForOf]=\"results$ | async\">\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {group: group}\"></ng-container>\r\n    </ng-template>\r\n  </ng-template>\r\n\r\n  <ng-template #storeItemTemplate let-group=\"group\">\r\n    <ng-template ngFor let-result [ngForOf]=\"group.results\">\r\n      <igo-search-results-item\r\n        igoListItem\r\n        color=\"accent\"\r\n        [map]=\"map\"\r\n        [result]=\"result\"\r\n        [showIcons]=\"showIcons\"\r\n        [withZoomButton]=\"withZoomButton\"\r\n        [focused]=\"store.state.get(result).focused\"\r\n        [selected]=\"store.state.get(result).selected\"\r\n        (focus)=\"resultFocus.emit(result)\"\r\n        (unfocus)=\"resultUnfocus.emit(result)\"\r\n        (select)=\"onResultSelect(result)\"\r\n        (mouseenter)=\"resultFocus.emit(result)\"\r\n        (mouseleave)=\"resultUnfocus.emit(result)\">\r\n\r\n        <ng-container igoSearchItemToolbar\r\n          [ngTemplateOutlet]=\"templateSearchToolbar\"\r\n          [ngTemplateOutletContext]=\"{result: result}\">\r\n        </ng-container>\r\n\r\n      </igo-search-results-item>\r\n    </ng-template>\r\n    <span class=\"moreResults mat-typography\" *ngIf=\"isMoreResults(group)\" (click)=\"displayMoreResults(group)\">\r\n      <u>{{ 'igo.geo.search.displayMoreResults' | translate }}</u>\r\n    </span>\r\n  </ng-template>\r\n</igo-list>","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ContentChild,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { Observable, EMPTY, timer, BehaviorSubject, Subscription } from 'rxjs';\r\nimport { debounce, map } from 'rxjs/operators';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { EntityState, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { TextSearchOptions } from '../shared/sources/source.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchSource } from '../shared/sources/source';\r\n\r\nexport enum SearchResultMode {\r\n  Grouped = 'grouped',\r\n  Flat = 'flat'\r\n}\r\n\r\n/**\r\n * List of search results with focus and selection capabilities.\r\n * This component is dumb and only emits events.\r\n */\r\n@Component({\r\n  selector: 'igo-search-results',\r\n  templateUrl: './search-results.component.html',\r\n  styleUrls: ['./search-results.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsComponent implements OnInit, OnDestroy {\r\n\r\n  private showResultsCount: boolean = true;\r\n\r\n  /**\r\n   * Reference to the SearchResultMode enum\r\n   * @internal\r\n   */\r\n  public searchResultMode = SearchResultMode;\r\n\r\n  /**\r\n   * Search results store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<SearchResult>;\r\n\r\n  private settingsChange$$: Subscription;\r\n\r\n  public pageIterator: {sourceId: string}[] = [];\r\n\r\n  public collapsed: {sourceId: string}[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Search results display mode\r\n   */\r\n  @Input() mode: SearchResultMode = SearchResultMode.Grouped;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  /**\r\n   * To check if the view for tabsMode for search-result-tools\r\n   */\r\n  @Input() tabsMode: boolean = false;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.pageIterator = [];\r\n  }\r\n  public _term: string;\r\n\r\n  @Input() settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Event emitted when a result is focused\r\n   */\r\n  @Output() resultFocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is unfocused\r\n   */\r\n  @Output() resultUnfocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is selected\r\n   */\r\n  @Output() resultSelect = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed after displaying more results is clicked\r\n   */\r\n  @Output() moreResults = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Events emitted when a result is focus or unfocus by mouse event\r\n   */\r\n  @Output() resultMouseenter = new EventEmitter<SearchResult>();\r\n  @Output() resultMouseleave = new EventEmitter<SearchResult>();\r\n\r\n  @ContentChild('igoSearchItemToolbar', /* TODO: add static flag */ {}) templateSearchToolbar: TemplateRef<any>;\r\n\r\n  get results$(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    if (this._results$ === undefined) {\r\n      this._results$ = this.liftResults();\r\n    }\r\n    return this._results$;\r\n  }\r\n  private _results$: Observable<\r\n    {source: SearchSource; results: SearchResult[]}[]\r\n  >;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n              private searchService: SearchService,\r\n              private configService: ConfigService,\r\n              ) {}\r\n\r\n  /**\r\n   * Bind the search results store to the watcher\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.settingsChange$$ = this.settingsChange$.subscribe(() => {\r\n      this.pageIterator = [];\r\n    });\r\n\r\n    if (this.configService.getConfig('searchSources.showResultsCount') === false) {\r\n      this.showResultsCount = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind the search results store from the watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.settingsChange$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Compute a group title\r\n   * @param group Search results group\r\n   * @returns Group title\r\n   * @internal\r\n   */\r\n  computeGroupTitle(group: {source: SearchSource; results: SearchResult[]}): string {\r\n    const parts = [group.source.title];\r\n    const count = group.results.length;\r\n    if (count > 1 && this.showResultsCount) {\r\n      parts.push(`(${count})`);\r\n    }\r\n    return parts.join(' ');\r\n  }\r\n\r\n  /**\r\n   * When a result is selected, update it's state in the store and emit\r\n   * an event. A selected result is also considered focused\r\n   * @param result Search result\r\n   * @internal\r\n   */\r\n  onResultSelect(result: SearchResult) {\r\n    if (this.store.state.get(result)) {\r\n      if (this.store.state.get(result).selected === true) {\r\n        return;\r\n      }\r\n    }\r\n    this.store.state.update(result, {focused: true, selected: true}, true);\r\n    this.resultSelect.emit(result);\r\n  }\r\n\r\n  /**\r\n   * Return an observable of the search results, grouped by search source\r\n   * @returns Observable of grouped search results\r\n   * @internal\r\n   */\r\n   private liftResults(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    return this.store.stateView.all$().pipe(\r\n      debounce((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return results.length === 0 ? EMPTY : timer(200);\r\n      }),\r\n      map((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return this.groupResults(results.map(r => r.entity).sort(this.sortByOrder));\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n  private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n    return r1.source.displayOrder - r2.source.displayOrder;\r\n  }\r\n\r\n  /**\r\n   * Group results by search source\r\n   * @param results Search results from all sources\r\n   * @returns Search results grouped by source\r\n   */\r\n  private groupResults(results: SearchResult[]): {source: SearchSource; results: SearchResult[]}[] {\r\n    const grouped = new Map<SearchSource, SearchResult[]>();\r\n    results.forEach((result: SearchResult) => {\r\n      const source = result.source;\r\n      let sourceResults = grouped.get(source);\r\n      if (sourceResults === undefined) {\r\n        sourceResults = [];\r\n        grouped.set(source, sourceResults);\r\n      }\r\n      sourceResults.push(result);\r\n    });\r\n\r\n    return Array.from(grouped.keys()).map((source: SearchSource) => {\r\n      if (this.pageIterator[source.getId()] === undefined) {\r\n        this.pageIterator[source.getId()] = 1;\r\n      }\r\n      return {source, results: grouped.get(source)};\r\n    });\r\n  }\r\n\r\n  isMoreResults(group: { source: SearchSource; results: SearchResult[] }) {\r\n    const stategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    const active = stategy?.active || false;\r\n    if (!active) {\r\n      return group.results && group.results[group.results.length - 1].meta.nextPage === true;\r\n    } else {\r\n      return group.results?.length % +group.source.params.limit === 0 && + group.source.params.page < 30;\r\n    }\r\n\r\n  }\r\n\r\n  displayMoreResults(group: {source: SearchSource; results: SearchResult[]}) {\r\n    const options: TextSearchOptions = {\r\n      sourceId: group.source.getId(),\r\n      page: ++this.pageIterator[group.source.getId()]\r\n    };\r\n\r\n    let terms;\r\n    if (this.termSplitter && this.term.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = this.term.split(this.termSplitter);\r\n    } else {\r\n      terms = [this.term];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      researches = researches.concat(this.searchService.search(term, options));\r\n    });\r\n\r\n    researches.map(research => {\r\n      research.request.subscribe((results: SearchResult[]) => {\r\n        const newResults = group.results.concat(results);\r\n        if (!results.length) {\r\n          newResults[newResults.length - 1].meta.nextPage = false;\r\n        }\r\n        this.moreResults.emit({research, results: newResults});\r\n      });\r\n    });\r\n    return;\r\n  }\r\n}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{'igo.geo.layer.saveFeatureInLayer' | translate}}</h1>\r\n\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <form class=\"igo-form\" [formGroup]=\"form\">\r\n    <igo-list [navigation]=\"false\" [selection]=\"false\">\r\n      <igo-search-results-item\r\n        igoListItem\r\n        color=\"accent\"\r\n        [result]=\"feature\"\r\n        showIcons=\"true\">\r\n      </igo-search-results-item>\r\n    </igo-list>\r\n    \r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\"\r\n          placeholder=\"{{'igo.geo.layer.chooseOrSet' | translate}}\"\r\n          matInput\r\n          [matAutocomplete]=\"auto\"\r\n          formControlName=\"layerName\">\r\n        <mat-autocomplete [displayWith]=\"displayFn\" #auto=\"matAutocomplete\">\r\n          <mat-option *ngFor=\"let layer of filteredLayers$ | async\" [value]=\"layer\">\r\n            <p mat-line>{{layer.title}}</p>\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n</div>\r\n\r\n<div mat-dialog-actions style=\"justify-content: center\">\r\n  <div class=\"igo-form-button-group create-layer-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"cancel()\">\r\n      {{'igo.geo.layer.cancelBtn' | translate}}\r\n    </button>\r\n    <button\r\n      id=\"createLayerBtnDialog\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      color=\"primary\"\r\n      (click)=\"save()\">\r\n      {{'igo.geo.layer.saveBtn' | translate}}\r\n    </button>\r\n  </div>\r\n</div>","import { LanguageService } from '@igo2/core';\r\nimport { Component, OnInit, Optional, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { UntypedFormBuilder, UntypedFormGroup, Validators } from '@angular/forms';\r\nimport { Layer } from '../../layer';\r\nimport { SearchResult } from '../shared';\r\nimport { Observable } from 'rxjs';\r\nimport { map, startWith } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-save-feature-dialog',\r\n  templateUrl: './save-feature-dialog.component.html',\r\n  styleUrls: ['./save-feature-dialog.component.scss']\r\n})\r\nexport class SaveFeatureDialogComponent implements OnInit {\r\n\r\n  public form: UntypedFormGroup;\r\n  feature: SearchResult;\r\n  layers: Layer[] = [];\r\n  filteredLayers$: Observable<Layer[]>;\r\n\r\n  constructor(\r\n    private formBuilder: UntypedFormBuilder,\r\n    public languageService: LanguageService,\r\n    public dialogRef: MatDialogRef<SaveFeatureDialogComponent>,\r\n    @Optional()\r\n    @Inject(MAT_DIALOG_DATA)\r\n    public data: { feature: SearchResult; layers: Layer[]}\r\n  ) {\r\n    this.form = this.formBuilder.group({\r\n      layerName: ['', [Validators.required]],\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.feature = this.data.feature;\r\n    this.layers = this.data.layers;\r\n    this.filteredLayers$ = this.form.controls['layerName'].valueChanges.pipe(\r\n      startWith(''),\r\n      map(val => this.filter(val))\r\n    );\r\n  }\r\n\r\n  private filter(val): Layer[] {\r\n    if(typeof val !== 'string'){\r\n      return;\r\n    }\r\n    return this.layers.map(l => l).filter(layer =>\r\n      layer?.title?.toLowerCase().includes(val.toLowerCase()));\r\n  }\r\n\r\n  displayFn(layer: Layer): string {\r\n    return layer && layer.title ? layer.title: '';\r\n  }\r\n\r\n  save() {\r\n    const data: {layer: string | Layer, feature: SearchResult} = {layer: this.form.value.layerName, feature: this.feature};\r\n    this.dialogRef.close(data);\r\n  }\r\n\r\n  cancel() {\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","<button\r\nigoStopPropagation\r\n(mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n*ngIf=\"layer.meta.dataType === 'Layer'\"\r\nmat-icon-button\r\ntooltip-position=\"below\"\r\nmatTooltipShowDelay=\"500\"\r\n[matTooltip]=\"computeTooltip() | translate\"\r\n[color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n(click)=\"onToggleClick($event)\">\r\n<mat-icon\r\n  matBadge=\"icon\"\r\n  [igoMatBadgeIcon]=\"getBadgeIcon()\"\r\n  igoMatBadgeColor=\"rgba(0,0,0,0.87)\"\r\n  igoMatBadgeBackgroundColor=\"none\"\r\n  igoMatBadgeInverseColor=\"true\"\r\n  [matBadgeHidden]=\"((inRange$ | async) && (isVisible$ | async) === true) || ((inRange$ | async) && !added) || ((inRange$ | async) && (isPreview$ | async))\"\r\n  [matBadgeDisabled]=\"(inRange$ | async) === false\"\r\n  matBadgeSize=\"small\"\r\n  matBadgePosition=\"after\"\r\n  [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n</mat-icon>\r\n</button>\r\n\r\n<button\r\n[id]=\"(!isMobile) ? 'hide-save-search-result-btn' : ''\"\r\nigoStopPropagation\r\n*ngIf=\"layer.meta.dataType === 'Feature' && saveSearchResultInLayer\"\r\nmat-icon-button\r\ntooltip-position=\"below\"\r\nmatTooltipShowDelay=\"500\"\r\n[matTooltip]=\"(addFeatureToLayerTooltip$ | async) | translate\"\r\n(click)=\"addFeatureToLayer()\">\r\n<mat-icon\r\n  matBadge=\"icon\"\r\n  igoMatBadgeIcon=\"eye-off\"\r\n  igoMatBadgeInverseColor=\"true\"\r\n  [matBadgeHidden]=\"(inRange$ | async)\"\r\n  matBadgeDisabled=\"true\"\r\n  matBadgeSize=\"small\"\r\n  matBadgePosition=\"after\"\r\n  svgIcon=\"file-plus-outline\">\r\n</mat-icon>\r\n</button>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy,\r\n} from '@angular/core';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayerOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { LAYER } from '../../layer/shared/layer.enums';\r\nimport { Subscription, BehaviorSubject, take } from 'rxjs';\r\nimport { SaveFeatureDialogComponent } from './save-feature-dialog.component';\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { DataSourceService, FeatureDataSource } from '../../datasource';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy,\r\n  tryBindStoreLayer\r\n} from '../../feature';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { getTooltipsOfOlGeometry } from '../../measure';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport Stroke from 'ol/style/Stroke';\r\nimport Fill from 'ol/style/Fill';\r\nimport Style from 'ol/style/Style';\r\nimport Circle from 'ol/style/Circle';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { QueryableDataSourceOptions } from '../../query';\r\nimport { Media, MediaService } from '@igo2/core';\r\n\r\n\r\n@Component({\r\n  selector: 'igo-search-add-button',\r\n  templateUrl: './search-results-add-button.component.html',\r\n  styleUrls: ['./search-results-add-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultAddButtonComponent implements OnInit, OnDestroy{\r\n  public tooltip$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.catalog.layer.addToMap'\r\n  );\r\n\r\n  public addFeatureToLayerTooltip$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.search.addToLayer'\r\n  );\r\n\r\n  private resolution$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  public isVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private layersSubcriptions = [];\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() layer: SearchResult;\r\n\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added: boolean;\r\n\r\n  /**\r\n   * The map to add the search result layer to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * show hide save search result in layer button\r\n   */\r\n  @Input() saveSearchResultInLayer: boolean = false;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  @Input() stores: FeatureStore<Feature>[] = [];\r\n\r\n  get allLayers() {\r\n    return this.map.layers.filter((layer) =>\r\n      String(layer.id).includes('igo-search-layer')\r\n    );\r\n  }\r\n  private mediaService$$: Subscription;\r\n  public isMobile: boolean = false;\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private dialog: MatDialog,\r\n    private dataSourceService: DataSourceService,\r\n    private mediaService: MediaService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    // check the view if is mobile or not\r\n    this.mediaService$$ = this.mediaService.media$.subscribe(\r\n      (media: Media) => {\r\n        if(media === Media.Mobile) {\r\n          this.isMobile = true;\r\n        }\r\n      }\r\n    );\r\n    if (this.layer.meta.dataType === 'Layer') {\r\n      this.added =\r\n        this.map.layers.findIndex(\r\n          lay => lay.id === this.layer.data.sourceOptions.id\r\n        ) !== -1;\r\n    }\r\n    this.layers$$ = this.map.layers$.subscribe(() => {\r\n      this.isVisible();\r\n    });\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(value => {\r\n      this.isInResolutionsRange(value);\r\n      this.isVisible();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n    if (this.mediaService$$) {\r\n      this.mediaService$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(currEvent: Event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    const event = currEvent ? currEvent : {} as Event;\r\n\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add(event);\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add(event);\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private add(event: Event) {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addLayerToMap(event);\r\n    }\r\n  }\r\n\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.removeLayerFromMap();\r\n      this.layersSubcriptions.map(s => s.unsubscribe());\r\n      this.layersSubcriptions = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private addLayerToMap(event?: Event) {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const layerOptions = (this.layer as SearchResult<LayerOptions>).data;\r\n    if (layerOptions.sourceOptions.optionsFromApi === undefined) {\r\n      layerOptions.sourceOptions.optionsFromApi = true;\r\n    }\r\n    this.layersSubcriptions.push(\r\n      this.layerService\r\n        .createAsyncLayer(layerOptions)\r\n        .subscribe(layer => {\r\n          if (event.type === 'click') {\r\n            this.map.layersAddedByClick$.next([layer]);\r\n          }\r\n          this.map.addLayer(layer);\r\n        })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private removeLayerFromMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const oLayer = this.map.getLayerById(this.layer.data.sourceOptions.id);\r\n    this.map.removeLayer(oLayer);\r\n  }\r\n\r\n  isInResolutionsRange(resolution: number) {\r\n    const minResolution = this.layer.data.minResolution || 0;\r\n    const maxResolution = this.layer.data.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      resolution >= minResolution && resolution <= maxResolution\r\n    );\r\n  }\r\n\r\n  isVisible() {\r\n    if (this.layer?.data?.sourceOptions?.id) {\r\n      const oLayer = this.map.getLayerById(this.layer.data.sourceOptions.id);\r\n      oLayer ? this.isVisible$.next(oLayer.visible) : this.isVisible$.next(false);\r\n    }\r\n  }\r\n\r\n  getBadgeIcon() {\r\n    if (this.inRange$.value) {\r\n      return this.isVisible$.value ? '' : 'eye-off';\r\n    } else {\r\n      return 'eye-off';\r\n    }\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      if (this.isPreview$.value) {\r\n        return 'igo.geo.catalog.layer.addToMap';\r\n      } else if (this.inRange$.value) {\r\n        return this.isVisible$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapNotVisible';\r\n      } else {\r\n        return 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n      }\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n\r\n  addFeatureToLayer() {\r\n    if (this.layer.meta.dataType !== 'Feature') {\r\n      return;\r\n    }\r\n\r\n    const selectedFeature = this.layer;\r\n    const dialogRef = this.dialog.open(SaveFeatureDialogComponent, {\r\n      width: '700px',\r\n      data: {\r\n        feature: selectedFeature,\r\n        layers: this.allLayers\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((data: {layer: string | any, feature: SearchResult}) => {\r\n      if (data) {\r\n        if(this.stores.length > 0) {\r\n          this.stores.map((store) => {\r\n            store.state.updateAll({selected: false});\r\n            (store?.layer).visible = false;\r\n            return store;\r\n          });\r\n        }\r\n        // check if is new layer\r\n        if (typeof data.layer === 'string') {\r\n          this.createLayer(data.layer, data.feature);\r\n        } else {\r\n          const activeStore = this.stores.find(store => store.layer.id === data.layer.id);\r\n          activeStore.layer.visible = true;\r\n          activeStore.layer.opacity = 1;\r\n          this.addFeature(data.feature, activeStore);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  createLayer(layerTitle: string, selectedFeature: SearchResult) {\r\n    const activeStore: FeatureStore<Feature> = new FeatureStore<Feature>([], {\r\n      map: this.map\r\n    });\r\n\r\n    const styles = [\r\n      new Style({\r\n        image: new Circle({\r\n          radius: 5,\r\n          stroke: new Stroke({\r\n            width: 1,\r\n            color: 'rgba(143,7,7,1)'\r\n          }),\r\n          fill: new Fill({\r\n            color: 'rgba(143,7,7,1)'\r\n          })\r\n        })\r\n      }),\r\n      new Style({\r\n        stroke: new Stroke({\r\n          width: 1,\r\n          color: 'rgba(143,7,7,1)'\r\n        }),\r\n        fill: new Fill({\r\n          color: 'rgba(0, 0, 255, 0.1)',\r\n        }),\r\n      })\r\n    ];\r\n\r\n    // set layer id\r\n    let layerCounterID: number = 0;\r\n    for (const layer of this.allLayers) {\r\n      let numberId = Number(layer.id.replace('igo-search-layer',''));\r\n      layerCounterID = Math.max(numberId,layerCounterID);\r\n    }\r\n\r\n    this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: FeatureDataSource) => {\r\n          let searchLayer: VectorLayer = new VectorLayer({\r\n            isIgoInternalLayer: true,\r\n            id: 'igo-search-layer' + ++layerCounterID,\r\n            title: layerTitle,\r\n            source: dataSource,\r\n            igoStyle: {\r\n              editable: false,\r\n              igoStyleObject: {\r\n                fill: { color: 'rgba(255,255,255,0.4)' },\r\n                stroke: { color: 'rgba(143,7,7,1)', width: 1 },\r\n                circle: {\r\n                  fill: { color: 'rgba(255,255,255,0.4)', },\r\n                  stroke: { color: 'rgba(143,7,7,1)', width: 1 },\r\n                  radius: 5,\r\n                }\r\n              }\r\n            },\r\n            style: styles,\r\n            showInLayerList: true,\r\n            exportable: true,\r\n            workspace: {\r\n              enabled: true\r\n            }\r\n          });\r\n\r\n          tryBindStoreLayer(activeStore, searchLayer);\r\n          tryAddLoadingStrategy(\r\n            activeStore,\r\n            new FeatureStoreLoadingStrategy({\r\n              motion: FeatureMotion.None\r\n            })\r\n          );\r\n\r\n          tryAddSelectionStrategy(\r\n            activeStore,\r\n            new FeatureStoreSelectionStrategy({\r\n              map: this.map,\r\n              motion: FeatureMotion.None,\r\n              many: true\r\n            })\r\n          );\r\n\r\n          activeStore.layer.visible = true;\r\n          activeStore.source.ol.on(\r\n            'removefeature',\r\n            (event: OlVectorSourceEvent<OlGeometry>) => {\r\n              const olGeometry = event.feature.getGeometry();\r\n              this.clearLabelsOfOlGeometry(olGeometry);\r\n            }\r\n          );\r\n\r\n          this.addFeature(selectedFeature, activeStore);\r\n          this.stores.push(activeStore);\r\n        });\r\n  }\r\n\r\n  addFeature(feature: SearchResult, activeStore: FeatureStore<Feature>) {\r\n    const newFeature = {\r\n      type: feature.data.type,\r\n      geometry: {\r\n        coordinates: feature.data.geometry.coordinates,\r\n        type: feature.data.geometry.type\r\n      },\r\n      projection: feature.data.projection,\r\n      properties: feature.data.properties,\r\n      meta: {\r\n        id: feature.meta.id\r\n      }\r\n    };\r\n    delete newFeature.properties.Route;\r\n    activeStore.update(newFeature);\r\n    activeStore.setLayerExtent();\r\n    activeStore.layer.ol.getSource().refresh();\r\n  }\r\n\r\n  private clearLabelsOfOlGeometry(olGeometry) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach(\r\n      (olTooltip: OlOverlay | undefined) => {\r\n        if (olTooltip && olTooltip.getMap()) {\r\n          this.map.ol.removeOverlay(olTooltip);\r\n        }\r\n      }\r\n    );\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\n\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoStopPropagationModule\r\n} from '@igo2/common';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { SearchResultsComponent } from './search-results.component';\r\nimport { SearchResultsItemComponent } from './search-results-item.component';\r\nimport { SearchResultAddButtonComponent } from './search-results-add-button.component';\r\nimport { SaveFeatureDialogComponent } from './save-feature-dialog.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatButtonModule,\r\n    MatTabsModule,\r\n    MatDialogModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoMetadataModule,\r\n    MatFormFieldModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatAutocompleteModule,\r\n  ],\r\n  exports: [\r\n    SearchResultsComponent,\r\n    SearchResultAddButtonComponent\r\n  ],\r\n  declarations: [\r\n    SearchResultsComponent,\r\n    SearchResultsItemComponent,\r\n    SearchResultAddButtonComponent,\r\n    SaveFeatureDialogComponent\r\n  ]\r\n})\r\nexport class IgoSearchResultsModule {}\r\n","import { FeatureGeometry } from './../../feature/shared/feature.interfaces';\r\nimport {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  AfterContentChecked\r\n} from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchService } from './search.service';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport { transform } from 'ol/proj';\r\nimport * as olgeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport { SearchResult, Research } from './search.interfaces';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion, FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { sourceCanReverseSearchAsSummary } from './search.utils';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { pointerPositionSummaryMarkerStyle } from '../../style/shared/feature/feature-style';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoSearchPointerSummary]'\r\n})\r\nexport class SearchPointerSummaryDirective implements OnInit, OnDestroy, AfterContentChecked {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private lonLat: [number, number];\r\n  private pointerSearchStore: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n  private reverseSearch$$: Subscription[] = [];\r\n  private hasPointerReverseSearchSource: boolean = false;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private searchPointerSummaryFeatureId: string = 'searchPointerSummaryFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoSearchPointerSummaryDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], {map: this.map});\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      if (this.store && !layers.find(l => l.id === 'searchPointerSummaryId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id : 'searchPointerSummaryId',\r\n      title: 'searchPointerSummary',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: pointerPositionSummaryMarkerStyle\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n  }\r\n\r\n  ngAfterContentChecked(): void {\r\n      if (!this.searchSourceService.getEnabledSources().filter(sourceCanReverseSearchAsSummary).length) {\r\n        this.hasPointerReverseSearchSource = false;\r\n      } else {\r\n        this.hasPointerReverseSearchSource = true;\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unsubscribeReverseSearch();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerSearchStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Build an object based on the closest feature by type (base on type and distance properties )\r\n   * @param results SearchResult[]\r\n   * @returns OL style function\r\n   */\r\n  private computeSummaryClosestFeature(results: SearchResult[]): {} {\r\n    const closestResultByType = {};\r\n\r\n    results.map(result => {\r\n      if (result.data.properties.type && result.data.properties.distance >= 0) {\r\n        if (closestResultByType.hasOwnProperty(result.data.properties.type)) {\r\n          const prevDistance = closestResultByType[result.data.properties.type].distance;\r\n          if (result.data.properties.distance < prevDistance) {\r\n            const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n            closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n          }\r\n        } else {\r\n          const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n          closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n        }\r\n      }\r\n    });\r\n\r\n    return closestResultByType;\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: SearchResult[]) {\r\n    const closestResultByType = this.computeSummaryClosestFeature(resultsUnderPointerPosition);\r\n    const summarizedClosestType = Object.keys(closestResultByType);\r\n    const processedSummarizedClosestType = [];\r\n    const summary = [];\r\n    resultsUnderPointerPosition.map(result => {\r\n      const typeIndex = summarizedClosestType.indexOf(result.data.properties.type);\r\n      if (typeIndex !== -1) {\r\n        summary.push(closestResultByType[result.data.properties.type].title);\r\n        summarizedClosestType.splice(typeIndex, 1);\r\n        processedSummarizedClosestType.push(result.data.properties.type);\r\n      } else {\r\n        if (processedSummarizedClosestType.indexOf(result.data.properties.type) === -1) {\r\n          summary.push(result.meta.pointerSummaryTitle || result.meta.title);\r\n        }\r\n      }\r\n    });\r\n    if (summary.length) {\r\n      this.addPointerOverlay(summary.join('\\n'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n  /**\r\n   * Unsubscribe to reverse seatch store.\r\n   * @internal\r\n   */\r\n  unsubscribeReverseSearch() {\r\n    this.reverseSearch$$.map(s => s.unsubscribe());\r\n    this.reverseSearch$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger reverse search when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoSearchPointerSummaryEnabled ||\r\n      !this.hasPointerReverseSearchSource || this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n      this.clearLayer();\r\n      this.unsubscribeReverseSearch();\r\n    }\r\n\r\n    this.lonLat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.onSearchCoordinate();\r\n    }, this.igoSearchPointerSummaryDelay);\r\n  }\r\n\r\n    /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n     private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n      return r1.source.displayOrder - r2.source.displayOrder;\r\n    }\r\n\r\n  private onSearchCoordinate() {\r\n    this.pointerSearchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonLat, { params: { geometry: 'false', icon: 'false' } }, true);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        this.reverseSearch$$.push(\r\n          results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n            this.onSearch({ research: results[i], results: _results });\r\n          }));\r\n      }\r\n    }\r\n  }\r\n\r\n  private onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    const newResults = this.pointerSearchStore.all()\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.pointerSearchStore.load(newResults.sort(this.sortByOrder));\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addPointerOverlay(text: string) {\r\n    this.clearLayer();\r\n\r\n    const geometry = new olgeom.Point(\r\n      transform(this.lonLat, 'EPSG:4326', this.mapProjection)\r\n    );\r\n    const feature = new olFeature({ geometry });\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.mapProjection,\r\n      dataProjection: this.mapProjection\r\n    }) as FeatureGeometry;\r\n\r\n    const f: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.mapProjection,\r\n      properties: {\r\n        id: this.searchPointerSummaryFeatureId,\r\n        pointerSummary: text\r\n      },\r\n      meta: {\r\n        id: this.searchPointerSummaryFeatureId\r\n      },\r\n      ol: feature\r\n    };\r\n    this.store.setLayerFeatures([f], FeatureMotion.None);\r\n  }\r\n\r\n/**\r\n * Clear the pointer store features\r\n */\r\nprivate clearLayer() {\r\n  if (this.store) {\r\n    this.store.clearLayer();\r\n  }\r\n}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { SearchService } from './shared/search.service';\r\nimport { provideSearchSourceService } from './shared/search-source-service.providers';\r\nimport { provideDefaultIChercheSearchResultFormatter } from './shared/sources/icherche.providers';\r\nimport { provideDefaultCoordinatesSearchResultFormatter } from './shared/sources/coordinates.providers';\r\nimport { provideILayerSearchResultFormatter } from './shared/sources/ilayer.providers';\r\n\r\nimport { IgoSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoSearchSelectorModule } from './search-selector/search-selector.module';\r\nimport { IgoSearchResultsModule } from './search-results/search-results.module';\r\nimport { IgoSearchSettingsModule } from './search-settings/search-settings.module';\r\nimport { SearchPointerSummaryDirective } from './shared/search-pointer-summary.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule,\r\n    SearchPointerSummaryDirective\r\n  ],\r\n  declarations: [SearchPointerSummaryDirective]\r\n})\r\nexport class IgoSearchModule {\r\n  static forRoot(): ModuleWithProviders<IgoSearchModule> {\r\n    return {\r\n      ngModule: IgoSearchModule,\r\n      providers: [\r\n        SearchService,\r\n        provideSearchSourceService(),\r\n        provideDefaultIChercheSearchResultFormatter(),\r\n        provideDefaultCoordinatesSearchResultFormatter(),\r\n        provideILayerSearchResultFormatter()\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { OnUpdateInputs, WidgetComponent } from '@igo2/common';\r\n\r\nimport { Layer } from '../../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Event emitted on complete\r\n   */\r\n  @Output() complete = new EventEmitter<void>();\r\n\r\n  /**\r\n   * Event emitted on cancel\r\n   */\r\n  @Output() cancel = new EventEmitter<void>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Implemented as part of OnUpdateInputs\r\n   */\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * On close, emit the cancel event\r\n   */\r\n  onClose() {\r\n    this.cancel.emit();\r\n  }\r\n\r\n}\r\n","<igo-ogc-filterable-item\r\n  igoListItem\r\n  [layer]=\"layer\"\r\n  [header]=\"false\" \r\n  [map]=\"map\" >\r\n</igo-ogc-filterable-item>","import { InjectionToken } from '@angular/core';\r\n\r\nimport { Widget, WidgetService } from '@igo2/common';\r\n\r\nimport { OgcFilterComponent } from './ogc-filter/ogc-filter.component';\r\n\r\nexport const OgcFilterWidget = new InjectionToken<Widget>('OgcFilterWidget');\r\n\r\nexport function ogcFilterWidgetFactory(widgetService: WidgetService): Widget {\r\n  return widgetService.create(OgcFilterComponent);\r\n}\r\n\r\nexport function provideOgcFilterWidget() {\r\n  return {\r\n    provide: OgcFilterWidget,\r\n    useFactory: ogcFilterWidgetFactory,\r\n    deps: [WidgetService]\r\n  };\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFilterModule } from '../../../filter/filter.module';\r\nimport { OgcFilterComponent } from './ogc-filter.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [OgcFilterComponent],\r\n  declarations: [OgcFilterComponent]\r\n})\r\nexport class IgoOgcFilterModule {}\r\n","import type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olStyle from 'ol/style';\r\nimport olFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\n\r\nimport { Feature } from '../../../feature/shared/feature.interfaces';\r\nimport { FeatureCommonVectorStyleOptions } from './vector-style.interface';\r\n\r\nimport { createOverlayDefaultStyle } from '../overlay/overlay-style.utils';\r\nimport { createOverlayMarkerStyle } from '../overlay/overlay-marker-style.utils';\r\n\r\n\r\n/**\r\n * Generate a style for selected features\r\n * @param feature The feature to generate the style\r\n * @returns A olStyle\r\n */\r\nexport function getCommonVectorSelectedStyle(\r\n  {\r\n    feature,\r\n    markerColor = [0, 161, 222],\r\n    markerOpacity = 1,\r\n    markerOutlineColor = [0, 255, 255],\r\n    fillColor,\r\n    fillOpacity = 0.15,\r\n    strokeColor = [0, 255, 255],\r\n    strokeOpacity = 0.5,\r\n    strokeWidth = 4\r\n  }: FeatureCommonVectorStyleOptions): olStyle.Style {\r\n\r\n  return getCommonVectorStyle({\r\n    feature,\r\n    markerColor,\r\n    markerOpacity,\r\n    markerOutlineColor,\r\n    fillColor,\r\n    fillOpacity,\r\n    strokeColor,\r\n    strokeOpacity,\r\n    strokeWidth\r\n  });\r\n}\r\n\r\n/**\r\n * Generate a basic style for features\r\n * @param feature The feature to generate the style\r\n * @returns A olStyle\r\n */\r\nexport function getCommonVectorStyle(\r\n  {\r\n    feature,\r\n    markerColor = [0, 161, 222],\r\n    markerOpacity = 0.5,\r\n    markerOutlineColor,\r\n    fillColor = [0, 161, 222],\r\n    fillOpacity = 0.15,\r\n    strokeColor = [0, 161, 222],\r\n    strokeOpacity = 0.5,\r\n    strokeWidth = 2\r\n  }: FeatureCommonVectorStyleOptions): olStyle.Style {\r\n\r\n  const isOlFeature = feature instanceof olFeature;\r\n  let geometry;\r\n  let text;\r\n  if (isOlFeature) {\r\n    feature = feature as olFeature<OlGeometry>;\r\n    geometry = feature.getGeometry();\r\n  } else {\r\n    feature = feature as Feature;\r\n    geometry = feature.geometry;\r\n    text = feature.meta.mapTitle;\r\n  }\r\n  const geometryType = isOlFeature ? geometry.getType() : geometry.type;\r\n\r\n  if (!geometry || geometryType === 'Point') {\r\n    const markerColorAsArray = ColorAsArray(markerColor).slice(0);\r\n    const markerColorRGB = markerColorAsArray.slice(0, 3);\r\n\r\n    if (markerColorAsArray.length === 4 &&\r\n        (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n      markerOpacity = markerColorAsArray[3];\r\n    }\r\n\r\n    return createOverlayMarkerStyle({\r\n      text,\r\n      opacity: markerOpacity,\r\n      markerOutlineColor,\r\n      markerColor: markerColorRGB\r\n    });\r\n  } else {\r\n    const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n    const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n    if (!(fillWithOpacity.length === 4 &&\r\n        (typeof fillColor !== 'string' || /^#[0-9A-F]{8}$/i.test(fillColor as string)))) {\r\n      fillWithOpacity[3] = fillOpacity;\r\n    }\r\n\r\n    if (!(strokeWithOpacity.length === 4 &&\r\n        (typeof strokeColor !== 'string' || /^#[0-9A-F]{8}$/i.test(strokeColor as string)))) {\r\n      strokeWithOpacity[3] = strokeOpacity;\r\n    }\r\n\r\n    return createOverlayDefaultStyle({\r\n      text,\r\n      strokeWidth,\r\n      strokeColor: strokeWithOpacity,\r\n      fillColor: fillWithOpacity\r\n    });\r\n  }\r\n}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface WfsWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class WfsWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: WfsWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\nimport { getCommonVectorSelectedStyle } from '../../style/shared/vector/commonVectorStyle';\r\n\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService, private configService: ConfigService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): WfsWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n    const wks = new WfsWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate } from '@igo2/common';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy } from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { StyleService } from '../../style/style-service/style.service';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { getCommonVectorSelectedStyle } from '../../style/shared/vector/commonVectorStyle';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WmsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private styleService: StyleService,\r\n    private configService: ConfigService) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): WfsWorkspace {\r\n    if (\r\n      !layer.options.workspace ||\r\n      map.layers.find(lay => lay.id === layer.id + '.WfsWorkspaceTableDest') ||\r\n      layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n\r\n    let wks;\r\n    let wksLayerOption = {\r\n      srcId: layer.id,\r\n      workspaceId: undefined,\r\n      enabled: false,\r\n      queryOptions: {\r\n        mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n        tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n      },\r\n      pageSize: layer.options.workspace?.pageSize,\r\n      pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n    };\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        isIgoInternalLayer: true,\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: wksLayerOption,\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        style: this.styleService.createStyle(\r\n          {\r\n            fill: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            stroke: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            circle: {\r\n              fill: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              stroke: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              radius: 5\r\n            }\r\n          }),\r\n        sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          queryFormatAsWms: layer.options.workspace?.enabled ? (dataSource.options as QueryableDataSourceOptions).queryFormatAsWms : true,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        if (!layer.options.workspace?.enabled) {\r\n          return;\r\n        }\r\n        wks = new WfsWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        });\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            enabled: true,\r\n            srcId: layer.id,\r\n            workspaceId: workspaceLayer.id,\r\n            queryOptions: {\r\n              mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n              tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n            },\r\n            pageSize: layer.options.workspace?.pageSize,\r\n            pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { LanguageService } from '@igo2/core';\r\nimport { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  type: string;\r\n  cancel: boolean;\r\n}\r\n\r\n@Component({\r\n    selector: 'igo-confirmation-popup-component',\r\n    templateUrl: './confirmation-popup.component.html',\r\n    styleUrls: ['./confirmation-popup.component.scss']\r\n  })\r\n  export class ConfirmationPopupComponent {\r\n\r\n    constructor(\r\n      public dialogRef: MatDialogRef<ConfirmationPopupComponent>,\r\n      public languageService: LanguageService,\r\n      @Inject(MAT_DIALOG_DATA) public data: {type: string, cancel: boolean}) {}\r\n\r\n    cancelAction() {\r\n      this.data.cancel = true;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n\r\n    confirmedAction() {\r\n      this.data.cancel = false;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n  }\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">{{data.type === 'add' ?\r\n    languageService.translate.instant('igo.geo.workspace.addConfirmation') :\r\n    languageService.translate.instant('igo.geo.workspace.deleteConfirmation')}}</p>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    (click)=\"confirmedAction()\">Ok\r\n  </button>\r\n  <button\r\n    mat-raised-button\r\n    (click)=\"cancelAction()\">{{languageService.translate.instant('igo.geo.workspace.cancel')}}\r\n  </button>\r\n</div>","import { MatDialog } from '@angular/material/dialog';\r\nimport {\r\n  Workspace,\r\n  WorkspaceOptions,\r\n  EntityRecord\r\n} from '@igo2/common';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { EditionWorkspaceService } from './edition-workspace.service';\r\nimport { ConfirmationPopupComponent } from '../confirmation-popup/confirmation-popup.component';\r\nimport { DrawControl } from '../../geometry';\r\nimport { createInteractionStyle, GeometryType } from '../../draw';\r\nimport { featureToOl } from '../../feature';\r\n\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport * as OlStyle from 'ol/style';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport Collection from 'ol/Collection';\r\nimport OlFeature from 'ol/Feature';\r\nimport { FeatureDataSource } from '../../datasource/shared';\r\n\r\nexport interface EditionWorkspaceOptions extends WorkspaceOptions {\r\n  layer: ImageLayer | VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class EditionWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): ImageLayer | VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  private drawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private olDrawingLayerSource = new OlVectorSource();\r\n  private olDrawingLayer: VectorLayer;\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n  public modify; // Reference to the ol interaction\r\n\r\n  public modifyStyle = new OlStyle.Style({\r\n    stroke: new OlStyle.Stroke({\r\n      color: 'rgba(255,255,255,1)',\r\n      width: 1\r\n    }),\r\n    fill: new OlStyle.Fill({\r\n      color: 'rgba(0,161,222,1)'\r\n    }),\r\n    image: new OlStyle.Circle({\r\n      radius: 7,\r\n      stroke: new OlStyle.Stroke({\r\n        color: 'rgba(255,255,255,1)',\r\n        width: 1\r\n      }),\r\n      fill: new OlStyle.Fill({\r\n        color: 'rgba(0,161,222,1)'\r\n      })\r\n    })\r\n  });\r\n\r\n  private newFeaturefilterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.newFeature === true;\r\n  };\r\n\r\n  private editFeaturefilterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.edit === true;\r\n  };\r\n\r\n  public fillColor: string;\r\n  public strokeColor: string;\r\n  public strokeWidth: number;\r\n\r\n  constructor(\r\n    protected options: EditionWorkspaceOptions,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private dialog: MatDialog,\r\n    private configService: ConfigService) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n\r\n    this.drawControl = this.createDrawControl();\r\n    this.drawControl.setGeometryType(this.geometryType.Point as any);\r\n\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n\r\n    this.olDrawingLayer = new VectorLayer({\r\n      id: 'igo-draw-layer',\r\n      title: 'edition',\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      },\r\n    });\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n\r\n  deleteFeature(feature, workspace) {\r\n    setTimeout(() => {\r\n      const dialogRef = this.dialog.open(ConfirmationPopupComponent, {\r\n        disableClose: false,\r\n        data: {type: 'delete'}\r\n    });\r\n\r\n      dialogRef.afterClosed().subscribe(result => {\r\n        if (result === false) {\r\n          let id, url;\r\n          const baseUrl = workspace.layer.dataSource.options.edition.baseUrl;\r\n          const deleteUrl = workspace.layer.dataSource.options.edition.deleteUrl;\r\n          if (baseUrl.length) {\r\n            url = this.configService.getConfig('edition.url') ?\r\n              this.configService.getConfig('edition.url') + baseUrl + '?' + deleteUrl :\r\n              baseUrl + '?' + deleteUrl;\r\n          } else {\r\n            url = this.configService.getConfig('edition.url') ?\r\n              this.configService.getConfig('edition.url') + deleteUrl : deleteUrl;\r\n          }\r\n\r\n          for (const column of workspace.meta.tableTemplate.columns) {\r\n            for (const property in feature.properties) {\r\n              let columnName = column.name;\r\n              if (columnName.includes('properties.')) {\r\n                columnName = columnName.split('.')[1];\r\n              }\r\n              if (columnName === property && column.primary === true) {\r\n                id = feature.properties[property];\r\n              }\r\n            }\r\n          }\r\n          if (url) {\r\n            url += id;\r\n            this.editionWorkspaceService.deleteFeature(workspace, url);\r\n          }\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  editFeature(feature, workspace: EditionWorkspace) {\r\n    feature.edition = true;\r\n    let id;\r\n    let find = false;\r\n    const editionOpt = workspace.layer.dataSource.options.edition;\r\n    for (const column of workspace.meta.tableTemplate.columns ) {\r\n\r\n      // Update domain list\r\n      if (column.type === 'list' || column.type === 'autocomplete') {\r\n        this.editionWorkspaceService.getDomainValues(column.relation).subscribe(result => {\r\n          column.domainValues = result;\r\n        });\r\n      }\r\n      if (find === false) {\r\n        for (const property in feature.properties) {\r\n          let columnName = column.name;\r\n          if (columnName.includes('properties.')) {\r\n            columnName = columnName.split('.')[1];\r\n          }\r\n          if (columnName === property && column.primary === true) {\r\n            id = feature.properties[property];\r\n            find = true;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (id) {\r\n      feature.original_properties = JSON.parse(JSON.stringify(feature.properties));\r\n      feature.original_geometry = feature.geometry;\r\n      feature.idkey = id;\r\n      workspace.entityStore.state.updateAll({ edit: false });\r\n      workspace.entityStore.stateView.filter(this.editFeaturefilterClauseFunc);\r\n      this.addFeatureToStore(feature, workspace);\r\n    } else {\r\n      // Only for edition with it's own geometry\r\n      if (!feature.newFeature && editionOpt.geomType) {\r\n        feature.newFeature = true;\r\n        this.editionWorkspaceService.adding$.next(true);\r\n        workspace.entityStore.state.updateAll({ newFeature: false });\r\n        workspace.entityStore.stateView.filter(this.newFeaturefilterClauseFunc);\r\n        if (editionOpt.addWithDraw) {\r\n          const geometryType = editionOpt.geomType;\r\n          this.onGeometryTypeChange(geometryType, feature, workspace);\r\n        } else {\r\n          workspace.entityStore.insert(feature);\r\n          workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(fillColor?: string, strokeColor?: string, strokeWidth?: number) {\r\n    const drawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.olDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(fillColor, strokeColor, strokeWidth),\r\n    });\r\n\r\n    return drawControl;\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: Type, feature, workspace: EditionWorkspace) {\r\n      this.drawControl.setGeometryType(geometryType);\r\n      this.toggleDrawControl(feature, workspace);\r\n    }\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl(feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  public deactivateDrawControl() {\r\n    if (!this.drawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.drawControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.drawEnd$$ = this.drawControl.end$.subscribe((olGeometry: OlGeometry) => {\r\n      this.addFeatureToStore(feature, workspace, olGeometry);\r\n    });\r\n\r\n    this.drawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to layer. The loading strategy of the layer\r\n   * will trigger and add the feature to the workspace store.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(feature, workspace: EditionWorkspace, olGeometry?: OlGeometry) {\r\n    const projection = this.map.ol.getView().getProjection();\r\n    let geometry = feature.geometry;\r\n\r\n    // If an olGeometry is passed, it means that it is a new feature\r\n    if (olGeometry) {\r\n      workspace.entityStore.insert(feature);\r\n      workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n      geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n        featureProjection: projection,\r\n        dataProjection: 'EPSG:4326'\r\n      }) as any;\r\n\r\n      feature.geometry = geometry;\r\n    } else {\r\n      workspace.entityStore.state.update(feature, { edit: true }, true);\r\n    }\r\n\r\n    feature.projection = 'EPSG:4326';\r\n\r\n    const featureOl = featureToOl(feature, projection.getCode());\r\n\r\n    this.olDrawingLayer.dataSource.ol.clear();\r\n    this.olDrawingLayer.dataSource.ol.addFeature(featureOl);\r\n    this.map.addLayer(this.olDrawingLayer);\r\n\r\n    this.deactivateDrawControl();\r\n    this.createModifyInteraction(featureOl, feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Delete drawings layer and source from the map AND feature from the entity store.\r\n   * Layer refresh will automatically add the new feature into the store.\r\n   */\r\n  deleteDrawings() {\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n    this.olDrawingLayerSource.clear();\r\n    this.map.ol.removeInteraction(this.modify);\r\n  }\r\n\r\n  /**\r\n   * Create a modify interaction to allow a geometry change one feature at the time (drag and drop)\r\n   */\r\n  createModifyInteraction(olFeature: OlFeature<OlGeometry>, feature, workspace: EditionWorkspace) {\r\n    this.map.ol.removeInteraction(this.modify);\r\n    const olCollection = new Collection([olFeature], { unique: true });\r\n    this.modify = new OlModify({\r\n      features: olCollection\r\n    });\r\n\r\n    this.map.ol.addInteraction(this.modify);\r\n    olCollection.forEach(feature => {\r\n      feature.setStyle(this.modifyStyle);\r\n    });\r\n\r\n    this.modify.on('modifyend', (event) => {\r\n      const olGeometry = event.features.getArray()[0]?.getGeometry();\r\n      if (olGeometry) {\r\n        this.addFeatureToStore(feature, workspace, olGeometry);\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse, HttpHeaders } from '@angular/common/http';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate,\r\n  EntityTableButton} from '@igo2/common';\r\nimport { ConfigService, MessageService, StorageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { catchError, map, skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy} from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { StyleService } from '../../style/style-service/style.service';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { EditionWorkspace } from './edition-workspace';\r\n\r\nimport WKT from 'ol/format/WKT';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\nimport olFeature from 'ol/Feature';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { BehaviorSubject, Observable, throwError } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionWorkspaceService {\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n  public adding$ = new BehaviorSubject<boolean>(false);\r\n  public relationLayers$ = new BehaviorSubject<ImageLayer[] | VectorLayer[]>(undefined);\r\n  public rowsInMapExtentCheckCondition$ = new BehaviorSubject<boolean>(true);\r\n  public loading = false;\r\n  public wktFormat = new WKT();\r\n  public geoJsonFormat = new GeoJSON();\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService,\r\n    private messageService: MessageService,\r\n    private http: HttpClient,\r\n    private dialog: MatDialog,\r\n    private styleService: StyleService,\r\n    public authInterceptor?: AuthInterceptor) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): EditionWorkspace {\r\n    if (layer.options.workspace?.enabled !== true || layer.dataSource.options.edition.enabled !== true) {\r\n      return;\r\n    }\r\n    let wksConfig;\r\n    if (layer.options.workspace) {\r\n      wksConfig = layer.options.workspace;\r\n    } else {\r\n      wksConfig = {};\r\n    }\r\n    wksConfig.srcId = layer.id;\r\n    wksConfig.workspaceId = layer.id;\r\n    wksConfig.enabled = true;\r\n    wksConfig.pageSize = layer.options.workspace?.pageSize;\r\n    wksConfig.pageSizeOptions = layer.options.workspace?.pageSizeOptions;\r\n\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n    let wks;\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: {\r\n          srcId: layer.id,\r\n          workspaceId: undefined,\r\n          enabled: false,\r\n          queryOptions: {\r\n            mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n            tabQuery: false\r\n          },\r\n          pageSize: layer.options.workspace?.pageSize,\r\n          pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n        },\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        style: this.styleService.createStyle(\r\n          {\r\n            fill: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            stroke: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            circle: {\r\n              fill: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              stroke: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              radius: 5\r\n            }\r\n          }),\r\n          sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined,\r\n          edition: dataSource.options.edition\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        wks = new EditionWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        }, this, this.dialog, this.configService);\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            wksConfig\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: EditionWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    let rendererType = EntityTableColumnRenderer.UnsanitizedHTML;\r\n    let buttons = [];\r\n    let columns = [];\r\n    let relationsColumn = [];\r\n\r\n    buttons = [{\r\n      name: 'edition',\r\n      title: undefined,\r\n      renderer: EntityTableColumnRenderer.ButtonGroup,\r\n      primary: false,\r\n      valueAccessor: () => {\r\n        return [{\r\n          editMode: false,\r\n          icon: 'pencil',\r\n          color: 'primary',\r\n          disabled: layer.dataSource.options.edition.modifyButton === false ? true : false,\r\n          click: (feature) => { workspace.editFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: false,\r\n          icon: 'delete',\r\n          color: 'warn',\r\n          disabled: layer.dataSource.options.edition.deleteButton === false ? true : false,\r\n          click: (feature) => { workspace.deleteFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'check',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.saveFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'alpha-x',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.cancelEdit(workspace, feature); }\r\n        }] as EntityTableButton[];\r\n      }\r\n    }];\r\n\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: rendererType,\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: false,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n\r\n    columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n\r\n      let column = {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: rendererType,\r\n        valueAccessor: undefined,\r\n        cellClassFunc: () => {\r\n          const cellClass = {};\r\n          if (field.type) {\r\n            cellClass[`class_${field.type}`] = true;\r\n            return cellClass;\r\n          }\r\n        },\r\n        primary: field.primary === true ? true : false,\r\n        visible: field.visible,\r\n        validation: field.validation,\r\n        linkColumnForce: field.linkColumnForce,\r\n        type: field.type,\r\n        domainValues: undefined,\r\n        relation: undefined,\r\n        multiple: field.multiple,\r\n        step: field.step,\r\n        tooltip: field.tooltip\r\n      };\r\n\r\n      if (field.type === 'list' || field.type === 'autocomplete') {\r\n        this.getDomainValues(field.relation).subscribe(result => {\r\n          column.domainValues = result;\r\n          column.relation = field.relation;\r\n        });\r\n      }\r\n      return column;\r\n    });\r\n\r\n    relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n          if (this.adding$.getValue() === false) {\r\n            this.ws$.next(relation.title);\r\n          }\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    columns.push(...buttons);\r\n\r\n    workspace.meta.tableTemplate = {\r\n      selection: false,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  public saveFeature(feature, workspace: EditionWorkspace) {\r\n    if (!this.validateFeature(feature, workspace)){\r\n      return false;\r\n    }\r\n\r\n    this.sanitizeParameter(feature, workspace);\r\n\r\n    const baseUrl = workspace.layer.dataSource.options.edition.baseUrl;\r\n    let url = this.configService.getConfig('edition.url');\r\n\r\n    if (!url) {\r\n      url = baseUrl;\r\n    } else {\r\n      url += baseUrl ? baseUrl : '';\r\n    }\r\n\r\n    if (feature.newFeature) {\r\n      url += workspace.layer.dataSource.options.edition.addUrl;\r\n\r\n      const addHeaders = workspace.layer.dataSource.options.edition.addHeaders;\r\n      const headers = new HttpHeaders(addHeaders);\r\n\r\n      this.addFeature(feature, workspace, url, headers);\r\n    } else {\r\n      if (workspace.layer.dataSource.options.edition.modifyProtocol !== \"post\") {\r\n        url += '?' + workspace.layer.dataSource.options.edition.modifyUrl + feature.idkey;\r\n      }\r\n      else {\r\n        url += workspace.layer.dataSource.options.edition.modifyUrl;\r\n      }\r\n\r\n      const protocole = workspace.layer.dataSource.options.edition.modifyProtocol;\r\n      const modifyHeaders = workspace.layer.dataSource.options.edition.modifyHeaders;\r\n      const headers = new HttpHeaders(modifyHeaders);\r\n\r\n      this.modifyFeature(feature, workspace, url, headers, protocole);\r\n    }\r\n  }\r\n\r\n  public addFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}) {\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      const projDest = workspace.layer.options.sourceOptions.edition.geomDatabaseProj;\r\n      feature.properties[workspace.layer.dataSource.options.params.fieldNameGeometry] =\r\n      'SRID=' + projDest.replace(\"EPSG:\", \"\") + ';' + this.wktFormat.writeGeometry(\r\n        this.geoJsonFormat.readFeature(feature.geometry).getGeometry().transform('EPSG:4326', projDest),\r\n        { dataProjection: projDest });\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || (sf.name === property && sf.validation?.send === false)) {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http.post(`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        workspace.entityStore.stateView.clear();\r\n        workspace.deleteDrawings();\r\n        workspace.entityStore.delete(feature);\r\n\r\n        this.messageService.success('igo.geo.workspace.addSuccess');\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        this.adding$.next(false);\r\n        this.rowsInMapExtentCheckCondition$.next(true);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error('igo.geo.workspace.addError');\r\n          }\r\n        } else {\r\n          this.messageService.error('igo.geo.workspace.addError');\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  public deleteFeature(workspace: EditionWorkspace, url: string) {\r\n    this.loading = true;\r\n    this.http.delete(`${url}`, {}).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        this.messageService.success('igo.geo.workspace.deleteSuccess');\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n          const messages = workspace.layer.dataSource.options.edition.messages;\r\n          if (messages) {\r\n            let text;\r\n            messages.forEach(message => {\r\n              const key = Object.keys(message)[0];\r\n              if (error.error.message.includes(key)) {\r\n                text = message[key];\r\n                this.messageService.error(text);\r\n              }\r\n            });\r\n            if (!text) {\r\n              this.messageService.error('igo.geo.workspace.addError');\r\n            }\r\n          } else {\r\n            this.messageService.error('igo.geo.workspace.addError');\r\n          }\r\n      }\r\n    );\r\n  }\r\n\r\n  public modifyFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}, protocole = 'patch' ) {\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      const projDest = workspace.layer.options.sourceOptions.edition.geomDatabaseProj;\r\n      // Remove 3e dimension\r\n      feature.geometry.coordinates = removeZ(feature.geometry.coordinates);\r\n      feature.properties[workspace.layer.dataSource.options.params.fieldNameGeometry] =\r\n        'SRID=' + projDest.replace(\"EPSG:\", \"\") + ';' + this.wktFormat.writeGeometry(\r\n          this.geoJsonFormat.readFeature(feature.geometry).getGeometry().transform('EPSG:4326', projDest),\r\n          { dataProjection: projDest });\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || (sf.name === property && sf.validation?.send === false)\r\n          || property === 'boundedBy') {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http[protocole](`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        this.cancelEdit(workspace, feature, true);\r\n\r\n        this.messageService.success('igo.geo.workspace.modifySuccess');\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n\r\n        let relationLayers = [];\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              relationLayers.push(layer);\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n        this.relationLayers$.next(relationLayers);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error('igo.geo.workspace.addError');\r\n          }\r\n        } else {\r\n          this.messageService.error('igo.geo.workspace.addError');\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  cancelEdit(workspace: EditionWorkspace, feature, fromSave = false) {\r\n    feature.edition = false;\r\n    this.adding$.next(false);\r\n    workspace.deleteDrawings();\r\n    workspace.entityStore.stateView.clear();\r\n\r\n    if (feature.newFeature) {\r\n      workspace.entityStore.delete(feature);\r\n      workspace.deactivateDrawControl();\r\n\r\n      this.rowsInMapExtentCheckCondition$.next(true);\r\n    } else {\r\n      if (!fromSave) {\r\n        feature.properties = feature.original_properties;\r\n        feature.geometry = feature.original_geometry;\r\n      }\r\n      delete feature.original_properties;\r\n      delete feature.original_geometry;\r\n    }\r\n  }\r\n\r\n  getDomainValues(relation: RelationOptions): Observable<any> {\r\n    let url = relation.url;\r\n    if (!url) {\r\n      url = this.configService.getConfig('edition.url') ?\r\n        this.configService.getConfig('edition.url') + relation.table : relation.table;\r\n    }\r\n\r\n    return this.http.get<any>(url).pipe(\r\n      map(result => {\r\n        return result;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        err.error.caught = true;\r\n        return throwError(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Refresh both wms and wfs layer\r\n   * A new wfs loader is used to ensure cache is not retrieving old data\r\n   * WMS params are updated to ensure layer is correctly refreshed\r\n   */\r\n  refreshMap(layer: VectorLayer, map: IgoMap) {\r\n    const wfsOlLayer = layer.dataSource.ol;\r\n    const loader = (extent, resolution, proj, success, failure) => {\r\n      layer.customWFSLoader(\r\n        layer.ol.getSource(),\r\n        layer.options.sourceOptions,\r\n        this.authInterceptor,\r\n        extent,\r\n        resolution,\r\n        proj,\r\n        success,\r\n        failure,\r\n        true\r\n      );\r\n    };\r\n    wfsOlLayer.setLoader(loader);\r\n    wfsOlLayer.refresh();\r\n\r\n    for (const lay of map.layers) {\r\n      if (\r\n        lay.id !== layer.id &&\r\n        lay.options.linkedLayers?.linkId.includes(layer.id.substr(0, layer.id.indexOf('.') - 1)) &&\r\n        lay.options.linkedLayers?.linkId.includes('WmsWorkspaceTableSrc')\r\n      )\r\n        {\r\n          const wmsOlLayer = lay.dataSource.ol as olSourceImageWMS;\r\n          let params = wmsOlLayer.getParams();\r\n          params._t = new Date().getTime();\r\n          wmsOlLayer.updateParams(params);\r\n        }\r\n    }\r\n  }\r\n\r\n  validateFeature(feature, workspace: EditionWorkspace) {\r\n    let message;\r\n    let key;\r\n    let valid = true;\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.hasOwnProperty('validation') && column.validation) {\r\n        key = getColumnKeyWithoutPropertiesTag(column.name);\r\n        Object.keys( column.validation).forEach((type) => {\r\n          switch (type) {\r\n            case 'mandatory': {\r\n              if (column.validation[type] && (!feature.properties.hasOwnProperty(key) || !feature.properties[key])) {\r\n                valid = false;\r\n                this.messageService.error(\r\n                  'igo.geo.formValidation.mandatory',\r\n                  undefined,\r\n                  undefined,\r\n                  {column: column.title});\r\n              }\r\n              break;\r\n            }\r\n            case 'minValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] < column.validation[type]) {\r\n                valid = false;\r\n                this.messageService.error(\r\n                  'igo.geo.formValidation.minValue',\r\n                  undefined,\r\n                  undefined,\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  });\r\n              }\r\n              break;\r\n            }\r\n            case 'maxValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] > column.validation[type]) {\r\n                valid = false;\r\n                this.messageService.error(\r\n                  'igo.geo.formValidation.maxValue',\r\n                  undefined,\r\n                  undefined,\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  });\r\n              }\r\n              break;\r\n            }\r\n            case 'minLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length < column.validation[type])\r\n              {\r\n                valid = false;\r\n                this.messageService.error(\r\n                  'igo.geo.formValidation.minLength',\r\n                  undefined,\r\n                  undefined,\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  });\r\n              }\r\n              break;\r\n            }\r\n            case 'maxLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length > column.validation[type])\r\n              {\r\n                valid = false;\r\n                this.messageService.error(\r\n                  'igo.geo.formValidation.maxLength',\r\n                  undefined,\r\n                  undefined,\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  });\r\n              }\r\n              break;\r\n            }\r\n            }\r\n          });\r\n      }\r\n    });\r\n    return valid;\r\n  }\r\n\r\n  sanitizeParameter(feature, workspace: EditionWorkspace) {\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.type === 'list' && feature.properties[getColumnKeyWithoutPropertiesTag(column.name)]) {\r\n        feature.properties[getColumnKeyWithoutPropertiesTag(column.name)] =\r\n          feature.properties[getColumnKeyWithoutPropertiesTag(column.name)].toString();\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n}\r\n\r\nfunction getColumnKeyWithoutPropertiesTag(column: string) {\r\n  if (column.includes('properties.')) {\r\n    return column.split('.')[1];\r\n  }\r\n  return column;\r\n}\r\n\r\nfunction removeZ(coords: any) {\r\n  if (coords.length === 0) return coords;\r\n  if (typeof coords[0] === 'number') return coords.slice(0, 2);\r\n  return coords.map(removeZ);\r\n}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface FeatureWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class FeatureWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: FeatureWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreSearchIndexStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\nimport { getCommonVectorSelectedStyle } from '../../style/shared/vector/commonVectorStyle';\r\n\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService, private configService: ConfigService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): FeatureWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n\r\n    const wks = new FeatureWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const searchStrategy = new FeatureStoreSearchIndexStrategy({\r\n      percentDistinctValueRatio: 2,\r\n      sourceFields: layer.dataSource.options.sourceFields\r\n    });\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    if (layer.options.workspace?.searchIndexEnabled) {\r\n      store.addStrategy(searchStrategy, true);\r\n    }\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: FeatureWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Directive, Input, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Workspace, WorkspaceStore, WorkspaceSelectorComponent } from '@igo2/common';\r\n\r\nimport { Layer, ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { WFSDataSource, WMSDataSource, FeatureDataSource } from '../../datasource';\r\nimport { OgcFilterableDataSourceOptions } from '../../filter';\r\n\r\nimport { WfsWorkspaceService } from '../shared/wfs-workspace.service';\r\nimport { WmsWorkspaceService } from '../shared/wms-workspace.service';\r\nimport { EditionWorkspaceService } from '../shared/edition-workspace.service';\r\nimport { FeatureWorkspaceService } from '../shared/feature-workspace.service';\r\nimport { FeatureStoreInMapExtentStrategy } from '../../feature/shared/strategies/in-map-extent';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\n\r\n@Directive({\r\n  selector: '[igoWorkspaceSelector]'\r\n})\r\nexport class WorkspaceSelectorDirective implements OnInit, OnDestroy {\r\n\r\n  private layers$$: Subscription;\r\n  private entities$$: Subscription[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() changeWorkspace = new EventEmitter<string>();\r\n  @Output() disableSwitch = new EventEmitter<boolean>();\r\n  @Output() relationLayers = new EventEmitter<ImageLayer[] | VectorLayer[]>();\r\n  @Output() rowsInMapExtentCheckCondition = new EventEmitter<boolean>();\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.component.store;\r\n  }\r\n\r\n  constructor(\r\n    private component: WorkspaceSelectorComponent,\r\n    private wfsWorkspaceService: WfsWorkspaceService,\r\n    private wmsWorkspaceService: WmsWorkspaceService,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private featureWorkspaceService: FeatureWorkspaceService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((layers: Layer[]) =>\r\n        this.onLayersChange(layers)\r\n      );\r\n\r\n    this.featureWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wmsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wfsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.adding$.subscribe((adding) => { this.disableSwitch.emit(adding); });\r\n    this.editionWorkspaceService.relationLayers$.subscribe((layers) => { this.relationLayers.emit(layers); });\r\n    this.editionWorkspaceService.rowsInMapExtentCheckCondition$.subscribe((condition) => {\r\n      this.rowsInMapExtentCheckCondition.emit(condition);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.entities$$.map(entities => entities.unsubscribe());\r\n  }\r\n\r\n  private onLayersChange(layers: Layer[]) {\r\n    const editableLayers = layers.filter((layer: Layer) =>\r\n      this.layerIsEditable(layer)\r\n    );\r\n    const editableLayersIds = editableLayers.map((layer: Layer) => layer.id);\r\n\r\n    const workspacesToAdd = editableLayers\r\n      .map((layer: VectorLayer) => this.getOrCreateWorkspace(layer))\r\n      .filter((workspace: Workspace | undefined) => workspace !== undefined);\r\n\r\n    const workspacesToRemove = this.workspaceStore.all()\r\n      .filter((workspace: Workspace) => {\r\n        return editableLayersIds.indexOf(workspace.id) < 0;\r\n      });\r\n\r\n    if (workspacesToRemove.length > 0) {\r\n      workspacesToRemove.forEach((workspace: Workspace) => {\r\n        workspace.entityStore.deactivateStrategyOfType(FeatureStoreInMapExtentStrategy);\r\n        workspace.deactivate();\r\n      });\r\n      this.workspaceStore.state.updateMany(workspacesToRemove, {active: false, selected: false});\r\n      this.workspaceStore.deleteMany(workspacesToRemove);\r\n    }\r\n\r\n    if (workspacesToAdd.length > 0) {\r\n      this.workspaceStore.insertMany(workspacesToAdd);\r\n    }\r\n  }\r\n\r\n  private getOrCreateWorkspace(layer: VectorLayer | ImageLayer): Workspace | undefined {\r\n    const workspace = this.workspaceStore.get(layer.id);\r\n    if (workspace !== undefined) {\r\n      return;\r\n    }\r\n    if (layer.dataSource instanceof WFSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      const wfsWks = this.wfsWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return wfsWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      if (!layer.dataSource.options.paramsWFS) { return; }\r\n      const wmsWks = this.wmsWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      wmsWks?.inResolutionRange$.subscribe((inResolutionRange) => {\r\n        (layer.dataSource.options as QueryableDataSourceOptions).queryable = !inResolutionRange;\r\n        (wmsWks.layer.dataSource.options as QueryableDataSourceOptions).queryable = inResolutionRange;\r\n      });\r\n      return wmsWks;\r\n    } else if (\r\n        layer.dataSource instanceof FeatureDataSource &&\r\n        (layer as VectorLayer).exportable === true &&\r\n        layer.dataSource.options.edition?.enabled !== true) {\r\n      const featureWks = this.featureWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return featureWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled === true) {\r\n      const editionWks = this.editionWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      return editionWks;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  private layerIsEditable(layer: Layer): boolean {\r\n    const dataSource = layer.dataSource;\r\n    if (dataSource instanceof WFSDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof FeatureDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof WMSDataSource) {\r\n      const dataSourceOptions = (dataSource.options ||\r\n        {}) as OgcFilterableDataSourceOptions;\r\n      return (dataSourceOptions.ogcFilters?.enabled || dataSource.options.paramsWFS?.featureTypes !== undefined);\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceSelectorDirective } from './workspace-selector.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceSelectorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceUpdatorDirective } from './workspace-updator.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceUpdatorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceUpdatorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceUpdatorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { ConfirmationPopupComponent } from './confirmation-popup.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatDialogModule,\r\n    MatButtonToggleModule\r\n  ],\r\n  exports: [ConfirmationPopupComponent],\r\n  declarations: [ConfirmationPopupComponent]\r\n})\r\nexport class IgoConfirmationPopupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport { provideOgcFilterWidget } from './widgets/widgets';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoOgcFilterModule } from './widgets/ogc-filter/ogc-filter.module';\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceUpdatorModule } from './workspace-updator/workspace-updator.module';\r\nimport { IgoConfirmationPopupModule } from './confirmation-popup/confirmation-popup.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoWidgetModule,\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    IgoConfirmationPopupModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    provideOgcFilterWidget()\r\n  ]\r\n})\r\nexport class IgoGeoWorkspaceModule {}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { StyleListService } from './style-list.service';\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\nexport let STYLELIST_OPTIONS = new InjectionToken<StyleListOptions>('styleListOptions');\r\n\r\nexport function provideStyleListOptions(options: StyleListOptions) {\r\n  return {\r\n    provide: STYLELIST_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function styleListFactory(\r\n  styleListService: StyleListService,\r\n  options: StyleListOptions\r\n) {\r\n  return () => styleListService.load(options);\r\n}\r\n\r\nexport function provideStyleListLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: styleListFactory,\r\n    multi: true,\r\n    deps: [StyleListService, STYLELIST_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideStyleListOptions, provideStyleListLoader } from './style-list.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoStyleListModule {\r\n  static forRoot(): ModuleWithProviders<IgoStyleListModule> {\r\n    return {\r\n      ngModule: IgoStyleListModule,\r\n      providers: [provideStyleListOptions({}), provideStyleListLoader()]\r\n    };\r\n  }\r\n}\r\n","import { CommonModule } from '@angular/common';\r\nimport { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\nimport { IgoStyleListModule } from './style-list/style-list.module';\r\nimport { StyleModalDrawingComponent } from './style-modal/drawing/style-modal-drawing.component';\r\nimport { StyleModalLayerComponent } from './style-modal/layer/style-modal-layer.component';\r\nimport { StyleModalLayerButtonComponent } from './style-modal/layer-button/style-modal-layer-button.component';\r\nimport { DrawStyleService } from './style-service/draw-style.service';\r\nimport { StyleService } from './style-service/style.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    ColorPickerModule,\r\n    CommonModule,\r\n    FormsModule,\r\n    IgoLanguageModule,\r\n    MatFormFieldModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    ReactiveFormsModule,\r\n    IgoStyleListModule.forRoot()\r\n  ],\r\n  exports: [IgoStyleListModule, StyleModalDrawingComponent, StyleModalLayerComponent, StyleModalLayerButtonComponent],\r\n  declarations: [StyleModalDrawingComponent, StyleModalLayerComponent, StyleModalLayerButtonComponent]\r\n})\r\nexport class IgoStyleModule {\r\n  static forRoot(): ModuleWithProviders<IgoStyleModule> {\r\n    return {\r\n      ngModule: IgoStyleModule,\r\n      providers: [StyleService, DrawStyleService]\r\n    };\r\n  }\r\n}\r\n","import { EntityStore } from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureWithDirection, FeatureWithStep, FeatureWithStop, Stop } from './directions.interface';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * stops.\r\n */\r\nexport class StopsStore extends EntityStore<Stop> {\r\n\r\n    public storeInitialized$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n    public clearStops() {\r\n        this.storeInitialized$.next(false);\r\n        this.clear();\r\n    }\r\n\r\n}\r\n\r\nexport class StopsFeatureStore extends FeatureStore<FeatureWithStop> {\r\n\r\n}\r\nexport class RoutesFeatureStore extends FeatureStore<FeatureWithDirection> {\r\n\r\n}\r\nexport class StepFeatureStore extends FeatureStore<FeatureWithStep> {\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsFormat, SourceDirectionsType } from '../shared/directions.enum';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { DirectionsSourceOptions } from './directions-source.interface';\r\n\r\n@Injectable()\r\nexport class OsrmDirectionsSource extends DirectionsSource {\r\n  get enabled(): boolean {\r\n    return this.options.enabled !== false;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  static _name = 'OSRM Québec';\r\n  private directionsUrl =\r\n    'https://geoegl.msp.gouv.qc.ca/services/itineraire/route/v1/driving/';\r\n  private options: DirectionsSourceOptions;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    super();\r\n    this.options = this.config.getConfig('directionsSources.osrm') || {};\r\n    this.directionsUrl = this.options.url || this.directionsUrl;\r\n  }\r\n\r\n  getName(): string {\r\n    return OsrmDirectionsSource._name;\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]> {\r\n    const directionsParams = this.getRouteParams(directionsOptions);\r\n    return this.http\r\n      .get<JSON[]>(this.directionsUrl + coordinates.join(';'), {\r\n        params: directionsParams\r\n      })\r\n      .pipe(map(res => this.extractRoutesData(res)));\r\n  }\r\n\r\n  private extractRoutesData(response): Direction[] {\r\n    const routeResponse = [];\r\n    response.routes.forEach(route => {\r\n      routeResponse.push(this.formatRoute(route, response.waypoints));\r\n    });\r\n    return routeResponse;\r\n  }\r\n\r\n  private getRouteParams(directionsOptions: DirectionOptions = {}): HttpParams {\r\n\r\n    directionsOptions.alternatives = directionsOptions.alternatives !== undefined ? directionsOptions.alternatives : true;\r\n    directionsOptions.steps = directionsOptions.steps !== undefined ? directionsOptions.steps : true;\r\n    directionsOptions.geometries = directionsOptions.geometries !== undefined ? directionsOptions.geometries : 'geojson';\r\n    directionsOptions.overview = directionsOptions.overview !== undefined ? directionsOptions.overview : false;\r\n    directionsOptions.continue_straight = directionsOptions.continue_straight !== undefined ? directionsOptions.continue_straight : false;\r\n\r\n    return new HttpParams({\r\n      fromObject: {\r\n        alternatives: directionsOptions.alternatives ? 'true' : 'false',\r\n        overview: directionsOptions.overview ? 'simplified' : 'full',\r\n        steps: directionsOptions.steps ? 'true' : 'false',\r\n        geometries: directionsOptions.geometries ? directionsOptions.geometries : 'geojson',\r\n        continue_straight: directionsOptions.continue_straight ? 'true' : 'false',\r\n      }\r\n    });\r\n  }\r\n\r\n  private formatRoute(roadNetworkRoute: any, waypoints: any): Direction {\r\n    const stepsUI = [];\r\n    roadNetworkRoute.legs.forEach(leg => {\r\n      leg.steps.forEach(step => {\r\n        stepsUI.push(step);\r\n      });\r\n    });\r\n    return {\r\n      id: uuid(),\r\n      title: roadNetworkRoute.legs[0].summary,\r\n      source: OsrmDirectionsSource._name,\r\n      sourceType: SourceDirectionsType.Route,\r\n      order: 1,\r\n      format: DirectionsFormat.GeoJSON,\r\n      icon: 'directions',\r\n      projection: 'EPSG:4326',\r\n      waypoints,\r\n      distance: roadNetworkRoute.distance,\r\n      duration: roadNetworkRoute.duration,\r\n      geometry: roadNetworkRoute.geometry,\r\n      legs: roadNetworkRoute.legs,\r\n      steps: stepsUI,\r\n      weight: roadNetworkRoute.weight,\r\n      weight_name: roadNetworkRoute.weight_name\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { OsrmDirectionsSource } from './osrm-directions-source';\r\n\r\nexport function osrmDirectionsSourcesFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new OsrmDirectionsSource(http, config);\r\n}\r\n\r\nexport function provideOsrmDirectionsSource() {\r\n  return {\r\n    provide: DirectionsSource,\r\n    useFactory: osrmDirectionsSourcesFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olWKT from 'ol/format/WKT';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\nimport { GeoJsonGeometryTypes } from 'geojson';\r\n\r\n/**\r\n * Cadastre search source\r\n */\r\n@Injectable()\r\nexport class CadastreSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'cadastre';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return CadastreSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CadastreSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Cadastre (Québec)',\r\n      searchUrl: 'https://carto.cptaq.gouv.qc.ca/php/find_lot_v1.php?'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    term = term.endsWith(',') ? term.slice(0, -1) : term;\r\n    term = term.startsWith(',') ? term.substr(1) : term;\r\n    term = term.replace(/ /g, '');\r\n\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('numero') || !params.get('numero').match(/^[0-9,]+$/g)) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params, responseType: 'text' })\r\n      .pipe(map((response: string) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          numero: term,\r\n          epsg: '4326'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: string, term: string): SearchResult<Feature>[] {\r\n    return response\r\n      .split('<br />')\r\n      .filter((lot: string) => lot.length > 0)\r\n      .map((lot: string) => this.dataToResult(lot, term));\r\n  }\r\n\r\n  private dataToResult(data: string, term: string): SearchResult<Feature> {\r\n    const lot = data.split(';');\r\n    const numero = lot[0];\r\n    const wkt = lot[7];\r\n    const geometry = this.computeGeometry(wkt);\r\n\r\n    const properties = {\r\n      NoLot: numero,\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    const id = [this.getId(), 'cadastre', numero].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: numero,\r\n        score: computeTermSimilarity(term.trim(), numero),\r\n        icon: 'map-marker'\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: numero\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeGeometry(wkt: string): FeatureGeometry {\r\n    const feature = new olWKT().readFeature(wkt, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: 'EPSG:4326'\r\n    });\r\n    return {\r\n      type: feature.getGeometry().getType() as GeoJsonGeometryTypes,\r\n      coordinates: (feature.getGeometry() as any).getCoordinates()\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { CadastreSearchSource } from './cadastre';\r\n\r\n/**\r\n * Cadastre search source factory\r\n * @ignore\r\n */\r\nexport function cadastreSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new CadastreSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${CadastreSearchSource.id}`),\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Cadastre search source\r\n */\r\nexport function provideCadastreSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: cadastreSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\nimport { NominatimData } from './nominatim.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * Nominatim search source\r\n */\r\n@Injectable()\r\nexport class NominatimSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'nominatim';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    storageService: StorageService\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return NominatimSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return NominatimSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Nominatim (OSM)',\r\n      searchUrl: 'https://nominatim.openstreetmap.org/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'amenity',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.food',\r\n              value:\r\n                'bar,bbq,biergaten,cafe,drinking_water,fast_food,food_court,ice_cream,pub,restaurant',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.health',\r\n              value:\r\n                'baby_hatch,clinic,dentist,doctors,hospital,nursing_home,pharmacy,social_facility,veterinary',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.entertainment',\r\n              value:\r\n                'arts_centre,brothel,casino,cinema,community_center_fountain,gambling,nightclub,planetarium \\\r\n                          ,public_bookcase,social_centre,stripclub,studio,swingerclub,theatre,internet_cafe',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.finance',\r\n              value: 'atm,bank,bureau_de_change',\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: true\r\n            },\r\n            {\r\n              title: '20',\r\n              value: 20,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'countrycodes',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.canada',\r\n              value: 'CA',\r\n              enabled: true\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.all',\r\n              value: null,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'multiple object',\r\n          name: 'dedupe',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.true',\r\n              value: 0,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.false',\r\n              value: 1,\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q')) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(map((response: NominatimData[]) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          q: this.computeTerm(term),\r\n          format: 'json'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: NominatimData[], term: string): SearchResult<Feature>[] {\r\n    return response.map((data: NominatimData) => this.dataToResult(data, term));\r\n  }\r\n\r\n  private dataToResult(data: NominatimData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const geometry = this.computeGeometry(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), 'place', data.place_id].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.display_name,\r\n        icon: 'map-marker',\r\n        score: computeTermSimilarity(term.trim(), data.display_name)\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.display_name\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: NominatimData): { [key: string]: any } {\r\n    return {\r\n      display_name: data.display_name,\r\n      place_id: data.place_id,\r\n      osm_type: data.osm_type,\r\n      class: data.class,\r\n      type: data.type\r\n    };\r\n  }\r\n\r\n  private computeGeometry(data: NominatimData): FeatureGeometry {\r\n    return {\r\n      type: 'Point',\r\n      coordinates: [parseFloat(data.lon), parseFloat(data.lat)]\r\n    };\r\n  }\r\n\r\n  private computeExtent(data: NominatimData): [number, number, number, number] {\r\n    return [\r\n      parseFloat(data.boundingbox[2]),\r\n      parseFloat(data.boundingbox[0]),\r\n      parseFloat(data.boundingbox[3]),\r\n      parseFloat(data.boundingbox[1])\r\n    ];\r\n  }\r\n\r\n  private computeTerm(term: string): string {\r\n    return this.computeTermTags(term);\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from query in Nominatim's format (+[])\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTermTags(term: string): string {\r\n    const hashtags = super.getHashtagsValid(term, 'amenity');\r\n    if (!hashtags) {\r\n      return this.computeTermSettings(term);\r\n    }\r\n\r\n    if (!hashtags.length) {\r\n      return null;\r\n    }\r\n\r\n    term = term.replace(/(#[^\\s]*)/g, '');\r\n    hashtags.forEach(tag => {\r\n      term += '+[' + tag + ']';\r\n    });\r\n\r\n    return term;\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from settings in Nominatim's format (+[])\r\n   * @param term Query\r\n   */\r\n  private computeTermSettings(term: string): string {\r\n    this.options.settings.forEach(settings => {\r\n      if (settings.name === 'amenity') {\r\n        settings.values.forEach(conf => {\r\n          if (conf.enabled && typeof conf.value === 'string') {\r\n            const splitted = conf.value.split(',');\r\n            splitted.forEach(value => {\r\n              term += '+[' + value + ']';\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return term;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { NominatimSearchSource } from './nominatim';\r\n\r\n/**\r\n * Nominatim search source factory\r\n * @ignore\r\n */\r\nexport function nominatimSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService,\r\n  storageService: StorageService\r\n) {\r\n  return new NominatimSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${NominatimSearchSource.id}`),\r\n    storageService\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Nominatim search source\r\n */\r\nexport function provideNominatimSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: nominatimSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService, StorageService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  StoredQueriesData,\r\n  StoredQueriesResponse,\r\n  StoredQueriesReverseData,\r\n  StoredQueriesReverseResponse,\r\n  StoredQueriesSearchSourceOptions,\r\n  StoredQueriesFields,\r\n  StoredQueriesReverseSearchSourceOptions\r\n} from './storedqueries.interfaces';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * StoredQueries search source\r\n */\r\n@Injectable()\r\nexport class StoredQueriesSearchSource extends SearchSource\r\n  implements TextSearch {\r\n  static id = 'storedqueries';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [\r\n    'boundedBy',\r\n    'id',\r\n    'coord_x',\r\n    'coord_y'\r\n  ];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesSearchSourceOptions;\r\n    if (this.storedQueriesOptions && !this.storedQueriesOptions.available) {\r\n      return;\r\n    }\r\n\r\n    const defaultStoredqueryId = 'rtss';\r\n    const defaultFieldSplitter: StoredQueriesFields[] = [\r\n      { name: 'rtss', defaultValue: '-99' },\r\n      { name: 'chainage', defaultValue: '0', splitPrefix: '\\\\+' }\r\n    ];\r\n    const defaultOutputformat = 'text/xml; subtype=gml/3.1.1';\r\n    const defaultSrsname = 'EPSG:4326';\r\n    const defaultResultTitle = 'title';\r\n\r\n    if (!this.storedQueriesOptions) {\r\n      console.log(\r\n        ' No configuration for this search source (storedqueries). You will use the default values'\r\n      );\r\n      this.storedQueriesOptions = {\r\n        storedquery_id: defaultStoredqueryId,\r\n        fields: defaultFieldSplitter,\r\n        outputformat: defaultOutputformat,\r\n        srsname: defaultSrsname,\r\n        resultTitle: defaultResultTitle\r\n      };\r\n      this.resultTitle = defaultResultTitle;\r\n      console.log('Default values', this.storedQueriesOptions);\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.fields) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"fields\" into options. ex: fields: {\"name\": \"rtss\", \"defaultValue\": \"-99\"}'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n\r\n    const storedQueryId = this.storedQueriesOptions.storedquery_id.toLowerCase();\r\n    if (\r\n      storedQueryId.includes('getfeaturebyid') &&\r\n      this.storedQueriesOptions.outputformat\r\n        .toLowerCase()\r\n        .includes('getfeaturebyid')\r\n    ) {\r\n      let err =\r\n        'You must set a geojson format for your stored query. This is due to an openlayers issue)';\r\n      err += ' (wfs 1.1.0 & gml 3.1.1 limitation)';\r\n      throw new Error(err);\r\n    }\r\n\r\n    if (!(this.storedQueriesOptions.fields instanceof Array)) {\r\n      this.storedQueriesOptions.fields = [this.storedQueriesOptions.fields];\r\n    }\r\n\r\n    this.multipleFieldsQuery =\r\n      this.storedQueriesOptions.fields.length > 1 ? true : false;\r\n\r\n    this.storedQueriesOptions.fields.forEach((field, index) => {\r\n      if (this.multipleFieldsQuery && !field.splitPrefix && index !== 0) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field spliter into your field definition (optional for the first one!)'\r\n        );\r\n      }\r\n      if (!field.defaultValue) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field default value into your field definition'\r\n        );\r\n      }\r\n    });\r\n\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  // URL CALL EXAMPLES:\r\n  //  GetFeatureById (mandatory storedquery for wfs server) (outputformat must be in geojson)\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=2.0.0&request=GetFeature&storedquery_id=urn:ogc:def:query:OGC-WFS::GetFeatureById&srsname=epsg:4326&outputformat=geojson&ID=a_num_route.132\r\n  //  Custom StoredQuery\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=rtss&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&rtss=0013801110000c&chainage=12\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const storedqueriesParams = this.termSplitter(\r\n      term,\r\n      this.storedQueriesOptions.fields\r\n    );\r\n    const params = this.computeRequestParams(\r\n      options || {},\r\n      storedqueriesParams\r\n    );\r\n    this.options.params = this.options.params ? this.options.params : {};\r\n    this.options.params.page = options.page ? String(options.page) : '1';\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            let resultArray = this.extractResults(this.extractWFSData(response), term);\r\n            resultArray.sort((a, b) =>\r\n              (a.meta.score > b.meta.score) ? 1 :\r\n              (a.meta.score === b.meta.score) ? ((a.meta.titleHtml < b.meta.titleHtml) ? 1 : -1) : -1);\r\n            resultArray.reverse();\r\n            if (resultArray.length > Number(this.options.params.limit)) {\r\n              const idxEnd = Number(this.options.params.limit) * Number(this.options.params.page);\r\n              const resultTotLenght = resultArray.length;\r\n              resultArray = resultArray.slice(0, idxEnd);\r\n              if (idxEnd < resultTotLenght) {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = true;\r\n              } else {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = false;\r\n              }\r\n            }\r\n            return resultArray;\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response), term);\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private termSplitter(term: string, fields: StoredQueriesFields[]): {} {\r\n    const splittedTerm = {};\r\n    let remainingTerm = term;\r\n    let cnt = 0;\r\n\r\n    // Used to build the default values\r\n    fields.forEach(field => {\r\n      splittedTerm[field.name] = field.defaultValue;\r\n      const splitterRegex = new RegExp(field.splitPrefix + '(.+)', 'i');\r\n      if (splitterRegex.test(remainingTerm)) {\r\n        cnt = field.splitPrefix ? (cnt += 1) : cnt;\r\n        remainingTerm = remainingTerm.split(splitterRegex)[1];\r\n      }\r\n    });\r\n    if (cnt === 0) {\r\n      splittedTerm[fields[0].name] = term;\r\n      return splittedTerm;\r\n    }\r\n    remainingTerm = term;\r\n    const localFields = [...fields].reverse();\r\n    localFields.forEach(field => {\r\n      const splitterRegex = new RegExp(field.splitPrefix || '' + '(.+)', 'i');\r\n      if (remainingTerm || remainingTerm !== '') {\r\n        const values = remainingTerm.split(splitterRegex);\r\n        remainingTerm = values[0];\r\n        if (values[1]) {\r\n          splittedTerm[field.name] = values[1].trim();\r\n        }\r\n      }\r\n    });\r\n    return splittedTerm;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    options: TextSearchOptions,\r\n    queryParams\r\n  ): HttpParams {\r\n    const wfsversion = this.storedQueriesOptions.storedquery_id\r\n      .toLowerCase()\r\n      .includes('getfeaturebyid')\r\n      ? '2.0.0'\r\n      : '1.1.0';\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'wfs',\r\n          version: wfsversion,\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        queryParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesResponse, term: string\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesData) => {\r\n      return this.dataToResult(data, term);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        // extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.title,\r\n        titleHtml: data.properties[title],\r\n        icon: 'map-marker',\r\n        score: (data.properties.title) ?\r\n        computeTermSimilarity(term.trim(), data.properties.title) :\r\n        computeTermSimilarity(term.trim(), data.properties[title]),\r\n\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: StoredQueriesData): { [key: string]: any } {\r\n    const properties = Object.assign(\r\n      {},\r\n      ObjectUtils.removeKeys(\r\n        data.properties,\r\n        StoredQueriesSearchSource.propertiesBlacklist\r\n      ),\r\n      { Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>' }\r\n    );\r\n    return properties;\r\n  }\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source\r\n */\r\n\r\n// EXAMPLE CALLS\r\n /* eslint-disable max-len */\r\n// https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=lim_adm&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&long=-71.292469&lat=46.748107\r\n//\r\n\r\n@Injectable()\r\nexport class StoredQueriesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'storedqueriesreverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesReverseSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesReverseSearchSourceOptions;\r\n\r\n    if (!this.storedQueriesOptions || (this.storedQueriesOptions && !this.storedQueriesOptions.available) ) {\r\n      return;\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.longField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"longField\" to map the longitude coordinate to the query params.'\r\n      );\r\n    }\r\n    if (!this.storedQueriesOptions.latField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"latField\" to map the latitude coordinate to the query params.'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries (reverse)',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            return this.extractResults(this.extractWFSData(response));\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response));\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    const longLatParams = {};\r\n    longLatParams[this.storedQueriesOptions.longField] = lonLat[0];\r\n    longLatParams[this.storedQueriesOptions.latField] = lonLat[1];\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'WFS',\r\n          version: '1.1.0',\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        longLatParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties[title],\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(\r\n    data: StoredQueriesReverseData\r\n  ): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      StoredQueriesReverseSearchSource.propertiesBlacklist\r\n    );\r\n    const routing = {\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    return Object.assign(properties, { type: data.properties.doc_type }, routing);\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  StoredQueriesSearchSource,\r\n  StoredQueriesReverseSearchSource\r\n} from './storedqueries';\r\n\r\n/**\r\n * StoredQueries search source factory\r\n * @ignore\r\n */\r\nexport function storedqueriesSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueries search source\r\n */\r\nexport function provideStoredQueriesSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source factory\r\n * @ignore\r\n */\r\n\r\nexport function storedqueriesReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesReverseSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueriesReverse search source\r\n */\r\nexport function provideStoredQueriesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { Observable, of, BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions\r\n} from './source.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { SimpleDocumentSearchResultSetUnit } from 'flexsearch';\r\nimport { GoogleLinks } from '../../../utils/googleLinks';\r\nimport pointOnFeature from '@turf/point-on-feature';\r\nimport { Layer } from '../../../layer/shared/layers/layer';\r\nimport { WorkspaceData } from './workspace.interfaces';\r\n\r\n\r\n/**\r\n * Workspace search source\r\n */\r\n@Injectable()\r\nexport class WorkspaceSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'workspace';\r\n  static type = FEATURE;\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return WorkspaceSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return WorkspaceSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const limit: Number = 5;\r\n\r\n    return {\r\n      title: 'igo.geo.search.workspace.name',\r\n      searchUrl: undefined,\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'datasets',\r\n          name: 'datasets',\r\n          values: []\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {title: '1',value: 1,enabled: limit === 1},\r\n            {title: '5',value: 5,enabled: limit === 5 || !limit},\r\n            {title: '10',value: 10,enabled: limit === 10},\r\n            {title: '25',value: 25,enabled: limit === 25},\r\n            {title: '50',value: 50,enabled: limit === 50}\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const limitSetting = this.settings.find((s) => s.name === 'limit');\r\n    const limitValue = limitSetting.values.find(v => v.enabled).value as number || 5;\r\n    this.options.params.limit = limitValue.toLocaleString();\r\n    const results: WorkspaceData[] = [];\r\n    this.options.params.page = (options.page || 1).toLocaleString();\r\n    const page = options.page || 1;\r\n    const datasets = this.options.params.datasets.split(',');\r\n    this.featureStoresWithIndex\r\n      .filter(fswi => fswi.searchDocument && datasets.includes(fswi.layer.title))\r\n      .map(fswi => {\r\n        const termToUse = term;\r\n        fswi.searchDocument.search(termToUse, { limit: page * limitValue }).map(i => {\r\n          const foundIn: SimpleDocumentSearchResultSetUnit = i;\r\n          const field = foundIn.field;\r\n          foundIn.result.map(index => {\r\n            const feature = fswi.index.get(index);\r\n            const score = computeTermSimilarity(termToUse.trim(), feature.properties[field]);\r\n            results.push({ index, feature, layer: fswi.layer, field, score });\r\n          });\r\n        });\r\n      });\r\n\r\n    results.sort((a, b) => (a.score > b.score) ? -1 : 1);\r\n    const gettedIndex = [];\r\n    const sortedResultToProcess: WorkspaceData[] = [];\r\n    results.map(r => {\r\n      if (!gettedIndex.includes(r.index)) {\r\n        gettedIndex.push(r.index);\r\n        sortedResultToProcess.push(r);\r\n      }\r\n    });\r\n\r\n    return of(\r\n      this.extractResults(sortedResultToProcess\r\n        .sort((a, b) => (a.score > b.score) ? -1 : 1)\r\n        .slice(0, page * limitValue))\r\n    );\r\n  }\r\n\r\n  private extractResults(results: WorkspaceData[]): SearchResult<Feature>[] {\r\n    return results.map(result => this.dataToResult(result, results.length));\r\n  }\r\n\r\n\r\n    private dataToResult(\r\n      data: WorkspaceData,\r\n      resultsCnt: number\r\n    ): SearchResult<Feature> {\r\n      const properties = this.computeProperties(data);\r\n      const id = [this.getId(), properties.type, data.index].join('.');\r\n      const titleHtml = data.feature.properties[data.field];\r\n      const subtitleHtml2 = '<br><small> ' + data.layer.title + '</small>';\r\n\r\n      return {\r\n        source: this,\r\n        data: {\r\n          type: FEATURE,\r\n          projection: 'EPSG:4326',\r\n          geometry: data.feature.geometry,\r\n          extent: data.feature.extent,\r\n          properties,\r\n          meta: {\r\n            id,\r\n            title: data.feature.properties[data.field],\r\n            alias: this.getAllowedFieldsAndAlias(data.layer)\r\n          }\r\n        },\r\n        meta: {\r\n          dataType: FEATURE,\r\n          id,\r\n          title: data.feature.meta.title,\r\n          titleHtml: titleHtml + subtitleHtml2,\r\n          icon: 'map-marker',\r\n          score: data.score,\r\n          nextPage:\r\n            resultsCnt % +this.options.params.limit === 0 &&\r\n            +this.options.params.page < 10\r\n        }\r\n      } as SearchResult<Feature>;\r\n    }\r\n\r\n\r\n    private getAllowedFieldsAndAlias(layer: Layer) {\r\n      let allowedFieldsAndAlias;\r\n      if (\r\n        layer.options?.source?.options?.sourceFields &&\r\n        layer.options.source.options.sourceFields.length >= 1\r\n      ) {\r\n        allowedFieldsAndAlias = {};\r\n        layer.options.source.options.sourceFields.forEach(sourceField => {\r\n          const alias = sourceField.alias ? sourceField.alias : sourceField.name;\r\n          allowedFieldsAndAlias[sourceField.name] = alias;\r\n        });\r\n      }\r\n      return allowedFieldsAndAlias;\r\n    }\r\n\r\n\r\n    private computeProperties(data: WorkspaceData): { [key: string]: any } {\r\n      if (!data.feature.geometry) {\r\n        return Object.assign({ type: data.layer.title + '.' + data.field }, data.feature.properties);\r\n      }\r\n      const googleLinksProperties: {\r\n        GoogleMaps: string;\r\n        GoogleStreetView?: string;\r\n      } = {\r\n        GoogleMaps: ''\r\n      };\r\n      let googleMaps;\r\n      if (data.feature.geometry.type === 'Point') {\r\n        googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n          data.feature.geometry.coordinates[0],\r\n          data.feature.geometry.coordinates[1]\r\n        );\r\n      } else {\r\n        const point = pointOnFeature(data.feature.geometry);\r\n        googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n          point.geometry.coordinates[0],\r\n          point.geometry.coordinates[1]\r\n        );\r\n      }\r\n      googleLinksProperties.GoogleMaps =\r\n        '<a href=' +\r\n        googleMaps +\r\n        ' target=\"_blank\">' +\r\n        this.languageService.translate.instant('igo.geo.searchByCoord') +\r\n        '</a>';\r\n      if (data.feature.geometry.type === 'Point') {\r\n        googleLinksProperties.GoogleStreetView = GoogleLinks.getGoogleStreetViewLink(\r\n          data.feature.geometry.coordinates[0],\r\n          data.feature.geometry.coordinates[1]\r\n        );\r\n      }\r\n      const routing: {\r\n        Route: string;\r\n      } = {\r\n        Route:\r\n          '<span class=\"routing\"> <u>' +\r\n          this.languageService.translate.instant('igo.geo.seeRouting') +\r\n          '</u> </span>'\r\n      };\r\n      return Object.assign(\r\n        { type: data.feature.sourceId },\r\n        data.feature.properties,\r\n        googleLinksProperties,\r\n        routing\r\n      );\r\n    }\r\n}\r\n","import { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\nimport { SearchSource } from './source';\r\nimport { WorkspaceSearchSource } from './workspace';\r\n\r\n\r\n/**\r\n * Workspace search source factory\r\n * @ignore\r\n */\r\nexport function workspaceSearchSourceFactory(\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new WorkspaceSearchSource(\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${WorkspaceSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Workspace search source\r\n */\r\nexport function provideWorkspaceSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: workspaceSearchSourceFactory,\r\n    multi: true,\r\n    deps: [\r\n      LanguageService,\r\n      StorageService,\r\n      ConfigService\r\n    ]\r\n  };\r\n}\r\n","import { WfsWorkspace } from './wfs-workspace';\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { EditionWorkspace } from './edition-workspace';\r\nimport { Observable } from 'rxjs';\r\nimport { EntityStoreFilterCustomFuncStrategy, EntityRecord } from '@igo2/common';\r\nimport { map } from 'rxjs/operators';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { StorageScope } from '@igo2/core';\r\n\r\n\r\nexport function getRowsInMapExtent(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.rowsInMapExtent.${layerId}`) as boolean || true;\r\n}\r\n\r\nexport function setRowsInMapExtent(value, layerId, storageService) {\r\n  storageService.set(`workspace.rowsInMapExtent.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function getSelectedOnly(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.selectedOnly.${layerId}`) as boolean || false;\r\n}\r\n\r\nexport function setSelectedOnly(value, layerId, storageService) {\r\n  storageService.set(`workspace.selectedOnly.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function mapExtentStrategyActiveToolTip(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<string> {\r\n  return ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy).active$.pipe(\r\n    map((active: boolean) => active ? 'igo.geo.workspace.inMapExtent.active.tooltip' : 'igo.geo.workspace.inMapExtent.inactive.tooltip')\r\n  );\r\n}\r\n\r\nexport function noElementSelected(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<boolean> {\r\n  return ws.entityStore.stateView.manyBy$((record: EntityRecord<Feature>) => {\r\n    return record.state.selected === true;\r\n  }).pipe(\r\n    map((entities: EntityRecord<Feature>[]) => entities.length >= 1)\r\n  );\r\n}\r\n\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/simple-map\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoPointerPosition\r\n  [pointerPositionDelay]=\"pointerCoordDelay\"\r\n  (pointerPositionCoord)=\"onPointerMove($event)\">\r\n    <igo-info-section [infoContent]=\"pointerCoord\"></igo-info-section>\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n    <igo-wake-lock-button></igo-wake-lock-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n\r\n<p *ngIf=\"!isTouchScreen\">{{pointerCoord}}</p>","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'simple-map',\r\n    component: AppSimpleMapComponent\r\n  }\r\n];\r\n\r\nexport const AppSimpleMapRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-simple-map',\r\n  templateUrl: './simple-map.component.html',\r\n  styleUrls: ['./simple-map.component.scss']\r\n})\r\nexport class AppSimpleMapComponent {\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    rotation: 0.75\r\n  };\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  onPointerMove(event) {\r\n    this.pointerCoord = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\nimport { AppSimpleMapRoutingModule } from './simple-map-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppSimpleMapComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSimpleMapRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppSimpleMapComponent]\r\n})\r\nexport class AppSimpleMapModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list\r\n    [map]=\"map\"\r\n    [layers]=\"map.layers\"\r\n    [expandLegendOfVisibleLayers]=\"false\"\r\n    floatLabel=\"never\"\r\n    [queryBadge]=\"true\">\r\n\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n        <igo-download-button [layer]=\"layer\"></igo-download-button>\r\n        <igo-ogc-filter-button [header]=\"true\" [layer]=\"layer\"></igo-ogc-filter-button>\r\n        <igo-time-filter-button [header]=\"true\" [layer]=\"layer\"></igo-time-filter-button>\r\n        <igo-track-feature-button [layer]=\"layer\" [trackFeature]=\"true\"></igo-track-feature-button>\r\n      </ng-template>\r\n\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'layer',\r\n    component: AppLayerComponent\r\n  }\r\n];\r\n\r\nexport const AppLayerRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-layer',\r\n  templateUrl: './layer.component.html',\r\n  styleUrls: ['./layer.component.scss']\r\n})\r\nexport class AppLayerComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    maxLayerZoomExtent: [-11000000, 4500000, -4500000, 10000000],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourceCustomEPSG: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson_utf8',\r\n        srsName: 'EPSG:32198',\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '12072'\r\n        }\r\n      },\r\n      formatOptions: {\r\n        dataProjection: 'EPSG:32198'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourceCustomEPSG)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS (Custom EPSG)',\r\n          visible: true,\r\n          source: dataSource,\r\n          removable: false\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'parc_routier',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Réseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habité',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'sh_dis_eco',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'sh_dis_eco',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'nurc:Arc_Sample_Parent',\r\n        visible: false,\r\n        legendOptions: {\r\n          // collapsed: false,\r\n          display: true,\r\n          // url: 'https://v.seloger.com/s/width/1144/visuels/0/m/l/4/0ml42xbt1n3itaboek3qec5dtskdgw6nlscu7j69k.jpg',\r\n          stylesAvailable: [\r\n            { name: 'rain', title: 'Pluie' },\r\n            { name: 'raster', title: 'Défaut' }\r\n          ] //\r\n        },\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://demo.geo-solutions.it/geoserver/ows',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'nurc:Arc_Sample', // , test:Linea_costa\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embâcle',\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\nimport { AppLayerRoutingModule } from './layer-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLayerComponent],\r\n  imports: [\r\n    AppLayerRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLayerComponent]\r\n})\r\nexport class AppLayerModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'legend',\r\n    component: AppLegendComponent\r\n  }\r\n];\r\n\r\nexport const AppLegendRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-legend',\r\n  templateUrl: './legend.component.html',\r\n  styleUrls: ['./legend.component.scss']\r\n})\r\nexport class AppLegendComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with display:false',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: false,\r\n        html: 'test html'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_dis_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend in html',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: true,\r\n        html: '<h2 style=\"background-color: blue;\">HTML légende</h2>'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: false,\r\n        params: {\r\n          LAYERS: 'sh_sreg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with url param',\r\n      visible: true,\r\n      legendOptions: {\r\n        url: `data:image/jpeg;base64,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`\r\n\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_reg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Commission scolaire anglophone',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/all.fcgi',\r\n          params: {\r\n            LAYERS: 'WMS_MEQ_CS_ANGLO',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Réseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habité',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embâcle',\r\n          visible: true,\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map with a legend list</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this\r\n      example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Legends\">\r\n    <igo-layer-legend-list [layers]=\"map.layers\"\r\n    [excludeBaseLayers]=\"true\"\r\n    [allowShowAllLegends]=\"true\"\r\n    [updateLegendOnResolutionChange]=\"false\"\r\n    [showAllLegendsValue]=\"false\">\r\n  </igo-layer-legend-list>\r\n\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\nimport { AppLegendRoutingModule } from './legend-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLegendComponent],\r\n  imports: [\r\n    AppLegendRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLegendComponent]\r\n})\r\nexport class AppLegendModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'overlay',\r\n    component: AppOverlayComponent\r\n  }\r\n];\r\n\r\nexport const AppOverlayRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, AfterViewInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-overlay',\r\n  templateUrl: './overlay.component.html',\r\n  styleUrls: ['./overlay.component.scss']\r\n})\r\nexport class AppOverlayComponent implements OnInit, AfterViewInit {\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    const feature1: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 1\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Point',\r\n        coordinates: [-73, 46.6]\r\n      }\r\n    };\r\n\r\n    const feature2: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 2\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'LineString',\r\n        coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n      }\r\n    };\r\n\r\n    const feature3: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 3\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Polygon',\r\n        coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n      }\r\n    };\r\n\r\n    this.map.overlay.setFeatures(\r\n      [feature1, feature2, feature3],\r\n      FeatureMotion.None\r\n    );\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Overlay</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/overlay\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoOverlayModule } from '@igo2/geo';\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\nimport { AppOverlayRoutingModule } from './overlay-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOverlayComponent],\r\n  imports: [\r\n    AppOverlayRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule\r\n  ],\r\n  exports: [AppOverlayComponent]\r\n})\r\nexport class AppOverlayModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Geometry Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'geometry',\r\n    component: AppGeometryComponent\r\n  }\r\n];\r\n\r\nexport const AppGeometryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-geometry',\r\n  templateUrl: './geometry.component.html',\r\n  styleUrls: ['./geometry.component.scss']\r\n})\r\nexport class AppGeometryComponent implements OnInit, OnDestroy {\r\n\r\n  map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  view = {\r\n    center: [-73, 47.2],\r\n    zoom: 15\r\n  };\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formService: FormService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'geometry',\r\n        title: 'Geometry',\r\n        options:  {\r\n          validator: Validators.required\r\n        },\r\n        type: 'geometry',\r\n        inputs: {\r\n          map: this.map,\r\n          geometryTypeField: true,\r\n          geometryType: 'Polygon',\r\n          drawGuideField: true,\r\n          drawGuide: 50,\r\n          drawGuidePlaceholder: 'Draw Guide',\r\n          drawStyle: new olstyle.Style({\r\n            stroke: new olstyle.Stroke({\r\n              color: [255, 0, 0, 1],\r\n              width: 2\r\n            }),\r\n            fill:  new olstyle.Fill({\r\n              color: [255, 0, 0, 0.2]\r\n            }),\r\n            image: new olstyle.Circle({\r\n              radius: 8,\r\n              stroke: new olstyle.Stroke({\r\n                color: [255, 0, 0, 1]\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: [255, 0, 0, 0.2]\r\n              })\r\n            })\r\n          })\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options:  {\r\n          validator: Validators.required\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      name: 'Place',\r\n      geometry: JSON.stringify({type: 'Polygon', coordinates: [[\r\n        [-106, 42],\r\n        [-107, 31],\r\n        [-81, 32],\r\n        [-82, 42],\r\n        [-106, 42]\r\n      ]]})\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\nimport { IgoGeometryModule, IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\nimport { AppGeometryRoutingModule } from './geometry-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppGeometryComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppGeometryRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule,\r\n    IgoGeometryModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppGeometryComponent]\r\n})\r\nexport class AppGeometryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'feature',\r\n    component: AppFeatureComponent\r\n  }\r\n];\r\n\r\nexport const AppFeatureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  VectorLayer,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-feature',\r\n  templateUrl: './feature.component.html',\r\n  styleUrls: ['./feature.component.scss']\r\n})\r\nexport class AppFeatureComponent implements OnInit, OnDestroy {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  public tableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'properties.id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'properties.name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'properties.description',\r\n        title: 'Description'\r\n      }\r\n    ]\r\n  };\r\n\r\n  public store = new FeatureStore([], { map: this.map });\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const loadingStrategy = new FeatureStoreLoadingStrategy({});\r\n    this.store.addStrategy(loadingStrategy);\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      motion: FeatureMotion.Default\r\n    });\r\n    this.store.addStrategy(selectionStrategy);\r\n\r\n    this.store.load([\r\n      {\r\n        meta: { id: 1 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-72, 47.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 1,\r\n          name: 'Name 1',\r\n          description: 'Description 1'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 4 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-71, 46.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 4,\r\n          name: 'Name 4',\r\n          description: 'Description 4'\r\n        }\r\n      },{\r\n        meta: { id: 5 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-73, 45.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 5,\r\n          name: 'Name 5',\r\n          description: 'Description 5'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 2 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'LineString',\r\n          coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 2,\r\n          name: 'Name 2',\r\n          description: 'Description 2'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 3 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Polygon',\r\n          coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 3,\r\n          name: 'Name 3',\r\n          description: 'Description 3'\r\n        }\r\n      }\r\n    ]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'MVT test',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true\r\n        },\r\n        igoStyle: {\r\n          mapboxStyle: {\r\n            url: 'assets/mapboxStyleExample-vectortile.json',\r\n            source: 'ahocevar'\r\n          }\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector'\r\n      })\r\n      .subscribe(dataSource => {\r\n        const layer = this.layerService.createLayer({\r\n          title: 'Vector Layer',\r\n          source: dataSource,\r\n          animation: {\r\n            duration: 2000\r\n          },\r\n          igoStyle: {\r\n            mapboxStyle: {\r\n              url: 'assets/mapboxStyleExample-feature.json',\r\n              source: 'source_nameX'\r\n            }\r\n          },\r\n        }) as VectorLayer;\r\n        this.map.addLayer(layer);\r\n        this.store.bindLayer(layer);\r\n        loadingStrategy.activate();\r\n        selectionStrategy.activate();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Feature</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geom/feature\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoEntityTableModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFeatureModule } from '@igo2/geo';\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\nimport { AppFeatureRoutingModule } from './feature-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFeatureComponent],\r\n  imports: [\r\n    AppFeatureRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoEntityTableModule,\r\n    IgoMapModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppFeatureComponent]\r\n})\r\nexport class AppFeatureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\nimport { AppHoverComponent } from './hover.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'hover',\r\n    component: AppHoverComponent\r\n  }\r\n];\r\n\r\nexport const AppHoverRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService, WFSDataSourceOptions, VectorLayerOptions, WFSDataSource } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-hover',\r\n  templateUrl: './hover.component.html',\r\n  styleUrls: ['./hover.component.scss']\r\n})\r\nexport class AppHoverComponent {\r\n  public selected;\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public pointerHoverFeatureDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 8,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wmts',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n        layer: 'carte_gouv_qc_public',\r\n        matrixSet: 'EPSG_3857',\r\n        version: '1.3.0'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Quebec',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSDataOptions\r\n      extends WFSDataSourceOptions { }\r\n\r\n    const wfsDatasourcePolygon: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'adn_bassin_n1_public_v',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '3.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePolygon)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (polygon)',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourcePoint: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/all.fcgi',\r\n      params: {\r\n        featureTypes: 'MSP_CASERNE_PUBLIC',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePoint)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (point)',\r\n          visible: true,\r\n          source: dataSource,\r\n          igoStyle: {\r\n            styleByAttribute: {\r\n              attribute: 'en_caserne',\r\n              data: ['true', 'false'],\r\n              stroke: ['red', 'blue'],\r\n              fill: ['#ffffff', '#ffffff'],\r\n              radius: [7, 7],\r\n              width: [2, 2]\r\n            },\r\n            hoverStyle: {\r\n              label: {\r\n                attribute: 'Caserne: ${no_caserne} \\n Mun: ${nom_ssi}',\r\n                style: {\r\n                  textAlign: 'left',\r\n                  textBaseline: 'top',\r\n                  font: '12px Calibri,sans-serif',\r\n                  fill: { color: '#000' },\r\n                  backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n                  backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n                  stroke: { color: '#fff', width: 3 },\r\n                  overflow: true,\r\n                  offsetX: 20,\r\n                  offsetY: 10,\r\n                  padding: [2.5, 2.5, 2.5, 2.5]\r\n                }\r\n              },\r\n              baseStyle: {\r\n                circle: {\r\n                  stroke: {\r\n                    color: 'orange',\r\n                    width: 5\r\n                  },\r\n                  width: [5],\r\n                  radius: 15\r\n                }\r\n              }\r\n            }\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Hover</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/hover\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoHoverFeature\r\n  [igoHoverFeatureDelay]=\"pointerHoverFeatureDelay\"\r\n  [igoHoverFeatureEnabled]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppHoverComponent } from './hover.component';\r\nimport { AppHoverRoutingModule } from './hover-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHoverComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppHoverRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppHoverComponent]\r\n})\r\nexport class AppHoverModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'measure',\r\n    component: AppMeasureComponent\r\n  }\r\n];\r\n\r\nexport const AppMeasureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithMeasure\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-measure',\r\n  templateUrl: './measure.component.html',\r\n  styleUrls: ['./measure.component.scss']\r\n})\r\nexport class AppMeasureComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public store = new FeatureStore<FeatureWithMeasure>([], {map: this.map});\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/measure\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-measurer [store]=\"store\" [map]=\"map\"></igo-measurer>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoMeasureModule } from '@igo2/geo';\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\nimport { AppMeasureRoutingModule } from './measure-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMeasureComponent],\r\n  imports: [\r\n    AppMeasureRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoMeasureModule\r\n  ],\r\n  exports: [AppMeasureComponent]\r\n})\r\nexport class AppMeasureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'draw',\r\n    component: AppDrawComponent\r\n  }\r\n];\r\n\r\nexport const AppDrawRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithDraw,\r\n  MapService\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-draw',\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss']\r\n})\r\nexport class AppDrawComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public stores: FeatureStore<FeatureWithDraw>[] = [];\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/draw\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-draw [stores]=\"stores\" [map]=\"map\"></igo-draw>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoDrawModule } from '@igo2/geo';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\nimport { AppDrawRoutingModule } from './draw-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDrawComponent],\r\n  imports: [\r\n    AppDrawRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoDrawModule\r\n  ],\r\n  exports: [AppDrawComponent]\r\n})\r\nexport class AppDrawModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Query</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/query\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay\r\n    igoQuery\r\n    [queryFeatures]=\"true\"\r\n    (query)=\"handleQueryResults($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Details\">\r\n    <ng-container *ngIf=\"features$ | async as features\">\r\n      <div *ngFor=\"let feature of features\">\r\n        <h1>Query Title : <span style=\"background-color: #e0e0e0;\">{{getTitle(feature)}}</span></h1>\r\n        <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n      </div>\r\n    </ng-container>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppQueryComponent } from './query.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'query',\r\n    component: AppQueryComponent\r\n  }\r\n];\r\n\r\nexport const AppQueryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olPoint from 'ol/geom/Point';\r\nimport olPolygon from 'ol/geom/Polygon';\r\nimport olLineString from 'ol/geom/LineString';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport {\r\n  IgoMap,\r\n  FeatureDataSource,\r\n  DataSourceService,\r\n  LayerService,\r\n  Feature,\r\n  QueryableDataSourceOptions,\r\n  QueryFormat,\r\n  QueryHtmlTarget,\r\n  SearchResult,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-query',\r\n  templateUrl: './query.component.html',\r\n  styleUrls: ['./query.component.scss']\r\n})\r\nexport class AppQueryComponent {\r\n  public features$ = new BehaviorSubject<Feature[]>([]);\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryTitle: 'num_rts',\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryFormat: QueryFormat.HTMLGML2,\r\n        queryHtmlTarget: QueryHtmlTarget.IFRAME,\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS html with a pre call in GML',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n      this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Query url test',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/all.fcgi',\r\n          queryable: true,\r\n          queryUrls: [{url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=wms_mern_reg_admin&LAYERS=wms_mern_reg_admin&INFO_FORMAT=application/geojson&FEATURE_COUNT=20&I=50&J=50&CRS=EPSG%3A3857&STYLES=&WIDTH=101&HEIGHT=101&BBOX={bbox}'}],\r\n          queryLayerFeatures: false,\r\n          queryFormat: 'geojson',\r\n          params: {\r\n            layers: 'SDA_MUNIC_S_20K',\r\n            version: '1.3.0'\r\n          }\r\n        }\r\n      } as any).subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector',\r\n        queryable: true,\r\n        queryTitle: 'So beautiful ${name}',\r\n        sourceFields: [\r\n          { name: 'name', alias: 'Alias name' },\r\n          { name: 'description', alias: 'Alias description' }\r\n        ]\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Vector Layer',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n        this.addFeatures(dataSource as FeatureDataSource);\r\n      });\r\n  }\r\n\r\n  addFeatures(dataSource: FeatureDataSource) {\r\n    const feature1 = new olFeature({\r\n      name: 'feature1',\r\n      geometry: new olLineString([\r\n        olproj.transform([-72, 47.8], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-73.5, 47.4], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-72.4, 48.6], 'EPSG:4326', 'EPSG:3857')\r\n      ]),\r\n    });\r\n\r\n    const feature2 = new olFeature({\r\n      name: 'feature2',\r\n      geometry: new olPoint(\r\n        olproj.transform([-73, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n      ),\r\n    });\r\n\r\n    const feature3 = new olFeature({\r\n      name: 'feature3',\r\n      geometry: new olPolygon([\r\n        [\r\n          olproj.transform([-71, 46.8], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-73, 47], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-71.2, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n        ]\r\n      ]),\r\n    });\r\n\r\n    dataSource.ol.addFeatures([feature1, feature2, feature3]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Vector tile with custom getfeatureinfo url',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url: 'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true,\r\n          queryUrls: [\r\n            { url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=wms_mern_reg_admin&LAYERS=wms_mern_reg_admin&INFO_FORMAT=application%2Fgeojson&FEATURE_COUNT=20&I=50&J=50&CRS=EPSG%3A3857&STYLES=&WIDTH=101&HEIGHT=101&BBOX={bbox}'}\r\n          ],\r\n          queryLayerFeatures: false,\r\n          // queryFormat: 'geojson'\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n      this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/incendie.fcgi',\r\n        queryable: true,\r\n        queryUrls: [\r\n          {\r\n            url:'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=SDA_MUNIC_S_20K&LAYERS=SDA_MUNIC_S_20K&INFO_FORMAT=geojson&FEATURE_COUNT=20&I=50&J=50&CRS=EPSG%3A3857&STYLES=&WIDTH=101&HEIGHT=101&BBOX={bbox}',\r\n            // minScale: 20000,\r\n            // maxScale: 9000000,\r\n            minResolution: 0,\r\n            maxResolution: 400\r\n          }\r\n        ],\r\n        queryFormat: 'geojson',\r\n        params: {\r\n          version: '1.3.0',\r\n          layers: 'MSP_CASERNE_PUBLIC'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS with custom getfeatureinfo url',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  handleQueryResults(results) {\r\n    const features: Feature[] = results.features;\r\n    if (features.length && features[0]) {\r\n      this.features$.next(features);\r\n      this.map.queryResultsOverlay.setFeatures(features, FeatureMotion.None);\r\n    }\r\n  }\r\n\r\n  getTitle(result: SearchResult) {\r\n    return getEntityTitle(result);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppQueryComponent } from './query.component';\r\nimport { AppQueryRoutingModule } from './query-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppQueryComponent],\r\n  imports: [\r\n    AppQueryRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppQueryComponent]\r\n})\r\nexport class AppQueryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppCatalogComponent } from './catalog.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'catalog',\r\n    component: AppCatalogComponent\r\n  }\r\n];\r\n\r\nexport const AppCatalogRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService, ConfigService, StorageService } from '@igo2/core';\r\nimport { IgoMap, LayerService, Catalog, CatalogItem, CatalogService, MapService } from '@igo2/geo';\r\nimport { EntityRecord, EntityStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-catalog',\r\n  templateUrl: './catalog.component.html',\r\n  styleUrls: ['./catalog.component.scss']\r\n})\r\nexport class AppCatalogComponent implements OnInit {\r\n  catalog: Catalog;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public catalogStore = new EntityStore<Catalog>([]);\r\n\r\n  public catalogItemStore = new EntityStore<CatalogItem>([]);\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private catalogService: CatalogService,\r\n    private storageService: StorageService,\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => this.map.addLayer(layer));\r\n\r\n    this.loadCatalogs();\r\n\r\n    this.mapService.setMap(this.map);\r\n    this.catalogStore.stateView\r\n      .firstBy$(\r\n        (record: EntityRecord<Catalog>) => record.state.selected === true\r\n      )\r\n      .subscribe((record: EntityRecord<Catalog>) => {\r\n        if (record && record.entity) {\r\n          const catalog = record.entity;\r\n          this.catalog = catalog;\r\n        }\r\n      });\r\n  }\r\n\r\n  /**\r\n   * When the selected catalog changes, toggle the the CatalogBrowser tool.\r\n   * @internal\r\n   * @param event Select event\r\n   */\r\n  onCatalogSelectChange(event: {selected: boolean; catalog: Catalog}) {\r\n    this.loadCatalogItems(event.catalog);\r\n  }\r\n\r\n  /**\r\n   * Get all the available catalogs from the CatalogService and\r\n   * load them into the store.\r\n   */\r\n  private loadCatalogs() {\r\n    this.catalogService.loadCatalogs()\r\n      .subscribe((catalogs: Catalog[]) => {\r\n        this.catalogStore.clear();\r\n        this.catalogStore.load(catalogs.concat((this.storageService.get('addedCatalogs') || []) as Catalog[]));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Get the selected catalog's items from the CatalogService and\r\n   * load them into the store.\r\n   * @param catalog Selected catalog\r\n   */\r\n  private loadCatalogItems(catalog: Catalog) {\r\n    this.catalogService.loadCatalogItems(catalog)\r\n      .subscribe((items: CatalogItem[]) => {\r\n        this.catalogItemStore.clear();\r\n        this.catalogItemStore.load(items);\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Catalog</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/catalog\">code of this example</a><br>\r\n    See catalog section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Catalog Library\">\r\n    <igo-catalog-library\r\n      [store]=\"catalogStore\"\r\n      (catalogSelectChange)=\"onCatalogSelectChange($event)\">\r\n    </igo-catalog-library>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Catalog Browser\">\r\n    <igo-catalog-browser\r\n      [catalog]=\"catalog\"\r\n      [store]=\"catalogItemStore\"\r\n      [map]=\"map\">\r\n    </igo-catalog-browser>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoCatalogModule } from '@igo2/geo';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppCatalogComponent } from './catalog.component';\r\nimport { AppCatalogRoutingModule } from './catalog-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppCatalogComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppCatalogRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoConfigModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoCatalogModule\r\n  ],\r\n  exports: [AppCatalogComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppCatalogModule {}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid context');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n","export enum TypePermission {\r\n  null,\r\n  read,\r\n  write\r\n}\r\n\r\nexport enum Scope {\r\n  public,\r\n  protected,\r\n  private\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\n\r\nimport { BehaviorSubject, Observable, of, Subject } from 'rxjs';\r\nimport {\r\n  map,\r\n  tap,\r\n  catchError,\r\n  debounceTime,\r\n  mergeMap,\r\n  first,\r\n  skip\r\n} from 'rxjs/operators';\r\n\r\nimport olPoint from 'ol/geom/Point';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\nimport Cluster from 'ol/source/Cluster';\r\nimport olVectorSource from 'ol/source/Vector';\r\n\r\nimport { Tool } from '@igo2/common';\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport {\r\n  ConfigService,\r\n  RouteService,\r\n  Message,\r\n  MessageService,\r\n  LanguageService,\r\n  StorageService\r\n} from '@igo2/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport type { IgoMap, Layer, LayerOptions } from '@igo2/geo';\r\nimport { ExportService } from '@igo2/geo';\r\n\r\nimport { TypePermission } from './context.enum';\r\nimport {\r\n  ContextsList,\r\n  ContextServiceOptions,\r\n  Context,\r\n  DetailedContext,\r\n  ContextMapView,\r\n  ContextPermission,\r\n  ContextProfils\r\n} from './context.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ContextService {\r\n  public context$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public contexts$ = new BehaviorSubject<ContextsList>({ ours: [] });\r\n  public defaultContextId$ = new BehaviorSubject<string>(undefined);\r\n  public editedContext$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public importedContext: Array<DetailedContext> = [];\r\n  public toolsChanged$ = new Subject<DetailedContext>();\r\n  private mapViewFromRoute: ContextMapView = {};\r\n  private options: ContextServiceOptions;\r\n  private baseUrl: string;\r\n\r\n  // Until the ContextService is completely refactored, this is needed\r\n  // to track the current tools\r\n  private tools: Tool[];\r\n  private toolbar: string[];\r\n\r\n  get defaultContextUri(): string {\r\n    return this.storageService.get('favorite.context.uri') as string || this._defaultContextUri || this.options.defaultContextUri;\r\n  }\r\n  set defaultContextUri(uri: string) {\r\n    this._defaultContextUri = uri;\r\n  }\r\n  private _defaultContextUri: string;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private languageService: LanguageService,\r\n    private config: ConfigService,\r\n    private messageService: MessageService,\r\n    private storageService: StorageService,\r\n    private exportService: ExportService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.options = Object.assign(\r\n      {\r\n        basePath: 'contexts',\r\n        contextListFile: '_contexts.json',\r\n        defaultContextUri: '_default'\r\n      },\r\n      this.config.getConfig('context')\r\n    );\r\n\r\n    this.baseUrl = this.options.url;\r\n\r\n    this.readParamsFromRoute();\r\n\r\n    if (this.authService.hasAuthService) {\r\n      this.authService.logged$.subscribe((logged) => {\r\n        if (logged) {\r\n          this.contexts$.pipe(skip(1), first()).subscribe((c) => {\r\n            this.handleContextsChange();\r\n          });\r\n          this.loadContexts();\r\n        }\r\n      });\r\n    } else {\r\n      this.loadContexts();\r\n      this.handleContextsChange(false);\r\n    }\r\n  }\r\n\r\n  get(permissions?: string[], hidden?: boolean): Observable<ContextsList> {\r\n    let url = this.baseUrl + '/contexts';\r\n    if (permissions && this.authService.authenticated) {\r\n      url += '?permission=' + permissions.join();\r\n      if (hidden) {\r\n        url += '&hidden=true';\r\n      }\r\n    }\r\n    return this.http.get<ContextsList>(url);\r\n  }\r\n\r\n  getById(id: string): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.get<Context>(url);\r\n  }\r\n\r\n  getDetails(id: string): Observable<DetailedContext> {\r\n    const url = `${this.baseUrl}/contexts/${id}/details`;\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, id);\r\n        throw res;\r\n      })\r\n    );\r\n  }\r\n\r\n  getDefault(): Observable<DetailedContext> {\r\n    if (this.authService.authenticated) {\r\n      const url = this.baseUrl + '/contexts/default';\r\n      return this.http.get<DetailedContext>(url).pipe(\r\n        tap((context) => {\r\n          this.defaultContextId$.next(context.id);\r\n        })\r\n      );\r\n    } else {\r\n      const uri = this.storageService.get('favorite.context.uri') as string;\r\n      this.defaultContextId$.next(uri);\r\n      return this.getContextByUri(uri);\r\n    }\r\n\r\n  }\r\n\r\n  getProfilByUser(): Observable<ContextProfils[]> {\r\n    if (this.baseUrl) {\r\n      const url = this.baseUrl + '/profils?';\r\n      return this.http.get<ContextProfils[]>(url);\r\n    }\r\n    return of([]);\r\n  }\r\n\r\n  setDefault(id: string): Observable<any> {\r\n    if (this.authService.authenticated) {\r\n      const url = this.baseUrl + '/contexts/default';\r\n      return this.http.post(url, { defaultContextId: id });\r\n    } else {\r\n      this.storageService.set('favorite.context.uri', id);\r\n      return of(undefined);\r\n    }\r\n  }\r\n\r\n  hideContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/hide';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  showContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/show';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  delete(id: string, imported = false): Observable<void> {\r\n    const contexts: ContextsList = { ours: [] };\r\n    Object.keys(this.contexts$.value).forEach(\r\n      (key) =>\r\n        (contexts[key] = this.contexts$.value[key].filter((c) => c.id !== id))\r\n    );\r\n\r\n    if (imported) {\r\n      this.importedContext = this.importedContext.filter((c) => c.id !== id);\r\n      return of(this.contexts$.next(contexts));\r\n    }\r\n\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.delete<void>(url).pipe(\r\n      tap((res) => {\r\n        this.contexts$.next(contexts);\r\n      })\r\n    );\r\n  }\r\n\r\n  create(context: DetailedContext): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts';\r\n    return this.http.post<Context>(url, context).pipe(\r\n      map((contextCreated) => {\r\n        if (this.authService.authenticated) {\r\n          contextCreated.permission = TypePermission[TypePermission.write];\r\n        } else {\r\n          contextCreated.permission = TypePermission[TypePermission.read];\r\n        }\r\n        this.contexts$.value.ours.unshift(contextCreated);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCreated;\r\n      })\r\n    );\r\n  }\r\n\r\n  clone(id: string, properties = {}): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/clone';\r\n    return this.http.post<Context>(url, properties).pipe(\r\n      map((contextCloned) => {\r\n        contextCloned.permission = TypePermission[TypePermission.write];\r\n        this.contexts$.value.ours.unshift(contextCloned);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCloned;\r\n      })\r\n    );\r\n  }\r\n\r\n  update(id: string, context: Context): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.patch<Context>(url, context);\r\n  }\r\n\r\n  // =================================================================\r\n\r\n  addToolAssociation(contextId: string, toolId: string): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools`;\r\n    const association = {\r\n      toolId\r\n    };\r\n    return this.http.post<void>(url, association);\r\n  }\r\n\r\n  deleteToolAssociation(contextId: string, toolId: string): Observable<any> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools/${toolId}`;\r\n    return this.http.delete(url);\r\n  }\r\n\r\n  getPermissions(id: string): Observable<ContextPermission[]> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/permissions';\r\n    return this.http.get<ContextPermission[]>(url);\r\n  }\r\n\r\n  addPermissionAssociation(\r\n    contextId: string,\r\n    profil: string,\r\n    type: TypePermission\r\n  ): Observable<ContextPermission[]> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions`;\r\n    const association = {\r\n      profil,\r\n      typePermission: type\r\n    };\r\n\r\n    return this.http.post<ContextPermission[]>(url, association).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, undefined, true);\r\n        throw [res]; // TODO Not sure about this.\r\n      })\r\n    );\r\n  }\r\n\r\n  deletePermissionAssociation(\r\n    contextId: string,\r\n    permissionId: string\r\n  ): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions/${permissionId}`;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  // ======================================================================\r\n\r\n  getLocalContexts(): Observable<ContextsList> {\r\n    const url = this.getPath(this.options.contextListFile);\r\n    return this.http.get<ContextsList>(url).pipe(\r\n      map((res: any) => {\r\n        return { ours: res };\r\n      })\r\n    );\r\n  }\r\n\r\n  getLocalContext(uri: string): Observable<DetailedContext> {\r\n    const url = this.getPath(`${uri}.json`);\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      mergeMap((res) => {\r\n        if (!res.base) {\r\n          return of(res);\r\n        }\r\n        const urlBase = this.getPath(`${res.base}.json`);\r\n        return this.http.get<DetailedContext>(urlBase).pipe(\r\n          map((resBase: DetailedContext) => {\r\n            const resMerge = res;\r\n            resMerge.map = ObjectUtils.mergeDeep(resBase.map, res.map);\r\n            resMerge.layers = (resBase.layers || [])\r\n              .concat(res.layers || [])\r\n              .reverse()\r\n              .filter(\r\n                (l, index, self) =>\r\n                  !l.id || self.findIndex((l2) => l2.id === l.id) === index\r\n              )\r\n              .reverse();\r\n            resMerge.toolbar = res.toolbar || resBase.toolbar;\r\n            resMerge.message = res.message || resBase.message;\r\n            resMerge.messages = res.messages || resBase.messages;\r\n            resMerge.tools = (res.tools || [])\r\n              .concat(resBase.tools || [])\r\n              .filter(\r\n                (t, index, self) =>\r\n                  self.findIndex((t2) => t2.name === t.name) === index\r\n              );\r\n            return resMerge;\r\n          }),\r\n          catchError((err) => {\r\n            this.handleError(err, uri);\r\n            throw err;\r\n          })\r\n        );\r\n      }),\r\n      catchError((err2) => {\r\n        this.handleError(err2, uri);\r\n        throw err2;\r\n      })\r\n    );\r\n  }\r\n\r\n  loadContexts(permissions?: string[], hidden?: boolean) {\r\n    let request;\r\n    if (this.baseUrl) {\r\n      request = this.get(permissions, hidden);\r\n    } else {\r\n      request = this.getLocalContexts();\r\n    }\r\n    request.subscribe((contexts) => {\r\n      contexts.ours = this.importedContext.concat(contexts.ours);\r\n      this.contexts$.next(contexts);\r\n    });\r\n  }\r\n\r\n  loadDefaultContext() {\r\n    const loadFct = (direct = false) => {\r\n      if (!direct && this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe(\r\n          (_context: DetailedContext) => {\r\n            this.defaultContextUri = _context.uri;\r\n            this.addContextToList(_context);\r\n            this.setContext(_context);\r\n          },\r\n          () => {\r\n            this.defaultContextId$.next(undefined);\r\n            this.loadContext(this.defaultContextUri);\r\n          }\r\n        );\r\n      } else {\r\n        this.loadContext(this.defaultContextUri);\r\n      }\r\n    };\r\n\r\n    if (this.route && this.route.options.contextKey) {\r\n      this.route.queryParams.pipe(debounceTime(100)).subscribe((params) => {\r\n        const contextParam = params[this.route.options.contextKey as string];\r\n        let direct = false;\r\n        if (contextParam) {\r\n          this.defaultContextUri = contextParam;\r\n          direct = true;\r\n        }\r\n        loadFct(direct);\r\n      });\r\n    } else {\r\n      loadFct();\r\n    }\r\n  }\r\n\r\n  loadContext(uri: string) {\r\n    const context = this.context$.value;\r\n\r\n    if (context && context.uri === uri) {\r\n      return;\r\n    }\r\n\r\n    this.getContextByUri(uri)\r\n      .pipe(first())\r\n      .subscribe(\r\n        (_context: DetailedContext) => {\r\n          this.addContextToList(_context);\r\n          this.setContext(_context);\r\n        },\r\n        (err) => {\r\n          if (uri !== this.options.defaultContextUri) {\r\n            this.loadContext(this.options.defaultContextUri);\r\n          }\r\n        }\r\n      );\r\n  }\r\n\r\n  setContext(context: DetailedContext) {\r\n    this.handleContextMessage(context);\r\n    const currentContext = this.context$.value;\r\n    if (currentContext && context && context.id === currentContext.id) {\r\n      if (context.map.view.keepCurrentView === undefined) {\r\n        context.map.view.keepCurrentView = true;\r\n      }\r\n      this.context$.next(context);\r\n      return;\r\n    }\r\n\r\n    if (!context.map) {\r\n      context.map = { view: {} };\r\n    }\r\n\r\n    Object.assign(context.map.view, this.mapViewFromRoute);\r\n\r\n    this.context$.next(context);\r\n  }\r\n\r\n  loadEditedContext(uri: string) {\r\n    this.getContextByUri(uri).subscribe((_context: DetailedContext) => {\r\n      this.setEditedContext(_context);\r\n    });\r\n  }\r\n\r\n  setEditedContext(context: DetailedContext) {\r\n    this.editedContext$.next(context);\r\n  }\r\n\r\n  getContextFromMap(igoMap: IgoMap, empty?: boolean): DetailedContext {\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: uuid(),\r\n      title: '',\r\n      scope: 'private',\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj,\r\n          maxZoomOnExtent: igoMap.viewController.maxZoomOnExtent\r\n        }\r\n      },\r\n      layers: [],\r\n      tools: []\r\n    };\r\n\r\n    let layers = [];\r\n    if (empty === true) {\r\n      layers = igoMap.layers$\r\n        .getValue()\r\n        .filter(\r\n          (lay) =>\r\n            lay.baseLayer === true ||\r\n            lay.options.id === 'searchPointerSummaryId'\r\n        )\r\n        .sort((a, b) => a.zIndex - b.zIndex);\r\n    } else {\r\n      layers = igoMap.layers$.getValue().filter(lay => !lay.id.includes('WfsWorkspaceTableDest')).sort((a, b) => a.zIndex - b.zIndex);\r\n    }\r\n\r\n    let i = 0;\r\n    for (const l of layers) {\r\n      const layer: any = l;\r\n      const opts = {\r\n        id: layer.options.id ? String(layer.options.id) : undefined,\r\n        layerOptions: {\r\n          title: layer.options.title,\r\n          zIndex: ++i,\r\n          visible: layer.visible,\r\n          security: layer.security\r\n        } as LayerOptions,\r\n        sourceOptions: {\r\n          type: layer.dataSource.options.type,\r\n          params: layer.dataSource.options.params,\r\n          url: layer.dataSource.options.url,\r\n          queryable: layer.queryable\r\n        }\r\n      };\r\n      if (opts.sourceOptions.type) {\r\n        context.layers.push(opts);\r\n      }\r\n    }\r\n\r\n    context.tools = this.tools.map((tool) => {\r\n      return { id: String(tool.id), global: tool.global };\r\n    });\r\n\r\n    return context;\r\n  }\r\n\r\n  getContextFromLayers(\r\n    igoMap: IgoMap,\r\n    layers: Layer[],\r\n    name: string\r\n  ): DetailedContext {\r\n    const currentContext = this.context$.getValue();\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: name,\r\n      title: name,\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj\r\n        }\r\n      },\r\n      layers: [],\r\n      toolbar: [],\r\n      tools: [],\r\n      extraFeatures: []\r\n    };\r\n\r\n    const currentLayers = igoMap.layers$.getValue();\r\n    context.layers = currentLayers\r\n      .filter((l) => l.baseLayer)\r\n      .map((l) => {\r\n        return {\r\n          baseLayer: true,\r\n          sourceOptions: l.options.sourceOptions,\r\n          title: l.options.title,\r\n          visible: l.visible\r\n        };\r\n      });\r\n\r\n    layers.forEach((layer) => {\r\n      // Do not seem to work properly. layerFound is always undefined.\r\n      const layerFound = currentContext.layers.find(\r\n        (contextLayer) => {\r\n          const source = contextLayer.source;\r\n          return source && layer.id === source.id && !contextLayer.baseLayer;\r\n        });\r\n      if (layerFound) {\r\n        let layerStyle = layerFound[`style`];\r\n        if (layerFound[`igoStyle`][`styleByAttribute`]) {\r\n          layerStyle = undefined;\r\n        } else if (layerFound[`igoStyle`][`clusterBaseStyle`]) {\r\n          layerStyle = undefined;\r\n          delete layerFound.sourceOptions[`source`];\r\n          delete layerFound.sourceOptions[`format`];\r\n        }\r\n        const opts = {\r\n          baseLayer: layerFound.baseLayer,\r\n          title: layer.options.title,\r\n          zIndex: layer.zIndex,\r\n          igoStyle: {\r\n            styleByAttribute: layerFound[`igoStyle`][`styleByAttribute`],\r\n            clusterBaseStyle: layerFound[`igoStyle`][`clusterBaseStyle`],\r\n          },\r\n          style: layerStyle,\r\n          clusterParam: layerFound[`clusterParam`],\r\n          visible: layer.visible,\r\n          opacity: layer.opacity,\r\n          sourceOptions: layerFound.sourceOptions\r\n        };\r\n        context.layers.push(opts);\r\n      } else {\r\n        if (!(layer.ol.getSource() instanceof olVectorSource)) {\r\n          const catalogLayer = layer.options;\r\n          catalogLayer.zIndex = layer.zIndex;\r\n          delete catalogLayer.source;\r\n          context.layers.push(catalogLayer);\r\n        } else {\r\n          let features;\r\n          const writer = new GeoJSON();\r\n          if (layer.ol.getSource() instanceof Cluster) {\r\n            const clusterSource = layer.ol.getSource() as Cluster;\r\n            let olFeatures = clusterSource.getFeatures();\r\n            olFeatures = (olFeatures as any).flatMap((cluster: any) => cluster.get('features'));\r\n            const cleanedOlFeatures = this.exportService.generateFeature(olFeatures, 'GeoJSON', '_featureStore');\r\n            features = writer.writeFeatures(\r\n              cleanedOlFeatures,\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          } else {\r\n            const source = layer.ol.getSource() as olVectorSource;\r\n            const olFeatures = source.getFeatures();\r\n            const cleanedOlFeatures = this.exportService.generateFeature(olFeatures, 'GeoJSON', '_featureStore');\r\n            features = writer.writeFeatures(\r\n              cleanedOlFeatures,\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          }\r\n          features = JSON.parse(features);\r\n          features.name = layer.options.title;\r\n          context.extraFeatures.push(features);\r\n        }\r\n      }\r\n    });\r\n\r\n    context.toolbar = this.toolbar;\r\n    context.tools = this.tools;\r\n\r\n    return context;\r\n  }\r\n\r\n  setTools(tools: Tool[]) {\r\n    this.tools = tools;\r\n  }\r\n\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar = toolbar;\r\n  }\r\n\r\n  private handleContextMessage(context: DetailedContext) {\r\n    if (this.context$.value && context.uri && this.context$.value.uri !== context.uri) {\r\n      this.messageService.removeAllAreNotError();\r\n    }\r\n\r\n    context.messages = context.messages ? context.messages : [];\r\n    context.messages.push(context.message);\r\n    context.messages.map(message => {\r\n      if (message) {\r\n        this.messageService.message(message as Message);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getContextByUri(uri: string): Observable<DetailedContext> {\r\n    if (this.baseUrl) {\r\n      let contextToLoad;\r\n      for (const key of Object.keys(this.contexts$.value)) {\r\n        contextToLoad = this.contexts$.value[key].find((c) => {\r\n          return c.uri === uri;\r\n        });\r\n        if (contextToLoad) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (contextToLoad && contextToLoad.imported) {\r\n        return of(contextToLoad);\r\n      }\r\n\r\n      // TODO : use always id or uri\r\n      const id = contextToLoad ? contextToLoad.id : uri;\r\n      return this.getDetails(id);\r\n    }\r\n\r\n    const importedContext = this.contexts$.value.ours.find((currentContext) => {\r\n      return currentContext.uri === uri && currentContext.imported === true;\r\n    });\r\n\r\n    if (importedContext) {\r\n      return of(importedContext);\r\n    } else {\r\n      return this.getLocalContext(uri);\r\n    }\r\n  }\r\n\r\n  getContextLayers(igoMap: IgoMap) {\r\n    const layers: Layer[] = [];\r\n    const mapLayers = igoMap.layers$.getValue();\r\n    mapLayers.forEach((layer) => {\r\n      if (!layer.baseLayer && layer.options.id !== 'searchPointerSummaryId') {\r\n        layers.push(layer);\r\n      }\r\n    });\r\n    return layers;\r\n  }\r\n\r\n  private readParamsFromRoute() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n\r\n    this.route.queryParams.subscribe((params) => {\r\n      const centerKey = this.route.options.centerKey;\r\n      if (centerKey && params[centerKey as string]) {\r\n        const centerParams = params[centerKey as string];\r\n        this.mapViewFromRoute.center = centerParams.split(',').map(Number);\r\n      }\r\n\r\n      const projectionKey = this.route.options.projectionKey;\r\n      if (projectionKey && params[projectionKey as string]) {\r\n        const projectionParam = params[projectionKey as string];\r\n        this.mapViewFromRoute.projection = projectionParam;\r\n      }\r\n\r\n      const zoomKey = this.route.options.zoomKey;\r\n      if (zoomKey && params[zoomKey as string]) {\r\n        const zoomParam = params[zoomKey as string];\r\n        this.mapViewFromRoute.zoom = Number(zoomParam);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getPath(file: string) {\r\n    const basePath = this.options.basePath.replace(/\\/$/, '');\r\n\r\n    return `${basePath}/${file}`;\r\n  }\r\n\r\n  private handleError(\r\n    error: HttpErrorResponse,\r\n    uri: string,\r\n    permissionError?: boolean\r\n  ) {\r\n    const context = this.contexts$.value.ours.find((obj) => obj.uri === uri);\r\n    const titleContext = context ? context.title : uri;\r\n    error.error.title = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.title'\r\n    );\r\n\r\n    error.error.message = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.text',\r\n      { value: titleContext }\r\n    );\r\n\r\n    error.error.toDisplay = true;\r\n\r\n    if (permissionError) {\r\n      error.error.title = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermissionTitle'\r\n      );\r\n      error.error.message = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermission'\r\n      );\r\n    }\r\n    this.messageService.error(\r\n      'igo.context.contextManager.errors.addPermission',\r\n      'igo.context.contextManager.errors.addPermissionTitle');\r\n  }\r\n\r\n  private handleContextsChange(\r\n    keepCurrentContext = true\r\n  ) {\r\n    const context = this.context$.value;\r\n    const editedContext = this.editedContext$.value;\r\n    if (!context || context.uri === this.options.defaultContextUri) {\r\n      keepCurrentContext = false;\r\n    }\r\n    if (!keepCurrentContext || !this.findContext(context)) {\r\n      this.defaultContextUri = undefined;\r\n      this.loadDefaultContext();\r\n    } else {\r\n      this.getContextByUri(context.uri)\r\n        .pipe(first())\r\n        .subscribe(\r\n          (newContext: DetailedContext) => {\r\n            this.toolsChanged$.next(newContext);\r\n          }\r\n        );\r\n\r\n      if (this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe();\r\n      }\r\n    }\r\n    const editedFound = this.findContext(editedContext);\r\n    if (!editedFound || editedFound.permission !== 'write') {\r\n      this.setEditedContext(undefined);\r\n    }\r\n  }\r\n\r\n  private addContextToList(context: Context) {\r\n    const contextFound = this.findContext(context);\r\n    if (!contextFound) {\r\n      const contextSimplifie = {\r\n        id: context.id,\r\n        uri: context.uri,\r\n        title: context.title,\r\n        scope: context.scope,\r\n        permission: TypePermission[TypePermission.read]\r\n      };\r\n\r\n      if (this.contexts$.value && this.contexts$.value.public) {\r\n        this.contexts$.value.public.push(contextSimplifie);\r\n        this.contexts$.next(this.contexts$.value);\r\n      }\r\n    }\r\n  }\r\n\r\n  private findContext(context: Context) {\r\n    if (!context) {\r\n      return false;\r\n    }\r\n\r\n    const contexts = this.contexts$.value;\r\n    let found;\r\n    for (const key of Object.keys(contexts)) {\r\n      const value = contexts[key];\r\n      found = value.find(\r\n        (c) =>\r\n          (context.id && c.id === context.id) ||\r\n          (context.uri && c.uri === context.uri)\r\n      );\r\n      if (found) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    return found;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { ContextImportExportComponent } from './context-import-export/context-import-export.component';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    MatTooltipModule,\r\n  ],\r\n  exports: [\r\n    ContextImportExportComponent\r\n  ],\r\n  declarations: [\r\n    ContextImportExportComponent\r\n  ]\r\n})\r\nexport class IgoContextImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextImportExportModule> {\r\n    return {\r\n      ngModule: IgoContextImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { MapViewOptions, MapBrowserComponent, MapControlsOptions, MapScaleLineOptions } from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext, ContextMapView } from './context.interface';\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Directive({\r\n  selector: '[igoMapContext]'\r\n})\r\nexport class MapContextDirective implements OnInit, OnDestroy {\r\n  private component: MapBrowserComponent;\r\n  private context$$: Subscription;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter(context => context !== undefined))\r\n      .subscribe(context => this.handleContextChange(context));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    // This creates a new ol.Map when the context changes. Doing that\r\n    // allows the print tool to work properly even when the map's canvas\r\n    // has been tainted (CORS) with the layers of another context. This could\r\n    // have some side effects such as unbinding all listeners on the first map.\r\n    // A better solution would be to create a new map (preview) before\r\n    // printing and avoid the tainted canvas issue. This will come later so\r\n    // this snippet of code is kept here in case it takes too long becomes\r\n    // an issue\r\n\r\n    // const target = this.component.map.ol.getTarget();\r\n    // this.component.map.ol.setTarget(undefined);\r\n    // this.component.map.init();\r\n    // this.component.map.ol.setTarget(target);\r\n\r\n    const viewContext: ContextMapView = context.map.view;\r\n    if (!this.component.view || viewContext.keepCurrentView !== true || context.map.view.projection !== this.map.projection) {\r\n      this.component.view = viewContext as MapViewOptions;\r\n    }\r\n    if (this.component.map.geolocationController) {\r\n      this.component.map.geolocationController.updateGeolocationOptions(viewContext);\r\n    }\r\n\r\n    const controlsContext: MapControlsOptions = context.map.controls;\r\n    if (!this.component.controls && controlsContext) {\r\n      if (this.mediaService.isMobile()) {\r\n        if (typeof(controlsContext.scaleLine) !== 'boolean') {\r\n          const scaleLineOption = controlsContext.scaleLine as MapScaleLineOptions;\r\n          if (!scaleLineOption.minWidth) {\r\n            scaleLineOption.minWidth = Math.min(64, scaleLineOption.minWidth);\r\n            controlsContext.scaleLine = scaleLineOption;\r\n          }\r\n        }\r\n      }\r\n      this.component.controls = controlsContext;\r\n    }\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy, Optional, Input } from '@angular/core';\r\n\r\nimport { Subscription, merge } from 'rxjs';\r\nimport { buffer, debounceTime, filter } from 'rxjs/operators';\r\n\r\nimport { RouteService, ConfigService } from '@igo2/core';\r\nimport {\r\n  MapBrowserComponent,\r\n  Layer,\r\n  LayerService,\r\n  LayerOptions,\r\n  StyleListService,\r\n  StyleService\r\n} from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext } from './context.interface';\r\nimport {\r\n  addImportedFeaturesToMap,\r\n  addImportedFeaturesStyledToMap\r\n} from '../../context-import-export/shared/context-import.utils';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\n\r\n@Directive({\r\n  selector: '[igoLayerContext]'\r\n})\r\nexport class LayerContextDirective implements OnInit, OnDestroy {\r\n  private context$$: Subscription;\r\n  private queryParams: any;\r\n\r\n  private contextLayers: Layer[] = [];\r\n\r\n  @Input() removeLayersOnContextChange: boolean = true;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    private component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private layerService: LayerService,\r\n    private configService: ConfigService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter((context) => context !== undefined))\r\n      .subscribe((context) => this.handleContextChange(context));\r\n\r\n    if (\r\n      this.route &&\r\n      this.route.options.visibleOnLayersKey &&\r\n      this.route.options.visibleOffLayersKey &&\r\n      this.route.options.contextKey\r\n    ) {\r\n      const queryParams$$ = this.route.queryParams.subscribe((params) => {\r\n        if (Object.keys(params).length > 0) {\r\n          this.queryParams = params;\r\n          queryParams$$.unsubscribe();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.layers === undefined) {\r\n      return;\r\n    }\r\n    if (this.removeLayersOnContextChange === true) {\r\n      this.map.removeAllLayers();\r\n    } else {\r\n      this.map.removeLayers(this.contextLayers);\r\n    }\r\n    this.contextLayers = [];\r\n\r\n    const layersAndIndex$ = merge(\r\n      ...context.layers.map((layerOptions: LayerOptions, index: number) => {\r\n        return this.layerService.createAsyncLayer(layerOptions, context.uri);\r\n      })\r\n    );\r\n\r\n    layersAndIndex$\r\n      .pipe(buffer(layersAndIndex$.pipe(debounceTime(500))))\r\n      .subscribe((layers: Layer[]) => {\r\n        this.handleAddLayers(layers);\r\n\r\n        if (context.extraFeatures) {\r\n          context.extraFeatures.forEach((featureCollection) => {\r\n            const format = new GeoJSON();\r\n            const title = featureCollection.name;\r\n            featureCollection = JSON.stringify(featureCollection);\r\n            featureCollection = format.readFeatures(featureCollection, {\r\n              dataProjection: 'EPSG:4326',\r\n              featureProjection: 'EPSG:3857'\r\n            });\r\n            const importExportOptions = this.configService.getConfig('importExport');\r\n            const importWithStyle =importExportOptions?.importWithStyle || this.configService.getConfig('importWithStyle');\r\n            if (this.configService.getConfig('importWithStyle')) {\r\n              console.warn(`\r\n              The location of this config importWithStyle is deprecated.\r\n              Please move this property within importExport configuration.\r\n              Ex: importWithStyle: true/false must be transfered to importExport: { importWithStyle: true/false }\r\n              Refer to environnement.ts OR config/config.json\r\n              This legacy conversion will be deleted in 2024.\r\n              `);\r\n            }\r\n            if (!importWithStyle) {\r\n              addImportedFeaturesToMap(featureCollection, this.map, title);\r\n            } else {\r\n              addImportedFeaturesStyledToMap(\r\n                featureCollection,\r\n                this.map,\r\n                title,\r\n                this.styleListService,\r\n                this.styleService\r\n              );\r\n            }\r\n          });\r\n        }\r\n      });\r\n\r\n      this.layerService.createAsyncIdbLayers(context.uri).pipe(debounceTime(500))\r\n      .subscribe((layers: Layer[]) => this.handleAddLayers(layers));\r\n\r\n  }\r\n\r\n  private handleAddLayers(layers: Layer[]) {\r\n    layers = layers\r\n      .filter((layer: Layer) => layer !== undefined)\r\n      .map((layer) => {\r\n        layer.visible = this.computeLayerVisibilityFromUrl(layer);\r\n        layer.zIndex = layer.zIndex;\r\n\r\n        return layer;\r\n      });\r\n    this.contextLayers.concat(layers);\r\n    this.map.addLayers(layers);\r\n  }\r\n\r\n  private computeLayerVisibilityFromUrl(layer: Layer): boolean {\r\n    const params = this.queryParams;\r\n    const currentContext = this.contextService.context$.value.uri;\r\n    const currentLayerid: string = layer.id;\r\n\r\n    let visible = layer.visible;\r\n    if (!params || !currentLayerid) {\r\n      return visible;\r\n    }\r\n\r\n    const contextParams = params[this.route.options.contextKey as string];\r\n    if (contextParams === currentContext || !contextParams) {\r\n      let visibleOnLayersParams = '';\r\n      let visibleOffLayersParams = '';\r\n      let visiblelayers: string[] = [];\r\n      let invisiblelayers: string[] = [];\r\n\r\n      if (\r\n        this.route.options.visibleOnLayersKey &&\r\n        params[this.route.options.visibleOnLayersKey as string]\r\n      ) {\r\n        visibleOnLayersParams =\r\n          params[this.route.options.visibleOnLayersKey as string];\r\n      }\r\n      if (\r\n        this.route.options.visibleOffLayersKey &&\r\n        params[this.route.options.visibleOffLayersKey as string]\r\n      ) {\r\n        visibleOffLayersParams =\r\n          params[this.route.options.visibleOffLayersKey as string];\r\n      }\r\n\r\n      /* This order is important because to control whichever\r\n       the order of * param. First whe open and close everything.*/\r\n      if (visibleOnLayersParams === '*') {\r\n        visible = true;\r\n      }\r\n      if (visibleOffLayersParams === '*') {\r\n        visible = false;\r\n      }\r\n\r\n      // After, managing named layer by id (context.json OR id from datasource)\r\n      visiblelayers = visibleOnLayersParams.split(',');\r\n      invisiblelayers = visibleOffLayersParams.split(',');\r\n      if (visiblelayers.indexOf(currentLayerid) > -1 || visiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = true;\r\n      }\r\n      if (invisiblelayers.indexOf(currentLayerid) > -1 || invisiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = false;\r\n      }\r\n    }\r\n\r\n    return visible;\r\n  }\r\n}\r\n","import type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  IgoMap,\r\n  VectorLayer,\r\n  QueryableDataSourceOptions,\r\n  StyleService,\r\n  StyleListService,\r\n  StyleByAttribute,\r\n  ClusterParam,\r\n  ClusterDataSourceOptions,\r\n  ClusterDataSource,\r\n  featureRandomStyle,\r\n  featureRandomStyleFunction\r\n} from '@igo2/geo';\r\nimport { MessageService } from '@igo2/core';\r\nimport { DetailedContext } from '../../context-manager/shared/context.interface';\r\nimport { ContextService } from '../../context-manager/shared/context.service';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  context: DetailedContext,\r\n  messageService: MessageService,\r\n  contextService: ContextService\r\n) {\r\n  if (Object.keys(context).length <= 0) {\r\n    handleNothingToImportError(file, messageService);\r\n    return;\r\n  }\r\n\r\n  const contextTitle = computeLayerTitleFromFile(file);\r\n\r\n  addContextToContextList(context, contextTitle, contextService);\r\n\r\n  messageService.success(\r\n    'igo.context.contextImportExport.import.success.text',\r\n    'igo.context.contextImportExport.import.success.title', undefined, {\r\n      value: contextTitle\r\n    });\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n) {\r\n  messageService.error(\r\n    'igo.context.contextImportExport.import.invalid.text',\r\n    'igo.context.contextImportExport.import.invalid.title',\r\n    undefined,\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    }\r\n  );\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  sizeMb: number\r\n) {\r\n  messageService.error(\r\n    'igo.context.contextImportExport.import.tooLarge.text',\r\n    'igo.context.contextImportExport.import.tooLarge.title',\r\n    undefined,\r\n    {\r\n      value: file.name,\r\n      size: sizeMb\r\n    });\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService\r\n) {\r\n  messageService.error(\r\n    'igo.context.contextImportExport.import.unreadable.text',\r\n    'igo.context.contextImportExport.import.unreadable.title',\r\n    undefined,\r\n    {\r\n      value: file.name\r\n    });\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService\r\n) {\r\n  messageService.error(\r\n    'igo.context.contextImportExport.import.empty.text',\r\n    'igo.context.contextImportExport.import.empty.title',\r\n    undefined,\r\n    { value: file.name });\r\n}\r\n\r\nexport function addContextToContextList(\r\n  context: DetailedContext,\r\n  contextTitle: string,\r\n  contextService: ContextService\r\n) {\r\n  context.title = contextTitle;\r\n  context.imported = true;\r\n  contextService.contexts$.value.ours.unshift(context);\r\n  contextService.contexts$.next(contextService.contexts$.value);\r\n  contextService.importedContext.unshift(context);\r\n  contextService.loadContext(context.uri);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name.split('.').pop().toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n\r\nexport function addImportedFeaturesToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  let randomStyle;\r\n  let editable: boolean = false;\r\n  if (\r\n    olFeatures[0].getKeys().includes('_style') ||\r\n    olFeatures[0].getKeys().includes('_mapTitle')) {\r\n    randomStyle = featureRandomStyleFunction();\r\n  } else {\r\n    randomStyle = featureRandomStyle();\r\n    editable = true;\r\n  }\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    igoStyle: { editable },\r\n    style: randomStyle\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addImportedFeaturesStyledToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService\r\n): VectorLayer {\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute, resolution);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style'), feature, resolution\r\n    );\r\n  } else {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList('default.style'), feature, resolution\r\n    );\r\n  }\r\n  let source;\r\n\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n","export enum ContextListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-bookmark-dialog',\r\n  templateUrl: './bookmark-dialog.component.html'\r\n})\r\nexport class BookmarkDialogComponent {\r\n  public title: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<BookmarkDialogComponent>) {}\r\n}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{ 'igo.context.bookmarkButton.dialog.title' | translate }}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <mat-form-field>\r\n    <input matInput required autocomplete=\"off\"\r\n      maxlength=\"128\"\r\n      [placeholder]=\"'igo.context.bookmarkButton.dialog.placeholder' | translate\"\r\n      [(ngModel)]=\"title\">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\"\r\n         [disabled]=\"!title\"\r\n         (click)=\"dialogRef.close(title)\">\r\n    {{'igo.common.confirmDialog.confirmBtn' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)=\"dialogRef.close(false)\">\r\n    {{'igo.common.confirmDialog.cancelBtn' | translate}}\r\n  </button>\r\n</div>\r\n","<mat-list-item\r\n  class=\"mat-list-item\"\r\n  [ngClass]=\"{'mat-list-item-light': hidden}\">\r\n  <button mat-list-avatar\r\n    *ngIf=\"auth.authenticated\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"auth.authenticated ? ('igo.context.contextManager.favorite' | translate) : ''\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon *ngIf=\"!context.iconImage\" svgIcon=\"{{context.icon ? context.icon : context.scope === 'public' ? 'earth' : 'star'}}\"></mat-icon>\r\n    <img *ngIf=\"context.iconImage\" [src]=\"context.iconImage\">\r\n  </button>\r\n  <button mat-list-avatar\r\n    *ngIf=\"!auth.authenticated && showFavorite\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"'igo.context.contextManager.favorite' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon svgIcon=\"star\"></mat-icon>\r\n  </button>\r\n  <h4 matLine>{{context.title}}</h4>\r\n\r\n  <div *ngIf=\"auth.authenticated\"\r\n       igoStopPropagation\r\n       class=\"igo-actions-container\">\r\n\r\n     <button *ngIf=\"collapsed && selected && (context.permission === typePermission[typePermission.write] || context.imported)\"\r\n       class=\"save-button\"\r\n       mat-icon-button\r\n       [matTooltip]=\"'igo.context.contextManager.save' | translate\"\r\n       matTooltipShowDelay=\"500\"\r\n       [color]=\"color\"\r\n       (click)=\"save.emit(context)\">\r\n       <mat-icon svgIcon=\"content-save\"></mat-icon>\r\n     </button>\r\n\r\n    <div #actions class=\"igo-actions-expand-container\">\r\n\r\n      <button *ngIf=\"canShare && !context.imported\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.managePermissions' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"managePermissions.emit(context)\">\r\n        <mat-icon svgIcon=\"account-arrow-right\"></mat-icon>\r\n      </button>\r\n\r\n      <!--button\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.manageTools' | translate\"\r\n        [color]=\"color\"\r\n        (click)=\"manageTools.emit(context)\">\r\n        <mat-icon svgIcon=\"widgets\"></mat-icon>\r\n      </button-->\r\n\r\n      <button *ngIf=\"!context.imported\"\r\n        class=\"clone-button\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.clone' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"clone.emit(context)\">\r\n        <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] && !context.imported\"\r\n        class=\"edit-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.edit' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"edit.emit(context)\">\r\n        <mat-icon svgIcon=\"pencil\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"!context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.hide' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"hide.emit(context)\">\r\n        <mat-icon svgIcon=\"eye\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.show' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"show.emit(context)\">\r\n        <mat-icon svgIcon=\"eye-off\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] || context.imported\"\r\n        class=\"delete-button\"\r\n        mat-icon-button\r\n        color=\"warn\"\r\n        [matTooltip]=\"'igo.context.contextManager.delete' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"delete.emit(context)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <button\r\n      class=\"actions-button\"\r\n      mat-icon-button\r\n      igoCollapse\r\n      [color]=\"color\"\r\n      [target]=\"actions\"\r\n      [collapsed]=collapsed\r\n      (click)=\"collapsed = !collapsed\">\r\n      <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { TypePermission } from '../shared/context.enum';\r\nimport { DetailedContext } from '../shared/context.interface';\r\n\r\n@Component({\r\n  selector: 'igo-context-item',\r\n  templateUrl: './context-item.component.html',\r\n  styleUrls: ['./context-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextItemComponent {\r\n  public typePermission = TypePermission;\r\n  public color = 'primary';\r\n  public collapsed = true;\r\n\r\n  @Input() showFavorite: boolean = true;\r\n  @Input() context: DetailedContext;\r\n  @Input() default: boolean;\r\n  @Input() selected: boolean;\r\n\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n\r\n  get hidden(): boolean {\r\n    return this.context.hidden;\r\n  }\r\n\r\n  get canShare(): boolean {\r\n    return this.storageService.get('canShare') === true;\r\n  }\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  favoriteClick(context: DetailedContext) {\r\n    this.favorite.emit(context);\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <mat-form-field *ngIf=\"showFilter()\" [ngClass]=\"auth.authenticated && configService.getConfig('context') ? 'context-filter-min-width' : 'context-filter-max-width'\">\r\n    <input\r\n      matInput\r\n      type=\"text\"\r\n      [placeholder]=\"'igo.context.contextManager.filterPlaceHolder' | translate\"\r\n      [(ngModel)]=\"term\">\r\n    <button\r\n      mat-button\r\n      mat-icon-button\r\n      matSuffix\r\n      class=\"clear-button\"\r\n      *ngIf=\"term.length\"\r\n      aria-label=\"Clear\"\r\n      color=\"warn\"\r\n      (click)=\"clearFilter()\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <button\r\n  *ngIf=\"!sortedAlpha\"\r\n  class=\"sort-alpha\"\r\n  mat-icon-button\r\n  [matTooltip]=\"'igo.context.contextManager.sortAlphabetically' | translate\"\r\n  matTooltipShowDelay=\"500\"\r\n  (click)=\"toggleSort(true)\">\r\n  <mat-icon color=\"primary\" svgIcon=\"sort-alphabetical-variant\"></mat-icon>\r\n  </button>\r\n  <button\r\n    *ngIf=\"sortedAlpha\"\r\n    class=\"sort-alpha\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.sortContextOrder' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    (click)=\"toggleSort(false)\">\r\n    <mat-icon color=\"warn\" svgIcon=\"sort-variant-remove\"></mat-icon>\r\n  </button>\r\n\r\n  <igo-actionbar *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"add-context-button\"\r\n    [iconColor]=\"color\"\r\n    [store]=\"actionStore\"\r\n    [withIcon]=\"true\"\r\n    icon=\"plus\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"false\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n  <button *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"users-filter\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.filterUser' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matMenuTriggerFor]=\"accountMenu\">\r\n    <mat-icon color=\"primary\" svgIcon=\"filter-menu\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu #accountMenu=\"matMenu\">\r\n    <ng-container *ngFor=\"let user of users\">\r\n      <span class=\"profilsMenu\">\r\n        <mat-checkbox\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(user).checked\"\r\n          [indeterminate]=\"getPermission(user).indeterminate\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(user)\">\r\n        </mat-checkbox>\r\n        <button *ngIf=\"user.childs\"\r\n          [matMenuTriggerFor]=\"subAccountMenu\"\r\n          mat-menu-item>\r\n          {{user.title}}\r\n        </button>\r\n        <button\r\n          mat-menu-item\r\n          *ngIf=\"!user.childs\">\r\n          {{user.title}}\r\n        </button>\r\n      </span>\r\n\r\n      <mat-menu #subAccountMenu=\"matMenu\">\r\n        <mat-checkbox *ngFor=\"let child of user.childs\"\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(child).checked\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(child, user)\">\r\n          {{child.title}}\r\n        </mat-checkbox>\r\n      </mat-menu>\r\n    </ng-container>\r\n\r\n    <span class=\"profilsMenu\">\r\n      <mat-checkbox\r\n        class=\"mat-menu-item\"\r\n        [checked]=\"showHidden\"\r\n        (click)=\"$event.stopPropagation()\"\r\n        (change)=\"showHiddenContexts.emit()\">\r\n      </mat-checkbox>\r\n      <button mat-menu-item>\r\n        {{ 'igo.context.contextManager.showHidden' | translate }}\r\n      </button>\r\n    </span>\r\n  </mat-menu>\r\n\r\n  <ng-template ngFor let-groupContexts [ngForOf]=\"contexts$ | async | keyvalue\">\r\n\r\n    <igo-collapsible *ngIf=\"groupContexts.value.length && auth.authenticated\" [title]=\"titleMapping[groupContexts.key] | translate\"\r\n      [collapsed]=\"collapsed[titleMapping[groupContexts.key]]\" (toggle)=\"collapsed[titleMapping[groupContexts.key]] = $event\">\r\n\r\n      <ng-template ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n        <igo-context-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n          [context]=\"context\"\r\n          [default]=\"context.id && this.defaultContextId && this.defaultContextId === context.id\"\r\n          (edit)=\"edit.emit(context)\"\r\n          (delete)=\"delete.emit(context)\"\r\n          (clone)=\"clone.emit(context)\"\r\n          (save)=\"save.emit(context)\"\r\n          (hide)=\"hideContext(context)\"\r\n          (show)=\"showContext(context)\"\r\n          (favorite)=\"favorite.emit(context)\"\r\n          (manageTools)=\"manageTools.emit(context)\"\r\n          (managePermissions)=\"managePermissions.emit(context)\"\r\n          (select)=\"select.emit(context)\"\r\n          (unselect)=\"unselect.emit(context)\">\r\n        </igo-context-item>\r\n      </ng-template>\r\n\r\n    </igo-collapsible>\r\n\r\n    <ng-template *ngIf=\"groupContexts.value.length && !auth.authenticated\" ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n      <igo-context-item\r\n        igoListItem\r\n        color=\"accent\"\r\n        [showFavorite]=\"configService.getConfig('favoriteContext4NonAuthenticated')\"\r\n        [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n        [context]=\"context\"\r\n        [default]=\"configService.getConfig('context') ? defaultContextId === context.id : defaultContextId === context.uri\"\r\n        (favorite)=\"favorite.emit(context)\"\r\n        (select)=\"select.emit(context)\"\r\n        (unselect)=\"unselect.emit(context)\">\r\n      </igo-context-item>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport {\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission,\r\n  ContextProfils\r\n} from '../shared/context.interface';\r\nimport { ContextListControlsEnum } from './context-list.enum';\r\nimport {\r\n  Subscription,\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { BookmarkDialogComponent } from '../../context-map-button/bookmark-button/bookmark-dialog.component';\r\nimport { debounce } from 'rxjs/operators';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'igo-context-list',\r\n  templateUrl: './context-list.component.html',\r\n  styleUrls: ['./context-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextListComponent implements OnInit, OnDestroy {\r\n  private contextsInitial: ContextsList = { ours: [] };\r\n  contexts$: BehaviorSubject<ContextsList> = new BehaviorSubject(\r\n    this.contextsInitial\r\n  );\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  private change$$: Subscription;\r\n\r\n  @Input()\r\n  get contexts(): ContextsList {\r\n    return this._contexts;\r\n  }\r\n  set contexts(value: ContextsList) {\r\n    this._contexts = value;\r\n    this.cdRef.detectChanges();\r\n    this.next();\r\n  }\r\n  private _contexts: ContextsList = { ours: [] };\r\n\r\n  @Input()\r\n  get selectedContext(): DetailedContext {\r\n    return this._selectedContext;\r\n  }\r\n  set selectedContext(value: DetailedContext) {\r\n    this._selectedContext = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _selectedContext: DetailedContext;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get defaultContextId(): string {\r\n    return this.configService.getConfig('context') ? this._defaultContextId :\r\n      this.storageService.get('favorite.context.uri') as string || this._defaultContextId;\r\n  }\r\n  set defaultContextId(value: string) {\r\n    this._defaultContextId = value;\r\n  }\r\n  private _defaultContextId: string;\r\n\r\n  public collapsed: { contextScope }[] = [];\r\n\r\n  @Output() select = new EventEmitter<DetailedContext>();\r\n  @Output() unselect = new EventEmitter<DetailedContext>();\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() create = new EventEmitter<{ title: string; empty: boolean }>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() showHiddenContexts = new EventEmitter<boolean>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n  @Output() filterPermissionsChanged = new EventEmitter<\r\n    ContextUserPermission[]\r\n  >();\r\n\r\n  public titleMapping = {\r\n    ours: 'igo.context.contextManager.ourContexts',\r\n    shared: 'igo.context.contextManager.sharedContexts',\r\n    public: 'igo.context.contextManager.publicContexts'\r\n  };\r\n\r\n  public users: ContextProfils[];\r\n  public permissions: ContextUserPermission[] = [];\r\n\r\n  public actionStore = new ActionStore([]);\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public color = 'primary';\r\n\r\n  public showHidden = false;\r\n\r\n  /**\r\n   * Context filter term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.next();\r\n  }\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  public _term: string = '';\r\n\r\n  get sortedAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortedAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha: boolean = undefined;\r\n\r\n  public showContextFilter = ContextListControlsEnum.always;\r\n\r\n  public thresholdToFilter = 5;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    public configService: ConfigService,\r\n    public auth: AuthService,\r\n    private dialog: MatDialog,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.contexts.ours.length === 0 &&\r\n            this.contexts.public?.length === 0 &&\r\n            this.contexts.shared?.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.contexts$.next(this.filterContextsList(this.contexts));\r\n      });\r\n\r\n    this.actionStore.load([\r\n      {\r\n        id: 'emptyContext',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContext'\r\n        ),\r\n        icon: 'map-outline',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContextTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'contextFromMap',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMap'\r\n        ),\r\n        icon: 'map-check',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMapTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(false);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private filterContextsList(contexts: ContextsList) {\r\n    if (this.term === '') {\r\n      if (this.sortedAlpha) {\r\n        contexts = this.sortContextsList(contexts);\r\n      }\r\n      return contexts;\r\n    } else {\r\n      const ours = contexts.ours.filter((context) => {\r\n        const filterNormalized = this.term\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const contextTitleNormalized = context.title\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        return contextTitleNormalized.includes(filterNormalized);\r\n      });\r\n\r\n      let updateContexts: ContextsList = {\r\n        ours\r\n      };\r\n\r\n      if (this.contexts.public) {\r\n        const publics = contexts.public.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.public = publics;\r\n      }\r\n\r\n      if (this.contexts.shared) {\r\n        const shared = contexts.shared.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.shared = shared;\r\n      }\r\n\r\n      if (this.sortedAlpha) {\r\n        updateContexts = this.sortContextsList(updateContexts);\r\n      }\r\n      return updateContexts;\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n\r\n  public showFilter() {\r\n    switch (this.showContextFilter) {\r\n      case ContextListControlsEnum.always:\r\n        return true;\r\n      case ContextListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        let totalLength = this.contexts.ours.length;\r\n        this.contexts.public\r\n          ? (totalLength += this.contexts.public.length)\r\n          : (totalLength += 0);\r\n        this.contexts.shared\r\n          ? (totalLength += this.contexts.shared.length)\r\n          : (totalLength += 0);\r\n        if (totalLength >= this.thresholdToFilter) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  sortContextsList(contexts: ContextsList) {\r\n    if (contexts) {\r\n      const contextsList = JSON.parse(JSON.stringify(contexts));\r\n      contextsList.ours.sort((a, b) => {\r\n        if (this.normalize(a.title) < this.normalize(b.title)) {\r\n          return -1;\r\n        }\r\n        if (this.normalize(a.title) > this.normalize(b.title)) {\r\n          return 1;\r\n        }\r\n        return 0;\r\n      });\r\n\r\n      if (contextsList.shared) {\r\n        contextsList.shared.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      } else if (contextsList.public) {\r\n        contextsList.public.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      }\r\n      return contextsList;\r\n    }\r\n  }\r\n\r\n  normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  toggleSort(sortAlpha: boolean) {\r\n    this.sortedAlpha = sortAlpha;\r\n  }\r\n\r\n  clearFilter() {\r\n    this.term = '';\r\n  }\r\n\r\n  createContext(empty?: boolean) {\r\n    this.dialog\r\n      .open(BookmarkDialogComponent, { disableClose: false })\r\n      .afterClosed()\r\n      .pipe(take(1))\r\n      .subscribe((title: string) => {\r\n        if (title) {\r\n          this.create.emit({ title, empty });\r\n        }\r\n      });\r\n  }\r\n\r\n  getPermission(user?): ContextUserPermission {\r\n    if (user) {\r\n      const permission = this.permissions.find((p) => p.name === user.name);\r\n      return permission;\r\n    }\r\n  }\r\n\r\n  userSelection(user, parent?) {\r\n    const permission = this.getPermission(user);\r\n    if (permission) {\r\n      permission.checked = !permission.checked;\r\n      this.storageService.set(\r\n        'contexts.permissions.' + permission.name,\r\n        permission.checked\r\n      );\r\n      permission.indeterminate = false;\r\n    }\r\n\r\n    if (parent) {\r\n      let indeterminate = false;\r\n\r\n      for (const c of parent.childs) {\r\n        const cPermission = this.getPermission(c);\r\n        if (cPermission.checked !== permission.checked) {\r\n          indeterminate = true;\r\n          break;\r\n        }\r\n      }\r\n      const parentPermission = this.getPermission(parent);\r\n      if (parentPermission) {\r\n        parentPermission.checked = permission.checked;\r\n        this.storageService.set(\r\n          'contexts.permissions.' + parentPermission.name,\r\n          permission.checked\r\n        );\r\n        parentPermission.indeterminate = indeterminate;\r\n      }\r\n    }\r\n\r\n    if (user.childs) {\r\n      for (const c of user.childs) {\r\n        const childrenPermission = this.getPermission(c);\r\n        if (\r\n          childrenPermission &&\r\n          childrenPermission.checked !== permission.checked\r\n        ) {\r\n          childrenPermission.checked = permission.checked;\r\n          this.storageService.set(\r\n            'contexts.permissions.' + childrenPermission.name,\r\n            permission.checked\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    this.filterPermissionsChanged.emit(this.permissions);\r\n  }\r\n\r\n  hideContext(context: DetailedContext) {\r\n    context.hidden = true;\r\n    if (!this.showHidden) {\r\n      const contexts: ContextsList = { ours: [], shared: [], public: [] };\r\n      contexts.ours = this.contexts.ours.filter((c) => c.id !== context.id);\r\n      contexts.shared = this.contexts.shared.filter((c) => c.id !== context.id);\r\n      contexts.public = this.contexts.public.filter((c) => c.id !== context.id);\r\n      this.contexts = contexts;\r\n    }\r\n    this.hide.emit(context);\r\n  }\r\n\r\n  showContext(context: DetailedContext) {\r\n    context.hidden = false;\r\n    this.show.emit(context);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Self,\r\n  OnInit,\r\n  OnDestroy,\r\n  HostListener,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { MessageService, LanguageService, StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfirmDialogService } from '@igo2/common';\r\nimport { MapService } from '@igo2/geo';\r\n\r\nimport {\r\n  Context,\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission\r\n} from '../shared/context.interface';\r\nimport { ContextService } from '../shared/context.service';\r\nimport { ContextListComponent } from './context-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoContextListBinding]'\r\n})\r\nexport class ContextListBindingDirective implements OnInit, OnDestroy {\r\n  private component: ContextListComponent;\r\n  private contexts$$: Subscription;\r\n  private selectedContext$$: Subscription;\r\n  private defaultContextId$$: Subscription;\r\n  private previousMessageId;\r\n\r\n  @HostListener('select', ['$event'])\r\n  onSelect(context: Context) {\r\n    this.contextService.loadContext(context.uri);\r\n  }\r\n\r\n  @HostListener('edit', ['$event'])\r\n  onEdit(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('save', ['$event'])\r\n  onSave(context: Context) {\r\n    const map = this.mapService.getMap();\r\n    const contextFromMap = this.contextService.getContextFromMap(map);\r\n\r\n    const msgSuccess = () => {\r\n      this.messageService.success(\r\n        'igo.context.contextManager.dialog.saveMsg',\r\n        'igo.context.contextManager.dialog.saveTitle',\r\n        undefined,\r\n        {\r\n          value: context.title\r\n        });\r\n    };\r\n\r\n    if (context.imported) {\r\n      contextFromMap.title = context.title;\r\n      this.contextService.delete(context.id, true);\r\n      this.contextService.create(contextFromMap).subscribe((contextCreated) => {\r\n        this.contextService.loadContext(contextCreated.uri);\r\n        msgSuccess();\r\n      });\r\n      return;\r\n    }\r\n\r\n    const changes: any = {\r\n      layers: contextFromMap.layers,\r\n      map: {\r\n        view: contextFromMap.map.view\r\n      }\r\n    };\r\n\r\n    this.contextService.update(context.id, changes).subscribe(() => {\r\n      msgSuccess();\r\n    });\r\n  }\r\n\r\n  @HostListener('favorite', ['$event'])\r\n  onFavorite(context: Context) {\r\n    if (!context.id) {\r\n      context.id = context.uri;\r\n    }\r\n    this.contextService.setDefault(context.id).subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      this.contextService.defaultContextId$.next(context.id);\r\n      const messageObj = this.messageService.success(\r\n        'igo.context.contextManager.dialog.favoriteMsg',\r\n      'igo.context.contextManager.dialog.favoriteTitle',\r\n      undefined,\r\n      {\r\n        value: context.title\r\n      }\r\n      );\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.cdRef.detectChanges();\r\n    });\r\n  }\r\n\r\n  @HostListener('manageTools', ['$event'])\r\n  onManageTools(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('managePermissions', ['$event'])\r\n  onManagePermissions(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('delete', ['$event'])\r\n  onDelete(context: Context) {\r\n    const translate = this.languageService.translate;\r\n    this.confirmDialogService\r\n      .open(\r\n        translate.instant('igo.context.contextManager.dialog.confirmDelete')\r\n      )\r\n      .subscribe((confirm) => {\r\n        if (confirm) {\r\n          this.contextService\r\n            .delete(context.id, context.imported)\r\n            .subscribe(() => {\r\n              this.messageService.info(\r\n                'igo.context.contextManager.dialog.deleteMsg',\r\n                'igo.context.contextManager.dialog.deleteTitle',\r\n                undefined,\r\n                {value: context.title});\r\n            });\r\n        }\r\n      });\r\n  }\r\n\r\n  @HostListener('clone', ['$event'])\r\n  onClone(context: DetailedContext) {\r\n    const properties = {\r\n      title: context.title + '-copy',\r\n      uri: context.uri + '-copy'\r\n    };\r\n    this.contextService.clone(context.id, properties).subscribe(() => {\r\n      this.messageService.success(\r\n        'igo.context.contextManager.dialog.cloneMsg',\r\n        'igo.context.contextManager.dialog.cloneTitle',\r\n        undefined,\r\n        { value: context.title });\r\n    });\r\n  }\r\n\r\n  @HostListener('create', ['$event'])\r\n  onCreate(opts: { title: string; empty: boolean }) {\r\n    const { title, empty } = opts;\r\n    const context = this.contextService.getContextFromMap(\r\n      this.component.map,\r\n      empty\r\n    );\r\n    context.title = title;\r\n    this.contextService.create(context).subscribe(() => {\r\n      this.messageService.success(\r\n        'igo.context.bookmarkButton.dialog.createMsg',\r\n        'igo.context.bookmarkButton.dialog.createTitle',\r\n        undefined,\r\n        { value: context.title });\r\n      this.contextService.loadContext(context.uri);\r\n    });\r\n  }\r\n\r\n  @HostListener('filterPermissionsChanged')\r\n  loadContexts() {\r\n    const permissions = ['none'];\r\n    for (const p of this.component.permissions) {\r\n      if (p.checked === true || p.indeterminate === true) {\r\n        permissions.push(p.name);\r\n      }\r\n    }\r\n    this.component.showHidden\r\n      ? this.contextService.loadContexts(permissions, true)\r\n      : this.contextService.loadContexts(permissions, false);\r\n  }\r\n\r\n  @HostListener('showHiddenContexts')\r\n  showHiddenContexts() {\r\n    this.component.showHidden = !this.component.showHidden;\r\n    this.storageService.set('contexts.showHidden', this.component.showHidden);\r\n    this.loadContexts();\r\n  }\r\n\r\n  @HostListener('show', ['$event'])\r\n  onShowContext(context: DetailedContext) {\r\n    this.contextService.showContext(context.id).subscribe();\r\n  }\r\n\r\n  @HostListener('hide', ['$event'])\r\n  onHideContext(context: DetailedContext) {\r\n    this.contextService.hideContext(context.id).subscribe();\r\n  }\r\n\r\n  constructor(\r\n    @Self() component: ContextListComponent,\r\n    private contextService: ContextService,\r\n    private mapService: MapService,\r\n    private languageService: LanguageService,\r\n    private confirmDialogService: ConfirmDialogService,\r\n    private messageService: MessageService,\r\n    private auth: AuthService,\r\n    private storageService: StorageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input contexts\r\n    this.component.contexts = { ours: [] };\r\n    this.component.showHidden = this.storageService.get(\r\n      'contexts.showHidden'\r\n    ) as boolean;\r\n\r\n    this.contexts$$ = this.contextService.contexts$.subscribe((contexts) =>\r\n      this.handleContextsChange(contexts)\r\n    );\r\n\r\n    this.defaultContextId$$ = this.contextService.defaultContextId$.subscribe(\r\n      (id) => {\r\n        this.component.defaultContextId = id;\r\n      }\r\n    );\r\n    const storedContextUri = this.storageService.get('favorite.context.uri') as string;\r\n    if (storedContextUri && !this.auth.authenticated) {\r\n      this.contextService.defaultContextId$.next(storedContextUri);\r\n    }\r\n\r\n    // See feature-list.component for an explanation about the debounce time\r\n    this.selectedContext$$ = this.contextService.context$\r\n      .pipe(debounceTime(100))\r\n      .subscribe((context) => (this.component.selectedContext = context));\r\n\r\n    this.auth.authenticate$.subscribe((authenticate) => {\r\n      if (authenticate) {\r\n        this.contextService.getProfilByUser().subscribe((profils) => {\r\n          this.component.users = profils;\r\n          this.component.permissions = [];\r\n          const profilsAcc = this.component.users.reduce((acc, cur) => {\r\n            acc = acc.concat(cur);\r\n            acc = cur.childs ? acc.concat(cur.childs) : acc;\r\n            return acc;\r\n          }, []);\r\n\r\n          for (const user of profilsAcc) {\r\n            const permission: ContextUserPermission = {\r\n              name: user.name,\r\n              checked: this.storageService.get(\r\n                'contexts.permissions.' + user.name\r\n              ) as boolean\r\n            };\r\n            if (permission.checked === null) {\r\n              permission.checked = true;\r\n            }\r\n            this.component.permissions.push(permission);\r\n          }\r\n\r\n          const permissions = ['none'];\r\n          for (const p of this.component.permissions) {\r\n            if (p.checked === true || p.indeterminate === true) {\r\n              permissions.push(p.name);\r\n            }\r\n          }\r\n\r\n          this.component.showHidden\r\n            ? this.contextService.loadContexts(permissions, true)\r\n            : this.contextService.loadContexts(permissions, false);\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.contexts$$.unsubscribe();\r\n    this.selectedContext$$.unsubscribe();\r\n    this.defaultContextId$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextsChange(contexts: ContextsList) {\r\n    this.component.contexts = contexts;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, EMPTY } from 'rxjs';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { Poi } from './poi.interface';\r\n\r\n@Injectable()\r\nexport class PoiService {\r\n  private baseUrl: string;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.baseUrl = this.config.getConfig('context.url');\r\n  }\r\n\r\n  get(): Observable<Poi[]> {\r\n    if (!this.baseUrl) {\r\n      return EMPTY;\r\n    }\r\n\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.get<Poi[]>(url);\r\n  }\r\n\r\n  delete(id: string): Observable<void> {\r\n    const url = this.baseUrl + '/pois/' + id;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  create(context: Poi): Observable<Poi> {\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.post<Poi>(url, context);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule, IgoStopPropagationModule } from '@igo2/common';\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { BookmarkButtonComponent } from './bookmark-button/bookmark-button.component';\r\nimport { BookmarkDialogComponent } from './bookmark-button/bookmark-dialog.component';\r\nimport { PoiButtonComponent } from './poi-button/poi-button.component';\r\nimport { PoiDialogComponent } from './poi-button/poi-dialog.component';\r\nimport { PoiService } from './poi-button/shared/poi.service';\r\nimport { UserDialogComponent } from './user-button/user-dialog.component';\r\nimport { UserButtonComponent } from './user-button/user-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    IgoStopPropagationModule,\r\n    IgoAuthModule,\r\n    FormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatDialogModule,\r\n    MatInputModule\r\n  ],\r\n  exports: [BookmarkButtonComponent, PoiButtonComponent, UserButtonComponent, BookmarkDialogComponent],\r\n  declarations: [\r\n    BookmarkButtonComponent,\r\n    BookmarkDialogComponent,\r\n    PoiButtonComponent,\r\n    PoiDialogComponent,\r\n    UserButtonComponent,\r\n    UserDialogComponent\r\n  ],\r\n  providers: [PoiService]\r\n})\r\nexport class IgoContextMapButtonModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMapButtonModule> {\r\n    return {\r\n      ngModule: IgoContextMapButtonModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoCollapsibleModule,\r\n  IgoStopPropagationModule,\r\n  IgoActionbarModule\r\n} from '@igo2/common';\r\n\r\nimport { MapContextDirective } from './shared/map-context.directive';\r\nimport { LayerContextDirective } from './shared/layer-context.directive';\r\nimport { ContextListComponent } from './context-list/context-list.component';\r\nimport { ContextListBindingDirective } from './context-list/context-list-binding.directive';\r\nimport { ContextItemComponent } from './context-item/context-item.component';\r\nimport { ContextFormComponent } from './context-form/context-form.component';\r\nimport { ContextEditComponent } from './context-edit/context-edit.component';\r\nimport { ContextEditBindingDirective } from './context-edit/context-edit-binding.directive';\r\nimport { ContextPermissionsComponent } from './context-permissions/context-permissions.component';\r\nimport { ContextPermissionsBindingDirective } from './context-permissions/context-permissions-binding.directive';\r\nimport { IgoContextMapButtonModule } from '../context-map-button/context-map-button.module';\r\nimport { IgoContextImportExportModule } from '../context-import-export/context-import-export.module';\r\n\r\nconst CONTEXT_DIRECTIVES = [\r\n  MapContextDirective,\r\n  LayerContextDirective\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatCheckboxModule,\r\n    MatRadioModule,\r\n    MatDialogModule,\r\n    MatMenuModule,\r\n    MatOptionModule,\r\n    MatAutocompleteModule,\r\n    IgoAuthModule,\r\n    IgoListModule,\r\n    IgoKeyValueModule,\r\n    IgoCollapsibleModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoContextImportExportModule,\r\n    IgoContextMapButtonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ],\r\n  declarations: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ]\r\n})\r\nexport class IgoContextManagerModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextManagerModule> {\r\n    return {\r\n      ngModule: IgoContextManagerModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ExportOptions } from '@igo2/geo';\r\n\r\nexport enum ImportExportType {\r\n  layer = 'layer',\r\n  context = 'context'\r\n}\r\n\r\nexport enum ImportExportMode {\r\n  import = 'import',\r\n  export = 'export'\r\n}\r\n\r\n/**\r\n * Service that holds the state of the importExport module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportExportState {\r\n\r\n  readonly importExportType$: BehaviorSubject<ImportExportType> = new BehaviorSubject(ImportExportType.layer);\r\n  readonly selectedMode$: BehaviorSubject<ImportExportMode> = new BehaviorSubject(ImportExportMode.import);\r\n  readonly exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(undefined);\r\n\r\n  setImportExportType(type: ImportExportType) {\r\n    this.importExportType$.next(type);\r\n  }\r\n\r\n  setMode(mode: ImportExportMode) {\r\n    this.selectedMode$.next(mode);\r\n  }\r\n\r\n  setsExportOptions(exportOptions: ExportOptions) {\r\n      this.exportOptions$.next(exportOptions);\r\n    }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Toolbox, ToolService } from '@igo2/common';\r\n\r\nimport { ExportOptions } from '@igo2/geo';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ImportExportMode, ImportExportState } from '../import-export/import-export.state';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolState {\r\n  get toolbox(): Toolbox {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  public openSidenav$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private importExportState: ImportExportState\r\n    ) {}\r\n\r\n    toolToActivateFromOptions(toolToActivate: { tool: string; options: {[key: string]: any} }) {\r\n    if (!toolToActivate) { return; }\r\n    if (toolToActivate.tool === 'importExport') {\r\n      let exportOptions: ExportOptions = this.importExportState.exportOptions$.value;\r\n      if (!exportOptions) {\r\n        exportOptions = {\r\n          layers: toolToActivate.options.layers,\r\n          featureInMapExtent: toolToActivate.options.featureInMapExtent\r\n        };\r\n      } else {\r\n        exportOptions.layers = toolToActivate.options.layers;\r\n        exportOptions.featureInMapExtent = toolToActivate.options.featureInMapExtent;\r\n      }\r\n      this.importExportState.setsExportOptions(exportOptions);\r\n      this.importExportState.setMode(ImportExportMode.export);\r\n    }\r\n\r\n    if (this.toolbox.getTool(toolToActivate.tool)) {\r\n      this.toolbox.activateTool(toolToActivate.tool);\r\n      this.openSidenav$.next(true);\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\n\r\nimport { IgoMap, MapService, ProjectionService } from '@igo2/geo';\r\n// import { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * Service that holds the state of the map module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MapState {\r\n\r\n  // public mapCenter$ = new BehaviorSubject<boolean>(false);\r\n  get showAllLegendsValue(): boolean {\r\n    return this._legendToolShowAll;\r\n  }\r\n\r\n  set showAllLegendsValue(value) {\r\n    this._legendToolShowAll = value;\r\n  }\r\n  private _legendToolShowAll: boolean;\r\n\r\n  /**\r\n   * Active map\r\n   */\r\n  get map(): IgoMap { return this._map; }\r\n  private _map: IgoMap;\r\n\r\n  constructor(\r\n    private mapService: MapService,\r\n    private projectionService: ProjectionService, // Don't remove this or it'll never be injected,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this._map = new IgoMap({\r\n      controls: {\r\n        scaleLine: true,\r\n        attribution: {\r\n          collapsed: true\r\n        }\r\n      }\r\n    },\r\n    this.storageService,\r\n    this.configService);\r\n\r\n    this.mapService.setMap(this.map);\r\n  }\r\n}\r\n","import {\r\n    FeatureMotion,\r\n    FeatureStoreSelectionStrategy,\r\n    FeatureWorkspace,\r\n    WfsWorkspace,\r\n    EditionWorkspace\r\n} from '@igo2/geo';\r\n\r\n\r\nexport function handleZoomAuto(workspace: FeatureWorkspace | WfsWorkspace | EditionWorkspace, storageService) {\r\n    const zoomStrategy = workspace.entityStore\r\n        .getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    zoomStrategy.setMotion(storageService.get('zoomAuto') as boolean ? FeatureMotion.Default : FeatureMotion.None);\r\n}\r\n\r\n\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\n\r\n/**\r\n * Service that holds the state of storage service\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageState {\r\n  get storageService(): StorageService {\r\n    return this.igoStorageService;\r\n  }\r\n\r\n  constructor(private igoStorageService: StorageService) {}\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  FeatureWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private toolState: ToolState,\r\n    private mediaService: MediaService\r\n  ) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(\r\n        skipWhile(\r\n          (storageChange: StorageServiceEvent) =>\r\n            storageChange.key !== 'zoomAuto' || storageChange.event === StorageServiceEventEnum.CLEARED\r\n        )\r\n      )\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    return [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set(\r\n            'zoomAuto',\r\n            !this.storageService.get('zoomAuto') as boolean\r\n          );\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.tooltip',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), {\r\n            selected: false\r\n          });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: FeatureWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'featureDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterCustomFuncStrategy\r\n          );\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterSelectionStrategy\r\n          );\r\n          const layersWithSelection = filterSelectionStrategy.active\r\n            ? [ws.layer.id]\r\n            : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: {\r\n              layers: [ws.layer.id],\r\n              featureInMapExtent: filterStrategy.active,\r\n              layersWithSelection\r\n            } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  WfsWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  // rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange?.key !== 'zoomAuto' || storageChange?.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: WfsWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: WfsWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).options.ogcFilters?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  EditionWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange?.key !== 'zoomAuto' || storageChange?.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: EditionWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: EditionWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).options.ogcFilters?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  EntityRecord,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  Widget,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityState } from '@igo2/common';\r\nimport { WfsWorkspace, FeatureWorkspace, EditionWorkspace } from '@igo2/geo';\r\nimport { FeatureActionsService } from './shared/feature-actions.service';\r\nimport { WfsActionsService } from './shared/wfs-actions.service';\r\nimport { StorageService } from '@igo2/core';\r\nimport { EditionActionsService } from './shared/edition-actions.service';\r\n\r\n/**\r\n * Service that holds the state of the workspace module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WorkspaceState implements OnDestroy {\r\n\r\n  public workspacePanelExpanded: boolean = false;\r\n\r\n  readonly workspaceEnabled$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n  readonly rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n  readonly selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  readonly workspaceMaximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n  private actionMaximize$$: Subscription[] = [];\r\n\r\n  private rowsInMapExtentCheckCondition$$: Subscription;\r\n  private selectOnlyCheckCondition$$: Subscription;\r\n\r\n  /** Subscription to the active workspace */\r\n  private activeWorkspace$$: Subscription;\r\n\r\n  /** Subscription to the active workspace widget */\r\n  private activeWorkspaceWidget$$: Subscription;\r\n\r\n  /** Active widget observable. Only one may be active for all available workspaces */\r\n  readonly activeWorkspaceWidget$: BehaviorSubject<Widget> = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the active workspace\r\n   */\r\n  public workspace$ = new BehaviorSubject<Workspace>(undefined);\r\n\r\n  /**\r\n   * Store that holds all the available workspaces\r\n   */\r\n  get store(): WorkspaceStore { return this._store; }\r\n  private _store: WorkspaceStore;\r\n\r\n  get workspaceSelection() {\r\n    if (this.workspace$.value) {\r\n    return this.workspace$.value?.entityStore.stateView.manyBy((r) => r.state.selected === true);\r\n    } else {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  get workspaceSelection$(): Observable<EntityRecord<object, EntityState>[]> {\r\n    if (this.workspace$.value) {\r\n      return this.workspace$.value?.entityStore?.stateView.manyBy$((r) => r.state.selected === true);\r\n    } else {\r\n      return of([]);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private featureActionsService: FeatureActionsService,\r\n    private wfsActionsService: WfsActionsService,\r\n    private editionActionsService: EditionActionsService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.initWorkspaces();\r\n  }\r\n\r\n  /**\r\n   * Initialize the workspace store. Each time a workspace is activated,\r\n   * subscribe to it's active widget. Tracking the active widget is useful\r\n   * to make sure only one widget is active at a time.\r\n   */\r\n  private initWorkspaces() {\r\n    this._store = new WorkspaceStore([]);\r\n    this._store.stateView\r\n      .firstBy$((record: EntityRecord<Workspace>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Workspace>) => {\r\n        const workspace = record ? record.entity : undefined;\r\n        this.workspace$.next(workspace);\r\n      });\r\n\r\n    this._store.stateView.all$()\r\n    .subscribe((workspaces: EntityRecord<Workspace>[]) => {\r\n      workspaces.map((wks: EntityRecord<Workspace>) => {\r\n        if (wks.entity.actionStore.empty) {\r\n          if (wks.entity instanceof WfsWorkspace) {\r\n            this.wfsActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof FeatureWorkspace) {\r\n            this.featureActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof EditionWorkspace) {\r\n            this.editionActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          }\r\n        }\r\n\r\n      });\r\n    });\r\n\r\n    this.actionMaximize$$.push(this.featureActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.wfsActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.editionActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.activeWorkspace$$ = this.workspace$\r\n      .subscribe((workspace: Workspace) => {\r\n        if (this.activeWorkspaceWidget$$ !== undefined) {\r\n          this.activeWorkspaceWidget$$.unsubscribe();\r\n          this.activeWorkspaceWidget$$ = undefined;\r\n        }\r\n\r\n        if (workspace !== undefined) {\r\n          this.activeWorkspaceWidget$$ = workspace.widget$\r\n            .subscribe((widget: Widget) => this.activeWorkspaceWidget$.next(widget));\r\n        }\r\n      });\r\n\r\n    this.rowsInMapExtentCheckCondition$$ = this.rowsInMapExtentCheckCondition$.subscribe((rowsInMapExtent) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          if (filterStrategy) {\r\n            if (rowsInMapExtent) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.selectOnlyCheckCondition$$ = this.selectOnlyCheckCondition$.subscribe((selectOnly) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          if (filterStrategy) {\r\n            if (selectOnly) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private setWorkspaceIsMaximized(maximized: boolean) {\r\n    this.storageService.set('workspaceMaximize', maximized);\r\n    this.workspaceMaximize$.next(maximized);\r\n  }\r\n\r\n  public setActiveWorkspaceById(id: string) {\r\n    const wksFromId = this.store\r\n    .all()\r\n    .find(workspace => workspace.id === id);\r\n    if (wksFromId) {\r\n      this.store.activateWorkspace(wksFromId);\r\n    }\r\n  }\r\n\r\n  public setActiveWorkspaceByTitle(title: string) {\r\n    const wksFromTitle = this.store\r\n      .all()\r\n      .find(workspace => workspace.title === title);\r\n    if (wksFromTitle) {\r\n      this.store.activateWorkspace(wksFromTitle);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown all the workspaces\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.teardownWorkspaces();\r\n    this.actionMaximize$$.map(a => a.unsubscribe());\r\n    if (this.rowsInMapExtentCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n    if (this.selectOnlyCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown the workspace store and any subscribers\r\n   */\r\n  private teardownWorkspaces() {\r\n    this.store.clear();\r\n    if (this.activeWorkspaceWidget$$ !== undefined) {\r\n      this.activeWorkspaceWidget$$.unsubscribe();\r\n    }\r\n    if (this.activeWorkspace$$ !== undefined) {\r\n      this.activeWorkspace$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport {\r\n  EntityRecord,\r\n  EntityStore,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreStrategyFuncOptions\r\n} from '@igo2/common';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\nimport {\r\n  SearchResult,\r\n  SearchSourceService,\r\n  SearchSource,\r\n  CommonVectorStyleOptions,\r\n  FeatureWorkspace,\r\n  FeatureStore,\r\n  Feature\r\n} from '@igo2/geo';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { WorkspaceState } from '../workspace/workspace.state';\r\nimport { MapState } from '../map';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchState {\r\n  public searchLayerStores: FeatureStore<Feature>[] = [];\r\n  public searchOverlayStyle: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleSelection: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleFocus: CommonVectorStyleOptions = {};\r\n\r\n  public focusedOrResolution$$: Subscription;\r\n  public selectedOrResolution$$: Subscription;\r\n\r\n  readonly searchTermSplitter$: BehaviorSubject<string> = new BehaviorSubject('|');\r\n\r\n  readonly searchTerm$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchDisabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchResultsGeometryEnabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchSettingsChange$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly selectedResult$: BehaviorSubject<SearchResult> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store that holds the search results\r\n   */\r\n  readonly store: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n\r\n  /**\r\n   * Search types currently enabled in the search source service\r\n   */\r\n  get searchTypes(): string[] {\r\n    return this.searchSourceService\r\n      .getEnabledSources()\r\n      .map((source: SearchSource) => (source.constructor as any).type);\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private storageService: StorageService,\r\n    private workspaceState: WorkspaceState,\r\n    private configService: ConfigService,\r\n    private mapState: MapState) {\r\n    const searchOverlayStyle = this.configService.getConfig('searchOverlayStyle') as {\r\n      base?: CommonVectorStyleOptions,\r\n      selection?: CommonVectorStyleOptions,\r\n      focus?: CommonVectorStyleOptions\r\n    };\r\n    if (searchOverlayStyle) {\r\n      this.searchOverlayStyle = searchOverlayStyle.base;\r\n      this.searchOverlayStyleSelection = searchOverlayStyle.selection;\r\n      this.searchOverlayStyleFocus = searchOverlayStyle.focus;\r\n    }\r\n\r\n    const searchResultsGeometryEnabled = this.storageService.get('searchResultsGeometryEnabled') as boolean;\r\n    if (searchResultsGeometryEnabled) {\r\n      this.searchResultsGeometryEnabled$.next(searchResultsGeometryEnabled);\r\n    }\r\n    this.store.addStrategy(this.createCustomFilterTermStrategy(), false);\r\n\r\n    const wksSource = this.searchSourceService.getSources().find(source => source.getId() === 'workspace');\r\n    this.workspaceState.store.entities$\r\n    .subscribe(e => {\r\n      const searchableWks = e.filter(fw => fw instanceof FeatureWorkspace && fw.layer.options.workspace.searchIndexEnabled);\r\n      this.searchSourceService.setWorkspaces(wksSource, searchableWks);\r\n    }\r\n    );\r\n    this.monitorLayerDeletion();\r\n  }\r\n\r\n  private monitorLayerDeletion() {\r\n    this.mapState.map.layers$\r\n      .subscribe((layers) => {\r\n        this.searchLayerStores.forEach((store) => {\r\n          let layer = layers.find(l => l.id === store.layer.id);\r\n          if (!layer) {\r\n            const index = this.searchLayerStores.indexOf(store);\r\n            this.searchLayerStores.splice(index, 1);\r\n          }\r\n        });\r\n      });\r\n  }\r\n\r\n  private createCustomFilterTermStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<SearchResult>) => {\r\n      return record.entity.meta.score === 100;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  /**\r\n   * Activate custom strategy\r\n   *\r\n   */\r\n  activateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate custom strategy\r\n   *\r\n   */\r\n  deactivateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  enableSearch() {\r\n    this.searchDisabled$.next(false);\r\n  }\r\n\r\n  disableSearch() {\r\n    this.searchDisabled$.next(true);\r\n  }\r\n\r\n  setSearchTerm(searchTerm: string) {\r\n    this.searchTerm$.next(searchTerm);\r\n  }\r\n\r\n  setSearchType(searchType: string) {\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  setSearchSettingsChange() {\r\n    this.searchSettingsChange$.next(true);\r\n  }\r\n\r\n  setSelectedResult(result: SearchResult) {\r\n    this.selectedResult$.next(result);\r\n  }\r\n\r\n  setSearchResultsGeometryStatus(value) {\r\n    this.storageService.set('searchResultsGeometryEnabled', value);\r\n    this.searchResultsGeometryEnabled$.next(value);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoSearchModule } from '@igo2/geo';\r\n\r\nimport { SearchBarBindingDirective } from './search-bar-binding.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [IgoSearchModule],\r\n  declarations: [SearchBarBindingDirective],\r\n  exports: [SearchBarBindingDirective],\r\n})\r\nexport class IgoAppSearchBarModule {}\r\n","import { NgModule, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoFlexibleModule, IgoCustomHtmlModule, IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoSearchModule,\r\n  IgoFeatureDetailsModule\r\n} from '@igo2/geo';\r\n\r\nimport { SearchResultsToolComponent } from './search-results-tool.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFeatureModule,\r\n    IgoSearchModule,\r\n    IgoFlexibleModule,\r\n    IgoPanelModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  declarations: [SearchResultsToolComponent],\r\n  exports: [SearchResultsToolComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n})\r\nexport class IgoAppSearchResultsToolModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoAppSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoAppSearchResultsToolModule } from './search-results-tool/search-results-tool.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n   IgoAppSearchBarModule,\r\n   IgoAppSearchResultsToolModule\r\n  ],\r\n})\r\nexport class IgoAppSearchModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Search</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/search\">code of this example</a><br>\r\n    See search section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n    <br>\r\n    <span *ngIf=\"!isTouchScreen\" title=\"Details\">\r\n      F2 activate/deactivate the pointer location.\r\n    </span>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser #mapBrowser [map]=\"map\" [view]=\"view\" igoOverlay [igoContextMenu]=actionbarMenu igoLongPress\r\n\r\n    igoSearchPointerSummary\r\n    [igoSearchPointerSummaryDelay]=\"500\"\r\n    [igoSearchPointerSummaryEnabled]=\"igoSearchPointerSummaryEnabled\"\r\n    (menuPosition)=\"onContextMenuOpen($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Search\">\r\n    <igo-search-bar\r\n      [term]=\"term\"\r\n      (pointerSummaryStatus)=\"onPointerSummaryStatusChange($event)\"\r\n      [searchSettings]=\"true\"\r\n      [store]=\"searchStore\"\r\n      [termSplitter]=\"termSplitter\"\r\n      (searchTermChange)=\"onSearchTermChange($event)\"\r\n      (search)=\"onSearch($event)\"\r\n      (clearFeature)=\"removeFeatureFromMap()\"\r\n      (searchSettingsChange)=\"onSearchSettingsChange()\"\r\n      [reverseSearchCoordsFormatEnabled]=\"igoReverseSearchCoordsFormatEnabled\"\r\n      (reverseSearchCoordsFormatStatus)=\"onReverseCoordsFormatStatusChange($event)\">\r\n    </igo-search-bar>\r\n\r\n    <igo-search-results\r\n      [store]=\"searchStore\"\r\n      [term]=\"term\"\r\n      [termSplitter]=\"termSplitter\"\r\n      placeholder=\"false\"\r\n      [settingsChange$]=\"settingsChange$\"\r\n      (resultFocus)=\"onResultFocus($event)\"\r\n      (resultSelect)=\"onResultFocus($event)\"\r\n      (moreResults)=\"onSearch($event)\">\r\n        <ng-template #igoSearchItemToolbar let-result=\"result\">\r\n          <igo-search-add-button\r\n            [map]=\"map\"\r\n            [layer]=\"result\">\r\n          </igo-search-add-button>\r\n        </ng-template>\r\n    </igo-search-results>\r\n\r\n  </igo-panel>\r\n\r\n  <igo-panel *ngIf=\"selectedFeature\" title=\"Details\">\r\n    <igo-feature-details [feature]=\"selectedFeature\"></igo-feature-details>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"false\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSearchComponent } from './search.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'search',\r\n    component: AppSearchComponent\r\n  }\r\n];\r\n\r\nexport const AppSearchRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  Component,\r\n  ElementRef,\r\n  OnDestroy,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport * as proj from 'ol/proj';\r\n\r\nimport { LanguageService, MediaService, StorageService } from '@igo2/core';\r\nimport { EntityStore, ActionStore } from '@igo2/common';\r\nimport {\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion,\r\n  GoogleLinks,\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  Layer,\r\n  ProjectionService,\r\n  Research,\r\n  SearchResult\r\n} from '@igo2/geo';\r\n\r\nimport { SearchState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-search',\r\n  templateUrl: './search.component.html',\r\n  styleUrls: ['./search.component.scss']\r\n})\r\nexport class AppSearchComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  public igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  public termSplitter: string = '|';\r\n\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public osmLayer: Layer;\r\n\r\n  @ViewChild('mapBrowser', { read: ElementRef, static: true }) mapBrowser: ElementRef;\r\n\r\n  public lonlat;\r\n  public mapProjection: string;\r\n  public term: string;\r\n\r\n  public settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  get searchStore(): EntityStore<SearchResult> {\r\n    return this.searchState.store;\r\n  }\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  public selectedFeature: Feature;\r\n  public igoReverseSearchCoordsFormatEnabled: boolean;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private projectionService: ProjectionService,\r\n    private mapService: MapService,\r\n    private layerService: LayerService,\r\n    private searchState: SearchState,\r\n    private mediaService: MediaService,\r\n    private storageService: StorageService,\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => {\r\n        this.osmLayer = layer;\r\n        this.map.addLayer(layer);\r\n      });\r\n\r\n      this.igoReverseSearchCoordsFormatEnabled =\r\n      this.storageService.get('reverseSearchCoordsFormatEnabled') as boolean || false;\r\n  }\r\n\r\n  onPointerSummaryStatusChange(value) {\r\n    this.igoSearchPointerSummaryEnabled = value;\r\n  }\r\n\r\n  onSearchTermChange(term?: string) {\r\n    this.term = term;\r\n    this.searchState.setSearchTerm(term);\r\n    const termWithoutHashtag = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (termWithoutHashtag.length < 2) {\r\n      this.searchStore.clear();\r\n      this.selectedFeature = undefined;\r\n    }\r\n  }\r\n\r\n  onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    this.searchStore.state.updateAll({ focused: false, selected: false });\r\n    const newResults = this.searchStore.entities$.value\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.searchStore.updateMany(newResults);\r\n  }\r\n\r\n  onReverseCoordsFormatStatusChange(value) {\r\n    this.storageService.set('reverseSearchCoordsFormatEnabled', value);\r\n    this.igoReverseSearchCoordsFormatEnabled = value;\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.settingsChange$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map when it's being focused\r\n   * @internal\r\n   * @param result A search result that could be a feature\r\n   */\r\n  onResultFocus(result: SearchResult) {\r\n    this.tryAddFeatureToMap(result);\r\n    this.selectedFeature = (result as SearchResult<Feature>).data;\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map overlay\r\n   * @param layer A search result that could be a feature\r\n   */\r\n  private tryAddFeatureToMap(layer: SearchResult) {\r\n    if (layer.meta.dataType !== FEATURE) {\r\n      return undefined;\r\n    }\r\n\r\n    // Somethimes features have no geometry. It happens with some GetFeatureInfo\r\n    if (layer.data.geometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.map.searchResultsOverlay.setFeatures(\r\n      [layer.data] as Feature[],\r\n      FeatureMotion.Default\r\n    );\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'coordinates',\r\n        title: 'coordinates',\r\n        handler: () => this.searchCoordinate(this.lonlat)\r\n      },\r\n      {\r\n        id: 'googleMaps',\r\n        title: 'googleMap',\r\n        handler: () => this.openGoogleMaps(this.lonlat),\r\n      },\r\n      {\r\n        id: 'googleStreetView',\r\n        title: 'googleStreetView',\r\n        handler: () => this.openGoogleStreetView(this.lonlat)\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /*\r\n   * Remove a feature to the map overlay\r\n   */\r\n  removeFeatureFromMap() {\r\n    this.map.searchResultsOverlay.clear();\r\n  }\r\n\r\n  onContextMenuOpen(event: { x: number; y: number }) {\r\n    const position = this.mapPosition(event);\r\n    const coord = this.mapService.getMap().ol.getCoordinateFromPixel(position);\r\n    this.mapProjection = this.mapService.getMap().projection;\r\n    this.lonlat = proj.transform(coord, this.mapProjection, 'EPSG:4326');\r\n  }\r\n\r\n  mapPosition(event: { x: number; y: number }) {\r\n    const contextmenuPoint = event;\r\n    contextmenuPoint.y =\r\n      contextmenuPoint.y -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().top +\r\n      window.scrollY;\r\n    contextmenuPoint.x =\r\n      contextmenuPoint.x -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().left +\r\n      window.scrollX;\r\n    const position = [contextmenuPoint.x, contextmenuPoint.y];\r\n    return position;\r\n  }\r\n\r\n  searchCoordinate(lonlat) {\r\n    this.searchStore.clear();\r\n    this.term = (!this.igoReverseSearchCoordsFormatEnabled) ?\r\n    lonlat.map((c) => c.toFixed(6)).join(', ') : lonlat.reverse().map((c) => c.toFixed(6)).join(', ');\r\n  }\r\n\r\n  openGoogleMaps(lonlat) {\r\n    window.open(GoogleLinks.getGoogleMapsCoordLink(lonlat[0], lonlat[1]));\r\n  }\r\n\r\n  openGoogleStreetView(lonlat) {\r\n    window.open(\r\n      GoogleLinks.getGoogleStreetViewLink(lonlat[0], lonlat[1])\r\n    );\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport {\r\n  IgoPanelModule,\r\n  IgoActionbarModule,\r\n  IgoContextMenuModule\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoMapModule,\r\n  IgoSearchModule,\r\n  provideIChercheSearchSource,\r\n  provideWorkspaceSearchSource,\r\n  provideILayerSearchSource,\r\n  provideNominatimSearchSource,\r\n  provideIChercheReverseSearchSource,\r\n  provideCoordinatesReverseSearchSource,\r\n  provideCadastreSearchSource,\r\n  provideStoredQueriesSearchSource,\r\n  provideStoredQueriesReverseSearchSource\r\n} from '@igo2/geo';\r\n\r\nimport { IgoAppSearchModule } from '@igo2/integration';\r\n\r\nimport { AppSearchComponent } from './search.component';\r\nimport { AppSearchRoutingModule } from './search-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSearchComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSearchRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoMessageModule.forRoot(),\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoSearchModule.forRoot(),\r\n    IgoAppSearchModule,\r\n    IgoActionbarModule,\r\n    IgoContextMenuModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppSearchComponent],\r\n  providers: [\r\n    provideCoordinatesReverseSearchSource(),\r\n    provideCadastreSearchSource(),\r\n    provideIChercheSearchSource(),\r\n    provideWorkspaceSearchSource(),\r\n    provideILayerSearchSource(),\r\n    provideNominatimSearchSource(),\r\n    provideIChercheReverseSearchSource(),\r\n    provideStoredQueriesSearchSource(),\r\n    provideStoredQueriesReverseSearchSource()\r\n  ]\r\n})\r\nexport class AppSearchModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppPrintComponent } from './print.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'print',\r\n    component: AppPrintComponent\r\n  }\r\n];\r\n\r\nexport const AppPrintRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-print',\r\n  templateUrl: './print.component.html',\r\n  styleUrls: ['./print.component.scss']\r\n})\r\nexport class AppPrintComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: false\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Quebec Base Map',\r\n        sourceOptions: {\r\n          type: 'wmts',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n          layer: 'carte_gouv_qc_ro',\r\n          matrixSet: 'EPSG_3857',\r\n          version: '1.3.0',\r\n          crossOrigin: 'anonymous',\r\n          attributions: \"© <a href='http://www.droitauteur.gouv.qc.ca/copyright.php' target='_blank'><img src='https://geoegl.msp.gouv.qc.ca/gouvouvert/public/images/quebec/gouv_qc_logo.png' width='64' height='14'>Gouvernement du Québec</a> / <a href='https://www.igouverte.org/' target='_blank'>IGO2</a>\"\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'School board',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'MELS_CS_ANGLO_S',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n    //\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Embacle',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    // this.layerService\r\n    //   .createAsyncLayer({\r\n    //     title: 'Geomet',\r\n    //     sourceOptions: {\r\n    //       type: 'wms',\r\n    //       url: 'http://geo.weather.gc.ca/geomet/?lang=fr',\r\n    //       params: {\r\n    //         LAYERS: 'RADAR_1KM_RDBR',\r\n    //         VERSION: '1.3.0'\r\n    //       },\r\n    //       crossOrigin: 'anonymous'\r\n    //     }\r\n    //   })\r\n    //   .subscribe(l => this.map.addLayer(l));\r\n\r\n    /*\r\n        //CORS error if activate (for test)\r\n        this.layerService\r\n          .createAsyncLayer({\r\n            title: 'Geomet',\r\n            sourceOptions: {\r\n              type: 'wms',\r\n              url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wms',\r\n              params: {\r\n                layers: 'swtq',\r\n                version: '1.3.0',\r\n              }\r\n            }\r\n          })\r\n          .subscribe(l => this.map.addLayer(l));\r\n    */\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Print</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/print\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-print [map]=\"map\"></igo-print>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport { IgoMapModule, IgoPrintModule } from '@igo2/geo';\r\n\r\nimport { AppPrintComponent } from './print.component';\r\nimport { AppPrintRoutingModule } from './print-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppPrintComponent],\r\n  imports: [\r\n    AppPrintRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoPrintModule\r\n  ],\r\n  exports: [AppPrintComponent]\r\n})\r\nexport class AppPrintModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'import-export',\r\n    component: AppImportExportComponent\r\n  }\r\n];\r\n\r\nexport const AppImportExportRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\nimport { WorkspaceStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class AppImportExportComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  public store = new WorkspaceStore([]);\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Import / Export</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/import-export\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-import-export [store]=\"store\" [map]=\"map\"></igo-import-export>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoImportExportModule,\r\n  provideStyleListOptions,\r\n  IgoStyleModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\nimport { AppImportExportRoutingModule } from './import-export-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppImportExportComponent],\r\n  imports: [\r\n    AppImportExportRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoStyleModule,\r\n    IgoImportExportModule\r\n  ],\r\n  exports: [AppImportExportComponent],\r\n  providers: [\r\n    provideStyleListOptions({\r\n      path: './assets/import-style.json'\r\n    })\r\n  ]\r\n})\r\nexport class AppImportExport {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'directions',\r\n    component: AppDirectionsComponent\r\n  }\r\n];\r\n\r\nexport const AppDirectionsRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  ProjectionService,\r\n  StopsStore,\r\n  StopsFeatureStore,\r\n  RoutesFeatureStore,\r\n  StepFeatureStore\r\n} from '@igo2/geo';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class AppDirectionsComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9,\r\n    geolocate: false\r\n  };\r\n\r\n  public stopsStore: StopsStore = new StopsStore([]);\r\n  public stopsFeatureStore: StopsFeatureStore = new StopsFeatureStore([], { map: this.map });\r\n  public stepFeatureStore: StepFeatureStore = new StepFeatureStore([], { map: this.map });\r\n  public routesFeatureStore: RoutesFeatureStore = new RoutesFeatureStore([], { map: this.map });\r\n  public zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private projectionService: ProjectionService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Directions</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/directions\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-directions\r\n    [stopsStore]=\"stopsStore\"\r\n    [stopsFeatureStore]=\"stopsFeatureStore\"\r\n    [stepFeatureStore]=\"stepFeatureStore\"\r\n    [routesFeatureStore]=\"routesFeatureStore\"\r\n    [zoomToActiveRoute$]=\"zoomToActiveRoute$\">  \r\n  </igo-directions>\r\n\r\n\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoDirectionsModule,\r\n  provideOsrmDirectionsSource\r\n} from '@igo2/geo';\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\nimport { AppDirectionsRoutingModule } from './directions-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDirectionsComponent],\r\n  imports: [\r\n    AppDirectionsRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoDirectionsModule\r\n  ],\r\n  exports: [AppDirectionsComponent],\r\n  providers: [provideOsrmDirectionsSource()]\r\n})\r\nexport class AppDirectionsModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'time-filter',\r\n    component: AppTimeFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppTimeFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  TimeFilterableDataSourceOptions,\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-time-filter',\r\n  templateUrl: './time-filter.component.html',\r\n  styleUrls: ['./time-filter.component.scss']\r\n})\r\nexport class AppTimeFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasource: TimeFilterableDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n    //   params: {\r\n    //     layers: 'vg_observation_v_inondation_embacle_wmst',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   timeFilterable: true,\r\n    //   timeFilter: {\r\n    //     min: '2017-01-01',\r\n    //     max: '2018-01-01',\r\n    //     range: true,\r\n    //     type: TimeFilterType.DATETIME,\r\n    //     style: TimeFilterStyle.SLIDER,\r\n    //     step: 86400000,\r\n    //     timeInterval: 2000\r\n    //   }\r\n    // };\r\n\r\n    const datasourceYear: TimeFilterableDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      },\r\n      timeFilterable: true,\r\n      timeFilter: {\r\n        min: '2013',\r\n        max: '2019',\r\n        range: false,\r\n        type: TimeFilterType.YEAR,\r\n        style: TimeFilterStyle.SLIDER,\r\n        step: 1,\r\n        timeInterval: 2000\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle YEAR',\r\n            visible: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Time filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>npm install --save moment@2.22.2</li>\r\n    <li>npm install --save @mat-datetimepicker/core@3.0.0-beta.0</li>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/time-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-time-filter-list [layers]=\"map.layers\"></igo-time-filter-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\nimport { AppTimeFilterRoutingModule } from './time-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTimeFilterComponent],\r\n  imports: [\r\n    AppTimeFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppTimeFilterComponent]\r\n})\r\nexport class AppTimeFilterModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'ogc-filter',\r\n    component: AppOgcFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppOgcFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  WFSDataSourceOptions,\r\n  WFSDataSourceOptionsParams,\r\n  OgcFilterableDataSourceOptions,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcFilterOperatorType,\r\n  OgcFilterDuringOptions\r\n} from '@igo2/geo';\r\n\r\nimport {Fill, Stroke, Circle, Style} from 'ol/style';\r\n\r\n@Component({\r\n  selector: 'app-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss']\r\n})\r\nexport class AppOgcFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const datasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'code_municipalite', alias: '# de la municipalitée' },\r\n        { name: 'date_observation', excludeFromOgcFilters: true },\r\n        { name: 'urgence', values: ['immédiate', 'inconnue'] }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters: {\r\n          logical: 'Or',\r\n          filters: [\r\n            {\r\n              operator: 'PropertyIsEqualTo',\r\n              propertyName: 'code_municipalite',\r\n              expression: '10043'\r\n            },\r\n            {\r\n              operator: 'Intersects',\r\n              geometryName: 'the_geom',\r\n              wkt_geometry: `MULTIPOLYGON(((\r\n              -8379441.158019895 5844447.897707146,\r\n              -8379441.158019895 5936172.331649357,\r\n              -8134842.66750733 5936172.331649357,\r\n              -8134842.66750733 5844447.897707146,\r\n              -8379441.158019895 5844447.897707146\r\n            ), (\r\n              -8015003 5942074,\r\n              -8015003 5780349,\r\n              -7792364 5780349,\r\n              -7792364 5942074,\r\n              -8015003 5942074\r\n            )))`\r\n            }\r\n          ] as AnyBaseOgcFilterOptions[]\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (PropertyIsEqualTo OR Intersects)',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'orange',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilter: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-21T00:00:00-05:00',\r\n            end: '2016-01-26T00:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-10T00:00:00-05:00',\r\n      stepDate: 'P2D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilter)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: P2D)',\r\n            id: '1',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n\r\n    const datasourceDuringFilterTime: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T04:00:00-05:00',\r\n            end: '2016-01-12T16:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-14T20:00:00-05:00',\r\n      stepDate: 'PT4H'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTime)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: PT4H)',\r\n            id: '2',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'blue',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeMonth: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T00:00:00-05:00',\r\n            end: '2016-03-31T00:00:00-05:00',\r\n            displayFormat: 'MMMM'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2018-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeMonth)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: P1M)',\r\n            id: '3',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'yellow',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeYear: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2014-01-01T00:00:00-05:00',\r\n            end: '2019-12-31T00:00:00-05:00',\r\n            sliderOptions: {\r\n              interval: 2000,\r\n              displayFormat: 'YY'\r\n            },\r\n            displayFormat: 'YYYY'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2014-01-01T00:00:00-05:00',\r\n      maxDate: '2019-12-31T00:00:00-05:00',\r\n      stepDate: 'P1Y'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Step: P1Y)',\r\n            id: '4',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'green',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeInterval: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: 'today - 2 days', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n            end: 'today', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeInterval)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, Interval from Now, Step: P1D)',\r\n            id: '5',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'black',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeRestrictedToStep: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2019-01-01 00:00:00',\r\n            restrictToStep: true\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeRestrictedToStep)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embâcle (During, RestrictToStep, Step: P1M)',\r\n            id: '6',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'black'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const wmsOgcFilterOptions: WMSoptions = {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'vg_observation_v_inondation23avril2017_wmst',\r\n          VERSION: '1.3.0'\r\n        },\r\n        sourceFields: [\r\n          { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n        ],\r\n        ogcFilters: {\r\n          enabled: true,\r\n          editable: true,\r\n          filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation'\r\n          } as OgcFilterDuringOptions,\r\n          allowedOperatorsType: OgcFilterOperatorType.Time\r\n        }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wmsOgcFilterOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Inondation (During, optionsFromCapabilities)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WMSoptions\r\n      extends WMSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const filterableWMSwithPushButtons: WMSoptions = {\r\n      type: 'wms',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        LAYERS: 'radars_photos',\r\n        VERSION: '1.3.0'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        pushButtons: {\r\n          selectorType: 'pushButton',\r\n          order: 2,\r\n          groups : [\r\n            {title: 'Nom du group1 - push', name: '1 - push', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Régions',\r\n              logical: 'Or',\r\n              vertical: true,\r\n              selectors: [\r\n                {\r\n                  title: 'Montréal & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'Or',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montréal'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Outside Montréal & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'And',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montréal'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        checkboxes: {\r\n          selectorType: 'checkbox',\r\n          order: 1,\r\n          groups : [\r\n            {title: 'Nom du group1 - checkbox', name: '1 - checkbox', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Type de radar photo',\r\n              logical: 'Or',\r\n              selectors: [\r\n                {\r\n                  title: 'Radar photo fixe',\r\n                  enabled: true,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo mobile',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo mobile'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo fixe + feu rouge',\r\n                  enabled: false,\r\n                  color: '0,200,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe et surveillance au feu rouge'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar feu rouge',\r\n                  enabled: false,\r\n                  color: '255,0,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Appareil de surveillance au feu rouge'\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        allowedOperatorsType: OgcFilterOperatorType.Basic\r\n        },\r\n      paramsWFS: {\r\n        featureTypes: 'radars_photos',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '1.1.0',\r\n        outputFormat: 'geojson',\r\n        outputFormatDownload: 'shp'\r\n      } as WFSDataSourceOptionsParams\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(filterableWMSwithPushButtons)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Filterable WMS layers with predefined filters (push buttons)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasourceWmsWith2Layers: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   params: {\r\n    //     layers: 'stations_meteoroutieres,histo_stations_meteoroutieres',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'histo_stations_meteoroutieres',\r\n    //     fieldNameGeometry: 'geometry',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'geojson',\r\n    //     outputFormatDownload: 'shp'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWmsWith2Layers)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Layer build from 2 WMS layers',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n\r\n    // const datasourceWms: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: '/geoserver/wms',\r\n    //   urlWfs: '/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true,\r\n    //     filters: {\r\n    //       operator: 'PropertyIsEqualTo',\r\n    //       propertyName: 'waterway',\r\n    //       expression: 'riverbank'\r\n    //     }\r\n    //   },\r\n    //   sourceFields: [\r\n    //     { name: 'waterway', alias: 'Chemin d eau' },\r\n    //     { name: 'osm_id' },\r\n    //     { name: 'landuse', values: ['yes', 'no'] }\r\n    //   ],\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWms)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Geoserver water_areas',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Ogc filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/ogc-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-ogc-filterable-list [map]=\"map\" [layers]=\"map.layers\">\r\n\r\n    </igo-ogc-filterable-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\nimport { AppOgcFilterRoutingModule } from './ogc-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOgcFilterComponent],\r\n  imports: [\r\n    AppOgcFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppOgcFilterComponent]\r\n})\r\nexport class AppOgcFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Query</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/query\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay\r\n    igoQuery\r\n    [queryFeatures]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel>\r\n    <igo-spatial-filter-type\r\n      [store]=\"spatialListStore\"\r\n      [selectedQueryType]=\"queryType\"\r\n      [zone]=\"zone\"\r\n      [layers]=\"activeLayers\"\r\n      (eventType)=\"getOutputType($event)\"\r\n      (eventQueryType)=\"getOutputQueryType($event)\"\r\n      (zoneChange)=\"onZoneChange($event)\"\r\n      (zoneWithBufferChange)=\"onZoneChange($event, true)\"\r\n      (bufferChange)=\"buffer = $event\"\r\n      (measureUnitChange)=\"measureUnit = $event\">\r\n    </igo-spatial-filter-type>\r\n\r\n    <igo-spatial-filter-item\r\n      [type]=\"type\"\r\n      [queryType]=\"queryType\"\r\n      [map]=\"map\"\r\n      [zone]=\"zone\"\r\n      [loading]=\"loading\"\r\n      [store]=\"store\"\r\n      [layers]=\"activeLayers\"\r\n      [allLayers]=\"layers\"\r\n      [thematicLength]=\"thematicLength\"\r\n      (radiusEvent)=\"buffer = $event\"\r\n      (bufferEvent)=\"buffer = $event\"\r\n      (measureUnitChange)=\"measureUnit = $event\"\r\n      (freehandControl)=\"freehandDrawIsActive = $event\"\r\n      (drawZoneEvent)=\"zone = $event\"\r\n      (zoneWithBufferChange)=\"onZoneChange($event, true)\"\r\n      (itemTypeChange)=\"itemType = $event\"\r\n      (thematicChange)=\"thematics = $event\"\r\n      (toggleSearch)=\"getOutputToggleSearch()\"\r\n      (clearButtonEvent)=\"clearMap()\"\r\n      (clearSearchEvent)=\"getOutputClearSearch()\">\r\n    </igo-spatial-filter-item>\r\n  </igo-panel>\r\n\r\n  <igo-panel>\r\n    <ng-container *ngIf=\"selectedFeature$ | async as feature\">\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n</mat-card>","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'spatial-filter',\r\n    component: AppSpatialFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppSpatialFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef, OnDestroy, OnInit } from '@angular/core';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\nimport { Observable, forkJoin, Subject } from 'rxjs';\r\nimport { tap, take, takeUntil } from 'rxjs/operators';\r\n\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  Feature,\r\n  moveToOlFeatures,\r\n  FeatureMotion,\r\n  ClusterDataSource,\r\n  featureToOl,\r\n  DataSource,\r\n  QueryableDataSourceOptions,\r\n  SpatialFilterService,\r\n  SpatialFilterType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterQueryType,\r\n  SpatialFilterThematic,\r\n  Layer,\r\n  VectorLayer,\r\n  createOverlayMarkerStyle,\r\n  MeasureLengthUnit\r\n} from '@igo2/geo';\r\nimport { EntityStore } from '@igo2/common';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport olSourceCluster from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'app-spatial-filter',\r\n  templateUrl: './spatial-filter.component.html',\r\n  styleUrls: ['./spatial-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSpatialFilterComponent implements OnInit, OnDestroy {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  @Input() type: SpatialFilterType;\r\n  @Input() itemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  @Input() freehandDrawIsActive: boolean;\r\n\r\n  public layers: Layer[] = [];\r\n  public activeLayers: Layer[] = [];\r\n\r\n  public queryType: SpatialFilterQueryType;\r\n  public thematics: SpatialFilterThematic[];\r\n  public zone: Feature;\r\n  public zoneWithBuffer: Feature;\r\n  public buffer = 0;\r\n\r\n  public iterator = 1;\r\n\r\n  public selectedFeature$: BehaviorSubject<Feature> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  public store: EntityStore<Feature> = new EntityStore<Feature>([]); // Store to print results at the end\r\n\r\n  public spatialListStore: EntityStore<Feature> = new EntityStore<Feature>([]);\r\n\r\n  public loading = false;\r\n\r\n  public thematicLength = 0;\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  private unsubscribe$ = new Subject<void>();\r\n\r\n  public defaultStyle: olstyle.Style | ((feature, resolution) => olstyle.Style);\r\n\r\n  constructor(\r\n    private matIconRegistry: MatIconRegistry,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnInit() {\r\n    for (const layer of this.map.layers) {\r\n      if (layer.title && layer.title.includes(this.languageService.translate.instant('igo.geo.spatialFilter.spatialFilter'))) {\r\n        this.layers.push(layer);\r\n      }\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribe$.next();\r\n    this.unsubscribe$.complete();\r\n  }\r\n\r\n  getOutputType(event: SpatialFilterType) {\r\n    this.type = event;\r\n    this.queryType = undefined;\r\n  }\r\n\r\n  getOutputQueryType(event: SpatialFilterQueryType) {\r\n    this.queryType = event;\r\n    if (this.queryType) {\r\n      this.loadFilterList();\r\n    }\r\n  }\r\n\r\n  private loadFilterList() {\r\n    this.spatialFilterService\r\n      .loadFilterList(this.queryType)\r\n      .pipe(takeUntil(this.unsubscribe$))\r\n      .subscribe((features: Feature[]) => {\r\n        features.sort((a, b) => {\r\n          if (a.properties.nom < b.properties.nom) {\r\n            return -1;\r\n          }\r\n          if (a.properties.nom > b.properties.nom) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n        this.spatialListStore.clear();\r\n        this.spatialListStore.load(features);\r\n      });\r\n  }\r\n\r\n  getOutputToggleSearch() {\r\n    this.loadThematics();\r\n  }\r\n\r\n  getOutputClearSearch() {\r\n    this.zone = undefined;\r\n    this.queryType = undefined;\r\n  }\r\n\r\n  clearMap() {\r\n    this.map.removeLayers(this.layers);\r\n    this.layers = [];\r\n    this.activeLayers = [];\r\n    this.thematicLength = 0;\r\n    this.iterator = 1;\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      this.zone = undefined;\r\n      this.queryType = undefined;\r\n    }\r\n  }\r\n\r\n  private loadThematics() {\r\n    this.loading = true;\r\n    let zeroResults = true;\r\n    let thematics;\r\n    if (this.buffer === 0 || this.type === SpatialFilterType.Point) {\r\n      this.tryAddFeaturesToMap([this.zone]);\r\n    }\r\n    if (this.itemType !== SpatialFilterItemType.Thematics) {\r\n      const theme: SpatialFilterThematic = {\r\n        name: ''\r\n      };\r\n      thematics = [theme];\r\n    } else {\r\n      thematics = this.thematics;\r\n    }\r\n    if (this.measureUnit === MeasureLengthUnit.Kilometers && this.type !== SpatialFilterType.Point) {\r\n      this.buffer = this.buffer * 1000;\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon) {\r\n      this.buffer = 0; // to avoid buffer enter a second time in terrAPI\r\n    }\r\n\r\n    const observables$: Observable<Feature[]>[] = [];\r\n    thematics.forEach(thematic => {\r\n      observables$.push(\r\n        this.spatialFilterService\r\n          .loadFilterItem(\r\n            this.zone,\r\n            this.itemType,\r\n            this.queryType,\r\n            thematic,\r\n            this.buffer\r\n          )\r\n          .pipe(\r\n            tap((features: Feature[]) => {\r\n              this.store.insertMany(features);\r\n              const featuresPoint: Feature[] = [];\r\n              const featuresLinePoly: Feature[] = [];\r\n              let idPoint;\r\n              let idLinePoly;\r\n              features.forEach(feature => {\r\n                if (feature.geometry.type === 'Point') {\r\n                  feature.properties.longitude = feature.geometry.coordinates[0];\r\n                  feature.properties.latitude = feature.geometry.coordinates[1];\r\n                  featuresPoint.push(feature);\r\n                  idPoint = feature.meta.id;\r\n                } else {\r\n                  featuresLinePoly.push(feature);\r\n                  idLinePoly = feature.meta.id;\r\n                }\r\n              });\r\n\r\n              this.tryAddPointToMap(featuresPoint, idPoint);\r\n              this.tryAddLayerToMap(featuresLinePoly, idLinePoly);\r\n              if (features.length) {\r\n                zeroResults = false;\r\n                this.thematicLength += 1;\r\n                thematic.zeroResults = false;\r\n                this.cdRef.detectChanges();\r\n              } else {\r\n                thematic.zeroResults = true;\r\n              }\r\n\r\n              if (features.length >= 10000) {\r\n                this.messageService.alert(\r\n                  'igo.geo.spatialFilter.maxSizeAlert',\r\n                  'igo.geo.spatialFilter.warning',\r\n                  { timeOut: 10000 }\r\n                );\r\n              }\r\n            })\r\n          )\r\n      );\r\n    });\r\n\r\n    forkJoin(observables$).pipe(takeUntil(this.unsubscribe$)).subscribe(() => {\r\n      this.loading = false;\r\n      if (zeroResults) {\r\n        this.messageService.alert(\r\n          'igo.geo.spatialFilter.zeroResults',\r\n          'igo.geo.spatialFilter.warning',\r\n          { timeOut: 10000 }\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  onZoneChange(feature: Feature, buffer?: boolean) {\r\n    this.zone = feature;\r\n    if (feature) {\r\n      buffer ? this.tryAddFeaturesToMap([feature], true) : this.tryAddFeaturesToMap([feature]);\r\n      this.zoomToFeatureExtent(feature);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add zone feature to the map overlay\r\n   */\r\n  public tryAddFeaturesToMap(features: Feature[], buffer?: boolean) {\r\n    let i = 1;\r\n    for (const feature of features) {\r\n      if (this.type === SpatialFilterType.Predefined) {\r\n        for (const layer of this.layers) {\r\n          if (\r\n            layer.options._internal &&\r\n            layer.options._internal.code === feature.properties.code &&\r\n            !buffer\r\n          ) {\r\n            if (!layer.title?.startsWith('Zone')) {\r\n              const index = this.layers.indexOf(layer);\r\n              this.layers.splice(index, 1);\r\n            }\r\n            return;\r\n          }\r\n          if (layer.title?.startsWith('Zone')) {\r\n            this.activeLayers = [];\r\n            const index = this.layers.indexOf(layer);\r\n            this.layers.splice(index, 1);\r\n            this.map.removeLayer(layer);\r\n          }\r\n        }\r\n      } else {\r\n        if (buffer) {\r\n          for (const layer of this.activeLayers) {\r\n            if (this.activeLayers.length === 1 && layer.title?.startsWith('Zone')) {\r\n              const index = this.layers.indexOf(layer);\r\n              this.layers.splice(index, 1);\r\n              this.map.removeLayer(layer);\r\n            }\r\n          }\r\n        }\r\n        this.activeLayers = [];\r\n      }\r\n      for (const layer of this.layers) {\r\n        if (layer.title?.startsWith('Zone')) {\r\n          i++;\r\n        }\r\n      }\r\n      this.defaultStyle = (_feature, resolution) => {\r\n        const coordinates = (features[0] as any).coordinates;\r\n        return new olstyle.Style({\r\n          image: new olstyle.Circle({\r\n            radius: coordinates\r\n              ? this.buffer /\r\n                Math.cos((Math.PI / 180) * coordinates[1]) /\r\n                resolution\r\n              : undefined,\r\n            fill: new olstyle.Fill({\r\n              color: 'rgba(200, 200, 20, 0.2)'\r\n            }),\r\n            stroke: new olstyle.Stroke({\r\n              width: 1,\r\n              color: 'orange'\r\n            })\r\n          }),\r\n          stroke: new olstyle.Stroke({\r\n            width: 1,\r\n            color: 'orange'\r\n          }),\r\n          fill: new olstyle.Fill({\r\n            color: 'rgba(200, 200, 20, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            isIgoInternalLayer: true,\r\n            title: ('Zone ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string,\r\n            workspace: { enabled: true },\r\n            _internal: {\r\n              code:\r\n                this.type === SpatialFilterType.Predefined\r\n                  ? feature.properties.code\r\n                  : undefined\r\n            },\r\n            source: dataSource,\r\n            visible: true\r\n          }) as VectorLayer;\r\n          const featuresOl = features.map(f => {\r\n            return featureToOl(f, this.map.projection);\r\n          });\r\n          if (this.type !== SpatialFilterType.Predefined) {\r\n            const type = this.type === SpatialFilterType.Point ? 'Cercle' : 'Polygone';\r\n            featuresOl[0].set('nom', 'Zone', true);\r\n            featuresOl[0].set('type', type, true);\r\n          }\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry> | olSourceCluster;\r\n          ol.addFeatures(featuresOl);\r\n          olLayer.ol.setStyle(this.defaultStyle);\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n          this.activeLayers.push(olLayer);\r\n          this.cdRef.detectChanges();\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add point features to the map\r\n   * Necessary to create clusters\r\n   */\r\n  private tryAddPointToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.layers) {\r\n        if (layer.title?.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'cluster',\r\n          id,\r\n          queryable: true,\r\n          distance: 120,\r\n          meta: {\r\n            title: 'Cluster'\r\n          }\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: ClusterDataSource) => {\r\n          const icon = features[0].meta.icon;\r\n          let style: olstyle.Style;\r\n          if (!icon) {\r\n            style = createOverlayMarkerStyle();\r\n          } else {\r\n            style = this.createSvgIcon(icon) || createOverlayMarkerStyle();\r\n          }\r\n\r\n          const olLayer = this.layerService.createLayer({\r\n            isIgoInternalLayer: true,\r\n            title: (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string,\r\n            source: dataSource,\r\n            visible: true,\r\n            style\r\n          });\r\n\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceCluster;\r\n          ol.getSource().addFeatures(featuresOl);\r\n          if (this.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.iterator = i;\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n          this.pushLayer(olLayer);\r\n          this.cdRef.detectChanges();\r\n        });\r\n    }\r\n  }\r\n\r\n  private createSvgIcon(icon): olstyle.Style {\r\n    let style: olstyle.Style;\r\n    this.matIconRegistry.getNamedSvgIcon(icon).subscribe(svgObj => {\r\n      const xmlSerializer = new XMLSerializer();\r\n      svgObj.setAttribute('width', '30');\r\n      svgObj.setAttribute('height', '30');\r\n      svgObj.setAttribute('fill', 'rgba(0, 128, 255)');\r\n      svgObj.setAttribute('stroke', 'white');\r\n      const svg = xmlSerializer.serializeToString(svgObj);\r\n      style = new olstyle.Style({\r\n        image: new olstyle.Icon({\r\n          src: 'data:image/svg+xml;utf8,' + svg\r\n        })\r\n      });\r\n    });\r\n    return style;\r\n  }\r\n  /**\r\n   * Try to add line or polygon features to the map\r\n   */\r\n  private tryAddLayerToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.layers) {\r\n        if (layer.title?.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          id,\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            isIgoInternalLayer: true,\r\n            title: (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string,\r\n            source: dataSource,\r\n            visible: true\r\n          });\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry>;\r\n          ol.addFeatures(featuresOl);\r\n          if (this.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n          this.pushLayer(olLayer);\r\n          this.cdRef.detectChanges();\r\n        });\r\n    }\r\n  }\r\n\r\n  zoomToFeatureExtent(feature) {\r\n    if (feature) {\r\n      const olFeature = this.format.readFeature(feature, {\r\n        dataProjection: feature.projection,\r\n        featureProjection: this.map.projection\r\n      });\r\n      moveToOlFeatures(this.map, [olFeature], FeatureMotion.Zoom);\r\n    }\r\n  }\r\n\r\n  pushLayer(layer) {\r\n    for (const lay of this.activeLayers) {\r\n      if (lay.id === layer.id) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.activeLayers.push(layer);\r\n  }\r\n}\r\n","import { CommonModule } from '@angular/common';\r\nimport { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoFormModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule, IgoQueryModule, IgoFeatureModule, IgoFeatureDetailsModule } from '@igo2/geo';\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\nimport { AppSpatialFilterRoutingModule } from './spatial-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSpatialFilterComponent],\r\n  imports: [\r\n    AppSpatialFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoMessageModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoFilterModule,\r\n    IgoFormModule,\r\n    CommonModule\r\n  ],\r\n  exports: [AppSpatialFilterComponent]\r\n})\r\nexport class AppSpatialFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Workspace</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/workspace\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-workspace-selector\r\n    igoWorkspaceSelector\r\n    [store]=\"workspaceStore\"\r\n    [map]=\"map\">\r\n  </igo-workspace-selector>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-entity-table-paginator\r\n      *ngIf=\"workspace.inResolutionRange$ | async\"\r\n      [store]=\"workspace.entityStore\"\r\n      [paginatorOptions]=\"paginatorOptions\"\r\n      [entitySortChange$]=\"entitySortChange$\"\r\n      (paginatorChange)=\"paginatorChange($event)\">\r\n    </igo-entity-table-paginator>\r\n  </ng-container>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-actionbar\r\n      *ngIf=\"workspace.actionStore\"\r\n      [store]=\"workspace.actionStore\"\r\n      [horizontal]=\"true\"\r\n      [withToggleButton]=\"true\"\r\n      [withTitle]=\"true\"\r\n      [mode]=\"actionbarMode\">\r\n    </igo-actionbar>\r\n\r\n    <igo-entity-table\r\n      *ngIf=\"workspace.entityStore && workspace.meta && workspace.meta.tableTemplate && (workspace.inResolutionRange$ | async)\"\r\n      class=\"table-compact table-centered\"\r\n      [paginator]=\"workspacePaginator\"\r\n      [scrollBehavior]=\"scrollBehavior\"\r\n      [store]=\"workspace.entityStore\"\r\n      [template]=\"workspace.meta.tableTemplate\">\r\n    </igo-entity-table>\r\n    <mat-card-content\r\n    *ngIf=\"(workspace.inResolutionRange$ | async) === false\">\r\n      No data available at this scale. Please zoom in. \r\n    </mat-card-content>\r\n\r\n    <igo-workspace-widget-outlet [workspace]=\"workspace\"></igo-workspace-widget-outlet>\r\n\r\n  </ng-container>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'workspace',\r\n    component: AppWorkspaceComponent\r\n  }\r\n];\r\n\r\nexport const AppWorkspaceRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { Observable, BehaviorSubject } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  ActionbarMode,\r\n  EntityRecord,\r\n  EntityTableScrollBehavior,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WFSDataSourceOptions\r\n} from '@igo2/geo';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { WorkspaceState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-workspace',\r\n  templateUrl: './workspace.component.html',\r\n  styleUrls: ['./workspace.component.scss']\r\n})\r\nexport class AppWorkspaceComponent implements OnInit {\r\n\r\n  public workspacePaginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public paginatorOptions: EntityTablePaginatorOptions = {\r\n    pageSize: 5, // Number of items to display on a page.\r\n    pageSizeOptions: [1, 5, 10, 15, 30, 50, 100], // The set of provided page size options to display to the user.\r\n    showFirstLastButtons: true // Whether to show the first/last buttons UI to the user.\r\n  };\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-72, 47.2],\r\n    zoom: 5\r\n  };\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.workspaceState.store;\r\n  }\r\n\r\n  public selectedWorkspace$: Observable<Workspace>;\r\n\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public scrollBehavior = EntityTableScrollBehavior.Instant;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    public workspaceState: WorkspaceState,\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.selectedWorkspace$ = this.workspaceStore.stateView\r\n      .firstBy$(\r\n        (record: EntityRecord<Workspace>) => record.state.selected === true\r\n      )\r\n      .pipe(\r\n        map((record: EntityRecord<Workspace>) => {\r\n          const entity = record === undefined ? undefined : record.entity;\r\n          if (entity) {\r\n            // In fact, the download action is not fully functionnal into the igo2-lib demo\r\n            // The reason why it's has been remove is that this button trigger a tool (importExport)\r\n            // and this tool is not available in the igo2-lib demo.\r\n            // This is why it's has been removed frome the actions's list.\r\n            // Refer to the igo2 demo at https://infra-geo-ouverte.github.io/igo2/\r\n            entity.actionStore.view.filter((action) => {\r\n              return action.id !== 'wfsDownload';\r\n            });\r\n          }\r\n          return entity;\r\n\r\n        })\r\n      );\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const wmsDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ahocevar.com/geoserver/wms',\r\n    //   urlWfs: 'https://ahocevar.com/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   },\r\n    //   sourceFields: [\r\n    //     {name: 'waterway', alias: 'Chemin d eau'},\r\n    //     {name: 'osm_id'},\r\n    //     {name: 'landuse'}\r\n    //   ],\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   serverType: 'geoserver'\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(wmsDataSourceOptions as OgcFilterableDataSourceOptions)\r\n    //   .subscribe(dataSource => {\r\n    //     const layer = {\r\n    //       optionsFromCapabilities: true,\r\n    //       title: 'WMS Geoserver filterable ',\r\n    //       visible: true,\r\n    //       source: dataSource\r\n    //     };\r\n    //     this.map.addLayer(this.layerService.createLayer(layer));\r\n    //   });\r\n\r\n    const wfsDataSourceOptions: WFSDataSourceOptions = {\r\n      type: 'wfs',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        featureTypes: 'etablissement_mtq',\r\n        fieldNameGeometry: 'geometry',\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson'\r\n      },\r\n      sourceFields: [\r\n        { name: 'idetablis', alias: 'ID' },\r\n        { name: 'nometablis', alias: 'Name' },\r\n        { name: 'typetablis', alias: 'Type' }\r\n      ]\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        const layer = {\r\n          title: 'Simple WFS ',\r\n          maxResolution: 3000,\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.workspacePaginator = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport {\r\n  IgoActionModule,\r\n  IgoEntityModule,\r\n  IgoWorkspaceModule,\r\n  IgoPanelModule\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoGeoWorkspaceModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\nimport { AppWorkspaceRoutingModule } from './workspace-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppWorkspaceComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppWorkspaceRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoActionModule,\r\n    IgoEntityModule,\r\n    IgoWorkspaceModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoGeoWorkspaceModule\r\n  ],\r\n  exports: [AppWorkspaceComponent]\r\n})\r\nexport class AppWorkspaceModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Context</mat-card-title>\r\n  <mat-card-content>\r\n    <p>* Dependencies: LanguageService</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/context/context\">code of this example</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/contexts\"> contexts</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    igoMapContext\r\n    igoLayerContext\r\n    [map]=\"map\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Contexts list\">\r\n    <igo-context-list igoContextListBinding [map]=\"map\"></igo-context-list>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list igoLayerListBinding [map]=\"map\">\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n      </ng-template>\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppContextComponent } from './context.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'context',\r\n    component: AppContextComponent\r\n  }\r\n];\r\n\r\nexport const AppContextRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, OverlayService, MapService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-context',\r\n  templateUrl: './context.component.html',\r\n  styleUrls: ['./context.component.scss']\r\n})\r\nexport class AppContextComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private mapService: MapService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { HttpClientJsonpModule } from '@angular/common/http';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoMetadataModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\nimport { IgoContextManagerModule } from '@igo2/context';\r\n\r\nimport { AppContextComponent } from './context.component';\r\nimport { AppContextRoutingModule } from './context-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppContextComponent],\r\n  imports: [\r\n    HttpClientJsonpModule,\r\n    AppContextRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoMetadataModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoContextManagerModule\r\n  ],\r\n  exports: [AppContextComponent]\r\n})\r\nexport class AppContextModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { RouterModule, Routes } from '@angular/router';\r\n\r\nconst routes: Routes = [\r\n  { path: '', redirectTo: '/home', pathMatch: 'full' },\r\n  { path: '**', redirectTo: '/home' }\r\n];\r\n\r\n@NgModule({\r\n  imports: [RouterModule.forRoot(routes, { useHash: true })],\r\n  exports: [RouterModule]\r\n})\r\nexport class AppRoutingModule {}\r\n","import { MediaMatcher } from '@angular/cdk/layout';\r\nimport {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  OnDestroy,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { version } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-root',\r\n  templateUrl: './app.component.html',\r\n  styleUrls: ['./app.component.scss']\r\n})\r\nexport class AppComponent implements OnDestroy {\r\n  mobileQuery: MediaQueryList;\r\n\r\n  public title = 'IGO';\r\n  public version = version;\r\n  private themeClass = 'deeppurple-theme';\r\n  private _mobileQueryListener: () => void;\r\n\r\n  constructor(\r\n    private changeDetectorRef: ChangeDetectorRef,\r\n    private media: MediaMatcher,\r\n    private renderer: Renderer2\r\n  ) {\r\n    this.mobileQuery = media.matchMedia('(max-width: 600px)');\r\n    this._mobileQueryListener = () => changeDetectorRef.detectChanges();\r\n    this.mobileQuery.addEventListener('change', this._mobileQueryListener);\r\n\r\n    this.renderer.addClass(document.body, this.themeClass);\r\n\r\n    this.detectOldBrowser();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.mobileQuery.removeEventListener('change', this._mobileQueryListener);\r\n  }\r\n\r\n  private detectOldBrowser() {\r\n    const oldBrowser = userAgent.satisfies({\r\n      ie: '<=11',\r\n      chrome: '<64',\r\n      firefox: '<60'\r\n    });\r\n\r\n    if (oldBrowser) {\r\n      console.log('Very old browser ! ', userAgent.getBrowser());\r\n    }\r\n  }\r\n}\r\n","<div class=\"example-container\" [class.example-is-mobile]=\"mobileQuery.matches\">\r\n  <mat-toolbar color=\"primary\" class=\"example-toolbar\">\r\n    <button mat-icon-button (click)=\"snav.toggle()\"><mat-icon svgIcon=\"menu\"></mat-icon></button>\r\n    <h1>{{title}}</h1>\r\n    <h5>{{version.lib}}</h5>\r\n  </mat-toolbar>\r\n\r\n  <mat-sidenav-container class=\"example-sidenav-container\" [style.marginTop.px]=\"mobileQuery.matches ? 56 : 0\">\r\n    <mat-sidenav #snav opened=\"true\" [mode]=\"mobileQuery.matches ? 'over' : 'side'\" [fixedInViewport]=\"mobileQuery.matches\" fixedTopGap=\"56\">\r\n      <mat-nav-list>\r\n        <a mat-list-item routerLink=\".\">Home</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"activity\">Activity</a>\r\n        <a mat-list-item routerLink=\"config\">Config</a>\r\n        <a mat-list-item routerLink=\"language\">Language</a>\r\n        <a mat-list-item routerLink=\"media\">Media</a>\r\n        <a mat-list-item routerLink=\"message\">Message</a>\r\n        <a mat-list-item routerLink=\"request\">Request</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"auth-form\">Authentification</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"action\">Action</a>\r\n        <a mat-list-item routerLink=\"dynamic-component\">Dynamic Component</a>\r\n        <a mat-list-item routerLink=\"entity-table\">Entity Table</a>\r\n        <a mat-list-item routerLink=\"entity-selector\">Entity Selector</a>\r\n        <a mat-list-item routerLink=\"form\">Form</a>\r\n        <a mat-list-item routerLink=\"table\">Table</a>\r\n        <a mat-list-item routerLink=\"tool\">Tool</a>\r\n        <a mat-list-item routerLink=\"widget\">Widget</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"simple-map\">Simple map</a>\r\n        <a mat-list-item routerLink=\"layer\">Layer</a>\r\n        <a mat-list-item routerLink=\"legend\">Legend</a>\r\n        <a mat-list-item routerLink=\"overlay\">Overlay</a>\r\n        <a mat-list-item routerLink=\"geometry\">Geometry</a>\r\n        <a mat-list-item routerLink=\"feature\">Feature</a>\r\n        <a mat-list-item routerLink=\"hover\">Hover</a>\r\n        <a mat-list-item routerLink=\"measure\">Measure</a>\r\n        <a mat-list-item routerLink=\"draw\">Draw</a>\r\n        <a mat-list-item routerLink=\"query\">Query</a>\r\n        <a mat-list-item routerLink=\"catalog\">Catalog</a>\r\n        <a mat-list-item routerLink=\"search\">Search</a>\r\n        <a mat-list-item routerLink=\"print\">Print</a>\r\n        <a mat-list-item routerLink=\"import-export\">Import/Export</a>\r\n        <a mat-list-item routerLink=\"directions\">Directions</a>\r\n        <a mat-list-item routerLink=\"time-filter\">Time filter</a>\r\n        <a mat-list-item routerLink=\"ogc-filter\">OGC filter</a>\r\n        <a mat-list-item routerLink=\"spatial-filter\">Spatial filter</a>\r\n        <a mat-list-item routerLink=\"workspace\">Workspace</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"context\">Context</a>\r\n\r\n      </mat-nav-list>\r\n    </mat-sidenav>\r\n\r\n    <mat-sidenav-content>\r\n      <router-outlet></router-outlet>\r\n    </mat-sidenav-content>\r\n\r\n  </mat-sidenav-container>\r\n</div>\r\n","import { BrowserModule, DomSanitizer } from '@angular/platform-browser';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\nimport { APP_INITIALIZER, ApplicationRef, Injector, NgModule } from '@angular/core';\r\nimport { HammerModule } from '@angular/platform-browser';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconRegistry, MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSidenavModule } from '@angular/material/sidenav';\r\nimport { MatToolbarModule } from '@angular/material/toolbar';\r\nimport { AppHomeModule } from './core/home/home.module';\r\nimport { AppActivityModule } from './core/activity/activity.module';\r\nimport { AppConfigModule } from './core/config/config.module';\r\nimport { AppLanguageModule } from './core/language/language.module';\r\nimport { AppMediaModule } from './core/media/media.module';\r\nimport { AppMessageModule } from './core/message/message.module';\r\nimport { AppRequestModule } from './core/request/request.module';\r\n\r\nimport { AppActionModule } from './common/action/action.module';\r\nimport { AppDynamicComponentModule } from './common/dynamic-component/dynamic-component.module';\r\nimport { AppEntityTableModule } from './common/entity-table/entity-table.module';\r\nimport { AppEntitySelectorModule } from './common/entity-selector/entity-selector.module';\r\nimport { AppFormModule } from './common/form/form.module';\r\nimport { AppTableModule } from './common/table/table.module';\r\nimport { AppToolModule } from './common/tool/tool.module';\r\nimport { AppWidgetModule } from './common/widget/widget.module';\r\n\r\nimport { AppAuthFormModule } from './auth/auth-form/auth-form.module';\r\n\r\nimport { AppSimpleMapModule } from './geo/simple-map/simple-map.module';\r\nimport { AppLayerModule } from './geo/layer/layer.module';\r\nimport { AppLegendModule } from './geo/legend/legend.module';\r\nimport { AppOverlayModule } from './geo/overlay/overlay.module';\r\nimport { AppGeometryModule } from './geo/geometry/geometry.module';\r\nimport { AppFeatureModule } from './geo/feature/feature.module';\r\nimport { AppHoverModule } from './geo/hover/hover.module';\r\nimport { AppMeasureModule } from './geo/measure/measure.module';\r\nimport { AppDrawModule } from './geo/draw/draw.module';\r\nimport { AppQueryModule } from './geo/query/query.module';\r\nimport { AppCatalogModule } from './geo/catalog/catalog.module';\r\nimport { AppSearchModule } from './geo/search/search.module';\r\nimport { AppPrintModule } from './geo/print/print.module';\r\nimport { AppImportExport } from './geo/import-export/import-export.module';\r\nimport { AppDirectionsModule } from './geo/directions/directions.module';\r\nimport { AppTimeFilterModule } from './geo/time-filter/time-filter.module';\r\nimport { AppOgcFilterModule } from './geo/ogc-filter/ogc-filter.module';\r\nimport { AppSpatialFilterModule } from './geo/spatial-filter/spatial-filter.module';\r\nimport { AppWorkspaceModule } from './geo/workspace/workspace.module';\r\n\r\nimport { AppContextModule } from './context/context/context.module';\r\n\r\nimport { AppRoutingModule } from './app-routing.module';\r\nimport { AppComponent } from './app.component';\r\nimport { IgoCoreModule, LanguageService } from '@igo2/core';\r\nimport { MatTooltipDefaultOptions, MAT_TOOLTIP_DEFAULT_OPTIONS } from '@angular/material/tooltip';\r\nimport { concatMap, first } from 'rxjs';\r\n\r\nexport const defaultTooltipOptions: MatTooltipDefaultOptions = {\r\n  showDelay: 500,\r\n  hideDelay: 0,\r\n  touchendHideDelay: 0,\r\n  disableTooltipInteractivity: true\r\n};\r\n\r\n@NgModule({\r\n  declarations: [AppComponent],\r\n  imports: [\r\n    IgoCoreModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatSidenavModule,\r\n    MatToolbarModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n\r\n    AppHomeModule,\r\n    AppActivityModule,\r\n    AppConfigModule,\r\n    AppLanguageModule,\r\n    AppMediaModule,\r\n    AppMessageModule,\r\n    AppRequestModule,\r\n\r\n    AppActionModule,\r\n    AppDynamicComponentModule,\r\n    AppEntityTableModule,\r\n    AppEntitySelectorModule,\r\n    AppFormModule,\r\n    AppTableModule,\r\n    AppToolModule,\r\n    AppWidgetModule,\r\n\r\n    AppAuthFormModule,\r\n\r\n    AppSimpleMapModule,\r\n    AppLayerModule,\r\n    AppLegendModule,\r\n    AppOverlayModule,\r\n    AppGeometryModule,\r\n    AppFeatureModule,\r\n    AppHoverModule,\r\n    AppMeasureModule,\r\n    AppDrawModule,\r\n    AppQueryModule,\r\n    AppCatalogModule,\r\n    AppSearchModule,\r\n    AppPrintModule,\r\n    AppImportExport,\r\n    AppDirectionsModule,\r\n    AppTimeFilterModule,\r\n    AppOgcFilterModule,\r\n    AppSpatialFilterModule,\r\n    AppWorkspaceModule,\r\n\r\n    AppContextModule,\r\n\r\n    AppRoutingModule,\r\n\r\n    HammerModule\r\n  ],\r\n  providers: [\r\n    { provide: APP_INITIALIZER, useFactory: appInitializerFactory, deps: [Injector, ApplicationRef], multi: true },\r\n    { provide: MAT_TOOLTIP_DEFAULT_OPTIONS, useValue: defaultTooltipOptions }\r\n  ],\r\n  bootstrap: [AppComponent]\r\n})\r\nexport class AppModule {\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n\r\nexport function appInitializerFactory(injector: Injector,\r\n  applicationRef: ApplicationRef) {\r\n  return () => new Promise<any>((resolve: any) => {\r\n    applicationRef.isStable.pipe(\r\n      first(isStable => isStable === true),\r\n      concatMap(() => {\r\n        const languageService = injector.get(LanguageService);\r\n        const lang = languageService.getLanguage();\r\n        return languageService.translate.getTranslation(lang);\r\n      }))\r\n      .subscribe((translations) => {\r\n        const languageService = injector.get(LanguageService);\r\n        const lang = languageService.getLanguage();\r\n        languageService.translate.setTranslation(lang, translations);\r\n        resolve();\r\n      });\r\n  });\r\n}\r\n","import { enableProdMode } from '@angular/core';\r\nimport { platformBrowserDynamic } from '@angular/platform-browser-dynamic';\r\n\r\nimport { AppModule } from './app/app.module';\r\nimport { environment } from './environments/environment';\r\n\r\nimport 'hammerjs';\r\n\r\nif (environment.production) {\r\n  enableProdMode();\r\n}\r\n\r\nplatformBrowserDynamic()\r\n  .bootstrapModule(AppModule)\r\n  .catch(err => console.log(err));\r\n","var map = {\n\t\"./af\": 58685,\n\t\"./af.js\": 58685,\n\t\"./ar\": 254,\n\t\"./ar-dz\": 4312,\n\t\"./ar-dz.js\": 4312,\n\t\"./ar-kw\": 32614,\n\t\"./ar-kw.js\": 32614,\n\t\"./ar-ly\": 18630,\n\t\"./ar-ly.js\": 18630,\n\t\"./ar-ma\": 28674,\n\t\"./ar-ma.js\": 28674,\n\t\"./ar-sa\": 49032,\n\t\"./ar-sa.js\": 49032,\n\t\"./ar-tn\": 24730,\n\t\"./ar-tn.js\": 24730,\n\t\"./ar.js\": 254,\n\t\"./az\": 53052,\n\t\"./az.js\": 53052,\n\t\"./be\": 60150,\n\t\"./be.js\": 60150,\n\t\"./bg\": 63069,\n\t\"./bg.js\": 63069,\n\t\"./bm\": 13466,\n\t\"./bm.js\": 13466,\n\t\"./bn\": 18516,\n\t\"./bn-bd\": 90557,\n\t\"./bn-bd.js\": 90557,\n\t\"./bn.js\": 18516,\n\t\"./bo\": 26273,\n\t\"./bo.js\": 26273,\n\t\"./br\": 9588,\n\t\"./br.js\": 9588,\n\t\"./bs\": 19815,\n\t\"./bs.js\": 19815,\n\t\"./ca\": 83331,\n\t\"./ca.js\": 83331,\n\t\"./cs\": 21320,\n\t\"./cs.js\": 21320,\n\t\"./cv\": 72219,\n\t\"./cv.js\": 72219,\n\t\"./cy\": 68266,\n\t\"./cy.js\": 68266,\n\t\"./da\": 66427,\n\t\"./da.js\": 66427,\n\t\"./de\": 67435,\n\t\"./de-at\": 52871,\n\t\"./de-at.js\": 52871,\n\t\"./de-ch\": 12994,\n\t\"./de-ch.js\": 12994,\n\t\"./de.js\": 67435,\n\t\"./dv\": 82357,\n\t\"./dv.js\": 82357,\n\t\"./el\": 95649,\n\t\"./el.js\": 95649,\n\t\"./en-au\": 59961,\n\t\"./en-au.js\": 59961,\n\t\"./en-ca\": 19878,\n\t\"./en-ca.js\": 19878,\n\t\"./en-gb\": 3924,\n\t\"./en-gb.js\": 3924,\n\t\"./en-ie\": 70864,\n\t\"./en-ie.js\": 70864,\n\t\"./en-il\": 91579,\n\t\"./en-il.js\": 91579,\n\t\"./en-in\": 30940,\n\t\"./en-in.js\": 30940,\n\t\"./en-nz\": 16181,\n\t\"./en-nz.js\": 16181,\n\t\"./en-sg\": 44301,\n\t\"./en-sg.js\": 44301,\n\t\"./eo\": 85291,\n\t\"./eo.js\": 85291,\n\t\"./es\": 54529,\n\t\"./es-do\": 53764,\n\t\"./es-do.js\": 53764,\n\t\"./es-mx\": 12584,\n\t\"./es-mx.js\": 12584,\n\t\"./es-us\": 63425,\n\t\"./es-us.js\": 63425,\n\t\"./es.js\": 54529,\n\t\"./et\": 35203,\n\t\"./et.js\": 35203,\n\t\"./eu\": 70678,\n\t\"./eu.js\": 70678,\n\t\"./fa\": 83483,\n\t\"./fa.js\": 83483,\n\t\"./fi\": 96262,\n\t\"./fi.js\": 96262,\n\t\"./fil\": 52521,\n\t\"./fil.js\": 52521,\n\t\"./fo\": 34555,\n\t\"./fo.js\": 34555,\n\t\"./fr\": 63131,\n\t\"./fr-ca\": 88239,\n\t\"./fr-ca.js\": 88239,\n\t\"./fr-ch\": 21702,\n\t\"./fr-ch.js\": 21702,\n\t\"./fr.js\": 63131,\n\t\"./fy\": 267,\n\t\"./fy.js\": 267,\n\t\"./ga\": 23821,\n\t\"./ga.js\": 23821,\n\t\"./gd\": 71753,\n\t\"./gd.js\": 71753,\n\t\"./gl\": 4074,\n\t\"./gl.js\": 4074,\n\t\"./gom-deva\": 92762,\n\t\"./gom-deva.js\": 92762,\n\t\"./gom-latn\": 5969,\n\t\"./gom-latn.js\": 5969,\n\t\"./gu\": 82809,\n\t\"./gu.js\": 82809,\n\t\"./he\": 45402,\n\t\"./he.js\": 45402,\n\t\"./hi\": 315,\n\t\"./hi.js\": 315,\n\t\"./hr\": 10410,\n\t\"./hr.js\": 10410,\n\t\"./hu\": 38288,\n\t\"./hu.js\": 38288,\n\t\"./hy-am\": 67928,\n\t\"./hy-am.js\": 67928,\n\t\"./id\": 71334,\n\t\"./id.js\": 71334,\n\t\"./is\": 86959,\n\t\"./is.js\": 86959,\n\t\"./it\": 34864,\n\t\"./it-ch\": 51124,\n\t\"./it-ch.js\": 51124,\n\t\"./it.js\": 34864,\n\t\"./ja\": 36141,\n\t\"./ja.js\": 36141,\n\t\"./jv\": 29187,\n\t\"./jv.js\": 29187,\n\t\"./ka\": 42136,\n\t\"./ka.js\": 42136,\n\t\"./kk\": 94332,\n\t\"./kk.js\": 94332,\n\t\"./km\": 18607,\n\t\"./km.js\": 18607,\n\t\"./kn\": 84305,\n\t\"./kn.js\": 84305,\n\t\"./ko\": 70234,\n\t\"./ko.js\": 70234,\n\t\"./ku\": 16003,\n\t\"./ku.js\": 16003,\n\t\"./ky\": 75061,\n\t\"./ky.js\": 75061,\n\t\"./lb\": 32786,\n\t\"./lb.js\": 32786,\n\t\"./lo\": 66183,\n\t\"./lo.js\": 66183,\n\t\"./lt\": 50029,\n\t\"./lt.js\": 50029,\n\t\"./lv\": 24169,\n\t\"./lv.js\": 24169,\n\t\"./me\": 68577,\n\t\"./me.js\": 68577,\n\t\"./mi\": 68177,\n\t\"./mi.js\": 68177,\n\t\"./mk\": 50337,\n\t\"./mk.js\": 50337,\n\t\"./ml\": 65260,\n\t\"./ml.js\": 65260,\n\t\"./mn\": 52325,\n\t\"./mn.js\": 52325,\n\t\"./mr\": 14695,\n\t\"./mr.js\": 14695,\n\t\"./ms\": 75334,\n\t\"./ms-my\": 37151,\n\t\"./ms-my.js\": 37151,\n\t\"./ms.js\": 75334,\n\t\"./mt\": 63570,\n\t\"./mt.js\": 63570,\n\t\"./my\": 97963,\n\t\"./my.js\": 97963,\n\t\"./nb\": 88028,\n\t\"./nb.js\": 88028,\n\t\"./ne\": 86638,\n\t\"./ne.js\": 86638,\n\t\"./nl\": 50302,\n\t\"./nl-be\": 66782,\n\t\"./nl-be.js\": 66782,\n\t\"./nl.js\": 50302,\n\t\"./nn\": 33501,\n\t\"./nn.js\": 33501,\n\t\"./oc-lnc\": 50563,\n\t\"./oc-lnc.js\": 50563,\n\t\"./pa-in\": 50869,\n\t\"./pa-in.js\": 50869,\n\t\"./pl\": 65302,\n\t\"./pl.js\": 65302,\n\t\"./pt\": 49687,\n\t\"./pt-br\": 74884,\n\t\"./pt-br.js\": 74884,\n\t\"./pt.js\": 49687,\n\t\"./ro\": 79107,\n\t\"./ro.js\": 79107,\n\t\"./ru\": 33627,\n\t\"./ru.js\": 33627,\n\t\"./sd\": 30355,\n\t\"./sd.js\": 30355,\n\t\"./se\": 83427,\n\t\"./se.js\": 83427,\n\t\"./si\": 11848,\n\t\"./si.js\": 11848,\n\t\"./sk\": 54590,\n\t\"./sk.js\": 54590,\n\t\"./sl\": 20184,\n\t\"./sl.js\": 20184,\n\t\"./sq\": 56361,\n\t\"./sq.js\": 56361,\n\t\"./sr\": 78965,\n\t\"./sr-cyrl\": 81287,\n\t\"./sr-cyrl.js\": 81287,\n\t\"./sr.js\": 78965,\n\t\"./ss\": 25456,\n\t\"./ss.js\": 25456,\n\t\"./sv\": 70451,\n\t\"./sv.js\": 70451,\n\t\"./sw\": 77558,\n\t\"./sw.js\": 77558,\n\t\"./ta\": 51356,\n\t\"./ta.js\": 51356,\n\t\"./te\": 73693,\n\t\"./te.js\": 73693,\n\t\"./tet\": 21243,\n\t\"./tet.js\": 21243,\n\t\"./tg\": 42500,\n\t\"./tg.js\": 42500,\n\t\"./th\": 55768,\n\t\"./th.js\": 55768,\n\t\"./tk\": 77761,\n\t\"./tk.js\": 77761,\n\t\"./tl-ph\": 35780,\n\t\"./tl-ph.js\": 35780,\n\t\"./tlh\": 29590,\n\t\"./tlh.js\": 29590,\n\t\"./tr\": 33807,\n\t\"./tr.js\": 33807,\n\t\"./tzl\": 93857,\n\t\"./tzl.js\": 93857,\n\t\"./tzm\": 60654,\n\t\"./tzm-latn\": 8806,\n\t\"./tzm-latn.js\": 8806,\n\t\"./tzm.js\": 60654,\n\t\"./ug-cn\": 30845,\n\t\"./ug-cn.js\": 30845,\n\t\"./uk\": 19232,\n\t\"./uk.js\": 19232,\n\t\"./ur\": 47052,\n\t\"./ur.js\": 47052,\n\t\"./uz\": 77967,\n\t\"./uz-latn\": 32233,\n\t\"./uz-latn.js\": 32233,\n\t\"./uz.js\": 77967,\n\t\"./vi\": 98615,\n\t\"./vi.js\": 98615,\n\t\"./x-pseudo\": 12320,\n\t\"./x-pseudo.js\": 12320,\n\t\"./yo\": 31313,\n\t\"./yo.js\": 31313,\n\t\"./zh-cn\": 64490,\n\t\"./zh-cn.js\": 64490,\n\t\"./zh-hk\": 55910,\n\t\"./zh-hk.js\": 55910,\n\t\"./zh-mo\": 98262,\n\t\"./zh-mo.js\": 98262,\n\t\"./zh-tw\": 44223,\n\t\"./zh-tw.js\": 44223\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 46700;"],"x_google_ignoreList":[690]}